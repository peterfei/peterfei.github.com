<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Peterfei</title>
  <subtitle>ä¸Šä¸»æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å®åœ¨ä¸€æ— æ‰€ç¼º</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://peterfei.me/"/>
  <updated>2022-09-05T11:51:54.334Z</updated>
  <id>http://peterfei.me/</id>
  
  <author>
    <name>peterfei</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Headscale ä¹‹éƒ¨ç½²ç§æœ‰ DERP ä¸­ç»§æœåŠ¡å™¨</title>
    <link href="http://peterfei.me/2022/09/05/Headscale-%E4%B9%8B%E9%83%A8%E7%BD%B2%E7%A7%81%E6%9C%89-DERP-%E4%B8%AD%E7%BB%A7%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>http://peterfei.me/2022/09/05/Headscale-ä¹‹éƒ¨ç½²ç§æœ‰-DERP-ä¸­ç»§æœåŠ¡å™¨/</id>
    <published>2022-09-05T11:42:20.000Z</published>
    <updated>2022-09-05T11:51:54.334Z</updated>
    
    <content type="html"><![CDATA[<h2 id="STUN-æ˜¯ä»€ä¹ˆ"><a href="#STUN-æ˜¯ä»€ä¹ˆ" class="headerlink" title="STUN æ˜¯ä»€ä¹ˆ"></a>STUN æ˜¯ä»€ä¹ˆ</h2><p>Tailscale çš„ç»ˆæç›®æ ‡æ˜¯è®©ä¸¤å°<strong>å¤„äºç½‘ç»œä¸Šçš„ä»»ä½•ä½ç½®</strong>çš„æœºå™¨å»ºç«‹<strong>ç‚¹å¯¹ç‚¹è¿æ¥</strong>ï¼ˆç›´è¿ï¼‰ï¼Œä½†ç°å®ä¸–ç•Œæ˜¯å¤æ‚çš„ï¼Œå¤§éƒ¨ä»½æƒ…å†µä¸‹æœºå™¨éƒ½ä½äº NAT å’Œé˜²ç«å¢™åé¢ï¼Œè¿™æ—¶å€™å°±éœ€è¦é€šè¿‡æ‰“æ´æ¥å®ç°ç›´è¿ï¼Œä¹Ÿå°±æ˜¯ NAT ç©¿é€ã€‚</p>
<p>NAT æŒ‰ç…§ <strong>NAT æ˜ å°„è¡Œä¸º</strong>å’Œ<strong>æœ‰çŠ¶æ€é˜²ç«å¢™è¡Œä¸º</strong>å¯ä»¥åˆ†ä¸ºå¤šç§ç±»å‹ï¼Œä½†å¯¹äº NAT ç©¿é€æ¥è¯´æ ¹æœ¬ä¸éœ€è¦å…³å¿ƒè¿™ä¹ˆå¤šç±»å‹ï¼Œåªéœ€è¦çœ‹ <strong>NAT æˆ–è€…æœ‰çŠ¶æ€é˜²ç«å¢™æ˜¯å¦ä¼šä¸¥æ ¼æ£€æŸ¥ç›®æ ‡ Endpoint</strong>ï¼Œæ ¹æ®è¿™ä¸ªå› ç´ ï¼Œå¯ä»¥å°† NAT åˆ†ä¸º <strong>Easy NAT</strong> å’Œ <strong>Hard NAT</strong>ã€‚</p>
<ul>
<li><strong>Easy NAT</strong> åŠå…¶å˜ç§ç§°ä¸º â€œEndpoint-Independent Mappingâ€ (<strong>EIMï¼Œç»ˆç‚¹æ— å…³çš„æ˜ å°„</strong>)<br>è¿™é‡Œçš„ Endpoint æŒ‡çš„æ˜¯ç›®æ ‡ Endpointï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰çŠ¶æ€é˜²ç«å¢™åªè¦çœ‹åˆ°æœ‰å®¢æˆ·ç«¯è‡ªå·±å‘èµ·çš„å‡ºå‘åŒ…ï¼Œå°±ä¼šå…è®¸ç›¸åº”çš„å…¥å‘åŒ…è¿›å…¥ï¼Œ<strong>ä¸ç®¡è¿™ä¸ªå…¥å‘åŒ…æ˜¯è°å‘è¿›æ¥çš„éƒ½å¯ä»¥</strong>ã€‚</li>
<li><strong>hard NAT</strong> ä»¥åŠå˜ç§ç§°ä¸º â€œEndpoint-Dependent Mappingâ€ï¼ˆ<strong>EDMï¼Œç»ˆç‚¹ç›¸å…³çš„æ˜ å°„</strong>ï¼‰<br>è¿™ç§ NAT ä¼šé’ˆå¯¹æ¯ä¸ªç›®æ ‡ Endpoint æ¥ç”Ÿæˆä¸€æ¡ç›¸åº”çš„æ˜ å°„å…³ç³»ã€‚ åœ¨è¿™æ ·çš„è®¾å¤‡ä¸Šï¼Œå¦‚æœå®¢æˆ·ç«¯å‘æŸä¸ªç›®æ ‡ Endpoint å‘èµ·äº†å‡ºå‘åŒ…ï¼Œå‡è®¾å®¢æˆ·ç«¯çš„å…¬ç½‘ IP æ˜¯ 2.2.2.2ï¼Œé‚£ä¹ˆæœ‰çŠ¶æ€é˜²ç«å¢™å°±ä¼šæ‰“å¼€ä¸€ä¸ªç«¯å£ï¼Œå‡è®¾æ˜¯ 4242ã€‚é‚£ä¹ˆåªæœ‰æ¥è‡ªè¯¥ç›®æ ‡ Endpoint çš„å…¥å‘åŒ…æ‰å…è®¸é€šè¿‡ <code>2.2.2.2:4242</code>ï¼Œå…¶ä»–å®¢æˆ·ç«¯ä¸€å¾‹ä¸å…è®¸ã€‚è¿™ç§ NAT æ›´åŠ ä¸¥æ ¼ï¼Œæ‰€ä»¥å« Hard NATã€‚</li>
</ul>
<p>å¯¹äº Easy NATï¼Œæˆ‘ä»¬åªéœ€è¦æä¾›ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„æœåŠ¡ï¼Œå®ƒèƒ½å¤Ÿå‘Šè¯‰å®¢æˆ·ç«¯â€œå®ƒçœ‹åˆ°çš„å®¢æˆ·ç«¯çš„å…¬ç½‘ ip:port æ˜¯ä»€ä¹ˆâ€ï¼Œç„¶åå°†è¿™ä¸ªä¿¡æ¯ä»¥æŸç§æ–¹å¼å‘Šè¯‰é€šä¿¡å¯¹ç«¯ï¼ˆpeerï¼‰ï¼Œåè€…å°±çŸ¥é“è¯¥å’Œå“ªä¸ªåœ°å€å»ºè¿äº†ï¼è¿™ç§æœåŠ¡å°±å« <strong>STUN</strong> (Session Traversal Utilities for NATï¼ŒNATä¼šè¯ç©¿è¶Šåº”ç”¨ç¨‹åº)ã€‚å®ƒçš„å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<ul>
<li>ç¬”è®°æœ¬å‘ STUN æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼šâ€œä»ä½ çš„è§’åº¦çœ‹ï¼Œæˆ‘çš„åœ°å€ä»€ä¹ˆï¼Ÿâ€</li>
<li>STUN æœåŠ¡å™¨è¿”å›ä¸€ä¸ªå“åº”ï¼šâ€œæˆ‘çœ‹åˆ°ä½ çš„ UDP åŒ…æ˜¯ä»è¿™ä¸ªåœ°å€æ¥çš„ï¼š<code>ip:port</code>â€ã€‚</li>
</ul>
<h2 id="ä¸­ç»§æ˜¯ä»€ä¹ˆ"><a href="#ä¸­ç»§æ˜¯ä»€ä¹ˆ" class="headerlink" title="ä¸­ç»§æ˜¯ä»€ä¹ˆ"></a>ä¸­ç»§æ˜¯ä»€ä¹ˆ</h2><p>å¯¹äº <strong>Hard NAT</strong> æ¥è¯´ï¼ŒSTUN å°±ä¸å¥½ä½¿äº†ï¼Œå³ä½¿ STUN æ‹¿åˆ°äº†å®¢æˆ·ç«¯çš„å…¬ç½‘ <code>ip:port</code> å‘Šè¯‰é€šä¿¡å¯¹ç«¯ä¹Ÿäºäº‹æ— è¡¥ï¼Œå› ä¸ºé˜²ç«å¢™æ˜¯å’Œ STUN é€šä¿¡æ‰æ‰“å¼€çš„ç¼ºå£ï¼Œè¿™ä¸ªç¼ºå£åªå…è®¸ STUN çš„å…¥å‘åŒ…è¿›å…¥ï¼Œå…¶ä»–é€šä¿¡å¯¹ç«¯çŸ¥é“äº†è¿™ä¸ªç¼ºå£ä¹Ÿè¿›ä¸æ¥ã€‚é€šå¸¸ä¼ä¸šçº§ NAT éƒ½å±äº Hard NATã€‚</p>
<p>è¿™ç§æƒ…å†µä¸‹æ‰“æ´æ˜¯ä¸å¯èƒ½äº†ï¼Œä½†ä¹Ÿä¸èƒ½å°±æ­¤æ”¾å¼ƒï¼Œå¯ä»¥é€‰æ‹©ä¸€ç§æŠ˜è¡·çš„æ–¹å¼ï¼šåˆ›å»ºä¸€ä¸ªä¸­ç»§æœåŠ¡å™¨ï¼ˆrelay serverï¼‰ï¼Œå®¢æˆ·ç«¯ä¸ä¸­ç»§æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œä¸­ç»§æœåŠ¡å™¨å†å°†åŒ…ä¸­ç»§ï¼ˆrelayï¼‰ç»™é€šä¿¡å¯¹ç«¯ã€‚</p>
<p>è‡³äºä¸­ç»§çš„æ€§èƒ½ï¼Œé‚£è¦çœ‹å…·ä½“æƒ…å†µäº†ï¼š</p>
<ul>
<li>å¦‚æœèƒ½ç›´è¿ï¼Œé‚£æ˜¾ç„¶æ²¡å¿…è¦ç”¨ä¸­ç»§æ–¹å¼ï¼›</li>
<li>ä½†å¦‚æœæ— æ³•ç›´è¿ï¼Œè€Œä¸­ç»§è·¯å¾„åˆéå¸¸æ¥è¿‘åŒæ–¹ç›´è¿çš„çœŸå®è·¯å¾„ï¼Œå¹¶ä¸”å¸¦å®½è¶³å¤Ÿå¤§ï¼Œé‚£ä¸­ç»§æ–¹å¼å¹¶ä¸ä¼šæ˜æ˜¾é™ä½é€šä¿¡è´¨é‡ã€‚å»¶è¿Ÿè‚¯å®šä¼šå¢åŠ ä¸€ç‚¹ï¼Œå¸¦å®½ä¼šå ç”¨ä¸€äº›ï¼Œä½†<strong>ç›¸æ¯”å®Œå…¨è¿æ¥ä¸ä¸Šï¼Œè¿˜æ˜¯å¯ä»¥æ¥å—çš„</strong>ã€‚</li>
</ul>
<p>äº‹å®ä¸Šå¯¹äºå¤§éƒ¨åˆ†ç½‘ç»œè€Œè¨€ï¼ŒTailscale éƒ½å¯ä»¥é€šè¿‡å„ç§é»‘ç§‘æŠ€æ‰“æ´æˆåŠŸï¼Œåªæœ‰æå°‘æ•°æƒ…å†µä¸‹æ‰ä¼šé€‰æ‹©ä¸­ç»§ï¼Œä¸­ç»§åªæ˜¯ä¸€ç§ fallback æœºåˆ¶ã€‚</p>
<h2 id="ä¸­ç»§åè®®ç®€ä»‹"><a href="#ä¸­ç»§åè®®ç®€ä»‹" class="headerlink" title="ä¸­ç»§åè®®ç®€ä»‹"></a>ä¸­ç»§åè®®ç®€ä»‹</h2><p>ä¸­ç»§åè®®æœ‰å¤šç§å®ç°æ–¹å¼ã€‚</p>
<h3 id="TURN"><a href="#TURN" class="headerlink" title="TURN"></a>TURN</h3><p>TURN å³ Traversal Using Relays around NATï¼Œè¿™æ˜¯ä¸€ç§ç»å…¸çš„ä¸­ç»§å®ç°æ–¹å¼ï¼Œæ ¸å¿ƒç†å¿µæ˜¯ï¼š</p>
<ul>
<li><strong>ç”¨æˆ·</strong>ï¼ˆäººï¼‰å…ˆå»å…¬ç½‘ä¸Šçš„ TURN æœåŠ¡å™¨è®¤è¯ï¼ŒæˆåŠŸååè€…ä¼šå‘Šè¯‰ä½ ï¼šâ€œæˆ‘å·²ç»ä¸ºä½ åˆ†é…äº† ip:portï¼Œæ¥ä¸‹æ¥å°†ä¸ºä½ ä¸­ç»§æµé‡â€ï¼Œ</li>
<li>ç„¶åå°†è¿™ä¸ª ip:port åœ°å€å‘Šè¯‰å¯¹æ–¹ï¼Œè®©å®ƒå»è¿æ¥è¿™ä¸ªåœ°å€ï¼Œæ¥ä¸‹å»å°±æ˜¯éå¸¸ç®€å•çš„å®¢æˆ·ç«¯/æœåŠ¡å™¨é€šä¿¡æ¨¡å‹äº†ã€‚</li>
</ul>
<p>ä¸ STUN ä¸åŒï¼Œè¿™ç§åè®®æ²¡æœ‰çœŸæ­£çš„äº¤äº’æ€§ï¼Œä¸æ˜¯å¾ˆå¥½ç”¨ï¼Œå› æ­¤ Tailscale å¹¶æ²¡æœ‰é‡‡ç”¨ TURN ä½œä¸ºä¸­ç»§åè®®ã€‚</p>
<h3 id="DERP"><a href="#DERP" class="headerlink" title="DERP"></a>DERP</h3><p>DERP å³ Detoured Encrypted Routing Protocolï¼Œè¿™æ˜¯ Tailscale è‡ªç ”çš„ä¸€ä¸ªåè®®ï¼š</p>
<ul>
<li>å®ƒæ˜¯ä¸€ä¸ª<strong>é€šç”¨ç›®çš„åŒ…ä¸­ç»§åè®®ï¼Œè¿è¡Œåœ¨ HTTP ä¹‹ä¸Š</strong>ï¼Œè€Œå¤§éƒ¨åˆ†ç½‘ç»œéƒ½æ˜¯å…è®¸ HTTP é€šä¿¡çš„ã€‚</li>
<li>å®ƒæ ¹æ®ç›®çš„å…¬é’¥ï¼ˆdestinationâ€™s public keyï¼‰æ¥ä¸­ç»§åŠ å¯†çš„æµé‡ï¼ˆencrypted payloadsï¼‰ã€‚</li>
</ul>
<h2 id="è‡ªå»ºç§æœ‰-DERP-server"><a href="#è‡ªå»ºç§æœ‰-DERP-server" class="headerlink" title="è‡ªå»ºç§æœ‰ DERP server"></a>è‡ªå»ºç§æœ‰ DERP server</h2><p>Tailscale çš„ç§é’¥åªä¼šä¿å­˜åœ¨å½“å‰èŠ‚ç‚¹ï¼Œå› æ­¤ DERP server æ— æ³•è§£å¯†æµé‡ï¼Œå®ƒåªèƒ½å’Œäº’è”ç½‘ä¸Šçš„å…¶ä»–è·¯ç”±å™¨ä¸€æ ·ï¼Œå‘†å‘†åœ°å°†åŠ å¯†çš„æµé‡ä»ä¸€ä¸ªèŠ‚ç‚¹è½¬å‘åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåªä¸è¿‡ DERP ä½¿ç”¨äº†ä¸€ä¸ªç¨å¾®é«˜çº§ä¸€ç‚¹çš„åè®®æ¥é˜²æ­¢æ»¥ç”¨ã€‚</p>
<p>Tailscale å¼€æºäº† DERP æœåŠ¡å™¨çš„ä»£ç ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥é˜…è¯» <a href="https://github.com/tailscale/tailscale/tree/main/derp" target="_blank" rel="external">DERP çš„æºä»£ç </a>ã€‚</p>
<hr>
<p>Tailscale å®˜æ–¹å†…ç½®äº†å¾ˆå¤š DERP æœåŠ¡å™¨ï¼Œåˆ†æ­¥åœ¨å…¨çƒå„åœ°ï¼Œ<strong>æƒŸç‹¬ä¸åŒ…å«ä¸­å›½å¤§é™†</strong>ï¼ŒåŸå› ä½ æ‡‚å¾—ã€‚è¿™å°±å¯¼è‡´äº†ä¸€æ—¦æµé‡é€šè¿‡ DERP æœåŠ¡å™¨è¿›è¡Œä¸­ç»§ï¼Œå»¶æ—¶å°±ä¼šéå¸¸é«˜ã€‚è€Œä¸”å®˜æ–¹æä¾›çš„ DERP æœåŠ¡å™¨æ˜¯ä¸‡äººéª‘ï¼Œå­˜åœ¨å®‰å…¨éšæ‚£ã€‚</p>
<p>ä¸ºäº†å®ç°ä½å»¶è¿Ÿã€é«˜å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ <a href="https://tailscale.com/kb/1118/custom-derp-servers/" target="_blank" rel="external">Tailscale å®˜æ–¹æ–‡æ¡£</a>è‡ªå»ºç§æœ‰çš„ DERP æœåŠ¡å™¨ã€‚æœ‰ä¸¤ç§éƒ¨ç½²æ¨¡å¼ï¼Œä¸€ç§æ˜¯åŸºäºåŸŸåï¼Œå¦å¤–ä¸€ç§ä¸éœ€è¦åŸŸåï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ IPï¼Œä¸è¿‡éœ€è¦ä¸€ç‚¹é»‘ç§‘æŠ€ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹æœ€ç®€å•çš„ä½¿ç”¨åŸŸåçš„æ–¹æ¡ˆã€‚</p>
<p>è¿˜éœ€è¦åˆ›å»ºè‡ªç­¾åè¯ä¹¦ï¼Œå¯ä»¥é€šè¿‡è„šæœ¬æ¥åˆ›å»ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># build_cert.sh</span></div><div class="line"></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">CERT_HOST=<span class="variable">$1</span></div><div class="line">CERT_DIR=<span class="variable">$2</span></div><div class="line">CONF_FILE=<span class="variable">$3</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"[req]</span></div><div class="line">default_bits  = 2048</div><div class="line">distinguished_name = req_distinguished_name</div><div class="line">req_extensions = req_ext</div><div class="line">x509_extensions = v3_req</div><div class="line">prompt = no</div><div class="line"></div><div class="line">[req_distinguished_name]</div><div class="line">countryName = XX</div><div class="line">stateOrProvinceName = N/A</div><div class="line">localityName = N/A</div><div class="line">organizationName = Self-signed certificate</div><div class="line">commonName = <span class="variable">$CERT_HOST</span>: Self-signed certificate</div><div class="line"></div><div class="line">[req_ext]</div><div class="line">subjectAltName = @alt_names</div><div class="line"></div><div class="line">[v3_req]</div><div class="line">subjectAltName = @alt_names</div><div class="line"></div><div class="line">[alt_names]</div><div class="line">IP.1 = <span class="variable">$CERT_HOST</span></div><div class="line">" &gt; <span class="string">"<span class="variable">$CONF_FILE</span>"</span></div><div class="line"></div><div class="line">mkdir -p <span class="string">"<span class="variable">$CERT_DIR</span>"</span></div><div class="line">openssl req -x509 -nodes -days 730 -newkey rsa:2048 -keyout <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.key"</span> -out <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.crt"</span> -config <span class="string">"<span class="variable">$CONF_FILE</span>"</span></div></pre></td></tr></table></figure>
<p>é‡æ–°ç¼–å†™ Dockerfileï¼Œå°† derper çš„åŸŸåè®¾ç½®ä¸º <code>127.0.0.1</code>ï¼š</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> golang:latest AS builder</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># ========= CONFIG =========</span></div><div class="line"><span class="comment"># - download links</span></div><div class="line"><span class="keyword">ENV</span> MODIFIED_DERPER_GIT=https://github.com/yangchuansheng/ip_derper.git</div><div class="line"><span class="keyword">ENV</span> BRANCH=ip_derper</div><div class="line"><span class="comment"># ==========================</span></div><div class="line"></div><div class="line"><span class="comment"># build modified derper</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> git <span class="built_in">clone</span> -b <span class="variable">$BRANCH</span> <span class="variable">$MODIFIED_DERPER_GIT</span> tailscale --depth 1 &amp;&amp; \</span></div><div class="line">    <span class="built_in">cd</span> /app/tailscale/cmd/derper &amp;&amp; \</div><div class="line">    /usr/<span class="built_in">local</span>/go/bin/go build -ldflags <span class="string">"-s -w"</span> -o /app/derper &amp;&amp; \</div><div class="line">    <span class="built_in">cd</span> /app &amp;&amp; \</div><div class="line">    rm -rf /app/tailscale</div><div class="line"></div><div class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># ========= CONFIG =========</span></div><div class="line"><span class="comment"># - derper args</span></div><div class="line"><span class="keyword">ENV</span> DERP_HOST=<span class="number">127.0</span>.<span class="number">0.1</span></div><div class="line"><span class="keyword">ENV</span> DERP_CERTS=/app/certs/</div><div class="line"><span class="keyword">ENV</span> DERP_STUN true</div><div class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</div><div class="line"><span class="comment"># ==========================</span></div><div class="line"></div><div class="line"><span class="comment"># apt</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></div><div class="line">    apt-get install -y openssl curl</div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> build_cert.sh /app/</span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /app/derper /app/derper</span></div><div class="line"></div><div class="line"><span class="comment"># build self-signed certs &amp;&amp; start derper</span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> bash /app/build_cert.sh <span class="variable">$DERP_HOST</span> <span class="variable">$DERP_CERTS</span> /app/san.conf &amp;&amp; \</span></div><div class="line">    /app/derper --hostname=<span class="variable">$DERP_HOST</span> \</div><div class="line">    --certmode=manual \</div><div class="line">    --certdir=<span class="variable">$DERP_CERTS</span> \</div><div class="line">    --stun=<span class="variable">$DERP_STUN</span>  \</div><div class="line">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></div></pre></td></tr></table></figure>
<p>æ„å»ºå¥½é•œåƒåï¼Œå°±å¯ä»¥åœ¨ä½ æƒ³éƒ¨ç½² derper çš„ä¸»æœºä¸Šç›´æ¥é€šè¿‡è¯¥é•œåƒå¯åŠ¨ derper å®¹å™¨äº†ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ğŸ³  â†’ docker run --restart always --net host --name derper  -p 12345:12345 -p 3478:3478/udp <span class="_">-e</span> DERP_ADDR=:12345  <span class="_">-d</span> ghcr.io/yangchuansheng/ip_derper</div></pre></td></tr></table></figure>
<p>Headscale çš„æœ¬åœ° YAML æ–‡ä»¶ç›®å‰è¿˜ä¸æ”¯æŒè¿™ä¸ªé…ç½®é¡¹ï¼Œæ‰€ä»¥æ²¡åŠæ³•ï¼Œå’±åªèƒ½ä½¿ç”¨åœ¨çº¿ URL äº†ã€‚JSON é…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@jetlink headscale]# cat derp.json </div><div class="line">&#123;</div><div class="line">  "Regions": &#123;</div><div class="line">    "901": &#123;</div><div class="line">      "RegionID": 901,</div><div class="line">      "RegionCode": "ali-sh",</div><div class="line">      "RegionName": "Aliyun Shanghai",</div><div class="line">      "Nodes": [</div><div class="line">        &#123;</div><div class="line">          "Name": "901a",</div><div class="line">          "RegionID": 901,</div><div class="line">          "DERPPort": 12345,</div><div class="line">          "HostName": "xx.xx.xx.118",</div><div class="line">          "IPv4": "xx.xx.xx.118",</div><div class="line">          "InsecureForTests": true</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é…ç½®è§£æï¼š</p>
<ul>
<li><code>HostName</code> ç›´æ¥å¡« derper çš„å…¬ç½‘ IPï¼Œå³å’Œ <code>IPv4</code> çš„å€¼ç›¸åŒã€‚</li>
<li><code>InsecureForTests</code> ä¸€å®šè¦è®¾ç½®ä¸º trueï¼Œä»¥è·³è¿‡åŸŸåéªŒè¯ã€‚</li>
</ul>
<p>ä½ éœ€è¦æŠŠè¿™ä¸ª JSON æ–‡ä»¶å˜æˆ Headscale æœåŠ¡å™¨å¯ä»¥è®¿é—®çš„ URLï¼Œæ¯”å¦‚åœ¨ Headscale ä¸»æœºä¸Šæ­ä¸ª Nginxï¼Œæˆ–è€…ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆæ¯”å¦‚é˜¿é‡Œäº‘ OSSï¼‰</p>
<p>æ¥ä¸‹æ¥è¿˜éœ€è¦ä¿®æ”¹ Headscale çš„é…ç½®æ–‡ä»¶ï¼Œå¼•ç”¨ä¸Šé¢çš„è‡ªå®šä¹‰ DERP çš„ URLã€‚éœ€è¦ä¿®æ”¹çš„é…ç½®é¡¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /etc/headscale/config.yaml</span></div><div class="line"><span class="attr">derp:</span></div><div class="line">  <span class="comment"># List of externally available DERP maps encoded in JSON</span></div><div class="line"><span class="attr">  urls:</span></div><div class="line">  <span class="comment">#  - https://controlplane.tailscale.com/derpmap/default</span></div><div class="line"><span class="attr">    - https:</span>//xxxxx/derp.json</div><div class="line"></div><div class="line">  <span class="comment"># Locally available DERP map files encoded in YAML</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment"># This option is mostly interesting for people hosting</span></div><div class="line">  <span class="comment"># their own DERP servers:</span></div><div class="line">  <span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment"># paths:</span></div><div class="line">  <span class="comment">#   - /etc/headscale/derp-example.yaml</span></div><div class="line"><span class="attr">  paths:</span></div><div class="line"><span class="bullet">    -</span> /etc/headscale/derp.yaml</div><div class="line"></div><div class="line">  <span class="comment"># If enabled, a worker will be set up to periodically</span></div><div class="line">  <span class="comment"># refresh the given sources and update the derpmap</span></div><div class="line">  <span class="comment"># will be set up.</span></div><div class="line"><span class="attr">  auto_update_enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment"># How often should we check for DERP updates?</span></div><div class="line"><span class="attr">  update_frequency:</span> <span class="number">24</span>h</div></pre></td></tr></table></figure>
<p>ä¿®æ”¹å®Œé…ç½®åï¼Œé‡å¯ headscale æœåŠ¡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl restart headscale</div></pre></td></tr></table></figure>
<p>åœ¨ Tailscale å®¢æˆ·ç«¯ä¸Šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ç›®å‰å¯ä»¥ä½¿ç”¨çš„ DERP æœåŠ¡å™¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ tailscale netcheck</div><div class="line"></div><div class="line">Report:</div><div class="line">	* UDP: <span class="literal">true</span></div><div class="line">	* IPv4: yes, 192.168.100.1:49656</div><div class="line">	* IPv6: no</div><div class="line">	* MappingVariesByDestIP: <span class="literal">true</span></div><div class="line">	* HairPinning: <span class="literal">false</span></div><div class="line">	* PortMapping: UPnP</div><div class="line">	* Nearest DERP: Home Hangzhou</div><div class="line">	* DERP latency:</div><div class="line">		- home: 9.7ms   (Home Hangzhou)</div><div class="line">		-  hs: 25.2ms  (Huawei Shanghai)</div><div class="line">		- thk: 43.5ms  (Tencent Hongkong)</div></pre></td></tr></table></figure>
<p>å†æ¬¡æŸ¥çœ‹ä¸é€šä¿¡å¯¹ç«¯çš„è¿æ¥æ–¹å¼ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ tailscale status</div><div class="line">                coredns              default      linux   active; direct xxxx:45986; offline, tx 131012 rx 196020</div><div class="line">                oneplus-8t           default      android active; relay <span class="string">"home"</span>; offline, tx 211900 rx 22780</div><div class="line">                openwrt              default      linux   active; direct 192.168.100.254:41641; offline, tx 189868 rx 4074772</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸€æ¬¡ Tailscale è‡ªåŠ¨é€‰æ‹©äº†ä¸€ä¸ªçº¿è·¯æœ€ä¼˜çš„<strong>å›½å†…çš„</strong> DERP æœåŠ¡å™¨ä½œä¸ºä¸­ç»§ï¼Œå¯ä»¥æµ‹è¯•ä¸€ä¸‹å»¶è¿Ÿï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ tailscale ping 10.1.0.8</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 45ms</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</div></pre></td></tr></table></figure>
<p>å®Œç¾ï¼è¿™é‡Œçš„ home å½“ç„¶æ˜¯æˆ‘çš„å®¶åº­å®½å¸¦ï¼Œéƒ¨ç½²æ–¹å¼ä¸ä¸Šé¢æ‰€è¯´çš„å›½å†…äº‘ä¸»æœºç±»ä¼¼ï¼Œä½ éœ€è¦é¢å¤–å¼€å¯å…¬ç½‘çš„ç«¯å£æ˜ å°„ï¼ˆ12345/tcp, 3478/udpï¼‰ã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯é…ç½®å†…å®¹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"Regions"</span>: &#123;</div><div class="line">    <span class="attr">"901"</span>: &#123;</div><div class="line">      <span class="attr">"RegionID"</span>: <span class="number">901</span>,</div><div class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"ali-sh"</span>,</div><div class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Aliyun Shanghai"</span>,</div><div class="line">      <span class="attr">"Nodes"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"Name"</span>: <span class="string">"901a"</span>,</div><div class="line">          <span class="attr">"RegionID"</span>: <span class="number">901</span>,</div><div class="line">          <span class="attr">"DERPPort"</span>: <span class="number">443</span>,</div><div class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"IPv4"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"902"</span>: &#123;</div><div class="line">      <span class="attr">"RegionID"</span>: <span class="number">902</span>,</div><div class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"home"</span>,</div><div class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Home Hangzhou"</span>,</div><div class="line">      <span class="attr">"Nodes"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"Name"</span>: <span class="string">"902a"</span>,</div><div class="line">          <span class="attr">"RegionID"</span>: <span class="number">902</span>,</div><div class="line">          <span class="attr">"DERPPort"</span>: <span class="number">12345</span>,</div><div class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸å›½å†…äº‘ä¸»æœºç›¸æ¯”ï¼Œå®¶åº­å®½å¸¦çš„é…ç½®æœ‰ä¸¤ç‚¹ä¸åŒï¼š</p>
<ul>
<li>éœ€è¦åˆ é™¤ <code>IPv4</code> é…ç½®é¡¹ã€‚å› ä¸ºå®¶ç”¨å®½å¸¦çš„å…¬ç½‘ IP æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ‰€ä»¥ä½ éœ€è¦ä½¿ç”¨ <strong>DDNS</strong> æ¥åŠ¨æ€è§£æå…¬ç½‘ IPã€‚</li>
<li><code>HostName</code> æœ€å¥½å¡«åŸŸåï¼Œå› ä¸ºä½ çš„å…¬ç½‘ IP æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ²¡æ³•å¡«å†™ IPï¼Œé™¤éä½ ä¸åœåœ°ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚å¡«åŸŸåä¹Ÿæ²¡å…³ç³»å•¦ï¼Œåæ­£ä¸ä¼šéªŒè¯åŸŸåçš„ï¼Œä¹Ÿä¸ç”¨å…³å¿ƒè¯ä¹¦çš„äº‹æƒ…ï¼Œ<strong>åªè¦åŸŸåèƒ½è§£æåˆ°ä½ çš„å…¬ç½‘ IP å³å¯ã€‚</strong></li>
</ul>
<h2 id="é˜²æ­¢-DERP-è¢«ç™½å«–"><a href="#é˜²æ­¢-DERP-è¢«ç™½å«–" class="headerlink" title="é˜²æ­¢ DERP è¢«ç™½å«–"></a>é˜²æ­¢ DERP è¢«ç™½å«–</h2><p>é»˜è®¤æƒ…å†µä¸‹ DERP æœåŠ¡å™¨æ˜¯å¯ä»¥è¢«ç™½å«–çš„ï¼Œåªè¦åˆ«äººçŸ¥é“äº†ä½ çš„ DERP æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£ï¼Œå°±å¯ä»¥ä¸ºä»–æ‰€ç”¨ã€‚å¦‚æœä½ çš„æœåŠ¡å™¨æ˜¯ä¸ªå°æ°´ç®¡ï¼Œç”¨çš„äººå¤šäº†å¯èƒ½ä¼šæŠŠä½ æ’‘çˆ†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¿®æ”¹é…ç½®æ¥é˜²æ­¢è¢«ç™½å«–ã€‚</p>
<blockquote>
<p>ç‰¹åˆ«å£°æ˜ï¼šåªæœ‰ä½¿ç”¨åŸŸåçš„æ–¹å¼æ‰å¯ä»¥é€šè¿‡è®¤è¯é˜²æ­¢è¢«ç™½å«–ï¼Œä½¿ç”¨çº¯ IP çš„æ–¹å¼æ— æ³•é˜²ç™½å«–ï¼Œä½ åªèƒ½å°å¿ƒç¿¼ç¿¼åœ°éšè—å¥½ä½ çš„ IP å’Œç«¯å£ï¼Œä¸èƒ½è®©åˆ«äººçŸ¥é“ã€‚</p>
</blockquote>
<p>åªéœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼š</p>
<p><strong>1ã€åœ¨ DERP æœåŠ¡å™¨ä¸Šå®‰è£… Tailscaleã€‚</strong></p>
<p>ç¬¬ä¸€æ­¥éœ€è¦åœ¨ DERP æœåŠ¡æ‰€åœ¨çš„ä¸»æœºä¸Šå®‰è£… Tailscale å®¢æˆ·ç«¯ï¼Œ<strong>å¯åŠ¨ tailscaled è¿›ç¨‹</strong>ã€‚</p>
<p><strong>2ã€derper å¯åŠ¨æ—¶åŠ ä¸Šå‚æ•° <code>--verify-clients</code>ã€‚</strong></p>
<p>æœ¬æ–‡æ¨èçš„æ˜¯é€šè¿‡å®¹å™¨å¯åŠ¨ï¼Œ <a href="https://github.com/yangchuansheng/docker-image/blob/master/derper/Dockerfile" target="_blank" rel="external">Dockerfile å†…å®¹</a>å¦‚ä¸‹ï¼š</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> golang:latest AS builder</div><div class="line"></div><div class="line"><span class="keyword">LABEL</span><span class="bash"> org.opencontainers.image.source https://github.com/yangchuansheng/docker-image</span></div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> go install tailscale.com/cmd/derper@main</span></div><div class="line"></div><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line">ARG DEBIAN_FRONTEND=noninteractive</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></div><div class="line">    apt-get install -y --no-install-recommends apt-utils &amp;&amp; \</div><div class="line">    apt-get install -y ca-certificates &amp;&amp; \</div><div class="line">    mkdir /app/certs</div><div class="line"></div><div class="line"><span class="keyword">ENV</span> DERP_DOMAIN your-hostname.com</div><div class="line"><span class="keyword">ENV</span> DERP_CERT_MODE letsencrypt</div><div class="line"><span class="keyword">ENV</span> DERP_CERT_DIR /app/certs</div><div class="line"><span class="keyword">ENV</span> DERP_ADDR :<span class="number">443</span></div><div class="line"><span class="keyword">ENV</span> DERP_STUN true</div><div class="line"><span class="keyword">ENV</span> DERP_HTTP_PORT <span class="number">80</span></div><div class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /go/bin/derper .</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> /app/derper --hostname=<span class="variable">$DERP_DOMAIN</span> \</span></div><div class="line">    --certmode=<span class="variable">$DERP_CERT_MODE</span> \</div><div class="line">    --certdir=<span class="variable">$DERP_CERT_DIR</span> \</div><div class="line">    -<span class="_">-a</span>=<span class="variable">$DERP_ADDR</span> \</div><div class="line">    --stun=<span class="variable">$DERP_STUN</span>  \</div><div class="line">    --http-port=<span class="variable">$DERP_HTTP_PORT</span> \</div><div class="line">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></div></pre></td></tr></table></figure>
<p>é»˜è®¤æƒ…å†µä¸‹ <code>--verify-clients</code> å‚æ•°è®¾ç½®çš„æ˜¯ <code>false</code>ã€‚æˆ‘ä»¬ä¸éœ€è¦å¯¹ Dockerfile å†…å®¹åšä»»ä½•æ”¹åŠ¨ï¼Œåªéœ€åœ¨å®¹å™¨å¯åŠ¨æ—¶åŠ ä¸Šç¯å¢ƒå˜é‡å³å¯ï¼Œå°†ä¹‹å‰çš„å¯åŠ¨å‘½ä»¤ä¿®æ”¹ä¸€ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ğŸ³  â†’ docker run --restart always \</div><div class="line">  --name derper -p 12345:12345 -p 3478:3478/udp \</div><div class="line">  -v /root/.acme.sh/xxxx/:/app/certs \</div><div class="line">  <span class="_">-e</span> DERP_CERT_MODE=manual \</div><div class="line">  <span class="_">-e</span> DERP_ADDR=:12345 \</div><div class="line">  <span class="_">-e</span> DERP_DOMAIN=xxxx \</div><div class="line">  <span class="_">-e</span> DERP_VERIFY_CLIENTS=<span class="literal">true</span> \</div><div class="line">  <span class="_">-d</span> ghcr.io/yangchuansheng/derper:latest</div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¤§åŠŸå‘Šæˆäº†ï¼Œåˆ«äººå³ä½¿çŸ¥é“äº†ä½ çš„ DERP æœåŠ¡å™¨åœ°å€ä¹Ÿæ— æ³•ä½¿ç”¨ï¼Œä½†è¿˜æ˜¯è¦è¯´æ˜ä¸€ç‚¹ï¼Œå³ä¾¿å¦‚æ­¤ï¼Œä½ ä¹Ÿåº”è¯¥å°½é‡ä¸è®©åˆ«äººçŸ¥é“ä½ çš„æœåŠ¡å™¨åœ°å€ï¼Œé˜²æ­¢åˆ«äººæœ‰å¯è¶ä¹‹æœºã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ç»™å¤§å®¶ä»‹ç»äº† STUN å¯¹äºè¾…åŠ© NAT ç©¿é€çš„æ„ä¹‰ï¼Œç§‘æ™®äº†å‡ ç§å¸¸è§çš„ä¸­ç»§åè®®ï¼ŒåŒ…å« Tailscale è‡ªç ”çš„ DERP åè®®ã€‚æœ€åæ‰‹æŠŠæ‰‹æ•™å¤§å®¶å¦‚ä½•è‡ªå»ºç§æœ‰çš„ DERP æœåŠ¡å™¨ï¼Œå¹¶è®© Tailscale ä½¿ç”¨æˆ‘ä»¬è‡ªå»ºçš„ DERP æœåŠ¡å™¨ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;STUN-æ˜¯ä»€ä¹ˆ&quot;&gt;&lt;a href=&quot;#STUN-æ˜¯ä»€ä¹ˆ&quot; class=&quot;headerlink&quot; title=&quot;STUN æ˜¯ä»€ä¹ˆ&quot;&gt;&lt;/a&gt;STUN æ˜¯ä»€ä¹ˆ&lt;/h2&gt;&lt;p&gt;Tailscale çš„ç»ˆæç›®æ ‡æ˜¯è®©ä¸¤å°&lt;strong&gt;å¤„äºç½‘ç»œä¸Šçš„ä»»ä½•ä½ç½®&lt;/strong&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Tailscaleæ­å»ºVPNä¸“çº¿</title>
    <link href="http://peterfei.me/2022/09/05/%E4%BD%BF%E7%94%A8Tailscale%E6%90%AD%E5%BB%BAVPN%E4%B8%93%E7%BA%BF/"/>
    <id>http://peterfei.me/2022/09/05/ä½¿ç”¨Tailscaleæ­å»ºVPNä¸“çº¿/</id>
    <published>2022-09-05T11:16:18.000Z</published>
    <updated>2022-09-05T11:36:16.273Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Tailscale-æ˜¯ä»€ä¹ˆ"><a href="#Tailscale-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Tailscale æ˜¯ä»€ä¹ˆ"></a>Tailscale æ˜¯ä»€ä¹ˆ</h2><p>Tailscale æ˜¯ä¸€ç§åŸºäº WireGuard çš„è™šæ‹Ÿç»„ç½‘å·¥å…·.</p>
<p>ä¸ OpenVPN ä¹‹æµç›¸æ¯”è¿˜æ˜¯èƒ½ç”©å¥½å‡ åæ¡è¡—çš„ï¼ŒTailscale è™½ç„¶åœ¨æ€§èƒ½ä¸Šåšäº†äº›è®¸å–èˆï¼Œä½†åœ¨åŠŸèƒ½å’Œæ˜“ç”¨æ€§ä¸Šç»å¯¹æ˜¯å®Œçˆ†å…¶ä»–å·¥å…·ï¼š</p>
<ol>
<li>å¼€ç®±å³ç”¨</li>
</ol>
<ul>
<li>æ— éœ€é…ç½®é˜²ç«å¢™</li>
<li>æ²¡æœ‰é¢å¤–çš„é…ç½®</li>
</ul>
<ol>
<li>é«˜å®‰å…¨æ€§/ç§å¯†æ€§</li>
</ol>
<ul>
<li>è‡ªåŠ¨å¯†é’¥è½®æ¢</li>
<li>ç‚¹å¯¹ç‚¹è¿æ¥</li>
<li>æ”¯æŒç”¨æˆ·å®¡æŸ¥ç«¯åˆ°ç«¯çš„è®¿é—®è®°å½•</li>
</ul>
<ol>
<li>åœ¨åŸæœ‰çš„ ICEã€STUN ç­‰ UDP åè®®å¤–ï¼Œå®ç°äº† DERP TCP åè®®æ¥å®ç° NAT ç©¿é€</li>
<li>åŸºäºå…¬ç½‘çš„æ§åˆ¶æœåŠ¡å™¨ä¸‹å‘ ACL å’Œé…ç½®ï¼Œå®ç°èŠ‚ç‚¹åŠ¨æ€æ›´æ–°</li>
<li>é€šè¿‡ç¬¬ä¸‰æ–¹ï¼ˆå¦‚ Googleï¼‰ SSO æœåŠ¡ç”Ÿæˆç”¨æˆ·å’Œç§é’¥ï¼Œå®ç°èº«ä»½è®¤è¯</li>
</ol>
<p>ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬å¯ä»¥å°† Tailscale çœ‹æˆæ˜¯æ›´ä¸ºæ˜“ç”¨ã€åŠŸèƒ½æ›´å®Œå–„çš„ WireGuardã€‚</p>
<h2 id="Headscale-æ˜¯ä»€ä¹ˆ"><a href="#Headscale-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Headscale æ˜¯ä»€ä¹ˆ"></a>Headscale æ˜¯ä»€ä¹ˆ</h2><p>Tailscale çš„æ§åˆ¶æœåŠ¡å™¨æ˜¯ä¸å¼€æºçš„ï¼Œè€Œä¸”å¯¹å…è´¹ç”¨æˆ·æœ‰è¯¸å¤šé™åˆ¶ï¼Œè¿™æ˜¯äººå®¶çš„æ‘‡é’±æ ‘ï¼Œå¯ä»¥ç†è§£ã€‚å¥½åœ¨ç›®å‰æœ‰ä¸€æ¬¾å¼€æºçš„å®ç°å« <a href="https://github.com/juanfont/headscale" target="_blank" rel="external">Headscale</a>ï¼Œè¿™ä¹Ÿæ˜¯å”¯ä¸€çš„ä¸€æ¬¾ï¼Œå¸Œæœ›èƒ½å‘å±•å£®å¤§ã€‚</p>
<p>Headscale ç”±æ¬§æ´²èˆªå¤©å±€çš„ Juan Font ä½¿ç”¨ Go è¯­è¨€å¼€å‘ï¼Œåœ¨ BSD è®¸å¯ä¸‹å‘å¸ƒï¼Œå®ç°äº† Tailscale æ§åˆ¶æœåŠ¡å™¨çš„æ‰€æœ‰ä¸»è¦åŠŸèƒ½ï¼Œå¯ä»¥éƒ¨ç½²åœ¨ä¼ä¸šå†…éƒ¨ï¼Œæ²¡æœ‰ä»»ä½•è®¾å¤‡æ•°é‡çš„é™åˆ¶ï¼Œä¸”æ‰€æœ‰çš„ç½‘ç»œæµé‡éƒ½ç”±è‡ªå·±æ§åˆ¶</p>
<h2 id="Headscale-éƒ¨ç½²"><a href="#Headscale-éƒ¨ç½²" class="headerlink" title="Headscale éƒ¨ç½²"></a>Headscale éƒ¨ç½²</h2><p>Headscale éƒ¨ç½²å¾ˆç®€å•ï¼Œæ¨èç›´æ¥åœ¨ Linux ä¸»æœºä¸Šå®‰è£…</p>
<p>é¦–å…ˆéœ€è¦åˆ°å…¶ GitHub ä»“åº“çš„ Release é¡µé¢ä¸‹è½½æœ€æ–°ç‰ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ wget --output-document=/usr/<span class="built_in">local</span>/bin/headscale \</div><div class="line">   https://github.com/juanfont/headscale/releases/download/v&lt;HEADSCALE VERSION&gt;/headscale_&lt;HEADSCALE VERSION&gt;_linux_&lt;ARCH&gt;</div><div class="line"></div><div class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/headscale</div></pre></td></tr></table></figure>
<p>åˆ›å»ºé…ç½®ç›®å½•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /etc/headscale</div></pre></td></tr></table></figure>
<p>åˆ›å»ºç›®å½•ç”¨æ¥å­˜å‚¨æ•°æ®ä¸è¯ä¹¦ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /var/lib/headscale</div></pre></td></tr></table></figure>
<p>åˆ›å»ºç©ºçš„ SQLite æ•°æ®åº“æ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ touch /var/lib/headscale/db.sqlite</div></pre></td></tr></table></figure>
<p>åˆ›å»º Headscale é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ wget https://github.com/juanfont/headscale/raw/main/config-example.yaml -O /etc/headscale/config.yaml</div></pre></td></tr></table></figure>
<ul>
<li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå°† <code>server_url</code> æ”¹ä¸ºå…¬ç½‘ IP æˆ–åŸŸåã€‚<strong>å¦‚æœæ˜¯å›½å†…æœåŠ¡å™¨ï¼ŒåŸŸåå¿…é¡»è¦å¤‡æ¡ˆ</strong>ã€‚æˆ‘çš„åŸŸåæ— æ³•å¤‡æ¡ˆï¼Œæ‰€ä»¥æˆ‘å°±ç›´æ¥ç”¨å…¬ç½‘ IP äº†ã€‚</p>
</li>
<li><p>å¦‚æœæš‚æ—¶ç”¨ä¸åˆ° DNS åŠŸèƒ½ï¼Œå¯ä»¥å…ˆå°† <code>magic_dns</code> è®¾ä¸º falseã€‚</p>
</li>
<li><p><code>server_url</code> è®¾ç½®ä¸º <code>http://&lt;PUBLIC_IP&gt;:8080</code>ï¼Œå°† <code>&lt;PUBLIC_IP&gt;</code> æ›¿æ¢ä¸ºå…¬ç½‘ IP æˆ–è€…åŸŸåã€‚</p>
</li>
<li><p>å¯è‡ªå®šä¹‰ç§æœ‰ç½‘æ®µï¼Œä¹Ÿå¯åŒæ—¶å¼€å¯ IPv4 å’Œ IPv6ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">ip_prefixes:</span></div><div class="line">  <span class="comment"># - fd7a:115c:a1e0::/48</span></div><div class="line"><span class="bullet">  -</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>åˆ›å»º SystemD service é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /etc/systemd/system/headscale.service</span></div><div class="line">[Unit]</div><div class="line">Description=headscale controller</div><div class="line">After=syslog.target</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=simple</div><div class="line">User=headscale</div><div class="line">Group=headscale</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/headscale serve</div><div class="line">Restart=always</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line"><span class="comment"># Optional security enhancements</span></div><div class="line">NoNewPrivileges=yes</div><div class="line">PrivateTmp=yes</div><div class="line">ProtectSystem=strict</div><div class="line">ProtectHome=yes</div><div class="line">ReadWritePaths=/var/lib/headscale /var/run/headscale</div><div class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</div><div class="line">RuntimeDirectory=headscale</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>åˆ›å»º headscale ç”¨æˆ·ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ useradd headscale <span class="_">-d</span> /home/headscale -m</div></pre></td></tr></table></figure>
<p>ä¿®æ”¹ /var/lib/headscale ç›®å½•çš„ ownerï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ chown -R headscale:headscale /var/lib/headscale</div></pre></td></tr></table></figure>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ <code>unix_socket</code>ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">unix_socket:</span> /var/run/headscale/headscale.sock</div></pre></td></tr></table></figure>
<p>Reload SystemD ä»¥åŠ è½½æ–°çš„é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl daemon-reload</div></pre></td></tr></table></figure>
<p>å¯åŠ¨ Headscale æœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl <span class="built_in">enable</span> --now headscale</div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl status headscale</div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹å ç”¨ç«¯å£ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ ss -tulnp|grep headscale</div><div class="line"></div><div class="line">tcp LISTEN 0 1024 [::]:9090 [::]:* users:((<span class="string">"headscale"</span>,pi</div><div class="line"></div><div class="line">d=10899,fd=13))</div><div class="line"></div><div class="line">tcp LISTEN 0 1024 [::]:50443 [::]:* users:((<span class="string">"headscale"</span>,pi</div><div class="line"></div><div class="line">d=10899,fd=10))</div><div class="line"></div><div class="line">tcp LISTEN 0 1024 [::]:8080 [::]:* users:((<span class="string">"headscale"</span>,pi</div><div class="line"></div><div class="line">d=10899,fd=12))</div></pre></td></tr></table></figure>
<p>ailscale ä¸­æœ‰ä¸€ä¸ªæ¦‚å¿µå« tailnetï¼Œä½ å¯ä»¥ç†è§£æˆç§Ÿæˆ·ï¼Œç§Ÿæˆ·ä¸ç§Ÿæˆ·ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œå…·ä½“çœ‹å‚è€ƒ Tailscale çš„å®˜æ–¹æ–‡æ¡£ï¼š <a href="https://tailscale.com/kb/1136/tailnet/" target="_blank" rel="external">What is a tailnet</a>ã€‚Headscale ä¹Ÿæœ‰ç±»ä¼¼çš„å®ç°å« namespaceï¼Œå³å‘½åç©ºé—´ã€‚æˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª namespaceï¼Œä»¥ä¾¿åç»­å®¢æˆ·ç«¯æ¥å…¥ï¼Œä¾‹å¦‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">headscale namespaces create vpn</div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹å‘½åç©ºé—´ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ headscale namespaces list</div><div class="line"></div><div class="line">ID | Name | Created</div><div class="line"></div><div class="line">1 | vpn | 2022-03-09 06:12:06</div></pre></td></tr></table></figure>
<h2 id="Tailscale-å®¢æˆ·ç«¯æ¥å…¥"><a href="#Tailscale-å®¢æˆ·ç«¯æ¥å…¥" class="headerlink" title="Tailscale å®¢æˆ·ç«¯æ¥å…¥"></a>Tailscale å®¢æˆ·ç«¯æ¥å…¥</h2><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Tailscale å®˜æ–¹æä¾›äº†å„ç§ Linux å‘è¡Œç‰ˆçš„è½¯ä»¶åŒ…ï¼Œä½†å›½å†…çš„ç½‘ç»œä½ æ‡‚å¾—ï¼Œè½¯ä»¶æºæ ¹æœ¬ç”¨ä¸äº†ã€‚å¥½åœ¨å®˜æ–¹è¿˜æä¾›äº† <a href="https://tailscale.com/download/linux/static" target="_blank" rel="external">é™æ€ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶</a>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¸‹è½½ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ wget https://pkgs.tailscale.com/stable/tailscale_1.22.2_amd64.tgz</div></pre></td></tr></table></figure>
<p>è§£å‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ tar zxvf tailscale_1.22.2_amd64.tgz</div><div class="line">x tailscale_1.22.2_amd64/</div><div class="line">x tailscale_1.22.2_amd64/tailscale</div><div class="line">x tailscale_1.22.2_amd64/tailscaled</div><div class="line">x tailscale_1.22.2_amd64/systemd/</div><div class="line">x tailscale_1.22.2_amd64/systemd/tailscaled.defaults</div><div class="line">x tailscale_1.22.2_amd64/systemd/tailscaled.service</div></pre></td></tr></table></figure>
<p>å°†äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°å®˜æ–¹è½¯ä»¶åŒ…é»˜è®¤çš„è·¯å¾„ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cp tailscale_1.22.2_amd64/tailscaled /usr/sbin/tailscaled</div><div class="line">$ cp tailscale_1.22.2_amd64/tailscale /usr/bin/tailscale</div></pre></td></tr></table></figure>
<p>å°† systemD service é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°ç³»ç»Ÿè·¯å¾„ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp tailscale_1.22.2_amd64/systemd/tailscaled.service /lib/systemd/system/tailscaled.service</div></pre></td></tr></table></figure>
<p>å°†ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°ç³»ç»Ÿè·¯å¾„ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp tailscale_1.22.2_amd64/systemd/tailscaled.defaults /etc/default/tailscaled</div></pre></td></tr></table></figure>
<p>å¯åŠ¨ tailscaled.service å¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl <span class="built_in">enable</span> --now tailscaled</div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl status tailscaled</div></pre></td></tr></table></figure>
<p>Tailscale æ¥å…¥ Headscaleï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å°† &lt;HEADSCALE_PUB_IP&gt; æ¢æˆä½ çš„ Headscale å…¬ç½‘ IP æˆ–åŸŸå</span></div><div class="line">$ tailscale up --login-server=http://xx.xx.xx.xx:8080 --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.xx.0/24</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæ¨èå°† DNS åŠŸèƒ½å…³é—­ï¼Œå› ä¸ºå®ƒä¼šè¦†ç›–ç³»ç»Ÿçš„é»˜è®¤ DNSã€‚å¦‚æœä½ å¯¹ DNS æœ‰éœ€æ±‚ï¼Œå¯è‡ªå·±ç ”ç©¶å®˜æ–¹æ–‡æ¡£ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<p>æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤åï¼Œä¼šå‡ºç°ä¸‹é¢çš„ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">To authenticate, visit:</div><div class="line"></div><div class="line">http://xxxxxx:8080/register?key=905cf165204800247fbd33989dbc22be95c987286c45aac303393704</div><div class="line"></div><div class="line">1150d846</div></pre></td></tr></table></figure>
<p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¥é“¾æ¥ï¼Œå°±ä¼šå‡ºç°å¦‚ä¸‹çš„ç•Œé¢</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-06-08qWbz.png" alt=""></p>
<p>å°†å…¶ä¸­çš„å‘½ä»¤å¤åˆ¶ç²˜è´´åˆ° headscale æ‰€åœ¨æœºå™¨çš„ç»ˆç«¯ä¸­ï¼Œå¹¶å°† NAMESPACE æ›¿æ¢ä¸ºå‰é¢æ‰€åˆ›å»ºçš„ namespaceã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ headscale -n vpn nodes register --key 905cf165204800247fbd33989dbc22be95c987286c45aac3033937041150d846</div><div class="line">Machine register</div></pre></td></tr></table></figure>
<p>æ³¨å†ŒæˆåŠŸï¼ŒæŸ¥çœ‹æ³¨å†Œçš„èŠ‚ç‚¹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ headscale nodes list</div><div class="line"></div><div class="line">ID | Name | NodeKey | Namespace | IP addresses | Ephemeral | Last seen | Onlin</div><div class="line"></div><div class="line">e | Expired</div><div class="line"></div><div class="line">1 | coredns | [Ew3RB] | vpn | 10.1.0.1 | <span class="literal">false</span> | 2022-03-20 09:08:58 | onlin</div><div class="line"></div><div class="line">e | no</div></pre></td></tr></table></figure>
<p>å›åˆ° Tailscale å®¢æˆ·ç«¯æ‰€åœ¨çš„ Linux ä¸»æœºï¼Œå¯ä»¥çœ‹åˆ° Tailscale ä¼šè‡ªåŠ¨åˆ›å»ºç›¸å…³çš„è·¯ç”±è¡¨å’Œ iptables è§„åˆ™ã€‚è·¯ç”±è¡¨å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ip route show table 52</div></pre></td></tr></table></figure>
<h3 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h3><p>macOS æœ‰ 3 ç§å®‰è£…æ–¹æ³•ï¼š</p>
<ul>
<li>ç›´æ¥é€šè¿‡åº”ç”¨å•†åº—å®‰è£…ï¼Œåœ°å€ï¼š <a href="https://apps.apple.com/ca/app/tailscale/id1475387142ã€‚å‰ææ˜¯ä½ **éœ€è¦ä¸€ä¸ªç¾åŒº" target="_blank" rel="external">https://apps.apple.com/ca/app/tailscale/id1475387142ã€‚å‰ææ˜¯ä½ **éœ€è¦ä¸€ä¸ªç¾åŒº</a> ID**ã€‚ã€‚ã€‚</li>
<li>ä¸‹è½½ <a href="https://pkgs.tailscale.com/stable/#macos" target="_blank" rel="external">å®‰è£…åŒ…</a>ç›´æ¥å®‰è£…ï¼Œç»•è¿‡åº”ç”¨å•†åº—ã€‚</li>
<li>å®‰è£…å¼€æºçš„å‘½ä»¤è¡Œå·¥å…· <code>tailscale</code> å’Œ <code>tailscaled</code>ã€‚ç›¸å…³é“¾æ¥ï¼š <a href="https://github.com/tailscale/tailscale/wiki/Tailscaled-on-macOSã€‚" target="_blank" rel="external">https://github.com/tailscale/tailscale/wiki/Tailscaled-on-macOSã€‚</a></li>
</ul>
<p>è¿™ä¸‰ç§å®‰è£…åŒ…çš„æ ¸å¿ƒæ•°æ®åŒ…å¤„ç†ä»£ç æ˜¯ç›¸åŒçš„ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºåœ¨äºæ‰“åŒ…æ–¹å¼ä»¥åŠä¸ç³»ç»Ÿçš„äº¤äº’æ–¹å¼</p>
<p>å®‰è£…å®Œ GUI ç‰ˆåº”ç”¨åè¿˜éœ€è¦åšä¸€äº›éªšæ“ä½œï¼Œæ‰èƒ½è®© Tailscale ä½¿ç”¨ Headscale ä½œä¸ºæ§åˆ¶æœåŠ¡å™¨ã€‚å½“ç„¶ï¼ŒHeadscale å·²ç»ç»™æˆ‘ä»¬æä¾›äº†è¯¦ç»†çš„æ“ä½œæ­¥éª¤ï¼Œä½ åªéœ€è¦åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ URLï¼š<code>http://&lt;HEADSCALE_PUB_IP&gt;:8080/apple</code>ï¼Œä¾¿ä¼šå‡ºç°å¦‚ä¸‹çš„ç•Œé¢ï¼š</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-39-arYdfv.png" alt=""></p>
<blockquote>
<p>éåº”ç”¨å•†åº—ç‰ˆæœ¬çš„ macOS å®¢æˆ·ç«¯éœ€è¦å°† <code>io.tailscale.ipn.macos</code> æ›¿æ¢ä¸º <code>io.tailscale.ipn.macsys</code>ã€‚å³ï¼š<code>defaults write io.tailscale.ipn.macsys ControlURL http://&lt;HEADSCALE_PUB_IP&gt;:8080</code></p>
</blockquote>
<p>ä¿®æ”¹å®Œæˆåé‡å¯ Tailscale å®¢æˆ·ç«¯ï¼Œåœ¨ macOS é¡¶éƒ¨çŠ¶æ€æ ä¸­æ‰¾åˆ° Tailscale å¹¶ç‚¹å‡»ï¼Œç„¶åå†ç‚¹å‡» <code>Log in</code></p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-43-pTW3r7.png" alt=""></p>
<p>ç„¶åç«‹é©¬å°±ä¼šè·³è½¬åˆ°æµè§ˆå™¨å¹¶æ‰“å¼€ä¸€ä¸ªé¡µé¢ã€‚</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-46-AbzngB.png" alt=""></p>
<p>æ¥ä¸‹æ¥ä¸ä¹‹å‰ Linux å®¢æˆ·ç«¯ç›¸åŒï¼Œå›åˆ° Headscale æ‰€åœ¨çš„æœºå™¨æ‰§è¡Œæµè§ˆå™¨ä¸­çš„å‘½ä»¤å³å¯ï¼Œæ³¨å†ŒæˆåŠŸ</p>
<p>å›åˆ° Headscale æ‰€åœ¨ä¸»æœºï¼ŒæŸ¥çœ‹æ³¨å†Œçš„èŠ‚ç‚¹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ headscale nodes list</div><div class="line"></div><div class="line">ID | Name | NodeKey | Namespace | IP addresses | Ephemeral | Last seen | Onlin</div><div class="line"></div><div class="line">e | Expired</div><div class="line"></div><div class="line">1 | coredns | [Ew3RB] | default | 10.1.0.1 | <span class="literal">false</span> | 2022-03-20 09:08:58 | onlin</div><div class="line"></div><div class="line">e | no</div><div class="line">2 | carsondemacbook-pro | [k7bzX] | default   | 10.1.0.2     | <span class="literal">false</span>     | 2022-03-20 09:48:30 | online  | no</div></pre></td></tr></table></figure>
<p>å›åˆ° macOSï¼Œæµ‹è¯•æ˜¯å¦èƒ½ ping é€šå¯¹ç«¯èŠ‚ç‚¹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ ping -c 2 10.1.0.1</div><div class="line">PING 10.1.0.1 (10.1.0.1): 56 data bytes</div><div class="line">64 bytes from 10.1.0.1: icmp_seq=0 ttl=64 time=37.025 ms</div><div class="line">64 bytes from 10.1.0.1: icmp_seq=1 ttl=64 time=38.181 ms</div><div class="line"></div><div class="line">--- 10.1.0.1 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0.0% packet loss</div><div class="line">round-trip min/avg/max/stddev = 37.025/37.603/38.181/0.578 ms</div></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ Tailscale CLI æ¥æµ‹è¯•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ /Applications/Tailscale.app/Contents/MacOS/Tailscale ping 10.1.0.1</div><div class="line">pong from coredns (10.1.0.1) via xxxx:41641 <span class="keyword">in</span> 36ms</div></pre></td></tr></table></figure>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>Windows Tailscale å®¢æˆ·ç«¯æƒ³è¦ä½¿ç”¨ Headscale ä½œä¸ºæ§åˆ¶æœåŠ¡å™¨ï¼Œåªéœ€åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ URLï¼š<code>http://&lt;HEADSCALE_PUB_IP&gt;:8080/windows</code>ï¼Œä¾¿ä¼šå‡ºç°å¦‚ä¸‹çš„ç•Œé¢</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-23-30-zcQX3F.png" alt=""></p>
<p>æŒ‰ç…§å…¶ä¸­çš„æ­¥éª¤æ“ä½œå³å¯ã€‚</p>
<h3 id="é€šè¿‡-Pre-Authkeys-æ¥å…¥"><a href="#é€šè¿‡-Pre-Authkeys-æ¥å…¥" class="headerlink" title="é€šè¿‡ Pre-Authkeys æ¥å…¥"></a>é€šè¿‡ Pre-Authkeys æ¥å…¥</h3><p>å‰é¢çš„æ¥å…¥æ–¹æ³•éƒ½éœ€è¦æœåŠ¡ç«¯åŒæ„ï¼Œæ­¥éª¤æ¯”è¾ƒçƒ¦çï¼Œå…¶å®è¿˜æœ‰æ›´ç®€å•çš„æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥æ¥å…¥ï¼Œä¸éœ€è¦æœåŠ¡ç«¯åŒæ„ã€‚</p>
<p>é¦–å…ˆåœ¨æœåŠ¡ç«¯ç”Ÿæˆ pre-authkey çš„ tokenï¼Œæœ‰æ•ˆæœŸå¯ä»¥è®¾ç½®ä¸º 24 å°æ—¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ headscale preauthkeys create <span class="_">-e</span> 24h -n default</div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹å·²ç»ç”Ÿæˆçš„ keyï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ headscale -n default preauthkeys list</div><div class="line">ID | Key                                              | Reusable | Ephemeral | Used  | Expiration          | Created            </div><div class="line">1  | 57e419c40e30b0dxxxxxxxf15562c18a8c6xxxx28ae76f57 | <span class="literal">false</span>    | <span class="literal">false</span>     | <span class="literal">false</span> | 2022-05-30 07:14:17 | 2022-05-29 07:14:17</div></pre></td></tr></table></figure>
<p>ç°åœ¨æ–°èŠ‚ç‚¹å°±å¯ä»¥æ— éœ€æœåŠ¡ç«¯åŒæ„ç›´æ¥æ¥å…¥äº†ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tailscale up --login-server=http://&lt;HEADSCALE_PUB_IP&gt;:8080 --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --authkey <span class="variable">$KEY</span></div></pre></td></tr></table></figure>
<h2 id="æ‰“é€šå±€åŸŸç½‘"><a href="#æ‰“é€šå±€åŸŸç½‘" class="headerlink" title="æ‰“é€šå±€åŸŸç½‘"></a>æ‰“é€šå±€åŸŸç½‘</h2><p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬åªæ˜¯æ‰“é€ äº†ä¸€ä¸ªç‚¹å¯¹ç‚¹çš„ Mesh ç½‘ç»œï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´éƒ½å¯ä»¥é€šè¿‡ WireGuard çš„ç§æœ‰ç½‘ç»œ IP è¿›è¡Œç›´è¿ã€‚ä½†æˆ‘ä»¬å¯ä»¥æ›´å¤§èƒ†ä¸€ç‚¹ï¼Œè¿˜è®°å¾—æˆ‘åœ¨æ–‡ç« å¼€å¤´æåˆ°çš„è®¿é—®å®¶åº­å†…ç½‘çš„èµ„æºå—ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡é€‚å½“çš„é…ç½®è®©æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è®¿é—®å…¶ä»–èŠ‚ç‚¹çš„å±€åŸŸç½‘ IPã€‚è¿™ä¸ªä½¿ç”¨åœºæ™¯å°±æ¯”è¾ƒå¤šäº†ï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—®å®¶åº­å†…ç½‘çš„ NASï¼Œæˆ–è€…å†…ç½‘çš„ä»»ä½•ä¸€ä¸ªæœåŠ¡ï¼Œ<strong>æ›´é«˜çº§çš„ç©å®¶å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ¥è®¿é—®äº‘ä¸Š Kubernetes é›†ç¾¤çš„ Pod IP å’Œ Service IPã€‚</strong></p>
<p>å‡è®¾ä½ çš„å®¶åº­å†…ç½‘æœ‰ä¸€å° Linux ä¸»æœºï¼ˆæ¯”å¦‚ OpenWrtï¼‰å®‰è£…äº† Tailscale å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å¸Œæœ›å…¶ä»– Tailscale å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥é€šè¿‡å®¶ä¸­çš„å±€åŸŸç½‘ IPï¼ˆä¾‹å¦‚ <strong>192.168.100.0/24</strong>ï¼‰ è®¿é—®å®¶åº­å†…ç½‘çš„ä»»ä½•ä¸€å°è®¾å¤‡ã€‚</p>
<p>é…ç½®æ–¹æ³•å¾ˆç®€å•ï¼Œé¦–å…ˆéœ€è¦è®¾ç½® IPv4 ä¸ IPv6 è·¯ç”±è½¬å‘ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">echo</span> <span class="string">'net.ipv4.ip_forward = 1'</span> | tee /etc/sysctl.d/ipforwarding.conf</div><div class="line">$ <span class="built_in">echo</span> <span class="string">'net.ipv6.conf.all.forwarding = 1'</span> | tee <span class="_">-a</span> /etc/sysctl.d/ipforwarding.conf</div><div class="line">$ sysctl -p /etc/sysctl.d/ipforwarding.conf</div></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯ä¿®æ”¹æ³¨å†ŒèŠ‚ç‚¹çš„å‘½ä»¤ï¼Œåœ¨åŸæ¥å‘½ä»¤çš„åŸºç¡€ä¸ŠåŠ ä¸Šå‚æ•° <code>--advertise-routes=192.168.100.0/24</code>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tailscale up --login-server=http://&lt;HEADSCALE_PUB_IP&gt;:8080 --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.100.0/24</div></pre></td></tr></table></figure>
<p>åœ¨ Headscale ç«¯æŸ¥çœ‹è·¯ç”±ï¼Œå¯ä»¥çœ‹åˆ°ç›¸å…³è·¯ç”±æ˜¯å…³é—­çš„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ headscale nodes list|grep openwrt</div><div class="line"></div><div class="line">6 | openwrt | [7LdVc] | default | 10.1.0.6 | <span class="literal">false</span> | 2022-03-20 15:50:46 | onlin</div><div class="line"></div><div class="line">e | no</div><div class="line"></div><div class="line">$ headscale routes list -i 6</div><div class="line"></div><div class="line">Route | Enabled</div><div class="line"></div><div class="line">192.168.100.0/24 | <span class="literal">false</span></div></pre></td></tr></table></figure>
<p>å¼€å¯è·¯ç”±ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ headscale routes <span class="built_in">enable</span> -i 6 -r <span class="string">"192.168.100.0/24"</span></div><div class="line"></div><div class="line">Route | Enabled</div><div class="line"></div><div class="line">192.168.100.0/24 | <span class="literal">true</span></div></pre></td></tr></table></figure>
<p>å…¶ä»–èŠ‚ç‚¹æŸ¥çœ‹è·¯ç”±ç»“æœï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ip route show table 52|grep <span class="string">"192.168.100.0/24"</span></div><div class="line">192.168.100.0/24 dev tailscale0</div></pre></td></tr></table></figure>
<p>ç°åœ¨ä½ åœ¨ä»»ä½•ä¸€ä¸ª Tailscale å®¢æˆ·ç«¯æ‰€åœ¨çš„èŠ‚ç‚¹éƒ½å¯ä»¥ ping é€šå®¶åº­å†…ç½‘çš„æœºå™¨.</p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Tailscale-æ˜¯ä»€ä¹ˆ&quot;&gt;&lt;a href=&quot;#Tailscale-æ˜¯ä»€ä¹ˆ&quot; class=&quot;headerlink&quot; title=&quot;Tailscale æ˜¯ä»€ä¹ˆ&quot;&gt;&lt;/a&gt;Tailscale æ˜¯ä»€ä¹ˆ&lt;/h2&gt;&lt;p&gt;Tailscale æ˜¯ä¸€ç§åŸºäº WireGuard 
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Elasticsearch ä¹‹Data stream</title>
    <link href="http://peterfei.me/2022/08/26/Elasticsearch-%E4%B9%8BData-stream/"/>
    <id>http://peterfei.me/2022/08/26/Elasticsearch-ä¹‹Data-stream/</id>
    <published>2022-08-26T09:05:46.000Z</published>
    <updated>2022-08-30T02:14:36.129Z</updated>
    
    <content type="html"><![CDATA[<ul>
<li>æ•°æ®æµ</li>
<li>Elasticsearch</li>
</ul>
<h2 id="Data-stream-çš„æ¦‚å¿µ"><a href="#Data-stream-çš„æ¦‚å¿µ" class="headerlink" title="Data stream çš„æ¦‚å¿µ"></a>Data stream çš„æ¦‚å¿µ</h2><h3 id="æ—¶åºæ€§æ•°æ®"><a href="#æ—¶åºæ€§æ•°æ®" class="headerlink" title="æ—¶åºæ€§æ•°æ®"></a>æ—¶åºæ€§æ•°æ®</h3><p>æ—¶é—´åºåˆ—æ•°æ®ï¼ˆ time series data ï¼‰æ˜¯åœ¨ä¸åŒæ—¶é—´ä¸Šæ”¶é›†åˆ°çš„æ•°æ®ï¼Œç”¨äºæ‰€æè¿°ç°è±¡éšæ—¶é—´å˜åŒ–çš„æƒ…å†µã€‚è¿™ç±»æ•°æ®åæ˜ äº†æŸä¸€äº‹ç‰©ã€ç°è±¡ç­‰ï¼Œéšæ—¶é—´çš„å˜åŒ–çŠ¶æ€æˆ–ç¨‹åº¦ã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼Œè¿™ç±»æ•°æ®ä¸»è¦åŸºäºæ—¶é—´ç‰¹æ€§æ˜æ˜¾ï¼Œéšç€æ—¶é—´çš„æµé€ï¼Œå¾€å¾€è¿‡å»æ—¶é—´çš„æ•°æ®æ²¡æœ‰ç°åœ¨æ—¶é—´çš„é‡è¦æˆ–è€…æ•æ„Ÿã€‚</p>
<p>å¯¹äº Elastisearch å¤„ç†æ—¶åºæ€§æ•°æ®ï¼Œæœ‰äººæ€»ç»“äº†ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ç”±æ—¶é—´æˆ³ + æ•°æ®ç»„æˆã€‚åŸºäºæ—¶é—´çš„äº‹ä»¶ï¼Œå¯ä»¥æ˜¯æœåŠ¡å™¨æ—¥å¿—æˆ–è€…ç¤¾äº¤åª’ä½“æµã€‚</li>
<li>é€šå¸¸æœç´¢æœ€è¿‘äº‹ä»¶ï¼Œæ—§æ–‡ä»¶å˜å¾—ä¸å¤ªé‡è¦ã€‚</li>
<li>ç´¢å¼•çš„ä½¿ç”¨ä¸»è¦åŸºäºæ—¶é—´ï¼Œä½†æ˜¯æ•°æ®å¹¶ä¸ä¸€å®šéšç€æ—¶é—´å‡è¡¡åˆ†å¸ƒã€‚</li>
<li>æ—¶åºæ€§æ•°æ®ä¸€æ—¦å­˜å…¥åå¾ˆå°‘ä¿®æ”¹ã€‚</li>
<li>æ—¶åºæ€§æ•°æ®éšç€æ—¶é—´çš„å¢åŠ ï¼Œæ•°æ®é‡ä¼šå¾ˆå¤§ã€‚</li>
</ul>
<p>Elastisearch åœ¨æ—¶åºæ€§æ•°æ®çš„ä½¿ç”¨ä¸­ï¼Œå¾€å¾€ä¼šæœ‰ä»¥ä¸‹çš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>ç´¢å¼•éšç€æ—¶é—´å¢åŠ è€Œæ•°ç›®è¾ƒå¤šã€‚</li>
<li>ç´¢å¼•å¤§å°æ— æ³•å‡è¡¡ã€‚</li>
<li>ç®¡ç†ç´¢å¼•æˆæœ¬è¾ƒé«˜ï¼Œéœ€è¦ç»´æŠ¤ merge åˆå¹¶åˆ é™¤ç­‰ä¸€ç³»åˆ—ä»»åŠ¡ã€‚</li>
<li>èŠ‚ç‚¹èµ„æºä¸å†·çƒ­æ•°æ®åˆ†å¸ƒä¸åŒ¹é…ã€‚</li>
</ul>
<p>åœ¨è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯ä¸‹ï¼Œæ•°æ®æµ Data stream åº”è¿è€Œç”Ÿã€‚</p>
<p>Data stream ï¼ˆæ•°æ®æµï¼‰æ˜¯ Elastic Stack 7.9 çš„ä¸€ä¸ªæ–°çš„åŠŸèƒ½ã€‚Data stream å¯ä»¥è·¨å¤šä¸ªç´¢å¼•å­˜å‚¨åªè¿½åŠ æ—¶åºæ€§æ•°æ®ï¼ŒåŒæ—¶ä¸ºæŸ¥è¯¢å†™å…¥ç­‰è¯·æ±‚æä¾›å”¯ä¸€çš„ä¸€ä¸ªå‘½åèµ„æºã€‚Data stream éå¸¸é€‚åˆæ—¥å¿—ï¼Œäº‹ä»¶ï¼ŒæŒ‡æ ‡ä»¥åŠå…¶ä»–æŒç»­ç”Ÿæˆçš„æ•°æ®ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼ŒData stream æ ¹æ®æ¨¡æ¿ç”Ÿæˆå­˜å‚¨æ•°æ®çš„åå¤‡ç´¢å¼•ï¼Œç„¶åè‡ªåŠ¨å°†æœç´¢æˆ–è€…ç´¢å¼•è¯·æ±‚è·¯ç”±åˆ°å­˜å‚¨æµæ•°æ®çš„åå¤‡ç´¢å¼•ã€‚è€Œè¿™äº›åå¤‡ç´¢å¼•åˆ™æ ¹æ®ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆ ILM ï¼‰æ¥è‡ªåŠ¨ç®¡ç†ã€‚</p>
<h2 id="Data-stream-çš„ç»„æˆ"><a href="#Data-stream-çš„ç»„æˆ" class="headerlink" title="Data stream çš„ç»„æˆ"></a>Data stream çš„ç»„æˆ</h2><p>æ•°æ®æµåœ¨ Elasticsearch é›†ç¾¤ä¸­ç”±ä¸€ä¸ªæˆ–å¤šä¸ªéšè—çš„ã€è‡ªåŠ¨ç”Ÿæˆçš„åå¤‡ç´¢å¼•ç»„æˆã€‚</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/2a1db1d79f6448398201a833be2e1d6c.png" alt=""></p>
<p>åœ¨å®é™…çš„ Elasticsearch æ“ä½œä¸­ï¼Œæ•°æ®æµä¾é ç´¢å¼•æ¨¡æ¿æ¥è®¾å®šæ•°æ®æµå®ä½“çš„åå¤‡ç´¢å¼•ã€‚</p>
<ul>
<li>æ¨¡æ¿åŒ…å«ç”¨äºé…ç½®æµçš„åå¤‡ç´¢å¼•çš„æ˜ å°„å’Œè®¾ç½®ã€‚</li>
<li>åŒä¸€ä¸ªç´¢å¼•æ¨¡æ¿å¯ç”¨äºå¤šä¸ªæ•°æ®æµã€‚</li>
<li>ä¸èƒ½åˆ é™¤æ•°æ®æµæ­£åœ¨ä½¿ç”¨çš„ç´¢å¼•æ¨¡æ¿ã€‚</li>
</ul>
<p>æ¯ä¸ªç´¢å¼•åˆ°æ•°æ®æµçš„æ–‡æ¡£ï¼Œå¿…é¡»åŒ…å«ä¸€ä¸ª @timestamp å­—æ®µï¼Œæ˜ å°„ä¸º date æˆ– date_nanos å­—æ®µç±»å‹ã€‚å¦‚æœç´¢å¼•æ¨¡æ¿æ²¡æœ‰ä¸º @timestamp å­—æ®µæŒ‡å®šæ˜ å°„ï¼ŒElasticsearch å°† @timestamp æ˜ å°„ä¸ºå¸¦æœ‰é»˜è®¤é€‰é¡¹çš„æ—¥æœŸå­—æ®µã€‚</p>
<p>Data stream çš„è¯»è¯·æ±‚ä¸»è¦å¦‚ä¸‹å›¾ï¼Œæ•°æ®æµè‡ªåŠ¨å°†è¯·æ±‚è·¯ç”±åˆ°å…¶æ‰€æœ‰åå¤‡ç´¢å¼•ã€‚</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/7f9c38c3deb84f3cb919e8581d69770b.png" alt=""></p>
<p>è€Œå¯¹äºå†™è¯·æ±‚ï¼Œæ•°æ®æµåˆ™å°†è¯¥è¯·æ±‚è‡ªåŠ¨è½¬å‘ç»™æœ€æ–°çš„åå¤‡ç´¢å¼•ã€‚</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/6d00171f1af04002b72ef6f9d263f192.png" alt=""></p>
<h2 id="Data-stream-çš„ç‰¹æ€§"><a href="#Data-stream-çš„ç‰¹æ€§" class="headerlink" title="Data stream çš„ç‰¹æ€§"></a>Data stream çš„ç‰¹æ€§</h2><h3 id="ç”Ÿæˆ"><a href="#ç”Ÿæˆ" class="headerlink" title="ç”Ÿæˆ"></a>ç”Ÿæˆ</h3><p>æ¯ä¸ª Data stream çš„åå¤‡ç´¢å¼•éƒ½æœ‰ä¸€ä¸ª generation æ•°ï¼Œä¸€ä¸ªå…­ä½æ•°ï¼Œé›¶å¡«å……çš„æ•´æ•°ï¼Œä» 000001 å¼€å§‹ï¼Œç”¨ä½œè¯¥æµçš„ rollover çš„è®¡æ•°ã€‚</p>
<p>åå¤‡ç´¢å¼•åä¸»è¦ä¾ç…§ä»¥ä¸‹æ ¼å¼ï¼š</p>
<p>.dsâ€“</p>
<p>Generation è¶Šå¤§ï¼Œåå¤‡ç´¢å¼•åŒ…å«çš„æ•°æ®è¶Šæ–°ã€‚ ä¾‹å¦‚ï¼Œweb-server-logs æ•°æ®æµæœ€æ–°çš„ generation ä¸º 34ã€‚è¯¥æµçš„æœ€æ–°åå¤‡ç´¢å¼•åä¸º .ds-web-server-logs-000034ã€‚</p>
<p>æ³¨æ„ï¼šæŸäº›æ“ä½œï¼ˆä¾‹å¦‚ shrink æˆ– restore ï¼‰å¯ä»¥æ›´æ”¹åå¤‡ç´¢å¼•çš„åç§°ã€‚ è¿™äº›åç§°æ›´æ”¹ä¸ä¼šä»å…¶æ•°æ®æµä¸­åˆ é™¤åå¤‡ç´¢å¼•ã€‚</p>
<h3 id="Rollover"><a href="#Rollover" class="headerlink" title="Rollover"></a>Rollover</h3><p>åœ¨ Data stream çš„ä½¿ç”¨ä¸­ï¼Œrollover æ˜¯å¿…ä¸å¯å°‘çš„æ¡ä»¶ã€‚</p>
<p>åˆ›å»ºæ•°æ®æµæ—¶ï¼ŒElasticsearch ä¼šè‡ªåŠ¨ä¸ºè¯¥ Data stream æ ¹æ® template åˆ›å»ºä¸€ä¸ªåå¤‡ç´¢å¼•ã€‚ è¯¥ç´¢å¼•è¿˜å……å½“æµçš„ç¬¬ä¸€ä¸ªå†™å…¥ç´¢å¼•ã€‚å½“æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶ï¼Œ rollover ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„åå¤‡ç´¢å¼•ï¼Œè¯¥åå¤‡ç´¢å¼•å°†æˆä¸º Data stream çš„æ–°å†™å…¥ç´¢å¼•ã€‚</p>
<p>å½“ç„¶ rollover çš„æ¡ä»¶è®¾ç½®ä¸»è¦ä¾é  ILMã€‚ å¦‚æœéœ€è¦ï¼Œä½ è¿˜å¯ä»¥æ‰‹åŠ¨å°†æ•°æ® rollover ã€‚</p>
<h3 id="è¿½åŠ "><a href="#è¿½åŠ " class="headerlink" title="è¿½åŠ "></a>è¿½åŠ </h3><p>ç”±äºæ—¶åºæ€§æ•°æ®çš„ç‰¹å¾ï¼ŒData stream çš„è®¾è®¡åœºæ™¯ä¸­ï¼Œæ•°æ®æ˜¯åªè¿½åŠ çš„ï¼Œæå°‘éœ€è¦ä¿®æ”¹åˆ é™¤ã€‚å¦‚æœå®é™…éœ€è¦ä¿®æ”¹åˆ é™¤ï¼Œåˆ™å¯ä»¥è€ƒè™‘ä»¥ä¸‹æ“ä½œï¼š</p>
<ul>
<li>å¯¹äºæ•°æ®æµåªèƒ½é€šè¿‡ update by query æˆ–è€… delete by query æ“ä½œï¼Œä¸èƒ½è¿›è¡Œ update æˆ–è€… delete æ–‡æ¡£ã€‚</li>
<li>éœ€è¦ delete æˆ–è€… update æ–‡æ¡£ï¼Œåˆ™ç›´æ¥å¯¹åå¤‡ç´¢å¼•æ“ä½œã€‚</li>
<li>éœ€è¦ç»å¸¸åˆ é™¤æˆ–è€…ä¿®æ”¹æ–‡æ¡£çš„ï¼Œè¯·ä½¿ç”¨ç´¢å¼•åˆ«åæˆ–è€…ç´¢å¼•æ¨¡æ¿ï¼Œä¸è¦å¯¹ Data stream æ“ä½œã€‚</li>
</ul>
<h2 id="Data-stream-çš„ä½¿ç”¨"><a href="#Data-stream-çš„ä½¿ç”¨" class="headerlink" title="Data stream çš„ä½¿ç”¨"></a>Data stream çš„ä½¿ç”¨</h2><h3 id="åˆ›å»ºç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥-ILM"><a href="#åˆ›å»ºç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥-ILM" class="headerlink" title="åˆ›å»ºç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥ ILM"></a>åˆ›å»ºç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥ ILM</h3><p>ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥ ILM çš„ä¸»è¦é…ç½®ç»†èŠ‚è§ç´¢å¼•å‘¨æœŸç®¡ç†ä¸€ç« ï¼Œæ­¤å¤„ä¸»è¦åš hot å’Œ delete é˜¶æ®µçš„è®¾ç½®ï¼Œç”¨äº rollover çš„å¼•ç”¨ã€‚</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">PUT /_ilm/policy/my-data-stream-policy</div><div class="line">&#123;</div><div class="line">  <span class="string">"policy"</span>: &#123;</div><div class="line">    <span class="string">"phases"</span>: &#123;</div><div class="line">      <span class="string">"hot"</span>: &#123;</div><div class="line">        <span class="string">"actions"</span>: &#123;</div><div class="line">          <span class="string">"rollover"</span>: &#123;</div><div class="line">            <span class="string">"max_size"</span>: <span class="string">"10mb"</span></div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="åˆ›å»ºç´¢å¼•æ¨¡æ¿"><a href="#åˆ›å»ºç´¢å¼•æ¨¡æ¿" class="headerlink" title="åˆ›å»ºç´¢å¼•æ¨¡æ¿"></a>åˆ›å»ºç´¢å¼•æ¨¡æ¿</h3><p>ç´¢å¼•æ¨¡æ¿æ˜¯åå¤‡ç´¢å¼•è®¾ç½®ï¼Œä»¥åŠ mapping çš„ä¸»è¦é…ç½®æ¥æºï¼Œæ­¤å¤„ä¸å±•å¼€å»¶ä¼¸ã€‚ä¸»è¦è®¾ç½® Data stream ç›¸å…³çš„éƒ¨åˆ†ã€‚</p>
<p>ç›¸å…³å‘½ä»¤ï¼š</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">PUT /_index_template/my-data-stream-template</div><div class="line">&#123;</div><div class="line">  <span class="string">"index_patterns"</span>: [ <span class="string">"my-data-stream*"</span> ],</div><div class="line">  <span class="string">"data_stream"</span>: &#123; &#125;,</div><div class="line">  <span class="string">"priority"</span>: <span class="number">200</span>,</div><div class="line">  <span class="string">"template"</span>: &#123;</div><div class="line">    <span class="string">"settings"</span>: &#123;</div><div class="line">      <span class="string">"index.lifecycle.name"</span>: <span class="string">"my-data-stream-policy"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼š</p>
<ol>
<li>å®šä¹‰ data_stream ä¸ºä¸€ä¸ªç©ºçš„ object ï¼Œè¿™æ˜¯å¿…è¦çš„ã€‚</li>
<li>Template ä¸­ä½¿ç”¨äº†ä¸Šä¸€æ­¥åˆ›å»ºçš„ ILM ç­–ç•¥ my-data-stream-policyã€‚</li>
</ol>
<p>æ­¤å¤–ï¼Œè¿˜éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š</p>
<ol>
<li>Elasticsearch æœ‰ä¸€äº›å†…ç½®ç´¢å¼•æ¨¡æ¿å¦‚ metric-<strong>-</strong> å’Œ logs-<strong>-</strong> ï¼Œé»˜è®¤ä¼˜å…ˆçº§ priority æ˜¯ 100ã€‚å¦‚æœæœ‰é‡åä½¿ç”¨ï¼Œåˆ™å¯ä»¥è°ƒé«˜ä¼˜å…ˆçº§ï¼Œé˜²æ­¢è¢«é»˜è®¤çš„è¦†ç›–ã€‚</li>
<li>ç´¢å¼•æ¨¡æ¿é»˜è®¤å°† @timestamp å­—æ®µè®¾ç½®ä¸º date å±æ€§</li>
</ol>
<h3 id="åˆ›å»º-Data-stream"><a href="#åˆ›å»º-Data-stream" class="headerlink" title="åˆ›å»º Data stream"></a>åˆ›å»º Data stream</h3><p>å¯ä»¥è‡ªåŠ¨åˆ©ç”¨ template çš„åŒ¹é…æ¨¡å¼æ–°å¢æ–‡æ¡£åˆ›å»º</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">PUT</span> /_data_stream/my-<span class="class"><span class="keyword">data</span>-stream</span></div></pre></td></tr></table></figure>
<h3 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h3><p>åˆ é™¤å‘½ä»¤ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">DELETE</span> <span class="regexp">/_data_stream/my</span>-data-stream</div></pre></td></tr></table></figure>
<p>åˆ é™¤æ•°æ®æµä¼šå°†æ•°æ®æµçš„åå¤‡ç´¢å¼•ä¸€èµ·åˆ é™¤ã€‚</p>
<h2 id="ä½¿ç”¨-Data-stream"><a href="#ä½¿ç”¨-Data-stream" class="headerlink" title="ä½¿ç”¨ Data stream"></a>ä½¿ç”¨ Data stream</h2><p>æ­¤å¤„å¯¹æ•°æ®æµçš„æ“ä½œä¸»è¦ä»¥å‘½ä»¤ä¸ºä¸»</p>
<h3 id="æ–°å¢æ•°æ®"><a href="#æ–°å¢æ•°æ®" class="headerlink" title="æ–°å¢æ•°æ®"></a>æ–°å¢æ•°æ®</h3><p>Data stream åœ¨æ–°å¢æ•°æ®æ—¶æ˜¯åªè¿½åŠ çš„æ¨¡å¼ï¼Œå› æ­¤åœ¨å›ºå®š id å’Œ bulk çš„æ¨¡å¼ä¸‹ï¼Œop_type æ˜¯æŒ‡å®š create çš„ã€‚</p>
<p>å¦‚ä¸‹é¢å‘½ä»¤ï¼š</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">POST</span> my-<span class="meta">data</span>-<span class="keyword">stream/_create/1</span></div><div class="line">&#123;<span class="string">"@timestamp"</span>:<span class="string">"2020-12-07T11:06:07.000Z"</span>,<span class="string">"test"</span>:<span class="number">1</span>&#125;</div></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">PUT /my-data-stream/_bulk?refresh</div><div class="line">&#123;<span class="string">"create"</span>:&#123; &#125;&#125;</div><div class="line">&#123; <span class="string">"@timestamp"</span>: <span class="string">"2020-12-08T11:04:05.000Z"</span>, <span class="string">"user"</span>: &#123; <span class="string">"id"</span>: <span class="string">"vlb44hny"</span> &#125;, <span class="string">"message"</span>: <span class="string">"Login attempt failed"</span> &#125;</div><div class="line">&#123;<span class="string">"create"</span>:&#123; &#125;&#125;</div><div class="line">&#123; <span class="string">"@timestamp"</span>: <span class="string">"2020-12-08T11:06:07.000Z"</span>, <span class="string">"user"</span>: &#123; <span class="string">"id"</span>: <span class="string">"8a4f500d"</span> &#125;, <span class="string">"message"</span>: <span class="string">"Login successful"</span> &#125;</div><div class="line">&#123;<span class="string">"create"</span>:&#123; &#125;&#125;</div><div class="line">&#123; <span class="string">"@timestamp"</span>: <span class="string">"2020-12-09T11:07:08.000Z"</span>, <span class="string">"user"</span>: &#123; <span class="string">"id"</span>: <span class="string">"l7gk7f82"</span> &#125;, <span class="string">"message"</span>: <span class="string">"Logout successful"</span> &#125;</div></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST /_reindex</div><div class="line">&#123;</div><div class="line">  <span class="string">"source"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"kibana_sample_data_logs_new"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"dest"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"my-data-stream"</span>,</div><div class="line">    <span class="string">"op_type"</span>: <span class="string">"create"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å› å­—æ®µä¸­<code>@timestamp</code>æ˜¯å¿…å¡«ï¼Œå®éªŒæ•°æ®å¦‚ä¸‹æ”¹åŠ¨ï¼š</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  <span class="string">"source"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"kibana_sample_data_logs"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"dest"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"kibana_sample_data_logs_new"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"script"</span>: &#123;</div><div class="line">    <span class="string">"source"</span>: <span class="string">"ctx._source['@timestamp'] = ctx._source.remove(\"</span>timestamp\<span class="string">")"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="è·å–-Data-stream-çŠ¶æ€"><a href="#è·å–-Data-stream-çŠ¶æ€" class="headerlink" title="è·å– Data stream çŠ¶æ€"></a>è·å– Data stream çŠ¶æ€</h3><p>ä½¿ç”¨ Data stream stats API æŸ¥çœ‹ Data stream çš„çŠ¶æ€ã€‚</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /<span class="variable">_data_stream</span>/my-data-stream/<span class="variable">_stats</span>?human=<span class="literal">true</span></div></pre></td></tr></table></figure>
<p>åŒæ—¶éœ€è¦ç”¨ _ilm/explain è·å– Data stream åå¤‡ç´¢å¼•æ‰€åœ¨çš„ ILM ç­–ç•¥çŠ¶æ€ã€‚</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">GET</span> my-<span class="class"><span class="keyword">data</span>-stream/_ilm/explain</span></div></pre></td></tr></table></figure>
<h3 id="æ‰‹åŠ¨-rollover-Data-stream"><a href="#æ‰‹åŠ¨-rollover-Data-stream" class="headerlink" title="æ‰‹åŠ¨ rollover Data stream"></a>æ‰‹åŠ¨ rollover Data stream</h3><p>ä½¿ç”¨ rollover APIï¼Œæ‰‹åŠ¨ rollover Data streamã€‚</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">POST</span> my-<span class="class"><span class="keyword">data</span>-stream/_rollover</span></div></pre></td></tr></table></figure>
<p>Response:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"acknowledged"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="attr">"shards_acknowledged"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="attr">"old_index"</span> : <span class="string">".ds-my-data-stream-000001"</span>,</div><div class="line">  <span class="attr">"new_index"</span> : <span class="string">".ds-my-data-stream-000002"</span>,</div><div class="line">  <span class="attr">"rolled_over"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="attr">"dry_run"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="attr">"conditions"</span> : &#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å† GET ç›¸å…³ Data stream çŠ¶æ€ï¼Œåå¤‡ç´¢å¼•å¢åŠ ã€‚</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">GET</span> /_data_stream/my-<span class="class"><span class="keyword">data</span>-stream/</span></div></pre></td></tr></table></figure>
<p>Response:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"data_streams"</span> : [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span> : <span class="string">"my-data-stream"</span>,</div><div class="line">      <span class="attr">"timestamp_field"</span> : &#123;</div><div class="line">        <span class="attr">"name"</span> : <span class="string">"@timestamp"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"indices"</span> : [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"index_name"</span> : <span class="string">".ds-my-data-stream-000001"</span>,</div><div class="line">          <span class="attr">"index_uuid"</span> : <span class="string">"AJBi0g3fRyG8-1tiH2UD2Q"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"index_name"</span> : <span class="string">".ds-my-data-stream-000002"</span>,</div><div class="line">          <span class="attr">"index_uuid"</span> : <span class="string">"AgOLGMSBSYWb4X-ID8uwtg"</span></div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="attr">"generation"</span> : <span class="number">2</span>,</div><div class="line">      <span class="attr">"status"</span> : <span class="string">"GREEN"</span>,</div><div class="line">      <span class="attr">"template"</span> : <span class="string">"my-data-stream-template"</span>,</div><div class="line">      <span class="attr">"ilm_policy"</span> : <span class="string">"my-data-stream-policy"</span>,</div><div class="line">      <span class="attr">"hidden"</span> : <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Reindex-Data-stream"><a href="#Reindex-Data-stream" class="headerlink" title="Reindex Data stream"></a>Reindex Data stream</h3><p>ä½¿ç”¨ reindex API å»å¤åˆ¶æ•°æ®åˆ°ä¸€ä¸ª Data streamã€‚ç”±äº Data stream çš„åªè¿½åŠ ç‰¹æ€§ï¼Œåœ¨ op_type ä¸­è¦é€‰æ‹©ä¸º create ã€‚</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST /_reindex</div><div class="line">&#123;</div><div class="line">  <span class="string">"source"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"test"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"dest"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"my-data-stream"</span>,</div><div class="line">    <span class="string">"op_type"</span>: <span class="string">"create"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Response:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"took"</span> : <span class="number">80</span>,</div><div class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="attr">"total"</span> : <span class="number">1</span>,</div><div class="line">  <span class="attr">"updated"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"created"</span> : <span class="number">1</span>,</div><div class="line">  <span class="attr">"deleted"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"batches"</span> : <span class="number">1</span>,</div><div class="line">  <span class="attr">"version_conflicts"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"noops"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"retries"</span> : &#123;</div><div class="line">    <span class="attr">"bulk"</span> : <span class="number">0</span>,</div><div class="line">    <span class="attr">"search"</span> : <span class="number">0</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"throttled_millis"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"requests_per_second"</span> : <span class="number">-1.0</span>,</div><div class="line">  <span class="attr">"throttled_until_millis"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"failures"</span> : [ ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Delete-Update-by-query"><a href="#Delete-Update-by-query" class="headerlink" title="Delete/Update by query"></a>Delete/Update by query</h3><p>é’ˆå¯¹ Data stream åªèƒ½ delete/update by query ã€‚</p>
<p>ç›¸å…³å‘½ä»¤ï¼š</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">POST /my-data-stream/_update_by_query</div><div class="line">&#123;</div><div class="line">  <span class="string">"query"</span>: &#123;</div><div class="line">    <span class="string">"match"</span>: &#123;</div><div class="line">      <span class="string">"user.id"</span>: <span class="string">"l7gk7f82"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"script"</span>: &#123;</div><div class="line">    <span class="string">"source"</span>: <span class="string">"ctx._source.user.id = params.new_id"</span>,</div><div class="line">    <span class="string">"params"</span>: &#123;</div><div class="line">      <span class="string">"new_id"</span>: <span class="string">"XgdX0NoX"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">POST /my-data-stream/_delete_by_query</div><div class="line">&#123;</div><div class="line">  <span class="string">"query"</span>: &#123;</div><div class="line">    <span class="string">"match"</span>: &#123;</div><div class="line">      <span class="string">"user.id"</span>: <span class="string">"vlb44hny"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;æ•°æ®æµ&lt;/li&gt;
&lt;li&gt;Elasticsearch&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Data-stream-çš„æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#Data-stream-çš„æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;Data stream çš„æ¦‚å¿µ
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>ES ReIndexè¿ç§»æ•°æ®</title>
    <link href="http://peterfei.me/2022/08/26/ES-ReIndex%E8%BF%81%E7%A7%BB%E6%95%B0%E6%8D%AE/"/>
    <id>http://peterfei.me/2022/08/26/ES-ReIndexè¿ç§»æ•°æ®/</id>
    <published>2022-08-26T02:56:55.000Z</published>
    <updated>2022-08-26T03:27:32.366Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•"><a href="#ä¸€ã€ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•" class="headerlink" title="ä¸€ã€ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•"></a><strong>ä¸€ã€</strong>ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•</h1><h4 id="1ã€elasticsearch-ymlä¸­æ·»åŠ reindex-remote-whitelist-â€œxx-xx-xx-xx-9200â€-ï¼Œä¸åŠ httpï¼Œé‡å¯ESæœåŠ¡ï¼›"><a href="#1ã€elasticsearch-ymlä¸­æ·»åŠ reindex-remote-whitelist-â€œxx-xx-xx-xx-9200â€-ï¼Œä¸åŠ httpï¼Œé‡å¯ESæœåŠ¡ï¼›" class="headerlink" title="1ã€elasticsearch.ymlä¸­æ·»åŠ reindex.remote.whitelist: [â€œxx.xx.xx.xx:9200â€]ï¼Œä¸åŠ httpï¼Œé‡å¯ESæœåŠ¡ï¼›"></a>1ã€<a href="https://so.csdn.net/so/search?q=elasticsearch&amp;spm=1001.2101.3001.7020" target="_blank" rel="external">elasticsearch</a>.ymlä¸­æ·»åŠ reindex.remote.whitelist: [â€œxx.xx.xx.xx:9200â€]ï¼Œä¸åŠ httpï¼Œé‡å¯ESæœåŠ¡ï¼›</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">http.host: 0.0.0.0</div><div class="line">http.cors.enabled: true</div><div class="line">http.cors.allow-origin: &quot;*&quot;</div><div class="line">http.cors.allow-headers: Authorization</div><div class="line">xpack.security.enabled: true</div><div class="line">xpack.security.transport.ssl.enabled: true</div><div class="line">reindex.remote.whitelist: [&quot;124.70.107.101:30997&quot;,&quot;47.94.255.84:30997&quot;]</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker ps|grep elasticsearch</div><div class="line"></div><div class="line">docker exec -it elasticsearch /bin/bash</div><div class="line"></div><div class="line">vi config/elasticsearch.yml</div><div class="line"></div><div class="line">docker restart elasticsearch</div></pre></td></tr></table></figure>
<h1 id="äºŒã€ä½¿ç”¨PostManä¿®æ”¹ç›®æ ‡ä¸»æœºESå‚æ•°"><a href="#äºŒã€ä½¿ç”¨PostManä¿®æ”¹ç›®æ ‡ä¸»æœºESå‚æ•°" class="headerlink" title="äºŒã€ä½¿ç”¨PostManä¿®æ”¹ç›®æ ‡ä¸»æœºESå‚æ•°"></a><strong>äºŒã€ä½¿ç”¨PostManä¿®æ”¹ç›®æ ‡ä¸»æœºESå‚æ•°</strong></h1><h4 id="1ã€PUT-settings-pretty"><a href="#1ã€PUT-settings-pretty" class="headerlink" title="1ã€PUT _settings?pretty"></a>1ã€PUT _settings?pretty</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;index.refresh_interval&quot;: -1,</div><div class="line">  &quot;index.number_of_replicas&quot;: 0</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="ä¸‰ã€ä½¿ç”¨reindexåŒæ­¥æ•°æ®"><a href="#ä¸‰ã€ä½¿ç”¨reindexåŒæ­¥æ•°æ®" class="headerlink" title="ä¸‰ã€ä½¿ç”¨reindexåŒæ­¥æ•°æ®"></a><strong>ä¸‰ã€ä½¿ç”¨reindexåŒæ­¥æ•°æ®</strong></h1><h4 id="1ã€åŒæ­¥æ•°æ®ï¼ŒPOST-reindex-wait-for-completion-false"><a href="#1ã€åŒæ­¥æ•°æ®ï¼ŒPOST-reindex-wait-for-completion-false" class="headerlink" title="1ã€åŒæ­¥æ•°æ®ï¼ŒPOST _reindex?wait_for_completion=false"></a>1ã€åŒæ­¥æ•°æ®ï¼ŒPOST _reindex?wait_for_completion=false</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"># 1ã€è¿‡æ»¤æ•°æ®</div><div class="line">&#123;</div><div class="line">    &quot;source&quot;: &#123;</div><div class="line">        &quot;remote&quot;: &#123;</div><div class="line">            &quot;host&quot;: &quot;http://47.94.255.84:30997&quot;,</div><div class="line">            &quot;username&quot;: &quot;elastic&quot;,</div><div class="line">            &quot;password&quot;: &quot;IQsMLRniP5BcYfoNzTBT&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;size&quot;: 10000,</div><div class="line">        &quot;index&quot;: &quot;aiot_towercrane_realtime_master&quot;,</div><div class="line">        &quot;query&quot;: &#123;</div><div class="line">            &quot;bool&quot;: &#123;</div><div class="line">                &quot;filter&quot;: [</div><div class="line">                    &#123;</div><div class="line">                        &quot;range&quot;: &#123;</div><div class="line">                            &quot;createTime&quot;: &#123;</div><div class="line">                                &quot;gte&quot;: 1652262590167,</div><div class="line">                                &quot;lte&quot;: 1652262590346</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        &quot;term&quot;: &#123;</div><div class="line">                            &quot;tenantId&quot;: &quot;1441953685304872961&quot;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;dest&quot;: &#123;</div><div class="line">        &quot;index&quot;: &quot;aiot_towercrane_realtime_master&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"># 2 æŸ¥è¯¢æ•°æ®</div><div class="line">&#123;</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;remote&quot;: &#123;</div><div class="line">      &quot;host&quot;: &quot;http://47.94.255.84:30997&quot;,</div><div class="line">      &quot;username&quot;: &quot;elastic&quot;,</div><div class="line">      &quot;password&quot;: &quot;IQsMLRniP5BcYfoNzTBT&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;index&quot;: &quot;aiot_deeppit_mesure_day_record_master&quot;,</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">      &quot;match&quot;: &#123;</div><div class="line">        &quot;projectId&quot;: &quot;1447476989099610114&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;aiot_deeppit_mesure_day_record_xiongan&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p> <strong>æ³¨ï¼š</strong></p>
<ul>
<li><strong>åŒæ­¥ä¹‹å‰ï¼Œéœ€è¦åˆ é™¤ç›®æ ‡ä¸»æœºä¸­å·²å­˜åœ¨ç´¢å¼•ï¼Œå¦åˆ™åŒæ­¥ä¸æˆåŠŸã€‚</strong></li>
<li><strong>åŒæ­¥ESæ•°æ®æ—¶ï¼Œå¦‚æœéœ€è¦è®¤è¯ï¼Œç›®æ ‡ä¸»æœºæ·»åŠ Basic authè®¤è¯ï¼Œæºä¸»æœºæ·»åŠ usernameå’Œpassword;</strong></li>
</ul>
</blockquote>
<h4 id="2ã€æ‰¹é‡ä¿®æ”¹æ•°æ®-POST-aiot-towercrane-param-xiongan-update-by-query"><a href="#2ã€æ‰¹é‡ä¿®æ”¹æ•°æ®-POST-aiot-towercrane-param-xiongan-update-by-query" class="headerlink" title="2ã€æ‰¹é‡ä¿®æ”¹æ•°æ® POST aiot_towercrane_param_xiongan/_update_by_query"></a>2ã€æ‰¹é‡ä¿®æ”¹æ•°æ® POST aiot_towercrane_param_xiongan/_update_by_query</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">http://144.7.110.56:9200/aiot_towercrane_param_xiongan/_update_by_query</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123; </div><div class="line">    &quot;match_all&quot;: &#123;</div><div class="line">      </div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;script&quot;: &#123;</div><div class="line">    &quot;source&quot;: &quot;ctx._source.tenantId = 1504718344228839425L &quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>æ³¨æ„ï¼šLongç±»å‹æ›´æ–°éœ€è¦æ·»åŠ L</li>
</ul>
</blockquote>
<h1 id="å››ã€æŸ¥çœ‹è¿ç§»çŠ¶å†µ"><a href="#å››ã€æŸ¥çœ‹è¿ç§»çŠ¶å†µ" class="headerlink" title="å››ã€æŸ¥çœ‹è¿ç§»çŠ¶å†µ"></a>å››ã€æŸ¥çœ‹è¿ç§»çŠ¶å†µ</h1><h4 id="1ã€æŸ¥çœ‹æ‰€æœ‰task"><a href="#1ã€æŸ¥çœ‹æ‰€æœ‰task" class="headerlink" title="1ã€æŸ¥çœ‹æ‰€æœ‰task"></a>1ã€æŸ¥çœ‹æ‰€æœ‰task</h4><p>GET _tasks?detailed=true&amp;actions=*reindex<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://144.7.110.56:9200/_tasks?detailed=true&amp;actions=*reindex</div></pre></td></tr></table></figure></p>
<p>GET _tasks/xxx?pretty<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://144.7.110.56:9200/_tasks/6kPnJej0SZKt4Y5THf6TuQ:697134?pretty</div></pre></td></tr></table></figure></p>
<h1 id="äº”ã€æ¢å¤æ–°esè®¾ç½®"><a href="#äº”ã€æ¢å¤æ–°esè®¾ç½®" class="headerlink" title="äº”ã€æ¢å¤æ–°esè®¾ç½®"></a>äº”ã€æ¢å¤æ–°esè®¾ç½®</h1><h4 id="1ã€PUT-settings-pretty-1"><a href="#1ã€PUT-settings-pretty-1" class="headerlink" title="1ã€PUT _settings?pretty"></a>1ã€PUT _settings?pretty</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;index.refresh_interval&quot;: &quot;10m&quot;,</div><div class="line">  &quot;index.number_of_replicas&quot;: 1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">boolæŸ¥è¯¢æ€»ç»“</div><div class="line"></div><div class="line">mustï¼šä¸å…³ç³»ï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ andã€‚</div><div class="line"></div><div class="line">shouldï¼šæˆ–å…³ç³»ï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ orã€‚</div><div class="line"></div><div class="line">must_notï¼šéå…³ç³»ï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ notã€‚</div><div class="line"></div><div class="line">filterï¼šè¿‡æ»¤æ¡ä»¶ã€‚</div><div class="line"></div><div class="line">rangeï¼šæ¡ä»¶ç­›é€‰èŒƒå›´ã€‚</div><div class="line"></div><div class="line">gtï¼šå¤§äºï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ &gt;ã€‚</div><div class="line"></div><div class="line">gteï¼šå¤§äºç­‰äºï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ &gt;=ã€‚</div><div class="line"></div><div class="line">ltï¼šå°äºï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ &lt;ã€‚</div><div class="line"></div><div class="line">lteï¼šå°äºç­‰äºï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ &lt;=ã€‚</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ä¸€ã€ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•&quot;&gt;&lt;a href=&quot;#ä¸€ã€ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•&quot;&gt;&lt;/a&gt;&lt;strong&gt;ä¸€ã€&lt;/strong&gt;ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•&lt;/h1&gt;&lt;h4 id=&quot;1ã€elasti
    
    </summary>
    
    
      <category term="es" scheme="http://peterfei.me/tags/es/"/>
    
      <category term="reindex" scheme="http://peterfei.me/tags/reindex/"/>
    
  </entry>
  
  <entry>
    <title>kubectl å¤‡å¿˜å•</title>
    <link href="http://peterfei.me/2021/04/30/kubectl-%E5%A4%87%E5%BF%98%E5%8D%95/"/>
    <id>http://peterfei.me/2021/04/30/kubectl-å¤‡å¿˜å•/</id>
    <published>2021-04-30T03:43:50.000Z</published>
    <updated>2022-08-26T02:42:20.310Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Kubectl-ä¸Šä¸‹æ–‡å’Œé…ç½®"><a href="#Kubectl-ä¸Šä¸‹æ–‡å’Œé…ç½®" class="headerlink" title="Kubectl ä¸Šä¸‹æ–‡å’Œé…ç½®"></a>Kubectl ä¸Šä¸‹æ–‡å’Œé…ç½®</h2><p>è®¾ç½® <code>kubectl</code> ä¸å“ªä¸ª Kubernetes é›†ç¾¤è¿›è¡Œé€šä¿¡å¹¶ä¿®æ”¹é…ç½®ä¿¡æ¯ã€‚</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">view </span><span class="comment"># æ˜¾ç¤ºåˆå¹¶çš„ kubeconfig é…ç½®ã€‚</span></div><div class="line"></div><div class="line"><span class="comment"># åŒæ—¶ä½¿ç”¨å¤šä¸ª kubeconfig æ–‡ä»¶å¹¶æŸ¥çœ‹åˆå¹¶çš„é…ç½®</span></div><div class="line"><span class="string">KUBECONFIG=</span>~/.<span class="string">kube/</span><span class="string">config:</span>~/.<span class="string">kube/</span><span class="string">kubconfig2 </span><span class="string">kubectl </span><span class="string">config </span><span class="string">view</span></div><div class="line"></div><div class="line"><span class="comment"># è·å– e2e ç”¨æˆ·çš„å¯†ç </span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">view </span>-o <span class="string">jsonpath=</span><span class="string">'&#123;.users[?(@.name == "e2e")].user.password&#125;'</span></div><div class="line"></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">view </span>-o <span class="string">jsonpath=</span><span class="string">'&#123;.users[].name&#125;'</span>    <span class="comment"># æ˜¾ç¤ºç¬¬ä¸€ä¸ªç”¨æˆ·</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">view </span>-o <span class="string">jsonpath=</span><span class="string">'&#123;.users[*].name&#125;'</span>   <span class="comment"># è·å–ç”¨æˆ·åˆ—è¡¨</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="built_in">get-contexts</span>                          <span class="comment"># æ˜¾ç¤ºä¸Šä¸‹æ–‡åˆ—è¡¨</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">current-context </span>                      <span class="comment"># å±•ç¤ºå½“å‰æ‰€å¤„çš„ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">use-context </span><span class="string">my-cluster-</span><span class="string">name </span>          <span class="comment"># è®¾ç½®é»˜è®¤çš„ä¸Šä¸‹æ–‡ä¸º my-cluster-name</span></div><div class="line"></div><div class="line"><span class="comment"># æ·»åŠ æ–°çš„ç”¨æˆ·é…ç½®åˆ° kubeconf ä¸­ï¼Œä½¿ç”¨ basic auth è¿›è¡Œèº«ä»½è®¤è¯</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="built_in">set-credentials</span> <span class="string">kubeuser/</span><span class="string">foo.</span><span class="string">kubernetes.</span><span class="string">com </span><span class="built_in">--username=kubeuser</span> <span class="built_in">--password=kubepassword</span></div><div class="line"></div><div class="line"><span class="comment"># åœ¨æŒ‡å®šä¸Šä¸‹æ–‡ä¸­æŒä¹…æ€§åœ°ä¿å­˜åå­—ç©ºé—´ï¼Œä¾›æ‰€æœ‰åç»­ kubectl å‘½ä»¤ä½¿ç”¨</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="built_in">set-context</span> <span class="built_in">--current</span> <span class="built_in">--namespace=ggckad-s2</span></div><div class="line"></div><div class="line"><span class="comment"># ä½¿ç”¨ç‰¹å®šçš„ç”¨æˆ·åå’Œåå­—ç©ºé—´è®¾ç½®ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="built_in">set-context</span> <span class="string">gce </span><span class="built_in">--user=cluster-admin</span> <span class="built_in">--namespace=foo</span> \</div><div class="line">  &amp;&amp; <span class="string">kubectl </span><span class="string">config </span><span class="string">use-context </span><span class="string">gce</span></div><div class="line"></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">unset </span><span class="string">users.</span><span class="string">foo </span>                      <span class="comment"># åˆ é™¤ç”¨æˆ· foo</span></div></pre></td></tr></table></figure>
<h2 id="Kubectl-apply"><a href="#Kubectl-apply" class="headerlink" title="Kubectl apply"></a>Kubectl apply</h2><p><code>apply</code> é€šè¿‡å®šä¹‰ Kubernetes èµ„æºçš„æ–‡ä»¶æ¥ç®¡ç†åº”ç”¨ã€‚ å®ƒé€šè¿‡è¿è¡Œ <code>kubectl apply</code> åœ¨é›†ç¾¤ä¸­åˆ›å»ºå’Œæ›´æ–°èµ„æºã€‚ è¿™æ˜¯åœ¨ç”Ÿäº§ä¸­ç®¡ç† Kubernetes åº”ç”¨çš„æ¨èæ–¹æ³•</p>
<h2 id="åˆ›å»ºå¯¹è±¡"><a href="#åˆ›å»ºå¯¹è±¡" class="headerlink" title="åˆ›å»ºå¯¹è±¡ "></a>åˆ›å»ºå¯¹è±¡<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#creating-objects" target="_blank" rel="external"> </a></h2><p>Kubernetes é…ç½®å¯ä»¥ç”¨ YAML æˆ– JSON å®šä¹‰ã€‚å¯ä»¥ä½¿ç”¨çš„æ–‡ä»¶æ‰©å±•åæœ‰ <code>.yaml</code>ã€<code>.yml</code> å’Œ <code>.json</code>ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">kubectl apply -f ./my-manifest.yaml           <span class="comment"># åˆ›å»ºèµ„æº</span></div><div class="line">kubectl apply -f ./my1.yaml -f ./my2.yaml     <span class="comment"># ä½¿ç”¨å¤šä¸ªæ–‡ä»¶åˆ›å»º</span></div><div class="line">kubectl apply -f ./dir                        <span class="comment"># åŸºäºç›®å½•ä¸‹çš„æ‰€æœ‰æ¸…å•æ–‡ä»¶åˆ›å»ºèµ„æº</span></div><div class="line">kubectl apply -f https://git.io/vPieo         <span class="comment"># ä» URL ä¸­åˆ›å»ºèµ„æº</span></div><div class="line">kubectl create deployment nginx --image=nginx <span class="comment"># å¯åŠ¨å•å®ä¾‹ nginx</span></div><div class="line"></div><div class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ‰“å° â€œHello Worldâ€ çš„ Job</span></div><div class="line">kubectl create job hello --image=busybox -- echo <span class="string">"Hello World"</span> </div><div class="line"></div><div class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ‰“å° â€œHello Worldâ€ é—´éš”1åˆ†é’Ÿçš„ CronJob</span></div><div class="line">kubectl create cronjob hello --image=busybox   --schedule=<span class="string">"*/1 * * * *"</span> -- echo <span class="string">"Hello World"</span>    </div><div class="line"></div><div class="line">kubectl explain pods                          <span class="comment"># è·å– pod æ¸…å•çš„æ–‡æ¡£è¯´æ˜</span></div><div class="line"></div><div class="line"><span class="comment"># ä»æ ‡å‡†è¾“å…¥åˆ›å»ºå¤šä¸ª YAML å¯¹è±¡</span></div><div class="line">cat &lt;&lt;EOF | kubectl apply -f -</div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> Pod</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> busybox-sleep</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> busybox</div><div class="line"><span class="attr">    image:</span> busybox</div><div class="line"><span class="attr">    args:</span></div><div class="line"><span class="bullet">    -</span> sleep</div><div class="line"><span class="bullet">    -</span> <span class="string">"1000000"</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> Pod</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> busybox-sleep-less</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> busybox</div><div class="line"><span class="attr">    image:</span> busybox</div><div class="line"><span class="attr">    args:</span></div><div class="line"><span class="bullet">    -</span> sleep</div><div class="line"><span class="bullet">    -</span> <span class="string">"1000"</span></div><div class="line">EOF</div><div class="line"></div><div class="line"><span class="comment"># åˆ›å»ºæœ‰å¤šä¸ª key çš„ Secret</span></div><div class="line">cat &lt;&lt;EOF | kubectl apply -f -</div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> Secret</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> mysecret</div><div class="line"><span class="attr">type:</span> Opaque</div><div class="line"><span class="attr">data:</span></div><div class="line"><span class="attr">  password:</span> $(echo -n <span class="string">"s33msi4"</span> | base64 -w0)</div><div class="line"><span class="attr">  username:</span> $(echo -n <span class="string">"jane"</span> | base64 -w0)</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h2 id="æŸ¥çœ‹å’ŒæŸ¥æ‰¾èµ„æº"><a href="#æŸ¥çœ‹å’ŒæŸ¥æ‰¾èµ„æº" class="headerlink" title="æŸ¥çœ‹å’ŒæŸ¥æ‰¾èµ„æº"></a>æŸ¥çœ‹å’ŒæŸ¥æ‰¾èµ„æº</h2><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># get å‘½ä»¤çš„åŸºæœ¬è¾“å‡º</span></div><div class="line">kubectl <span class="keyword">get</span> services                          # åˆ—å‡ºå½“å‰å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ services</div><div class="line">kubectl <span class="keyword">get</span> pods --all-namespaces             # åˆ—å‡ºæ‰€æœ‰å‘½åç©ºé—´ä¸‹çš„å…¨éƒ¨çš„ Pods</div><div class="line">kubectl <span class="keyword">get</span> pods -o wide                      # åˆ—å‡ºå½“å‰å‘½åç©ºé—´ä¸‹çš„å…¨éƒ¨ Podsï¼Œå¹¶æ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯</div><div class="line">kubectl <span class="keyword">get</span> deployment my-dep                 # åˆ—å‡ºæŸä¸ªç‰¹å®šçš„ Deployment</div><div class="line">kubectl <span class="keyword">get</span> pods                              # åˆ—å‡ºå½“å‰å‘½åç©ºé—´ä¸‹çš„å…¨éƒ¨ Pods</div><div class="line">kubectl <span class="keyword">get</span> pod my-pod -o yaml                # è·å–ä¸€ä¸ª pod çš„ YAML</div><div class="line"></div><div class="line"><span class="meta"># describe å‘½ä»¤çš„è¯¦ç»†è¾“å‡º</span></div><div class="line">kubectl describe nodes my-node</div><div class="line">kubectl describe pods my-pod</div><div class="line"></div><div class="line"><span class="meta"># åˆ—å‡ºå½“å‰åå­—ç©ºé—´ä¸‹æ‰€æœ‰ Servicesï¼ŒæŒ‰åç§°æ’åº</span></div><div class="line">kubectl <span class="keyword">get</span> services --sort-by=.metadata.name</div><div class="line"></div><div class="line"><span class="meta"># åˆ—å‡º Podsï¼ŒæŒ‰é‡å¯æ¬¡æ•°æ’åº</span></div><div class="line">kubectl <span class="keyword">get</span> pods --sort-by=<span class="string">'.status.containerStatuses[0].restartCount'</span></div><div class="line"></div><div class="line"><span class="meta"># åˆ—ä¸¾æ‰€æœ‰ PV æŒä¹…å·ï¼ŒæŒ‰å®¹é‡æ’åº</span></div><div class="line">kubectl <span class="keyword">get</span> pv --sort-by=.spec.capacity.storage</div><div class="line"></div><div class="line"><span class="meta"># è·å–åŒ…å« app=cassandra æ ‡ç­¾çš„æ‰€æœ‰ Pods çš„ version æ ‡ç­¾</span></div><div class="line">kubectl <span class="keyword">get</span> pods --selector=app=cassandra -o \</div><div class="line">  jsonpath=<span class="string">'&#123;.items[*].metadata.labels.version&#125;'</span></div><div class="line"></div><div class="line"><span class="meta"># æ£€ç´¢å¸¦æœ‰ â€œ.â€ é”®å€¼ï¼Œä¾‹ï¼š 'ca.crt'</span></div><div class="line">kubectl <span class="keyword">get</span> configmap myconfig \</div><div class="line">  -o jsonpath=<span class="string">'&#123;.data.ca\.crt&#125;'</span></div><div class="line"></div><div class="line"><span class="meta"># è·å–æ‰€æœ‰å·¥ä½œèŠ‚ç‚¹ï¼ˆä½¿ç”¨é€‰æ‹©å™¨ä»¥æ’é™¤æ ‡ç­¾åç§°ä¸º 'node-role.kubernetes.io/master' çš„ç»“æœï¼‰</span></div><div class="line">kubectl <span class="keyword">get</span> node --selector=<span class="string">'!node-role.kubernetes.io/master'</span></div><div class="line"></div><div class="line"><span class="meta"># è·å–å½“å‰å‘½åç©ºé—´ä¸­æ­£åœ¨è¿è¡Œçš„ Pods</span></div><div class="line">kubectl <span class="keyword">get</span> pods --field-selector=status.phase=Running</div><div class="line"></div><div class="line"><span class="meta"># è·å–å…¨éƒ¨èŠ‚ç‚¹çš„ ExternalIP åœ°å€</span></div><div class="line">kubectl <span class="keyword">get</span> nodes -o jsonpath=<span class="string">'&#123;.items[*].status.addresses[?(@.type=="ExternalIP")].address&#125;'</span></div><div class="line"></div><div class="line"><span class="meta"># åˆ—å‡ºå±äºæŸä¸ªç‰¹å®š RC çš„ Pods çš„åç§°</span></div><div class="line"><span class="meta"># åœ¨è½¬æ¢å¯¹äº jsonpath è¿‡äºå¤æ‚çš„åœºåˆï¼Œ"jq" å‘½ä»¤å¾ˆæœ‰ç”¨ï¼›å¯ä»¥åœ¨ https://stedolan.github.io/jq/ æ‰¾åˆ°å®ƒã€‚</span></div><div class="line">sel=$&#123;$(kubectl <span class="keyword">get</span> rc my-rc --output=json | jq -j <span class="string">'.spec.selector | to_entries | .[] | "\(.key)=\(.value),"'</span>)%?&#125;</div><div class="line">echo $(kubectl <span class="keyword">get</span> pods --selector=$sel --output=jsonpath=&#123;.items..metadata.name&#125;)</div><div class="line"></div><div class="line"><span class="meta"># æ˜¾ç¤ºæ‰€æœ‰ Pods çš„æ ‡ç­¾ï¼ˆæˆ–ä»»ä½•å…¶ä»–æ”¯æŒæ ‡ç­¾çš„ Kubernetes å¯¹è±¡ï¼‰</span></div><div class="line">kubectl <span class="keyword">get</span> pods --show-labels</div><div class="line"></div><div class="line"><span class="meta"># æ£€æŸ¥å“ªäº›èŠ‚ç‚¹å¤„äºå°±ç»ªçŠ¶æ€</span></div><div class="line">JSONPATH=<span class="string">'&#123;range .items[*]&#125;&#123;@.metadata.name&#125;:&#123;range @.status.conditions[*]&#125;&#123;@.type&#125;=&#123;@.status&#125;;&#123;end&#125;&#123;end&#125;'</span> \</div><div class="line"> &amp;&amp; kubectl <span class="keyword">get</span> nodes -o jsonpath=<span class="string">"$JSONPATH"</span> | grep <span class="string">"Ready=True"</span></div><div class="line"></div><div class="line"><span class="meta"># åˆ—å‡ºè¢«ä¸€ä¸ª Pod ä½¿ç”¨çš„å…¨éƒ¨ Secret</span></div><div class="line">kubectl <span class="keyword">get</span> pods -o json | jq <span class="string">'.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name'</span> | grep -v <span class="literal">null</span> | sort | uniq</div><div class="line"></div><div class="line"><span class="meta"># åˆ—ä¸¾æ‰€æœ‰ Pods ä¸­åˆå§‹åŒ–å®¹å™¨çš„å®¹å™¨ IDï¼ˆcontainerIDï¼‰</span></div><div class="line"><span class="meta"># Helpful when cleaning up stopped containers, while avoiding removal of initContainers.</span></div><div class="line">kubectl <span class="keyword">get</span> pods --all-namespaces -o jsonpath=<span class="string">'&#123;range .items[*].status.initContainerStatuses[*]&#125;&#123;.containerID&#125;&#123;"\n"&#125;&#123;end&#125;'</span> | cut -d/ -f3</div><div class="line"></div><div class="line"><span class="meta"># åˆ—å‡ºäº‹ä»¶ï¼ˆEventsï¼‰ï¼ŒæŒ‰æ—¶é—´æˆ³æ’åº</span></div><div class="line">kubectl <span class="keyword">get</span> events --sort-by=.metadata.creationTimestamp</div><div class="line"></div><div class="line"><span class="meta"># æ¯”è¾ƒå½“å‰çš„é›†ç¾¤çŠ¶æ€å’Œå‡å®šæŸæ¸…å•è¢«åº”ç”¨ä¹‹åçš„é›†ç¾¤çŠ¶æ€</span></div><div class="line">kubectl diff -f ./my-manifest.yaml</div><div class="line"></div><div class="line"><span class="meta"># ç”Ÿæˆä¸€ä¸ªå¥ç‚¹åˆ†éš”çš„æ ‘ï¼Œå…¶ä¸­åŒ…å«ä¸ºèŠ‚ç‚¹è¿”å›çš„æ‰€æœ‰é”®</span></div><div class="line"><span class="meta"># åœ¨å¤æ‚çš„åµŒå¥—JSONç»“æ„ä¸­å®šä½é”®æ—¶éå¸¸æœ‰ç”¨</span></div><div class="line">kubectl <span class="keyword">get</span> nodes -o json | jq -c <span class="string">'path(..)|[.[]|tostring]|join(".")'</span></div><div class="line"></div><div class="line"><span class="meta"># ç”Ÿæˆä¸€ä¸ªå¥ç‚¹åˆ†éš”çš„æ ‘ï¼Œå…¶ä¸­åŒ…å«ä¸ºpodç­‰è¿”å›çš„æ‰€æœ‰é”®</span></div><div class="line">kubectl <span class="keyword">get</span> pods -o json | jq -c <span class="string">'path(..)|[.[]|tostring]|join(".")'</span></div></pre></td></tr></table></figure>
<h2 id="æ›´æ–°èµ„æº"><a href="#æ›´æ–°èµ„æº" class="headerlink" title="æ›´æ–°èµ„æº "></a>æ›´æ–°èµ„æº<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#æ›´æ–°èµ„æº" target="_blank" rel="external"> </a></h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">kubectl <span class="built_in">set</span> image deployment/frontend www=image:v2               <span class="comment"># æ»šåŠ¨æ›´æ–° "frontend" Deployment çš„ "www" å®¹å™¨é•œåƒ</span></div><div class="line">kubectl rollout history deployment/frontend                      <span class="comment"># æ£€æŸ¥ Deployment çš„å†å²è®°å½•ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬</span></div><div class="line">kubectl rollout undo deployment/frontend                         <span class="comment"># å›æ»šåˆ°ä¸Šæ¬¡éƒ¨ç½²ç‰ˆæœ¬</span></div><div class="line">kubectl rollout undo deployment/frontend <span class="comment">--to-revision=2         # å›æ»šåˆ°ç‰¹å®šéƒ¨ç½²ç‰ˆæœ¬</span></div><div class="line">kubectl rollout status -w deployment/frontend                    <span class="comment"># ç›‘è§† "frontend" Deployment çš„æ»šåŠ¨å‡çº§çŠ¶æ€ç›´åˆ°å®Œæˆ</span></div><div class="line">kubectl rollout restart deployment/frontend                      <span class="comment"># è½®æ›¿é‡å¯ "frontend" Deployment</span></div><div class="line"></div><div class="line">cat pod.json | kubectl <span class="built_in">replace</span> -f -                              <span class="comment"># é€šè¿‡ä¼ å…¥åˆ°æ ‡å‡†è¾“å…¥çš„ JSON æ¥æ›¿æ¢ Pod</span></div><div class="line"></div><div class="line"><span class="comment"># å¼ºåˆ¶æ›¿æ¢ï¼Œåˆ é™¤åé‡å»ºèµ„æºã€‚ä¼šå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚</span></div><div class="line">kubectl <span class="built_in">replace</span> <span class="comment">--force -f ./pod.json</span></div><div class="line"></div><div class="line"><span class="comment"># ä¸ºå¤šå‰¯æœ¬çš„ nginx åˆ›å»ºæœåŠ¡ï¼Œä½¿ç”¨ 80 ç«¯å£æä¾›æœåŠ¡ï¼Œè¿æ¥åˆ°å®¹å™¨çš„ 8000 ç«¯å£ã€‚</span></div><div class="line">kubectl expose rc nginx <span class="comment">--port=80 --target-port=8000</span></div><div class="line"></div><div class="line"><span class="comment"># å°†æŸå•å®¹å™¨ Pod çš„é•œåƒç‰ˆæœ¬ï¼ˆæ ‡ç­¾ï¼‰æ›´æ–°åˆ° v4</span></div><div class="line">kubectl <span class="built_in">get</span> pod mypod -o yaml | sed <span class="string">'s/\(image: myimage\):.*$/\1:v4/'</span> | kubectl <span class="built_in">replace</span> -f -</div><div class="line"></div><div class="line">kubectl label pods my-pod <span class="built_in">new</span>-label=awesome                      <span class="comment"># æ·»åŠ æ ‡ç­¾</span></div><div class="line">kubectl annotate pods my-pod icon-url=<span class="keyword">http</span>://goo.gl/XXBTWq       <span class="comment"># æ·»åŠ æ³¨è§£</span></div><div class="line">kubectl autoscale deployment foo <span class="comment">--min=2 --max=10                # å¯¹ "foo" Deployment è‡ªåŠ¨ä¼¸ç¼©å®¹</span></div></pre></td></tr></table></figure>
<h2 id="éƒ¨åˆ†æ›´æ–°èµ„æº"><a href="#éƒ¨åˆ†æ›´æ–°èµ„æº" class="headerlink" title="éƒ¨åˆ†æ›´æ–°èµ„æº "></a>éƒ¨åˆ†æ›´æ–°èµ„æº<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#éƒ¨åˆ†æ›´æ–°èµ„æº" target="_blank" rel="external"> </a></h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># éƒ¨åˆ†æ›´æ–°æŸèŠ‚ç‚¹</span></div><div class="line">kubectl patch <span class="keyword">node</span> <span class="title">k8s-node-1</span> -p '&#123;<span class="string">"spec"</span>:&#123;<span class="string">"unschedulable"</span>:<span class="literal">true</span>&#125;&#125;'</div><div class="line"></div><div class="line"><span class="comment"># æ›´æ–°å®¹å™¨çš„é•œåƒï¼›spec.containers[*].name æ˜¯å¿…é¡»çš„ã€‚å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªåˆå¹¶æ€§è´¨çš„ä¸»é”®ã€‚</span></div><div class="line">kubectl patch pod valid-pod -p '&#123;<span class="string">"spec"</span>:&#123;<span class="string">"containers"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"kubernetes-serve-hostname"</span>,<span class="string">"image"</span>:<span class="string">"new image"</span>&#125;]&#125;&#125;'</div><div class="line"></div><div class="line"><span class="comment"># ä½¿ç”¨å¸¦ä½ç½®æ•°ç»„çš„ JSON patch æ›´æ–°å®¹å™¨çš„é•œåƒ</span></div><div class="line">kubectl patch pod valid-pod --<span class="attr">type=</span>'json' -p='[&#123;<span class="string">"op"</span>: <span class="string">"replace"</span>, <span class="string">"path"</span>: <span class="string">"/spec/containers/0/image"</span>, <span class="string">"value"</span>:<span class="string">"new image"</span>&#125;]'</div><div class="line"></div><div class="line"><span class="comment"># ä½¿ç”¨å¸¦ä½ç½®æ•°ç»„çš„ JSON patch ç¦ç”¨æŸ Deployment çš„ livenessProbe</span></div><div class="line">kubectl patch deployment valid-deployment  --<span class="keyword">type</span> json   -p='[&#123;<span class="string">"op"</span>: <span class="string">"remove"</span>, <span class="string">"path"</span>: <span class="string">"/spec/template/spec/containers/0/livenessProbe"</span>&#125;]'</div><div class="line"></div><div class="line"><span class="comment"># åœ¨å¸¦ä½ç½®æ•°ç»„ä¸­æ·»åŠ å…ƒç´ </span></div><div class="line">kubectl patch sa default --<span class="attr">type=</span>'json' -p='[&#123;<span class="string">"op"</span>: <span class="string">"add"</span>, <span class="string">"path"</span>: <span class="string">"/secrets/1"</span>, <span class="string">"value"</span>: &#123;<span class="string">"name"</span>: <span class="string">"whatever"</span> &#125; &#125;]'</div></pre></td></tr></table></figure>
<h2 id="ç¼–è¾‘èµ„æº"><a href="#ç¼–è¾‘èµ„æº" class="headerlink" title="ç¼–è¾‘èµ„æº "></a>ç¼–è¾‘èµ„æº<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#ç¼–è¾‘èµ„æº" target="_blank" rel="external"> </a></h2><figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl <span class="keyword">edit</span> svc/docker-registry                      <span class="meta"># ç¼–è¾‘åä¸º docker-registry çš„æœåŠ¡</span></div></pre></td></tr></table></figure>
<h2 id="åˆ é™¤èµ„æº"><a href="#åˆ é™¤èµ„æº" class="headerlink" title="åˆ é™¤èµ„æº "></a>åˆ é™¤èµ„æº<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#åˆ é™¤èµ„æº" target="_blank" rel="external"> </a></h2><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">kubectl <span class="keyword">delete</span> -f ./pod.json                                              <span class="comment"># åˆ é™¤åœ¨ pod.json ä¸­æŒ‡å®šçš„ç±»å‹å’Œåç§°çš„ Pod</span></div><div class="line">kubectl <span class="keyword">delete</span> pod,service baz foo                                        <span class="comment"># åˆ é™¤åç§°ä¸º "baz" å’Œ "foo" çš„ Pod å’ŒæœåŠ¡</span></div><div class="line">kubectl <span class="keyword">delete</span> pods,services -l name=myLabel                              <span class="comment"># åˆ é™¤åŒ…å« name=myLabel æ ‡ç­¾çš„ pods å’ŒæœåŠ¡</span></div><div class="line">kubectl -n my-ns <span class="keyword">delete</span> pod,svc --all                                     <span class="comment"># åˆ é™¤åœ¨ my-ns åå­—ç©ºé—´ä¸­å…¨éƒ¨çš„ Pods å’ŒæœåŠ¡</span></div><div class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰ä¸ pattern1 æˆ– pattern2 awk æ¨¡å¼åŒ¹é…çš„ Pods</span></div><div class="line">kubectl get pods  -n mynamespace --<span class="literal">no</span>-headers=<span class="literal">true</span> | awk <span class="string">'/pattern1|pattern2/&#123;print $1&#125;'</span> | xargs  kubectl <span class="keyword">delete</span> -n mynamespace pod</div></pre></td></tr></table></figure>
<h2 id="ä¸è¿è¡Œä¸­çš„-Pods-è¿›è¡Œäº¤äº’"><a href="#ä¸è¿è¡Œä¸­çš„-Pods-è¿›è¡Œäº¤äº’" class="headerlink" title="ä¸è¿è¡Œä¸­çš„ Pods è¿›è¡Œäº¤äº’"></a>ä¸è¿è¡Œä¸­çš„ Pods è¿›è¡Œäº¤äº’</h2><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">kubectl logs <span class="keyword">my</span>-pod                                 <span class="comment"># è·å– pod æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰</span></div><div class="line">kubectl logs -l <span class="built_in">name</span>=myLabel                        <span class="comment"># è·å–å« name=myLabel æ ‡ç­¾çš„ Pods çš„æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰</span></div><div class="line">kubectl logs <span class="keyword">my</span>-pod <span class="comment">--previous                      # è·å–ä¸Šä¸ªå®¹å™¨å®ä¾‹çš„ pod æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰</span></div><div class="line">kubectl logs <span class="keyword">my</span>-pod -c <span class="keyword">my</span>-container                 <span class="comment"># è·å– Pod å®¹å™¨çš„æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡º, å¤šå®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl logs -l <span class="built_in">name</span>=myLabel -c <span class="keyword">my</span>-container        <span class="comment"># è·å–å« name=myLabel æ ‡ç­¾çš„ Pod å®¹å™¨æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡º, å¤šå®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl logs <span class="keyword">my</span>-pod -c <span class="keyword">my</span>-container <span class="comment">--previous      # è·å– Pod ä¸­æŸå®¹å™¨çš„ä¸Šä¸ªå®ä¾‹çš„æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡º, å¤šå®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl logs -f <span class="keyword">my</span>-pod                              <span class="comment"># æµå¼è¾“å‡º Pod çš„æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰</span></div><div class="line">kubectl logs -f <span class="keyword">my</span>-pod -c <span class="keyword">my</span>-container              <span class="comment"># æµå¼è¾“å‡º Pod å®¹å™¨çš„æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡º, å¤šå®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl logs -f -l <span class="built_in">name</span>=myLabel <span class="comment">--all-containers    # æµå¼è¾“å‡ºå« name=myLabel æ ‡ç­¾çš„ Pod çš„æ‰€æœ‰æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰</span></div><div class="line">kubectl <span class="built_in">run</span> -i <span class="comment">--tty busybox --image=busybox -- sh  # ä»¥äº¤äº’å¼ Shell è¿è¡Œ Pod</span></div><div class="line">kubectl <span class="built_in">run</span> nginx <span class="comment">--image=nginx -n mynamespace      # åœ¨æŒ‡å®šåå­—ç©ºé—´ä¸­è¿è¡Œ nginx Pod</span></div><div class="line">kubectl <span class="built_in">run</span> nginx <span class="comment">--image=nginx                     # è¿è¡Œ ngins Pod å¹¶å°†å…¶è§„çº¦å†™å…¥åˆ°åä¸º pod.yaml çš„æ–‡ä»¶</span></div><div class="line">  <span class="comment">--dry-run=client -o yaml &gt; pod.yaml</span></div><div class="line"></div><div class="line">kubectl attach <span class="keyword">my</span>-pod -i                            <span class="comment"># æŒ‚æ¥åˆ°ä¸€ä¸ªè¿è¡Œçš„å®¹å™¨ä¸­</span></div><div class="line">kubectl port-forward <span class="keyword">my</span>-pod <span class="number">5000</span>:<span class="number">6000</span>               <span class="comment"># åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šä¾¦å¬ç«¯å£ 5000 å¹¶è½¬å‘åˆ° my-pod ä¸Šçš„ç«¯å£ 6000</span></div><div class="line">kubectl exec <span class="keyword">my</span>-pod <span class="comment">-- ls /                         # åœ¨å·²æœ‰çš„ Pod ä¸­è¿è¡Œå‘½ä»¤ï¼ˆå•å®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl exec <span class="comment">--stdin --tty my-pod -- /bin/sh        # ä½¿ç”¨äº¤äº’ shell è®¿é—®æ­£åœ¨è¿è¡Œçš„ Pod (ä¸€ä¸ªå®¹å™¨åœºæ™¯)</span></div><div class="line">kubectl exec <span class="keyword">my</span>-pod -c <span class="keyword">my</span>-container <span class="comment">-- ls /         # åœ¨å·²æœ‰çš„ Pod ä¸­è¿è¡Œå‘½ä»¤ï¼ˆå¤šå®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl top pod POD_NAME <span class="comment">--containers               # æ˜¾ç¤ºç»™å®š Pod å’Œå…¶ä¸­å®¹å™¨çš„ç›‘æ§æ•°æ®</span></div></pre></td></tr></table></figure>
<h2 id="ä¸èŠ‚ç‚¹å’Œé›†ç¾¤è¿›è¡Œäº¤äº’"><a href="#ä¸èŠ‚ç‚¹å’Œé›†ç¾¤è¿›è¡Œäº¤äº’" class="headerlink" title="ä¸èŠ‚ç‚¹å’Œé›†ç¾¤è¿›è¡Œäº¤äº’"></a>ä¸èŠ‚ç‚¹å’Œé›†ç¾¤è¿›è¡Œäº¤äº’</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">kubectl cordon my-<span class="keyword">node</span>                                                <span class="title"># æ ‡è®° my-node</span> èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦</div><div class="line">kubectl drain my-<span class="keyword">node</span>                                                 <span class="title"># å¯¹ my-node</span> èŠ‚ç‚¹è¿›è¡Œæ¸…ç©ºæ“ä½œï¼Œä¸ºèŠ‚ç‚¹ç»´æŠ¤åšå‡†å¤‡</div><div class="line">kubectl uncordon my-<span class="keyword">node</span>                                              <span class="title"># æ ‡è®° my-node</span> èŠ‚ç‚¹ä¸ºå¯ä»¥è°ƒåº¦</div><div class="line">kubectl top <span class="keyword">node</span> <span class="title">my-node</span>                                              <span class="comment"># æ˜¾ç¤ºç»™å®šèŠ‚ç‚¹çš„åº¦é‡å€¼</span></div><div class="line">kubectl cluster<span class="literal">-inf</span>o                                                  <span class="comment"># æ˜¾ç¤ºä¸»æ§èŠ‚ç‚¹å’ŒæœåŠ¡çš„åœ°å€</span></div><div class="line">kubectl cluster<span class="literal">-inf</span>o dump                                             <span class="comment"># å°†å½“å‰é›†ç¾¤çŠ¶æ€è½¬å‚¨åˆ°æ ‡å‡†è¾“å‡º</span></div><div class="line">kubectl cluster<span class="literal">-inf</span>o dump --<span class="attr">output-directory=</span>/path/to/cluster-state   <span class="comment"># å°†å½“å‰é›†ç¾¤çŠ¶æ€è¾“å‡ºåˆ° /path/to/cluster-state</span></div><div class="line"></div><div class="line"><span class="comment"># å¦‚æœå·²å­˜åœ¨å…·æœ‰æŒ‡å®šé”®å’Œæ•ˆæœçš„æ±¡ç‚¹ï¼Œåˆ™æ›¿æ¢å…¶å€¼ä¸ºæŒ‡å®šå€¼ã€‚</span></div><div class="line">kubectl taint nodes foo <span class="attr">dedicated=</span>special-user:NoSchedule</div></pre></td></tr></table></figure>
<h3 id="æ ¼å¼åŒ–è¾“å‡º"><a href="#æ ¼å¼åŒ–è¾“å‡º" class="headerlink" title="æ ¼å¼åŒ–è¾“å‡º "></a>æ ¼å¼åŒ–è¾“å‡º<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#æ ¼å¼åŒ–è¾“å‡º" target="_blank" rel="external"> </a></h3><p>è¦ä»¥ç‰¹å®šæ ¼å¼å°†è¯¦ç»†ä¿¡æ¯è¾“å‡ºåˆ°ç»ˆç«¯çª—å£ï¼Œå°† <code>-o</code>ï¼ˆæˆ–è€… <code>--output</code>ï¼‰å‚æ•°æ·»åŠ åˆ°æ”¯æŒçš„ <code>kubectl</code> å‘½ä»¤ä¸­ã€‚</p>
<table>
<thead>
<tr>
<th>è¾“å‡ºæ ¼å¼</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-o=custom-columns=&lt;spec&gt;</code></td>
<td>ä½¿ç”¨é€—å·åˆ†éš”çš„è‡ªå®šä¹‰åˆ—æ¥æ‰“å°è¡¨æ ¼</td>
</tr>
<tr>
<td><code>-o=custom-columns-file=&lt;filename&gt;</code></td>
<td>ä½¿ç”¨ <code>&lt;filename&gt;</code> æ–‡ä»¶ä¸­çš„è‡ªå®šä¹‰åˆ—æ¨¡æ¿æ‰“å°è¡¨æ ¼</td>
</tr>
<tr>
<td><code>-o=json</code></td>
<td>è¾“å‡º JSON æ ¼å¼çš„ API å¯¹è±¡</td>
</tr>
<tr>
<td><code>-o=jsonpath=&lt;template&gt;</code></td>
<td>æ‰“å° <a href="https://kubernetes.io/zh/docs/reference/kubectl/jsonpath" target="_blank" rel="external">jsonpath</a> è¡¨è¾¾å¼ä¸­å®šä¹‰çš„å­—æ®µ</td>
</tr>
<tr>
<td><code>-o=jsonpath-file=&lt;filename&gt;</code></td>
<td>æ‰“å°åœ¨ <code>&lt;filename&gt;</code> æ–‡ä»¶ä¸­å®šä¹‰çš„ <a href="https://kubernetes.io/zh/docs/reference/kubectl/jsonpath" target="_blank" rel="external">jsonpath</a> è¡¨è¾¾å¼æ‰€æŒ‡å®šçš„å­—æ®µã€‚</td>
</tr>
<tr>
<td><code>-o=name</code></td>
<td>ä»…æ‰“å°èµ„æºåç§°è€Œä¸æ‰“å°å…¶ä»–å†…å®¹</td>
</tr>
<tr>
<td><code>-o=wide</code></td>
<td>ä»¥çº¯æ–‡æœ¬æ ¼å¼è¾“å‡ºé¢å¤–ä¿¡æ¯ï¼Œå¯¹äº Pod æ¥è¯´ï¼Œè¾“å‡ºä¸­åŒ…å«äº†èŠ‚ç‚¹åç§°</td>
</tr>
<tr>
<td><code>-o=yaml</code></td>
<td>è¾“å‡º YAML æ ¼å¼çš„ API å¯¹è±¡</td>
</tr>
</tbody>
</table>
<h3 id="Kubectl-æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦å’Œè°ƒè¯•"><a href="#Kubectl-æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦å’Œè°ƒè¯•" class="headerlink" title="Kubectl æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦å’Œè°ƒè¯• "></a>Kubectl æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦å’Œè°ƒè¯•<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#kubectl-æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦å’Œè°ƒè¯•" target="_blank" rel="external"> </a></h3><p>Kubectl æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦æ˜¯é€šè¿‡ <code>-v</code> æˆ–è€… <code>--v</code> æ¥æ§åˆ¶çš„ï¼Œå‚æ•°åè·Ÿä¸€ä¸ªæ•°å­—è¡¨ç¤ºæ—¥å¿—çš„çº§åˆ«ã€‚ Kubernetes é€šç”¨çš„æ—¥å¿—ä¹ æƒ¯å’Œç›¸å…³çš„æ—¥å¿—çº§åˆ«åœ¨ <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md" target="_blank" rel="external">è¿™é‡Œ</a> æœ‰ç›¸åº”çš„æè¿°ã€‚</p>
<table>
<thead>
<tr>
<th>è¯¦ç»†ç¨‹åº¦</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--v=0</code></td>
<td>ç”¨äºé‚£äº›åº”è¯¥ <em>å§‹ç»ˆ</em> å¯¹è¿ç»´äººå‘˜å¯è§çš„ä¿¡æ¯ï¼Œå› ä¸ºè¿™äº›ä¿¡æ¯ä¸€èˆ¬å¾ˆæœ‰ç”¨ã€‚</td>
</tr>
<tr>
<td><code>--v=1</code></td>
<td>å¦‚æœæ‚¨ä¸æƒ³è¦çœ‹åˆ°å†—ä½™ä¿¡æ¯ï¼Œæ­¤å€¼æ˜¯ä¸€ä¸ªåˆç†çš„é»˜è®¤æ—¥å¿—çº§åˆ«ã€‚</td>
</tr>
<tr>
<td><code>--v=2</code></td>
<td>è¾“å‡ºæœ‰å…³æœåŠ¡çš„ç¨³å®šçŠ¶æ€çš„ä¿¡æ¯ä»¥åŠé‡è¦çš„æ—¥å¿—æ¶ˆæ¯ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½ä¸ç³»ç»Ÿä¸­çš„é‡å¤§å˜åŒ–æœ‰å…³ã€‚è¿™æ˜¯å»ºè®®å¤§å¤šæ•°ç³»ç»Ÿè®¾ç½®çš„é»˜è®¤æ—¥å¿—çº§åˆ«ã€‚</td>
</tr>
<tr>
<td><code>--v=3</code></td>
<td>åŒ…å«æœ‰å…³ç³»ç»ŸçŠ¶æ€å˜åŒ–çš„æ‰©å±•ä¿¡æ¯ã€‚</td>
</tr>
<tr>
<td><code>--v=4</code></td>
<td>åŒ…å«è°ƒè¯•çº§åˆ«çš„å†—ä½™ä¿¡æ¯ã€‚</td>
</tr>
<tr>
<td><code>--v=5</code></td>
<td>è·Ÿè¸ªçº§åˆ«çš„è¯¦ç»†ç¨‹åº¦ã€‚</td>
</tr>
<tr>
<td><code>--v=6</code></td>
<td>æ˜¾ç¤ºæ‰€è¯·æ±‚çš„èµ„æºã€‚</td>
</tr>
<tr>
<td><code>--v=7</code></td>
<td>æ˜¾ç¤º HTTP è¯·æ±‚å¤´ã€‚</td>
</tr>
<tr>
<td><code>--v=8</code></td>
<td>æ˜¾ç¤º HTTP è¯·æ±‚å†…å®¹ã€‚</td>
</tr>
<tr>
<td><code>--v=9</code></td>
<td>æ˜¾ç¤º HTTP è¯·æ±‚å†…å®¹è€Œä¸”ä¸æˆªæ–­å†…å®¹ã€‚</td>
</tr>
</tbody>
</table>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Kubectl-ä¸Šä¸‹æ–‡å’Œé…ç½®&quot;&gt;&lt;a href=&quot;#Kubectl-ä¸Šä¸‹æ–‡å’Œé…ç½®&quot; class=&quot;headerlink&quot; title=&quot;Kubectl ä¸Šä¸‹æ–‡å’Œé…ç½®&quot;&gt;&lt;/a&gt;Kubectl ä¸Šä¸‹æ–‡å’Œé…ç½®&lt;/h2&gt;&lt;p&gt;è®¾ç½® &lt;code&gt;kubectl&lt;/code
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Prometheus Operator è‡ªå®šä¹‰æŠ¥è­¦</title>
    <link href="http://peterfei.me/2021/04/29/Prometheus-Operator-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8A%A5%E8%AD%A6/"/>
    <id>http://peterfei.me/2021/04/29/Prometheus-Operator-è‡ªå®šä¹‰æŠ¥è­¦/</id>
    <published>2021-04-29T08:09:39.000Z</published>
    <updated>2022-08-26T02:42:20.302Z</updated>
    
    <content type="html"><![CDATA[<ul>
<li>prometheus</li>
<li>é’‰é’‰é¢„è­¦</li>
</ul>
<h3 id="éƒ¨ç½²Prometheus-è½¯ä»¶"><a href="#éƒ¨ç½²Prometheus-è½¯ä»¶" class="headerlink" title="éƒ¨ç½²Prometheus è½¯ä»¶"></a><strong>éƒ¨ç½²Prometheus è½¯ä»¶</strong></h3><p>é¦–å…ˆï¼Œæ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬æ‰€è¿è¡Œçš„Helmç‰ˆæœ¬</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ helm version</div><div class="line">version.BuildInfo&#123;<span class="string">Version:</span><span class="string">"v3.1.2"</span>, <span class="string">GitCommit:</span><span class="string">"d878d4d45863e42fd5cff6743294a11d28a9abce"</span>, <span class="string">GitTreeState:</span><span class="string">"clean"</span>, <span class="string">GoVersion:</span><span class="string">"go1.13.8"</span>&#125;</div></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬ä½¿ç”¨Helm 3æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªstable é•œåƒä»“åº“ï¼Œå› ä¸ºé»˜è®¤çŠ¶æ€ä¸‹ä¸ä¼šè®¾ç½®è¯¥ä»“åº“ã€‚</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@ops1</span> test]<span class="comment"># helm repo add stable http://mirror.azure.cn/kubernetes/charts/</span></div><div class="line"></div><div class="line">[root<span class="variable">@ops1</span> test]<span class="comment"># helm repo list</span></div><div class="line"></div><div class="line">NAME            URL</div><div class="line"></div><div class="line">local           <span class="symbol">http:</span>/<span class="regexp">/127.0.0.1:8879/charts</span>                       </div><div class="line"></div><div class="line">stable          <span class="symbol">http:</span>/<span class="regexp">/mirror.azure.cn/kubernetes</span><span class="regexp">/charts/</span></div><div class="line"></div><div class="line">incubator       <span class="symbol">http:</span>/<span class="regexp">/mirror.azure.cn/kubernetes</span><span class="regexp">/charts-incubator/</span></div><div class="line"></div><div class="line">[root<span class="variable">@ops1</span> test]<span class="comment"># helm repo update</span></div></pre></td></tr></table></figure>
<p>Helmé…ç½®å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å®‰è£…<code>prometheus-operator</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ kubectl <span class="keyword">create</span> namespace <span class="keyword">monitoring</span></div><div class="line">namespace/<span class="keyword">monitoring</span> created</div><div class="line">[root@ops1 <span class="keyword">test</span>]# helm <span class="keyword">search</span> prometheus</div><div class="line"></div><div class="line">stable/prometheus-<span class="keyword">operator</span>              <span class="number">8.12</span><span class="number">.0</span>          <span class="number">0.37</span><span class="number">.0</span>          Provides easy <span class="keyword">monitoring</span> definitions <span class="keyword">for</span> Kubernetes servi...</div><div class="line"></div><div class="line">[root@ops1 <span class="keyword">test</span>]# helm <span class="keyword">fetch</span> stable/prometheus-<span class="keyword">operator</span> <span class="comment">--version 8.12.0</span></div><div class="line"></div><div class="line">[root@ops1 <span class="keyword">test</span>]# tar -zxf prometheus-<span class="keyword">operator</span><span class="number">-8.12</span><span class="number">.0</span>.tgz </div><div class="line"></div><div class="line">$ cd prometheus-<span class="keyword">operator</span></div></pre></td></tr></table></figure>
<p>ç¼–è¾‘values.yaml</p>
<p>cat values.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div><div class="line">785</div><div class="line">786</div><div class="line">787</div><div class="line">788</div><div class="line">789</div><div class="line">790</div><div class="line">791</div><div class="line">792</div><div class="line">793</div><div class="line">794</div><div class="line">795</div><div class="line">796</div><div class="line">797</div><div class="line">798</div><div class="line">799</div><div class="line">800</div><div class="line">801</div><div class="line">802</div><div class="line">803</div><div class="line">804</div><div class="line">805</div><div class="line">806</div><div class="line">807</div><div class="line">808</div><div class="line">809</div><div class="line">810</div><div class="line">811</div><div class="line">812</div><div class="line">813</div><div class="line">814</div><div class="line">815</div><div class="line">816</div><div class="line">817</div><div class="line">818</div><div class="line">819</div><div class="line">820</div><div class="line">821</div><div class="line">822</div><div class="line">823</div><div class="line">824</div><div class="line">825</div><div class="line">826</div><div class="line">827</div><div class="line">828</div><div class="line">829</div><div class="line">830</div><div class="line">831</div><div class="line">832</div><div class="line">833</div><div class="line">834</div><div class="line">835</div><div class="line">836</div><div class="line">837</div><div class="line">838</div><div class="line">839</div><div class="line">840</div><div class="line">841</div><div class="line">842</div><div class="line">843</div><div class="line">844</div><div class="line">845</div><div class="line">846</div><div class="line">847</div><div class="line">848</div><div class="line">849</div><div class="line">850</div><div class="line">851</div><div class="line">852</div><div class="line">853</div><div class="line">854</div><div class="line">855</div><div class="line">856</div><div class="line">857</div><div class="line">858</div><div class="line">859</div><div class="line">860</div><div class="line">861</div><div class="line">862</div><div class="line">863</div><div class="line">864</div><div class="line">865</div><div class="line">866</div><div class="line">867</div><div class="line">868</div><div class="line">869</div><div class="line">870</div><div class="line">871</div><div class="line">872</div><div class="line">873</div><div class="line">874</div><div class="line">875</div><div class="line">876</div><div class="line">877</div><div class="line">878</div><div class="line">879</div><div class="line">880</div><div class="line">881</div><div class="line">882</div><div class="line">883</div><div class="line">884</div><div class="line">885</div><div class="line">886</div><div class="line">887</div><div class="line">888</div><div class="line">889</div><div class="line">890</div><div class="line">891</div><div class="line">892</div><div class="line">893</div><div class="line">894</div><div class="line">895</div><div class="line">896</div><div class="line">897</div><div class="line">898</div><div class="line">899</div><div class="line">900</div><div class="line">901</div><div class="line">902</div><div class="line">903</div><div class="line">904</div><div class="line">905</div><div class="line">906</div><div class="line">907</div><div class="line">908</div><div class="line">909</div><div class="line">910</div><div class="line">911</div><div class="line">912</div><div class="line">913</div><div class="line">914</div><div class="line">915</div><div class="line">916</div><div class="line">917</div><div class="line">918</div><div class="line">919</div><div class="line">920</div><div class="line">921</div><div class="line">922</div><div class="line">923</div><div class="line">924</div><div class="line">925</div><div class="line">926</div><div class="line">927</div><div class="line">928</div><div class="line">929</div><div class="line">930</div><div class="line">931</div><div class="line">932</div><div class="line">933</div><div class="line">934</div><div class="line">935</div><div class="line">936</div><div class="line">937</div><div class="line">938</div><div class="line">939</div><div class="line">940</div><div class="line">941</div><div class="line">942</div><div class="line">943</div><div class="line">944</div><div class="line">945</div><div class="line">946</div><div class="line">947</div><div class="line">948</div><div class="line">949</div><div class="line">950</div><div class="line">951</div><div class="line">952</div><div class="line">953</div><div class="line">954</div><div class="line">955</div><div class="line">956</div><div class="line">957</div><div class="line">958</div><div class="line">959</div><div class="line">960</div><div class="line">961</div><div class="line">962</div><div class="line">963</div><div class="line">964</div><div class="line">965</div><div class="line">966</div><div class="line">967</div><div class="line">968</div><div class="line">969</div><div class="line">970</div><div class="line">971</div><div class="line">972</div><div class="line">973</div><div class="line">974</div><div class="line">975</div><div class="line">976</div><div class="line">977</div><div class="line">978</div><div class="line">979</div><div class="line">980</div><div class="line">981</div><div class="line">982</div><div class="line">983</div><div class="line">984</div><div class="line">985</div><div class="line">986</div><div class="line">987</div><div class="line">988</div><div class="line">989</div><div class="line">990</div><div class="line">991</div><div class="line">992</div><div class="line">993</div><div class="line">994</div><div class="line">995</div><div class="line">996</div><div class="line">997</div><div class="line">998</div><div class="line">999</div><div class="line">1000</div><div class="line">1001</div><div class="line">1002</div><div class="line">1003</div><div class="line">1004</div><div class="line">1005</div><div class="line">1006</div><div class="line">1007</div><div class="line">1008</div><div class="line">1009</div><div class="line">1010</div><div class="line">1011</div><div class="line">1012</div><div class="line">1013</div><div class="line">1014</div><div class="line">1015</div><div class="line">1016</div><div class="line">1017</div><div class="line">1018</div><div class="line">1019</div><div class="line">1020</div><div class="line">1021</div><div class="line">1022</div><div class="line">1023</div><div class="line">1024</div><div class="line">1025</div><div class="line">1026</div><div class="line">1027</div><div class="line">1028</div><div class="line">1029</div><div class="line">1030</div><div class="line">1031</div><div class="line">1032</div><div class="line">1033</div><div class="line">1034</div><div class="line">1035</div><div class="line">1036</div><div class="line">1037</div><div class="line">1038</div><div class="line">1039</div><div class="line">1040</div><div class="line">1041</div><div class="line">1042</div><div class="line">1043</div><div class="line">1044</div><div class="line">1045</div><div class="line">1046</div><div class="line">1047</div><div class="line">1048</div><div class="line">1049</div><div class="line">1050</div><div class="line">1051</div><div class="line">1052</div><div class="line">1053</div><div class="line">1054</div><div class="line">1055</div><div class="line">1056</div><div class="line">1057</div><div class="line">1058</div><div class="line">1059</div><div class="line">1060</div><div class="line">1061</div><div class="line">1062</div><div class="line">1063</div><div class="line">1064</div><div class="line">1065</div><div class="line">1066</div><div class="line">1067</div><div class="line">1068</div><div class="line">1069</div><div class="line">1070</div><div class="line">1071</div><div class="line">1072</div><div class="line">1073</div><div class="line">1074</div><div class="line">1075</div><div class="line">1076</div><div class="line">1077</div><div class="line">1078</div><div class="line">1079</div><div class="line">1080</div><div class="line">1081</div><div class="line">1082</div><div class="line">1083</div><div class="line">1084</div><div class="line">1085</div><div class="line">1086</div><div class="line">1087</div><div class="line">1088</div><div class="line">1089</div><div class="line">1090</div><div class="line">1091</div><div class="line">1092</div><div class="line">1093</div><div class="line">1094</div><div class="line">1095</div><div class="line">1096</div><div class="line">1097</div><div class="line">1098</div><div class="line">1099</div><div class="line">1100</div><div class="line">1101</div><div class="line">1102</div><div class="line">1103</div><div class="line">1104</div><div class="line">1105</div><div class="line">1106</div><div class="line">1107</div><div class="line">1108</div><div class="line">1109</div><div class="line">1110</div><div class="line">1111</div><div class="line">1112</div><div class="line">1113</div><div class="line">1114</div><div class="line">1115</div><div class="line">1116</div><div class="line">1117</div><div class="line">1118</div><div class="line">1119</div><div class="line">1120</div><div class="line">1121</div><div class="line">1122</div><div class="line">1123</div><div class="line">1124</div><div class="line">1125</div><div class="line">1126</div><div class="line">1127</div><div class="line">1128</div><div class="line">1129</div><div class="line">1130</div><div class="line">1131</div><div class="line">1132</div><div class="line">1133</div><div class="line">1134</div><div class="line">1135</div><div class="line">1136</div><div class="line">1137</div><div class="line">1138</div><div class="line">1139</div><div class="line">1140</div><div class="line">1141</div><div class="line">1142</div><div class="line">1143</div><div class="line">1144</div><div class="line">1145</div><div class="line">1146</div><div class="line">1147</div><div class="line">1148</div><div class="line">1149</div><div class="line">1150</div><div class="line">1151</div><div class="line">1152</div><div class="line">1153</div><div class="line">1154</div><div class="line">1155</div><div class="line">1156</div><div class="line">1157</div><div class="line">1158</div><div class="line">1159</div><div class="line">1160</div><div class="line">1161</div><div class="line">1162</div><div class="line">1163</div><div class="line">1164</div><div class="line">1165</div><div class="line">1166</div><div class="line">1167</div><div class="line">1168</div><div class="line">1169</div><div class="line">1170</div><div class="line">1171</div><div class="line">1172</div><div class="line">1173</div><div class="line">1174</div><div class="line">1175</div><div class="line">1176</div><div class="line">1177</div><div class="line">1178</div><div class="line">1179</div><div class="line">1180</div><div class="line">1181</div><div class="line">1182</div><div class="line">1183</div><div class="line">1184</div><div class="line">1185</div><div class="line">1186</div><div class="line">1187</div><div class="line">1188</div><div class="line">1189</div><div class="line">1190</div><div class="line">1191</div><div class="line">1192</div><div class="line">1193</div><div class="line">1194</div><div class="line">1195</div><div class="line">1196</div><div class="line">1197</div><div class="line">1198</div><div class="line">1199</div><div class="line">1200</div><div class="line">1201</div><div class="line">1202</div><div class="line">1203</div><div class="line">1204</div><div class="line">1205</div><div class="line">1206</div><div class="line">1207</div><div class="line">1208</div><div class="line">1209</div><div class="line">1210</div><div class="line">1211</div><div class="line">1212</div><div class="line">1213</div><div class="line">1214</div><div class="line">1215</div><div class="line">1216</div><div class="line">1217</div><div class="line">1218</div><div class="line">1219</div><div class="line">1220</div><div class="line">1221</div><div class="line">1222</div><div class="line">1223</div><div class="line">1224</div><div class="line">1225</div><div class="line">1226</div><div class="line">1227</div><div class="line">1228</div><div class="line">1229</div><div class="line">1230</div><div class="line">1231</div><div class="line">1232</div><div class="line">1233</div><div class="line">1234</div><div class="line">1235</div><div class="line">1236</div><div class="line">1237</div><div class="line">1238</div><div class="line">1239</div><div class="line">1240</div><div class="line">1241</div><div class="line">1242</div><div class="line">1243</div><div class="line">1244</div><div class="line">1245</div><div class="line">1246</div><div class="line">1247</div><div class="line">1248</div><div class="line">1249</div><div class="line">1250</div><div class="line">1251</div><div class="line">1252</div><div class="line">1253</div><div class="line">1254</div><div class="line">1255</div><div class="line">1256</div><div class="line">1257</div><div class="line">1258</div><div class="line">1259</div><div class="line">1260</div><div class="line">1261</div><div class="line">1262</div><div class="line">1263</div><div class="line">1264</div><div class="line">1265</div><div class="line">1266</div><div class="line">1267</div><div class="line">1268</div><div class="line">1269</div><div class="line">1270</div><div class="line">1271</div><div class="line">1272</div><div class="line">1273</div><div class="line">1274</div><div class="line">1275</div><div class="line">1276</div><div class="line">1277</div><div class="line">1278</div><div class="line">1279</div><div class="line">1280</div><div class="line">1281</div><div class="line">1282</div><div class="line">1283</div><div class="line">1284</div><div class="line">1285</div><div class="line">1286</div><div class="line">1287</div><div class="line">1288</div><div class="line">1289</div><div class="line">1290</div><div class="line">1291</div><div class="line">1292</div><div class="line">1293</div><div class="line">1294</div><div class="line">1295</div><div class="line">1296</div><div class="line">1297</div><div class="line">1298</div><div class="line">1299</div><div class="line">1300</div><div class="line">1301</div><div class="line">1302</div><div class="line">1303</div><div class="line">1304</div><div class="line">1305</div><div class="line">1306</div><div class="line">1307</div><div class="line">1308</div><div class="line">1309</div><div class="line">1310</div><div class="line">1311</div><div class="line">1312</div><div class="line">1313</div><div class="line">1314</div><div class="line">1315</div><div class="line">1316</div><div class="line">1317</div><div class="line">1318</div><div class="line">1319</div><div class="line">1320</div><div class="line">1321</div><div class="line">1322</div><div class="line">1323</div><div class="line">1324</div><div class="line">1325</div><div class="line">1326</div><div class="line">1327</div><div class="line">1328</div><div class="line">1329</div><div class="line">1330</div><div class="line">1331</div><div class="line">1332</div><div class="line">1333</div><div class="line">1334</div><div class="line">1335</div><div class="line">1336</div><div class="line">1337</div><div class="line">1338</div><div class="line">1339</div><div class="line">1340</div><div class="line">1341</div><div class="line">1342</div><div class="line">1343</div><div class="line">1344</div><div class="line">1345</div><div class="line">1346</div><div class="line">1347</div><div class="line">1348</div><div class="line">1349</div><div class="line">1350</div><div class="line">1351</div><div class="line">1352</div><div class="line">1353</div><div class="line">1354</div><div class="line">1355</div><div class="line">1356</div><div class="line">1357</div><div class="line">1358</div><div class="line">1359</div><div class="line">1360</div><div class="line">1361</div><div class="line">1362</div><div class="line">1363</div><div class="line">1364</div><div class="line">1365</div><div class="line">1366</div><div class="line">1367</div><div class="line">1368</div><div class="line">1369</div><div class="line">1370</div><div class="line">1371</div><div class="line">1372</div><div class="line">1373</div><div class="line">1374</div><div class="line">1375</div><div class="line">1376</div><div class="line">1377</div><div class="line">1378</div><div class="line">1379</div><div class="line">1380</div><div class="line">1381</div><div class="line">1382</div><div class="line">1383</div><div class="line">1384</div><div class="line">1385</div><div class="line">1386</div><div class="line">1387</div><div class="line">1388</div><div class="line">1389</div><div class="line">1390</div><div class="line">1391</div><div class="line">1392</div><div class="line">1393</div><div class="line">1394</div><div class="line">1395</div><div class="line">1396</div><div class="line">1397</div><div class="line">1398</div><div class="line">1399</div><div class="line">1400</div><div class="line">1401</div><div class="line">1402</div><div class="line">1403</div><div class="line">1404</div><div class="line">1405</div><div class="line">1406</div><div class="line">1407</div><div class="line">1408</div><div class="line">1409</div><div class="line">1410</div><div class="line">1411</div><div class="line">1412</div><div class="line">1413</div><div class="line">1414</div><div class="line">1415</div><div class="line">1416</div><div class="line">1417</div><div class="line">1418</div><div class="line">1419</div><div class="line">1420</div><div class="line">1421</div><div class="line">1422</div><div class="line">1423</div><div class="line">1424</div><div class="line">1425</div><div class="line">1426</div><div class="line">1427</div><div class="line">1428</div><div class="line">1429</div><div class="line">1430</div><div class="line">1431</div><div class="line">1432</div><div class="line">1433</div><div class="line">1434</div><div class="line">1435</div><div class="line">1436</div><div class="line">1437</div><div class="line">1438</div><div class="line">1439</div><div class="line">1440</div><div class="line">1441</div><div class="line">1442</div><div class="line">1443</div><div class="line">1444</div><div class="line">1445</div><div class="line">1446</div><div class="line">1447</div><div class="line">1448</div><div class="line">1449</div><div class="line">1450</div><div class="line">1451</div><div class="line">1452</div><div class="line">1453</div><div class="line">1454</div><div class="line">1455</div><div class="line">1456</div><div class="line">1457</div><div class="line">1458</div><div class="line">1459</div><div class="line">1460</div><div class="line">1461</div><div class="line">1462</div><div class="line">1463</div><div class="line">1464</div><div class="line">1465</div><div class="line">1466</div><div class="line">1467</div><div class="line">1468</div><div class="line">1469</div><div class="line">1470</div><div class="line">1471</div><div class="line">1472</div><div class="line">1473</div><div class="line">1474</div><div class="line">1475</div><div class="line">1476</div><div class="line">1477</div><div class="line">1478</div><div class="line">1479</div><div class="line">1480</div><div class="line">1481</div><div class="line">1482</div><div class="line">1483</div><div class="line">1484</div><div class="line">1485</div><div class="line">1486</div><div class="line">1487</div><div class="line">1488</div><div class="line">1489</div><div class="line">1490</div><div class="line">1491</div><div class="line">1492</div><div class="line">1493</div><div class="line">1494</div><div class="line">1495</div><div class="line">1496</div><div class="line">1497</div><div class="line">1498</div><div class="line">1499</div><div class="line">1500</div><div class="line">1501</div><div class="line">1502</div><div class="line">1503</div><div class="line">1504</div><div class="line">1505</div><div class="line">1506</div><div class="line">1507</div><div class="line">1508</div><div class="line">1509</div><div class="line">1510</div><div class="line">1511</div><div class="line">1512</div><div class="line">1513</div><div class="line">1514</div><div class="line">1515</div><div class="line">1516</div><div class="line">1517</div><div class="line">1518</div><div class="line">1519</div><div class="line">1520</div><div class="line">1521</div><div class="line">1522</div><div class="line">1523</div><div class="line">1524</div><div class="line">1525</div><div class="line">1526</div><div class="line">1527</div><div class="line">1528</div><div class="line">1529</div><div class="line">1530</div><div class="line">1531</div><div class="line">1532</div><div class="line">1533</div><div class="line">1534</div><div class="line">1535</div><div class="line">1536</div><div class="line">1537</div><div class="line">1538</div><div class="line">1539</div><div class="line">1540</div><div class="line">1541</div><div class="line">1542</div><div class="line">1543</div><div class="line">1544</div><div class="line">1545</div><div class="line">1546</div><div class="line">1547</div><div class="line">1548</div><div class="line">1549</div><div class="line">1550</div><div class="line">1551</div><div class="line">1552</div><div class="line">1553</div><div class="line">1554</div><div class="line">1555</div><div class="line">1556</div><div class="line">1557</div><div class="line">1558</div><div class="line">1559</div><div class="line">1560</div><div class="line">1561</div><div class="line">1562</div><div class="line">1563</div><div class="line">1564</div><div class="line">1565</div><div class="line">1566</div><div class="line">1567</div><div class="line">1568</div><div class="line">1569</div><div class="line">1570</div><div class="line">1571</div><div class="line">1572</div><div class="line">1573</div><div class="line">1574</div><div class="line">1575</div><div class="line">1576</div><div class="line">1577</div><div class="line">1578</div><div class="line">1579</div><div class="line">1580</div><div class="line">1581</div><div class="line">1582</div><div class="line">1583</div><div class="line">1584</div><div class="line">1585</div><div class="line">1586</div><div class="line">1587</div><div class="line">1588</div><div class="line">1589</div><div class="line">1590</div><div class="line">1591</div><div class="line">1592</div><div class="line">1593</div><div class="line">1594</div><div class="line">1595</div><div class="line">1596</div><div class="line">1597</div><div class="line">1598</div><div class="line">1599</div><div class="line">1600</div><div class="line">1601</div><div class="line">1602</div><div class="line">1603</div><div class="line">1604</div><div class="line">1605</div><div class="line">1606</div><div class="line">1607</div><div class="line">1608</div><div class="line">1609</div><div class="line">1610</div><div class="line">1611</div><div class="line">1612</div><div class="line">1613</div><div class="line">1614</div><div class="line">1615</div><div class="line">1616</div><div class="line">1617</div><div class="line">1618</div><div class="line">1619</div><div class="line">1620</div><div class="line">1621</div><div class="line">1622</div><div class="line">1623</div><div class="line">1624</div><div class="line">1625</div><div class="line">1626</div><div class="line">1627</div><div class="line">1628</div><div class="line">1629</div><div class="line">1630</div><div class="line">1631</div><div class="line">1632</div><div class="line">1633</div><div class="line">1634</div><div class="line">1635</div><div class="line">1636</div><div class="line">1637</div><div class="line">1638</div><div class="line">1639</div><div class="line">1640</div><div class="line">1641</div><div class="line">1642</div><div class="line">1643</div><div class="line">1644</div><div class="line">1645</div><div class="line">1646</div><div class="line">1647</div><div class="line">1648</div><div class="line">1649</div><div class="line">1650</div><div class="line">1651</div><div class="line">1652</div><div class="line">1653</div><div class="line">1654</div><div class="line">1655</div><div class="line">1656</div><div class="line">1657</div><div class="line">1658</div><div class="line">1659</div><div class="line">1660</div><div class="line">1661</div><div class="line">1662</div><div class="line">1663</div><div class="line">1664</div><div class="line">1665</div><div class="line">1666</div><div class="line">1667</div><div class="line">1668</div><div class="line">1669</div><div class="line">1670</div><div class="line">1671</div><div class="line">1672</div><div class="line">1673</div><div class="line">1674</div><div class="line">1675</div><div class="line">1676</div><div class="line">1677</div><div class="line">1678</div><div class="line">1679</div><div class="line">1680</div><div class="line">1681</div><div class="line">1682</div><div class="line">1683</div><div class="line">1684</div><div class="line">1685</div><div class="line">1686</div><div class="line">1687</div><div class="line">1688</div><div class="line">1689</div><div class="line">1690</div><div class="line">1691</div><div class="line">1692</div><div class="line">1693</div><div class="line">1694</div><div class="line">1695</div><div class="line">1696</div><div class="line">1697</div><div class="line">1698</div><div class="line">1699</div><div class="line">1700</div><div class="line">1701</div><div class="line">1702</div><div class="line">1703</div><div class="line">1704</div><div class="line">1705</div><div class="line">1706</div><div class="line">1707</div><div class="line">1708</div><div class="line">1709</div><div class="line">1710</div><div class="line">1711</div><div class="line">1712</div><div class="line">1713</div><div class="line">1714</div><div class="line">1715</div><div class="line">1716</div><div class="line">1717</div><div class="line">1718</div><div class="line">1719</div><div class="line">1720</div><div class="line">1721</div><div class="line">1722</div><div class="line">1723</div><div class="line">1724</div><div class="line">1725</div><div class="line">1726</div><div class="line">1727</div><div class="line">1728</div><div class="line">1729</div><div class="line">1730</div><div class="line">1731</div><div class="line">1732</div><div class="line">1733</div><div class="line">1734</div><div class="line">1735</div><div class="line">1736</div><div class="line">1737</div><div class="line">1738</div><div class="line">1739</div><div class="line">1740</div><div class="line">1741</div><div class="line">1742</div><div class="line">1743</div><div class="line">1744</div><div class="line">1745</div><div class="line">1746</div><div class="line">1747</div><div class="line">1748</div><div class="line">1749</div><div class="line">1750</div><div class="line">1751</div><div class="line">1752</div><div class="line">1753</div><div class="line">1754</div><div class="line">1755</div><div class="line">1756</div><div class="line">1757</div><div class="line">1758</div><div class="line">1759</div><div class="line">1760</div><div class="line">1761</div><div class="line">1762</div><div class="line">1763</div><div class="line">1764</div><div class="line">1765</div><div class="line">1766</div><div class="line">1767</div><div class="line">1768</div><div class="line">1769</div><div class="line">1770</div><div class="line">1771</div><div class="line">1772</div><div class="line">1773</div><div class="line">1774</div><div class="line">1775</div><div class="line">1776</div><div class="line">1777</div><div class="line">1778</div><div class="line">1779</div><div class="line">1780</div><div class="line">1781</div><div class="line">1782</div><div class="line">1783</div><div class="line">1784</div><div class="line">1785</div><div class="line">1786</div><div class="line">1787</div><div class="line">1788</div><div class="line">1789</div><div class="line">1790</div><div class="line">1791</div><div class="line">1792</div><div class="line">1793</div><div class="line">1794</div><div class="line">1795</div><div class="line">1796</div><div class="line">1797</div><div class="line">1798</div><div class="line">1799</div><div class="line">1800</div><div class="line">1801</div><div class="line">1802</div><div class="line">1803</div><div class="line">1804</div><div class="line">1805</div><div class="line">1806</div><div class="line">1807</div><div class="line">1808</div><div class="line">1809</div><div class="line">1810</div><div class="line">1811</div><div class="line">1812</div><div class="line">1813</div><div class="line">1814</div><div class="line">1815</div><div class="line">1816</div><div class="line">1817</div><div class="line">1818</div><div class="line">1819</div><div class="line">1820</div><div class="line">1821</div><div class="line">1822</div><div class="line">1823</div><div class="line">1824</div><div class="line">1825</div><div class="line">1826</div><div class="line">1827</div><div class="line">1828</div><div class="line">1829</div><div class="line">1830</div><div class="line">1831</div><div class="line">1832</div><div class="line">1833</div><div class="line">1834</div><div class="line">1835</div><div class="line">1836</div><div class="line">1837</div><div class="line">1838</div><div class="line">1839</div><div class="line">1840</div><div class="line">1841</div><div class="line">1842</div><div class="line">1843</div><div class="line">1844</div><div class="line">1845</div><div class="line">1846</div><div class="line">1847</div><div class="line">1848</div><div class="line">1849</div><div class="line">1850</div><div class="line">1851</div><div class="line">1852</div><div class="line">1853</div><div class="line">1854</div><div class="line">1855</div><div class="line">1856</div><div class="line">1857</div><div class="line">1858</div><div class="line">1859</div><div class="line">1860</div><div class="line">1861</div><div class="line">1862</div><div class="line">1863</div><div class="line">1864</div><div class="line">1865</div><div class="line">1866</div><div class="line">1867</div><div class="line">1868</div><div class="line">1869</div><div class="line">1870</div><div class="line">1871</div><div class="line">1872</div><div class="line">1873</div><div class="line">1874</div><div class="line">1875</div><div class="line">1876</div><div class="line">1877</div><div class="line">1878</div><div class="line">1879</div><div class="line">1880</div><div class="line">1881</div><div class="line">1882</div><div class="line">1883</div><div class="line">1884</div><div class="line">1885</div><div class="line">1886</div><div class="line">1887</div><div class="line">1888</div><div class="line">1889</div><div class="line">1890</div><div class="line">1891</div><div class="line">1892</div><div class="line">1893</div><div class="line">1894</div><div class="line">1895</div><div class="line">1896</div><div class="line">1897</div><div class="line">1898</div><div class="line">1899</div><div class="line">1900</div><div class="line">1901</div><div class="line">1902</div><div class="line">1903</div><div class="line">1904</div><div class="line">1905</div><div class="line">1906</div><div class="line">1907</div><div class="line">1908</div><div class="line">1909</div><div class="line">1910</div><div class="line">1911</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Default values for prometheus-operator.</span></div><div class="line"><span class="comment"># This is a YAML-formatted file.</span></div><div class="line"><span class="comment"># Declare variables to be passed into your templates.</span></div><div class="line"></div><div class="line"><span class="comment">## Provide a name in place of prometheus-operator for `app:` labels</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">nameOverride:</span> <span class="string">""</span></div><div class="line"></div><div class="line"><span class="comment">## Provide a k8s version to auto dashboard import script example: kubeTargetVersionOverride: 1.16.6</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">kubeTargetVersionOverride:</span> <span class="string">""</span></div><div class="line"></div><div class="line"><span class="comment">## Provide a name to substitute for the full names of resources</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">fullnameOverride:</span> <span class="string">""</span></div><div class="line"></div><div class="line"><span class="comment">## Labels to apply to all resources</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">commonLabels:</span> &#123;&#125;</div><div class="line"><span class="comment"># scmhash: abc123</span></div><div class="line"><span class="comment"># myLabel: aakkmd</span></div><div class="line"></div><div class="line"><span class="comment">## Create default rules for monitoring the cluster</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">defaultRules:</span></div><div class="line"><span class="attr">  create:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  rules:</span></div><div class="line"><span class="attr">    alertmanager:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    etcd:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    general:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    k8s:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    kubeApiserver:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    kubeApiserverError:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    kubePrometheusNodeAlerting:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    kubePrometheusNodeRecording:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    kubernetesAbsent:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    kubernetesApps:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    kubernetesResources:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    kubernetesStorage:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    kubernetesSystem:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    kubeScheduler:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    network:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    node:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    prometheus:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    prometheusOperator:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    time:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## Runbook url prefix for default rules</span></div><div class="line"><span class="attr">  runbookUrl:</span> https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md<span class="comment">#</span></div><div class="line">  <span class="comment">## Reduce app namespace alert scope</span></div><div class="line"><span class="attr">  appNamespacesTarget:</span> <span class="string">".*"</span></div><div class="line"></div><div class="line">  <span class="comment">## Labels for default rules</span></div><div class="line"><span class="attr">  labels:</span> &#123;&#125;</div><div class="line">  <span class="comment">## Annotations for default rules</span></div><div class="line"><span class="attr">  annotations:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">## Provide custom recording or alerting rules to be deployed into the cluster.</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">additionalPrometheusRules:</span> []</div><div class="line"><span class="comment">#  - name: my-rule-file</span></div><div class="line"><span class="comment">#    groups:</span></div><div class="line"><span class="comment">#      - name: my_group</span></div><div class="line"><span class="comment">#        rules:</span></div><div class="line"><span class="comment">#        - record: my_record</span></div><div class="line"><span class="comment">#          expr: 100 * my_record</span></div><div class="line"></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">global:</span></div><div class="line"><span class="attr">  rbac:</span></div><div class="line"><span class="attr">    create:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    pspEnabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## Reference to one or more secrets to be used when pulling images</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  imagePullSecrets:</span> []</div><div class="line">  <span class="comment"># - name: "image-pull-secret"</span></div><div class="line"></div><div class="line"><span class="comment">## Configuration for alertmanager</span></div><div class="line"><span class="comment">## ref: https://prometheus.io/docs/alerting/alertmanager/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">alertmanager:</span></div><div class="line"></div><div class="line">  <span class="comment">## Deploy alertmanager</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## Api that prometheus will use to communicate with alertmanager. Possible values are v1, v2</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  apiVersion:</span> v2</div><div class="line"></div><div class="line">  <span class="comment">## Service account for Alertmanager to use.</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  serviceAccount:</span></div><div class="line"><span class="attr">    create:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    name:</span> <span class="string">""</span></div><div class="line"></div><div class="line">  <span class="comment">## Configure pod disruption budgets for Alertmanager</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/tasks/run-application/configure-pdb/#specifying-a-poddisruptionbudget</span></div><div class="line">  <span class="comment">## This configuration is immutable once created and will require the PDB to be deleted to be changed</span></div><div class="line">  <span class="comment">## https://github.com/kubernetes/kubernetes/issues/45398</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  podDisruptionBudget:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    minAvailable:</span> <span class="number">1</span></div><div class="line"><span class="attr">    maxUnavailable:</span> <span class="string">""</span></div><div class="line"></div><div class="line">  <span class="comment">## Alertmanager configuration directives</span></div><div class="line">  <span class="comment">## ref: https://prometheus.io/docs/alerting/configuration/#configuration-file</span></div><div class="line">  <span class="comment">##      https://prometheus.io/webtools/alerting/routing-tree-editor/</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  config:</span></div><div class="line"><span class="attr">    global:</span></div><div class="line"><span class="attr">      resolve_timeout:</span> <span class="number">5</span>m</div><div class="line"><span class="attr">    route:</span></div><div class="line"><span class="attr">      group_by:</span> [<span class="string">'job'</span>]</div><div class="line"><span class="attr">      group_wait:</span> <span class="number">30</span>s</div><div class="line"><span class="attr">      group_interval:</span> <span class="number">5</span>m</div><div class="line"><span class="attr">      repeat_interval:</span> <span class="number">12</span>h</div><div class="line"><span class="attr">      receiver:</span> <span class="string">'null'</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line"><span class="attr">      - match:</span></div><div class="line"><span class="attr">          alertname:</span> Watchdog</div><div class="line"><span class="attr">        receiver:</span> <span class="string">'null'</span></div><div class="line"><span class="attr">    receivers:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">'null'</span></div><div class="line"></div><div class="line">  <span class="comment">## Pass the Alertmanager configuration directives through Helm's templating</span></div><div class="line">  <span class="comment">## engine. If the Alertmanager configuration contains Alertmanager templates,</span></div><div class="line">  <span class="comment">## they'll need to be properly escaped so that they are not interpreted by</span></div><div class="line">  <span class="comment">## Helm</span></div><div class="line">  <span class="comment">## ref: https://helm.sh/docs/developing_charts/#using-the-tpl-function</span></div><div class="line">  <span class="comment">##      https://prometheus.io/docs/alerting/configuration/#%3Ctmpl_string%3E</span></div><div class="line">  <span class="comment">##      https://prometheus.io/docs/alerting/notifications/</span></div><div class="line">  <span class="comment">##      https://prometheus.io/docs/alerting/notification_examples/</span></div><div class="line"><span class="attr">  tplConfig:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">  <span class="comment">## Alertmanager template files to format alerts</span></div><div class="line">  <span class="comment">## ref: https://prometheus.io/docs/alerting/notifications/</span></div><div class="line">  <span class="comment">##      https://prometheus.io/docs/alerting/notification_examples/</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  templateFiles:</span> &#123;&#125;</div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment">## An example template:</span></div><div class="line">  <span class="comment">#   template_1.tmpl: |-</span></div><div class="line">  <span class="comment">#       &#123;&#123; define "cluster" &#125;&#125;&#123;&#123; .ExternalURL | reReplaceAll ".*alertmanager\\.(.*)" "$1" &#125;&#125;&#123;&#123; end &#125;&#125;</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment">#       &#123;&#123; define "slack.myorg.text" &#125;&#125;</span></div><div class="line">  <span class="comment">#       &#123;&#123;- $root := . -&#125;&#125;</span></div><div class="line">  <span class="comment">#       &#123;&#123; range .Alerts &#125;&#125;</span></div><div class="line">  <span class="comment">#         *Alert:* &#123;&#123; .Annotations.summary &#125;&#125; - `&#123;&#123; .Labels.severity &#125;&#125;`</span></div><div class="line">  <span class="comment">#         *Cluster:*  &#123;&#123; template "cluster" $root &#125;&#125;</span></div><div class="line">  <span class="comment">#         *Description:* &#123;&#123; .Annotations.description &#125;&#125;</span></div><div class="line">  <span class="comment">#         *Graph:* &lt;&#123;&#123; .GeneratorURL &#125;&#125;|:chart_with_upwards_trend:&gt;</span></div><div class="line">  <span class="comment">#         *Runbook:* &lt;&#123;&#123; .Annotations.runbook &#125;&#125;|:spiral_note_pad:&gt;</span></div><div class="line">  <span class="comment">#         *Details:*</span></div><div class="line">  <span class="comment">#           &#123;&#123; range .Labels.SortedPairs &#125;&#125; â€¢ *&#123;&#123; .Name &#125;&#125;:* `&#123;&#123; .Value &#125;&#125;`</span></div><div class="line">  <span class="comment">#           &#123;&#123; end &#125;&#125;</span></div><div class="line"></div><div class="line"><span class="attr">  ingress:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line"></div><div class="line"><span class="attr">    annotations:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="attr">    labels:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Hosts must be provided if Ingress is enabled.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    hosts:</span> []</div><div class="line">      <span class="comment"># - alertmanager.domain.com</span></div><div class="line"></div><div class="line">    <span class="comment">## Paths to use for ingress rules - one path should match the alertmanagerSpec.routePrefix</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    paths:</span> []</div><div class="line">    <span class="comment"># - /</span></div><div class="line"></div><div class="line">    <span class="comment">## TLS configuration for Alertmanager Ingress</span></div><div class="line">    <span class="comment">## Secret must be manually created in the namespace</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    tls:</span> []</div><div class="line">    <span class="comment"># - secretName: alertmanager-general-tls</span></div><div class="line">    <span class="comment">#   hosts:</span></div><div class="line">    <span class="comment">#   - alertmanager.example.com</span></div><div class="line"></div><div class="line">  <span class="comment">## Configuration for Alertmanager secret</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  secret:</span></div><div class="line"><span class="attr">    annotations:</span> &#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment">## Configuration for Alertmanager service</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="attr">    annotations:</span> &#123;&#125;</div><div class="line"><span class="attr">    labels:</span> &#123;&#125;</div><div class="line"><span class="attr">    clusterIP:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## Port for Alertmanager Service to listen on</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    port:</span> <span class="number">9093</span></div><div class="line">    <span class="comment">## To be used with a proxy extraContainer port</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">9093</span></div><div class="line">    <span class="comment">## Port to expose on each node</span></div><div class="line">    <span class="comment">## Only used if service.type is 'NodePort'</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    nodePort:</span> <span class="number">30091</span></div><div class="line">    <span class="comment">## List of IP addresses at which the Prometheus server service is available</span></div><div class="line">    <span class="comment">## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    externalIPs:</span> []</div><div class="line"><span class="attr">    loadBalancerIP:</span> <span class="string">""</span></div><div class="line"><span class="attr">    loadBalancerSourceRanges:</span> []</div><div class="line">    <span class="comment">## Service type</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment">#type: ClusterIP</span></div><div class="line"><span class="attr">    type:</span> NodePort</div><div class="line"></div><div class="line">  <span class="comment">## If true, create a serviceMonitor for alertmanager</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"><span class="attr">    selfMonitor:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line">  <span class="comment">## Settings affecting alertmanagerSpec</span></div><div class="line">  <span class="comment">## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#alertmanagerspec</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  alertmanagerSpec:</span></div><div class="line">    <span class="comment">## Standard objectâ€™s metadata. More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata</span></div><div class="line">    <span class="comment">## Metadata Labels and Annotations gets propagated to the Alertmanager pods.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    podMetadata:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Image of Alertmanager</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    image:</span></div><div class="line"><span class="attr">      repository:</span> quay.io/prometheus/alertmanager</div><div class="line"><span class="attr">      tag:</span> v0<span class="number">.20</span><span class="number">.0</span></div><div class="line"></div><div class="line">    <span class="comment">## If true then the user will be responsible to provide a secret with alertmanager configuration</span></div><div class="line">    <span class="comment">## So when true the config part will be ignored (including templateFiles) and the one in the secret will be used</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    useExistingSecret:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## Secrets is a list of Secrets in the same namespace as the Alertmanager object, which shall be mounted into the</span></div><div class="line">    <span class="comment">## Alertmanager Pods. The Secrets are mounted into /etc/alertmanager/secrets/.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    secrets:</span> []</div><div class="line"></div><div class="line">    <span class="comment">## ConfigMaps is a list of ConfigMaps in the same namespace as the Alertmanager object, which shall be mounted into the Alertmanager Pods.</span></div><div class="line">    <span class="comment">## The ConfigMaps are mounted into /etc/alertmanager/configmaps/.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    configMaps:</span> []</div><div class="line"></div><div class="line">    <span class="comment">## ConfigSecret is the name of a Kubernetes Secret in the same namespace as the Alertmanager object, which contains configuration for</span></div><div class="line">    <span class="comment">## this Alertmanager instance. Defaults to 'alertmanager-' The secret is mounted into /etc/alertmanager/config.</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># configSecret:</span></div><div class="line"></div><div class="line">    <span class="comment">## Define Log Format</span></div><div class="line">    <span class="comment"># Use logfmt (default) or json-formatted logging</span></div><div class="line"><span class="attr">    logFormat:</span> logfmt</div><div class="line"></div><div class="line">    <span class="comment">## Log level for Alertmanager to be configured with.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    logLevel:</span> info</div><div class="line"></div><div class="line">    <span class="comment">## Size is the expected size of the alertmanager cluster. The controller will eventually make the size of the</span></div><div class="line">    <span class="comment">## running cluster equal to the expected size.</span></div><div class="line"><span class="attr">    replicas:</span> <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="comment">## Time duration Alertmanager shall retain data for. Default is '120h', and must match the regular expression</span></div><div class="line">    <span class="comment">## [0-9]+(ms|s|m|h) (milliseconds seconds minutes hours).</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    retention:</span> <span class="number">120</span>h</div><div class="line"></div><div class="line">    <span class="comment">## Storage is the definition of how storage will be used by the Alertmanager instances.</span></div><div class="line">    <span class="comment">## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/storage.md</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    storage:</span> &#123;&#125;</div><div class="line">    <span class="comment"># volumeClaimTemplate:</span></div><div class="line">    <span class="comment">#   spec:</span></div><div class="line">    <span class="comment">#     storageClassName: gluster</span></div><div class="line">    <span class="comment">#     accessModes: ["ReadWriteOnce"]</span></div><div class="line">    <span class="comment">#     resources:</span></div><div class="line">    <span class="comment">#       requests:</span></div><div class="line">    <span class="comment">#         storage: 50Gi</span></div><div class="line">    <span class="comment">#   selector: &#123;&#125;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">## 	The external URL the Alertmanager instances will be available under. This is necessary to generate correct URLs. This is necessary if Alertmanager is not served from root of a DNS name.	string	false</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    externalUrl:</span></div><div class="line"></div><div class="line">    <span class="comment">## 	The route prefix Alertmanager registers HTTP handlers for. This is useful, if using ExternalURL and a proxy is rewriting HTTP routes of a request, and the actual ExternalURL is still true,</span></div><div class="line">    <span class="comment">## but the server serves requests under a different route prefix. For example for use with kubectl proxy.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    routePrefix:</span> /</div><div class="line"></div><div class="line">    <span class="comment">## If set to true all actions on the underlying managed objects are not going to be performed, except for delete actions.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    paused:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## Define which Nodes the Pods are scheduled on.</span></div><div class="line">    <span class="comment">## ref: https://kubernetes.io/docs/user-guide/node-selection/</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    nodeSelector:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Define resources requests and limits for single Pods.</span></div><div class="line">    <span class="comment">## ref: https://kubernetes.io/docs/user-guide/compute-resources/</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    resources:</span> &#123;&#125;</div><div class="line">    <span class="comment"># requests:</span></div><div class="line">    <span class="comment">#   memory: 400Mi</span></div><div class="line"></div><div class="line">    <span class="comment">## Pod anti-affinity can prevent the scheduler from placing Prometheus replicas on the same node.</span></div><div class="line">    <span class="comment">## The default value "soft" means that the scheduler should *prefer* to not schedule two replica pods onto the same node but no guarantee is provided.</span></div><div class="line">    <span class="comment">## The value "hard" means that the scheduler is *required* to not schedule two replica pods onto the same node.</span></div><div class="line">    <span class="comment">## The value "" will disable pod anti-affinity so that no anti-affinity rules will be configured.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    podAntiAffinity:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## If anti-affinity is enabled sets the topologyKey to use for anti-affinity.</span></div><div class="line">    <span class="comment">## This can be changed to, for example, failure-domain.beta.kubernetes.io/zone</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    podAntiAffinityTopologyKey:</span> kubernetes.io/hostname</div><div class="line"></div><div class="line">    <span class="comment">## Assign custom affinity rules to the alertmanager instance</span></div><div class="line">    <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    affinity:</span> &#123;&#125;</div><div class="line">    <span class="comment"># nodeAffinity:</span></div><div class="line">    <span class="comment">#   requiredDuringSchedulingIgnoredDuringExecution:</span></div><div class="line">    <span class="comment">#     nodeSelectorTerms:</span></div><div class="line">    <span class="comment">#     - matchExpressions:</span></div><div class="line">    <span class="comment">#       - key: kubernetes.io/e2e-az-name</span></div><div class="line">    <span class="comment">#         operator: In</span></div><div class="line">    <span class="comment">#         values:</span></div><div class="line">    <span class="comment">#         - e2e-az1</span></div><div class="line">    <span class="comment">#         - e2e-az2</span></div><div class="line"></div><div class="line">    <span class="comment">## If specified, the pod's tolerations.</span></div><div class="line">    <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    tolerations:</span> []</div><div class="line">    <span class="comment"># - key: "key"</span></div><div class="line">    <span class="comment">#   operator: "Equal"</span></div><div class="line">    <span class="comment">#   value: "value"</span></div><div class="line">    <span class="comment">#   effect: "NoSchedule"</span></div><div class="line"></div><div class="line">    <span class="comment">## SecurityContext holds pod-level security attributes and common container settings.</span></div><div class="line">    <span class="comment">## This defaults to non root user with uid 1000 and gid 2000.	*v1.PodSecurityContext	false</span></div><div class="line">    <span class="comment">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    securityContext:</span></div><div class="line"><span class="attr">      runAsNonRoot:</span> <span class="literal">true</span></div><div class="line"><span class="attr">      runAsUser:</span> <span class="number">1000</span></div><div class="line"><span class="attr">      fsGroup:</span> <span class="number">2000</span></div><div class="line"></div><div class="line">    <span class="comment">## ListenLocal makes the Alertmanager server listen on loopback, so that it does not bind against the Pod IP.</span></div><div class="line">    <span class="comment">## Note this is only for the Alertmanager UI, not the gossip communication.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    listenLocal:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## Containers allows injecting additional containers. This is meant to allow adding an authentication proxy to an Alertmanager pod.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    containers:</span> []</div><div class="line"></div><div class="line">    <span class="comment">## Priority class assigned to the Pods</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    priorityClassName:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## AdditionalPeers allows injecting a set of additional Alertmanagers to peer with to form a highly available cluster.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    additionalPeers:</span> []</div><div class="line"></div><div class="line">    <span class="comment">## PortName to use for Alert Manager.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    portName:</span> <span class="string">"web"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## Using default values from https://github.com/helm/charts/blob/master/stable/grafana/values.yaml</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">grafana:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## Deploy default dashboards.</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  defaultDashboardsEnabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="attr">  adminPassword:</span> prom-operator</div><div class="line"></div><div class="line"><span class="attr">  ingress:</span></div><div class="line">    <span class="comment">## If true, Grafana Ingress will be created</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## Annotations for Grafana Ingress</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    annotations:</span> &#123;&#125;</div><div class="line">      <span class="comment"># kubernetes.io/ingress.class: nginx</span></div><div class="line">      <span class="comment"># kubernetes.io/tls-acme: "true"</span></div><div class="line"></div><div class="line">    <span class="comment">## Labels to be added to the Ingress</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    labels:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Hostnames.</span></div><div class="line">    <span class="comment">## Must be provided if Ingress is enable.</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># hosts:</span></div><div class="line">    <span class="comment">#   - grafana.domain.com</span></div><div class="line"><span class="attr">    hosts:</span> []</div><div class="line"></div><div class="line">    <span class="comment">## Path for grafana ingress</span></div><div class="line"><span class="attr">    path:</span> /</div><div class="line"></div><div class="line">    <span class="comment">## TLS configuration for grafana Ingress</span></div><div class="line">    <span class="comment">## Secret must be manually created in the namespace</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    tls:</span> []</div><div class="line">    <span class="comment"># - secretName: grafana-general-tls</span></div><div class="line">    <span class="comment">#   hosts:</span></div><div class="line">    <span class="comment">#   - grafana.example.com</span></div><div class="line"></div><div class="line"><span class="attr">  sidecar:</span></div><div class="line"><span class="attr">    dashboards:</span></div><div class="line"><span class="attr">      enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">      label:</span> grafana_dashboard</div><div class="line"><span class="attr">    datasources:</span></div><div class="line"><span class="attr">      enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">      defaultDatasourceEnabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">      <span class="comment">## Annotations for Grafana datasource configmaps</span></div><div class="line">      <span class="comment">##</span></div><div class="line"><span class="attr">      annotations:</span> &#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">## Create datasource for each Pod of Prometheus StatefulSet;</span></div><div class="line">      <span class="comment">## this uses headless service `prometheus-operated` which is</span></div><div class="line">      <span class="comment">## created by Prometheus Operator</span></div><div class="line">      <span class="comment">## ref: https://git.io/fjaBS</span></div><div class="line"><span class="attr">      createPrometheusReplicasDatasources:</span> <span class="literal">false</span></div><div class="line"><span class="attr">      label:</span> grafana_datasource</div><div class="line"></div><div class="line"><span class="attr">  extraConfigmapMounts:</span> []</div><div class="line">  <span class="comment"># - name: certs-configmap</span></div><div class="line">  <span class="comment">#   mountPath: /etc/grafana/ssl/</span></div><div class="line">  <span class="comment">#   configMap: certs-configmap</span></div><div class="line">  <span class="comment">#   readOnly: true</span></div><div class="line"></div><div class="line">  <span class="comment">## Configure additional grafana datasources</span></div><div class="line">  <span class="comment">## ref: http://docs.grafana.org/administration/provisioning/#datasources</span></div><div class="line"><span class="attr">  additionalDataSources:</span> []</div><div class="line">  <span class="comment">#  - name: prometheus-sample</span></div><div class="line">  <span class="comment">#    access: proxy</span></div><div class="line">  <span class="comment">#    basicAuth: true</span></div><div class="line">  <span class="comment">#    basicAuthPassword: pass</span></div><div class="line">  <span class="comment">#    basicAuthUser: daco</span></div><div class="line">  <span class="comment">#    editable: false</span></div><div class="line">  <span class="comment">#    jsonData:</span></div><div class="line">  <span class="comment">#        tlsSkipVerify: true</span></div><div class="line">  <span class="comment">#    orgId: 1</span></div><div class="line">  <span class="comment">#    type: prometheus</span></div><div class="line">  <span class="comment">#    url: https://prometheus.svc:9090</span></div><div class="line">  <span class="comment">#    version: 1</span></div><div class="line"></div><div class="line">  <span class="comment">## Passed to grafana subchart and used by servicemonitor below</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="attr">    portName:</span> service</div><div class="line"></div><div class="line">  <span class="comment">## If true, create a serviceMonitor for grafana</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"><span class="attr">    selfMonitor:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line"><span class="comment">## Component scraping the kube api server</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">kubeApiServer:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  tlsConfig:</span></div><div class="line"><span class="attr">    serverName:</span> kubernetes</div><div class="line"><span class="attr">    insecureSkipVerify:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">  <span class="comment">## If your API endpoint address is not reachable (as in AKS) you can replace it with the kubernetes service</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  relabelings:</span> []</div><div class="line">  <span class="comment"># - sourceLabels:</span></div><div class="line">  <span class="comment">#     - __meta_kubernetes_namespace</span></div><div class="line">  <span class="comment">#     - __meta_kubernetes_service_name</span></div><div class="line">  <span class="comment">#     - __meta_kubernetes_endpoint_port_name</span></div><div class="line">  <span class="comment">#   action: keep</span></div><div class="line">  <span class="comment">#   regex: default;kubernetes;https</span></div><div class="line">  <span class="comment"># - targetLabel: __address__</span></div><div class="line">  <span class="comment">#   replacement: kubernetes.default.svc:443</span></div><div class="line"></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"><span class="attr">    jobLabel:</span> component</div><div class="line"><span class="attr">    selector:</span></div><div class="line"><span class="attr">      matchLabels:</span></div><div class="line"><span class="attr">        component:</span> apiserver</div><div class="line"><span class="attr">        provider:</span> kubernetes</div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line"><span class="comment">## Component scraping the kubelet and kubelet-hosted cAdvisor</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">kubelet:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  namespace:</span> kube-system</div><div class="line"></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## Enable scraping the kubelet over https. For requirements to enable this see</span></div><div class="line">    <span class="comment">## https://github.com/coreos/prometheus-operator/issues/926</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    https:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">    <span class="comment">## Metric relabellings to apply to samples before ingestion</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    cAdvisorMetricRelabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__name__, image]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: container_([a-z_]+);</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: drop</span></div><div class="line">    <span class="comment"># - sourceLabels: [__name__]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: container_(network_tcp_usage_total|network_udp_usage_total|tasks_state|cpu_load_average_10s)</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: drop</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">#   metrics_path is required to match upstream rules and charts</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    cAdvisorRelabelings:</span></div><div class="line"><span class="attr">      - sourceLabels:</span> [__metrics_path__]</div><div class="line"><span class="attr">        targetLabel:</span> metrics_path</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__name__, image]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: container_([a-z_]+);</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: drop</span></div><div class="line">    <span class="comment"># - sourceLabels: [__name__]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: container_(network_tcp_usage_total|network_udp_usage_total|tasks_state|cpu_load_average_10s)</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: drop</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">#   metrics_path is required to match upstream rules and charts</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span></div><div class="line"><span class="attr">      - sourceLabels:</span> [__metrics_path__]</div><div class="line"><span class="attr">        targetLabel:</span> metrics_path</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line"><span class="comment">## Component scraping the kube controller manager</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">kubeControllerManager:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## If your kube controller manager is not deployed as a pod, specify IPs it can be found on</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  endpoints:</span> []</div><div class="line">  <span class="comment"># - 10.141.4.22</span></div><div class="line">  <span class="comment"># - 10.141.4.23</span></div><div class="line">  <span class="comment"># - 10.141.4.24</span></div><div class="line"></div><div class="line">  <span class="comment">## If using kubeControllerManager.endpoints only the port and targetPort are used</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="attr">    port:</span> <span class="number">10252</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">10252</span></div><div class="line">    <span class="comment"># selector:</span></div><div class="line">    <span class="comment">#   component: kube-controller-manager</span></div><div class="line"></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## Enable scraping kube-controller-manager over https.</span></div><div class="line">    <span class="comment">## Requires proper certs (not self-signed) and delegated authentication/authorization checks</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    https:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment"># Skip TLS certificate validation when scraping</span></div><div class="line"><span class="attr">    insecureSkipVerify:</span> <span class="literal">null</span></div><div class="line"></div><div class="line">    <span class="comment"># Name of the server to use when validating TLS certificate</span></div><div class="line"><span class="attr">    serverName:</span> <span class="literal">null</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line"><span class="comment">## Component scraping coreDns. Use either this or kubeDns</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">coreDns:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="attr">    port:</span> <span class="number">9153</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">9153</span></div><div class="line">    <span class="comment"># selector:</span></div><div class="line">    <span class="comment">#   k8s-app: kube-dns</span></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line"><span class="comment">## Component scraping kubeDns. Use either this or coreDns</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">kubeDns:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="attr">    dnsmasq:</span></div><div class="line"><span class="attr">      port:</span> <span class="number">10054</span></div><div class="line"><span class="attr">      targetPort:</span> <span class="number">10054</span></div><div class="line"><span class="attr">    skydns:</span></div><div class="line"><span class="attr">      port:</span> <span class="number">10055</span></div><div class="line"><span class="attr">      targetPort:</span> <span class="number">10055</span></div><div class="line">    <span class="comment"># selector:</span></div><div class="line">    <span class="comment">#   k8s-app: kube-dns</span></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"><span class="attr">    dnsmasqMetricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    dnsmasqRelabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line"><span class="comment">## Component scraping etcd</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">kubeEtcd:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## If your etcd is not deployed as a pod, specify IPs it can be found on</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  endpoints:</span> []</div><div class="line">  <span class="comment"># - 10.141.4.22</span></div><div class="line">  <span class="comment"># - 10.141.4.23</span></div><div class="line">  <span class="comment"># - 10.141.4.24</span></div><div class="line"></div><div class="line">  <span class="comment">## Etcd service. If using kubeEtcd.endpoints only the port and targetPort are used</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="attr">    port:</span> <span class="number">2379</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">2379</span></div><div class="line">    <span class="comment"># selector:</span></div><div class="line">    <span class="comment">#   component: etcd</span></div><div class="line"></div><div class="line">  <span class="comment">## Configure secure access to the etcd cluster by loading a secret into prometheus and</span></div><div class="line">  <span class="comment">## specifying security configuration below. For example, with a secret named etcd-client-cert</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## serviceMonitor:</span></div><div class="line">  <span class="comment">##   scheme: https</span></div><div class="line">  <span class="comment">##   insecureSkipVerify: false</span></div><div class="line">  <span class="comment">##   serverName: localhost</span></div><div class="line">  <span class="comment">##   caFile: /etc/prometheus/secrets/etcd-client-cert/etcd-ca</span></div><div class="line">  <span class="comment">##   certFile: /etc/prometheus/secrets/etcd-client-cert/etcd-client</span></div><div class="line">  <span class="comment">##   keyFile: /etc/prometheus/secrets/etcd-client-cert/etcd-client-key</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"><span class="attr">    scheme:</span> http</div><div class="line"><span class="attr">    insecureSkipVerify:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    serverName:</span> <span class="string">""</span></div><div class="line"><span class="attr">    caFile:</span> <span class="string">""</span></div><div class="line"><span class="attr">    certFile:</span> <span class="string">""</span></div><div class="line"><span class="attr">    keyFile:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## Component scraping kube scheduler</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">kubeScheduler:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## If your kube scheduler is not deployed as a pod, specify IPs it can be found on</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  endpoints:</span> []</div><div class="line">  <span class="comment"># - 10.141.4.22</span></div><div class="line">  <span class="comment"># - 10.141.4.23</span></div><div class="line">  <span class="comment"># - 10.141.4.24</span></div><div class="line"></div><div class="line">  <span class="comment">## If using kubeScheduler.endpoints only the port and targetPort are used</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="attr">    port:</span> <span class="number">10251</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">10251</span></div><div class="line">    <span class="comment"># selector:</span></div><div class="line">    <span class="comment">#   component: kube-scheduler</span></div><div class="line"></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line">    <span class="comment">## Enable scraping kube-scheduler over https.</span></div><div class="line">    <span class="comment">## Requires proper certs (not self-signed) and delegated authentication/authorization checks</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    https:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## Skip TLS certificate validation when scraping</span></div><div class="line"><span class="attr">    insecureSkipVerify:</span> <span class="literal">null</span></div><div class="line"></div><div class="line">    <span class="comment">## Name of the server to use when validating TLS certificate</span></div><div class="line"><span class="attr">    serverName:</span> <span class="literal">null</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## Component scraping kube proxy</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">kubeProxy:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## If your kube proxy is not deployed as a pod, specify IPs it can be found on</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  endpoints:</span> []</div><div class="line">  <span class="comment"># - 10.141.4.22</span></div><div class="line">  <span class="comment"># - 10.141.4.23</span></div><div class="line">  <span class="comment"># - 10.141.4.24</span></div><div class="line"></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="attr">    port:</span> <span class="number">10249</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">10249</span></div><div class="line">    <span class="comment"># selector:</span></div><div class="line">    <span class="comment">#   k8s-app: kube-proxy</span></div><div class="line"></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## Enable scraping kube-proxy over https.</span></div><div class="line">    <span class="comment">## Requires proper certs (not self-signed) and delegated authentication/authorization checks</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    https:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## Component scraping kube state metrics</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">kubeStateMetrics:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line"><span class="comment">## Configuration for kube-state-metrics subchart</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">kube-state-metrics:</span></div><div class="line"><span class="attr">  rbac:</span></div><div class="line"><span class="attr">    create:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  podSecurityPolicy:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">## Deploy node exporter as a daemonset to all nodes</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">nodeExporter:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## Use the value configured in prometheus-node-exporter.podLabels</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  jobLabel:</span> jobLabel</div><div class="line"></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## How long until a scrape request times out. If not set, the Prometheus default scape timeout is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    scrapeTimeout:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__name__]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^node_mountstats_nfs_(event|operations|transport)_.+</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: drop</span></div><div class="line"></div><div class="line">    <span class="comment">## 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line"><span class="comment">## Configuration for prometheus-node-exporter subchart</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">prometheus-node-exporter:</span></div><div class="line"><span class="attr">  podLabels:</span></div><div class="line">    <span class="comment">## Add the 'node-exporter' label to be used by serviceMonitor to match standard common usage in rules and grafana dashboards</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    jobLabel:</span> node-exporter</div><div class="line"><span class="attr">  extraArgs:</span></div><div class="line"><span class="bullet">    -</span> --collector.filesystem.ignored-mount-points=^/(dev|proc|sys|var/lib/docker/.+)($|/)</div><div class="line"><span class="bullet">    -</span> --collector.filesystem.ignored-fs-types=^(autofs|binfmt_misc|cgroup|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|mqueue|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|sysfs|tracefs)$</div><div class="line"></div><div class="line"><span class="comment">## Manages Prometheus and Alertmanager components</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">prometheusOperator:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment"># If true prometheus operator will create and update its CRDs on startup</span></div><div class="line"><span class="attr">  manageCrds:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="attr">  tlsProxy:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    image:</span></div><div class="line"><span class="attr">      repository:</span> squareup/ghostunnel</div><div class="line"><span class="attr">      tag:</span> v1<span class="number">.5</span><span class="number">.2</span></div><div class="line"><span class="attr">      pullPolicy:</span> IfNotPresent</div><div class="line"><span class="attr">    resources:</span> &#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment">## Admission webhook support for PrometheusRules resources added in Prometheus Operator 0.30 can be enabled to prevent incorrectly formatted</span></div><div class="line">  <span class="comment">## rules from making their way into prometheus and potentially preventing the container from starting</span></div><div class="line"><span class="attr">  admissionWebhooks:</span></div><div class="line"><span class="attr">    failurePolicy:</span> Fail</div><div class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></div><div class="line">    <span class="comment">## If enabled, generate a self-signed certificate, then patch the webhook configurations with the generated data.</span></div><div class="line">    <span class="comment">## On chart upgrades (or if the secret exists) the cert will not be re-generated. You can use this to provide your own</span></div><div class="line">    <span class="comment">## certs ahead of time if you wish.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    patch:</span></div><div class="line"><span class="attr">      enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">      image:</span></div><div class="line"><span class="attr">        repository:</span> jettech/kube-webhook-certgen</div><div class="line"><span class="attr">        tag:</span> v1<span class="number">.0</span><span class="number">.0</span></div><div class="line"><span class="attr">        pullPolicy:</span> IfNotPresent</div><div class="line"><span class="attr">      resources:</span> &#123;&#125;</div><div class="line">      <span class="comment">## Provide a priority class name to the webhook patching job</span></div><div class="line">      <span class="comment">##</span></div><div class="line"><span class="attr">      priorityClassName:</span> <span class="string">""</span></div><div class="line"><span class="attr">      podAnnotations:</span> &#123;&#125;</div><div class="line"><span class="attr">      nodeSelector:</span> &#123;&#125;</div><div class="line"><span class="attr">      affinity:</span> &#123;&#125;</div><div class="line"><span class="attr">      tolerations:</span> []</div><div class="line"></div><div class="line">  <span class="comment">## Namespaces to scope the interaction of the Prometheus Operator and the apiserver (allow list).</span></div><div class="line">  <span class="comment">## This is mutually exclusive with denyNamespaces. Setting this to an empty object will disable the configuration</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  namespaces:</span> &#123;&#125;</div><div class="line">    <span class="comment"># releaseNamespace: true</span></div><div class="line">    <span class="comment"># additional:</span></div><div class="line">    <span class="comment"># - kube-system</span></div><div class="line"></div><div class="line">  <span class="comment">## Namespaces not to scope the interaction of the Prometheus Operator (deny list).</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  denyNamespaces:</span> []</div><div class="line"></div><div class="line">  <span class="comment">## Service account for Alertmanager to use.</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  serviceAccount:</span></div><div class="line"><span class="attr">    create:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    name:</span> <span class="string">""</span></div><div class="line"></div><div class="line">  <span class="comment">## Configuration for Prometheus operator service</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="attr">    annotations:</span> &#123;&#125;</div><div class="line"><span class="attr">    labels:</span> &#123;&#125;</div><div class="line"><span class="attr">    clusterIP:</span> <span class="string">""</span></div><div class="line"></div><div class="line">  <span class="comment">## Port to expose on each node</span></div><div class="line">  <span class="comment">## Only used if service.type is 'NodePort'</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">    nodePort:</span> <span class="number">30080</span></div><div class="line"></div><div class="line"><span class="attr">    nodePortTls:</span> <span class="number">30443</span></div><div class="line"></div><div class="line">  <span class="comment">## Additional ports to open for Prometheus service</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/services-networking/service/#multi-port-services</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">    additionalPorts:</span> []</div><div class="line"></div><div class="line">  <span class="comment">## Loadbalancer IP</span></div><div class="line">  <span class="comment">## Only use if service.type is "loadbalancer"</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">    loadBalancerIP:</span> <span class="string">""</span></div><div class="line"><span class="attr">    loadBalancerSourceRanges:</span> []</div><div class="line"></div><div class="line">  <span class="comment">## Service type</span></div><div class="line">  <span class="comment">## NodePort, ClusterIP, loadbalancer</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">    type:</span> ClusterIP</div><div class="line"></div><div class="line">    <span class="comment">## List of IP addresses at which the Prometheus server service is available</span></div><div class="line">    <span class="comment">## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    externalIPs:</span> []</div><div class="line"></div><div class="line">  <span class="comment">## Deploy CRDs used by Prometheus Operator.</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  createCustomResource:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## Attempt to clean up CRDs created by Prometheus Operator.</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  cleanupCustomResource:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">  <span class="comment">## Labels to add to the operator pod</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  podLabels:</span> &#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment">## Annotations to add to the operator pod</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  podAnnotations:</span> &#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment">## Assign a PriorityClassName to pods if set</span></div><div class="line">  <span class="comment"># priorityClassName: ""</span></div><div class="line"></div><div class="line">  <span class="comment">## Define Log Format</span></div><div class="line">  <span class="comment"># Use logfmt (default) or json-formatted logging</span></div><div class="line">  <span class="comment"># logFormat: logfmt</span></div><div class="line"></div><div class="line">  <span class="comment">## Decrease log verbosity to errors only</span></div><div class="line">  <span class="comment"># logLevel: error</span></div><div class="line"></div><div class="line">  <span class="comment">## If true, the operator will create and maintain a service for scraping kubelets</span></div><div class="line">  <span class="comment">## ref: https://github.com/coreos/prometheus-operator/blob/master/helm/prometheus-operator/README.md</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  kubeletService:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    namespace:</span> kube-system</div><div class="line"></div><div class="line">  <span class="comment">## Create a servicemonitor for the operator</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"><span class="attr">    selfMonitor:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line">  <span class="comment">## Resource limits &amp; requests</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  resources:</span> &#123;&#125;</div><div class="line">  <span class="comment"># limits:</span></div><div class="line">  <span class="comment">#   cpu: 200m</span></div><div class="line">  <span class="comment">#   memory: 200Mi</span></div><div class="line">  <span class="comment"># requests:</span></div><div class="line">  <span class="comment">#   cpu: 100m</span></div><div class="line">  <span class="comment">#   memory: 100Mi</span></div><div class="line"></div><div class="line">  <span class="comment">## Define which Nodes the Pods are scheduled on.</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/user-guide/node-selection/</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  nodeSelector:</span> &#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment">## Tolerations for use with node taints</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  tolerations:</span> []</div><div class="line">  <span class="comment"># - key: "key"</span></div><div class="line">  <span class="comment">#   operator: "Equal"</span></div><div class="line">  <span class="comment">#   value: "value"</span></div><div class="line">  <span class="comment">#   effect: "NoSchedule"</span></div><div class="line"></div><div class="line">  <span class="comment">## Assign custom affinity rules to the prometheus operator</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  affinity:</span> &#123;&#125;</div><div class="line">    <span class="comment"># nodeAffinity:</span></div><div class="line">    <span class="comment">#   requiredDuringSchedulingIgnoredDuringExecution:</span></div><div class="line">    <span class="comment">#     nodeSelectorTerms:</span></div><div class="line">    <span class="comment">#     - matchExpressions:</span></div><div class="line">    <span class="comment">#       - key: kubernetes.io/e2e-az-name</span></div><div class="line">    <span class="comment">#         operator: In</span></div><div class="line">    <span class="comment">#         values:</span></div><div class="line">    <span class="comment">#         - e2e-az1</span></div><div class="line">    <span class="comment">#         - e2e-az2</span></div><div class="line"></div><div class="line"><span class="attr">  securityContext:</span></div><div class="line"><span class="attr">    runAsNonRoot:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    runAsUser:</span> <span class="number">65534</span></div><div class="line"></div><div class="line">  <span class="comment">## Prometheus-operator image</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  image:</span></div><div class="line"><span class="attr">    repository:</span> quay.io/coreos/prometheus-operator</div><div class="line"><span class="attr">    tag:</span> v0<span class="number">.37</span><span class="number">.0</span></div><div class="line"><span class="attr">    pullPolicy:</span> IfNotPresent</div><div class="line"></div><div class="line">  <span class="comment">## Configmap-reload image to use for reloading configmaps</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  configmapReloadImage:</span></div><div class="line"><span class="attr">    repository:</span> quay.io/coreos/configmap-reload</div><div class="line"><span class="attr">    tag:</span> v0<span class="number">.0</span><span class="number">.1</span></div><div class="line"></div><div class="line">  <span class="comment">## Prometheus-config-reloader image to use for config and rule reloading</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  prometheusConfigReloaderImage:</span></div><div class="line"><span class="attr">    repository:</span> quay.io/coreos/prometheus-config-reloader</div><div class="line"><span class="attr">    tag:</span> v0<span class="number">.37</span><span class="number">.0</span></div><div class="line"></div><div class="line">  <span class="comment">## Set the prometheus config reloader side-car CPU limit</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  configReloaderCpu:</span> <span class="number">100</span>m</div><div class="line"></div><div class="line">  <span class="comment">## Set the prometheus config reloader side-car memory limit</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  configReloaderMemory:</span> <span class="number">25</span>Mi</div><div class="line"></div><div class="line">  <span class="comment">## Hyperkube image to use when cleaning up</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  hyperkubeImage:</span></div><div class="line"><span class="attr">    repository:</span> k8s.gcr.io/hyperkube</div><div class="line"><span class="attr">    tag:</span> v1<span class="number">.12</span><span class="number">.1</span></div><div class="line"><span class="attr">    pullPolicy:</span> IfNotPresent</div><div class="line"></div><div class="line"><span class="comment">## Deploy a Prometheus instance</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">prometheus:</span></div><div class="line"></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## Annotations for Prometheus</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  annotations:</span> &#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment">## Service account for Prometheuses to use.</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  serviceAccount:</span></div><div class="line"><span class="attr">    create:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    name:</span> <span class="string">""</span></div><div class="line"></div><div class="line">  <span class="comment">## Configuration for Prometheus service</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="attr">    annotations:</span> &#123;&#125;</div><div class="line"><span class="attr">    labels:</span> &#123;&#125;</div><div class="line"><span class="attr">    clusterIP:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## Port for Prometheus Service to listen on</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    port:</span> <span class="number">9090</span></div><div class="line"></div><div class="line">    <span class="comment">## To be used with a proxy extraContainer port</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">9090</span></div><div class="line"></div><div class="line">    <span class="comment">## List of IP addresses at which the Prometheus server service is available</span></div><div class="line">    <span class="comment">## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    externalIPs:</span> []</div><div class="line"></div><div class="line">    <span class="comment">## Port to expose on each node</span></div><div class="line">    <span class="comment">## Only used if service.type is 'NodePort'</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    nodePort:</span> <span class="number">30090</span></div><div class="line"><span class="attr">    type:</span> NodePort</div><div class="line"></div><div class="line">    <span class="comment">## Loadbalancer IP</span></div><div class="line">    <span class="comment">## Only use if service.type is "loadbalancer"</span></div><div class="line"><span class="attr">    loadBalancerIP:</span> <span class="string">""</span></div><div class="line"><span class="attr">    loadBalancerSourceRanges:</span> []</div><div class="line">    <span class="comment">## Service type</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment">##type: ClusterIP</span></div><div class="line"></div><div class="line"><span class="attr">    sessionAffinity:</span> <span class="string">""</span></div><div class="line"></div><div class="line">  <span class="comment">## Configuration for creating a separate Service for each statefulset Prometheus replica</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  servicePerReplica:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    annotations:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Port for Prometheus Service per replica to listen on</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    port:</span> <span class="number">9090</span></div><div class="line"></div><div class="line">    <span class="comment">## To be used with a proxy extraContainer port</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">9090</span></div><div class="line"></div><div class="line">    <span class="comment">## Port to expose on each node</span></div><div class="line">    <span class="comment">## Only used if servicePerReplica.type is 'NodePort'</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    nodePort:</span> <span class="number">30091</span></div><div class="line"></div><div class="line">    <span class="comment">## Loadbalancer source IP ranges</span></div><div class="line">    <span class="comment">## Only used if servicePerReplica.type is "loadbalancer"</span></div><div class="line"><span class="attr">    loadBalancerSourceRanges:</span> []</div><div class="line">    <span class="comment">## Service type</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment">#type: NodePort</span></div><div class="line"><span class="attr">    type:</span> ClusterIP</div><div class="line"></div><div class="line">  <span class="comment">## Configure pod disruption budgets for Prometheus</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/tasks/run-application/configure-pdb/#specifying-a-poddisruptionbudget</span></div><div class="line">  <span class="comment">## This configuration is immutable once created and will require the PDB to be deleted to be changed</span></div><div class="line">  <span class="comment">## https://github.com/kubernetes/kubernetes/issues/45398</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  podDisruptionBudget:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    minAvailable:</span> <span class="number">1</span></div><div class="line"><span class="attr">    maxUnavailable:</span> <span class="string">""</span></div><div class="line"></div><div class="line"><span class="attr">  ingress:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    annotations:</span> &#123;&#125;</div><div class="line"><span class="attr">    labels:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Hostnames.</span></div><div class="line">    <span class="comment">## Must be provided if Ingress is enabled.</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># hosts:</span></div><div class="line">    <span class="comment">#   - prometheus.domain.com</span></div><div class="line"><span class="attr">    hosts:</span> []</div><div class="line"></div><div class="line">    <span class="comment">## Paths to use for ingress rules - one path should match the prometheusSpec.routePrefix</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    paths:</span> []</div><div class="line">    <span class="comment"># - /</span></div><div class="line"></div><div class="line">    <span class="comment">## TLS configuration for Prometheus Ingress</span></div><div class="line">    <span class="comment">## Secret must be manually created in the namespace</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    tls:</span> []</div><div class="line">      <span class="comment"># - secretName: prometheus-general-tls</span></div><div class="line">      <span class="comment">#   hosts:</span></div><div class="line">      <span class="comment">#     - prometheus.example.com</span></div><div class="line"></div><div class="line">  <span class="comment">## Configuration for creating an Ingress that will map to each Prometheus replica service</span></div><div class="line">  <span class="comment">## prometheus.servicePerReplica must be enabled</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  ingressPerReplica:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    annotations:</span> &#123;&#125;</div><div class="line"><span class="attr">    labels:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Final form of the hostname for each per replica ingress is</span></div><div class="line">    <span class="comment">## &#123;&#123; ingressPerReplica.hostPrefix &#125;&#125;-&#123;&#123; $replicaNumber &#125;&#125;.&#123;&#123; ingressPerReplica.hostDomain &#125;&#125;</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment">## Prefix for the per replica ingress that will have `-$replicaNumber`</span></div><div class="line">    <span class="comment">## appended to the end</span></div><div class="line"><span class="attr">    hostPrefix:</span> <span class="string">""</span></div><div class="line">    <span class="comment">## Domain that will be used for the per replica ingress</span></div><div class="line"><span class="attr">    hostDomain:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## Paths to use for ingress rules</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    paths:</span> []</div><div class="line">    <span class="comment"># - /</span></div><div class="line"></div><div class="line">    <span class="comment">## Secret name containing the TLS certificate for Prometheus per replica ingress</span></div><div class="line">    <span class="comment">## Secret must be manually created in the namespace</span></div><div class="line"><span class="attr">    tlsSecretName:</span> <span class="string">""</span></div><div class="line"></div><div class="line">  <span class="comment">## Configure additional options for default pod security policy for Prometheus</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/policy/pod-security-policy/</span></div><div class="line"><span class="attr">  podSecurityPolicy:</span></div><div class="line"><span class="attr">    allowedCapabilities:</span> []</div><div class="line"></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    interval:</span> <span class="string">""</span></div><div class="line"><span class="attr">    selfMonitor:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">    <span class="comment">## scheme: HTTP scheme to use for scraping. Can be used with `tlsConfig` for example if using istio mTLS.</span></div><div class="line"><span class="attr">    scheme:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## tlsConfig: TLS configuration to use when scraping the endpoint. For example if using istio mTLS.</span></div><div class="line">    <span class="comment">## Of type: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#tlsconfig</span></div><div class="line"><span class="attr">    tlsConfig:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="attr">    bearerTokenFile:</span></div><div class="line"></div><div class="line">    <span class="comment">## 	metric relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    metricRelabelings:</span> []</div><div class="line">    <span class="comment"># - action: keep</span></div><div class="line">    <span class="comment">#   regex: 'kube_(daemonset|deployment|pod|namespace|node|statefulset).+'</span></div><div class="line">    <span class="comment">#   sourceLabels: [__name__]</span></div><div class="line"></div><div class="line">    <span class="comment"># 	relabel configs to apply to samples before ingestion.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    relabelings:</span> []</div><div class="line">    <span class="comment"># - sourceLabels: [__meta_kubernetes_pod_node_name]</span></div><div class="line">    <span class="comment">#   separator: ;</span></div><div class="line">    <span class="comment">#   regex: ^(.*)$</span></div><div class="line">    <span class="comment">#   targetLabel: nodename</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: replace</span></div><div class="line"></div><div class="line">  <span class="comment">## Settings affecting prometheusSpec</span></div><div class="line">  <span class="comment">## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#prometheusspec</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  prometheusSpec:</span></div><div class="line">    <span class="comment">## If true, pass --storage.tsdb.max-block-duration=2h to prometheus. This is already done if using Thanos</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    disableCompaction:</span> <span class="literal">false</span></div><div class="line">    <span class="comment">## APIServerConfig</span></div><div class="line">    <span class="comment">## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#apiserverconfig</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    apiserverConfig:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Interval between consecutive scrapes.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    scrapeInterval:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## Interval between consecutive evaluations.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    evaluationInterval:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## ListenLocal makes the Prometheus server listen on loopback, so that it does not bind against the Pod IP.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    listenLocal:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## EnableAdminAPI enables Prometheus the administrative HTTP API which includes functionality such as deleting time series.</span></div><div class="line">    <span class="comment">## This is disabled by default.</span></div><div class="line">    <span class="comment">## ref: https://prometheus.io/docs/prometheus/latest/querying/api/#tsdb-admin-apis</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    enableAdminAPI:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## Image of Prometheus.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    image:</span></div><div class="line"><span class="attr">      repository:</span> quay.io/prometheus/prometheus</div><div class="line"><span class="attr">      tag:</span> v2<span class="number">.15</span><span class="number">.2</span></div><div class="line"></div><div class="line">    <span class="comment">## Tolerations for use with node taints</span></div><div class="line">    <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    tolerations:</span> []</div><div class="line">    <span class="comment">#  - key: "key"</span></div><div class="line">    <span class="comment">#    operator: "Equal"</span></div><div class="line">    <span class="comment">#    value: "value"</span></div><div class="line">    <span class="comment">#    effect: "NoSchedule"</span></div><div class="line"></div><div class="line">    <span class="comment">## Alertmanagers to which alerts will be sent</span></div><div class="line">    <span class="comment">## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#alertmanagerendpoints</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment">## Default configuration will connect to the alertmanager deployed as part of this release</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    alertingEndpoints:</span> []</div><div class="line">    <span class="comment"># - name: ""</span></div><div class="line">    <span class="comment">#   namespace: ""</span></div><div class="line">    <span class="comment">#   port: http</span></div><div class="line">    <span class="comment">#   scheme: http</span></div><div class="line">    <span class="comment">#   pathPrefix: ""</span></div><div class="line">    <span class="comment">#   tlsConfig: &#123;&#125;</span></div><div class="line">    <span class="comment">#   bearerTokenFile: ""</span></div><div class="line">    <span class="comment">#   apiVersion: v2</span></div><div class="line"></div><div class="line">    <span class="comment">## External labels to add to any time series or alerts when communicating with external systems</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    externalLabels:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Name of the external label used to denote replica name</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    replicaExternalLabelName:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## If true, the Operator won't add the external label used to denote replica name</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    replicaExternalLabelNameClear:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## Name of the external label used to denote Prometheus instance name</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    prometheusExternalLabelName:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## If true, the Operator won't add the external label used to denote Prometheus instance name</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    prometheusExternalLabelNameClear:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## External URL at which Prometheus will be reachable.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    externalUrl:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## Define which Nodes the Pods are scheduled on.</span></div><div class="line">    <span class="comment">## ref: https://kubernetes.io/docs/user-guide/node-selection/</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    nodeSelector:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Secrets is a list of Secrets in the same namespace as the Prometheus object, which shall be mounted into the Prometheus Pods.</span></div><div class="line">    <span class="comment">## The Secrets are mounted into /etc/prometheus/secrets/. Secrets changes after initial creation of a Prometheus object are not</span></div><div class="line">    <span class="comment">## reflected in the running Pods. To change the secrets mounted into the Prometheus Pods, the object must be deleted and recreated</span></div><div class="line">    <span class="comment">## with the new list of secrets.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    secrets:</span> []</div><div class="line"></div><div class="line">    <span class="comment">## ConfigMaps is a list of ConfigMaps in the same namespace as the Prometheus object, which shall be mounted into the Prometheus Pods.</span></div><div class="line">    <span class="comment">## The ConfigMaps are mounted into /etc/prometheus/configmaps/.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    configMaps:</span> []</div><div class="line"></div><div class="line">    <span class="comment">## QuerySpec defines the query command line flags when starting Prometheus.</span></div><div class="line">    <span class="comment">## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#queryspec</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    query:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Namespaces to be selected for PrometheusRules discovery.</span></div><div class="line">    <span class="comment">## If nil, select own namespace. Namespaces to be selected for ServiceMonitor discovery.</span></div><div class="line">    <span class="comment">## See https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#namespaceselector for usage</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    ruleNamespaceSelector:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## If true, a nil or &#123;&#125; value for prometheus.prometheusSpec.ruleSelector will cause the</span></div><div class="line">    <span class="comment">## prometheus resource to be created with selectors based on values in the helm deployment,</span></div><div class="line">    <span class="comment">## which will also match the PrometheusRule resources created</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    ruleSelectorNilUsesHelmValues:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">    <span class="comment">## PrometheusRules to be selected for target discovery.</span></div><div class="line">    <span class="comment">## If &#123;&#125;, select all ServiceMonitors</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    ruleSelector:</span> &#123;&#125;</div><div class="line">    <span class="comment">## Example which select all prometheusrules resources</span></div><div class="line">    <span class="comment">## with label "prometheus" with values any of "example-rules" or "example-rules-2"</span></div><div class="line">    <span class="comment"># ruleSelector:</span></div><div class="line">    <span class="comment">#   matchExpressions:</span></div><div class="line">    <span class="comment">#     - key: prometheus</span></div><div class="line">    <span class="comment">#       operator: In</span></div><div class="line">    <span class="comment">#       values:</span></div><div class="line">    <span class="comment">#         - example-rules</span></div><div class="line">    <span class="comment">#         - example-rules-2</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment">## Example which select all prometheusrules resources with label "role" set to "example-rules"</span></div><div class="line">    <span class="comment"># ruleSelector:</span></div><div class="line">    <span class="comment">#   matchLabels:</span></div><div class="line">    <span class="comment">#     role: example-rules</span></div><div class="line"></div><div class="line">    <span class="comment">## If true, a nil or &#123;&#125; value for prometheus.prometheusSpec.serviceMonitorSelector will cause the</span></div><div class="line">    <span class="comment">## prometheus resource to be created with selectors based on values in the helm deployment,</span></div><div class="line">    <span class="comment">## which will also match the servicemonitors created</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    serviceMonitorSelectorNilUsesHelmValues:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">    <span class="comment">## ServiceMonitors to be selected for target discovery.</span></div><div class="line">    <span class="comment">## If &#123;&#125;, select all ServiceMonitors</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    serviceMonitorSelector:</span> &#123;&#125;</div><div class="line">    <span class="comment">## Example which selects ServiceMonitors with label "prometheus" set to "somelabel"</span></div><div class="line">    <span class="comment"># serviceMonitorSelector:</span></div><div class="line">    <span class="comment">#   matchLabels:</span></div><div class="line">    <span class="comment">#     prometheus: somelabel</span></div><div class="line"></div><div class="line">    <span class="comment">## Namespaces to be selected for ServiceMonitor discovery.</span></div><div class="line">    <span class="comment">## See https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#namespaceselector for usage</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    serviceMonitorNamespaceSelector:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## If true, a nil or &#123;&#125; value for prometheus.prometheusSpec.podMonitorSelector will cause the</span></div><div class="line">    <span class="comment">## prometheus resource to be created with selectors based on values in the helm deployment,</span></div><div class="line">    <span class="comment">## which will also match the podmonitors created</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    podMonitorSelectorNilUsesHelmValues:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">    <span class="comment">## PodMonitors to be selected for target discovery.</span></div><div class="line">    <span class="comment">## If &#123;&#125;, select all PodMonitors</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    podMonitorSelector:</span> &#123;&#125;</div><div class="line">    <span class="comment">## Example which selects PodMonitors with label "prometheus" set to "somelabel"</span></div><div class="line">    <span class="comment"># podMonitorSelector:</span></div><div class="line">    <span class="comment">#   matchLabels:</span></div><div class="line">    <span class="comment">#     prometheus: somelabel</span></div><div class="line"></div><div class="line">    <span class="comment">## Namespaces to be selected for PodMonitor discovery.</span></div><div class="line">    <span class="comment">## See https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#namespaceselector for usage</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    podMonitorNamespaceSelector:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## How long to retain metrics</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    retention:</span> <span class="number">10</span>d</div><div class="line"></div><div class="line">    <span class="comment">## Maximum size of metrics</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    retentionSize:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## Enable compression of the write-ahead log using Snappy.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    walCompression:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## If true, the Operator won't process any Prometheus configuration changes</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    paused:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## Number of Prometheus replicas desired</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    replicas:</span> <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="comment">## Log level for Prometheus be configured in</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    logLevel:</span> info</div><div class="line"></div><div class="line">    <span class="comment">## Log format for Prometheus be configured in</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    logFormat:</span> logfmt</div><div class="line"></div><div class="line">    <span class="comment">## Prefix used to register routes, overriding externalUrl route.</span></div><div class="line">    <span class="comment">## Useful for proxies that rewrite URLs.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    routePrefix:</span> /</div><div class="line"></div><div class="line">    <span class="comment">## Standard objectâ€™s metadata. More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata</span></div><div class="line">    <span class="comment">## Metadata Labels and Annotations gets propagated to the prometheus pods.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    podMetadata:</span> &#123;&#125;</div><div class="line">    <span class="comment"># labels:</span></div><div class="line">    <span class="comment">#   app: prometheus</span></div><div class="line">    <span class="comment">#   k8s-app: prometheus</span></div><div class="line"></div><div class="line">    <span class="comment">## Pod anti-affinity can prevent the scheduler from placing Prometheus replicas on the same node.</span></div><div class="line">    <span class="comment">## The default value "soft" means that the scheduler should *prefer* to not schedule two replica pods onto the same node but no guarantee is provided.</span></div><div class="line">    <span class="comment">## The value "hard" means that the scheduler is *required* to not schedule two replica pods onto the same node.</span></div><div class="line">    <span class="comment">## The value "" will disable pod anti-affinity so that no anti-affinity rules will be configured.</span></div><div class="line"><span class="attr">    podAntiAffinity:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## If anti-affinity is enabled sets the topologyKey to use for anti-affinity.</span></div><div class="line">    <span class="comment">## This can be changed to, for example, failure-domain.beta.kubernetes.io/zone</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    podAntiAffinityTopologyKey:</span> kubernetes.io/hostname</div><div class="line"></div><div class="line">    <span class="comment">## Assign custom affinity rules to the prometheus instance</span></div><div class="line">    <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    affinity:</span> &#123;&#125;</div><div class="line">    <span class="comment"># nodeAffinity:</span></div><div class="line">    <span class="comment">#   requiredDuringSchedulingIgnoredDuringExecution:</span></div><div class="line">    <span class="comment">#     nodeSelectorTerms:</span></div><div class="line">    <span class="comment">#     - matchExpressions:</span></div><div class="line">    <span class="comment">#       - key: kubernetes.io/e2e-az-name</span></div><div class="line">    <span class="comment">#         operator: In</span></div><div class="line">    <span class="comment">#         values:</span></div><div class="line">    <span class="comment">#         - e2e-az1</span></div><div class="line">    <span class="comment">#         - e2e-az2</span></div><div class="line"></div><div class="line">    <span class="comment">## The remote_read spec configuration for Prometheus.</span></div><div class="line">    <span class="comment">## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#remotereadspec</span></div><div class="line"><span class="attr">    remoteRead:</span> []</div><div class="line">    <span class="comment"># - url: http://remote1/read</span></div><div class="line"></div><div class="line">    <span class="comment">## The remote_write spec configuration for Prometheus.</span></div><div class="line">    <span class="comment">## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#remotewritespec</span></div><div class="line"><span class="attr">    remoteWrite:</span> []</div><div class="line">    <span class="comment"># - url: http://remote1/push</span></div><div class="line"></div><div class="line">    <span class="comment">## Enable/Disable Grafana dashboards provisioning for prometheus remote write feature</span></div><div class="line"><span class="attr">    remoteWriteDashboards:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## Resource limits &amp; requests</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    resources:</span> &#123;&#125;</div><div class="line">    <span class="comment"># requests:</span></div><div class="line">    <span class="comment">#   memory: 400Mi</span></div><div class="line"></div><div class="line">    <span class="comment">## Prometheus StorageSpec for persistent data</span></div><div class="line">    <span class="comment">## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/storage.md</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    storageSpec:</span> &#123;&#125;</div><div class="line">    <span class="comment">#  volumeClaimTemplate:</span></div><div class="line">    <span class="comment">#    spec:</span></div><div class="line">    <span class="comment">#      storageClassName: gluster</span></div><div class="line">    <span class="comment">#      accessModes: ["ReadWriteOnce"]</span></div><div class="line">    <span class="comment">#      resources:</span></div><div class="line">    <span class="comment">#        requests:</span></div><div class="line">    <span class="comment">#          storage: 50Gi</span></div><div class="line">    <span class="comment">#    selector: &#123;&#125;</span></div><div class="line"></div><div class="line">    <span class="comment">## AdditionalScrapeConfigs allows specifying additional Prometheus scrape configurations. Scrape configurations</span></div><div class="line">    <span class="comment">## are appended to the configurations generated by the Prometheus Operator. Job configurations must have the form</span></div><div class="line">    <span class="comment">## as specified in the official Prometheus documentation:</span></div><div class="line">    <span class="comment">## https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config. As scrape configs are</span></div><div class="line">    <span class="comment">## appended, the user is responsible to make sure it is valid. Note that using this feature may expose the possibility</span></div><div class="line">    <span class="comment">## to break upgrades of Prometheus. It is advised to review Prometheus release notes to ensure that no incompatible</span></div><div class="line">    <span class="comment">## scrape configs are going to break Prometheus after the upgrade.</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment">## The scrape configuraiton example below will find master nodes, provided they have the name .*mst.*, relabel the</span></div><div class="line">    <span class="comment">## port to 2379 and allow etcd scraping provided it is running on all Kubernetes master nodes</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    additionalScrapeConfigs:</span> []</div><div class="line">    <span class="comment"># - job_name: kube-etcd</span></div><div class="line">    <span class="comment">#   kubernetes_sd_configs:</span></div><div class="line">    <span class="comment">#     - role: node</span></div><div class="line">    <span class="comment">#   scheme: https</span></div><div class="line">    <span class="comment">#   tls_config:</span></div><div class="line">    <span class="comment">#     ca_file:   /etc/prometheus/secrets/etcd-client-cert/etcd-ca</span></div><div class="line">    <span class="comment">#     cert_file: /etc/prometheus/secrets/etcd-client-cert/etcd-client</span></div><div class="line">    <span class="comment">#     key_file:  /etc/prometheus/secrets/etcd-client-cert/etcd-client-key</span></div><div class="line">    <span class="comment">#   relabel_configs:</span></div><div class="line">    <span class="comment">#   - action: labelmap</span></div><div class="line">    <span class="comment">#     regex: __meta_kubernetes_node_label_(.+)</span></div><div class="line">    <span class="comment">#   - source_labels: [__address__]</span></div><div class="line">    <span class="comment">#     action: replace</span></div><div class="line">    <span class="comment">#     targetLabel: __address__</span></div><div class="line">    <span class="comment">#     regex: ([^:;]+):(\d+)</span></div><div class="line">    <span class="comment">#     replacement: $&#123;1&#125;:2379</span></div><div class="line">    <span class="comment">#   - source_labels: [__meta_kubernetes_node_name]</span></div><div class="line">    <span class="comment">#     action: keep</span></div><div class="line">    <span class="comment">#     regex: .*mst.*</span></div><div class="line">    <span class="comment">#   - source_labels: [__meta_kubernetes_node_name]</span></div><div class="line">    <span class="comment">#     action: replace</span></div><div class="line">    <span class="comment">#     targetLabel: node</span></div><div class="line">    <span class="comment">#     regex: (.*)</span></div><div class="line">    <span class="comment">#     replacement: $&#123;1&#125;</span></div><div class="line">    <span class="comment">#   metric_relabel_configs:</span></div><div class="line">    <span class="comment">#   - regex: (kubernetes_io_hostname|failure_domain_beta_kubernetes_io_region|beta_kubernetes_io_os|beta_kubernetes_io_arch|beta_kubernetes_io_instance_type|failure_domain_beta_kubernetes_io_zone)</span></div><div class="line">    <span class="comment">#     action: labeldrop</span></div><div class="line"></div><div class="line">    <span class="comment">## additionalPrometheusSecretsAnnotations allows to add annotations to the kubernetes secret. This can be useful</span></div><div class="line">    <span class="comment">## when deploying via spinnaker to disable versioning on the secret, strategy.spinnaker.io/versioned: 'false'</span></div><div class="line"><span class="attr">    additionalPrometheusSecretsAnnotations:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## AdditionalAlertManagerConfigs allows for manual configuration of alertmanager jobs in the form as specified</span></div><div class="line">    <span class="comment">## in the official Prometheus documentation https://prometheus.io/docs/prometheus/latest/configuration/configuration/#&lt;alertmanager_config&gt;.</span></div><div class="line">    <span class="comment">## AlertManager configurations specified are appended to the configurations generated by the Prometheus Operator.</span></div><div class="line">    <span class="comment">## As AlertManager configs are appended, the user is responsible to make sure it is valid. Note that using this</span></div><div class="line">    <span class="comment">## feature may expose the possibility to break upgrades of Prometheus. It is advised to review Prometheus release</span></div><div class="line">    <span class="comment">## notes to ensure that no incompatible AlertManager configs are going to break Prometheus after the upgrade.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    additionalAlertManagerConfigs:</span> []</div><div class="line">    <span class="comment"># - consul_sd_configs:</span></div><div class="line">    <span class="comment">#   - server: consul.dev.test:8500</span></div><div class="line">    <span class="comment">#     scheme: http</span></div><div class="line">    <span class="comment">#     datacenter: dev</span></div><div class="line">    <span class="comment">#     tag_separator: ','</span></div><div class="line">    <span class="comment">#     services:</span></div><div class="line">    <span class="comment">#       - metrics-prometheus-alertmanager</span></div><div class="line"></div><div class="line">    <span class="comment">## AdditionalAlertRelabelConfigs allows specifying Prometheus alert relabel configurations. Alert relabel configurations specified are appended</span></div><div class="line">    <span class="comment">## to the configurations generated by the Prometheus Operator. Alert relabel configurations specified must have the form as specified in the</span></div><div class="line">    <span class="comment">## official Prometheus documentation: https://prometheus.io/docs/prometheus/latest/configuration/configuration/#alert_relabel_configs.</span></div><div class="line">    <span class="comment">## As alert relabel configs are appended, the user is responsible to make sure it is valid. Note that using this feature may expose the</span></div><div class="line">    <span class="comment">## possibility to break upgrades of Prometheus. It is advised to review Prometheus release notes to ensure that no incompatible alert relabel</span></div><div class="line">    <span class="comment">## configs are going to break Prometheus after the upgrade.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    additionalAlertRelabelConfigs:</span> []</div><div class="line">    <span class="comment"># - separator: ;</span></div><div class="line">    <span class="comment">#   regex: prometheus_replica</span></div><div class="line">    <span class="comment">#   replacement: $1</span></div><div class="line">    <span class="comment">#   action: labeldrop</span></div><div class="line"></div><div class="line">    <span class="comment">## SecurityContext holds pod-level security attributes and common container settings.</span></div><div class="line">    <span class="comment">## This defaults to non root user with uid 1000 and gid 2000.</span></div><div class="line">    <span class="comment">## https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    securityContext:</span></div><div class="line"><span class="attr">      runAsNonRoot:</span> <span class="literal">true</span></div><div class="line"><span class="attr">      runAsUser:</span> <span class="number">1000</span></div><div class="line"><span class="attr">      fsGroup:</span> <span class="number">2000</span></div><div class="line"></div><div class="line">    <span class="comment">## 	Priority class assigned to the Pods</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    priorityClassName:</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">## Thanos configuration allows configuring various aspects of a Prometheus server in a Thanos environment.</span></div><div class="line">    <span class="comment">## This section is experimental, it may change significantly without deprecation notice in any release.</span></div><div class="line">    <span class="comment">## This is experimental and may change significantly without backward compatibility in any release.</span></div><div class="line">    <span class="comment">## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#thanosspec</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    thanos:</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">## Containers allows injecting additional containers. This is meant to allow adding an authentication proxy to a Prometheus pod.</span></div><div class="line">    <span class="comment">##  if using proxy extraContainer  update targetPort with proxy container port</span></div><div class="line"><span class="attr">    containers:</span> []</div><div class="line"></div><div class="line">    <span class="comment">## Enable additional scrape configs that are managed externally to this chart. Note that the prometheus</span></div><div class="line">    <span class="comment">## will fail to provision if the correct secret does not exist.</span></div><div class="line">    <span class="comment">## This option requires that you are maintaining a secret in the same namespace as Prometheus with</span></div><div class="line">    <span class="comment">## a name of 'prometheus-operator-prometheus-scrape-confg' and a key of 'additional-scrape-configs.yaml' that</span></div><div class="line">    <span class="comment">## contains a list of scrape_config's. The name of the secret may vary if you utilize the "fullnameOverride".</span></div><div class="line">    <span class="comment">## This feature cannot be used in conjunction with the additionalScrapeConfigs attribute (the helm-generated</span></div><div class="line">    <span class="comment">## secret will overwrite your self-maintained secret).</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment">## scrape_config docs: https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config</span></div><div class="line">    <span class="comment">## explanation of "confg" typo: https://github.com/helm/charts/issues/13368</span></div><div class="line"><span class="attr">    additionalScrapeConfigsExternal:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="comment">## PortName to use for Prometheus.</span></div><div class="line">    <span class="comment">##</span></div><div class="line"><span class="attr">    portName:</span> <span class="string">"web"</span></div><div class="line"></div><div class="line"><span class="attr">  additionalServiceMonitors:</span> []</div><div class="line">  <span class="comment">## Name of the ServiceMonitor to create</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># - name: ""</span></div><div class="line"></div><div class="line">    <span class="comment">## Additional labels to set used for the ServiceMonitorSelector. Together with standard labels from</span></div><div class="line">    <span class="comment">## the chart</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># additionalLabels: &#123;&#125;</span></div><div class="line"></div><div class="line">    <span class="comment">## Service label for use in assembling a job name of the form &lt;label value&gt;-&lt;port&gt;</span></div><div class="line">    <span class="comment">## If no label is specified, the service name is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># jobLabel: ""</span></div><div class="line"></div><div class="line">    <span class="comment">## labels to transfer from the kubernetes service to the target</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># targetLabels: ""</span></div><div class="line"></div><div class="line">    <span class="comment">## Label selector for services to which this ServiceMonitor applies</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># selector: &#123;&#125;</span></div><div class="line"></div><div class="line">    <span class="comment">## Namespaces from which services are selected</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># namespaceSelector:</span></div><div class="line">      <span class="comment">## Match any namespace</span></div><div class="line">      <span class="comment">##</span></div><div class="line">      <span class="comment"># any: false</span></div><div class="line"></div><div class="line">      <span class="comment">## Explicit list of namespace names to select</span></div><div class="line">      <span class="comment">##</span></div><div class="line">      <span class="comment"># matchNames: []</span></div><div class="line"></div><div class="line">    <span class="comment">## Endpoints of the selected service to be monitored</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># endpoints: []</span></div><div class="line">      <span class="comment">## Name of the endpoint's service port</span></div><div class="line">      <span class="comment">## Mutually exclusive with targetPort</span></div><div class="line">      <span class="comment"># - port: ""</span></div><div class="line"></div><div class="line">      <span class="comment">## Name or number of the endpoint's target port</span></div><div class="line">      <span class="comment">## Mutually exclusive with port</span></div><div class="line">      <span class="comment"># - targetPort: ""</span></div><div class="line"></div><div class="line">      <span class="comment">## File containing bearer token to be used when scraping targets</span></div><div class="line">      <span class="comment">##</span></div><div class="line">      <span class="comment">#   bearerTokenFile: ""</span></div><div class="line"></div><div class="line">      <span class="comment">## Interval at which metrics should be scraped</span></div><div class="line">      <span class="comment">##</span></div><div class="line">      <span class="comment">#   interval: 30s</span></div><div class="line"></div><div class="line">      <span class="comment">## HTTP path to scrape for metrics</span></div><div class="line">      <span class="comment">##</span></div><div class="line">      <span class="comment">#   path: /metrics</span></div><div class="line"></div><div class="line">      <span class="comment">## HTTP scheme to use for scraping</span></div><div class="line">      <span class="comment">##</span></div><div class="line">      <span class="comment">#   scheme: http</span></div><div class="line"></div><div class="line">      <span class="comment">## TLS configuration to use when scraping the endpoint</span></div><div class="line">      <span class="comment">##</span></div><div class="line">      <span class="comment">#   tlsConfig:</span></div><div class="line"></div><div class="line">          <span class="comment">## Path to the CA file</span></div><div class="line">          <span class="comment">##</span></div><div class="line">          <span class="comment"># caFile: ""</span></div><div class="line"></div><div class="line">          <span class="comment">## Path to client certificate file</span></div><div class="line">          <span class="comment">##</span></div><div class="line">          <span class="comment"># certFile: ""</span></div><div class="line"></div><div class="line">          <span class="comment">## Skip certificate verification</span></div><div class="line">          <span class="comment">##</span></div><div class="line">          <span class="comment"># insecureSkipVerify: false</span></div><div class="line"></div><div class="line">          <span class="comment">## Path to client key file</span></div><div class="line">          <span class="comment">##</span></div><div class="line">          <span class="comment"># keyFile: ""</span></div><div class="line"></div><div class="line">          <span class="comment">## Server name used to verify host name</span></div><div class="line">          <span class="comment">##</span></div><div class="line">          <span class="comment"># serverName: ""</span></div><div class="line"></div><div class="line"><span class="attr">  additionalPodMonitors:</span> []</div><div class="line">  <span class="comment">## Name of the PodMonitor to create</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># - name: ""</span></div><div class="line"></div><div class="line">    <span class="comment">## Additional labels to set used for the PodMonitorSelector. Together with standard labels from</span></div><div class="line">    <span class="comment">## the chart</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># additionalLabels: &#123;&#125;</span></div><div class="line"></div><div class="line">    <span class="comment">## Pod label for use in assembling a job name of the form &lt;label value&gt;-&lt;port&gt;</span></div><div class="line">    <span class="comment">## If no label is specified, the pod endpoint name is used.</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># jobLabel: ""</span></div><div class="line"></div><div class="line">    <span class="comment">## Label selector for pods to which this PodMonitor applies</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># selector: &#123;&#125;</span></div><div class="line"></div><div class="line">    <span class="comment">## PodTargetLabels transfers labels on the Kubernetes Pod onto the target.</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># podTargetLabels: &#123;&#125;</span></div><div class="line"></div><div class="line">    <span class="comment">## SampleLimit defines per-scrape limit on number of scraped samples that will be accepted.</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># sampleLimit: 0</span></div><div class="line"></div><div class="line">    <span class="comment">## Namespaces from which pods are selected</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># namespaceSelector:</span></div><div class="line">      <span class="comment">## Match any namespace</span></div><div class="line">      <span class="comment">##</span></div><div class="line">      <span class="comment"># any: false</span></div><div class="line"></div><div class="line">      <span class="comment">## Explicit list of namespace names to select</span></div><div class="line">      <span class="comment">##</span></div><div class="line">      <span class="comment"># matchNames: []</span></div><div class="line"></div><div class="line">    <span class="comment">## Endpoints of the selected pods to be monitored</span></div><div class="line">    <span class="comment">## https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#podmetricsendpoint</span></div><div class="line">    <span class="comment">##</span></div><div class="line">    <span class="comment"># podMetricsEndpoints: []</span></div></pre></td></tr></table></figure>
<p>å®‰è£… prometheus-operator</p>
<p> <code>helm install --name prometheus-operator .  --namespace=monitoring</code></p>
<p>è®©æˆ‘ä»¬æ¸…ç†é»˜è®¤è§„åˆ™ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°è§‚å¯Ÿæˆ‘ä»¬å°†è¦åˆ›å»ºçš„é‚£ä¸ªè§„åˆ™ã€‚ä»¥ä¸‹å‘½ä»¤å°†åˆ é™¤æ‰€æœ‰è§„åˆ™ï¼Œä½†ä¼šç•™ä¸‹monitoring-demo-prometheus-operator-alertmanager.rulesã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl -n monitoring <span class="keyword">delete</span> prometheusrules $(kubectl -n <span class="keyword">monitoring</span> <span class="keyword">get</span> prometheusrules | grep -v alert)</div></pre></td></tr></table></figure>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ kubectl -n monitoring <span class="built_in">get</span> prometheusrules</div><div class="line">NAME                                          AGE</div><div class="line">demo-prometheus-<span class="keyword">operator</span>-alertmanager.rules   <span class="number">8</span>m53s</div></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼šæˆ‘ä»¬åªä¿ç•™ä¸€æ¡è§„åˆ™æ˜¯ä¸ºäº†è®©demoæ›´å®¹æ˜“ã€‚ä½†æ˜¯æœ‰ä¸€æ¡è§„åˆ™ï¼Œä½ ç»å¯¹ä¸èƒ½åˆ é™¤ï¼Œå®ƒä½äº<code>monitoring-demo-prometheus-operator-general.rules.yaml</code>ä¸­ï¼Œè¢«ç§°ä¸ºçœ‹é—¨ç‹—ã€‚è¯¥å‘Šè­¦æ€»æ˜¯å¤„äºè§¦å‘çŠ¶æ€ï¼Œå…¶ç›®çš„æ˜¯ç¡®ä¿æ•´ä¸ªå‘Šè­¦æµæ°´çº¿æ­£å¸¸è¿è½¬ã€‚</p>
</blockquote>
<p>åˆ›å»ºè‡ªå·±çš„é¢„è­¦</p>
<p> cat prometheus-operator-tomcat-rules.yaml</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="attribute">apiVersion</span>: monitoring.coreos.com/v1</div><div class="line"></div><div class="line"><span class="http"><span class="attribute">kind</span>: PrometheusRule</span></div><div class="line"></div><div class="line"><span class="yaml"><span class="attr">metadata:</span></span></div><div class="line"></div><div class="line"><span class="attr">  labels:</span></div><div class="line"></div><div class="line"><span class="attr">    chart:</span> prometheus-operator<span class="bullet">-8.12</span><span class="number">.0</span></div><div class="line"></div><div class="line"><span class="attr">    heritage:</span> Tiller</div><div class="line"></div><div class="line"><span class="attr">    app:</span> prometheus-operator</div><div class="line"></div><div class="line"><span class="attr">    release:</span> prometheus-operator</div><div class="line"></div><div class="line"><span class="attr">  name:</span> prometheus-operator-tomcat-test.rules</div><div class="line"></div><div class="line"><span class="attr">  namespace:</span> monitoring</div><div class="line"></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  groups:</span></div><div class="line">  <span class="comment">#- name: webhook</span></div><div class="line">  <span class="comment">#  rules:</span></div><div class="line">  <span class="comment">#  - alert: "é’‰é’‰æŠ¥è­¦æµ‹è¯•"</span></div><div class="line">  <span class="comment">#    expr: rate(kube_pod_container_status_restarts_total&#123;job="kube-state-metrics",</span></div><div class="line">  <span class="comment">#      namespace=~".*"&#125;[15m]) * 60 * 5 &gt; 0</span></div><div class="line">  <span class="comment">#    for: 5m</span></div><div class="line">  <span class="comment">#    labels:</span></div><div class="line">  <span class="comment">#      severity: 'è­¦å‘Š'</span></div><div class="line">  <span class="comment">#    annotations:</span></div><div class="line">  <span class="comment">#      summary: "&#123;&#123; $labels.instance &#125;&#125;: é’‰é’‰æŠ¥è­¦æµ‹è¯•"</span></div><div class="line">  <span class="comment">#      description: "&#123;&#123; $labels.instance &#125;&#125;ï¼šé’‰é’‰æŠ¥è­¦æµ‹è¯•"</span></div><div class="line">  <span class="comment">#      custom: "é’‰é’‰æŠ¥è­¦æµ‹è¯•"</span></div><div class="line">  <span class="comment">#      value: "&#123;&#123;$value&#125;&#125;"</span></div><div class="line"><span class="attr">  - name:</span> alert-pods.rules</div><div class="line"><span class="attr">    rules:</span></div><div class="line"><span class="attr">    - alert:</span> <span class="string">"160æµ‹è¯•/ç°åº¦ç¯å¢ƒPodåº”ç”¨æŒ‚èµ·é¢„è­¦"</span></div><div class="line"><span class="attr">      annotations:</span></div><div class="line"><span class="attr">        description:</span> åº”ç”¨ &#123;&#123; $labels.namespace &#125;&#125;/&#123;&#123; $labels.pod &#125;&#125; (&#123;&#123; $labels.container</div><div class="line">          &#125;&#125;) is restarting &#123;&#123; printf <span class="string">"%.2f"</span> $value &#125;&#125; times / <span class="number">5</span> minutes.</div><div class="line"><span class="attr">      expr:</span> rate(kube_pod_container_status_restarts_total&#123;job=<span class="string">"kube-state-metrics"</span>,</div><div class="line">        namespace=~<span class="string">".*"</span>&#125;[<span class="number">15</span>m]) * <span class="number">60</span> * <span class="number">5</span> &gt; <span class="number">0</span></div><div class="line"><span class="attr">      for:</span> <span class="number">15</span>m</div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        severity:</span> critical  <span class="comment"># æ³¨æ„è¿™è¡Œï¼Œalertmangarè¦æ ¹æ®è¿™ä¸ªæ ‡ç­¾æ¥è¿›è¡ŒæŠ¥è­¦</span></div></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†Prometheuså‘Šè­¦çš„è®¾ç½®ï¼Œè®©æˆ‘ä»¬é…ç½®Alertmanagerï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡ç”µå­é‚®ä»¶è·å¾—å‘Šè­¦é€šçŸ¥ã€‚Alertmanagerçš„é…ç½®ä½äºKubernetes secretå¯¹è±¡ä¸­ã€‚</p>
<p>cat alertmanager.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="attr">global:</span></div><div class="line"></div><div class="line">  <span class="comment"># åœ¨æ²¡æœ‰æŠ¥è­¦çš„æƒ…å†µä¸‹å£°æ˜ä¸ºå·²è§£å†³çš„æ—¶é—´</span></div><div class="line"></div><div class="line"><span class="attr">  resolve_timeout:</span> <span class="number">5</span>m</div><div class="line"></div><div class="line">  <span class="comment"># é…ç½®é‚®ä»¶å‘é€ä¿¡æ¯</span></div><div class="line"></div><div class="line"><span class="attr">  smtp_smarthost:</span> <span class="string">'smtp.qq.com:465'</span></div><div class="line"></div><div class="line"><span class="attr">  smtp_from:</span> <span class="string">'XXX@qq.com'</span></div><div class="line"></div><div class="line"><span class="attr">  smtp_auth_username:</span> <span class="string">'XXX@qq.com'</span></div><div class="line"></div><div class="line"><span class="attr">  smtp_auth_password:</span> <span class="string">"xxxxxxxxxxx"</span></div><div class="line"></div><div class="line"><span class="attr">  smtp_hello:</span> <span class="string">'xxxx@qq.com'</span></div><div class="line"></div><div class="line"><span class="attr">  smtp_require_tls:</span> <span class="literal">false</span></div><div class="line"></div><div class="line"><span class="comment"># æ‰€æœ‰æŠ¥è­¦ä¿¡æ¯è¿›å…¥åçš„æ ¹è·¯ç”±ï¼Œç”¨æ¥è®¾ç½®æŠ¥è­¦çš„åˆ†å‘ç­–ç•¥</span></div><div class="line"></div><div class="line"><span class="attr">route:</span></div><div class="line"></div><div class="line">  <span class="comment"># è¿™é‡Œçš„æ ‡ç­¾åˆ—è¡¨æ˜¯æ¥æ”¶åˆ°æŠ¥è­¦ä¿¡æ¯åçš„é‡æ–°åˆ†ç»„æ ‡ç­¾ï¼Œä¾‹å¦‚ï¼Œæ¥æ”¶åˆ°çš„æŠ¥è­¦ä¿¡æ¯é‡Œé¢æœ‰è®¸å¤šå…·æœ‰ cluster=A å’Œ alertname=LatncyHigh è¿™æ ·çš„æ ‡ç­¾çš„æŠ¥è­¦ä¿¡æ¯å°†ä¼šæ‰¹é‡è¢«èšåˆåˆ°ä¸€ä¸ªåˆ†ç»„é‡Œé¢</span></div><div class="line"></div><div class="line"><span class="attr">  group_by:</span> [<span class="string">'alertname'</span>, <span class="string">'cluster'</span>,<span class="string">'namespace'</span>]</div><div class="line"></div><div class="line">  <span class="comment"># å½“ä¸€ä¸ªæ–°çš„æŠ¥è­¦åˆ†ç»„è¢«åˆ›å»ºåï¼Œéœ€è¦ç­‰å¾…è‡³å°‘group_waitæ—¶é—´æ¥åˆå§‹åŒ–é€šçŸ¥ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿æ‚¨èƒ½æœ‰è¶³å¤Ÿçš„æ—¶é—´ä¸ºåŒä¸€åˆ†ç»„æ¥è·å–å¤šä¸ªè­¦æŠ¥ï¼Œç„¶åä¸€èµ·è§¦å‘è¿™ä¸ªæŠ¥è­¦ä¿¡æ¯ã€‚</span></div><div class="line"></div><div class="line"><span class="attr">  group_wait:</span> <span class="number">20</span>m</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment"># å½“ç¬¬ä¸€ä¸ªæŠ¥è­¦å‘é€åï¼Œç­‰å¾…'group_interval'æ—¶é—´æ¥å‘é€æ–°çš„ä¸€ç»„æŠ¥è­¦ä¿¡æ¯ã€‚</span></div><div class="line"></div><div class="line"><span class="attr">  group_interval:</span> <span class="number">30</span>m</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment"># å¦‚æœä¸€ä¸ªæŠ¥è­¦ä¿¡æ¯å·²ç»å‘é€æˆåŠŸäº†ï¼Œç­‰å¾…'repeat_interval'æ—¶é—´æ¥é‡æ–°å‘é€ä»–ä»¬</span></div><div class="line"></div><div class="line"><span class="attr">  repeat_interval:</span> <span class="number">25</span>m</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment"># é»˜è®¤çš„receiverï¼šå¦‚æœä¸€ä¸ªæŠ¥è­¦æ²¡æœ‰è¢«ä¸€ä¸ªrouteåŒ¹é…ï¼Œåˆ™å‘é€ç»™é»˜è®¤çš„æ¥æ”¶å™¨</span></div><div class="line"></div><div class="line">  <span class="comment">#receiver: default</span></div><div class="line"><span class="attr">  receiver:</span> webhook</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment"># ä¸Šé¢æ‰€æœ‰çš„å±æ€§éƒ½ç”±æ‰€æœ‰å­è·¯ç”±ç»§æ‰¿ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æ¯ä¸ªå­è·¯ç”±ä¸Šè¿›è¡Œè¦†ç›–ã€‚</span></div><div class="line"></div><div class="line"><span class="attr">  routes:</span></div><div class="line"></div><div class="line"><span class="attr">  - receiver:</span> email</div><div class="line"></div><div class="line"><span class="attr">    group_wait:</span> <span class="number">10</span>s</div><div class="line"></div><div class="line"><span class="attr">    match:</span></div><div class="line"></div><div class="line"><span class="attr">      alertManagerRule:</span> node  <span class="comment">#æ ¹æ®æ­¤æ ‡ç­¾ï¼Œé€‰æ‹©æŠ¥è­¦è§„åˆ™</span></div><div class="line"></div><div class="line"><span class="attr">  - receiver:</span> webhook</div><div class="line"></div><div class="line"><span class="attr">    match:</span></div><div class="line"><span class="attr">      severity:</span> critical</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="attr">receivers:</span></div><div class="line"></div><div class="line"><span class="attr">- name:</span> <span class="string">'default'</span></div><div class="line"></div><div class="line"><span class="attr">  email_configs:</span></div><div class="line"></div><div class="line"><span class="attr">  - to:</span> <span class="string">'xxxx@qq.com'</span></div><div class="line"></div><div class="line"><span class="attr">    send_resolved:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="attr">- name:</span> <span class="string">'email'</span></div><div class="line"></div><div class="line"><span class="attr">  email_configs:</span></div><div class="line"></div><div class="line"><span class="attr">  - to:</span> <span class="string">'xxxxx@qq.com'</span></div><div class="line"></div><div class="line"><span class="attr">    send_resolved:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"> <span class="comment"># webhook_configs:</span></div><div class="line"></div><div class="line"> <span class="comment"># - url: 'http://dingtalk-hook:5000'</span></div><div class="line"></div><div class="line"> <span class="comment">#   send_resolved: true</span></div><div class="line"></div><div class="line"><span class="attr">- name:</span> <span class="string">'webhook'</span></div><div class="line"></div><div class="line"><span class="attr">  webhook_configs:</span></div><div class="line"></div><div class="line"><span class="attr">  - url:</span> <span class="string">'http://webhook-dingtalk/dingtalk/webhook1/send'</span></div><div class="line"></div><div class="line"><span class="attr">    send_resolved:</span> <span class="literal">true</span></div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl <span class="keyword">create</span> secret generic alertmanager-prometheus-<span class="keyword">operator</span>-alertmanager <span class="comment">--from-file=alertmanager.yaml -n monitoring</span></div><div class="line">kubectl <span class="keyword">apply</span> -f prometheus-<span class="keyword">operator</span>-tomcat-rules.yaml</div></pre></td></tr></table></figure>
<p>å¯èƒ½é‡åˆ°çš„å‘</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">kubectl get validatingwebhookconfigurations<span class="selector-class">.admissionregistration</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span></div><div class="line">kubectl delete  validatingwebhookconfigurations<span class="selector-class">.admissionregistration</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span>  prometheus-operator-admission</div><div class="line">kubectl get MutatingWebhookConfiguration</div><div class="line">kubectl delete MutatingWebhookConfiguration prometheus-operator-admission</div></pre></td></tr></table></figure>
<hr>
<h3 id="Kubernetesé›†ç¾¤Prometheus-Operatoré’‰é’‰æŠ¥è­¦é…ç½®"><a href="#Kubernetesé›†ç¾¤Prometheus-Operatoré’‰é’‰æŠ¥è­¦é…ç½®" class="headerlink" title="Kubernetesé›†ç¾¤Prometheus Operatoré’‰é’‰æŠ¥è­¦é…ç½®"></a>Kubernetesé›†ç¾¤Prometheus Operatoré’‰é’‰æŠ¥è­¦é…ç½®</h3><p>åˆ›å»ºk8s   dingtalk-webhook</p>
<p>cat dingtalk-webhook.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> apps/v1</div><div class="line"><span class="attr">kind:</span> Deployment</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> webhook-dingtalk</div><div class="line"><span class="attr">  namespace:</span> monitoring</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      app:</span> dingtalk</div><div class="line"><span class="attr">  replicas:</span> <span class="number">1</span></div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> dingtalk</div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      nodeSelector:</span></div><div class="line"><span class="attr">        nodeType:</span> master</div><div class="line"><span class="attr">      restartPolicy:</span> Always</div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - name:</span> dingtalk</div><div class="line"><span class="attr">        image:</span> timonwong/prometheus-webhook-dingtalk:v1<span class="number">.4</span><span class="number">.0</span></div><div class="line"><span class="attr">        imagePullPolicy:</span> IfNotPresent</div><div class="line"><span class="attr">        args:</span></div><div class="line"><span class="bullet">          -</span> <span class="string">'--web.enable-ui'</span></div><div class="line"><span class="bullet">          -</span> <span class="string">'--web.enable-lifecycle'</span></div><div class="line"><span class="bullet">          -</span> <span class="string">'--config.file=/mnt/data/dingtalk/dingdingalert/templates/config.yml'</span></div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - containerPort:</span> <span class="number">8060</span></div><div class="line"><span class="attr">          protocol:</span> TCP</div><div class="line"><span class="attr">        volumeMounts:</span></div><div class="line"><span class="attr">        - mountPath:</span> <span class="string">"/mnt/data/dingtalk/dingdingalert/templates"</span></div><div class="line"><span class="attr">          name:</span> dingtalk-volume</div><div class="line"><span class="attr">      volumes:</span></div><div class="line"><span class="attr">      - name:</span> dingtalk-volume</div><div class="line"><span class="attr">        hostPath:</span></div><div class="line"><span class="attr">          path:</span> <span class="string">"/mnt/data/dingtalk/dingdingalert/templates"</span></div><div class="line">        <span class="comment">#persistentVolumeClaim:</span></div><div class="line">        <span class="comment">#  claimName: dingding-pvc</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> Service</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> webhook-dingtalk</div><div class="line"><span class="attr">  namespace:</span> monitoring</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">  - port:</span> <span class="number">80</span></div><div class="line"><span class="attr">    protocol:</span> TCP</div><div class="line"><span class="attr">    targetPort:</span> <span class="number">8060</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    app:</span> dingtalk</div><div class="line"><span class="attr">  sessionAffinity:</span> None</div></pre></td></tr></table></figure>
<p>cat /mnt/data/dingtalk/dingdingalert/templates/config.yml</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">templates:</span></div><div class="line">  - <span class="meta-keyword">/mnt/</span>data<span class="meta-keyword">/dingtalk/</span>dingdingalert<span class="meta-keyword">/templates/</span>template.tmpl</div><div class="line"><span class="symbol">targets:</span></div><div class="line"><span class="symbol">  webhook1:</span></div><div class="line"><span class="symbol">    url:</span> https:<span class="comment">//oapi.dingtalk.com/robot/send?access_token=84e6cdba089128514d1a641faf8bd28655af2089a47c729877f23c697e71f09b</span></div></pre></td></tr></table></figure>
<p>cat /mnt/data/dingtalk/dingdingalert/templates/template.tmpl</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; define <span class="string">"ding.link.title"</span> &#125;&#125;[ç›‘æ§æŠ¥è­¦]&#123;&#123; end &#125;&#125;</div><div class="line">&#123;&#123; define <span class="string">"ding.link.content"</span> -&#125;&#125;</div><div class="line">&#123;&#123;- if gt (len .Alerts.Firing) <span class="number">0</span> -&#125;&#125;</div><div class="line">  &#123;&#123; range $i, $alert := .Alerts.Firing &#125;&#125;</div><div class="line">    [å‘Šè­¦é¡¹ç›®]:&#123;&#123; index $alert.Labels <span class="string">"alertname"</span> &#125;&#125;</div><div class="line">    [å‘Šè­¦å®ä¾‹]:&#123;&#123; index $alert.Labels <span class="string">"instance"</span> &#125;&#125;</div><div class="line">    [å‘Šè­¦çº§åˆ«]:&#123;&#123; index $alert.Labels <span class="string">"severity"</span> &#125;&#125;</div><div class="line">    [å‘Šè­¦è¯¦æƒ…]:&#123;&#123; index $alert.Annotations <span class="string">"description"</span> &#125;&#125;</div><div class="line">    [è§¦å‘æ—¶é—´]:&#123;&#123; (.StartsAt.Add <span class="number">28800</span>e9).Format <span class="string">"2006-01-02 15:04:05"</span> &#125;&#125;</div><div class="line">  &#123;&#123; end &#125;&#125;&#123;&#123;- end &#125;&#125;</div><div class="line">&#123;&#123;- if gt (len .Alerts.Resolved) <span class="number">0</span> -&#125;&#125;</div><div class="line">  &#123;&#123; range $i, $alert := .Alerts.Resolved &#125;&#125;</div><div class="line">    [é¡¹ç›®]:&#123;&#123; index $alert.Labels <span class="string">"alertname"</span> &#125;&#125;</div><div class="line">    [å®ä¾‹]:&#123;&#123; index $alert.Labels <span class="string">"instance"</span> &#125;&#125;</div><div class="line">    [çŠ¶æ€]:æ­£åœ¨é‡å¯</div><div class="line">    [å¼€å§‹]:&#123;&#123; (.StartsAt.Add <span class="number">28800</span>e9).Format <span class="string">"2006-01-02 15:04:05"</span> &#125;&#125;</div><div class="line">    [æ¢å¤]:&#123;&#123; (.EndsAt.Add <span class="number">28800</span>e9).Format <span class="string">"2006-01-02 15:04:05"</span> &#125;&#125;</div><div class="line">  &#123;&#123; end &#125;&#125;&#123;&#123;- end &#125;&#125;</div><div class="line">&#123;&#123;- end &#125;&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;prometheus&lt;/li&gt;
&lt;li&gt;é’‰é’‰é¢„è­¦&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;éƒ¨ç½²Prometheus-è½¯ä»¶&quot;&gt;&lt;a href=&quot;#éƒ¨ç½²Prometheus-è½¯ä»¶&quot; class=&quot;headerlink&quot; title=&quot;éƒ¨ç½²Prometheus è½¯ä»¶&quot;&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Springboot AliOssUtil</title>
    <link href="http://peterfei.me/2021/03/22/Springboot-AliOssUtil/"/>
    <id>http://peterfei.me/2021/03/22/Springboot-AliOssUtil/</id>
    <published>2021-03-22T06:05:32.000Z</published>
    <updated>2022-08-26T02:42:20.304Z</updated>
    
    <content type="html"><![CDATA[<ul>
<li>oss</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.xxx.common.utils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</div><div class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</div><div class="line"><span class="keyword">import</span> com.aliyun.oss.*;</div><div class="line"><span class="keyword">import</span> com.aliyun.oss.model.CannedAccessControlList;</div><div class="line"><span class="keyword">import</span> com.aliyun.oss.model.PutObjectRequest;</div><div class="line"><span class="keyword">import</span> com.aliyun.oss.model.PutObjectResult;</div><div class="line"><span class="keyword">import</span> com.huazhu.spm.face.config.AliOssProperties;</div><div class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> haobiao</div><div class="line"> * <span class="doctag">@date</span> 2020/12/22 11:05</div><div class="line"> * <span class="doctag">@description</span> é˜¿é‡ŒOSSå­˜å‚¨</div><div class="line"> */</div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@Slf</span>4j</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AliOssUtil</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> AliOssProperties aliOssProperties;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> OSS <span class="title">initClient</span><span class="params">()</span> </span>&#123;</div><div class="line">        ClientBuilderConfiguration conf = <span class="keyword">new</span> ClientBuilderConfiguration();</div><div class="line">        conf.setConnectionTimeout(<span class="number">10000</span>);</div><div class="line">        conf.setMaxErrorRetry(<span class="number">10</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OSSClientBuilder().build(aliOssProperties.getEndpoint(), aliOssProperties.getKey(), aliOssProperties.getSecret(), conf);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸Šä¼ ç…§ç‰‡</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> inputStream</div><div class="line">     * <span class="doctag">@param</span> fileType    æ–‡ä»¶ç±»å‹</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">ossUploadFile</span><span class="params">(InputStream inputStream, String fileType)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            OSS ossBuild = <span class="keyword">new</span> OSSClientBuilder().build(aliOssProperties.getEndpoint(), aliOssProperties.getKey(), aliOssProperties.getSecret());</div><div class="line">            String bucketName = aliOssProperties.getBucket();</div><div class="line">            String endpoint = aliOssProperties.getEndpoint();</div><div class="line">            String fileName = DateUtil.format(<span class="keyword">new</span> Date(), <span class="string">"yyyyMMdd"</span>) + <span class="string">"/"</span> + IdUtil.simpleUUID() + <span class="string">"."</span> + fileType;</div><div class="line">            <span class="comment">//ä¸Šä¼ æ–‡ä»¶</span></div><div class="line">            PutObjectRequest putObjectRequest = <span class="keyword">new</span> PutObjectRequest(bucketName, fileName, inputStream);</div><div class="line">            PutObjectResult result = ossBuild.putObject(putObjectRequest);</div><div class="line">            <span class="comment">//è®¾ç½®æƒé™ä¸ºå…¬å¼€è¯»</span></div><div class="line">            ossBuild.setObjectAcl(bucketName, fileName, CannedAccessControlList.PublicRead);</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != result) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="string">"http://"</span> + bucketName + <span class="string">"."</span> + endpoint + <span class="string">"/"</span> + fileName;</div><div class="line">            &#125;</div><div class="line">            ossBuild.shutdown();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            log.error(<span class="string">"ossUploadFile exception is &#123;&#125;"</span>, e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AliOssUtil</span><span class="params">(AliOssProperties aliOssProperties)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.aliOssProperties = aliOssProperties;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;oss&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>k8s éƒ¨ç½²å’Œgitlab CI/CD</title>
    <link href="http://peterfei.me/2021/03/16/k8s-%E9%83%A8%E7%BD%B2%E5%92%8Cgitlab-CI-CD/"/>
    <id>http://peterfei.me/2021/03/16/k8s-éƒ¨ç½²å’Œgitlab-CI-CD/</id>
    <published>2021-03-16T08:01:03.000Z</published>
    <updated>2022-08-26T02:42:20.310Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><h4 id="1-å®‰è£…å¿…å¤‡è½¯ä»¶"><a href="#1-å®‰è£…å¿…å¤‡è½¯ä»¶" class="headerlink" title="1. å®‰è£…å¿…å¤‡è½¯ä»¶"></a>1. å®‰è£…å¿…å¤‡è½¯ä»¶</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y wget vim net-tools epel-<span class="keyword">release</span></div></pre></td></tr></table></figure>
<h4 id="2-å…³é—­swap"><a href="#2-å…³é—­swap" class="headerlink" title="2. å…³é—­swap"></a>2. å…³é—­swap</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">swapoff -a</div><div class="line"></div><div class="line"><span class="comment"># æ°¸ä¹…ç¦ç”¨ï¼Œæ‰“å¼€/etc/fstabæ³¨é‡Šæ‰swapé‚£ä¸€è¡Œã€‚</span></div><div class="line">sed -i <span class="string">'s/.*swap.*/#&amp;/'</span> <span class="regexp">/etc/</span>fstab</div></pre></td></tr></table></figure>
<h4 id="3-å…³é—­selinux"><a href="#3-å…³é—­selinux" class="headerlink" title="3. å…³é—­selinux"></a>3. å…³é—­selinux</h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># ä¸´æ—¶ç¦ç”¨selinux</span></div><div class="line">setenforce <span class="number">0</span></div><div class="line"><span class="meta"># æ°¸ä¹…å…³é—­ ä¿®æ”¹/etc/sysconfig/selinuxæ–‡ä»¶è®¾ç½®</span></div><div class="line">sed -i <span class="string">'s/SELINUX=permissive/SELINUX=disabled/'</span> /etc/sysconfig/selinux</div><div class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</div></pre></td></tr></table></figure>
<h3 id="4-å…³é—­é˜²ç«å¢™"><a href="#4-å…³é—­é˜²ç«å¢™" class="headerlink" title="4. å…³é—­é˜²ç«å¢™"></a>4. å…³é—­é˜²ç«å¢™</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl <span class="keyword">disable</span> firewalld</div><div class="line">systemctl <span class="keyword">stop</span> firewalld</div></pre></td></tr></table></figure>
<h2 id="å®‰è£…Dockerå’Œé…ç½®ä»£ç†"><a href="#å®‰è£…Dockerå’Œé…ç½®ä»£ç†" class="headerlink" title="å®‰è£…Dockerå’Œé…ç½®ä»£ç†"></a>å®‰è£…Dockerå’Œé…ç½®ä»£ç†</h2><h3 id="1-é…ç½®yumæº"><a href="#1-é…ç½®yumæº" class="headerlink" title="1. é…ç½®yumæº"></a>1. é…ç½®yumæº</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">## é…ç½®é»˜è®¤æº</div><div class="line">## å¤‡ä»½</div><div class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</div><div class="line"></div><div class="line">## ä¸‹è½½é˜¿é‡Œæº</div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http:<span class="comment">//mirrors.aliyun.com/repo/Centos-7.repo</span></div><div class="line"></div><div class="line">## åˆ·æ–°</div><div class="line">yum makecache fast</div><div class="line"></div><div class="line">## é…ç½®k8sæº</div><div class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</div><div class="line">[kubernetes]</div><div class="line">name=Kubernetes</div><div class="line">baseurl=https:<span class="comment">//mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></div><div class="line">enabled=<span class="number">1</span></div><div class="line">gpgcheck=<span class="number">0</span></div><div class="line">EOF</div><div class="line"></div><div class="line">## é‡å»ºyumç¼“å­˜</div><div class="line">yum clean all</div><div class="line">yum makecache fast</div><div class="line">yum -y update</div></pre></td></tr></table></figure>
<h3 id="2-å®‰è£…docker"><a href="#2-å®‰è£…docker" class="headerlink" title="2. å®‰è£…docker"></a>2. å®‰è£…docker</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">yum -y <span class="keyword">install</span> yum-utils device-mapper-persistent-<span class="keyword">data</span> lvm2</div><div class="line">yum-config-manager <span class="comment">--add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></div><div class="line">yum -y <span class="keyword">install</span>  docker-ce<span class="number">-20.10</span><span class="number">.5</span> </div><div class="line">systemctl <span class="keyword">enable</span> docker</div><div class="line">systemctl <span class="keyword">start</span> docker</div></pre></td></tr></table></figure>
<h3 id="3-ç¡®ä¿kubeletä½¿ç”¨çš„cgroup-driver-ä¸-Dockerçš„ä¸€è‡´"><a href="#3-ç¡®ä¿kubeletä½¿ç”¨çš„cgroup-driver-ä¸-Dockerçš„ä¸€è‡´" class="headerlink" title="3. ç¡®ä¿kubeletä½¿ç”¨çš„cgroup driver ä¸ Dockerçš„ä¸€è‡´"></a>3. ç¡®ä¿kubeletä½¿ç”¨çš„cgroup driver ä¸ Dockerçš„ä¸€è‡´</h3><figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;<span class="symbol">EOF</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</div><div class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</div><div class="line">  <span class="string">"log-opts"</span>: &#123;</div><div class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>,</div><div class="line">  <span class="string">"storage-opts"</span>: [</div><div class="line">    <span class="string">"overlay2.override_kernel_check=true"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://ifa4ye2m.mirror.aliyuncs.com"</span>]</div><div class="line">&#125;</div><div class="line"><span class="symbol">EOF</span></div><div class="line"></div><div class="line">sudo systemctl daemon-reload sudo systemctl restart docker</div></pre></td></tr></table></figure>
<h3 id="4-ä»å›½å†…ä»“åº“æ‹‰å–é•œåƒï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæ²¡æœ‰ä»£ç†ï¼‰"><a href="#4-ä»å›½å†…ä»“åº“æ‹‰å–é•œåƒï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæ²¡æœ‰ä»£ç†ï¼‰" class="headerlink" title="4. ä»å›½å†…ä»“åº“æ‹‰å–é•œåƒï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæ²¡æœ‰ä»£ç†ï¼‰"></a>4. ä»å›½å†…ä»“åº“æ‹‰å–é•œåƒï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæ²¡æœ‰ä»£ç†ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">images=(</div><div class="line">kube-apiserver:v1.18.16</div><div class="line">kube-controller-manager:v1.18.16</div><div class="line">kube-scheduler:v1.18.16</div><div class="line">kube-proxy:v1.18.16</div><div class="line">pause:3.2</div><div class="line">etcd:3.4.3-0</div><div class="line">coredns:1.6.7</div><div class="line">kubernetes-dashboard-amd64:v1.10.1</div><div class="line">)</div><div class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span>;<span class="keyword">do</span></div><div class="line">        docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></div><div class="line">        docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<h2 id="å¼€å§‹å®‰è£…k8s"><a href="#å¼€å§‹å®‰è£…k8s" class="headerlink" title="å¼€å§‹å®‰è£…k8s"></a>å¼€å§‹å®‰è£…k8s</h2><h3 id="1-å®‰è£…kubeadmï¼Œkubeletç­‰"><a href="#1-å®‰è£…kubeadmï¼Œkubeletç­‰" class="headerlink" title="1. å®‰è£…kubeadmï¼Œkubeletç­‰"></a>1. å®‰è£…kubeadmï¼Œkubeletç­‰</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">yum</span> <span class="selector-tag">install</span> <span class="selector-tag">kubelet-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span> <span class="selector-tag">kubeadm-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span> <span class="selector-tag">kubectl-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span> <span class="selector-tag">kubernetes-cni-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span></div></pre></td></tr></table></figure>
<h3 id="2-é›†ç¾¤åˆå§‹åŒ–"><a href="#2-é›†ç¾¤åˆå§‹åŒ–" class="headerlink" title="2. é›†ç¾¤åˆå§‹åŒ–"></a>2. é›†ç¾¤åˆå§‹åŒ–</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">## masterèŠ‚ç‚¹æ‰§è¡Œï¼š</div><div class="line">sudo kubeadm init \</div><div class="line"> --apiserver-advertise-address <span class="number">10.1</span><span class="number">.69</span><span class="number">.101</span> \</div><div class="line"> --kubernetes-version=v1<span class="number">.15</span><span class="number">.0</span> \</div><div class="line"> --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">å¦‚æœå¤–ç½‘ï¼š</div><div class="line"></div><div class="line">kubeadm init --apiserver-advertise-address xx.xx<span class="number">.255</span><span class="number">.84</span> --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> --kubernetes-version=v1<span class="number">.18</span><span class="number">.0</span></div></pre></td></tr></table></figure>
<p>å¾—åˆ°å›å¤ï¼š</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">(...çœç•¥)</div><div class="line"><span class="keyword">mkdir</span> -p <span class="variable">$HOME</span>/.kube</div><div class="line">sudo cp -i /etc/kubernetes/admin.<span class="keyword">conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -<span class="keyword">u</span>):$(id -<span class="keyword">g</span>) <span class="variable">$HOME</span>/.kube/config</div><div class="line"></div><div class="line">## ä¿å­˜å¥½è¯¥å‘½ä»¤ï¼Œä¸¢äº†ä¸å¥½æ‰¾å›ã€‚èŠ‚ç‚¹åŠ å…¥æ—¶éœ€è¦</div><div class="line">kubeadm join 10.1.69.101:6443 --<span class="keyword">token</span> ou5pvo.qseafc4s8licblzy \</div><div class="line">    --discovery-<span class="keyword">token</span>-<span class="keyword">ca</span>-cert-hash sha256:de9c10f11c50c074f212698b9d514fc12a9c1c4ffe70961aff89ac5e585f0663</div></pre></td></tr></table></figure>
<h3 id="3-æ‹·è´é…ç½®ï¼Œç»™kubectlä½¿ç”¨"><a href="#3-æ‹·è´é…ç½®ï¼Œç»™kubectlä½¿ç”¨" class="headerlink" title="3. æ‹·è´é…ç½®ï¼Œç»™kubectlä½¿ç”¨"></a>3. æ‹·è´é…ç½®ï¼Œç»™kubectlä½¿ç”¨</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir -<span class="selector-tag">p</span> <span class="variable">$HOME</span>/<span class="selector-class">.kube</span></div><div class="line">sudo cp -<span class="selector-tag">i</span> /etc/kubernetes/admin<span class="selector-class">.conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</div></pre></td></tr></table></figure>
<h3 id="4-å®‰è£…flannelç½‘ç»œ"><a href="#4-å®‰è£…flannelç½‘ç»œ" class="headerlink" title="4. å®‰è£…flannelç½‘ç»œ"></a>4. å®‰è£…flannelç½‘ç»œ</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo kubectl apply -<span class="keyword">f</span> http<span class="variable">s:</span>//raw.githubusercontent.<span class="keyword">com</span>/coreos/flannel/master/Documentation/kube-flannel.yml</div><div class="line"></div><div class="line">## æŸ¥çœ‹flannalæ˜¯å¦å®‰è£…æˆåŠŸ</div><div class="line"></div><div class="line">sudo kubectl -n kube-<span class="built_in">system</span> <span class="built_in">get</span> <span class="keyword">po</span> -<span class="keyword">l</span> app=flannel -<span class="keyword">o</span> wide</div></pre></td></tr></table></figure>
<h2 id="5-nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤"><a href="#5-nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤" class="headerlink" title="5. nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤"></a>5. nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h2><p>å…¶ä»–èŠ‚ç‚¹æ‰§è¡Œï¼š</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">kubeadm</span> <span class="selector-tag">join</span> 10<span class="selector-class">.1</span><span class="selector-class">.69</span><span class="selector-class">.101</span><span class="selector-pseudo">:6443</span> <span class="selector-tag">--token</span> <span class="selector-tag">ou5pvo</span><span class="selector-class">.qseafc4s8licblzy</span> \</div><div class="line">    <span class="selector-tag">--discovery-token-ca-cert-hash</span> <span class="selector-tag">sha256</span><span class="selector-pseudo">:de9c10f11c50c074f212698b9d514fc12a9c1c4ffe70961aff89ac5e585f0663</span></div></pre></td></tr></table></figure>
<h2 id="æ¸…ç†å®‰è£…"><a href="#æ¸…ç†å®‰è£…" class="headerlink" title="æ¸…ç†å®‰è£…"></a>æ¸…ç†å®‰è£…</h2><ul>
<li>å¦‚æœå®‰è£…è¿‡ç¨‹ä¸­å‡ºä»»ä½•é—®é¢˜ï¼Œå¯ä»¥é‡ç½®åé‡æ–°å®‰è£…</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">sudo kubeadm reset</span></div></pre></td></tr></table></figure>
<h3 id="å®‰è£…-helm-å’Œ-gitlab-runner"><a href="#å®‰è£…-helm-å’Œ-gitlab-runner" class="headerlink" title="å®‰è£… helm å’Œ gitlab-runner"></a>å®‰è£… helm å’Œ gitlab-runner</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tar -zxvf helm-v2.<span class="number">12.1</span>-linux-amd64<span class="selector-class">.tar</span><span class="selector-class">.gz</span></div><div class="line">cd linux-amd64/</div><div class="line"></div><div class="line">cp helm /usr/local/bin</div></pre></td></tr></table></figure>
<p><code>cat tiller.yaml</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> apps/v1</div><div class="line"><span class="attr">kind:</span> Deployment</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> helm</div><div class="line"><span class="attr">    name:</span> tiller</div><div class="line"><span class="attr">  name:</span> tiller-deploy</div><div class="line"><span class="attr">  namespace:</span> kube-system</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">1</span></div><div class="line"><span class="attr">  strategy:</span> &#123;&#125;</div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      name:</span> tiller</div><div class="line"><span class="attr">      app:</span> helm</div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> helm</div><div class="line"><span class="attr">        name:</span> tiller</div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      automountServiceAccountToken:</span> <span class="literal">true</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - env:</span></div><div class="line"><span class="attr">        - name:</span> TILLER_NAMESPACE</div><div class="line"><span class="attr">          value:</span> kube-system</div><div class="line"><span class="attr">        - name:</span> TILLER_HISTORY_MAX</div><div class="line"><span class="attr">          value:</span> <span class="string">"0"</span></div><div class="line"><span class="attr">        image:</span> registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2<span class="number">.14</span><span class="number">.3</span></div><div class="line"><span class="attr">        imagePullPolicy:</span> IfNotPresent</div><div class="line"><span class="attr">        livenessProbe:</span></div><div class="line"><span class="attr">          httpGet:</span></div><div class="line"><span class="attr">            path:</span> /liveness</div><div class="line"><span class="attr">            port:</span> <span class="number">44135</span></div><div class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">        name:</span> tiller</div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - containerPort:</span> <span class="number">44134</span></div><div class="line"><span class="attr">          name:</span> tiller</div><div class="line"><span class="attr">        - containerPort:</span> <span class="number">44135</span></div><div class="line"><span class="attr">          name:</span> http</div><div class="line"><span class="attr">        readinessProbe:</span></div><div class="line"><span class="attr">          httpGet:</span></div><div class="line"><span class="attr">            path:</span> /readiness</div><div class="line"><span class="attr">            port:</span> <span class="number">44135</span></div><div class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">        resources:</span> &#123;&#125;</div><div class="line"><span class="attr">      serviceAccountName:</span> tiller</div><div class="line"><span class="attr">status:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> Service</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> helm</div><div class="line"><span class="attr">    name:</span> tiller</div><div class="line"><span class="attr">  name:</span> tiller-deploy</div><div class="line"><span class="attr">  namespace:</span> kube-system</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">  - name:</span> tiller</div><div class="line"><span class="attr">    port:</span> <span class="number">44134</span></div><div class="line"><span class="attr">    targetPort:</span> tiller</div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    app:</span> helm</div><div class="line"><span class="attr">    name:</span> tiller</div><div class="line"><span class="attr">  type:</span> ClusterIP</div><div class="line"><span class="attr">status:</span></div><div class="line"><span class="attr">  loadBalancer:</span> &#123;&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">kubectl apply -<span class="keyword">f</span> tiller.yaml</div><div class="line">helm init --upgrade --stable-repo-url http<span class="variable">s:</span>//kubernetes.oss-<span class="keyword">cn</span>-hangzhou.aliyuncs.<span class="keyword">com</span>/charts</div><div class="line"></div><div class="line">#helm init -i registry.<span class="keyword">cn</span>-hangzhou.aliyuncs.<span class="keyword">com</span>/google_containers/tiller:v2.<span class="number">14.3</span> --stable-repo-url http://mirror.azure.<span class="keyword">cn</span>/kubernetes/charts/ --service-account tiller --override spec.selector.matchLabels.<span class="string">'name'</span>=<span class="string">'tiller'</span>,spec.selector.matchLabels.<span class="string">'app'</span>=<span class="string">'helm'</span> --output yaml | sed <span class="string">'s@apiVersion: extensions/v1beta1@apiVersion: apps/v1@'</span> | kubectl <span class="keyword">delete</span> -<span class="keyword">f</span> -</div><div class="line"> </div><div class="line"> kubectl create serviceaccount --namespace kube-<span class="built_in">system</span> tiller</div><div class="line"> kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-<span class="built_in">system</span>:tiller</div><div class="line"> kubectl patch deploy --namespace kube-<span class="built_in">system</span> tiller-deploy -<span class="keyword">p</span> <span class="string">'&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;'</span></div><div class="line"></div><div class="line"></div><div class="line"> kubectl <span class="built_in">get</span> <span class="keyword">po</span>  -A|<span class="keyword">grep</span> tiller</div><div class="line"> kubectl patch deploy --namespace kube-<span class="built_in">system</span> tiller-deploy -<span class="keyword">p</span> <span class="string">'&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;'</span></div><div class="line"></div><div class="line"> helm repo <span class="built_in">add</span> gitlab http<span class="variable">s:</span>//charts.gitlab.io</div><div class="line"> helm repo <span class="keyword">update</span></div><div class="line"> helm fetch gitlab/gitlab-runner --<span class="keyword">version</span> <span class="string">"v0.10.0-rc1"</span></div><div class="line"> </div><div class="line"> kubectl create namespace gitlab-runners</div><div class="line"> <span class="built_in">mkdir</span> -<span class="keyword">p</span> gitlab-runner</div><div class="line"> <span class="keyword">cd</span> gitlab-runner/</div><div class="line"> kubectl create -<span class="keyword">f</span> rbac-runner-config.yaml</div></pre></td></tr></table></figure>
<p>cat rbac-runner-config.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> ServiceAccount</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">kind:</span> Role</div><div class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">rules:</span></div><div class="line"><span class="attr">- apiGroups:</span> [<span class="string">""</span>] <span class="comment">#"" indicates the core API group</span></div><div class="line"><span class="attr">  resources:</span> [<span class="string">"*"</span>]</div><div class="line"><span class="attr">  verbs:</span> [<span class="string">"*"</span>]</div><div class="line"><span class="attr">- apiGroups:</span> [<span class="string">"apps"</span>]</div><div class="line"><span class="attr">  resources:</span> [<span class="string">"deployments"</span>]</div><div class="line"><span class="attr">  verbs:</span> [<span class="string">"*"</span>]</div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">kind:</span> RoleBinding</div><div class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">subjects:</span></div><div class="line"><span class="attr">- kind:</span> ServiceAccount</div><div class="line"><span class="attr">  name:</span> gitlab <span class="comment"># Name is case sensitive</span></div><div class="line"><span class="attr">  apiGroup:</span> <span class="string">""</span></div><div class="line"><span class="attr">roleRef:</span></div><div class="line"><span class="attr">  kind:</span> Role <span class="comment">#this must be Role or ClusterRole</span></div><div class="line"><span class="attr">  name:</span> gitlab <span class="comment"># this must match the name of the Role or ClusterRole you wish to bind to</span></div><div class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</div></pre></td></tr></table></figure>
<blockquote>
<p> <code>cat  values-spm-operation-frontend.yaml</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## GitLab Runner Image</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## By default it's using gitlab/gitlab-runner:alpine-v&#123;VERSION&#125;</span></div><div class="line"><span class="comment">## where &#123;VERSION&#125; is taken from Chart.yaml from appVersion field</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## ref: https://hub.docker.com/r/gitlab/gitlab-runner/tags/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># image: gitlab/gitlab-runner:alpine-v11.6.0</span></div><div class="line"></div><div class="line"><span class="comment">## Specify a imagePullPolicy</span></div><div class="line"><span class="comment">## 'Always' if imageTag is 'latest', else set to 'IfNotPresent'</span></div><div class="line"><span class="comment">## ref: http://kubernetes.io/docs/user-guide/images/#pre-pulling-images</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">imagePullPolicy:</span> IfNotPresent</div><div class="line"><span class="attr">gitlabUrl:</span> http://xxx.xxx.cn/</div><div class="line"><span class="attr">runnerRegistrationToken:</span> <span class="string">"-Rxxz6Cqdk33Q96mRdxk"</span></div><div class="line"></div><div class="line"><span class="comment">## å’Œä¹‹å‰é…ç½®çš„ rbac name å¯¹åº”</span></div><div class="line"></div><div class="line"><span class="comment">## æŒ‡å®šå…³è” runner çš„æ ‡ç­¾</span></div><div class="line"><span class="attr">tags:</span> <span class="string">" operations"</span></div><div class="line"></div><div class="line"><span class="attr">privileged:</span> <span class="literal">true</span></div><div class="line"><span class="attr">serviceAccountName:</span> gitlab</div><div class="line"><span class="comment">## The GitLab Server URL (with protocol) that want to register the runner against</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/commands/README.html#gitlab-runner-register</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># gitlabUrl: http://gitlab.your-domain.com/</span></div><div class="line"></div><div class="line"><span class="comment">## The Registration Token for adding new Runners to the GitLab Server. This must</span></div><div class="line"><span class="comment">## be retrieved from your GitLab Instance.</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/ce/ci/runners/README.html</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># runnerRegistrationToken: ""</span></div><div class="line"></div><div class="line"><span class="comment">## The Runner Token for adding new Runners to the GitLab Server. This must</span></div><div class="line"><span class="comment">## be retrieved from your GitLab Instance. It is token of already registered runner.</span></div><div class="line"><span class="comment">## ref: (we don't yet have docs for that, but we want to use existing token)</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># runnerToken: ""</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Unregister all runners before termination</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## Updating the runner's chart version or configuration will cause the runner container</span></div><div class="line"><span class="comment">## to be terminated and created again. This may cause your Gitlab instance to reference</span></div><div class="line"><span class="comment">## non-existant runners. Un-registering the runner before termination mitigates this issue.</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/commands/README.html#gitlab-runner-unregister</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">unregisterRunners:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">## When stopping ther runner, give it time to wait for it's jobs to terminate.</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## Updating the runner's chart version or configuration will cause the runner container</span></div><div class="line"><span class="comment">## to be terminated with a graceful stop request. terminationGracePeriodSeconds</span></div><div class="line"><span class="comment">## instructs Kubernetes to wait long enough for the runner pod to terminate gracefully.</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/commands/#signals</span></div><div class="line"><span class="attr">terminationGracePeriodSeconds:</span> <span class="number">3600</span></div><div class="line"></div><div class="line"><span class="comment">## Set the certsSecretName in order to pass custom certficates for GitLab Runner to use</span></div><div class="line"><span class="comment">## Provide resource name for a Kubernetes Secret Object in the same namespace,</span></div><div class="line"><span class="comment">## this is used to populate the /home/gitlab-runner/.gitlab-runner/certs/ directory</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># certsSecretName:</span></div><div class="line"></div><div class="line"><span class="comment">## Configure the maximum number of concurrent jobs</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">concurrent:</span> <span class="number">10</span></div><div class="line"></div><div class="line"><span class="comment">## Defines in seconds how often to check GitLab for a new builds</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">checkInterval:</span> <span class="number">30</span></div><div class="line"><span class="attr">limitLine:</span> <span class="number">100000</span></div><div class="line"><span class="comment">## Configure GitLab Runner's logging level. Available values are: debug, info, warn, error, fatal, panic</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># logLevel:</span></div><div class="line"></div><div class="line"><span class="comment">## Configure GitLab Runner's logging format. Available values are: runner, text, json</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># logFormat:</span></div><div class="line"></div><div class="line"><span class="comment">## For RBAC support:</span></div><div class="line"><span class="attr">rbac:</span></div><div class="line"><span class="attr">  create:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  serviceAccountName:</span> gitlab</div><div class="line">  <span class="comment">## Define specific rbac permissions.</span></div><div class="line">  <span class="comment"># resources: ["pods", "pods/exec", "secrets"]</span></div><div class="line">  <span class="comment"># verbs: ["get", "list", "watch", "create", "patch", "delete"]</span></div><div class="line"></div><div class="line">  <span class="comment">## Run the gitlab-bastion container with the ability to deploy/manage containers of jobs</span></div><div class="line">  <span class="comment">## cluster-wide or only within namespace</span></div><div class="line"><span class="attr">  clusterWideAccess:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">  <span class="comment">## Use the following Kubernetes Service Account name if RBAC is disabled in this Helm chart (see rbac.create)</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># serviceAccountName: default</span></div><div class="line"></div><div class="line"><span class="comment">## Configure integrated Prometheus metrics exporter</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/monitoring/#configuration-of-the-metrics-http-server</span></div><div class="line"><span class="attr">metrics:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">## Configuration for the Pods that that the runner launches for each new job</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">runners:</span></div><div class="line">  <span class="comment">## Default container image to use for builds when none is specified</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  image:</span> ubuntu:<span class="number">16.04</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify one or more imagePullSecrets</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># imagePullSecrets: []</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify the image pull policy: never, if-not-present, always. The cluster default will be used if not set.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># imagePullPolicy: ""</span></div><div class="line"></div><div class="line">  <span class="comment">## Defines number of concurrent requests for new job from GitLab</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># requestConcurrency: 1</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify whether the runner should be locked to a specific project: true, false. Defaults to true.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># locked: true</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify the tags associated with the runner. Comma-separated list of tags.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/ce/ci/runners/#using-tags</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># tags: ""</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify if jobs without tags should be run.</span></div><div class="line">  <span class="comment">## If not specified, Runner will default to true if no tags were specified. In other case it will</span></div><div class="line">  <span class="comment">## default to false.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/ce/ci/runners/#allowing-runners-with-tags-to-pick-jobs-without-tags</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># runUntagged: true</span></div><div class="line"></div><div class="line">  <span class="comment">## Run all containers with the privileged flag enabled</span></div><div class="line">  <span class="comment">## This will allow the docker:dind image to run if you need to run Docker</span></div><div class="line">  <span class="comment">## commands. Please read the docs before turning this on:</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-dind</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  privileged:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">  <span class="comment">## The name of the secret containing runner-token and runner-registration-token</span></div><div class="line">  <span class="comment"># secret: gitlab-runner</span></div><div class="line"></div><div class="line">  <span class="comment">## Namespace to run Kubernetes jobs in (defaults to the same namespace of this release)</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># namespace:</span></div><div class="line"></div><div class="line">  <span class="comment">## Distributed runners caching</span></div><div class="line">  <span class="comment">## ref: https://gitlab.com/gitlab-org/gitlab-runner/blob/master/docs/configuration/autoscale.md#distributed-runners-caching</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## If you want to use s3 based distributing caching:</span></div><div class="line">  <span class="comment">## First of all you need to uncomment General settings and S3 settings sections.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Create a secret 's3access' containing 'accesskey' &amp; 'secretkey'</span></div><div class="line">  <span class="comment">## ref: https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## $ kubectl create secret generic s3access \</span></div><div class="line">  <span class="comment">##   --from-literal=accesskey="YourAccessKey" \</span></div><div class="line">  <span class="comment">##   --from-literal=secretkey="YourSecretKey"</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/secret/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## If you want to use gcs based distributing caching:</span></div><div class="line">  <span class="comment">## First of all you need to uncomment General settings and GCS settings sections.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Access using credentials file:</span></div><div class="line">  <span class="comment">## Create a secret 'google-application-credentials' containing your application credentials file.</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnerscachegcs-section</span></div><div class="line">  <span class="comment">## You could configure</span></div><div class="line">  <span class="comment">## $ kubectl create secret generic google-application-credentials \</span></div><div class="line">  <span class="comment">##   --from-file=gcs-applicaton-credentials-file=./path-to-your-google-application-credentials-file.json</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/secret/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Access using access-id and private-key:</span></div><div class="line">  <span class="comment">## Create a secret 'gcsaccess' containing 'gcs-access-id' &amp; 'gcs-private-key'.</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-cache-gcs-section</span></div><div class="line">  <span class="comment">## You could configure</span></div><div class="line">  <span class="comment">## $ kubectl create secret generic gcsaccess \</span></div><div class="line">  <span class="comment">##   --from-literal=gcs-access-id="YourAccessID" \</span></div><div class="line">  <span class="comment">##   --from-literal=gcs-private-key="YourPrivateKey"</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/secret/</span></div><div class="line"><span class="attr">  cache:</span> &#123;&#125;</div><div class="line">    <span class="comment">## General settings</span></div><div class="line">    <span class="comment"># cacheType: s3</span></div><div class="line">    <span class="comment"># cachePath: "gitlab_runner"</span></div><div class="line">    <span class="comment"># cacheShared: true</span></div><div class="line"></div><div class="line">    <span class="comment">## S3 settings</span></div><div class="line">    <span class="comment"># s3ServerAddress: s3.amazonaws.com</span></div><div class="line">    <span class="comment"># s3BucketName:</span></div><div class="line">    <span class="comment"># s3BucketLocation:</span></div><div class="line">    <span class="comment"># s3CacheInsecure: false</span></div><div class="line">    <span class="comment"># secretName: s3access</span></div><div class="line"></div><div class="line">    <span class="comment">## GCS settings</span></div><div class="line">    <span class="comment"># gcsBucketName:</span></div><div class="line">    <span class="comment">## Use this line for access using access-id and private-key</span></div><div class="line">    <span class="comment"># secretName: gcsaccess</span></div><div class="line">    <span class="comment">## Use this line for access using google-application-credentials file</span></div><div class="line">    <span class="comment"># secretName: google-application-credentials</span></div><div class="line"></div><div class="line">  <span class="comment">## Build Container specific configuration</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  builds:</span> &#123;&#125;</div><div class="line">    <span class="comment"># cpuLimit: 200m</span></div><div class="line">    <span class="comment"># memoryLimit: 256Mi</span></div><div class="line">    <span class="comment"># cpuRequests: 100m</span></div><div class="line">    <span class="comment"># memoryRequests: 128Mi</span></div><div class="line"></div><div class="line">  <span class="comment">## Service Container specific configuration</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  services:</span> &#123;&#125;</div><div class="line">    <span class="comment"># cpuLimit: 200m</span></div><div class="line">    <span class="comment"># memoryLimit: 256Mi</span></div><div class="line">    <span class="comment"># cpuRequests: 100m</span></div><div class="line">    <span class="comment"># memoryRequests: 128Mi</span></div><div class="line"></div><div class="line">  <span class="comment">## Helper Container specific configuration</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  helpers:</span> &#123;&#125;</div><div class="line">    <span class="comment"># cpuLimit: 200m</span></div><div class="line">    <span class="comment"># memoryLimit: 256Mi</span></div><div class="line">    <span class="comment"># cpuRequests: 100m</span></div><div class="line">    <span class="comment"># memoryRequests: 128Mi</span></div><div class="line">    <span class="comment"># image: gitlab/gitlab-runner-helper:x86_64-latest</span></div><div class="line"></div><div class="line">  <span class="comment">## Service Account to be used for runners</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># serviceAccountName:</span></div><div class="line"></div><div class="line">  <span class="comment">## If Gitlab is not reachable through $CI_SERVER_URL</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># cloneUrl:</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify node labels for CI job pods assignment</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># nodeSelector: &#123;&#125;</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify pod labels for CI job pods</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># podLabels: &#123;&#125;</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify annotations for job pods, useful for annotations such as iam.amazonaws.com/role</span></div><div class="line">  <span class="comment"># podAnnotations: &#123;&#125;</span></div><div class="line"></div><div class="line">  <span class="comment">## Configure environment variables that will be injected to the pods that are created while</span></div><div class="line">  <span class="comment">## the build is running. These variables are passed as parameters, i.e. `--env "NAME=VALUE"`,</span></div><div class="line">  <span class="comment">## to `gitlab-runner register` command.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Note that `envVars` (see below) are only present in the runner pod, not the pods that are</span></div><div class="line">  <span class="comment">## created for each build.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/commands/#gitlab-runner-register</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># env:</span></div><div class="line">  <span class="comment">#   NAME: VALUE</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## Configure resource requests and limits</span></div><div class="line"><span class="comment">## ref: http://kubernetes.io/docs/user-guide/compute-resources/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">resources:</span> &#123;&#125;</div><div class="line">  <span class="comment"># limits:</span></div><div class="line">  <span class="comment">#   memory: 256Mi</span></div><div class="line">  <span class="comment">#   cpu: 200m</span></div><div class="line">  <span class="comment"># requests:</span></div><div class="line">  <span class="comment">#   memory: 128Mi</span></div><div class="line">  <span class="comment">#   cpu: 100m</span></div><div class="line"></div><div class="line"><span class="comment">## Affinity for pod assignment</span></div><div class="line"><span class="comment">## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">affinity:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">## Node labels for pod assignment</span></div><div class="line"><span class="comment">## Ref: https://kubernetes.io/docs/user-guide/node-selection/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">nodeSelector:</span> &#123;</div><div class="line"><span class="attr">  nodeType:</span> k8s</div><div class="line">&#125;</div><div class="line">  <span class="comment"># Example: The gitlab runner manager should not run on spot instances so you can assign</span></div><div class="line">  <span class="comment"># them to the regular worker nodes only.</span></div><div class="line">  <span class="comment"># node-role.kubernetes.io/worker: "true"</span></div><div class="line"></div><div class="line"><span class="comment">## List of node taints to tolerate (requires Kubernetes &gt;= 1.6)</span></div><div class="line"><span class="comment">## Ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">tolerations:</span> []</div><div class="line">  <span class="comment"># Example: Regular worker nodes may have a taint, thus you need to tolerate the taint</span></div><div class="line">  <span class="comment"># when you assign the gitlab runner manager with nodeSelector or affinity to the nodes.</span></div><div class="line">  <span class="comment"># - key: "node-role.kubernetes.io/worker"</span></div><div class="line">  <span class="comment">#   operator: "Exists"</span></div><div class="line"></div><div class="line"><span class="comment">## Configure environment variables that will be present when the registration command runs</span></div><div class="line"><span class="comment">## This provides further control over the registration process and the config.toml file</span></div><div class="line"><span class="comment">## ref: `gitlab-runner register --help`</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># envVars:</span></div><div class="line"><span class="comment">#   - name: RUNNER_EXECUTOR</span></div><div class="line"><span class="comment">#     value: kubernetes</span></div><div class="line"></div><div class="line"><span class="comment">## list of hosts and IPs that will be injected into the pod's hosts file</span></div><div class="line"><span class="attr">hostAliases:</span> []</div><div class="line">  <span class="comment"># Example:</span></div><div class="line">  <span class="comment"># - ip: "127.0.0.1"</span></div><div class="line">  <span class="comment">#   hostnames:</span></div><div class="line">  <span class="comment">#   - "foo.local"</span></div><div class="line">  <span class="comment">#   - "bar.local"</span></div><div class="line">  <span class="comment"># - ip: "10.1.2.3"</span></div><div class="line">  <span class="comment">#   hostnames:</span></div><div class="line">  <span class="comment">#   - "foo.remote"</span></div><div class="line">  <span class="comment">#   - "bar.remote"</span></div><div class="line"></div><div class="line"><span class="comment">## Annotations to be added to manager pod</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">podAnnotations:</span> &#123;&#125;</div><div class="line">  <span class="comment"># Example:</span></div><div class="line">  <span class="comment"># iam.amazonaws.com/role: &lt;my_role_arn&gt;</span></div><div class="line"></div><div class="line"><span class="comment">## HPA support for custom metrics:</span></div><div class="line"><span class="comment">## This section enables runners to autoscale based on defined custom metrics.</span></div><div class="line"><span class="comment">## In order to use this functionality, Need to enable a custom metrics API server by</span></div><div class="line"><span class="comment">## implementing "custom.metrics.k8s.io" using supported third party adapter</span></div><div class="line"><span class="comment">## Example: https://github.com/directxman12/k8s-prometheus-adapter</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">#hpa: &#123;&#125;</span></div><div class="line">  <span class="comment"># minReplicas: 1</span></div><div class="line">  <span class="comment"># maxReplicas: 10</span></div><div class="line">  <span class="comment"># metrics:</span></div><div class="line">  <span class="comment"># - type: Pods</span></div><div class="line">  <span class="comment">#   pods:</span></div><div class="line">  <span class="comment">#     metricName: gitlab_runner_jobs</span></div><div class="line">  <span class="comment">#     targetAverageValue: 400m</span></div></pre></td></tr></table></figure>
<h3 id="Helm-for-gitlab-configmap"><a href="#Helm-for-gitlab-configmap" class="headerlink" title="Helm for gitlab configmap"></a>Helm for gitlab configmap</h3><p> cat templates/configmap.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ConfigMap</div><div class="line">metadata:</div><div class="line">  name: &#123;&#123; include <span class="string">"gitlab-runner.fullname"</span> . &#125;&#125;</div><div class="line">  labels:</div><div class="line">    app: &#123;&#123; include <span class="string">"gitlab-runner.fullname"</span> . &#125;&#125;</div><div class="line">    chart: &#123;&#123; include <span class="string">"gitlab-runner.chart"</span> . &#125;&#125;</div><div class="line">    release: <span class="string">"&#123;&#123; .Release.Name &#125;&#125;"</span></div><div class="line">    heritage: <span class="string">"&#123;&#123; .Release.Service &#125;&#125;"</span></div><div class="line">data:</div><div class="line">  entrypoint: |</div><div class="line">    <span class="comment">#!/bin/bash</span></div><div class="line">    <span class="built_in">set</span> <span class="_">-e</span></div><div class="line">    mkdir -p /home/gitlab-runner/.gitlab-runner/</div><div class="line">    cp /scripts/config.toml /home/gitlab-runner/.gitlab-runner/</div><div class="line"></div><div class="line">    <span class="comment"># Register the runner</span></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/accesskey &amp;&amp; <span class="_">-f</span> /secrets/secretkey ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> CACHE_S3_ACCESS_KEY=$(cat /secrets/accesskey)</div><div class="line">      <span class="built_in">export</span> CACHE_S3_SECRET_KEY=$(cat /secrets/secretkey)</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/gcs-applicaton-credentials-file ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> GOOGLE_APPLICATION_CREDENTIALS=<span class="string">"/secrets/gcs-applicaton-credentials-file"</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">      <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/gcs-access-id &amp;&amp; <span class="_">-f</span> /secrets/gcs-private-key ]]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">export</span> CACHE_GCS_ACCESS_ID=$(cat /secrets/gcs-access-id)</div><div class="line">        <span class="comment"># echo -e used to make private key multiline (in google json auth key private key is oneline with \n)</span></div><div class="line">        <span class="built_in">export</span> CACHE_GCS_PRIVATE_KEY=$(<span class="built_in">echo</span> <span class="_">-e</span> $(cat /secrets/gcs-private-key))</div><div class="line">      <span class="keyword">fi</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/runner-registration-token ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> REGISTRATION_TOKEN=$(cat /secrets/runner-registration-token)</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/runner-token ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> CI_SERVER_TOKEN=$(cat /secrets/runner-token)</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> ! sh /scripts/register-the-runner; <span class="keyword">then</span></div><div class="line">      <span class="built_in">exit</span> 1</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF</div><div class="line">      output_limit = 100000</div><div class="line">      [[runners.kubernetes.volumes.pvc]]</div><div class="line">        name = <span class="string">"gitlab-runner-maven-repo-claim"</span></div><div class="line">        mount_path = <span class="string">"/home/cache/maven"</span></div><div class="line">      [[runners.kubernetes.volumes.host_path]]</div><div class="line">        name = <span class="string">"docker"</span></div><div class="line">        mount_path = <span class="string">"/var/run/docker.sock"</span></div><div class="line">    EOF</div><div class="line">    <span class="comment"># Start the runner</span></div><div class="line">    <span class="built_in">exec</span> /entrypoint run --user=gitlab-runner \</div><div class="line">      --working-directory=/home/gitlab-runner</div><div class="line"></div><div class="line">  config.toml: |</div><div class="line">    concurrent = &#123;&#123; .Values.concurrent &#125;&#125;</div><div class="line">    check_interval = &#123;&#123; .Values.checkInterval &#125;&#125;</div><div class="line">    log_level = &#123;&#123; default <span class="string">"info"</span> .Values.logLevel | quote &#125;&#125;</div><div class="line">    output_limit = &#123;&#123; default 10000 .Values.limitLine&#125;&#125;</div><div class="line">    &#123;&#123;- <span class="keyword">if</span> .Values.logFormat &#125;&#125;</div><div class="line">    log_format = &#123;&#123; .Values.logFormat | quote &#125;&#125;</div><div class="line">    &#123;&#123;- end &#125;&#125;</div><div class="line">    &#123;&#123;- <span class="keyword">if</span> .Values.metrics.enabled &#125;&#125;</div><div class="line">    listen_address = <span class="string">'[::]:9252'</span></div><div class="line">    &#123;&#123;- end &#125;&#125;</div><div class="line">  configure: |</div><div class="line">    <span class="built_in">set</span> <span class="_">-e</span></div><div class="line">    cp /init-secrets/* /secrets</div><div class="line">  register-the-runner: |</div><div class="line">    <span class="comment">#!/bin/bash</span></div><div class="line">    MAX_REGISTER_ATTEMPTS=30</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> $(seq 1 <span class="string">"<span class="variable">$&#123;MAX_REGISTER_ATTEMPTS&#125;</span>"</span>); <span class="keyword">do</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"Registration attempt <span class="variable">$&#123;i&#125;</span> of <span class="variable">$&#123;MAX_REGISTER_ATTEMPTS&#125;</span>"</span></div><div class="line">      /entrypoint register \</div><div class="line">        &#123;&#123;- range .Values.runners.imagePullSecrets &#125;&#125;</div><div class="line">        --kubernetes-image-pull-secrets &#123;&#123; . | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$val</span> := .Values.runners.nodeSelector &#125;&#125;</div><div class="line">        --kubernetes-node-selector &#123;&#123; <span class="variable">$key</span> | quote &#125;&#125;:&#123;&#123; <span class="variable">$val</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$value</span> := .Values.runners.podLabels &#125;&#125;</div><div class="line">        --kubernetes-pod-labels &#123;&#123; <span class="variable">$key</span> | quote &#125;&#125;:&#123;&#123; <span class="variable">$value</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$val</span> := .Values.runners.podAnnotations &#125;&#125;</div><div class="line">        --kubernetes-pod-annotations &#123;&#123; <span class="variable">$key</span> | quote &#125;&#125;:&#123;&#123; <span class="variable">$val</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$value</span> := .Values.runners.env &#125;&#125;</div><div class="line">        --env &#123;&#123; <span class="variable">$key</span> | quote -&#125;&#125; = &#123;&#123;- <span class="variable">$value</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- <span class="keyword">if</span> and (hasKey .Values.runners <span class="string">"runUntagged"</span>) .Values.runners.runUntagged &#125;&#125;</div><div class="line">        --run-untagged=<span class="literal">true</span> \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        --non-interactive</div><div class="line"></div><div class="line">      retval=$?</div><div class="line"></div><div class="line">      <span class="keyword">if</span> [ <span class="variable">$&#123;retval&#125;</span> = 0 ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">break</span></div><div class="line">      <span class="keyword">elif</span> [ <span class="variable">$&#123;i&#125;</span> = <span class="variable">$&#123;MAX_REGISTER_ATTEMPTS&#125;</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line">      <span class="keyword">fi</span></div><div class="line"></div><div class="line">      sleep 5</div><div class="line">    <span class="keyword">done</span></div><div class="line"></div><div class="line">    <span class="built_in">exit</span> 0</div><div class="line"></div><div class="line">  check-live: |</div><div class="line">    <span class="comment">#!/bin/bash</span></div><div class="line">    <span class="keyword">if</span> /usr/bin/pgrep <span class="_">-f</span> .*register-the-runner; <span class="keyword">then</span></div><div class="line">      <span class="built_in">exit</span> 0</div><div class="line">    <span class="keyword">elif</span> /usr/bin/pgrep gitlab.*runner; <span class="keyword">then</span></div><div class="line">      <span class="built_in">exit</span> 0</div><div class="line">    <span class="keyword">else</span></div><div class="line">      <span class="built_in">exit</span> 1</div><div class="line">    <span class="keyword">fi</span></div></pre></td></tr></table></figure>
<h3 id="gitlab-runner"><a href="#gitlab-runner" class="headerlink" title="gitlab-runner"></a>gitlab-runner</h3><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="string">helm </span><span class="string">install </span><span class="built_in">--name</span> <span class="string">xxx </span><span class="string">gitlab/</span><span class="string">gitlab-runner </span>-f <span class="string">values-spm-</span><span class="string">labour.</span><span class="string">yaml </span> <span class="built_in">--namespace</span> <span class="string">gitlab-runners </span><span class="built_in">--version</span> <span class="string">"v0.10.0-rc1"</span></div><div class="line"><span class="string">helm </span><span class="string">upgrade </span><span class="string">xxx </span>./<span class="string">gitlab-runner/</span></div></pre></td></tr></table></figure>
<h3 id="åˆ›å»ºrunner-maven-ç¼“å­˜"><a href="#åˆ›å»ºrunner-maven-ç¼“å­˜" class="headerlink" title="åˆ›å»ºrunner maven ç¼“å­˜"></a>åˆ›å»ºrunner maven ç¼“å­˜</h3><blockquote>
<p>Java éœ€è¦</p>
</blockquote>
<p>cat maven-nfs.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> PersistentVolume</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab-runner-maven-repo</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span>Gi</div><div class="line"><span class="attr">  mountOptions:</span></div><div class="line"><span class="bullet">  -</span> nolock</div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> /data/nfs/volumes</div><div class="line"><span class="attr">    server:</span> YOURIPADDRESS</div><div class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> Recycle</div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> PersistentVolumeClaim</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab-runner-maven-repo-claim</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">  resources:</span></div><div class="line"><span class="attr">    requests:</span></div><div class="line"><span class="attr">      storage:</span> <span class="number">5</span>Gi</div><div class="line"><span class="attr">  volumeName:</span> gitlab-runner-maven-repo</div><div class="line"><span class="attr">status:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span>Gi</div></pre></td></tr></table></figure>
<h4 id="ç”Ÿæˆmavenç¼“å­˜PVC"><a href="#ç”Ÿæˆmavenç¼“å­˜PVC" class="headerlink" title="ç”Ÿæˆmavenç¼“å­˜PVC"></a>ç”Ÿæˆmavenç¼“å­˜PVC</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> PersistentVolumeClaim</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab-runner-maven-repo-claim</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">    resources:</span></div><div class="line"><span class="attr">    requests:</span></div><div class="line"><span class="attr">      storage:</span> <span class="number">5</span>Gi</div><div class="line"><span class="attr">    volumeName:</span> gitlab-runner-maven-repo</div><div class="line"><span class="attr">status:</span></div><div class="line"><span class="attr">    accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">    capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span>Gi</div></pre></td></tr></table></figure>
<h4 id="ä»£ç åŠé•œåƒä¸Šä¼ "><a href="#ä»£ç åŠé•œåƒä¸Šä¼ " class="headerlink" title="ä»£ç åŠé•œåƒä¸Šä¼ "></a>ä»£ç åŠé•œåƒä¸Šä¼ </h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">##å¦‚æœåˆ é™¤</div><div class="line">helm del --purge spm-labour</div><div class="line"></div><div class="line">##ç”Ÿæˆgitlab namespace</div><div class="line">kubectl create ns gitlab</div><div class="line">### ä»£ç é•œåƒä¸Šä¼ å¯†é’¥</div><div class="line">kubectl create secret docker-registry  huawei-auth --docker-server=XXX.myhuaweicloud.com --docker-username=XXX --docker-password=XXXX -ngitlab</div><div class="line">###kubectl create secret docker-registry  aliyun-auth --docker-server=registry.cn-zhangjiakou.aliyuncs.com --docker-username=xxx --docker-password=xxx -ngitlab</div></pre></td></tr></table></figure>
<h5 id="å…¶å®ƒåŠé‡åˆ°çš„å‘"><a href="#å…¶å®ƒåŠé‡åˆ°çš„å‘" class="headerlink" title="å…¶å®ƒåŠé‡åˆ°çš„å‘"></a>å…¶å®ƒåŠé‡åˆ°çš„å‘</h5><blockquote>
<p>GitLabé›†æˆk8s ç­¾åé”™è¯¯</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl get secrets</div><div class="line">kubectl get secret default-token-52xsf  -o jsonpath="&#123;[<span class="string">'data'</span>][<span class="symbol">'ca\.crt'</span>]&#125;" | base64 --decode</div></pre></td></tr></table></figure>
<blockquote>
<p>cat gitlab-admin-service-account.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> ServiceAccount</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab</div><div class="line"></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</div><div class="line"><span class="attr">kind:</span> ClusterRoleBinding</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab</div><div class="line"><span class="attr">subjects:</span></div><div class="line"><span class="attr">  - kind:</span> ServiceAccount</div><div class="line"><span class="attr">    name:</span> gitlab</div><div class="line"><span class="attr">    namespace:</span> gitlab</div><div class="line"><span class="attr">roleRef:</span></div><div class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</div><div class="line"><span class="attr">  kind:</span> ClusterRole</div><div class="line"><span class="attr">  name:</span> cluster-admin</div></pre></td></tr></table></figure>
<blockquote>
<p>è·å– Service Token</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl -n gitlab  describe secret $(kubectl -n gitlab get secret <span class="params">| grep gitlab|</span> awk <span class="string">'&#123;print $1&#125;'</span>)</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;a href=&quot;#å‡†å¤‡å·¥ä½œ&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;/a&gt;å‡†å¤‡å·¥ä½œ&lt;/h3&gt;&lt;h4 id=&quot;1-å®‰è£…å¿…å¤‡è½¯ä»¶&quot;&gt;&lt;a href=&quot;#1-å®‰è£…å¿…å¤‡è½¯ä»¶&quot; class=&quot;headerlink&quot; title=&quot;1
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>è®°k8såœ¨å…¬ç½‘éƒ¨ç½²</title>
    <link href="http://peterfei.me/2020/10/29/%E8%AE%B0k8s%E5%9C%A8%E5%85%AC%E7%BD%91%E9%83%A8%E7%BD%B2/"/>
    <id>http://peterfei.me/2020/10/29/è®°k8såœ¨å…¬ç½‘éƒ¨ç½²/</id>
    <published>2020-10-29T02:26:59.000Z</published>
    <updated>2022-08-26T02:42:20.318Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><h3 id="1-å®‰è£…å¿…å¤‡è½¯ä»¶"><a href="#1-å®‰è£…å¿…å¤‡è½¯ä»¶" class="headerlink" title="1. å®‰è£…å¿…å¤‡è½¯ä»¶"></a>1. å®‰è£…å¿…å¤‡è½¯ä»¶</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y wget vim net-tools epel-<span class="keyword">release</span></div></pre></td></tr></table></figure>
<h3 id="2-å…³é—­swap"><a href="#2-å…³é—­swap" class="headerlink" title="2. å…³é—­swap"></a>2. å…³é—­swap</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">swapoff -a</div><div class="line"></div><div class="line"><span class="comment"># æ°¸ä¹…ç¦ç”¨ï¼Œæ‰“å¼€/etc/fstabæ³¨é‡Šæ‰swapé‚£ä¸€è¡Œã€‚</span></div><div class="line">sed -i <span class="string">'s/.*swap.*/#&amp;/'</span> <span class="regexp">/etc/</span>fstab</div></pre></td></tr></table></figure>
<h3 id="3-å…³é—­selinux"><a href="#3-å…³é—­selinux" class="headerlink" title="3. å…³é—­selinux"></a>3. å…³é—­selinux</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># ä¸´æ—¶ç¦ç”¨selinux</span></div><div class="line">setenforce <span class="number">0</span></div><div class="line"><span class="meta"># æ°¸ä¹…å…³é—­ ä¿®æ”¹/etc/sysconfig/selinuxæ–‡ä»¶è®¾ç½®</span></div><div class="line">sed -i <span class="string">'s/SELINUX=permissive/SELINUX=disabled/'</span> /etc/sysconfig/selinux</div><div class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</div></pre></td></tr></table></figure>
<h3 id="4-å…³é—­é˜²ç«å¢™"><a href="#4-å…³é—­é˜²ç«å¢™" class="headerlink" title="4. å…³é—­é˜²ç«å¢™"></a>4. å…³é—­é˜²ç«å¢™</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl <span class="keyword">disable</span> firewalld</div><div class="line">systemctl <span class="keyword">stop</span> firewalld</div></pre></td></tr></table></figure>
<h2 id="å®‰è£…Dockerå’Œé…ç½®ä»£ç†"><a href="#å®‰è£…Dockerå’Œé…ç½®ä»£ç†" class="headerlink" title="å®‰è£…Dockerå’Œé…ç½®ä»£ç†"></a>å®‰è£…Dockerå’Œé…ç½®ä»£ç†</h2><h3 id="1-é…ç½®yumæº"><a href="#1-é…ç½®yumæº" class="headerlink" title="1. é…ç½®yumæº"></a>1. é…ç½®yumæº</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">## é…ç½®é»˜è®¤æº</div><div class="line">## å¤‡ä»½</div><div class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</div><div class="line"></div><div class="line">## ä¸‹è½½é˜¿é‡Œæº</div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http:<span class="comment">//mirrors.aliyun.com/repo/Centos-7.repo</span></div><div class="line"></div><div class="line">## åˆ·æ–°</div><div class="line">yum makecache fast</div><div class="line"></div><div class="line">## é…ç½®k8sæº</div><div class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</div><div class="line">[kubernetes]</div><div class="line">name=Kubernetes</div><div class="line">baseurl=https:<span class="comment">//mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></div><div class="line">enabled=<span class="number">1</span></div><div class="line">gpgcheck=<span class="number">0</span></div><div class="line">EOF</div><div class="line"></div><div class="line">## é‡å»ºyumç¼“å­˜</div><div class="line">yum clean all</div><div class="line">yum makecache fast</div><div class="line">yum -y update</div></pre></td></tr></table></figure>
<h3 id="2-å®‰è£…docker"><a href="#2-å®‰è£…docker" class="headerlink" title="2. å®‰è£…docker"></a>2. å®‰è£…docker</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">yum -y <span class="keyword">install</span> yum-utils device-mapper-persistent-<span class="keyword">data</span> lvm2</div><div class="line">yum-config-manager <span class="comment">--add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></div><div class="line">yum -y <span class="keyword">install</span> docker-ce</div><div class="line">systemctl <span class="keyword">enable</span> docker</div><div class="line">systemctl <span class="keyword">start</span> docker</div></pre></td></tr></table></figure>
<h3 id="3-ç¡®ä¿kubeletä½¿ç”¨çš„cgroup-driver-ä¸-Dockerçš„ä¸€è‡´"><a href="#3-ç¡®ä¿kubeletä½¿ç”¨çš„cgroup-driver-ä¸-Dockerçš„ä¸€è‡´" class="headerlink" title="3. ç¡®ä¿kubeletä½¿ç”¨çš„cgroup driver ä¸ Dockerçš„ä¸€è‡´"></a>3. ç¡®ä¿kubeletä½¿ç”¨çš„cgroup driver ä¸ Dockerçš„ä¸€è‡´</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;<span class="built_in">EOF</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</div><div class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</div><div class="line">  <span class="string">"log-opts"</span>: &#123;</div><div class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>,</div><div class="line">  <span class="string">"storage-opts"</span>: [</div><div class="line">    <span class="string">"overlay2.override_kernel_check=true"</span></div><div class="line">  ]</div><div class="line">&#125;</div><div class="line"><span class="built_in">EOF</span></div><div class="line"></div><div class="line">sudo systemctl daemon-reload sudo systemctl restart docker</div></pre></td></tr></table></figure>
<h3 id="4-è®¾ç½®dockerä»£ç†ï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæœ‰ä»£ç†ï¼‰"><a href="#4-è®¾ç½®dockerä»£ç†ï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæœ‰ä»£ç†ï¼‰" class="headerlink" title="4. è®¾ç½®dockerä»£ç†ï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæœ‰ä»£ç†ï¼‰"></a>4. è®¾ç½®dockerä»£ç†ï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæœ‰ä»£ç†ï¼‰</h3><blockquote>
<p>æ²¡æœ‰ä»£ç†æ‰§è¡Œæ­¥éª¤5</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mkdir /etc/systemd/system/docker<span class="selector-class">.service</span><span class="selector-class">.d</span></div><div class="line">touch /etc/systemd/system/docker<span class="selector-class">.service</span><span class="selector-class">.d</span>/http-proxy<span class="selector-class">.conf</span></div><div class="line"></div><div class="line">[Service]</div><div class="line">Environment=<span class="string">"HTTP_PROXY=http://xxx"</span></div><div class="line">Environment=<span class="string">"HTTPS_PROXY=http://xxx"</span></div><div class="line">Environment=<span class="string">"NO_PROXY=localhost,127.0.0.1,localaddress,.localdomain.com"</span></div><div class="line"></div><div class="line">systemctl daemon-reload &amp;&amp; systemctl restart docker</div></pre></td></tr></table></figure>
<h3 id="5-ä»å›½å†…ä»“åº“æ‹‰å–é•œåƒï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæ²¡æœ‰ä»£ç†ï¼‰"><a href="#5-ä»å›½å†…ä»“åº“æ‹‰å–é•œåƒï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæ²¡æœ‰ä»£ç†ï¼‰" class="headerlink" title="5. ä»å›½å†…ä»“åº“æ‹‰å–é•œåƒï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæ²¡æœ‰ä»£ç†ï¼‰"></a>5. ä»å›½å†…ä»“åº“æ‹‰å–é•œåƒï¼ˆæ ¸å¿ƒæ­¥éª¤-å¦‚æœæ²¡æœ‰ä»£ç†ï¼‰</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## æŸ¥çœ‹é›†ç¾¤åˆå§‹åŒ–æ‰€éœ€é•œåƒåŠå¯¹åº”ä¾èµ–ç‰ˆæœ¬å·ï¼Œåˆ—å‡ºçš„å°±æ˜¯éœ€è¦ä¸‹è½½çš„é•œåƒ</span></div><div class="line">kubeadm config images <span class="built_in">list</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">images=(</div><div class="line">kube-apiserver:v1.18.0</div><div class="line">kube-controller-manager:v1.18.0</div><div class="line">kube-scheduler:v1.18.0</div><div class="line">kube-proxy:v1.18.0</div><div class="line">pause:3.2</div><div class="line">etcd:3.4.3-0</div><div class="line">coredns:1.6.7</div><div class="line">kubernetes-dashboard-amd64:v1.10.1</div><div class="line">)</div><div class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span>;<span class="keyword">do</span></div><div class="line">        docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></div><div class="line">        docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<h2 id="å¼€å§‹å®‰è£…k8s"><a href="#å¼€å§‹å®‰è£…k8s" class="headerlink" title="å¼€å§‹å®‰è£…k8s"></a>å¼€å§‹å®‰è£…k8s</h2><h3 id="1-å®‰è£…kubeadmï¼Œkubeletç­‰"><a href="#1-å®‰è£…kubeadmï¼Œkubeletç­‰" class="headerlink" title="1. å®‰è£…kubeadmï¼Œkubeletç­‰"></a>1. å®‰è£…kubeadmï¼Œkubeletç­‰</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum -y <span class="keyword">install</span> kubelet kubeadm kubectl kubernetes-cni</div><div class="line">systemctl <span class="keyword">enable</span> kubelet &amp;&amp; systemctl <span class="keyword">start</span> kubelet</div></pre></td></tr></table></figure>
<h3 id="2-é›†ç¾¤åˆå§‹åŒ–"><a href="#2-é›†ç¾¤åˆå§‹åŒ–" class="headerlink" title="2. é›†ç¾¤åˆå§‹åŒ–"></a>2. é›†ç¾¤åˆå§‹åŒ–</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">## masterèŠ‚ç‚¹æ‰§è¡Œï¼š</div><div class="line">sudo kubeadm init \</div><div class="line"> --apiserver-advertise-address <span class="number">10.1</span><span class="number">.69</span><span class="number">.101</span> \</div><div class="line"> --kubernetes-version=v1<span class="number">.15</span><span class="number">.0</span> \</div><div class="line"> --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></div></pre></td></tr></table></figure>
<blockquote>
<p>å…¬ç½‘ä¼šå¡åœ¨:</p>
</blockquote>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[wait-control-plane] Waiting <span class="keyword">for</span> the kubelet <span class="keyword">to</span> boot up the control plane <span class="keyword">as</span> <span class="keyword">static</span> Pods <span class="keyword">from</span> directory <span class="string">"/etc/kubernetes/manifests"</span>. This can <span class="keyword">take</span> up <span class="keyword">to</span> <span class="number">4</span>m0s</div><div class="line">[kubelet-check] Initial timeout <span class="keyword">of</span> <span class="number">40</span>s passed.</div></pre></td></tr></table></figure>
<h2 id="ä¿®æ”¹etcd-yaml"><a href="#ä¿®æ”¹etcd-yaml" class="headerlink" title="ä¿®æ”¹etcd.yaml"></a>ä¿®æ”¹etcd.yaml</h2><blockquote>
<p>æ–‡ä»¶è·¯å¾„â€/etc/kubernetes/manifests/etcd.yamlâ€</p>
</blockquote>
<h5 id="ä¿®æ”¹å‰"><a href="#ä¿®æ”¹å‰" class="headerlink" title="ä¿®æ”¹å‰"></a>ä¿®æ”¹å‰</h5><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g90yzxelfhj30m00f8ac2.jpg" alt=""></p>
<h5 id="ä¿®æ”¹å"><a href="#ä¿®æ”¹å" class="headerlink" title="ä¿®æ”¹å"></a>ä¿®æ”¹å</h5><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g90z0cev0kj30m00f8dhs.jpg" alt=""></p>
<blockquote>
<p>æ­¤å¤„â€xxxâ€ä¸ºå…¬ç½‘ipï¼Œè¦å…³æ³¨çš„æ˜¯â€â€“listen-client-urlsâ€å’Œâ€â€“listen-peer-urlsâ€ã€‚éœ€è¦æŠŠâ€“listen-client-urls å’Œ â€“listen-peer-urls éƒ½æ”¹æˆ0.0.0.0ï¼šxxx</p>
</blockquote>
<p><a href="https://my.oschina.net/u/4389078/blog/3233116" target="_blank" rel="external">æ¥æº</a></p>
<p>å¾—åˆ°å›å¤ï¼š</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">(...çœç•¥)</div><div class="line"><span class="keyword">mkdir</span> -p <span class="variable">$HOME</span>/.kube</div><div class="line">sudo cp -i /etc/kubernetes/admin.<span class="keyword">conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -<span class="keyword">u</span>):$(id -<span class="keyword">g</span>) <span class="variable">$HOME</span>/.kube/config</div><div class="line"></div><div class="line">## ä¿å­˜å¥½è¯¥å‘½ä»¤ï¼Œä¸¢äº†ä¸å¥½æ‰¾å›ã€‚èŠ‚ç‚¹åŠ å…¥æ—¶éœ€è¦</div><div class="line">kubeadm join 10.1.69.101:6443 --<span class="keyword">token</span> ou5pvo.qseafc4s8licblzy \</div><div class="line">    --discovery-<span class="keyword">token</span>-<span class="keyword">ca</span>-cert-hash sha256:de9c10f11c50c074f212698b9d514fc12a9c1c4ffe70961aff89ac5e585f0663</div></pre></td></tr></table></figure>
<h3 id="3-æ‹·è´é…ç½®ï¼Œç»™kubectlä½¿ç”¨"><a href="#3-æ‹·è´é…ç½®ï¼Œç»™kubectlä½¿ç”¨" class="headerlink" title="3. æ‹·è´é…ç½®ï¼Œç»™kubectlä½¿ç”¨"></a>3. æ‹·è´é…ç½®ï¼Œç»™kubectlä½¿ç”¨</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir -<span class="selector-tag">p</span> <span class="variable">$HOME</span>/<span class="selector-class">.kube</span></div><div class="line">sudo cp -<span class="selector-tag">i</span> /etc/kubernetes/admin<span class="selector-class">.conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</div></pre></td></tr></table></figure>
<h3 id="4-å®‰è£…flannelç½‘ç»œ"><a href="#4-å®‰è£…flannelç½‘ç»œ" class="headerlink" title="4. å®‰è£…flannelç½‘ç»œ"></a>4. å®‰è£…flannelç½‘ç»œ</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo kubectl apply -<span class="keyword">f</span> http<span class="variable">s:</span>//raw.githubusercontent.<span class="keyword">com</span>/coreos/flannel/master/Documentation/kube-flannel.yml</div><div class="line"></div><div class="line">## æŸ¥çœ‹flannalæ˜¯å¦å®‰è£…æˆåŠŸ</div><div class="line"></div><div class="line">sudo kubectl -n kube-<span class="built_in">system</span> <span class="built_in">get</span> <span class="keyword">po</span> -<span class="keyword">l</span> app=flannel -<span class="keyword">o</span> wide</div></pre></td></tr></table></figure>
<h2 id="5-nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤"><a href="#5-nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤" class="headerlink" title="5. nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤"></a>5. nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h2><p>å…¶ä»–èŠ‚ç‚¹æ‰§è¡Œï¼š</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">kubeadm</span> <span class="selector-tag">join</span> 39<span class="selector-class">.99</span><span class="selector-class">.xxx</span><span class="selector-class">.xxx</span><span class="selector-pseudo">:6443</span>   <span class="selector-tag">--token</span> <span class="selector-tag">w4tx2r</span><span class="selector-class">.0dm194h24wlw8m8t</span> <span class="selector-tag">--discovery-token-ca-cert-hash</span> <span class="selector-tag">sha256</span><span class="selector-pseudo">:caae3b178b4172839269254f373b6eaa14514173b01e129e0b0fe7d64694dc39</span></div></pre></td></tr></table></figure>
<h2 id="æ¸…ç†å®‰è£…"><a href="#æ¸…ç†å®‰è£…" class="headerlink" title="æ¸…ç†å®‰è£…"></a>æ¸…ç†å®‰è£…</h2><blockquote>
<p> å¦‚æœå®‰è£…è¿‡ç¨‹ä¸­å‡ºä»»ä½•é—®é¢˜ï¼Œå¯ä»¥é‡ç½®åé‡æ–°å®‰è£…</p>
</blockquote>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">sudo kubeadm reset</span></div></pre></td></tr></table></figure>
<h1 id="Dashboardå®‰è£…"><a href="#Dashboardå®‰è£…" class="headerlink" title="Dashboardå®‰è£…"></a>Dashboardå®‰è£…</h1><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å®‰è£…dashboardï¼Œå›½å†…å¯ä»¥ä½¿ç”¨åˆ«çš„yamlæº</span></div><div class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.<span class="number">10.1</span>/src/deploy/recommended/kubernetes-dashboard.yaml</div><div class="line"></div><div class="line"><span class="comment"># ä¿®æ”¹nodeä¸ºNodePortæ¨¡å¼</span></div><div class="line">kubectl patch svc -n kube-system kubernetes-dashboard -p '&#123;<span class="string">"spec"</span>:&#123;<span class="string">"type"</span>:<span class="string">"NodePort"</span>&#125;&#125;'</div><div class="line"></div><div class="line"><span class="comment"># æŸ¥çœ‹æœåŠ¡(å¾—çŸ¥dashboardè¿è¡Œåœ¨443:32383/TCPç«¯å£)</span></div><div class="line">kubectl get svc -n kube-system </div><div class="line"><span class="comment"># --- è¾“å‡º ---</span></div><div class="line">NAME                   <span class="keyword">TYPE</span>        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE</div><div class="line">kube-dns               ClusterIP   <span class="number">10.96</span>.<span class="number">0.10</span>      <span class="tag">&lt;none&gt;</span>        <span class="number">53</span>/UDP,<span class="number">53</span>/TCP,<span class="number">9153</span>/TCP   <span class="number">7h</span>40m</div><div class="line">kubernetes-dashboard   NodePort    <span class="number">10.111</span>.<span class="number">77.210</span>   <span class="tag">&lt;none&gt;</span>        <span class="number">443</span>:<span class="number">32383</span>/TCP            <span class="number">3h</span>42m</div><div class="line"><span class="comment"># --- è¾“å‡º ---</span></div><div class="line"></div><div class="line"><span class="comment"># æŸ¥çœ‹dashboardè¿è¡Œåœ¨å“ªä¸ªnode(å¾—çŸ¥dashboardè¿è¡Œåœ¨192.168.20.4)</span></div><div class="line">kubectl get pods -A -o wide</div><div class="line"><span class="comment"># --- è¾“å‡º ---</span></div><div class="line">NAMESPACE     NAME                                    READY   STATUS    RESTARTS   AGE     IP             <span class="keyword">NODE</span>     <span class="title">NOMINATED</span> <span class="keyword">NODE</span>   <span class="title">READINESS</span> GATES</div><div class="line">kube-system   coredns-fb8b8dccf-rn8kd                 <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>43m   <span class="number">10.244</span>.<span class="number">0.2</span>     <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   coredns-fb8b8dccf-slwr4                 <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>43m   <span class="number">10.244</span>.<span class="number">0.3</span>     <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   etcd-<span class="keyword">master</span>                             <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-apiserver-<span class="keyword">master</span>                   <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-controller-manager-<span class="keyword">master</span>          <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-flannel-ds-amd64-l8c7c             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>3m    <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-flannel-ds-amd64-lcmxw             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">6h</span>50m   <span class="number">192.168</span>.<span class="number">20.4</span>   node1    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-flannel-ds-amd64-pqnln             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">6h</span>5m    <span class="number">192.168</span>.<span class="number">20.3</span>   node2    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-proxy-<span class="number">4</span>kcqb                        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>43m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-proxy-jcqjd                        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">6h</span>5m    <span class="number">192.168</span>.<span class="number">20.3</span>   node2    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-proxy-vm9sj                        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">6h</span>50m   <span class="number">192.168</span>.<span class="number">20.4</span>   node1    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-scheduler-<span class="keyword">master</span>                   <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kubernetes-dashboard-<span class="number">5</span>f7b999d65-<span class="number">2</span>ltmv   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3h</span>45m   <span class="number">10.244</span>.<span class="number">1.2</span>     node1    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line"><span class="comment"># --- è¾“å‡º ---</span></div><div class="line"><span class="comment"># å¦‚æœæ— æ³•å˜æˆRunningçŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ’é”™</span></div><div class="line">journalctl -f -u kubelet  <span class="comment"># åªçœ‹å½“å‰çš„kubeletè¿›ç¨‹æ—¥å¿—</span></div><div class="line"><span class="comment">### æç¤ºæ‹‰å–é•œåƒå¤±è´¥ï¼Œæ— æ³•ç¿»å¢™çš„å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•é¢„å…ˆæ‹‰å–é•œåƒ</span></div><div class="line"><span class="comment">### è¯·åœ¨kubernetes-dashboardçš„èŠ‚ç‚¹ä¸Šæ“ä½œï¼š</span></div><div class="line">docker pull mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span></div><div class="line">docker <span class="keyword">tag</span> <span class="title">mirrorgooglecontainers</span>/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span> k8s.gcr.io/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span></div><div class="line">docker rmi  mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span></div></pre></td></tr></table></figure>
<p>è·å–tokenå‘½ä»¤</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## è·å–ç™»é™†ç•Œé¢token</span></div><div class="line">kubectl -n kube-<span class="keyword">system</span> describe $(kubectl -n kube-<span class="keyword">system</span> \</div><div class="line"><span class="built_in">get</span> secret -n kube-<span class="keyword">system</span> -o name | grep namespace) | grep <span class="keyword">token</span></div></pre></td></tr></table></figure>
<p>å¦‚æœdashboardçš„tokenè¿‡æœŸï¼Œä»¥ä¸‹è„šæœ¬é‡æ–°ç”Ÿæˆconfigæ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">TOKEN=$(kubectl -n kube-system describe secret default| awk <span class="string">'$1=="token:"&#123;print $2&#125;'</span>)</div><div class="line">kubectl config <span class="built_in">set</span>-credentials kubernetes-admin --token=<span class="string">"<span class="variable">$&#123;TOKEN&#125;</span>"</span></div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;a href=&quot;#å‡†å¤‡å·¥ä½œ&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;/a&gt;å‡†å¤‡å·¥ä½œ&lt;/h2&gt;&lt;h3 id=&quot;1-å®‰è£…å¿…å¤‡è½¯ä»¶&quot;&gt;&lt;a href=&quot;#1-å®‰è£…å¿…å¤‡è½¯ä»¶&quot; class=&quot;headerlink&quot; title=&quot;1
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ç¼–å†™Dockerfile</title>
    <link href="http://peterfei.me/2019/04/18/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99Dockerfile/"/>
    <id>http://peterfei.me/2019/04/18/å¦‚ä½•ç¼–å†™Dockerfile/</id>
    <published>2019-04-18T05:59:18.000Z</published>
    <updated>2022-08-26T02:42:20.316Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><p>å‡è®¾æˆ‘ä»¬éœ€è¦ä½¿ç”¨Dockerè¿è¡Œä¸€ä¸ªNode.jsåº”ç”¨</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get upgrade -y  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nodejs ssh mysql  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> mysql &amp; sshd &amp; npm start</span></div></pre></td></tr></table></figure>
<p>æ„å»ºé•œåƒ:</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-t mydocker .</div></pre></td></tr></table></figure>
<h4 id="ç¼–å†™-dockerignoreæ–‡ä»¶"><a href="#ç¼–å†™-dockerignoreæ–‡ä»¶" class="headerlink" title="ç¼–å†™.dockerignoreæ–‡ä»¶"></a>ç¼–å†™.dockerignoreæ–‡ä»¶</h4><p>æ„å»ºé•œåƒæ—¶ï¼ŒDockeréœ€è¦å…ˆå‡†å¤‡context ï¼Œå°†æ‰€æœ‰éœ€è¦çš„æ–‡ä»¶æ”¶é›†åˆ°è¿›ç¨‹ä¸­ã€‚é»˜è®¤çš„contextåŒ…å«Dockerfileç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦.gitç›®å½•ï¼Œnode_modulesç›®å½•ç­‰å†…å®¹ã€‚ .dockerignore çš„ä½œç”¨å’Œè¯­æ³•ç±»ä¼¼äº .gitignoreï¼Œå¯ä»¥å¿½ç•¥ä¸€äº›ä¸éœ€è¦çš„æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆåŠ å¿«é•œåƒæ„å»ºæ—¶é—´ï¼ŒåŒæ—¶å‡å°‘Dockeré•œåƒçš„å¤§å°ã€‚ç¤ºä¾‹å¦‚ä¸‹:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="title">.git/</span></div><div class="line">node<span class="emphasis">_modules/</span></div></pre></td></tr></table></figure>
<h4 id="å®¹å™¨åªè¿è¡Œå•ä¸ªåº”ç”¨"><a href="#å®¹å™¨åªè¿è¡Œå•ä¸ªåº”ç”¨" class="headerlink" title="å®¹å™¨åªè¿è¡Œå•ä¸ªåº”ç”¨"></a>å®¹å™¨åªè¿è¡Œå•ä¸ªåº”ç”¨</h4><p>ä»æŠ€æœ¯è§’åº¦è®²ï¼Œä½ å¯ä»¥åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œå¤šä¸ªè¿›ç¨‹ã€‚ä½ å¯ä»¥å°†æ•°æ®åº“ï¼Œå‰ç«¯ï¼Œåç«¯ï¼Œsshï¼Œsupervisoréƒ½è¿è¡Œåœ¨åŒä¸€ä¸ªDockerå®¹å™¨ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™ä¼šè®©ä½ éå¸¸ç—›è‹¦:</p>
<ul>
<li>éå¸¸é•¿çš„æ„å»ºæ—¶é—´(ä¿®æ”¹å‰ç«¯ä¹‹åï¼Œæ•´ä¸ªåç«¯ä¹Ÿéœ€è¦é‡æ–°æ„å»º)</li>
<li>éå¸¸å¤§çš„é•œåƒå¤§å°</li>
<li>å¤šä¸ªåº”ç”¨çš„æ—¥å¿—éš¾ä»¥å¤„ç†</li>
<li>æ¨ªå‘æ‰©å±•æ—¶éå¸¸æµªè´¹èµ„æº(ä¸åŒçš„åº”ç”¨éœ€è¦è¿è¡Œçš„å®¹å™¨æ•°å¹¶ä¸ç›¸åŒ)</li>
<li>åƒµå°¸è¿›ç¨‹é—®é¢˜ - ä½ éœ€è¦é€‰æ‹©åˆé€‚çš„initè¿›ç¨‹</li>
</ul>
<p>å› æ­¤ï¼Œæˆ‘å»ºè®®å¤§å®¶ä¸ºæ¯ä¸ªåº”ç”¨æ„å»ºå•ç‹¬çš„Dockeré•œåƒï¼Œç„¶åä½¿ç”¨ Docker Compose è¿è¡Œå¤šä¸ªDockerå®¹å™¨ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»Dockerfileä¸­åˆ é™¤ä¸€äº›ä¸éœ€è¦çš„å®‰è£…åŒ…ï¼Œå¦å¤–ï¼ŒSSHå¯ä»¥ç”¨docker execæ›¿ä»£ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get upgrade -y</span></div><div class="line"></div><div class="line"><span class="comment"># we should remove ssh and mysql, and use</span></div><div class="line"><span class="comment"># separate container for database </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nodejs  <span class="comment"># ssh mysql  </span></span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="å°†å¤šä¸ªRUNæŒ‡ä»¤åˆå¹¶ä¸ºä¸€ä¸ª"><a href="#å°†å¤šä¸ªRUNæŒ‡ä»¤åˆå¹¶ä¸ºä¸€ä¸ª" class="headerlink" title="å°†å¤šä¸ªRUNæŒ‡ä»¤åˆå¹¶ä¸ºä¸€ä¸ª"></a>å°†å¤šä¸ªRUNæŒ‡ä»¤åˆå¹¶ä¸ºä¸€ä¸ª</h4><p>Dockeré•œåƒæ˜¯åˆ†å±‚çš„ï¼Œä¸‹é¢è¿™äº›çŸ¥è¯†ç‚¹éå¸¸é‡è¦:</p>
<ul>
<li>Dockerfileä¸­çš„æ¯ä¸ªæŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒå±‚ã€‚</li>
<li>é•œåƒå±‚å°†è¢«ç¼“å­˜å’Œå¤ç”¨</li>
<li>å½“Dockerfileçš„æŒ‡ä»¤ä¿®æ”¹äº†ï¼Œå¤åˆ¶çš„æ–‡ä»¶å˜åŒ–äº†ï¼Œæˆ–è€…æ„å»ºé•œåƒæ—¶æŒ‡å®šçš„å˜é‡ä¸åŒäº†ï¼Œå¯¹åº”çš„é•œåƒå±‚ç¼“å­˜å°±ä¼šå¤±æ•ˆ</li>
<li>æŸä¸€å±‚çš„é•œåƒç¼“å­˜å¤±æ•ˆä¹‹åï¼Œå®ƒä¹‹åçš„é•œåƒå±‚ç¼“å­˜éƒ½ä¼šå¤±æ•ˆ</li>
<li>é•œåƒå±‚æ˜¯ä¸å¯å˜çš„ï¼Œå¦‚æœæˆ‘ä»¬å†æŸä¸€å±‚ä¸­æ·»åŠ ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶ååœ¨ä¸‹ä¸€å±‚ä¸­åˆ é™¤å®ƒï¼Œåˆ™é•œåƒä¸­ä¾ç„¶ä¼šåŒ…å«è¯¥æ–‡ä»¶(åªæ˜¯è¿™ä¸ªæ–‡ä»¶åœ¨Dockerå®¹å™¨ä¸­ä¸å¯è§äº†)ã€‚</li>
</ul>
<p>Dockeré•œåƒç±»ä¼¼äºæ´‹è‘±ã€‚å®ƒä»¬éƒ½æœ‰å¾ˆå¤šå±‚ã€‚ä¸ºäº†ä¿®æ”¹å†…å±‚ï¼Œåˆ™éœ€è¦å°†å¤–é¢çš„å±‚éƒ½åˆ æ‰ã€‚è®°ä½è¿™ä¸€ç‚¹çš„è¯ï¼Œå…¶ä»–å†…å®¹å°±å¾ˆå¥½ç†è§£äº†ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰çš„RUNæŒ‡ä»¤åˆå¹¶ä¸ºä¸€ä¸ªã€‚åŒæ—¶æŠŠapt-get upgradeåˆ é™¤ï¼Œå› ä¸ºå®ƒä¼šä½¿å¾—é•œåƒæ„å»ºéå¸¸ä¸ç¡®å®š(æˆ‘ä»¬åªéœ€è¦ä¾èµ–åŸºç¡€é•œåƒçš„æ›´æ–°å°±å¥½äº†)</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \  </span></div><div class="line">    &amp;&amp; apt-get install -y nodejs \</div><div class="line">    &amp;&amp; cd /app \</div><div class="line">    &amp;&amp; npm install</div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<p>è®°ä½ä¸€ç‚¹ï¼Œæˆ‘ä»¬åªèƒ½å°†å˜åŒ–é¢‘ç‡ä¸€æ ·çš„æŒ‡ä»¤åˆå¹¶åœ¨ä¸€èµ·ã€‚å°†node.jså®‰è£…ä¸npmæ¨¡å—å®‰è£…æ”¾åœ¨ä¸€èµ·çš„è¯ï¼Œåˆ™æ¯æ¬¡ä¿®æ”¹æºä»£ç ï¼Œéƒ½éœ€è¦é‡æ–°å®‰è£…node.jsï¼Œè¿™æ˜¾ç„¶ä¸åˆé€‚ã€‚å› æ­¤ï¼Œæ­£ç¡®çš„å†™æ³•æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y nodejs  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="åŸºç¡€é•œåƒçš„æ ‡ç­¾ä¸è¦ç”¨latest"><a href="#åŸºç¡€é•œåƒçš„æ ‡ç­¾ä¸è¦ç”¨latest" class="headerlink" title="åŸºç¡€é•œåƒçš„æ ‡ç­¾ä¸è¦ç”¨latest"></a>åŸºç¡€é•œåƒçš„æ ‡ç­¾ä¸è¦ç”¨latest</h4><p>å½“é•œåƒæ²¡æœ‰æŒ‡å®šæ ‡ç­¾æ—¶ï¼Œå°†é»˜è®¤ä½¿ç”¨latest æ ‡ç­¾ã€‚å› æ­¤ï¼Œ FROM ubuntu æŒ‡ä»¤ç­‰åŒäºFROM ubuntu:latestã€‚å½“æ—¶ï¼Œå½“é•œåƒæ›´æ–°æ—¶ï¼Œlatestæ ‡ç­¾ä¼šæŒ‡å‘ä¸åŒçš„é•œåƒï¼Œè¿™æ—¶æ„å»ºé•œåƒæœ‰å¯èƒ½å¤±è´¥ã€‚å¦‚æœä½ çš„ç¡®éœ€è¦ä½¿ç”¨æœ€æ–°ç‰ˆçš„åŸºç¡€é•œåƒï¼Œå¯ä»¥ä½¿ç”¨latestæ ‡ç­¾ï¼Œå¦åˆ™çš„è¯ï¼Œæœ€å¥½æŒ‡å®šç¡®å®šçš„é•œåƒæ ‡ç­¾ã€‚</p>
<p>ç¤ºä¾‹Dockerfileåº”è¯¥ä½¿ç”¨16.04ä½œä¸ºæ ‡ç­¾ã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">16.04</span>  <span class="comment"># it's that easy!</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y nodejs  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="æ¯ä¸ªRUNæŒ‡ä»¤ååˆ é™¤å¤šä½™æ–‡ä»¶"><a href="#æ¯ä¸ªRUNæŒ‡ä»¤ååˆ é™¤å¤šä½™æ–‡ä»¶" class="headerlink" title="æ¯ä¸ªRUNæŒ‡ä»¤ååˆ é™¤å¤šä½™æ–‡ä»¶"></a>æ¯ä¸ªRUNæŒ‡ä»¤ååˆ é™¤å¤šä½™æ–‡ä»¶</h4><p>å‡è®¾æˆ‘ä»¬æ›´æ–°äº†apt-getæºï¼Œä¸‹è½½ï¼Œè§£å‹å¹¶å®‰è£…äº†ä¸€äº›è½¯ä»¶åŒ…ï¼Œå®ƒä»¬éƒ½ä¿å­˜åœ¨/var/lib/apt/lists/ç›®å½•ä¸­ã€‚ä½†æ˜¯ï¼Œè¿è¡Œåº”ç”¨æ—¶Dockeré•œåƒä¸­å¹¶ä¸éœ€è¦è¿™äº›æ–‡ä»¶ã€‚æˆ‘ä»¬æœ€å¥½å°†å®ƒä»¬åˆ é™¤ï¼Œå› ä¸ºå®ƒä¼šä½¿Dockeré•œåƒå˜å¤§ã€‚</p>
<p>ç¤ºä¾‹Dockerfileä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ é™¤/var/lib/apt/lists/ç›®å½•ä¸­çš„æ–‡ä»¶(å®ƒä»¬æ˜¯ç”±apt-get updateç”Ÿæˆçš„)ã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ROM ubuntu:<span class="number">16.04</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \  </span></div><div class="line">    &amp;&amp; apt-get install -y nodejs \</div><div class="line">    <span class="comment"># added lines</span></div><div class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/*</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ-alpineç‰ˆæœ¬æœ€å¥½"><a href="#é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ-alpineç‰ˆæœ¬æœ€å¥½" class="headerlink" title="é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ(alpineç‰ˆæœ¬æœ€å¥½)"></a>é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ(alpineç‰ˆæœ¬æœ€å¥½)</h4><p>åœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ubuntuä½œä¸ºåŸºç¡€é•œåƒã€‚ä½†æ˜¯æˆ‘ä»¬åªéœ€è¦è¿è¡Œnodeç¨‹åºï¼Œæœ‰å¿…è¦ä½¿ç”¨ä¸€ä¸ªé€šç”¨çš„åŸºç¡€é•œåƒå—ï¼Ÿnodeé•œåƒåº”è¯¥æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="comment"># we don't need to install node </span></div><div class="line"><span class="comment"># anymore and use apt-get</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<p>æ›´å¥½çš„é€‰æ‹©æ˜¯alpineç‰ˆæœ¬çš„nodeé•œåƒã€‚alpineæ˜¯ä¸€ä¸ªæå°åŒ–çš„Linuxå‘è¡Œç‰ˆï¼Œåªæœ‰4MBï¼Œè¿™è®©å®ƒéå¸¸é€‚åˆä½œä¸ºåŸºç¡€é•œåƒã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="è®¾ç½®WORKDIRå’Œ-CMD"><a href="#è®¾ç½®WORKDIRå’Œ-CMD" class="headerlink" title="è®¾ç½®WORKDIRå’Œ CMD"></a>è®¾ç½®WORKDIRå’Œ CMD</h4><p>WORKDIRæŒ‡ä»¤å¯ä»¥è®¾ç½®é»˜è®¤ç›®å½•ï¼Œä¹Ÿå°±æ˜¯è¿è¡ŒRUN / CMD / ENTRYPOINTæŒ‡ä»¤çš„åœ°æ–¹ã€‚</p>
<p>CMDæŒ‡ä»¤å¯ä»¥è®¾ç½®å®¹å™¨åˆ›å»ºæ˜¯æ‰§è¡Œçš„é»˜è®¤å‘½ä»¤ã€‚å¦å¤–ï¼Œä½ åº”è¯¥è®²å‘½ä»¤å†™åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ ä¸ºå‘½ä»¤çš„æ¯ä¸ªå•è¯(å‚è€ƒ<a href="https://docs.docker.com/engine/reference/builder/#cmd" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>)ã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"npm"</span>, <span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="ä½¿ç”¨ENTRYPOINT-å¯é€‰"><a href="#ä½¿ç”¨ENTRYPOINT-å¯é€‰" class="headerlink" title="ä½¿ç”¨ENTRYPOINT (å¯é€‰)"></a>ä½¿ç”¨ENTRYPOINT (å¯é€‰)</h4><p>ENTRYPOINTæŒ‡ä»¤å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºå®ƒä¼šå¢åŠ å¤æ‚åº¦ã€‚ENTRYPOINTæ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œå®ƒä¼šé»˜è®¤æ‰§è¡Œï¼Œå¹¶ä¸”å°†æŒ‡å®šçš„å‘½ä»¤é”™è¯¯å…¶å‚æ•°ã€‚å®ƒé€šå¸¸ç”¨äºæ„å»ºå¯æ‰§è¡Œçš„Dockeré•œåƒã€‚entrypoint.shå¦‚ä¸‹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env sh</span></div><div class="line"><span class="comment"># $0 is a script name, </span></div><div class="line"><span class="comment"># $1, $2, $3 etc are passed arguments</span></div><div class="line"><span class="comment"># $1 is our command</span></div><div class="line">CMD=<span class="variable">$1</span></div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$CMD</span>"</span> <span class="keyword">in</span>  </div><div class="line">  <span class="string">"dev"</span> )</div><div class="line">    npm install</div><div class="line">    <span class="built_in">export</span> NODE_ENV=development</div><div class="line">    <span class="built_in">exec</span> npm run dev</div><div class="line">    ;;</div><div class="line"></div><div class="line">  <span class="string">"start"</span> )</div><div class="line">    <span class="comment"># we can modify files here, using ENV variables passed in </span></div><div class="line">    <span class="comment"># "docker create" command. It can't be done during build process.</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"db: <span class="variable">$DATABASE_ADDRESS</span>"</span> &gt;&gt; /app/config.yml</div><div class="line">    <span class="built_in">export</span> NODE_ENV=production</div><div class="line">    <span class="built_in">exec</span> npm start</div><div class="line">    ;;</div><div class="line"></div><div class="line">   * )</div><div class="line">    <span class="comment"># Run custom command. Thanks to this line we can still use </span></div><div class="line">    <span class="comment"># "docker run our_image /bin/bash" and it will work</span></div><div class="line">    <span class="built_in">exec</span> <span class="variable">$CMD</span> <span class="variable">$&#123;@:2&#125;</span></div><div class="line">    ;;</div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure>
<p>ç¤ºä¾‹Dockerfile:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<p>å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿è¡Œè¯¥é•œåƒ:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># è¿è¡Œå¼€å‘ç‰ˆæœ¬</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> our-app dev </span></div><div class="line"></div><div class="line"><span class="comment"># è¿è¡Œç”Ÿäº§ç‰ˆæœ¬</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> our-app start </span></div><div class="line"></div><div class="line"><span class="comment"># è¿è¡Œbash</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> -it our-app /bin/bash</span></div></pre></td></tr></table></figure>
<h4 id="COPYä¸ADDä¼˜å…ˆä½¿ç”¨å‰è€…"><a href="#COPYä¸ADDä¼˜å…ˆä½¿ç”¨å‰è€…" class="headerlink" title="COPYä¸ADDä¼˜å…ˆä½¿ç”¨å‰è€…"></a>COPYä¸ADDä¼˜å…ˆä½¿ç”¨å‰è€…</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="åˆç†è°ƒæ•´COPYä¸RUNçš„é¡ºåº"><a href="#åˆç†è°ƒæ•´COPYä¸RUNçš„é¡ºåº" class="headerlink" title="åˆç†è°ƒæ•´COPYä¸RUNçš„é¡ºåº"></a>åˆç†è°ƒæ•´COPYä¸RUNçš„é¡ºåº</h4><p>æˆ‘ä»¬åº”è¯¥æŠŠå˜åŒ–æœ€å°‘çš„éƒ¨åˆ†æ”¾åœ¨Dockerfileçš„å‰é¢ï¼Œè¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨é•œåƒç¼“å­˜ã€‚</p>
<p>ç¤ºä¾‹ä¸­ï¼Œæºä»£ç ä¼šç»å¸¸å˜åŒ–ï¼Œåˆ™æ¯æ¬¡æ„å»ºé•œåƒæ—¶éƒ½éœ€è¦é‡æ–°å®‰è£…NPMæ¨¡å—ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆæ‹·è´package.jsonï¼Œç„¶åå®‰è£…NPMæ¨¡å—ï¼Œæœ€åæ‰æ‹·è´å…¶ä½™çš„æºä»£ç ã€‚è¿™æ ·çš„è¯ï¼Œå³ä½¿æºä»£ç å˜åŒ–ï¼Œä¹Ÿä¸éœ€è¦é‡æ–°å®‰è£…NPMæ¨¡å—ã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="è®¾ç½®é»˜è®¤çš„ç¯å¢ƒå˜é‡ï¼Œæ˜ å°„ç«¯å£å’Œæ•°æ®å·"><a href="#è®¾ç½®é»˜è®¤çš„ç¯å¢ƒå˜é‡ï¼Œæ˜ å°„ç«¯å£å’Œæ•°æ®å·" class="headerlink" title="è®¾ç½®é»˜è®¤çš„ç¯å¢ƒå˜é‡ï¼Œæ˜ å°„ç«¯å£å’Œæ•°æ®å·"></a>è®¾ç½®é»˜è®¤çš„ç¯å¢ƒå˜é‡ï¼Œæ˜ å°„ç«¯å£å’Œæ•°æ®å·</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">ENV</span> PROJECT_DIR=/app</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json <span class="variable">$PROJECT_DIR</span>  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> MEDIA_DIR=/media \  </div><div class="line">    NODE_ENV=production \</div><div class="line">    APP_PORT=<span class="number">3000</span></div><div class="line"></div><div class="line"><span class="keyword">VOLUME</span><span class="bash"> <span class="variable">$MEDIA_DIR</span>  </span></div><div class="line"><span class="keyword">EXPOSE</span> $APP_PORT</div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="æ·»åŠ HEALTHCHECK"><a href="#æ·»åŠ HEALTHCHECK" class="headerlink" title="æ·»åŠ HEALTHCHECK"></a>æ·»åŠ HEALTHCHECK</h4><p>è¿è¡Œå®¹å™¨æ—¶ï¼Œå¯ä»¥æŒ‡å®šâ€“restart alwaysé€‰é¡¹ã€‚è¿™æ ·çš„è¯ï¼Œå®¹å™¨å´©æºƒæ—¶ï¼ŒDockerå®ˆæŠ¤è¿›ç¨‹(docker daemon)ä¼šé‡å¯å®¹å™¨ã€‚å¯¹äºéœ€è¦é•¿æ—¶é—´è¿è¡Œçš„å®¹å™¨ï¼Œè¿™ä¸ªé€‰é¡¹éå¸¸æœ‰ç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœå®¹å™¨çš„ç¡®åœ¨è¿è¡Œï¼Œä½†æ˜¯ä¸å¯(é™·å…¥æ­»å¾ªç¯ï¼Œé…ç½®é”™è¯¯)ç”¨æ€ä¹ˆåŠï¼Ÿä½¿ç”¨HEALTHCHECKæŒ‡ä»¤å¯ä»¥è®©Dockerå‘¨æœŸæ€§çš„æ£€æŸ¥å®¹å™¨çš„å¥åº·çŠ¶å†µã€‚æˆ‘ä»¬åªéœ€è¦æŒ‡å®šä¸€ä¸ªå‘½ä»¤ï¼Œå¦‚æœä¸€åˆ‡æ­£å¸¸çš„è¯è¿”å›0ï¼Œå¦åˆ™è¿”å›1ã€‚ç¤ºä¾‹å¦‚ä¸‹:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine  </div><div class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer <span class="string">"jakub.skalecki@example.com"</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> PROJECT_DIR=/app  </div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json <span class="variable">$PROJECT_DIR</span>  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> MEDIA_DIR=/media \  </div><div class="line">    NODE_ENV=production \</div><div class="line">    APP_PORT=<span class="number">3000</span></div><div class="line"></div><div class="line"><span class="keyword">VOLUME</span><span class="bash"> <span class="variable">$MEDIA_DIR</span>  </span></div><div class="line"><span class="keyword">EXPOSE</span> $APP_PORT  </div><div class="line"><span class="keyword">HEALTHCHECK</span><span class="bash"> CMD curl --fail http://localhost:<span class="variable">$APP_PORT</span> || <span class="built_in">exit</span> 1</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;ç¤ºä¾‹&quot;&gt;&lt;a href=&quot;#ç¤ºä¾‹&quot; class=&quot;headerlink&quot; title=&quot;ç¤ºä¾‹&quot;&gt;&lt;/a&gt;ç¤ºä¾‹&lt;/h4&gt;&lt;p&gt;å‡è®¾æˆ‘ä»¬éœ€è¦ä½¿ç”¨Dockerè¿è¡Œä¸€ä¸ªNode.jsåº”ç”¨&lt;/p&gt;
&lt;figure class=&quot;highlight dockerfile&quot;&gt;&lt;
    
    </summary>
    
      <category term="Docker" scheme="http://peterfei.me/categories/Docker/"/>
    
    
      <category term="docker" scheme="http://peterfei.me/tags/docker/"/>
    
      <category term="Dockerfile" scheme="http://peterfei.me/tags/Dockerfile/"/>
    
  </entry>
  
  <entry>
    <title>è®°_ç»™å…¬å¸Unityå°ç»„å®ç°çš„åŸºäºSqliteç¼“å­˜Cacheç±»</title>
    <link href="http://peterfei.me/2019/04/18/%E8%AE%B0-%E7%BB%99%E5%85%AC%E5%8F%B8Unity%E7%BB%84%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98%E7%B1%BB/"/>
    <id>http://peterfei.me/2019/04/18/è®°-ç»™å…¬å¸Unityç»„å®ç°çš„æ•°æ®åº“ç¼“å­˜ç±»/</id>
    <published>2019-04-18T02:28:51.000Z</published>
    <updated>2022-08-26T02:42:20.317Z</updated>
    
    <content type="html"><![CDATA[<h3 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h3><ol>
<li>æ‰€æœ‰çº¿ä¸Šæ¥å£ç®¡ç†è‡³æœ¬åœ°ç¼“å­˜</li>
<li>ä½¿ç”¨é¢å‘å¯¹è±¡</li>
<li>dbä½¿ç”¨sqlite</li>
</ol>
<h3 id="è®¾è®¡æ€è·¯"><a href="#è®¾è®¡æ€è·¯" class="headerlink" title="è®¾è®¡æ€è·¯"></a>è®¾è®¡æ€è·¯</h3><p>çº¿ä¸Šæ‹‰å–æ•°æ®,ç¼“å­˜è‡³æœ¬åœ°,è¯»å–æœ¬åœ°ç‰ˆæœ¬,å¯¹æ¯”çº¿ä¸Šç‰ˆæœ¬å·,å¦‚æœ‰æ›´æ–°,æ›´æ–°æœ¬åœ°æ•°æ®åº“æ•°æ®,å¦‚æ²¡æœ‰,åˆ™è¯»å–æœ¬åœ°.</p>
<h3 id="æ ¸å¿ƒä»£ç "><a href="#æ ¸å¿ƒä»£ç " class="headerlink" title="æ ¸å¿ƒä»£ç "></a>æ ¸å¿ƒä»£ç </h3><blockquote>
<p><code>IDbDao.cs</code> æ¥å£å®šä¹‰</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.DbDao</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface IDbDao&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">void</span> setCache(<span class="built_in">string</span> r);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>CacheOption.cs</code> å®ç°</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Linq;</div><div class="line">using System.Text;</div><div class="line">using Assets.Scripts.Repository;</div><div class="line">using Assets.Scripts.Model;</div><div class="line">using Assets.Scripts.Infrastructure;</div><div class="line">using UnityEngine;</div><div class="line">using Newtonsoft.Json;</div><div class="line"></div><div class="line">namespace Assets.Scripts.DbDao</div><div class="line">&#123;</div><div class="line">    public <span class="keyword">class</span> CacheOption&lt;T&gt; : IDbDao&lt;T&gt; where T : <span class="keyword">class</span>, new()</div><div class="line">    &#123;</div><div class="line">        public void setCache_dbPath(string r, string path, bool is_append = false)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> repository = new RemoteRepository&lt;GetStruct&gt;();</div><div class="line">            repository.Get&lt;Response&lt;T&gt;&gt;(r, (response) =&gt;</div><div class="line">            &#123;</div><div class="line">                Debug.<span class="built_in">Log</span>(JsonConvert.SerializeObject(response));</div><div class="line">                <span class="keyword">if</span> (response.<span class="keyword">List</span> != null &amp;&amp; response.<span class="keyword">List</span>.<span class="keyword">Count</span> != 0)</div><div class="line">                &#123;</div><div class="line">                   </div><div class="line">                    <span class="keyword">var</span> <span class="keyword">db</span> = new DbRepository&lt;T&gt;();</div><div class="line">                    <span class="keyword">db</span>.CreateDb(path);</div><div class="line">                    <span class="keyword">if</span> (!is_append)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">db</span>.DropTable();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">db</span>.CreateTable();</div><div class="line">                    <span class="keyword">db</span>.InsertAll(response.<span class="keyword">List</span>);<span class="comment">//æ›´æ–°è¿œç¨‹æ•°æ®æº</span></div><div class="line">                    <span class="keyword">db</span>.<span class="keyword">Close</span>();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                &#123;</div><div class="line">                    Debug.<span class="built_in">Log</span>(<span class="string">"Struct List data is null "</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//å®ç°å†™å…¥ç¼“å­˜å…±æœ‰ç±»</span></div><div class="line">        public void setCache(string r)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> repository = new RemoteRepository&lt;GetStruct&gt;();</div><div class="line"></div><div class="line">            <span class="keyword">var</span> <span class="keyword">version</span> = new DbRepository&lt;TableVersions&gt;();</div><div class="line">            <span class="keyword">version</span>.DataService(<span class="string">"vesali.db"</span>);</div><div class="line">            <span class="keyword">version</span>.CreateTable();</div><div class="line">            TableVersions tv = <span class="keyword">version</span>.SelectOne&lt;TableVersions&gt;((tmpT) =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (tmpT.table_name == <span class="keyword">typeof</span>(T).Name)</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">return</span> true;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> false;</div><div class="line"></div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">var</span> struct_version = <span class="string">"-1"</span>;</div><div class="line">            <span class="keyword">if</span> (tv != null)</div><div class="line">            &#123;</div><div class="line">                struct_version = tv.<span class="keyword">version</span>;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            </div><div class="line">            repository.Get&lt;Response&lt;T&gt;&gt;(r, new GetStruct &#123; <span class="keyword">Version</span> = struct_version, device = SystemInfo.deviceUniqueIdentifier, os = Enum.GetName(<span class="keyword">typeof</span>(asset_platform), PublicClass.platform) , level = ((int)PublicClass.Quality).<span class="keyword">ToString</span>(), softVersion = PublicClass.get_version() &#125;, (response) =&gt;</div><div class="line">                       &#123;</div><div class="line">                           <span class="keyword">if</span> (response.<span class="keyword">List</span> != null &amp;&amp; response.<span class="keyword">List</span>.<span class="keyword">Count</span> != 0)</div><div class="line">                           &#123;</div><div class="line">                               Debug.<span class="built_in">Log</span>(<span class="string">"============è¯»å–æ•°æ®åº“ç¼“å­˜æ›´æ–°ï¼Œä»è¿œç¨‹æ‹‰å–æ•°æ®ï¼Œæ›´æ–°ç‰ˆæœ¬å·=================== "</span>);</div><div class="line">                               <span class="comment">//å¦‚æœæœ‰æ•°æ®,æ›´æ–°æ•°æ®å’Œç‰ˆæœ¬</span></div><div class="line">                               <span class="keyword">if</span> (tv == null)</div><div class="line">                               &#123;</div><div class="line">                                   <span class="keyword">version</span>.Insert(new TableVersions &#123; table_name = <span class="keyword">typeof</span>(T).Name, <span class="keyword">version</span> = response.maxVersion &#125;);</div><div class="line">                               &#125;</div><div class="line">                               <span class="keyword">else</span></div><div class="line">                               &#123;</div><div class="line">                                   <span class="keyword">version</span>.<span class="keyword">Update</span>(new TableVersions &#123; table_name = <span class="keyword">typeof</span>(T).Name, <span class="keyword">version</span> = response.maxVersion &#125;);</div><div class="line">                               &#125;</div><div class="line">                               <span class="keyword">version</span>.<span class="keyword">Close</span>();</div><div class="line">                               <span class="keyword">var</span> <span class="keyword">db</span> = new DbRepository&lt;T&gt;();</div><div class="line">                               <span class="keyword">db</span>.DataService(<span class="string">"vesali.db"</span>);</div><div class="line">                               <span class="keyword">db</span>.DropTable();</div><div class="line">                               <span class="keyword">db</span>.CreateTable();</div><div class="line">                               <span class="keyword">db</span>.InsertAll(response.<span class="keyword">List</span>);<span class="comment">//æ›´æ–°è¿œç¨‹æ•°æ®æº</span></div><div class="line">                               <span class="keyword">db</span>.<span class="keyword">Close</span>();</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">else</span></div><div class="line">                           &#123;</div><div class="line">                               Debug.<span class="built_in">Log</span>(<span class="string">"Struct List data is null "</span>);</div><div class="line">                               <span class="comment">// Debug.Log("============è¯»å–æ•°æ®åº“ç¼“å­˜=================== ");</span></div><div class="line">                               <span class="comment">//è¯»å–æ•°æ®åº“ç¼“å­˜</span></div><div class="line">                           &#125;</div><div class="line">                           PublicClass.data_list_count++;</div><div class="line">                       &#125;);</div><div class="line">            <span class="comment">//throw new NotImplementedException();</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>IRepository.cs</code> å¯¹åŸºæœ¬æ•°æ®æ“ä½œæ¥å£å®šä¹‰,å¦‚å¢åˆ æ”¹æŸ¥</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface IRepository&lt;T&gt; where T:<span class="keyword">class</span>,<span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">void</span> Insert(T instance);</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Delete</span><span class="params">(T instance)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Update</span><span class="params">(T instance)</span></span>;</div><div class="line">        IEnumerable&lt;T&gt; Select(Func&lt;T,<span class="keyword">bool</span>&gt; func );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p> <code>DbRepository.cs</code>æ•°æ®åº“è„šæœ¬å®ç°</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.IO;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> SQLite4Unity3d;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> DbRepository&lt;T&gt; : IRepository&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="comment">//public delegate void DoConnection(String str);</span></div><div class="line">        <span class="keyword">private</span> SQLiteConnection _connection;</div><div class="line">        <span class="comment">//private string v;</span></div><div class="line"></div><div class="line">        <span class="comment">//public DbRepository(string v)</span></div><div class="line">        <span class="comment">//&#123;</span></div><div class="line">        <span class="comment">//    this.v = v;</span></div><div class="line">        <span class="comment">//&#125;</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateTable</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            _connection.CreateTable&lt;T&gt;();</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> TableQuery&lt;T&gt; getTableQuerry()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;();</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DropTable</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            _connection.DropTable&lt;T&gt;();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Delete</span><span class="params">(T instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Delete(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span><span class="params">(T instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Insert(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InsertAll</span><span class="params">(T[] instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.InsertAll(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InsertAll</span><span class="params">(List&lt;T&gt; instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.InsertAll(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> T SelectOne&lt;R&gt;(Func&lt;T, <span class="keyword">bool</span>&gt; func) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;().Where(func).FirstOrDefault();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> IEnumerable&lt;T&gt; Select&lt;R&gt;(Func&lt;T, <span class="keyword">bool</span>&gt; func) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;().Where(func);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span><span class="params">(T t)</span></span></div><div class="line">        &#123;</div><div class="line"></div><div class="line">            _connection.Update(t);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Close();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateDb</span><span class="params">(<span class="built_in">string</span> dbPath)</span></span></div><div class="line">        &#123;</div><div class="line">            _connection = <span class="keyword">new</span> SQLiteConnection(dbPath, SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DataService</span><span class="params">(<span class="built_in">string</span> DatabaseName)</span></span></div><div class="line">        &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></div><div class="line">            var dbPath = <span class="built_in">string</span>.Format(<span class="string">"&#123;0&#125;/&#123;1&#125;"</span>, PublicClass.vesal_db_path, DatabaseName); <span class="comment">//string.Format(@"Assets/StreamingAssets/&#123;0&#125;", DatabaseName);</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">        </div><div class="line"></div><div class="line">        var filepath = <span class="built_in">string</span>.Format(<span class="string">"&#123;0&#125;/&#123;1&#125;"</span>,PublicClass.vesal_db_path, DatabaseName);</div><div class="line"></div><div class="line">       </div><div class="line"></div><div class="line">        var dbPath = filepath;</div><div class="line">        <span class="comment">// var dbPath = loadDb;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">            _connection = <span class="keyword">new</span> SQLiteConnection(dbPath, SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create);</div><div class="line">            <span class="comment">//DebugLog.DebugLogInfo("Final PATH: " + dbPath);</span></div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> IEnumerable&lt;T&gt; Select(Func&lt;T, <span class="keyword">bool</span>&gt; func)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>RemoteRepository.cs</code> æ¥å£ç±»å®ç°</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> Assets.Scripts.Infrastructure;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> Assets.Scripts.Network;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> Newtonsoft.Json;</div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> RemoteRepository&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> ISerializer Serializer &#123; <span class="built_in">get</span>; set; &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> RemoteRepository(ISerializer serializer = null)</div><div class="line">        &#123;</div><div class="line">            Serializer = serializer ?? SerializerJson.Instance;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Get&lt;R&gt;(<span class="keyword">string</span> url, T instance, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            var parameters = HttpUtility.BuildParameters(instance, <span class="keyword">new</span> StringBuilder(<span class="string">"?"</span>));</div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Get,</div><div class="line">                Parameters = parameters</div><div class="line">            &#125;;</div><div class="line">            Debug.Log(httpRequest.Url + httpRequest.Parameters);</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    R r = JsonConvert.DeserializeObject&lt;R&gt;(httpResponse.Data);</div><div class="line">                    onSuccess(r);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//<span class="doctag">TODO:</span>å¼‚å¸¸å¤„ç†</span></div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Get&lt;R&gt;(<span class="keyword">string</span> url, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// var parameters = HttpUtility.BuildParameters(instance, new StringBuilder("?"));</span></div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Get,</div><div class="line">                <span class="comment">// Parameters = parameters</span></div><div class="line">            &#125;;</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    R r = JsonConvert.DeserializeObject&lt;R&gt;(httpResponse.Data);</div><div class="line">                    Debug.Log(<span class="string">"json str :"</span> + r);</div><div class="line">                    onSuccess(r);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//<span class="doctag">TODO:</span>å¼‚å¸¸å¤„ç†</span></div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Post&lt;R&gt;(<span class="keyword">string</span> url, T instance, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            var parameters = HttpUtility.BuildParameters(instance, <span class="keyword">new</span> StringBuilder());</div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Post,</div><div class="line">                Parameters = parameters</div><div class="line">            &#125;;</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    <span class="comment">//<span class="doctag">TODO:</span>åˆ¤æ–­æ˜¯å¦æœ‰Data</span></div><div class="line">                    onSuccess(Serializer.Deserialize&lt;R&gt;(httpResponse.Data));</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Test()</div><div class="line">        &#123;</div><div class="line">            Debug.Log(<span class="string">"Hello..."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>Response.cs</code></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    [System.Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> Response&lt;T&gt;</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> msg;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> code;</div><div class="line">        <span class="keyword">public</span> List&lt;T&gt; List;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> maxVersion;</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>HttpUtility.cs</code> httpæ“ä½œç±»</p>
</blockquote>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line">namespace Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtility</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> string BuildParameters&lt;T&gt;(T instance, StringBuilder sb) where T:<span class="type">class</span>,<span class="keyword">new</span><span class="type"></span>()</div><div class="line">        &#123;</div><div class="line">            foreach (<span class="keyword">var</span> property <span class="keyword">in</span> instance.GetType().GetProperties())</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">var</span> propertyName = property.Name;</div><div class="line">                <span class="keyword">var</span> value = property.GetValue(instance, <span class="literal">null</span>);</div><div class="line">                sb.Append(propertyName + <span class="string">"="</span> + value + <span class="string">"&amp;"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> sb.ToString().TrimEnd(<span class="string">'&amp;'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>ISerializer.cs</code> æ ¼å¼åŒ–æ¥å£ </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface ISerializer</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">string</span> Serialize&lt;T&gt;(T obj, <span class="keyword">bool</span> readableOutput = <span class="literal">false</span>) where T : <span class="keyword">class</span>, <span class="keyword">new</span>();</div><div class="line">        T Deserialize&lt;T&gt;(<span class="built_in">string</span> json) where T : <span class="keyword">class</span>, <span class="keyword">new</span>();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>SerializerJson.cs</code> </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> SerializerJson:ISerializer</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> readonly SerializerJson Instance=<span class="keyword">new</span> SerializerJson();</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">SerializerJson</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Serialize&lt;T&gt;(T obj, <span class="keyword">bool</span> readableOutput = <span class="literal">false</span>) where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> T Deserialize&lt;T&gt;(<span class="built_in">string</span> json) where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> JsonUtility.FromJson&lt;T&gt;(json);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>SQLite.cs</code></p>
</blockquote>
<p><a href="https://gist.github.com/peterfei/69f98addc648163cd61ca63b9f53ef68" target="_blank" rel="external">æŸ¥çœ‹æºç </a></p>
<blockquote>
<p><code>HttpMethod.cs</code></p>
</blockquote>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Linq;</div><div class="line">using System.Text;</div><div class="line"></div><div class="line">namespace Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    public <span class="class"><span class="keyword">enum</span> <span class="title">HttpMethod</span></span></div><div class="line">    &#123;</div><div class="line">        Get,</div><div class="line">        Post</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Modelå®ä¾‹"><a href="#Modelå®ä¾‹" class="headerlink" title="Modelå®ä¾‹"></a>Modelå®ä¾‹</h3><blockquote>
<p><code>TableVersions.cs</code></p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> SQLite4Unity3d;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Assets.Scripts.Model</span></div><div class="line">&#123;</div><div class="line">    [Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TableVersions</span></div><div class="line">    &#123;</div><div class="line">        [PrimaryKey]</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> table_name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> version &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">       </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>GetStruct.cs</code> </p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Assets.Scripts.Model</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">class</span> <span class="title">GetStruct</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Version &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> UpdateUrlUuid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> device &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> os &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> level &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> softVersion &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h3><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> cache_CommonLib = <span class="keyword">new</span> <span class="type">CacheOption</span>&lt;GetStruct&gt;();</div><div class="line">cache_CommonLib.setCache(PublicClass.server_ip+<span class="string">'v1/app/api'</span>)</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;éœ€æ±‚&quot;&gt;&lt;a href=&quot;#éœ€æ±‚&quot; class=&quot;headerlink&quot; title=&quot;éœ€æ±‚&quot;&gt;&lt;/a&gt;éœ€æ±‚&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;æ‰€æœ‰çº¿ä¸Šæ¥å£ç®¡ç†è‡³æœ¬åœ°ç¼“å­˜&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨é¢å‘å¯¹è±¡&lt;/li&gt;
&lt;li&gt;dbä½¿ç”¨sqlite&lt;/li&gt;
&lt;/ol&gt;
&lt;h3
    
    </summary>
    
      <category term="Unity" scheme="http://peterfei.me/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://peterfei.me/tags/Unity/"/>
    
      <category term="C#" scheme="http://peterfei.me/tags/C/"/>
    
      <category term="Sqlite" scheme="http://peterfei.me/tags/Sqlite/"/>
    
  </entry>
  
  <entry>
    <title>dockerç¬”è®°01</title>
    <link href="http://peterfei.me/2019/04/17/docker%E7%AC%94%E8%AE%B001/"/>
    <id>http://peterfei.me/2019/04/17/dockerç¬”è®°01/</id>
    <published>2019-04-17T10:16:56.000Z</published>
    <updated>2022-08-26T02:42:20.306Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å®‰è£…-Docker"><a href="#å®‰è£…-Docker" class="headerlink" title="å®‰è£… Docker"></a>å®‰è£… Docker</h3><p>Mac ä¸Šçš„å®‰è£…<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">brew </span>cask <span class="keyword">install </span>docker</div></pre></td></tr></table></figure></p>
<p>å®‰è£…å®Œæˆä¹‹åï¼Œæ‰§è¡Œ hello-world è¯•ä¸€ä¸‹:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker <span class="keyword">run</span><span class="bash"> hello-world</span></div></pre></td></tr></table></figure>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Hello <span class="built_in">from</span> Docker!</div><div class="line">This message shows that your installation appears <span class="built_in">to</span> be working correctly.</div><div class="line"></div><div class="line">To generate this message, Docker took <span class="keyword">the</span> following steps:</div><div class="line"> <span class="number">1.</span> The Docker client contacted <span class="keyword">the</span> Docker daemon.</div><div class="line"> <span class="number">2.</span> The Docker daemon pulled <span class="keyword">the</span> <span class="string">"hello-world"</span> image <span class="built_in">from</span> <span class="keyword">the</span> Docker Hub.</div><div class="line">    (amd64)</div><div class="line"> <span class="number">3.</span> The Docker daemon created <span class="keyword">a</span> <span class="built_in">new</span> container <span class="built_in">from</span> that image which runs <span class="keyword">the</span></div><div class="line">    executable that produces <span class="keyword">the</span> output you are currently reading.</div><div class="line"> <span class="number">4.</span> The Docker daemon streamed that output <span class="built_in">to</span> <span class="keyword">the</span> Docker client, which sent <span class="keyword">it</span></div><div class="line">    <span class="built_in">to</span> your terminal.</div><div class="line"></div><div class="line">To <span class="keyword">try</span> something more ambitious, you can run <span class="keyword">an</span> Ubuntu container <span class="keyword">with</span>:</div><div class="line"> $ docker run -<span class="keyword">it</span> ubuntu bash</div><div class="line"></div><div class="line">Share images, automate workflows, <span class="keyword">and</span> more <span class="keyword">with</span> <span class="keyword">a</span> free Docker ID:</div><div class="line"> <span class="keyword">https</span>://hub.docker.com/</div><div class="line"></div><div class="line">For more examples <span class="keyword">and</span> ideas, visit:</div><div class="line"> <span class="keyword">https</span>://docs.docker.com/<span class="built_in">get</span>-started/</div></pre></td></tr></table></figure>
<h3 id="å¯åŠ¨NginxæœåŠ¡"><a href="#å¯åŠ¨NginxæœåŠ¡" class="headerlink" title="å¯åŠ¨NginxæœåŠ¡"></a>å¯åŠ¨NginxæœåŠ¡</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">run</span><span class="bash"> <span class="_">-d</span> -p 80:80 --restart=always  nginx:latest</span></div></pre></td></tr></table></figure>
<blockquote>
<p><code>-p</code> è¡¨ç¤ºå®¿ä¸»æœºIP:å®¹å™¨IP<br><code>--restart</code> é‡å¯æ¨¡å¼ï¼Œè®¾ç½® alwaysï¼Œæ¯æ¬¡å¯åŠ¨ docker éƒ½ä¼šå¯åŠ¨ nginx å®¹å™¨</p>
</blockquote>
<h3 id="è¿›å…¥å®¹å™¨"><a href="#è¿›å…¥å®¹å™¨" class="headerlink" title="è¿›å…¥å®¹å™¨"></a>è¿›å…¥å®¹å™¨</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker exec -<span class="keyword">it</span> <span class="number">4591552</span>a4185 bash</div></pre></td></tr></table></figure>
<p>å‚æ•°è¯´æ˜ï¼š</p>
<blockquote>
<p><code>exec</code> å¯¹å®¹å™¨æ“ä½œ<br><code>-it</code> åˆ†é…ä¼ªtty<br><code>4591552a4185</code>å®¹å™¨ID<br><code>bash</code>äº¤äº’ç¨‹åºä¸ºbash</p>
</blockquote>
<p>Docker æä¾›æ•°æ®æŒ‚è½½çš„åŠŸèƒ½ï¼Œå³å¯ä»¥æŒ‡å®šå®¹å™¨å†…çš„æŸäº›è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºå™¨ä¸Šï¼Œä¿®æ”¹å‘½ä»¤ï¼Œæ·»åŠ  -v å‚æ•°ï¼Œå¯åŠ¨æ–°çš„å®¹å™¨ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p <span class="number">80</span>:<span class="number">80</span>  -v <span class="regexp">~/docker-demo/</span>nginx-<span class="string">htmls:</span><span class="regexp">/usr/</span>share<span class="regexp">/nginx/</span>html/ --restart=always  <span class="string">nginx:</span>latest</div></pre></td></tr></table></figure>
<blockquote>
<p>å¯åŠ¨æˆåŠŸä¹‹åï¼Œdocker ä¼šå¸®ä½ ç”Ÿæˆç›®å½• ~/docker-demo/nginx-htmls</p>
</blockquote>
<h3 id="åœæ­¢è¿è¡Œ"><a href="#åœæ­¢è¿è¡Œ" class="headerlink" title="åœæ­¢è¿è¡Œ"></a>åœæ­¢è¿è¡Œ</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">stop</span> <span class="number">4591552</span>a4185</div></pre></td></tr></table></figure>
<h3 id="åˆ é™¤å®¹å™¨"><a href="#åˆ é™¤å®¹å™¨" class="headerlink" title="åˆ é™¤å®¹å™¨"></a>åˆ é™¤å®¹å™¨</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker rm <span class="number">4591552</span>a4185</div></pre></td></tr></table></figure>
<h3 id="åˆ†é…IPç»™å®¿ä¸»æœº"><a href="#åˆ†é…IPç»™å®¿ä¸»æœº" class="headerlink" title="åˆ†é…IPç»™å®¿ä¸»æœº"></a>åˆ†é…IPç»™å®¿ä¸»æœº</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ifconfig lo0 alias <span class="number">192.168</span><span class="number">.64</span><span class="number">.0</span>/<span class="number">24</span></div></pre></td></tr></table></figure>
<p>è®¿é—® <code>http://192.168.64.0:8080</code> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å®‰è£…-Docker&quot;&gt;&lt;a href=&quot;#å®‰è£…-Docker&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£… Docker&quot;&gt;&lt;/a&gt;å®‰è£… Docker&lt;/h3&gt;&lt;p&gt;Mac ä¸Šçš„å®‰è£…&lt;br&gt;&lt;figure class=&quot;highlight mipsa
    
    </summary>
    
      <category term="docker" scheme="http://peterfei.me/categories/docker/"/>
    
    
      <category term="docker" scheme="http://peterfei.me/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>ReactNativeä¹‹Realmé¢„åŠ è½½æ•°æ®</title>
    <link href="http://peterfei.me/2019/04/11/ReactNative%E4%B9%8BRealm%E9%A2%84%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE/"/>
    <id>http://peterfei.me/2019/04/11/ReactNativeä¹‹Realmé¢„åŠ è½½æ•°æ®/</id>
    <published>2019-04-11T03:28:51.000Z</published>
    <updated>2022-08-26T02:42:20.302Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>realm æ•°æ®é¢„åŠ è½½</p>
</blockquote>
<h5 id="Require-Env"><a href="#Require-Env" class="headerlink" title="Require Env:"></a>Require Env:</h5><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">npm</span> i realm</div><div class="line"><span class="built_in">npm</span> i react-<span class="keyword">native</span>-fs</div><div class="line">react-<span class="keyword">native</span> link</div></pre></td></tr></table></figure>
<p>åˆ†åˆ«æ‹·è´æ•°æ®åº“è‡³åŸç”Ÿå…¬ç”¨ç›®å½•</p>
<h5 id="Androidç«¯"><a href="#Androidç«¯" class="headerlink" title="Androidç«¯"></a>Androidç«¯</h5><p><code>android/app/src/main/assets/demo.realm</code></p>
<h5 id="IOSç«¯"><a href="#IOSç«¯" class="headerlink" title="IOSç«¯"></a>IOSç«¯</h5><p><code>Build Phases-&gt;Copy Bundle Resources-&gt;demo.realm</code></p>
<h5 id="å‰ç«¯"><a href="#å‰ç«¯" class="headerlink" title="å‰ç«¯"></a>å‰ç«¯</h5><p>æ‰§è¡ŒRealm æä¾›çš„copyBundledRealmFiles,å¯ä»¥å°†å…±ç”¨çš„æ•°æ®åº“æ–‡ä»¶æ‹·è´è‡³åº”ç”¨å®‰è£…çš„<code>Documents</code>ç›®å½•.</p>
<blockquote>
<p><code>Realm.copyBundledRealmFiles();</code></p>
</blockquote>
<h5 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h5><h5 id="prepare-realm-data-demo"><a href="#prepare-realm-data-demo" class="headerlink" title="prepare-realm-data-demo"></a><a href="https://github.com/peterfei/prepare-realm-data-demo" target="_blank" rel="external">prepare-realm-data-demo</a></h5>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;realm æ•°æ®é¢„åŠ è½½&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h5 id=&quot;Require-Env&quot;&gt;&lt;a href=&quot;#Require-Env&quot; class=&quot;headerlink&quot; title=&quot;Require Env:&quot;&gt;&lt;/a&gt;Requir
    
    </summary>
    
      <category term="å‰ç«¯" scheme="http://peterfei.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="react-native" scheme="http://peterfei.me/tags/react-native/"/>
    
      <category term="realm" scheme="http://peterfei.me/tags/realm/"/>
    
  </entry>
  
  <entry>
    <title>è®°IOSå¼€å‘ä¹‹æˆ‘æ˜¯å¦‚ä½•è§£å†³react-native-unity-viewæ’ä»¶åœ¨Productæ¨¡å¼é—ªé€€</title>
    <link href="http://peterfei.me/2019/04/10/%E8%AE%B0IOS%E5%BC%80%E5%8F%91%E4%B9%8B%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3react-native-unity-view%E6%8F%92%E4%BB%B6%E5%9C%A8Product%E6%A8%A1%E5%BC%8F%E9%97%AA%E9%80%80Bug/"/>
    <id>http://peterfei.me/2019/04/10/è®°IOSå¼€å‘ä¹‹æˆ‘æ˜¯å¦‚ä½•è§£å†³react-native-unity-viewæ’ä»¶åœ¨Productæ¨¡å¼é—ªé€€Bug/</id>
    <published>2019-04-10T01:44:13.000Z</published>
    <updated>2022-08-26T02:42:20.318Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p> äº‹ä»¶èµ·å› :</p>
<p>å…¬å¸åœ¨ä½¿ç”¨react-nativeå¼€å‘è§£å‰–3Dè½¯ä»¶,éœ€è¦å’Œunityè¿›è¡Œèåˆ,åœ¨ç»„ä»¶é€‰æ‹©ä¸Š,ä½¿ç”¨äº†react-native-unity-viewè¿™æ¬¾æ’ä»¶,åœ¨èåˆè¿‡ç¨‹ä¸­,è¸©äº†å¾ˆå¤šå‘,èŠ±è´¹ç²¾åŠ›æœ€å¤§çš„,æ˜¯å¹´åIOSå‡çº§ä¸º12.1å,é›†æˆæ–¹æ¡ˆé›†ä¸­å‡ºç°é—ªé€€.</p>
</blockquote>
<h5 id="Issue-79"><a href="#Issue-79" class="headerlink" title="Issue #79"></a>Issue #79</h5><p><a href="https://github.com/f111fei/react-native-unity-view/issues/79" target="_blank" rel="external">iOS crashes on launch in release builds only #79</a></p>
<blockquote>
<p>Cash log å¦‚ä¸‹</p>
</blockquote>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">Thread <span class="number">7</span> <span class="symbol">name:</span>  com.facebook.react.JavaScript</div><div class="line">Thread <span class="number">7</span> <span class="symbol">Crashed:</span></div><div class="line"><span class="number">0</span>   libsystem_kernel.dylib        	<span class="number">0x00000001fbbbd104</span> __pthread_kill + <span class="number">8</span></div><div class="line"><span class="number">1</span>   libsystem_pthread.dylib       	<span class="number">0x00000001fbc3ca00</span> pthread_kill<span class="variable">$VARIANT</span><span class="variable">$armv81</span> + <span class="number">296</span></div><div class="line"><span class="number">2</span>   libsystem_c.dylib             	<span class="number">0x00000001fbb14d78</span> abort + <span class="number">140</span></div><div class="line"><span class="number">3</span>   libsystem_malloc.dylib        	<span class="number">0x00000001fbc11768</span> _malloc_put + <span class="number">0</span></div><div class="line"><span class="number">4</span>   libsystem_malloc.dylib        	<span class="number">0x00000001fbc11924</span> malloc_report + <span class="number">64</span></div><div class="line"><span class="number">5</span>   libsystem_malloc.dylib        	<span class="number">0x00000001fbc042d0</span> free + <span class="number">376</span></div><div class="line"><span class="number">6</span>   libc++.<span class="number">1</span>.dylib                	<span class="number">0x00000001fb1bf120</span> <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt;<span class="symbol">:</span><span class="symbol">:~basic_string+</span> <span class="number">258336</span> () + <span class="number">32</span></div><div class="line"><span class="number">7</span>   UnityTest                     	<span class="number">0x0000000102de23a4</span> <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:__vector_base&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt; &gt;<span class="symbol">:</span><span class="symbol">:~__vector_base</span>() + <span class="number">730020</span> (<span class="symbol">vector:</span><span class="number">451</span>)</div><div class="line"><span class="number">8</span>   UnityTest                     	<span class="number">0x0000000103385214</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:ModuleRegistry</span><span class="symbol">:</span><span class="symbol">:getConfig+</span> <span class="number">6640148</span> (<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; const&amp;) + <span class="number">100</span></div><div class="line"><span class="number">9</span>   UnityTest                     	<span class="number">0x0000000103394168</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSCNativeModules</span><span class="symbol">:</span><span class="symbol">:createModule+</span> <span class="number">6701416</span> (<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; const&amp;, OpaqueJSContext const*) + <span class="number">292</span></div><div class="line"><span class="number">10</span>  UnityTest                     	<span class="number">0x0000000103393cc8</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSCNativeModules</span><span class="symbol">:</span><span class="symbol">:getModule+</span> <span class="number">6700232</span> (OpaqueJSContext const*, OpaqueJSString*) + <span class="number">188</span></div><div class="line"><span class="number">11</span>  UnityTest                     	<span class="number">0x000000010338e85c</span> OpaqueJSValue const* (*<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:</span>(anonymous namespace)<span class="symbol">:</span><span class="symbol">:exceptionWrapMethod&lt;&amp;</span>(<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSCExecutor</span><span class="symbol">:</span><span class="symbol">:getNativeModule</span>(OpaqueJSValue*, OpaqueJSString*))&gt;())(OpaqueJSContext const*, OpaqueJSValue*, OpaqueJSString*, OpaqueJSValue const**)<span class="symbol">:</span><span class="symbol">:funcWrapper</span><span class="symbol">:</span><span class="symbol">:call+</span> <span class="number">6678620</span> (OpaqueJSContext const*, OpaqueJSValue*, OpaqueJSString*, OpaqueJSValue const**) + <span class="number">104</span></div><div class="line"><span class="number">12</span>  JavaScriptCore                	<span class="number">0x0000000203350404</span> <span class="symbol">JSC:</span><span class="symbol">:JSCallbackObject&lt;JSC</span><span class="symbol">:</span><span class="symbol">:JSDestructibleObject&gt;</span><span class="symbol">:</span><span class="symbol">:getOwnPropertySlot+</span> <span class="number">574468</span> (<span class="symbol">JSC:</span><span class="symbol">:JSObject*</span>, <span class="symbol">JSC:</span><span class="symbol">:ExecState*</span>, <span class="symbol">JSC:</span><span class="symbol">:PropertyName</span>, <span class="symbol">JSC:</span><span class="symbol">:PropertySlot&amp;</span>) + <span class="number">340</span></div><div class="line"><span class="number">13</span>  JavaScriptCore                	<span class="number">0x0000000203a354f0</span> llint_slow_path_get_by_id + <span class="number">2008</span></div><div class="line"><span class="number">14</span>  JavaScriptCore                	<span class="number">0x0000000203328928</span> llint_entry + <span class="number">11528</span></div><div class="line"><span class="number">15</span>  JavaScriptCore                	<span class="number">0x000000020332d134</span> llint_entry + <span class="number">29972</span></div><div class="line"><span class="number">16</span>  JavaScriptCore                	<span class="number">0x000000020332d134</span> llint_entry + <span class="number">29972</span></div><div class="line"><span class="number">17</span>  JavaScriptCore                	<span class="number">0x000000020332d134</span> llint_entry + <span class="number">29972</span></div><div class="line"><span class="number">18</span>  JavaScriptCore                	<span class="number">0x000000020332d134</span> llint_entry + <span class="number">29972</span></div><div class="line"><span class="number">19</span>  JavaScriptCore                	<span class="number">0x000000020332d134</span> llint_entry + <span class="number">29972</span></div><div class="line"><span class="number">20</span>  JavaScriptCore                	<span class="number">0x0000000203325a1c</span> vmEntryToJavaScript + <span class="number">300</span></div><div class="line"><span class="number">21</span>  JavaScriptCore                	<span class="number">0x000000020399bfe4</span> <span class="symbol">JSC:</span><span class="symbol">:Interpreter</span><span class="symbol">:</span><span class="symbol">:executeProgram+</span> <span class="number">7176164</span> (<span class="symbol">JSC:</span><span class="symbol">:SourceCode</span> const&amp;, <span class="symbol">JSC:</span><span class="symbol">:ExecState*</span>, <span class="symbol">JSC:</span><span class="symbol">:JSObject*</span>) + <span class="number">9620</span></div><div class="line"><span class="number">22</span>  JavaScriptCore                	<span class="number">0x0000000203b77218</span> <span class="symbol">JSC:</span><span class="symbol">:evaluate+</span> <span class="number">9122328</span> (<span class="symbol">JSC:</span><span class="symbol">:ExecState*</span>, <span class="symbol">JSC:</span><span class="symbol">:SourceCode</span> const&amp;, <span class="symbol">JSC:</span><span class="symbol">:JSValue</span>, <span class="symbol">WTF:</span><span class="symbol">:NakedPtr&lt;JSC</span><span class="symbol">:</span><span class="symbol">:Exception&gt;&amp;</span>) + <span class="number">316</span></div><div class="line"><span class="number">23</span>  JavaScriptCore                	<span class="number">0x000000020334e634</span> JSEvaluateScript + <span class="number">472</span></div><div class="line"><span class="number">24</span>  UnityTest                     	<span class="number">0x000000010336dad0</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:evaluateScript+</span> <span class="number">6544080</span> (OpaqueJSContext const*, OpaqueJSString*, OpaqueJSString*) + <span class="number">80</span></div><div class="line"><span class="number">25</span>  UnityTest                     	<span class="number">0x000000010338c918</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSCExecutor</span><span class="symbol">:</span><span class="symbol">:loadApplicationScript+</span> <span class="number">6670616</span> (<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:unique_ptr&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:default_delete&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const&gt; &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt;) + <span class="number">528</span></div><div class="line"><span class="number">26</span>  UnityTest                     	<span class="number">0x0000000103392ba4</span> <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:__function</span><span class="symbol">:</span><span class="symbol">:__func&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:NativeToJsBridge</span><span class="symbol">:</span><span class="symbol">:loadApplication</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:unique_ptr&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:RAMBundleRegistry</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:default_delete&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:RAMBundleRegistry&gt;</span> &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:unique_ptr&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:default_delete&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const&gt; &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt;)<span class="symbol">:</span><span class="symbol">:</span><span class="variable">$_0</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:NativeToJsBridge</span><span class="symbol">:</span><span class="symbol">:loadApplication</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:unique_ptr&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:RAMBundleRegistry</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:default_delete&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:RAMBundleRegistry&gt;</span> &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:unique_ptr&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:default_delete&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const&gt; &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt;)<span class="symbol">:</span><span class="symbol">:</span><span class="variable">$_0</span>&gt;, void (<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSExecutor*</span>)&gt;<span class="symbol">:</span><span class="symbol">:operator</span>()+ <span class="number">6695844</span> (<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSExecutor*&amp;&amp;</span>) + <span class="number">144</span></div><div class="line"><span class="number">27</span>  UnityTest                     	<span class="number">0x0000000103393ba8</span> <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:function&lt;void</span> (<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSExecutor*</span>)&gt;<span class="symbol">:</span><span class="symbol">:operator</span>()+ <span class="number">6699944</span> (<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSExecutor*</span>) const + <span class="number">40</span></div><div class="line"><span class="number">28</span>  UnityTest                     	<span class="number">0x000000010330c9cc</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:tryAndReturnError</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:function&lt;void</span> + <span class="number">6146508</span> ()&gt; const&amp;) + <span class="number">24</span></div><div class="line"><span class="number">29</span>  UnityTest                     	<span class="number">0x0000000103302528</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:RCTMessageThread</span><span class="symbol">:</span><span class="symbol">:tryFunc</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:function&lt;void</span> + <span class="number">6104360</span> ()&gt; const&amp;) + <span class="number">24</span></div><div class="line"><span class="number">30</span>  CoreFoundation                	<span class="number">0x00000001fbfb6408</span> __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK_<span class="number">_</span> + <span class="number">20</span></div><div class="line"><span class="number">31</span>  CoreFoundation                	<span class="number">0x00000001fbfb5d08</span> __CFRunLoopDoBlocks + <span class="number">272</span></div><div class="line"><span class="number">32</span>  CoreFoundation                	<span class="number">0x00000001fbfb1220</span> __CFRunLoopRun + <span class="number">2376</span></div><div class="line"><span class="number">33</span>  CoreFoundation                	<span class="number">0x00000001fbfb05b8</span> CFRunLoopRunSpecific + <span class="number">436</span></div><div class="line"><span class="number">34</span>  UnityTest                     	<span class="number">0x00000001032e36a4</span> +[RCTCxxBridge runRunLoop] + <span class="number">264</span></div><div class="line"><span class="number">35</span>  Foundation                    	<span class="number">0x00000001fcad73b0</span> __NSThread__start_<span class="number">_</span> + <span class="number">1040</span></div><div class="line"><span class="number">36</span>  libsystem_pthread.dylib       	<span class="number">0x00000001fbc412fc</span> _pthread_body + <span class="number">128</span></div><div class="line"><span class="number">37</span>  libsystem_pthread.dylib       	<span class="number">0x00000001fbc4125c</span> _pthread_start + <span class="number">48</span></div><div class="line"><span class="number">38</span>  libsystem_pthread.dylib       	<span class="number">0x00000001fbc44d08</span> thread_start + <span class="number">4</span></div></pre></td></tr></table></figure>
<h5 id="æœ€åˆçš„è§£å†³æ–¹æ¡ˆ"><a href="#æœ€åˆçš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="æœ€åˆçš„è§£å†³æ–¹æ¡ˆ"></a>æœ€åˆçš„è§£å†³æ–¹æ¡ˆ</h5><ul>
<li>å‡çº§<code>react-native</code>ç‰ˆæœ¬åˆ°0.57.0</li>
<li><code>rm -fr node_modules</code></li>
<li>å‡çº§æ’ä»¶ç‰ˆæœ¬<code>react-native-unity-view&quot;: &quot;^1.2.1&quot;</code></li>
<li>åœ¨Xcodeé‡Œ<code>Setting &quot;Strip Linked Product&quot; to NO</code>  </li>
</ul>
<p>æˆåŠŸé˜»æ­¢äº†ç¼–è¯‘é—ªé€€,ä½†å‘å¸ƒåè¢«å®¡æ ¸å‘ŠçŸ¥é—ªé€€.æ¥æ¥å›å›å‡ æ¬¡å,ç»ˆäºé‡æ–°æµ‹è¯•å‘ç°,å±…ç„¶æ˜¯æ‰“åŒ…ä¸º<code>release IPA file</code>åæ‰å¼€å§‹é—ªé€€-_-!!</p>
<h5 id="å†æ¬¡å°è¯•"><a href="#å†æ¬¡å°è¯•" class="headerlink" title="å†æ¬¡å°è¯•"></a>å†æ¬¡å°è¯•</h5><p>ä¹‹ååœ¨issueé‡Œæé—®å›å¸–,å¾—åˆ°å¦‚ä¸‹æ–¹æ¡ˆ:</p>
<p>åœ¨é…ç½®æ–‡ä»¶é‡ŒåŠ å…¥</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">COPY_PHASE_STRIP</span> = <span class="literal">YES</span>;</div><div class="line"><span class="attr">ENABLE_BITCODE</span> = <span class="literal">NO</span>;</div><div class="line"><span class="attr">STRIP_INSTALLED_PRODUCT</span> = <span class="literal">NO</span>;</div></pre></td></tr></table></figure>
<p>ä¹‹ååœ¨æµ‹è¯•æœºä¸Šè¿è¡Œ,æ²¡æœ‰é—ªé€€.äºæ˜¯æäº¤å®¡æ ¸,å‘å¸ƒäº†ç‰ˆæœ¬.ä¹‹åæœ‰ç”¨æˆ·åé¦ˆåœ¨<code>IPHONE XS Max</code>ä¸Šé—ªé€€ <code>-_-!!!</code></p>
<h5 id="æœ€åçš„å°è¯•"><a href="#æœ€åçš„å°è¯•" class="headerlink" title="æœ€åçš„å°è¯•"></a>æœ€åçš„å°è¯•</h5><p>ä¹‹åç»§ç»­å›å¸–,åœ¨ <a href="https://github.com/JanOwiesniak" target="_blank" rel="external">JanOwiesniak</a>å’Œ<a href="https://github.com/mtostenson" target="_blank" rel="external">mtostenson </a>çš„å»ºè®®ä¸‹,è¿›è¡Œå¦‚ä¸‹æ”¹åŠ¨:</p>
<ul>
<li>using XCodes new build system or the legacy build system</li>
<li>Reinstall node_modues </li>
<li>Update Unity from 2018.2.14f1 to 2018.3.6f1</li>
<li>Build UnityExport</li>
<li>Patch UnityExport <a href="https://github.com/jiulongw/swift-unity/pull/120#issuecomment-456315250" target="_blank" rel="external">jiulongw/swift-unity#120 (comment)</a> <a href="https://github.com/f111fei/react-native-unity-view/issues/79#issuecomment-465819733" target="_blank" rel="external">#79 (comment)</a></li>
<li>Update react-native-unity-view to 1.3.3</li>
<li>Update react-native to 0.57+</li>
<li>Patch react-native moduleNames() <a href="https://github.com/f111fei/react-native-unity-view/issues/79#issuecomment-465110101" target="_blank" rel="external">(#79 (comment)</a></li>
<li>Add AVKit.framework in Xcode</li>
</ul>
<h5 id="æœ€ç»ˆæˆåŠŸè§£å†³iphone-xs-max-12-1å…¼å®¹"><a href="#æœ€ç»ˆæˆåŠŸè§£å†³iphone-xs-max-12-1å…¼å®¹" class="headerlink" title="æœ€ç»ˆæˆåŠŸè§£å†³iphone xs max 12.1å…¼å®¹"></a>æœ€ç»ˆæˆåŠŸè§£å†³iphone xs max 12.1å…¼å®¹</h5>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt; äº‹ä»¶èµ·å› :&lt;/p&gt;
&lt;p&gt;å…¬å¸åœ¨ä½¿ç”¨react-nativeå¼€å‘è§£å‰–3Dè½¯ä»¶,éœ€è¦å’Œunityè¿›è¡Œèåˆ,åœ¨ç»„ä»¶é€‰æ‹©ä¸Š,ä½¿ç”¨äº†react-native-unity-viewè¿™æ¬¾æ’ä»¶,åœ¨èåˆè¿‡ç¨‹ä¸­,è¸©äº†å¾ˆå¤šå‘,èŠ±è´¹ç²¾åŠ›æœ€å¤§çš„,æ˜¯å¹´åIOSå‡çº§ä¸º12.
    
    </summary>
    
      <category term="IOS" scheme="http://peterfei.me/categories/IOS/"/>
    
    
      <category term="IOS" scheme="http://peterfei.me/tags/IOS/"/>
    
      <category term="React-native" scheme="http://peterfei.me/tags/React-native/"/>
    
      <category term="react-native-unity-view" scheme="http://peterfei.me/tags/react-native-unity-view/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨WPFåŠ è½½Unityå¯æ‰§è¡Œç¨‹åº</title>
    <link href="http://peterfei.me/2019/04/09/%E4%BD%BF%E7%94%A8WPF%E5%8A%A0%E8%BD%BDUnity%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F/"/>
    <id>http://peterfei.me/2019/04/09/ä½¿ç”¨WPFåŠ è½½Unityå¯æ‰§è¡Œç¨‹åº/</id>
    <published>2019-04-09T03:23:31.000Z</published>
    <updated>2022-08-26T02:42:20.315Z</updated>
    
    <content type="html"><![CDATA[<p>  å…¬å¸æœ‰å¼€å‘wpféœ€æ±‚,æ¨¡å‹ä¸»è¦æ˜¯ç”±Unityå¼€å‘,å¯¼å‡ºåæ˜¯<code>.exe</code>å¯æ‰§è¡Œç¨‹åº,<br>å¤–å±‚æ˜¯åˆ©ç”¨react-nativeç¼–å†™ç•Œé¢,ä¸»è¦ç»„ä»¶ä¸ºreact-native-windows,äºæ˜¯éœ€è¦èåˆäºŒè€….<br>  é¦–å…ˆæ˜¯å†™å…¥wpfè°ƒç”¨å¤–éƒ¨<code>exe</code>ç»„ä»¶:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Diagnostics;</div><div class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</div><div class="line"><span class="keyword">using</span> System.Windows;</div><div class="line"><span class="keyword">using</span> System.Windows.Interop;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Vesal_PC</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// GameHost is a FrameworkElement and can be added to controls like so:</span></div><div class="line">    <span class="comment">// var gameHost = new GameHost(container.ActualWidth, container.ActualHeight);</span></div><div class="line">    <span class="comment">// container.Child = gameHost;</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// Sources:</span></div><div class="line">    <span class="comment">// - https://msdn.microsoft.com/en-us/library/ms752055.aspx</span></div><div class="line">    <span class="comment">// - Another source I can't remember or find, concerning running a standalone Unity process using parentHWND parameter</span></div><div class="line">    </div><div class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">GameHost</span> : <span class="title">HwndHost</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> WS_CHILD = <span class="number">0x40000000</span>;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> WS_VISIBLE = <span class="number">0x10000000</span>;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> HOST_ID = <span class="number">0x00000002</span>;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> IntPtr hwndHost;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> hostHeight, hostWidth;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> Process process;</div><div class="line">        <span class="keyword">private</span> IntPtr unityHWND = IntPtr.Zero;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> WM_ACTIVATE = <span class="number">0x0006</span>;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IntPtr WA_ACTIVE = <span class="keyword">new</span> IntPtr(<span class="number">1</span>);</div><div class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IntPtr WA_INACTIVE = <span class="keyword">new</span> IntPtr(<span class="number">0</span>);</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">GameHost</span>(<span class="params"><span class="keyword">double</span> width, <span class="keyword">double</span> height</span>)</span></div><div class="line">        &#123;</div><div class="line">            hostHeight = (<span class="keyword">int</span>)height;</div><div class="line">            hostWidth = (<span class="keyword">int</span>)width;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> HandleRef <span class="title">BuildWindowCore</span>(<span class="params">HandleRef hwndParent</span>)</span></div><div class="line">        &#123;</div><div class="line">            hwndHost = IntPtr.Zero;</div><div class="line"></div><div class="line">            hwndHost = CreateWindowEx(<span class="number">0</span>, <span class="string">"static"</span>, <span class="string">""</span>,</div><div class="line">                                      WS_CHILD | WS_VISIBLE,</div><div class="line">                                      <span class="number">0</span>, <span class="number">0</span>,</div><div class="line">                                      hostWidth, hostHeight,</div><div class="line">                                      hwndParent.Handle,</div><div class="line">                                      (IntPtr)HOST_ID,</div><div class="line">                                      IntPtr.Zero,</div><div class="line">                                      <span class="number">0</span>);</div><div class="line"></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">try</span></div><div class="line">                &#123;</div><div class="line">                    process = <span class="keyword">new</span> Process();</div><div class="line">                    process.StartInfo.FileName = AppDomain.CurrentDomain.BaseDirectory + <span class="string">"win/vesal.exe"</span>;</div><div class="line">                    process.StartInfo.Arguments = <span class="string">"-parentHWND "</span> + hwndHost.ToInt32() + <span class="string">" "</span> + Environment.CommandLine;</div><div class="line">                    process.StartInfo.UseShellExecute = <span class="literal">true</span>;</div><div class="line">                    process.StartInfo.CreateNoWindow = <span class="literal">true</span>;</div><div class="line"></div><div class="line">                    process.Start();</div><div class="line"></div><div class="line">                    process.WaitForInputIdle();</div><div class="line">                    <span class="comment">// Doesn't work for some reason ?!</span></div><div class="line">                    <span class="comment">//unityHWND = process.MainWindowHandle;</span></div><div class="line">                    EnumChildWindows(hwndHost, WindowEnum, IntPtr.Zero);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">catch</span> (Exception ex)</div><div class="line">                &#123;</div><div class="line">                    MessageBox.Show(ex.Message + <span class="string">"GameHost: Could not find game executable."</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> HandleRef(<span class="keyword">this</span>, hwndHost);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DestroyWindowCore</span>(<span class="params">HandleRef hwnd</span>)</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                process.CloseMainWindow();</div><div class="line"></div><div class="line">                System.Threading.Thread.Sleep(<span class="number">1000</span>);</div><div class="line">                <span class="keyword">while</span> (process.HasExited == <span class="literal">false</span>)</div><div class="line">                    process.Kill();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception)</div><div class="line">            &#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            DestroyWindow(hwnd.Handle);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ActivateUnityWindow</span>(<span class="params"></span>)</span></div><div class="line">        &#123;</div><div class="line">            SendMessage(unityHWND, WM_ACTIVATE, WA_ACTIVE, IntPtr.Zero);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DeactivateUnityWindow</span>(<span class="params"></span>)</span></div><div class="line">        &#123;</div><div class="line">            SendMessage(unityHWND, WM_ACTIVATE, WA_INACTIVE, IntPtr.Zero);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> IntPtr <span class="title">WndProc</span>(<span class="params">IntPtr hwnd, <span class="keyword">int</span> msg, IntPtr wParam, IntPtr lParam, <span class="keyword">ref</span> <span class="keyword">bool</span> handled</span>)</span></div><div class="line">        &#123;</div><div class="line">            handled = <span class="literal">false</span>;</div><div class="line">            <span class="keyword">return</span> IntPtr.Zero;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">WindowEnum</span>(<span class="params">IntPtr hwnd, IntPtr lparam</span>)</span></div><div class="line">        &#123;</div><div class="line">            unityHWND = hwnd;</div><div class="line">            ActivateUnityWindow();</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//PInvoke declarations</span></div><div class="line">        [DllImport(<span class="string">"user32.dll"</span>, EntryPoint = <span class="string">"CreateWindowEx"</span>, CharSet = CharSet.Unicode)]</div><div class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">CreateWindowEx</span>(<span class="params"><span class="keyword">int</span> dwExStyle,</span></span></div><div class="line">                                                      <span class="keyword">string</span> lpszClassName,</div><div class="line">                                                      <span class="keyword">string</span> lpszWindowName,</div><div class="line">                                                      <span class="keyword">int</span> style,</div><div class="line">                                                      <span class="keyword">int</span> x, <span class="keyword">int</span> y,</div><div class="line">                                                      <span class="keyword">int</span> width, <span class="keyword">int</span> height,</div><div class="line">                                                      IntPtr hwndParent,</div><div class="line">                                                      IntPtr hMenu,</div><div class="line">                                                      IntPtr hInst,</div><div class="line">                                                      [MarshalAs(UnmanagedType.AsAny)] <span class="keyword">object</span> pvParam);</div><div class="line"></div><div class="line">        [DllImport(<span class="string">"user32.dll"</span>, EntryPoint = <span class="string">"DestroyWindow"</span>, CharSet = CharSet.Unicode)]</div><div class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">DestroyWindow</span>(<span class="params">IntPtr hwnd</span>)</span>;</div><div class="line"></div><div class="line">        [DllImport(<span class="string">"User32.dll"</span>)]</div><div class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">MoveWindow</span>(<span class="params">IntPtr handle, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">bool</span> redraw</span>)</span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">delegate</span> <span class="keyword">int</span> <span class="title">WindowEnumProc</span>(<span class="params">IntPtr hwnd, IntPtr lparam</span>)</span>;</div><div class="line">        [DllImport(<span class="string">"user32.dll"</span>)]</div><div class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">EnumChildWindows</span>(<span class="params">IntPtr hwnd, WindowEnumProc func, IntPtr lParam</span>)</span>;</div><div class="line"></div><div class="line">        [DllImport(<span class="string">"user32.dll"</span>)]</div><div class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">SendMessage</span>(<span class="params">IntPtr hWnd, <span class="keyword">int</span> msg, IntPtr wParam, IntPtr lParam</span>)</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¼–å†™react-native UnityViewç»„ä»¶:</p>
<blockquote>
<p>ReactUnityManager.cs</p>
</blockquote>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Copyright (c) Microsoft Corporation. All rights reserved.</span></div><div class="line"><span class="comment">// Portions derived from React Native:</span></div><div class="line"><span class="comment">// Copyright (c) 2015-present, Facebook, Inc.</span></div><div class="line"><span class="comment">// Licensed under the MIT License.</span></div><div class="line"></div><div class="line"><span class="keyword">using</span> Newtonsoft.Json.Linq;</div><div class="line"><span class="keyword">using</span> ReactNative.Collections;</div><div class="line"><span class="keyword">using</span> ReactNative.Modules.Image;</div><div class="line"><span class="keyword">using</span> ReactNative.UIManager;</div><div class="line"><span class="keyword">using</span> ReactNative.UIManager.Annotations;</div><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Concurrent;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Threading;</div><div class="line"><span class="keyword">using</span> System.Windows.Controls;</div><div class="line"></div><div class="line">namespace Vesal_PC</div><div class="line">&#123;</div><div class="line">    <span class="comment">/// &lt;summary&gt;</span></div><div class="line">    <span class="comment">/// The view manager responsible for rendering native images.</span></div><div class="line">    <span class="comment">/// &lt;/summary&gt;</span></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactUnityManager</span> : <span class="title">SimpleViewManager</span>&lt;<span class="title">Border</span>&gt;</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">private</span> readonly ConcurrentDictionary&lt;Border, List&lt;KeyValuePair&lt;string, double&gt;&gt;&gt; _imageSources =</div><div class="line">            <span class="keyword">new</span> <span class="type">ConcurrentDictionary</span>&lt;Border, List&lt;KeyValuePair&lt;string, double&gt;&gt;&gt;();</div><div class="line">        Border view;</div><div class="line"></div><div class="line">        <span class="comment">/// &lt;summary&gt;</span></div><div class="line">        <span class="comment">/// The view manager name.</span></div><div class="line">        <span class="comment">/// &lt;/summary&gt;</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">override</span> string Name</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">get</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">return</span> <span class="string">"RCTUnityView"</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/// &lt;summary&gt;</span></div><div class="line">        <span class="comment">/// The view manager event constants.</span></div><div class="line">        <span class="comment">/// &lt;/summary&gt;</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">override</span> JObject CustomDirectEventTypeConstants</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">get</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">JObject</span></div><div class="line">                &#123;</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"topLoadStart"</span>,</div><div class="line">                        <span class="keyword">new</span> <span class="type">JObject</span></div><div class="line">                        &#123;</div><div class="line">                            &#123; <span class="string">"registrationName"</span>, <span class="string">"onLoadStart"</span> &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"topLoad"</span>,</div><div class="line">                        <span class="keyword">new</span> <span class="type">JObject</span></div><div class="line">                        &#123;</div><div class="line">                            &#123; <span class="string">"registrationName"</span>, <span class="string">"onLoad"</span> &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"topLoadEnd"</span>,</div><div class="line">                        <span class="keyword">new</span> <span class="type">JObject</span></div><div class="line">                        &#123;</div><div class="line">                            &#123; <span class="string">"registrationName"</span>, <span class="string">"onLoadEnd"</span> &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"topError"</span>,</div><div class="line">                        <span class="keyword">new</span> <span class="type">JObject</span></div><div class="line">                        &#123;</div><div class="line">                            &#123; <span class="string">"registrationName"</span>, <span class="string">"onError"</span> &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                &#125;;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        </div><div class="line"></div><div class="line">        <span class="comment">/// &lt;summary&gt;</span></div><div class="line">        <span class="comment">/// Called when view is detached from view hierarchy and allows for </span></div><div class="line">        <span class="comment">/// additional cleanup.</span></div><div class="line">        <span class="comment">/// &lt;/summary&gt;</span></div><div class="line">        <span class="comment">/// &lt;param name="reactContext"&gt;The React context.&lt;/param&gt;</span></div><div class="line">        <span class="comment">/// &lt;param name="view"&gt;The view.&lt;/param&gt;</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">override</span> void OnDropViewInstance(ThemedReactContext reactContext, Border view)</div><div class="line">        &#123;</div><div class="line">            base.OnDropViewInstance(reactContext, view);</div><div class="line"></div><div class="line">            _imageSources.TryRemove(view, out <span class="literal">_</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        [ReactPropGroup(</div><div class="line">            ViewProps.BorderWidth,</div><div class="line">            ViewProps.BorderLeftWidth,</div><div class="line">            ViewProps.BorderRightWidth,</div><div class="line">            ViewProps.BorderTopWidth,</div><div class="line">            ViewProps.BorderBottomWidth,</div><div class="line">            DefaultDouble = double.NaN)]</div><div class="line"></div><div class="line">         </div><div class="line">        <span class="keyword">public</span> void SetBorderWidth(Border view, int index, double width)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> _width = width;</div><div class="line">            <span class="comment">//view.SetBorderWidth(ViewProps.BorderSpacingTypes[index], width);</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">/// &lt;summary&gt;</span></div><div class="line">        <span class="comment">/// Creates the image view instance.</span></div><div class="line">        <span class="comment">/// &lt;/summary&gt;</span></div><div class="line">        <span class="comment">/// &lt;param name="reactContext"&gt;The React context.&lt;/param&gt;</span></div><div class="line">        <span class="comment">/// &lt;returns&gt;The image view instance.&lt;/returns&gt;</span></div><div class="line">        protected <span class="keyword">override</span> Border CreateViewInstance(ThemedReactContext reactContext)</div><div class="line">        &#123;</div><div class="line"></div><div class="line">           </div><div class="line">            <span class="keyword">var</span> border = <span class="keyword">new</span> <span class="type">Border</span></div><div class="line">            &#123;</div><div class="line">                </div><div class="line">            &#125;;</div><div class="line">            <span class="keyword">var</span> gameHost = <span class="keyword">new</span> <span class="type">GameHost</span>((int)MainWindow.mw.ActualWidth, (int)MainWindow.mw.ActualHeight<span class="number">-60</span>);</div><div class="line">            <span class="comment">// container.Child = gameHost;</span></div><div class="line">            border.Child = gameHost;</div><div class="line">            <span class="keyword">var</span> a = view;</div><div class="line">            <span class="keyword">return</span> border;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨å†Œç»„ä»¶:</p>
<blockquote>
<p>MyReactPage.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> ReactNative.Bridge;</div><div class="line"><span class="keyword">using</span> ReactNative.Modules.Core;</div><div class="line"><span class="keyword">using</span> ReactNative.UIManager;</div><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> System.Threading.Tasks;</div><div class="line"><span class="keyword">using</span> Vesal_PC.MyModel;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Vesal_PC</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyReactPage</span> : <span class="title">IReactPackage</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> ReactContext context;</div><div class="line">        <span class="function"><span class="keyword">public</span> IReadOnlyList&lt;INativeModule&gt; <span class="title">CreateNativeModules</span>(<span class="params">ReactContext reactContext</span>)</span></div><div class="line">        &#123;</div><div class="line">            context = reactContext;</div><div class="line">            MyDialogModel mdm = <span class="keyword">new</span> MyDialogModel(reactContext);</div><div class="line">        </div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> List&lt;INativeModule&gt;</div><div class="line">        &#123;</div><div class="line">               mdm,</div><div class="line">        &#125;;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> IReadOnlyList&lt;IViewManager&gt; <span class="title">CreateViewManagers</span>(<span class="params">ReactContext reactContext</span>)</span></div><div class="line">        &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> List&lt;IViewManager&gt; &#123;</div><div class="line">                    <span class="keyword">new</span> ReactUnityManager()</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>AppReactPage.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> ReactNative;</div><div class="line"><span class="keyword">using</span> ReactNative.Bridge;</div><div class="line"><span class="keyword">using</span> ReactNative.Modules.Core;</div><div class="line"><span class="keyword">using</span> ReactNative.Shell;</div><div class="line"><span class="keyword">using</span> ReactNative.UIManager;</div><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> ReactNative.Modules.Dialog;</div><div class="line"><span class="keyword">namespace</span> <span class="title">Vesal_PC</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">AppReactPage</span> : <span class="title">ReactPage</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> MainComponentName =&gt; <span class="string">"Vesal_PC"</span>;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> JavaScriptMainModuleName =&gt; <span class="string">"index"</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> BUNDLE</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> JavaScriptBundleFile =&gt; AppDomain.CurrentDomain.BaseDirectory + <span class="string">"ReactAssets/index.wpf.bundle"</span>;</div><div class="line">        </div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">override</span> List&lt;IReactPackage&gt; Packages =&gt; <span class="keyword">new</span> List&lt;IReactPackage&gt;</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">new</span> MainReactPackage(),</div><div class="line">            <span class="keyword">new</span> MyReactPage(),</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> UseDeveloperSupport</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">get</span></div><div class="line">            &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !BUNDLE || DEBUG</span></div><div class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        </div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‰ç«¯:</p>
<blockquote>
<p>UnityView.js </p>
</blockquote>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; <span class="type">PropTypes</span>, <span class="type">Component</span> &#125; from <span class="string">"react"</span>;</div><div class="line"><span class="keyword">import</span> &#123; requireNativeComponent, <span class="type">View</span>, <span class="type">ViewPropTypes</span> &#125; from <span class="string">"react-native"</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnityView</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> &lt;<span class="type">RCTUnityView</span> &#123;...<span class="keyword">this</span>.props&#125; /&gt;;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">module.exports = requireNativeComponent(<span class="string">"RCTUnityView"</span>, <span class="type">UnityView</span>);</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨:<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;UnityView <span class="built_in">style</span>=&#123;&#123;<span class="built_in">width</span>:<span class="number">1680</span>,<span class="built_in">height</span>:<span class="number">1050</span>&#125;&#125;/&gt;</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;  å…¬å¸æœ‰å¼€å‘wpféœ€æ±‚,æ¨¡å‹ä¸»è¦æ˜¯ç”±Unityå¼€å‘,å¯¼å‡ºåæ˜¯&lt;code&gt;.exe&lt;/code&gt;å¯æ‰§è¡Œç¨‹åº,&lt;br&gt;å¤–å±‚æ˜¯åˆ©ç”¨react-nativeç¼–å†™ç•Œé¢,ä¸»è¦ç»„ä»¶ä¸ºreact-native-windows,äºæ˜¯éœ€è¦èåˆäºŒè€….&lt;br&gt;  é¦–å…ˆæ˜¯å†™å…¥wpfè°ƒç”¨å¤–éƒ¨&lt;co
    
    </summary>
    
      <category term="WPF" scheme="http://peterfei.me/categories/WPF/"/>
    
    
  </entry>
  
  <entry>
    <title>æœåŠ¡å™¨ç›‘æ§è„šæœ¬</title>
    <link href="http://peterfei.me/2019/04/09/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%91%E6%8E%A7%E8%84%9A%E6%9C%AC/"/>
    <id>http://peterfei.me/2019/04/09/æœåŠ¡å™¨ç›‘æ§è„šæœ¬/</id>
    <published>2019-04-09T00:52:58.000Z</published>
    <updated>2022-08-26T02:42:20.317Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>monitor.py</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coding:utf-8</span></div><div class="line"><span class="comment"># ï¼/usr/bin/env python3</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">from</span> aliyunsdkdysmsapi.request.v20170525 <span class="keyword">import</span> SendSmsRequest</div><div class="line"><span class="keyword">from</span> aliyunsdkdysmsapi.request.v20170525 <span class="keyword">import</span> QuerySendDetailsRequest</div><div class="line"><span class="keyword">from</span> aliyunsdkcore.client <span class="keyword">import</span> AcsClient</div><div class="line"><span class="keyword">import</span> uuid</div><div class="line"><span class="keyword">from</span> aliyunsdkcore.profile <span class="keyword">import</span> region_provider</div><div class="line"><span class="keyword">from</span> aliyunsdkcore.http <span class="keyword">import</span> method_type <span class="keyword">as</span> MT</div><div class="line"><span class="keyword">from</span> aliyunsdkcore.http <span class="keyword">import</span> format_type <span class="keyword">as</span> FT</div><div class="line"><span class="keyword">import</span> const</div><div class="line"><span class="comment"># from config import Alarm_cache</span></div><div class="line"><span class="keyword">from</span> config <span class="keyword">import</span> Settings</div><div class="line"></div><div class="line"><span class="comment"># ç›‘æ§é€»è¾‘</span></div><div class="line"></div><div class="line"><span class="comment"># æ³¨æ„ï¼šä¸è¦æ›´æ”¹</span></div><div class="line">REGION = <span class="string">"cn-hangzhou"</span></div><div class="line">PRODUCT_NAME = <span class="string">"Dysmsapi"</span></div><div class="line">DOMAIN = <span class="string">"dysmsapi.aliyuncs.com"</span></div><div class="line"></div><div class="line">acs_client = AcsClient(const.ACCESS_KEY_ID, const.ACCESS_KEY_SECRET, REGION)</div><div class="line">region_provider.add_endpoint(PRODUCT_NAME, REGION, DOMAIN)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_sms</span><span class="params">(phone_numbers, sign_name, template_code, template_param=None)</span>:</span></div><div class="line">    smsRequest = SendSmsRequest.SendSmsRequest()</div><div class="line">    <span class="comment"># ç”³è¯·çš„çŸ­ä¿¡æ¨¡æ¿ç¼–ç ,å¿…å¡«</span></div><div class="line">    smsRequest.set_TemplateCode(template_code)</div><div class="line"></div><div class="line">    <span class="comment"># çŸ­ä¿¡æ¨¡æ¿å˜é‡å‚æ•°</span></div><div class="line">    <span class="keyword">if</span> template_param <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        smsRequest.set_TemplateParam(template_param)</div><div class="line"></div><div class="line">    <span class="comment"># çŸ­ä¿¡ç­¾å</span></div><div class="line">    smsRequest.set_SignName(sign_name)</div><div class="line"></div><div class="line">    <span class="comment"># æ•°æ®æäº¤æ–¹å¼</span></div><div class="line">    <span class="comment"># smsRequest.set_method(MT.POST)</span></div><div class="line"></div><div class="line">    <span class="comment"># æ•°æ®æäº¤æ ¼å¼</span></div><div class="line">    <span class="comment"># smsRequest.set_accept_format(FT.JSON)</span></div><div class="line"></div><div class="line">    <span class="comment"># çŸ­ä¿¡å‘é€çš„å·ç åˆ—è¡¨ï¼Œå¿…å¡«ã€‚</span></div><div class="line">    smsRequest.set_PhoneNumbers(phone_numbers)</div><div class="line"></div><div class="line">    <span class="comment"># è°ƒç”¨çŸ­ä¿¡å‘é€æ¥å£ï¼Œè¿”å›json</span></div><div class="line">    smsResponse = acs_client.do_action_with_exception(smsRequest)</div><div class="line"></div><div class="line">    <span class="comment"># TODO ä¸šåŠ¡å¤„ç†</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> smsResponse</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">monitor</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'***å¯åŠ¨ç›‘æ§***'</span>)</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        ports = [<span class="number">8000</span>, <span class="number">8001</span>, <span class="number">8002</span>]</div><div class="line">        <span class="keyword">for</span> port <span class="keyword">in</span> ports:</div><div class="line">            check_url = <span class="string">"http://api.XXX.cn:%s/server?type=0"</span> % (</div><div class="line">                port)</div><div class="line">            command = <span class="string">"curl -I -m 30 -o /dev/null -s -w %&#123;http_code&#125; "</span> + check_url</div><div class="line">            http_code = os.popen(command).read()</div><div class="line">            print(<span class="string">"ping %s çŠ¶æ€ç ä¸º%s"</span> % (check_url, http_code))</div><div class="line">            <span class="keyword">if</span> http_code != <span class="string">"200"</span>:</div><div class="line">                <span class="comment"># Alarm_cache["ping_error"].append(diff)</span></div><div class="line">                <span class="comment"># å‘çŸ­ä¿¡</span></div><div class="line">                print(<span class="string">"###å‘é€çŸ­ä¿¡ç»™ç›¸å…³çš„äºº###"</span>)</div><div class="line">                params = <span class="string">"&#123;\"interface\":\"%s\"&#125;"</span> % (port)</div><div class="line">                <span class="keyword">for</span> phone <span class="keyword">in</span> Settings[<span class="string">"alarm_phones"</span>]:</div><div class="line">                    print(send_sms(phone, <span class="string">"thisissignname"</span>, <span class="string">"SMS_99999999"</span>, params))</div><div class="line">        time.sleep(<span class="number">300</span>)</div><div class="line">        print(<span class="string">'5åˆ†é’Ÿåæ£€æŸ¥'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    monitor()</div></pre></td></tr></table></figure>
<blockquote>
<p>config.py</p>
</blockquote>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># coding:utf-8</span></div><div class="line">Alarm_cache = &#123;</div><div class="line">    <span class="string">"ping_error"</span>: []</div><div class="line">&#125;</div><div class="line"><span class="meta"># é…ç½®</span></div><div class="line">Settings = &#123;</div><div class="line">    <span class="string">"alarm_phones"</span>: [<span class="string">'thisiscellphone'</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;monitor.py&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;d
    
    </summary>
    
      <category term="Python" scheme="http://peterfei.me/categories/Python/"/>
    
    
      <category term="python" scheme="http://peterfei.me/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Android è°ƒè¯•|æ—¥å¿—è„šæœ¬</title>
    <link href="http://peterfei.me/2019/04/08/Android-%E8%B0%83%E8%AF%95-%E6%97%A5%E5%BF%97%E8%84%9A%E6%9C%AC/"/>
    <id>http://peterfei.me/2019/04/08/Android-è°ƒè¯•-æ—¥å¿—è„šæœ¬/</id>
    <published>2019-04-08T09:04:56.000Z</published>
    <updated>2022-08-26T02:42:20.298Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">PackageName=<span class="variable">$1</span></div><div class="line"></div><div class="line"><span class="comment">#PackageName=com.example.appinfomanagertinno</span></div><div class="line">pid=<span class="string">"<span class="variable">$(adb shell ps | grep $PackageName | awk '&#123;print $2&#125;')</span>"</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"PackageName-----"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$PackageName</span>"</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"-----------------------------------------"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"-----------------------------------------"</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"pid-----"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$pid</span>"</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"-----------------------------------------"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"-----------------------------------------"</span></div><div class="line"></div><div class="line">adb logcat | grep <span class="variable">$pid</span></div></pre></td></tr></table></figure>
<blockquote>
<p>ä½¿ç”¨æ–¹æ³•<br><code>./logcat_package.sh com.XXX.XXX</code></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div
    
    </summary>
    
      <category term="å‰ç«¯" scheme="http://peterfei.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="Android" scheme="http://peterfei.me/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ç™¾åº¦è¯­éŸ³tts Android9.0 å‘éŸ³è§£å†³åŠæ³•</title>
    <link href="http://peterfei.me/2019/04/08/%E7%99%BE%E5%BA%A6%E8%AF%AD%E9%9F%B3tts-Android9-0-%E5%8F%91%E9%9F%B3%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"/>
    <id>http://peterfei.me/2019/04/08/ç™¾åº¦è¯­éŸ³tts-Android9-0-å‘éŸ³è§£å†³åŠæ³•/</id>
    <published>2019-04-08T08:58:00.000Z</published>
    <updated>2022-08-26T02:42:20.317Z</updated>
    
    <content type="html"><![CDATA[<p>ç™¾åº¦è¯­éŸ³åœ¨Android9.0ä¸èƒ½å‘éŸ³è§£å†³åŠæ³•:<br>åœ¨ <code>AndroidManifest.xml</code> <code>&lt;application&gt;</code>ä¸‹åŠ å…¥:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-library <span class="string">android:</span>name=<span class="string">"org.apache.http.legacy"</span> <span class="string">android:</span>required=<span class="string">"false"</span>/&gt;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç™¾åº¦è¯­éŸ³åœ¨Android9.0ä¸èƒ½å‘éŸ³è§£å†³åŠæ³•:&lt;br&gt;åœ¨ &lt;code&gt;AndroidManifest.xml&lt;/code&gt; &lt;code&gt;&amp;lt;application&amp;gt;&lt;/code&gt;ä¸‹åŠ å…¥:&lt;/p&gt;
&lt;figure class=&quot;highlight groovy&quot;&gt;
    
    </summary>
    
      <category term="å‰ç«¯" scheme="http://peterfei.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="ç™¾åº¦ android9.0" scheme="http://peterfei.me/tags/%E7%99%BE%E5%BA%A6-android9-0/"/>
    
  </entry>
  
  <entry>
    <title>Swifté«˜çº§ç¯‡</title>
    <link href="http://peterfei.me/2016/12/20/Swift%E9%AB%98%E7%BA%A7%E7%AF%87/"/>
    <id>http://peterfei.me/2016/12/20/Swifté«˜çº§ç¯‡/</id>
    <published>2016-12-20T05:55:50.000Z</published>
    <updated>2022-08-26T02:42:20.305Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‰©å±•-Extension"><a href="#æ‰©å±•-Extension" class="headerlink" title="æ‰©å±•(Extension)"></a>æ‰©å±•(Extension)</h2><p>ä»»åŠ¡ï¼š æ±‚æ•°å­—çš„å¹³æ–¹ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// èœé¸Ÿç‰ˆ</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">square</span><span class="params">(x: Int)</span></span> -&gt; <span class="type">Int</span> &#123; <span class="keyword">return</span> x * x &#125;</div><div class="line"><span class="keyword">var</span> squaredOfFive = square(x: <span class="number">5</span>)</div><div class="line">square(x: squaredOfFive) <span class="comment">// 625</span></div></pre></td></tr></table></figure>
<p>ä¸ºäº†æ±‚5çš„å››æ¬¡æ–¹æˆ‘ä»¬è¢«è¿«åˆ›å»ºå˜é‡ squaredOfFive â€” é«˜æ‰‹å¯ä¸å–œæ¬¢è¢«è¿«å®šä¹‰ä¸€ä¸ªæ— ç”¨çš„å˜é‡ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é«˜æ‰‹ç‰ˆ</span></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Int</span> </span>&#123; </div><div class="line"> <span class="keyword">var</span> squared: <span class="type">Int</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span> * <span class="keyword">self</span> &#125;</div><div class="line">&#125;</div><div class="line"><span class="number">5</span>.squared <span class="comment">// 25</span></div><div class="line"><span class="number">5</span>.squared.squared <span class="comment">// 625</span></div></pre></td></tr></table></figure>
<h2 id="æ³›å‹-Generics"><a href="#æ³›å‹-Generics" class="headerlink" title="æ³›å‹(Generics)"></a>æ³›å‹(Generics)</h2><p>ä»»åŠ¡ï¼šæ‰“å°è¾“å‡ºæ•°ç»„å†…æ‰€æœ‰çš„å…ƒç´ ã€‚<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// èœé¸Ÿç‰ˆ</span></div><div class="line"><span class="selector-tag">var</span> stringArray = [<span class="string">"è‹è€å¸ˆ"</span>, <span class="string">"èŒƒè€å¸ˆ"</span>, <span class="string">"ä¼˜è¡£åº“"</span>]</div><div class="line"><span class="selector-tag">var</span> intArray = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</div><div class="line"><span class="selector-tag">var</span> doubleArray = [<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>]</div><div class="line">func printStringArray(<span class="selector-tag">a</span>: [String]) &#123; </div><div class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> <span class="selector-tag">a</span> &#123; </div><div class="line">              print(s) </div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line">func printIntArray(<span class="selector-tag">a</span>: [Int]) &#123; <span class="keyword">for</span> <span class="selector-tag">i</span> <span class="keyword">in</span> <span class="selector-tag">a</span> &#123; print(i) &#125; &#125;</div><div class="line">func printDoubleArray(<span class="selector-tag">a</span>: [Double]) &#123;<span class="keyword">for</span> d <span class="keyword">in</span> <span class="selector-tag">a</span> &#123; print(d) &#125; &#125;</div></pre></td></tr></table></figure></p>
<p>å±…ç„¶è¦å®šä¹‰è¿™ä¹ˆå¤šå‡½æ•°ï¼Ÿ èœé¸Ÿèƒ½å¿é«˜æ‰‹ä¸èƒ½å¿ï¼</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é«˜æ‰‹ç‰ˆ</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">printElementFromArray</span><span class="params">(a: [T])</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> a &#123; </div><div class="line">            <span class="built_in">print</span>(element) </div><div class="line">        &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="For-éå†-vs-While-éå†"><a href="#For-éå†-vs-While-éå†" class="headerlink" title="For éå† vs While éå†"></a>For éå† vs While éå†</h2><p>ä»»åŠ¡ï¼šæ‰“å° 5 æ¬¡ å¤§é›å¡”</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// èœé¸Ÿç‰ˆ</span></div><div class="line"><span class="selector-tag">var</span> <span class="selector-tag">i</span> = <span class="number">0</span></div><div class="line">while <span class="number">5</span> &gt; <span class="selector-tag">i</span> &#123;</div><div class="line">      print(<span class="string">"å¤§é›å¡”"</span>)</div><div class="line">      <span class="selector-tag">i</span> += <span class="number">1</span> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¢«è¿«å®šä¹‰äº†å˜é‡ i æ¥ç¡®ä¿æ‰“å°å¤§é›å¡”5æ¬¡</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é«˜æ‰‹ç‰ˆ</span></div><div class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="number">1.</span>.<span class="number">.5</span> &#123; </div><div class="line">    <span class="built_in">print</span>(<span class="string">"å¤§é›å¡”"</span>) </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="è®¡ç®—å±æ€§-vs-å‡½æ•°"><a href="#è®¡ç®—å±æ€§-vs-å‡½æ•°" class="headerlink" title="è®¡ç®—å±æ€§ vs å‡½æ•°"></a>è®¡ç®—å±æ€§ vs å‡½æ•°</h2><p>ä»»åŠ¡ï¼šè®¡ç®—åœ†çš„ç›´å¾„<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// èœé¸Ÿç‰ˆ</span></div><div class="line"><span class="selector-tag">funcgetDiameter</span>(<span class="attribute">radius</span>: Double) <span class="selector-tag">-</span>&gt; <span class="selector-tag">Double</span> &#123; <span class="selector-tag">return</span> <span class="selector-tag">radius</span> * <span class="selector-tag">2</span>&#125;</div><div class="line"><span class="selector-tag">funcgetRadius</span>(<span class="attribute">diameter</span>: Double) <span class="selector-tag">-</span>&gt; <span class="selector-tag">Double</span> &#123; <span class="selector-tag">return</span> <span class="selector-tag">diameter</span> / <span class="selector-tag">2</span>&#125;</div><div class="line"><span class="selector-tag">getDiameter</span>(<span class="attribute">radius</span>: <span class="number">10</span>) <span class="comment">// return 20</span></div><div class="line"><span class="selector-tag">getRadius</span>(<span class="attribute">diameter</span>: <span class="number">200</span>) <span class="comment">// return 100</span></div><div class="line"><span class="selector-tag">getRadius</span>(<span class="attribute">diameter</span>: <span class="number">600</span>) <span class="comment">// return 300</span></div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢æˆ‘ä»¬åˆ›å»ºäº†2ä¸ªæ¯«æ— å…³ç³»çš„å‡½æ•°ï¼Œå¯æ˜¯ç›´å¾„å’Œå‘¨é•¿ä¸¤è€…çœŸçš„æ²¡æœ‰å…³ç³»å—ï¼Ÿ<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é«˜æ‰‹ç‰ˆ</span></div><div class="line"><span class="keyword">var</span> radius: <span class="built_in">Double</span> = <span class="number">10</span></div><div class="line"><span class="keyword">var</span> diameter: <span class="built_in">Double</span> &#123;</div><div class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> radius * <span class="number">2</span>&#125;</div><div class="line">      <span class="keyword">set</span> &#123; radius = newValue / <span class="number">2</span>&#125; </div><div class="line">&#125;</div><div class="line">radius <span class="comment">// 10</span></div><div class="line">diameter <span class="comment">// 20</span></div><div class="line">diameter = <span class="number">1000</span></div><div class="line">radius <span class="comment">// 500</span></div></pre></td></tr></table></figure></p>
<h2 id="å‡½æ•°å¼ç¼–ç¨‹"><a href="#å‡½æ•°å¼ç¼–ç¨‹" class="headerlink" title="å‡½æ•°å¼ç¼–ç¨‹"></a>å‡½æ•°å¼ç¼–ç¨‹</h2><p>ä»»åŠ¡ï¼š è·å–å¶æ•°ã€‚</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// èœé¸Ÿç‰ˆ</span></div><div class="line"><span class="keyword">var</span> <span class="keyword">new</span><span class="type">Evens</span> = [<span class="keyword">Int</span>]()</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1.</span>.<span class="number">.10</span> &#123;</div><div class="line">  <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span> &#123; </div><div class="line">      <span class="keyword">new</span><span class="type">Evens</span>.append(i) </div><div class="line">    &#125; </div><div class="line">&#125;</div><div class="line">print(<span class="keyword">new</span><span class="type">Evens</span>) <span class="comment">// [2, 4, 6, 8, 10]</span></div></pre></td></tr></table></figure>
<p>è¿™ç§forå¾ªç¯çœŸæ˜¯å†—é•¿ï¼Œè®©äººçœ‹çš„æ˜æ˜æ¬²ç¡ã€‚<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é«˜æ‰‹ç‰ˆ</span></div><div class="line">var evens = (<span class="number">1.</span>.<span class="number">.10</span>).filter &#123; $<span class="number">0</span> % <span class="number">2</span> == <span class="number">0</span> &#125; </div><div class="line">print(evens) </div><div class="line"><span class="comment">// [2, 4, 6, 8, 10]</span></div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ‰©å±•-Extension&quot;&gt;&lt;a href=&quot;#æ‰©å±•-Extension&quot; class=&quot;headerlink&quot; title=&quot;æ‰©å±•(Extension)&quot;&gt;&lt;/a&gt;æ‰©å±•(Extension)&lt;/h2&gt;&lt;p&gt;ä»»åŠ¡ï¼š æ±‚æ•°å­—çš„å¹³æ–¹ã€‚&lt;/p&gt;
&lt;figure clas
    
    </summary>
    
      <category term="Swift" scheme="http://peterfei.me/categories/Swift/"/>
    
    
      <category term="swift" scheme="http://peterfei.me/tags/swift/"/>
    
  </entry>
  
  <entry>
    <title>swiftå®ç°ä»£ç†,é€šçŸ¥,é—­åŒ…ä¼ å€¼</title>
    <link href="http://peterfei.me/2016/12/20/swift%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%90%86-%E9%80%9A%E7%9F%A5-%E9%97%AD%E5%8C%85%E4%BC%A0%E5%80%BC/"/>
    <id>http://peterfei.me/2016/12/20/swiftå®ç°ä»£ç†-é€šçŸ¥-é—­åŒ…ä¼ å€¼/</id>
    <published>2016-12-20T01:58:21.000Z</published>
    <updated>2022-08-26T02:42:20.314Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h2><p>ç¬¬ä¸€å°±æ˜¯ä»£ç†ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„æ–¹å¼ï¼Œç‰¹ç‚¹æ˜¯ä¸€å¯¹ä¸€çš„å½¢å¼ï¼Œè€Œä¸”é€»è¾‘ç»“æ„éå¸¸æ¸…æ™°ã€‚å®ç°èµ·æ¥è¾ƒä¸ºç®€å•ï¼šå†™åè®® ï¼Œè®¾ç½®ä»£ç†è¿™ä¸ªå±æ€§ï¼Œ æœ€å¥½åœ¨ä½ æƒ³é€šçŸ¥ä»£ç†åšäº‹æƒ…çš„æ–¹æ³•ä¸­è°ƒç”¨å³å¯ã€‚å½“ç„¶è¿™é‡Œé¢æœ‰ä¸€äº›ç»†èŠ‚ï¼ŒåŒ…æ‹¬ â‘ åè®®å®šä¹‰æ—¶ï¼Œè¯·ç”¨å…³é”®å­—@requiredï¼Œå’Œ@optionalæ¥æ˜ç¡®ä»£ç†æ˜¯å¦å¿…é¡»å®ç°æŸäº›æ–¹æ³• â‘¡ä»£ç†çš„ç±»å‹éœ€ç”¨idç±»å‹ï¼Œå¹¶å†™æ˜è¦éµå®ˆçš„åè®® â‘¢å°±æ˜¯åœ¨è°ƒç”¨ä»£ç†æ–¹æ³•çš„æ—¶å€™éœ€è¦åˆ¤æ–­ä»£ç†æ˜¯å¦å®ç°è¯¥æ–¹æ³•ã€‚</p>
<p>ç¬¬äºŒå°±æ˜¯é€šçŸ¥ï¼Œé€šçŸ¥çš„ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼Œä»–æ˜¯ä¸€å¯¹å¤šçš„å½¢å¼ï¼Œè€Œä¸”å¯ä»¥åœ¨ä»»æ„å¯¹è±¡ä¹‹é—´ä¼ é€’ï¼Œä¸éœ€è¦äºŒè€…æœ‰è”ç³»ï¼Œå½“ç„¶ä»–çš„å®ç°å’Œä»£ç†ç›¸æ¯”è¾ƒç¨å¾®ç»•ä¸€ç‚¹ï¼Œæ³¨å†Œï¼Œå‘é€šçŸ¥ï¼Œæ”¶é€šçŸ¥ã€‚è¿™é‡Œé¢çš„æ³¨æ„ç‚¹å°±æ˜¯ â‘ å¯¹äºç³»ç»Ÿæ²¡æœ‰å®šä¹‰çš„äº‹ä»¶ç›‘å¬æ—¶éœ€è¦è‡ªå·±å‘é€šçŸ¥ï¼Œè¿™æ˜¯ä½ å°±éœ€è¦å®šä¹‰ä¸€ä¸ªkeyï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œè¿™ä¹Ÿæ˜¯é€šçŸ¥çš„ä¸€ä¸ªå¼Šç«¯ï¼Œä½ éœ€è¦æ‹·è´åˆ°æ”¶é€šçŸ¥çš„å¯¹è±¡ï¼Œé¿å…å†™é”™ä¸€ä¸ªå­—æ¯è€Œæ— æ³•æ”¶é€šçŸ¥çš„å°´å°¬ â‘¡å°±æ˜¯æ³¨å†Œçš„é€šçŸ¥ä¸­å¿ƒéœ€è¦æ‰‹åŠ¨ç§»é™¤ï¼Œä¸ç„¶é™¤äº†æ€§èƒ½çš„é—®é¢˜è¿˜ä¼šæœ‰å…¶ä»–çš„é—®é¢˜å‡ºç°ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªæ§åˆ¶å™¨æ¶ˆå¤±äº†ä¹‹åè¿˜æœ‰å› ä¸ºæŸäº›äº‹ä»¶è€Œå‘å‡ºé€šçŸ¥ï¼Œé€ æˆä¸æƒ³è¦çš„ç»“æœã€‚</p>
<p>ç¬¬ä¸‰å°±æ˜¯blockäº†ï¼Œè¿™æ˜¯è‹¹æœåæ¥æ‰åŠ å…¥çš„ï¼Œä¹Ÿæ˜¯ç›®å‰å¼€å‘æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ç§æ–¹å¼ï¼ŒåŠŸèƒ½æ¯”è¾ƒå¼ºå¤§ï¼Œä½†æ˜¯åœ¨ç†è§£å’Œä½¿ç”¨ä¸Šå¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´æ‘¸ç´¢å’Œç†Ÿæ‚‰ã€‚ä»–çš„æœ€å¤§ç‰¹ç‚¹å°±æ˜¯å›è°ƒï¼Œè€Œä¸”å›è°ƒæ—¶å¯ä»¥ä¼ å…¥å‚æ•°ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæ— è®ºåœ¨å“ªè°ƒç”¨ï¼Œblockçš„æ‰§è¡Œéƒ½ä¼šå›åˆ°blockåˆ›å»ºçš„åœ°æ–¹æ‰§è¡Œï¼Œè€Œéè°ƒç”¨çš„åœ°æ–¹ã€‚è€Œblockæœ¬èº«å¯ä»¥å°è£…ä¸€æ®µä»£ç ï¼Œä¸€æ®µä»£ç ä½ æ‡‚çš„ï¼Œå¾ˆå¤šäººåœ¨åˆå­¦æ—¶ä¼šè¢«ææ™•ï¼Œç”šè‡³åœ¨blockçš„å£°æ˜ä¸Šå°±çº ç»“ï¼Œå…¶å®å¾ˆæ­£å¸¸ï¼Œå¤šç”¨å°±å¥½ã€‚</p>
<h2 id="ä»£ç†"><a href="#ä»£ç†" class="headerlink" title="ä»£ç†"></a>ä»£ç†</h2><p>å¦‚ä¸‹é¢ä»£ç ,æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåè®®æ–¹æ³•, å…¶ç»“æ„å°±æ˜¯protocolå…³é”®å­—+åè®®çš„åç§° + : + NSObjectProtocol {},æ³¨æ„Swiftä¸­çš„è‡ªå®šä¹‰åè®®å…¶æœ¬èº«å¿…é¡»éµå¾ªNSObjectProtocolåè®®</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">TextViewControllerDelegate</span>: <span class="title">NSObjectProtocol</span></span>&#123;</div><div class="line">    <span class="comment">// ç‚¹å‡»delegateæŒ‰é’®å›è°ƒ</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">delegateBtnWillClick</span><span class="params">(message : String)</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¹¶ä¸”åœ¨OCä¸­,æˆ‘ä»¬ä¸€èˆ¬ä¼šå®šä¹‰ä¸€ä¸ªå±æ€§æ¥ä¿å­˜ä»£ç†å¦‚@property (nonatomic,weak)id&lt; TextViewControllerDelegate &gt; delegate;ä½†æ˜¯åœ¨Swiftä¸­æˆ‘ä»¬ä¾ç„¶è¦è¿™æ ·åš,åªä¸è¿‡å†™æ³•å˜æˆäº†weak var delegate : TextViewControllerDelegate?,æ³¨æ„ä¸€å®šè¦åŠ ä¸Šweakå…³é”®å­—,é¿å…å¾ªç¯å¼•ç”¨é—®é¢˜.è¿™æ˜¯æˆ‘çš„demoä¸­çš„ä»£ç ,å›è°ƒä¸€æ®µå­—ç¬¦ä¸²</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/<span class="type">MARK</span>: - ç‚¹å‡»ä»£ç†ä¼ å€¼æŒ‰é’®</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">delegateBtnClick</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"ä»£ç†ä¼ å€¼æŒ‰é’®è¢«ç‚¹å‡»"</span>)</div><div class="line">    <span class="keyword">let</span> str = <span class="string">"ä»£ç†ä¼ å€¼æŒ‰é’®è¢«ç‚¹å‡»,æŠŠä¸Šä¸ªç•Œé¢çš„å€¼ä¼ äº†è¿‡æ¥"</span></div><div class="line">    delegate?.delegateBtnWillClick(str)</div><div class="line">    <span class="keyword">self</span>.navigationController?.popViewControllerAnimated(<span class="literal">true</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åå°±åœ¨åˆ«çš„æ§åˆ¶å™¨,è®¾ç½®é‚£ä¸ªæ§åˆ¶å™¨ä¸ºè¯¥æ§åˆ¶å™¨çš„ä»£ç†,å»å®ç°åè®®æ–¹æ³•å°±å¯ä»¥äº†</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;åŒºåˆ«&quot;&gt;&lt;a href=&quot;#åŒºåˆ«&quot; class=&quot;headerlink&quot; title=&quot;åŒºåˆ«&quot;&gt;&lt;/a&gt;åŒºåˆ«&lt;/h2&gt;&lt;p&gt;ç¬¬ä¸€å°±æ˜¯ä»£ç†ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„æ–¹å¼ï¼Œç‰¹ç‚¹æ˜¯ä¸€å¯¹ä¸€çš„å½¢å¼ï¼Œè€Œä¸”é€»è¾‘ç»“æ„éå¸¸æ¸…æ™°ã€‚å®ç°èµ·æ¥è¾ƒä¸ºç®€å•ï¼šå†™åè®® ï¼Œè®¾ç½®ä»£ç†è¿™ä¸ªå±æ€§ï¼Œ æœ€å¥½åœ¨ä½ æƒ³é€šçŸ¥ä»£
    
    </summary>
    
      <category term="Swift" scheme="http://peterfei.me/categories/Swift/"/>
    
    
  </entry>
  
</feed>
