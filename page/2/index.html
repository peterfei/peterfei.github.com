<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="peterfei.me,peterfei" />





  <link rel="alternate" href="/atom.xml" title="Peterfei" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.0" />






<meta name="description" content="peterfei|æŠ€æœ¯|ä¸Šä¸»æ˜¯æˆ‘çš„ç‰§è€…">
<meta property="og:type" content="website">
<meta property="og:title" content="Peterfei">
<meta property="og:url" content="http://peterfei.me/page/2/index.html">
<meta property="og:site_name" content="Peterfei">
<meta property="og:description" content="peterfei|æŠ€æœ¯|ä¸Šä¸»æ˜¯æˆ‘çš„ç‰§è€…">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Peterfei">
<meta name="twitter:description" content="peterfei|æŠ€æœ¯|ä¸Šä¸»æ˜¯æˆ‘çš„ç‰§è€…">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: '[object Object]',
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'åšä¸»'
    }
  };
</script>

  <title> Peterfei </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Peterfei</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">ä¸Šä¸»æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å®åœ¨ä¸€æ— æ‰€ç¼º</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      

      
      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'PqEYgqEwUwFoXjgtngj9','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">

    

    
    
      
      

      
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/09/05/Headscale-ä¹‹éƒ¨ç½²ç§æœ‰-DERP-ä¸­ç»§æœåŠ¡å™¨/" itemprop="url">
                  Headscale ä¹‹éƒ¨ç½²ç§æœ‰ DERP ä¸­ç»§æœåŠ¡å™¨
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2022-09-05T19:42:20+08:00" content="2022-09-05">
              2022-09-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2022/09/05/Headscale-ä¹‹éƒ¨ç½²ç§æœ‰-DERP-ä¸­ç»§æœåŠ¡å™¨/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2022/09/05/Headscale-ä¹‹éƒ¨ç½²ç§æœ‰-DERP-ä¸­ç»§æœåŠ¡å™¨/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="STUN-æ˜¯ä»€ä¹ˆ"><a href="#STUN-æ˜¯ä»€ä¹ˆ" class="headerlink" title="STUN æ˜¯ä»€ä¹ˆ"></a>STUN æ˜¯ä»€ä¹ˆ</h2><p>Tailscale çš„ç»ˆæç›®æ ‡æ˜¯è®©ä¸¤å°<strong>å¤„äºç½‘ç»œä¸Šçš„ä»»ä½•ä½ç½®</strong>çš„æœºå™¨å»ºç«‹<strong>ç‚¹å¯¹ç‚¹è¿æ¥</strong>ï¼ˆç›´è¿ï¼‰ï¼Œä½†ç°å®ä¸–ç•Œæ˜¯å¤æ‚çš„ï¼Œå¤§éƒ¨ä»½æƒ…å†µä¸‹æœºå™¨éƒ½ä½äº NAT å’Œé˜²ç«å¢™åé¢ï¼Œè¿™æ—¶å€™å°±éœ€è¦é€šè¿‡æ‰“æ´æ¥å®ç°ç›´è¿ï¼Œä¹Ÿå°±æ˜¯ NAT ç©¿é€ã€‚</p>
<p>NAT æŒ‰ç…§ <strong>NAT æ˜ å°„è¡Œä¸º</strong>å’Œ<strong>æœ‰çŠ¶æ€é˜²ç«å¢™è¡Œä¸º</strong>å¯ä»¥åˆ†ä¸ºå¤šç§ç±»å‹ï¼Œä½†å¯¹äº NAT ç©¿é€æ¥è¯´æ ¹æœ¬ä¸éœ€è¦å…³å¿ƒè¿™ä¹ˆå¤šç±»å‹ï¼Œåªéœ€è¦çœ‹ <strong>NAT æˆ–è€…æœ‰çŠ¶æ€é˜²ç«å¢™æ˜¯å¦ä¼šä¸¥æ ¼æ£€æŸ¥ç›®æ ‡ Endpoint</strong>ï¼Œæ ¹æ®è¿™ä¸ªå› ç´ ï¼Œå¯ä»¥å°† NAT åˆ†ä¸º <strong>Easy NAT</strong> å’Œ <strong>Hard NAT</strong>ã€‚</p>
<ul>
<li><strong>Easy NAT</strong> åŠå…¶å˜ç§ç§°ä¸º â€œEndpoint-Independent Mappingâ€ (<strong>EIMï¼Œç»ˆç‚¹æ— å…³çš„æ˜ å°„</strong>)<br>è¿™é‡Œçš„ Endpoint æŒ‡çš„æ˜¯ç›®æ ‡ Endpointï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰çŠ¶æ€é˜²ç«å¢™åªè¦çœ‹åˆ°æœ‰å®¢æˆ·ç«¯è‡ªå·±å‘èµ·çš„å‡ºå‘åŒ…ï¼Œå°±ä¼šå…è®¸ç›¸åº”çš„å…¥å‘åŒ…è¿›å…¥ï¼Œ<strong>ä¸ç®¡è¿™ä¸ªå…¥å‘åŒ…æ˜¯è°å‘è¿›æ¥çš„éƒ½å¯ä»¥</strong>ã€‚</li>
<li><strong>hard NAT</strong> ä»¥åŠå˜ç§ç§°ä¸º â€œEndpoint-Dependent Mappingâ€ï¼ˆ<strong>EDMï¼Œç»ˆç‚¹ç›¸å…³çš„æ˜ å°„</strong>ï¼‰<br>è¿™ç§ NAT ä¼šé’ˆå¯¹æ¯ä¸ªç›®æ ‡ Endpoint æ¥ç”Ÿæˆä¸€æ¡ç›¸åº”çš„æ˜ å°„å…³ç³»ã€‚ åœ¨è¿™æ ·çš„è®¾å¤‡ä¸Šï¼Œå¦‚æœå®¢æˆ·ç«¯å‘æŸä¸ªç›®æ ‡ Endpoint å‘èµ·äº†å‡ºå‘åŒ…ï¼Œå‡è®¾å®¢æˆ·ç«¯çš„å…¬ç½‘ IP æ˜¯ 2.2.2.2ï¼Œé‚£ä¹ˆæœ‰çŠ¶æ€é˜²ç«å¢™å°±ä¼šæ‰“å¼€ä¸€ä¸ªç«¯å£ï¼Œå‡è®¾æ˜¯ 4242ã€‚é‚£ä¹ˆåªæœ‰æ¥è‡ªè¯¥ç›®æ ‡ Endpoint çš„å…¥å‘åŒ…æ‰å…è®¸é€šè¿‡ <code>2.2.2.2:4242</code>ï¼Œå…¶ä»–å®¢æˆ·ç«¯ä¸€å¾‹ä¸å…è®¸ã€‚è¿™ç§ NAT æ›´åŠ ä¸¥æ ¼ï¼Œæ‰€ä»¥å« Hard NATã€‚</li>
</ul>
<p>å¯¹äº Easy NATï¼Œæˆ‘ä»¬åªéœ€è¦æä¾›ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„æœåŠ¡ï¼Œå®ƒèƒ½å¤Ÿå‘Šè¯‰å®¢æˆ·ç«¯â€œå®ƒçœ‹åˆ°çš„å®¢æˆ·ç«¯çš„å…¬ç½‘ ip:port æ˜¯ä»€ä¹ˆâ€ï¼Œç„¶åå°†è¿™ä¸ªä¿¡æ¯ä»¥æŸç§æ–¹å¼å‘Šè¯‰é€šä¿¡å¯¹ç«¯ï¼ˆpeerï¼‰ï¼Œåè€…å°±çŸ¥é“è¯¥å’Œå“ªä¸ªåœ°å€å»ºè¿äº†ï¼è¿™ç§æœåŠ¡å°±å« <strong>STUN</strong> (Session Traversal Utilities for NATï¼ŒNATä¼šè¯ç©¿è¶Šåº”ç”¨ç¨‹åº)ã€‚å®ƒçš„å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<ul>
<li>ç¬”è®°æœ¬å‘ STUN æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼šâ€œä»ä½ çš„è§’åº¦çœ‹ï¼Œæˆ‘çš„åœ°å€ä»€ä¹ˆï¼Ÿâ€</li>
<li>STUN æœåŠ¡å™¨è¿”å›ä¸€ä¸ªå“åº”ï¼šâ€œæˆ‘çœ‹åˆ°ä½ çš„ UDP åŒ…æ˜¯ä»è¿™ä¸ªåœ°å€æ¥çš„ï¼š<code>ip:port</code>â€ã€‚</li>
</ul>
<h2 id="ä¸­ç»§æ˜¯ä»€ä¹ˆ"><a href="#ä¸­ç»§æ˜¯ä»€ä¹ˆ" class="headerlink" title="ä¸­ç»§æ˜¯ä»€ä¹ˆ"></a>ä¸­ç»§æ˜¯ä»€ä¹ˆ</h2><p>å¯¹äº <strong>Hard NAT</strong> æ¥è¯´ï¼ŒSTUN å°±ä¸å¥½ä½¿äº†ï¼Œå³ä½¿ STUN æ‹¿åˆ°äº†å®¢æˆ·ç«¯çš„å…¬ç½‘ <code>ip:port</code> å‘Šè¯‰é€šä¿¡å¯¹ç«¯ä¹Ÿäºäº‹æ— è¡¥ï¼Œå› ä¸ºé˜²ç«å¢™æ˜¯å’Œ STUN é€šä¿¡æ‰æ‰“å¼€çš„ç¼ºå£ï¼Œè¿™ä¸ªç¼ºå£åªå…è®¸ STUN çš„å…¥å‘åŒ…è¿›å…¥ï¼Œå…¶ä»–é€šä¿¡å¯¹ç«¯çŸ¥é“äº†è¿™ä¸ªç¼ºå£ä¹Ÿè¿›ä¸æ¥ã€‚é€šå¸¸ä¼ä¸šçº§ NAT éƒ½å±äº Hard NATã€‚</p>
<p>è¿™ç§æƒ…å†µä¸‹æ‰“æ´æ˜¯ä¸å¯èƒ½äº†ï¼Œä½†ä¹Ÿä¸èƒ½å°±æ­¤æ”¾å¼ƒï¼Œå¯ä»¥é€‰æ‹©ä¸€ç§æŠ˜è¡·çš„æ–¹å¼ï¼šåˆ›å»ºä¸€ä¸ªä¸­ç»§æœåŠ¡å™¨ï¼ˆrelay serverï¼‰ï¼Œå®¢æˆ·ç«¯ä¸ä¸­ç»§æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œä¸­ç»§æœåŠ¡å™¨å†å°†åŒ…ä¸­ç»§ï¼ˆrelayï¼‰ç»™é€šä¿¡å¯¹ç«¯ã€‚</p>
<p>è‡³äºä¸­ç»§çš„æ€§èƒ½ï¼Œé‚£è¦çœ‹å…·ä½“æƒ…å†µäº†ï¼š</p>
<ul>
<li>å¦‚æœèƒ½ç›´è¿ï¼Œé‚£æ˜¾ç„¶æ²¡å¿…è¦ç”¨ä¸­ç»§æ–¹å¼ï¼›</li>
<li>ä½†å¦‚æœæ— æ³•ç›´è¿ï¼Œè€Œä¸­ç»§è·¯å¾„åˆéå¸¸æ¥è¿‘åŒæ–¹ç›´è¿çš„çœŸå®è·¯å¾„ï¼Œå¹¶ä¸”å¸¦å®½è¶³å¤Ÿå¤§ï¼Œé‚£ä¸­ç»§æ–¹å¼å¹¶ä¸ä¼šæ˜æ˜¾é™ä½é€šä¿¡è´¨é‡ã€‚å»¶è¿Ÿè‚¯å®šä¼šå¢åŠ ä¸€ç‚¹ï¼Œå¸¦å®½ä¼šå ç”¨ä¸€äº›ï¼Œä½†<strong>ç›¸æ¯”å®Œå…¨è¿æ¥ä¸ä¸Šï¼Œè¿˜æ˜¯å¯ä»¥æ¥å—çš„</strong>ã€‚</li>
</ul>
<p>äº‹å®ä¸Šå¯¹äºå¤§éƒ¨åˆ†ç½‘ç»œè€Œè¨€ï¼ŒTailscale éƒ½å¯ä»¥é€šè¿‡å„ç§é»‘ç§‘æŠ€æ‰“æ´æˆåŠŸï¼Œåªæœ‰æå°‘æ•°æƒ…å†µä¸‹æ‰ä¼šé€‰æ‹©ä¸­ç»§ï¼Œä¸­ç»§åªæ˜¯ä¸€ç§ fallback æœºåˆ¶ã€‚</p>
<h2 id="ä¸­ç»§åè®®ç®€ä»‹"><a href="#ä¸­ç»§åè®®ç®€ä»‹" class="headerlink" title="ä¸­ç»§åè®®ç®€ä»‹"></a>ä¸­ç»§åè®®ç®€ä»‹</h2><p>ä¸­ç»§åè®®æœ‰å¤šç§å®ç°æ–¹å¼ã€‚</p>
<h3 id="TURN"><a href="#TURN" class="headerlink" title="TURN"></a>TURN</h3><p>TURN å³ Traversal Using Relays around NATï¼Œè¿™æ˜¯ä¸€ç§ç»å…¸çš„ä¸­ç»§å®ç°æ–¹å¼ï¼Œæ ¸å¿ƒç†å¿µæ˜¯ï¼š</p>
<ul>
<li><strong>ç”¨æˆ·</strong>ï¼ˆäººï¼‰å…ˆå»å…¬ç½‘ä¸Šçš„ TURN æœåŠ¡å™¨è®¤è¯ï¼ŒæˆåŠŸååè€…ä¼šå‘Šè¯‰ä½ ï¼šâ€œæˆ‘å·²ç»ä¸ºä½ åˆ†é…äº† ip:portï¼Œæ¥ä¸‹æ¥å°†ä¸ºä½ ä¸­ç»§æµé‡â€ï¼Œ</li>
<li>ç„¶åå°†è¿™ä¸ª ip:port åœ°å€å‘Šè¯‰å¯¹æ–¹ï¼Œè®©å®ƒå»è¿æ¥è¿™ä¸ªåœ°å€ï¼Œæ¥ä¸‹å»å°±æ˜¯éå¸¸ç®€å•çš„å®¢æˆ·ç«¯/æœåŠ¡å™¨é€šä¿¡æ¨¡å‹äº†ã€‚</li>
</ul>
<p>ä¸ STUN ä¸åŒï¼Œè¿™ç§åè®®æ²¡æœ‰çœŸæ­£çš„äº¤äº’æ€§ï¼Œä¸æ˜¯å¾ˆå¥½ç”¨ï¼Œå› æ­¤ Tailscale å¹¶æ²¡æœ‰é‡‡ç”¨ TURN ä½œä¸ºä¸­ç»§åè®®ã€‚</p>
<h3 id="DERP"><a href="#DERP" class="headerlink" title="DERP"></a>DERP</h3><p>DERP å³ Detoured Encrypted Routing Protocolï¼Œè¿™æ˜¯ Tailscale è‡ªç ”çš„ä¸€ä¸ªåè®®ï¼š</p>
<ul>
<li>å®ƒæ˜¯ä¸€ä¸ª<strong>é€šç”¨ç›®çš„åŒ…ä¸­ç»§åè®®ï¼Œè¿è¡Œåœ¨ HTTP ä¹‹ä¸Š</strong>ï¼Œè€Œå¤§éƒ¨åˆ†ç½‘ç»œéƒ½æ˜¯å…è®¸ HTTP é€šä¿¡çš„ã€‚</li>
<li>å®ƒæ ¹æ®ç›®çš„å…¬é’¥ï¼ˆdestinationâ€™s public keyï¼‰æ¥ä¸­ç»§åŠ å¯†çš„æµé‡ï¼ˆencrypted payloadsï¼‰ã€‚</li>
</ul>
<h2 id="è‡ªå»ºç§æœ‰-DERP-server"><a href="#è‡ªå»ºç§æœ‰-DERP-server" class="headerlink" title="è‡ªå»ºç§æœ‰ DERP server"></a>è‡ªå»ºç§æœ‰ DERP server</h2><p>Tailscale çš„ç§é’¥åªä¼šä¿å­˜åœ¨å½“å‰èŠ‚ç‚¹ï¼Œå› æ­¤ DERP server æ— æ³•è§£å¯†æµé‡ï¼Œå®ƒåªèƒ½å’Œäº’è”ç½‘ä¸Šçš„å…¶ä»–è·¯ç”±å™¨ä¸€æ ·ï¼Œå‘†å‘†åœ°å°†åŠ å¯†çš„æµé‡ä»ä¸€ä¸ªèŠ‚ç‚¹è½¬å‘åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåªä¸è¿‡ DERP ä½¿ç”¨äº†ä¸€ä¸ªç¨å¾®é«˜çº§ä¸€ç‚¹çš„åè®®æ¥é˜²æ­¢æ»¥ç”¨ã€‚</p>
<p>Tailscale å¼€æºäº† DERP æœåŠ¡å™¨çš„ä»£ç ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥é˜…è¯» <a href="https://github.com/tailscale/tailscale/tree/main/derp" target="_blank" rel="external">DERP çš„æºä»£ç </a>ã€‚</p>
<hr>
<p>Tailscale å®˜æ–¹å†…ç½®äº†å¾ˆå¤š DERP æœåŠ¡å™¨ï¼Œåˆ†æ­¥åœ¨å…¨çƒå„åœ°ï¼Œ<strong>æƒŸç‹¬ä¸åŒ…å«ä¸­å›½å¤§é™†</strong>ï¼ŒåŸå› ä½ æ‡‚å¾—ã€‚è¿™å°±å¯¼è‡´äº†ä¸€æ—¦æµé‡é€šè¿‡ DERP æœåŠ¡å™¨è¿›è¡Œä¸­ç»§ï¼Œå»¶æ—¶å°±ä¼šéå¸¸é«˜ã€‚è€Œä¸”å®˜æ–¹æä¾›çš„ DERP æœåŠ¡å™¨æ˜¯ä¸‡äººéª‘ï¼Œå­˜åœ¨å®‰å…¨éšæ‚£ã€‚</p>
<p>ä¸ºäº†å®ç°ä½å»¶è¿Ÿã€é«˜å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ <a href="https://tailscale.com/kb/1118/custom-derp-servers/" target="_blank" rel="external">Tailscale å®˜æ–¹æ–‡æ¡£</a>è‡ªå»ºç§æœ‰çš„ DERP æœåŠ¡å™¨ã€‚æœ‰ä¸¤ç§éƒ¨ç½²æ¨¡å¼ï¼Œä¸€ç§æ˜¯åŸºäºåŸŸåï¼Œå¦å¤–ä¸€ç§ä¸éœ€è¦åŸŸåï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ IPï¼Œä¸è¿‡éœ€è¦ä¸€ç‚¹é»‘ç§‘æŠ€ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹æœ€ç®€å•çš„ä½¿ç”¨åŸŸåçš„æ–¹æ¡ˆã€‚</p>
<p>è¿˜éœ€è¦åˆ›å»ºè‡ªç­¾åè¯ä¹¦ï¼Œå¯ä»¥é€šè¿‡è„šæœ¬æ¥åˆ›å»ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># build_cert.sh</span></div><div class="line"></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">CERT_HOST=<span class="variable">$1</span></div><div class="line">CERT_DIR=<span class="variable">$2</span></div><div class="line">CONF_FILE=<span class="variable">$3</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"[req]</span></div><div class="line">default_bits  = 2048</div><div class="line">distinguished_name = req_distinguished_name</div><div class="line">req_extensions = req_ext</div><div class="line">x509_extensions = v3_req</div><div class="line">prompt = no</div><div class="line"></div><div class="line">[req_distinguished_name]</div><div class="line">countryName = XX</div><div class="line">stateOrProvinceName = N/A</div><div class="line">localityName = N/A</div><div class="line">organizationName = Self-signed certificate</div><div class="line">commonName = <span class="variable">$CERT_HOST</span>: Self-signed certificate</div><div class="line"></div><div class="line">[req_ext]</div><div class="line">subjectAltName = @alt_names</div><div class="line"></div><div class="line">[v3_req]</div><div class="line">subjectAltName = @alt_names</div><div class="line"></div><div class="line">[alt_names]</div><div class="line">IP.1 = <span class="variable">$CERT_HOST</span></div><div class="line">" &gt; <span class="string">"<span class="variable">$CONF_FILE</span>"</span></div><div class="line"></div><div class="line">mkdir -p <span class="string">"<span class="variable">$CERT_DIR</span>"</span></div><div class="line">openssl req -x509 -nodes -days 730 -newkey rsa:2048 -keyout <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.key"</span> -out <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.crt"</span> -config <span class="string">"<span class="variable">$CONF_FILE</span>"</span></div></pre></td></tr></table></figure>
<p>é‡æ–°ç¼–å†™ Dockerfileï¼Œå°† derper çš„åŸŸåè®¾ç½®ä¸º <code>127.0.0.1</code>ï¼š</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> golang:latest AS builder</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># ========= CONFIG =========</span></div><div class="line"><span class="comment"># - download links</span></div><div class="line"><span class="keyword">ENV</span> MODIFIED_DERPER_GIT=https://github.com/yangchuansheng/ip_derper.git</div><div class="line"><span class="keyword">ENV</span> BRANCH=ip_derper</div><div class="line"><span class="comment"># ==========================</span></div><div class="line"></div><div class="line"><span class="comment"># build modified derper</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> git <span class="built_in">clone</span> -b <span class="variable">$BRANCH</span> <span class="variable">$MODIFIED_DERPER_GIT</span> tailscale --depth 1 &amp;&amp; \</span></div><div class="line">    <span class="built_in">cd</span> /app/tailscale/cmd/derper &amp;&amp; \</div><div class="line">    /usr/<span class="built_in">local</span>/go/bin/go build -ldflags <span class="string">"-s -w"</span> -o /app/derper &amp;&amp; \</div><div class="line">    <span class="built_in">cd</span> /app &amp;&amp; \</div><div class="line">    rm -rf /app/tailscale</div><div class="line"></div><div class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># ========= CONFIG =========</span></div><div class="line"><span class="comment"># - derper args</span></div><div class="line"><span class="keyword">ENV</span> DERP_HOST=<span class="number">127.0</span>.<span class="number">0.1</span></div><div class="line"><span class="keyword">ENV</span> DERP_CERTS=/app/certs/</div><div class="line"><span class="keyword">ENV</span> DERP_STUN true</div><div class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</div><div class="line"><span class="comment"># ==========================</span></div><div class="line"></div><div class="line"><span class="comment"># apt</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></div><div class="line">    apt-get install -y openssl curl</div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> build_cert.sh /app/</span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /app/derper /app/derper</span></div><div class="line"></div><div class="line"><span class="comment"># build self-signed certs &amp;&amp; start derper</span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> bash /app/build_cert.sh <span class="variable">$DERP_HOST</span> <span class="variable">$DERP_CERTS</span> /app/san.conf &amp;&amp; \</span></div><div class="line">    /app/derper --hostname=<span class="variable">$DERP_HOST</span> \</div><div class="line">    --certmode=manual \</div><div class="line">    --certdir=<span class="variable">$DERP_CERTS</span> \</div><div class="line">    --stun=<span class="variable">$DERP_STUN</span>  \</div><div class="line">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></div></pre></td></tr></table></figure>
<p>æ„å»ºå¥½é•œåƒåï¼Œå°±å¯ä»¥åœ¨ä½ æƒ³éƒ¨ç½² derper çš„ä¸»æœºä¸Šç›´æ¥é€šè¿‡è¯¥é•œåƒå¯åŠ¨ derper å®¹å™¨äº†ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ğŸ³  â†’ docker run --restart always --net host --name derper  -p 12345:12345 -p 3478:3478/udp <span class="_">-e</span> DERP_ADDR=:12345  <span class="_">-d</span> ghcr.io/yangchuansheng/ip_derper</div></pre></td></tr></table></figure>
<p>Headscale çš„æœ¬åœ° YAML æ–‡ä»¶ç›®å‰è¿˜ä¸æ”¯æŒè¿™ä¸ªé…ç½®é¡¹ï¼Œæ‰€ä»¥æ²¡åŠæ³•ï¼Œå’±åªèƒ½ä½¿ç”¨åœ¨çº¿ URL äº†ã€‚JSON é…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@jetlink headscale]# cat derp.json </div><div class="line">&#123;</div><div class="line">  "Regions": &#123;</div><div class="line">    "901": &#123;</div><div class="line">      "RegionID": 901,</div><div class="line">      "RegionCode": "ali-sh",</div><div class="line">      "RegionName": "Aliyun Shanghai",</div><div class="line">      "Nodes": [</div><div class="line">        &#123;</div><div class="line">          "Name": "901a",</div><div class="line">          "RegionID": 901,</div><div class="line">          "DERPPort": 12345,</div><div class="line">          "HostName": "xx.xx.xx.118",</div><div class="line">          "IPv4": "xx.xx.xx.118",</div><div class="line">          "InsecureForTests": true</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é…ç½®è§£æï¼š</p>
<ul>
<li><code>HostName</code> ç›´æ¥å¡« derper çš„å…¬ç½‘ IPï¼Œå³å’Œ <code>IPv4</code> çš„å€¼ç›¸åŒã€‚</li>
<li><code>InsecureForTests</code> ä¸€å®šè¦è®¾ç½®ä¸º trueï¼Œä»¥è·³è¿‡åŸŸåéªŒè¯ã€‚</li>
</ul>
<p>ä½ éœ€è¦æŠŠè¿™ä¸ª JSON æ–‡ä»¶å˜æˆ Headscale æœåŠ¡å™¨å¯ä»¥è®¿é—®çš„ URLï¼Œæ¯”å¦‚åœ¨ Headscale ä¸»æœºä¸Šæ­ä¸ª Nginxï¼Œæˆ–è€…ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆæ¯”å¦‚é˜¿é‡Œäº‘ OSSï¼‰</p>
<p>æ¥ä¸‹æ¥è¿˜éœ€è¦ä¿®æ”¹ Headscale çš„é…ç½®æ–‡ä»¶ï¼Œå¼•ç”¨ä¸Šé¢çš„è‡ªå®šä¹‰ DERP çš„ URLã€‚éœ€è¦ä¿®æ”¹çš„é…ç½®é¡¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /etc/headscale/config.yaml</span></div><div class="line"><span class="attr">derp:</span></div><div class="line">  <span class="comment"># List of externally available DERP maps encoded in JSON</span></div><div class="line"><span class="attr">  urls:</span></div><div class="line">  <span class="comment">#  - https://controlplane.tailscale.com/derpmap/default</span></div><div class="line"><span class="attr">    - https:</span>//xxxxx/derp.json</div><div class="line"></div><div class="line">  <span class="comment"># Locally available DERP map files encoded in YAML</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment"># This option is mostly interesting for people hosting</span></div><div class="line">  <span class="comment"># their own DERP servers:</span></div><div class="line">  <span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment"># paths:</span></div><div class="line">  <span class="comment">#   - /etc/headscale/derp-example.yaml</span></div><div class="line"><span class="attr">  paths:</span></div><div class="line"><span class="bullet">    -</span> /etc/headscale/derp.yaml</div><div class="line"></div><div class="line">  <span class="comment"># If enabled, a worker will be set up to periodically</span></div><div class="line">  <span class="comment"># refresh the given sources and update the derpmap</span></div><div class="line">  <span class="comment"># will be set up.</span></div><div class="line"><span class="attr">  auto_update_enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment"># How often should we check for DERP updates?</span></div><div class="line"><span class="attr">  update_frequency:</span> <span class="number">24</span>h</div></pre></td></tr></table></figure>
<p>ä¿®æ”¹å®Œé…ç½®åï¼Œé‡å¯ headscale æœåŠ¡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl restart headscale</div></pre></td></tr></table></figure>
<p>åœ¨ Tailscale å®¢æˆ·ç«¯ä¸Šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ç›®å‰å¯ä»¥ä½¿ç”¨çš„ DERP æœåŠ¡å™¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ tailscale netcheck</div><div class="line"></div><div class="line">Report:</div><div class="line">	* UDP: <span class="literal">true</span></div><div class="line">	* IPv4: yes, 192.168.100.1:49656</div><div class="line">	* IPv6: no</div><div class="line">	* MappingVariesByDestIP: <span class="literal">true</span></div><div class="line">	* HairPinning: <span class="literal">false</span></div><div class="line">	* PortMapping: UPnP</div><div class="line">	* Nearest DERP: Home Hangzhou</div><div class="line">	* DERP latency:</div><div class="line">		- home: 9.7ms   (Home Hangzhou)</div><div class="line">		-  hs: 25.2ms  (Huawei Shanghai)</div><div class="line">		- thk: 43.5ms  (Tencent Hongkong)</div></pre></td></tr></table></figure>
<p>å†æ¬¡æŸ¥çœ‹ä¸é€šä¿¡å¯¹ç«¯çš„è¿æ¥æ–¹å¼ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ tailscale status</div><div class="line">                coredns              default      linux   active; direct xxxx:45986; offline, tx 131012 rx 196020</div><div class="line">                oneplus-8t           default      android active; relay <span class="string">"home"</span>; offline, tx 211900 rx 22780</div><div class="line">                openwrt              default      linux   active; direct 192.168.100.254:41641; offline, tx 189868 rx 4074772</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸€æ¬¡ Tailscale è‡ªåŠ¨é€‰æ‹©äº†ä¸€ä¸ªçº¿è·¯æœ€ä¼˜çš„<strong>å›½å†…çš„</strong> DERP æœåŠ¡å™¨ä½œä¸ºä¸­ç»§ï¼Œå¯ä»¥æµ‹è¯•ä¸€ä¸‹å»¶è¿Ÿï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ tailscale ping 10.1.0.8</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 45ms</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</div></pre></td></tr></table></figure>
<p>å®Œç¾ï¼è¿™é‡Œçš„ home å½“ç„¶æ˜¯æˆ‘çš„å®¶åº­å®½å¸¦ï¼Œéƒ¨ç½²æ–¹å¼ä¸ä¸Šé¢æ‰€è¯´çš„å›½å†…äº‘ä¸»æœºç±»ä¼¼ï¼Œä½ éœ€è¦é¢å¤–å¼€å¯å…¬ç½‘çš„ç«¯å£æ˜ å°„ï¼ˆ12345/tcp, 3478/udpï¼‰ã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯é…ç½®å†…å®¹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"Regions"</span>: &#123;</div><div class="line">    <span class="attr">"901"</span>: &#123;</div><div class="line">      <span class="attr">"RegionID"</span>: <span class="number">901</span>,</div><div class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"ali-sh"</span>,</div><div class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Aliyun Shanghai"</span>,</div><div class="line">      <span class="attr">"Nodes"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"Name"</span>: <span class="string">"901a"</span>,</div><div class="line">          <span class="attr">"RegionID"</span>: <span class="number">901</span>,</div><div class="line">          <span class="attr">"DERPPort"</span>: <span class="number">443</span>,</div><div class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"IPv4"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"902"</span>: &#123;</div><div class="line">      <span class="attr">"RegionID"</span>: <span class="number">902</span>,</div><div class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"home"</span>,</div><div class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Home Hangzhou"</span>,</div><div class="line">      <span class="attr">"Nodes"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"Name"</span>: <span class="string">"902a"</span>,</div><div class="line">          <span class="attr">"RegionID"</span>: <span class="number">902</span>,</div><div class="line">          <span class="attr">"DERPPort"</span>: <span class="number">12345</span>,</div><div class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸å›½å†…äº‘ä¸»æœºç›¸æ¯”ï¼Œå®¶åº­å®½å¸¦çš„é…ç½®æœ‰ä¸¤ç‚¹ä¸åŒï¼š</p>
<ul>
<li>éœ€è¦åˆ é™¤ <code>IPv4</code> é…ç½®é¡¹ã€‚å› ä¸ºå®¶ç”¨å®½å¸¦çš„å…¬ç½‘ IP æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ‰€ä»¥ä½ éœ€è¦ä½¿ç”¨ <strong>DDNS</strong> æ¥åŠ¨æ€è§£æå…¬ç½‘ IPã€‚</li>
<li><code>HostName</code> æœ€å¥½å¡«åŸŸåï¼Œå› ä¸ºä½ çš„å…¬ç½‘ IP æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ²¡æ³•å¡«å†™ IPï¼Œé™¤éä½ ä¸åœåœ°ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚å¡«åŸŸåä¹Ÿæ²¡å…³ç³»å•¦ï¼Œåæ­£ä¸ä¼šéªŒè¯åŸŸåçš„ï¼Œä¹Ÿä¸ç”¨å…³å¿ƒè¯ä¹¦çš„äº‹æƒ…ï¼Œ<strong>åªè¦åŸŸåèƒ½è§£æåˆ°ä½ çš„å…¬ç½‘ IP å³å¯ã€‚</strong></li>
</ul>
<h2 id="é˜²æ­¢-DERP-è¢«ç™½å«–"><a href="#é˜²æ­¢-DERP-è¢«ç™½å«–" class="headerlink" title="é˜²æ­¢ DERP è¢«ç™½å«–"></a>é˜²æ­¢ DERP è¢«ç™½å«–</h2><p>é»˜è®¤æƒ…å†µä¸‹ DERP æœåŠ¡å™¨æ˜¯å¯ä»¥è¢«ç™½å«–çš„ï¼Œåªè¦åˆ«äººçŸ¥é“äº†ä½ çš„ DERP æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£ï¼Œå°±å¯ä»¥ä¸ºä»–æ‰€ç”¨ã€‚å¦‚æœä½ çš„æœåŠ¡å™¨æ˜¯ä¸ªå°æ°´ç®¡ï¼Œç”¨çš„äººå¤šäº†å¯èƒ½ä¼šæŠŠä½ æ’‘çˆ†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¿®æ”¹é…ç½®æ¥é˜²æ­¢è¢«ç™½å«–ã€‚</p>
<blockquote>
<p>ç‰¹åˆ«å£°æ˜ï¼šåªæœ‰ä½¿ç”¨åŸŸåçš„æ–¹å¼æ‰å¯ä»¥é€šè¿‡è®¤è¯é˜²æ­¢è¢«ç™½å«–ï¼Œä½¿ç”¨çº¯ IP çš„æ–¹å¼æ— æ³•é˜²ç™½å«–ï¼Œä½ åªèƒ½å°å¿ƒç¿¼ç¿¼åœ°éšè—å¥½ä½ çš„ IP å’Œç«¯å£ï¼Œä¸èƒ½è®©åˆ«äººçŸ¥é“ã€‚</p>
</blockquote>
<p>åªéœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼š</p>
<p><strong>1ã€åœ¨ DERP æœåŠ¡å™¨ä¸Šå®‰è£… Tailscaleã€‚</strong></p>
<p>ç¬¬ä¸€æ­¥éœ€è¦åœ¨ DERP æœåŠ¡æ‰€åœ¨çš„ä¸»æœºä¸Šå®‰è£… Tailscale å®¢æˆ·ç«¯ï¼Œ<strong>å¯åŠ¨ tailscaled è¿›ç¨‹</strong>ã€‚</p>
<p><strong>2ã€derper å¯åŠ¨æ—¶åŠ ä¸Šå‚æ•° <code>--verify-clients</code>ã€‚</strong></p>
<p>æœ¬æ–‡æ¨èçš„æ˜¯é€šè¿‡å®¹å™¨å¯åŠ¨ï¼Œ <a href="https://github.com/yangchuansheng/docker-image/blob/master/derper/Dockerfile" target="_blank" rel="external">Dockerfile å†…å®¹</a>å¦‚ä¸‹ï¼š</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> golang:latest AS builder</div><div class="line"></div><div class="line"><span class="keyword">LABEL</span><span class="bash"> org.opencontainers.image.source https://github.com/yangchuansheng/docker-image</span></div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> go install tailscale.com/cmd/derper@main</span></div><div class="line"></div><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line">ARG DEBIAN_FRONTEND=noninteractive</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></div><div class="line">    apt-get install -y --no-install-recommends apt-utils &amp;&amp; \</div><div class="line">    apt-get install -y ca-certificates &amp;&amp; \</div><div class="line">    mkdir /app/certs</div><div class="line"></div><div class="line"><span class="keyword">ENV</span> DERP_DOMAIN your-hostname.com</div><div class="line"><span class="keyword">ENV</span> DERP_CERT_MODE letsencrypt</div><div class="line"><span class="keyword">ENV</span> DERP_CERT_DIR /app/certs</div><div class="line"><span class="keyword">ENV</span> DERP_ADDR :<span class="number">443</span></div><div class="line"><span class="keyword">ENV</span> DERP_STUN true</div><div class="line"><span class="keyword">ENV</span> DERP_HTTP_PORT <span class="number">80</span></div><div class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /go/bin/derper .</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> /app/derper --hostname=<span class="variable">$DERP_DOMAIN</span> \</span></div><div class="line">    --certmode=<span class="variable">$DERP_CERT_MODE</span> \</div><div class="line">    --certdir=<span class="variable">$DERP_CERT_DIR</span> \</div><div class="line">    -<span class="_">-a</span>=<span class="variable">$DERP_ADDR</span> \</div><div class="line">    --stun=<span class="variable">$DERP_STUN</span>  \</div><div class="line">    --http-port=<span class="variable">$DERP_HTTP_PORT</span> \</div><div class="line">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></div></pre></td></tr></table></figure>
<p>é»˜è®¤æƒ…å†µä¸‹ <code>--verify-clients</code> å‚æ•°è®¾ç½®çš„æ˜¯ <code>false</code>ã€‚æˆ‘ä»¬ä¸éœ€è¦å¯¹ Dockerfile å†…å®¹åšä»»ä½•æ”¹åŠ¨ï¼Œåªéœ€åœ¨å®¹å™¨å¯åŠ¨æ—¶åŠ ä¸Šç¯å¢ƒå˜é‡å³å¯ï¼Œå°†ä¹‹å‰çš„å¯åŠ¨å‘½ä»¤ä¿®æ”¹ä¸€ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ğŸ³  â†’ docker run --restart always \</div><div class="line">  --name derper -p 12345:12345 -p 3478:3478/udp \</div><div class="line">  -v /root/.acme.sh/xxxx/:/app/certs \</div><div class="line">  <span class="_">-e</span> DERP_CERT_MODE=manual \</div><div class="line">  <span class="_">-e</span> DERP_ADDR=:12345 \</div><div class="line">  <span class="_">-e</span> DERP_DOMAIN=xxxx \</div><div class="line">  <span class="_">-e</span> DERP_VERIFY_CLIENTS=<span class="literal">true</span> \</div><div class="line">  <span class="_">-d</span> ghcr.io/yangchuansheng/derper:latest</div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¤§åŠŸå‘Šæˆäº†ï¼Œåˆ«äººå³ä½¿çŸ¥é“äº†ä½ çš„ DERP æœåŠ¡å™¨åœ°å€ä¹Ÿæ— æ³•ä½¿ç”¨ï¼Œä½†è¿˜æ˜¯è¦è¯´æ˜ä¸€ç‚¹ï¼Œå³ä¾¿å¦‚æ­¤ï¼Œä½ ä¹Ÿåº”è¯¥å°½é‡ä¸è®©åˆ«äººçŸ¥é“ä½ çš„æœåŠ¡å™¨åœ°å€ï¼Œé˜²æ­¢åˆ«äººæœ‰å¯è¶ä¹‹æœºã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ç»™å¤§å®¶ä»‹ç»äº† STUN å¯¹äºè¾…åŠ© NAT ç©¿é€çš„æ„ä¹‰ï¼Œç§‘æ™®äº†å‡ ç§å¸¸è§çš„ä¸­ç»§åè®®ï¼ŒåŒ…å« Tailscale è‡ªç ”çš„ DERP åè®®ã€‚æœ€åæ‰‹æŠŠæ‰‹æ•™å¤§å®¶å¦‚ä½•è‡ªå»ºç§æœ‰çš„ DERP æœåŠ¡å™¨ï¼Œå¹¶è®© Tailscale ä½¿ç”¨æˆ‘ä»¬è‡ªå»ºçš„ DERP æœåŠ¡å™¨ã€‚</p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/09/05/ä½¿ç”¨Tailscaleæ­å»ºVPNä¸“çº¿/" itemprop="url">
                  ä½¿ç”¨Tailscaleæ­å»ºVPNä¸“çº¿
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2022-09-05T19:16:18+08:00" content="2022-09-05">
              2022-09-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2022/09/05/ä½¿ç”¨Tailscaleæ­å»ºVPNä¸“çº¿/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2022/09/05/ä½¿ç”¨Tailscaleæ­å»ºVPNä¸“çº¿/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Tailscale-æ˜¯ä»€ä¹ˆ"><a href="#Tailscale-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Tailscale æ˜¯ä»€ä¹ˆ"></a>Tailscale æ˜¯ä»€ä¹ˆ</h2><p>Tailscale æ˜¯ä¸€ç§åŸºäº WireGuard çš„è™šæ‹Ÿç»„ç½‘å·¥å…·.</p>
<p>ä¸ OpenVPN ä¹‹æµç›¸æ¯”è¿˜æ˜¯èƒ½ç”©å¥½å‡ åæ¡è¡—çš„ï¼ŒTailscale è™½ç„¶åœ¨æ€§èƒ½ä¸Šåšäº†äº›è®¸å–èˆï¼Œä½†åœ¨åŠŸèƒ½å’Œæ˜“ç”¨æ€§ä¸Šç»å¯¹æ˜¯å®Œçˆ†å…¶ä»–å·¥å…·ï¼š</p>
<ol>
<li>å¼€ç®±å³ç”¨</li>
</ol>
<ul>
<li>æ— éœ€é…ç½®é˜²ç«å¢™</li>
<li>æ²¡æœ‰é¢å¤–çš„é…ç½®</li>
</ul>
<ol>
<li>é«˜å®‰å…¨æ€§/ç§å¯†æ€§</li>
</ol>
<ul>
<li>è‡ªåŠ¨å¯†é’¥è½®æ¢</li>
<li>ç‚¹å¯¹ç‚¹è¿æ¥</li>
<li>æ”¯æŒç”¨æˆ·å®¡æŸ¥ç«¯åˆ°ç«¯çš„è®¿é—®è®°å½•</li>
</ul>
<ol>
<li>åœ¨åŸæœ‰çš„ ICEã€STUN ç­‰ UDP åè®®å¤–ï¼Œå®ç°äº† DERP TCP åè®®æ¥å®ç° NAT ç©¿é€</li>
<li>åŸºäºå…¬ç½‘çš„æ§åˆ¶æœåŠ¡å™¨ä¸‹å‘ ACL å’Œé…ç½®ï¼Œå®ç°èŠ‚ç‚¹åŠ¨æ€æ›´æ–°</li>
<li>é€šè¿‡ç¬¬ä¸‰æ–¹ï¼ˆå¦‚ Googleï¼‰ SSO æœåŠ¡ç”Ÿæˆç”¨æˆ·å’Œç§é’¥ï¼Œå®ç°èº«ä»½è®¤è¯</li>
</ol>
<p>ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬å¯ä»¥å°† Tailscale çœ‹æˆæ˜¯æ›´ä¸ºæ˜“ç”¨ã€åŠŸèƒ½æ›´å®Œå–„çš„ WireGuardã€‚</p>
<h2 id="Headscale-æ˜¯ä»€ä¹ˆ"><a href="#Headscale-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Headscale æ˜¯ä»€ä¹ˆ"></a>Headscale æ˜¯ä»€ä¹ˆ</h2><p>Tailscale çš„æ§åˆ¶æœåŠ¡å™¨æ˜¯ä¸å¼€æºçš„ï¼Œè€Œä¸”å¯¹å…è´¹ç”¨æˆ·æœ‰è¯¸å¤šé™åˆ¶ï¼Œè¿™æ˜¯äººå®¶çš„æ‘‡é’±æ ‘ï¼Œå¯ä»¥ç†è§£ã€‚å¥½åœ¨ç›®å‰æœ‰ä¸€æ¬¾å¼€æºçš„å®ç°å« <a href="https://github.com/juanfont/headscale" target="_blank" rel="external">Headscale</a>ï¼Œè¿™ä¹Ÿæ˜¯å”¯ä¸€çš„ä¸€æ¬¾ï¼Œå¸Œæœ›èƒ½å‘å±•å£®å¤§ã€‚</p>
<p>Headscale ç”±æ¬§æ´²èˆªå¤©å±€çš„ Juan Font ä½¿ç”¨ Go è¯­è¨€å¼€å‘ï¼Œåœ¨ BSD è®¸å¯ä¸‹å‘å¸ƒï¼Œå®ç°äº† Tailscale æ§åˆ¶æœåŠ¡å™¨çš„æ‰€æœ‰ä¸»è¦åŠŸèƒ½ï¼Œå¯ä»¥éƒ¨ç½²åœ¨ä¼ä¸šå†…éƒ¨ï¼Œæ²¡æœ‰ä»»ä½•è®¾å¤‡æ•°é‡çš„é™åˆ¶ï¼Œä¸”æ‰€æœ‰çš„ç½‘ç»œæµé‡éƒ½ç”±è‡ªå·±æ§åˆ¶</p>
<h2 id="Headscale-éƒ¨ç½²"><a href="#Headscale-éƒ¨ç½²" class="headerlink" title="Headscale éƒ¨ç½²"></a>Headscale éƒ¨ç½²</h2><p>Headscale éƒ¨ç½²å¾ˆç®€å•ï¼Œæ¨èç›´æ¥åœ¨ Linux ä¸»æœºä¸Šå®‰è£…</p>
<p>é¦–å…ˆéœ€è¦åˆ°å…¶ GitHub ä»“åº“çš„ Release é¡µé¢ä¸‹è½½æœ€æ–°ç‰ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ wget --output-document=/usr/<span class="built_in">local</span>/bin/headscale \</div><div class="line">   https://github.com/juanfont/headscale/releases/download/v&lt;HEADSCALE VERSION&gt;/headscale_&lt;HEADSCALE VERSION&gt;_linux_&lt;ARCH&gt;</div><div class="line"></div><div class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/headscale</div></pre></td></tr></table></figure>
<p>åˆ›å»ºé…ç½®ç›®å½•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /etc/headscale</div></pre></td></tr></table></figure>
<p>åˆ›å»ºç›®å½•ç”¨æ¥å­˜å‚¨æ•°æ®ä¸è¯ä¹¦ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /var/lib/headscale</div></pre></td></tr></table></figure>
<p>åˆ›å»ºç©ºçš„ SQLite æ•°æ®åº“æ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ touch /var/lib/headscale/db.sqlite</div></pre></td></tr></table></figure>
<p>åˆ›å»º Headscale é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ wget https://github.com/juanfont/headscale/raw/main/config-example.yaml -O /etc/headscale/config.yaml</div></pre></td></tr></table></figure>
<ul>
<li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå°† <code>server_url</code> æ”¹ä¸ºå…¬ç½‘ IP æˆ–åŸŸåã€‚<strong>å¦‚æœæ˜¯å›½å†…æœåŠ¡å™¨ï¼ŒåŸŸåå¿…é¡»è¦å¤‡æ¡ˆ</strong>ã€‚æˆ‘çš„åŸŸåæ— æ³•å¤‡æ¡ˆï¼Œæ‰€ä»¥æˆ‘å°±ç›´æ¥ç”¨å…¬ç½‘ IP äº†ã€‚</p>
</li>
<li><p>å¦‚æœæš‚æ—¶ç”¨ä¸åˆ° DNS åŠŸèƒ½ï¼Œå¯ä»¥å…ˆå°† <code>magic_dns</code> è®¾ä¸º falseã€‚</p>
</li>
<li><p><code>server_url</code> è®¾ç½®ä¸º <code>http://&lt;PUBLIC_IP&gt;:8080</code>ï¼Œå°† <code>&lt;PUBLIC_IP&gt;</code> æ›¿æ¢ä¸ºå…¬ç½‘ IP æˆ–è€…åŸŸåã€‚</p>
</li>
<li><p>å¯è‡ªå®šä¹‰ç§æœ‰ç½‘æ®µï¼Œä¹Ÿå¯åŒæ—¶å¼€å¯ IPv4 å’Œ IPv6ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">ip_prefixes:</span></div><div class="line">  <span class="comment"># - fd7a:115c:a1e0::/48</span></div><div class="line"><span class="bullet">  -</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>åˆ›å»º SystemD service é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /etc/systemd/system/headscale.service</span></div><div class="line">[Unit]</div><div class="line">Description=headscale controller</div><div class="line">After=syslog.target</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=simple</div><div class="line">User=headscale</div><div class="line">Group=headscale</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/headscale serve</div><div class="line">Restart=always</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line"><span class="comment"># Optional security enhancements</span></div><div class="line">NoNewPrivileges=yes</div><div class="line">PrivateTmp=yes</div><div class="line">ProtectSystem=strict</div><div class="line">ProtectHome=yes</div><div class="line">ReadWritePaths=/var/lib/headscale /var/run/headscale</div><div class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</div><div class="line">RuntimeDirectory=headscale</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>åˆ›å»º headscale ç”¨æˆ·ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ useradd headscale <span class="_">-d</span> /home/headscale -m</div></pre></td></tr></table></figure>
<p>ä¿®æ”¹ /var/lib/headscale ç›®å½•çš„ ownerï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ chown -R headscale:headscale /var/lib/headscale</div></pre></td></tr></table></figure>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ <code>unix_socket</code>ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">unix_socket:</span> /var/run/headscale/headscale.sock</div></pre></td></tr></table></figure>
<p>Reload SystemD ä»¥åŠ è½½æ–°çš„é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl daemon-reload</div></pre></td></tr></table></figure>
<p>å¯åŠ¨ Headscale æœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl <span class="built_in">enable</span> --now headscale</div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl status headscale</div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹å ç”¨ç«¯å£ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ ss -tulnp|grep headscale</div><div class="line"></div><div class="line">tcp LISTEN 0 1024 [::]:9090 [::]:* users:((<span class="string">"headscale"</span>,pi</div><div class="line"></div><div class="line">d=10899,fd=13))</div><div class="line"></div><div class="line">tcp LISTEN 0 1024 [::]:50443 [::]:* users:((<span class="string">"headscale"</span>,pi</div><div class="line"></div><div class="line">d=10899,fd=10))</div><div class="line"></div><div class="line">tcp LISTEN 0 1024 [::]:8080 [::]:* users:((<span class="string">"headscale"</span>,pi</div><div class="line"></div><div class="line">d=10899,fd=12))</div></pre></td></tr></table></figure>
<p>ailscale ä¸­æœ‰ä¸€ä¸ªæ¦‚å¿µå« tailnetï¼Œä½ å¯ä»¥ç†è§£æˆç§Ÿæˆ·ï¼Œç§Ÿæˆ·ä¸ç§Ÿæˆ·ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œå…·ä½“çœ‹å‚è€ƒ Tailscale çš„å®˜æ–¹æ–‡æ¡£ï¼š <a href="https://tailscale.com/kb/1136/tailnet/" target="_blank" rel="external">What is a tailnet</a>ã€‚Headscale ä¹Ÿæœ‰ç±»ä¼¼çš„å®ç°å« namespaceï¼Œå³å‘½åç©ºé—´ã€‚æˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª namespaceï¼Œä»¥ä¾¿åç»­å®¢æˆ·ç«¯æ¥å…¥ï¼Œä¾‹å¦‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">headscale namespaces create vpn</div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹å‘½åç©ºé—´ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ headscale namespaces list</div><div class="line"></div><div class="line">ID | Name | Created</div><div class="line"></div><div class="line">1 | vpn | 2022-03-09 06:12:06</div></pre></td></tr></table></figure>
<h2 id="Tailscale-å®¢æˆ·ç«¯æ¥å…¥"><a href="#Tailscale-å®¢æˆ·ç«¯æ¥å…¥" class="headerlink" title="Tailscale å®¢æˆ·ç«¯æ¥å…¥"></a>Tailscale å®¢æˆ·ç«¯æ¥å…¥</h2><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Tailscale å®˜æ–¹æä¾›äº†å„ç§ Linux å‘è¡Œç‰ˆçš„è½¯ä»¶åŒ…ï¼Œä½†å›½å†…çš„ç½‘ç»œä½ æ‡‚å¾—ï¼Œè½¯ä»¶æºæ ¹æœ¬ç”¨ä¸äº†ã€‚å¥½åœ¨å®˜æ–¹è¿˜æä¾›äº† <a href="https://tailscale.com/download/linux/static" target="_blank" rel="external">é™æ€ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶</a>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¸‹è½½ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ wget https://pkgs.tailscale.com/stable/tailscale_1.22.2_amd64.tgz</div></pre></td></tr></table></figure>
<p>è§£å‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ tar zxvf tailscale_1.22.2_amd64.tgz</div><div class="line">x tailscale_1.22.2_amd64/</div><div class="line">x tailscale_1.22.2_amd64/tailscale</div><div class="line">x tailscale_1.22.2_amd64/tailscaled</div><div class="line">x tailscale_1.22.2_amd64/systemd/</div><div class="line">x tailscale_1.22.2_amd64/systemd/tailscaled.defaults</div><div class="line">x tailscale_1.22.2_amd64/systemd/tailscaled.service</div></pre></td></tr></table></figure>
<p>å°†äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°å®˜æ–¹è½¯ä»¶åŒ…é»˜è®¤çš„è·¯å¾„ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cp tailscale_1.22.2_amd64/tailscaled /usr/sbin/tailscaled</div><div class="line">$ cp tailscale_1.22.2_amd64/tailscale /usr/bin/tailscale</div></pre></td></tr></table></figure>
<p>å°† systemD service é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°ç³»ç»Ÿè·¯å¾„ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp tailscale_1.22.2_amd64/systemd/tailscaled.service /lib/systemd/system/tailscaled.service</div></pre></td></tr></table></figure>
<p>å°†ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°ç³»ç»Ÿè·¯å¾„ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp tailscale_1.22.2_amd64/systemd/tailscaled.defaults /etc/default/tailscaled</div></pre></td></tr></table></figure>
<p>å¯åŠ¨ tailscaled.service å¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl <span class="built_in">enable</span> --now tailscaled</div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl status tailscaled</div></pre></td></tr></table></figure>
<p>Tailscale æ¥å…¥ Headscaleï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å°† &lt;HEADSCALE_PUB_IP&gt; æ¢æˆä½ çš„ Headscale å…¬ç½‘ IP æˆ–åŸŸå</span></div><div class="line">$ tailscale up --login-server=http://xx.xx.xx.xx:8080 --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.xx.0/24</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæ¨èå°† DNS åŠŸèƒ½å…³é—­ï¼Œå› ä¸ºå®ƒä¼šè¦†ç›–ç³»ç»Ÿçš„é»˜è®¤ DNSã€‚å¦‚æœä½ å¯¹ DNS æœ‰éœ€æ±‚ï¼Œå¯è‡ªå·±ç ”ç©¶å®˜æ–¹æ–‡æ¡£ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<p>æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤åï¼Œä¼šå‡ºç°ä¸‹é¢çš„ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">To authenticate, visit:</div><div class="line"></div><div class="line">http://xxxxxx:8080/register?key=905cf165204800247fbd33989dbc22be95c987286c45aac303393704</div><div class="line"></div><div class="line">1150d846</div></pre></td></tr></table></figure>
<p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¥é“¾æ¥ï¼Œå°±ä¼šå‡ºç°å¦‚ä¸‹çš„ç•Œé¢</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-06-08qWbz.png" alt=""></p>
<p>å°†å…¶ä¸­çš„å‘½ä»¤å¤åˆ¶ç²˜è´´åˆ° headscale æ‰€åœ¨æœºå™¨çš„ç»ˆç«¯ä¸­ï¼Œå¹¶å°† NAMESPACE æ›¿æ¢ä¸ºå‰é¢æ‰€åˆ›å»ºçš„ namespaceã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ headscale -n vpn nodes register --key 905cf165204800247fbd33989dbc22be95c987286c45aac3033937041150d846</div><div class="line">Machine register</div></pre></td></tr></table></figure>
<p>æ³¨å†ŒæˆåŠŸï¼ŒæŸ¥çœ‹æ³¨å†Œçš„èŠ‚ç‚¹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ headscale nodes list</div><div class="line"></div><div class="line">ID | Name | NodeKey | Namespace | IP addresses | Ephemeral | Last seen | Onlin</div><div class="line"></div><div class="line">e | Expired</div><div class="line"></div><div class="line">1 | coredns | [Ew3RB] | vpn | 10.1.0.1 | <span class="literal">false</span> | 2022-03-20 09:08:58 | onlin</div><div class="line"></div><div class="line">e | no</div></pre></td></tr></table></figure>
<p>å›åˆ° Tailscale å®¢æˆ·ç«¯æ‰€åœ¨çš„ Linux ä¸»æœºï¼Œå¯ä»¥çœ‹åˆ° Tailscale ä¼šè‡ªåŠ¨åˆ›å»ºç›¸å…³çš„è·¯ç”±è¡¨å’Œ iptables è§„åˆ™ã€‚è·¯ç”±è¡¨å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ip route show table 52</div></pre></td></tr></table></figure>
<h3 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h3><p>macOS æœ‰ 3 ç§å®‰è£…æ–¹æ³•ï¼š</p>
<ul>
<li>ç›´æ¥é€šè¿‡åº”ç”¨å•†åº—å®‰è£…ï¼Œåœ°å€ï¼š <a href="https://apps.apple.com/ca/app/tailscale/id1475387142ã€‚å‰ææ˜¯ä½ **éœ€è¦ä¸€ä¸ªç¾åŒº" target="_blank" rel="external">https://apps.apple.com/ca/app/tailscale/id1475387142ã€‚å‰ææ˜¯ä½ **éœ€è¦ä¸€ä¸ªç¾åŒº</a> ID**ã€‚ã€‚ã€‚</li>
<li>ä¸‹è½½ <a href="https://pkgs.tailscale.com/stable/#macos" target="_blank" rel="external">å®‰è£…åŒ…</a>ç›´æ¥å®‰è£…ï¼Œç»•è¿‡åº”ç”¨å•†åº—ã€‚</li>
<li>å®‰è£…å¼€æºçš„å‘½ä»¤è¡Œå·¥å…· <code>tailscale</code> å’Œ <code>tailscaled</code>ã€‚ç›¸å…³é“¾æ¥ï¼š <a href="https://github.com/tailscale/tailscale/wiki/Tailscaled-on-macOSã€‚" target="_blank" rel="external">https://github.com/tailscale/tailscale/wiki/Tailscaled-on-macOSã€‚</a></li>
</ul>
<p>è¿™ä¸‰ç§å®‰è£…åŒ…çš„æ ¸å¿ƒæ•°æ®åŒ…å¤„ç†ä»£ç æ˜¯ç›¸åŒçš„ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºåœ¨äºæ‰“åŒ…æ–¹å¼ä»¥åŠä¸ç³»ç»Ÿçš„äº¤äº’æ–¹å¼</p>
<p>å®‰è£…å®Œ GUI ç‰ˆåº”ç”¨åè¿˜éœ€è¦åšä¸€äº›éªšæ“ä½œï¼Œæ‰èƒ½è®© Tailscale ä½¿ç”¨ Headscale ä½œä¸ºæ§åˆ¶æœåŠ¡å™¨ã€‚å½“ç„¶ï¼ŒHeadscale å·²ç»ç»™æˆ‘ä»¬æä¾›äº†è¯¦ç»†çš„æ“ä½œæ­¥éª¤ï¼Œä½ åªéœ€è¦åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ URLï¼š<code>http://&lt;HEADSCALE_PUB_IP&gt;:8080/apple</code>ï¼Œä¾¿ä¼šå‡ºç°å¦‚ä¸‹çš„ç•Œé¢ï¼š</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-39-arYdfv.png" alt=""></p>
<blockquote>
<p>éåº”ç”¨å•†åº—ç‰ˆæœ¬çš„ macOS å®¢æˆ·ç«¯éœ€è¦å°† <code>io.tailscale.ipn.macos</code> æ›¿æ¢ä¸º <code>io.tailscale.ipn.macsys</code>ã€‚å³ï¼š<code>defaults write io.tailscale.ipn.macsys ControlURL http://&lt;HEADSCALE_PUB_IP&gt;:8080</code></p>
</blockquote>
<p>ä¿®æ”¹å®Œæˆåé‡å¯ Tailscale å®¢æˆ·ç«¯ï¼Œåœ¨ macOS é¡¶éƒ¨çŠ¶æ€æ ä¸­æ‰¾åˆ° Tailscale å¹¶ç‚¹å‡»ï¼Œç„¶åå†ç‚¹å‡» <code>Log in</code></p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-43-pTW3r7.png" alt=""></p>
<p>ç„¶åç«‹é©¬å°±ä¼šè·³è½¬åˆ°æµè§ˆå™¨å¹¶æ‰“å¼€ä¸€ä¸ªé¡µé¢ã€‚</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-46-AbzngB.png" alt=""></p>
<p>æ¥ä¸‹æ¥ä¸ä¹‹å‰ Linux å®¢æˆ·ç«¯ç›¸åŒï¼Œå›åˆ° Headscale æ‰€åœ¨çš„æœºå™¨æ‰§è¡Œæµè§ˆå™¨ä¸­çš„å‘½ä»¤å³å¯ï¼Œæ³¨å†ŒæˆåŠŸ</p>
<p>å›åˆ° Headscale æ‰€åœ¨ä¸»æœºï¼ŒæŸ¥çœ‹æ³¨å†Œçš„èŠ‚ç‚¹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ headscale nodes list</div><div class="line"></div><div class="line">ID | Name | NodeKey | Namespace | IP addresses | Ephemeral | Last seen | Onlin</div><div class="line"></div><div class="line">e | Expired</div><div class="line"></div><div class="line">1 | coredns | [Ew3RB] | default | 10.1.0.1 | <span class="literal">false</span> | 2022-03-20 09:08:58 | onlin</div><div class="line"></div><div class="line">e | no</div><div class="line">2 | carsondemacbook-pro | [k7bzX] | default   | 10.1.0.2     | <span class="literal">false</span>     | 2022-03-20 09:48:30 | online  | no</div></pre></td></tr></table></figure>
<p>å›åˆ° macOSï¼Œæµ‹è¯•æ˜¯å¦èƒ½ ping é€šå¯¹ç«¯èŠ‚ç‚¹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ ping -c 2 10.1.0.1</div><div class="line">PING 10.1.0.1 (10.1.0.1): 56 data bytes</div><div class="line">64 bytes from 10.1.0.1: icmp_seq=0 ttl=64 time=37.025 ms</div><div class="line">64 bytes from 10.1.0.1: icmp_seq=1 ttl=64 time=38.181 ms</div><div class="line"></div><div class="line">--- 10.1.0.1 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0.0% packet loss</div><div class="line">round-trip min/avg/max/stddev = 37.025/37.603/38.181/0.578 ms</div></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ Tailscale CLI æ¥æµ‹è¯•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ /Applications/Tailscale.app/Contents/MacOS/Tailscale ping 10.1.0.1</div><div class="line">pong from coredns (10.1.0.1) via xxxx:41641 <span class="keyword">in</span> 36ms</div></pre></td></tr></table></figure>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>Windows Tailscale å®¢æˆ·ç«¯æƒ³è¦ä½¿ç”¨ Headscale ä½œä¸ºæ§åˆ¶æœåŠ¡å™¨ï¼Œåªéœ€åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ URLï¼š<code>http://&lt;HEADSCALE_PUB_IP&gt;:8080/windows</code>ï¼Œä¾¿ä¼šå‡ºç°å¦‚ä¸‹çš„ç•Œé¢</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-23-30-zcQX3F.png" alt=""></p>
<p>æŒ‰ç…§å…¶ä¸­çš„æ­¥éª¤æ“ä½œå³å¯ã€‚</p>
<h3 id="é€šè¿‡-Pre-Authkeys-æ¥å…¥"><a href="#é€šè¿‡-Pre-Authkeys-æ¥å…¥" class="headerlink" title="é€šè¿‡ Pre-Authkeys æ¥å…¥"></a>é€šè¿‡ Pre-Authkeys æ¥å…¥</h3><p>å‰é¢çš„æ¥å…¥æ–¹æ³•éƒ½éœ€è¦æœåŠ¡ç«¯åŒæ„ï¼Œæ­¥éª¤æ¯”è¾ƒçƒ¦çï¼Œå…¶å®è¿˜æœ‰æ›´ç®€å•çš„æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥æ¥å…¥ï¼Œä¸éœ€è¦æœåŠ¡ç«¯åŒæ„ã€‚</p>
<p>é¦–å…ˆåœ¨æœåŠ¡ç«¯ç”Ÿæˆ pre-authkey çš„ tokenï¼Œæœ‰æ•ˆæœŸå¯ä»¥è®¾ç½®ä¸º 24 å°æ—¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ headscale preauthkeys create <span class="_">-e</span> 24h -n default</div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹å·²ç»ç”Ÿæˆçš„ keyï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ headscale -n default preauthkeys list</div><div class="line">ID | Key                                              | Reusable | Ephemeral | Used  | Expiration          | Created            </div><div class="line">1  | 57e419c40e30b0dxxxxxxxf15562c18a8c6xxxx28ae76f57 | <span class="literal">false</span>    | <span class="literal">false</span>     | <span class="literal">false</span> | 2022-05-30 07:14:17 | 2022-05-29 07:14:17</div></pre></td></tr></table></figure>
<p>ç°åœ¨æ–°èŠ‚ç‚¹å°±å¯ä»¥æ— éœ€æœåŠ¡ç«¯åŒæ„ç›´æ¥æ¥å…¥äº†ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tailscale up --login-server=http://&lt;HEADSCALE_PUB_IP&gt;:8080 --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --authkey <span class="variable">$KEY</span></div></pre></td></tr></table></figure>
<h2 id="æ‰“é€šå±€åŸŸç½‘"><a href="#æ‰“é€šå±€åŸŸç½‘" class="headerlink" title="æ‰“é€šå±€åŸŸç½‘"></a>æ‰“é€šå±€åŸŸç½‘</h2><p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬åªæ˜¯æ‰“é€ äº†ä¸€ä¸ªç‚¹å¯¹ç‚¹çš„ Mesh ç½‘ç»œï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´éƒ½å¯ä»¥é€šè¿‡ WireGuard çš„ç§æœ‰ç½‘ç»œ IP è¿›è¡Œç›´è¿ã€‚ä½†æˆ‘ä»¬å¯ä»¥æ›´å¤§èƒ†ä¸€ç‚¹ï¼Œè¿˜è®°å¾—æˆ‘åœ¨æ–‡ç« å¼€å¤´æåˆ°çš„è®¿é—®å®¶åº­å†…ç½‘çš„èµ„æºå—ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡é€‚å½“çš„é…ç½®è®©æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è®¿é—®å…¶ä»–èŠ‚ç‚¹çš„å±€åŸŸç½‘ IPã€‚è¿™ä¸ªä½¿ç”¨åœºæ™¯å°±æ¯”è¾ƒå¤šäº†ï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—®å®¶åº­å†…ç½‘çš„ NASï¼Œæˆ–è€…å†…ç½‘çš„ä»»ä½•ä¸€ä¸ªæœåŠ¡ï¼Œ<strong>æ›´é«˜çº§çš„ç©å®¶å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ¥è®¿é—®äº‘ä¸Š Kubernetes é›†ç¾¤çš„ Pod IP å’Œ Service IPã€‚</strong></p>
<p>å‡è®¾ä½ çš„å®¶åº­å†…ç½‘æœ‰ä¸€å° Linux ä¸»æœºï¼ˆæ¯”å¦‚ OpenWrtï¼‰å®‰è£…äº† Tailscale å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å¸Œæœ›å…¶ä»– Tailscale å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥é€šè¿‡å®¶ä¸­çš„å±€åŸŸç½‘ IPï¼ˆä¾‹å¦‚ <strong>192.168.100.0/24</strong>ï¼‰ è®¿é—®å®¶åº­å†…ç½‘çš„ä»»ä½•ä¸€å°è®¾å¤‡ã€‚</p>
<p>é…ç½®æ–¹æ³•å¾ˆç®€å•ï¼Œé¦–å…ˆéœ€è¦è®¾ç½® IPv4 ä¸ IPv6 è·¯ç”±è½¬å‘ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">echo</span> <span class="string">'net.ipv4.ip_forward = 1'</span> | tee /etc/sysctl.d/ipforwarding.conf</div><div class="line">$ <span class="built_in">echo</span> <span class="string">'net.ipv6.conf.all.forwarding = 1'</span> | tee <span class="_">-a</span> /etc/sysctl.d/ipforwarding.conf</div><div class="line">$ sysctl -p /etc/sysctl.d/ipforwarding.conf</div></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯ä¿®æ”¹æ³¨å†ŒèŠ‚ç‚¹çš„å‘½ä»¤ï¼Œåœ¨åŸæ¥å‘½ä»¤çš„åŸºç¡€ä¸ŠåŠ ä¸Šå‚æ•° <code>--advertise-routes=192.168.100.0/24</code>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tailscale up --login-server=http://&lt;HEADSCALE_PUB_IP&gt;:8080 --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.100.0/24</div></pre></td></tr></table></figure>
<p>åœ¨ Headscale ç«¯æŸ¥çœ‹è·¯ç”±ï¼Œå¯ä»¥çœ‹åˆ°ç›¸å…³è·¯ç”±æ˜¯å…³é—­çš„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ headscale nodes list|grep openwrt</div><div class="line"></div><div class="line">6 | openwrt | [7LdVc] | default | 10.1.0.6 | <span class="literal">false</span> | 2022-03-20 15:50:46 | onlin</div><div class="line"></div><div class="line">e | no</div><div class="line"></div><div class="line">$ headscale routes list -i 6</div><div class="line"></div><div class="line">Route | Enabled</div><div class="line"></div><div class="line">192.168.100.0/24 | <span class="literal">false</span></div></pre></td></tr></table></figure>
<p>å¼€å¯è·¯ç”±ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ headscale routes <span class="built_in">enable</span> -i 6 -r <span class="string">"192.168.100.0/24"</span></div><div class="line"></div><div class="line">Route | Enabled</div><div class="line"></div><div class="line">192.168.100.0/24 | <span class="literal">true</span></div></pre></td></tr></table></figure>
<p>å…¶ä»–èŠ‚ç‚¹æŸ¥çœ‹è·¯ç”±ç»“æœï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ip route show table 52|grep <span class="string">"192.168.100.0/24"</span></div><div class="line">192.168.100.0/24 dev tailscale0</div></pre></td></tr></table></figure>
<p>ç°åœ¨ä½ åœ¨ä»»ä½•ä¸€ä¸ª Tailscale å®¢æˆ·ç«¯æ‰€åœ¨çš„èŠ‚ç‚¹éƒ½å¯ä»¥ ping é€šå®¶åº­å†…ç½‘çš„æœºå™¨.</p>
<hr>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/08/26/Elasticsearch-ä¹‹Data-stream/" itemprop="url">
                  Elasticsearch ä¹‹Data stream
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2022-08-26T17:05:46+08:00" content="2022-08-26">
              2022-08-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2022/08/26/Elasticsearch-ä¹‹Data-stream/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2022/08/26/Elasticsearch-ä¹‹Data-stream/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>æ•°æ®æµ</li>
<li>Elasticsearch</li>
</ul>
<h2 id="Data-stream-çš„æ¦‚å¿µ"><a href="#Data-stream-çš„æ¦‚å¿µ" class="headerlink" title="Data stream çš„æ¦‚å¿µ"></a>Data stream çš„æ¦‚å¿µ</h2><h3 id="æ—¶åºæ€§æ•°æ®"><a href="#æ—¶åºæ€§æ•°æ®" class="headerlink" title="æ—¶åºæ€§æ•°æ®"></a>æ—¶åºæ€§æ•°æ®</h3><p>æ—¶é—´åºåˆ—æ•°æ®ï¼ˆ time series data ï¼‰æ˜¯åœ¨ä¸åŒæ—¶é—´ä¸Šæ”¶é›†åˆ°çš„æ•°æ®ï¼Œç”¨äºæ‰€æè¿°ç°è±¡éšæ—¶é—´å˜åŒ–çš„æƒ…å†µã€‚è¿™ç±»æ•°æ®åæ˜ äº†æŸä¸€äº‹ç‰©ã€ç°è±¡ç­‰ï¼Œéšæ—¶é—´çš„å˜åŒ–çŠ¶æ€æˆ–ç¨‹åº¦ã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼Œè¿™ç±»æ•°æ®ä¸»è¦åŸºäºæ—¶é—´ç‰¹æ€§æ˜æ˜¾ï¼Œéšç€æ—¶é—´çš„æµé€ï¼Œå¾€å¾€è¿‡å»æ—¶é—´çš„æ•°æ®æ²¡æœ‰ç°åœ¨æ—¶é—´çš„é‡è¦æˆ–è€…æ•æ„Ÿã€‚</p>
<p>å¯¹äº Elastisearch å¤„ç†æ—¶åºæ€§æ•°æ®ï¼Œæœ‰äººæ€»ç»“äº†ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ç”±æ—¶é—´æˆ³ + æ•°æ®ç»„æˆã€‚åŸºäºæ—¶é—´çš„äº‹ä»¶ï¼Œå¯ä»¥æ˜¯æœåŠ¡å™¨æ—¥å¿—æˆ–è€…ç¤¾äº¤åª’ä½“æµã€‚</li>
<li>é€šå¸¸æœç´¢æœ€è¿‘äº‹ä»¶ï¼Œæ—§æ–‡ä»¶å˜å¾—ä¸å¤ªé‡è¦ã€‚</li>
<li>ç´¢å¼•çš„ä½¿ç”¨ä¸»è¦åŸºäºæ—¶é—´ï¼Œä½†æ˜¯æ•°æ®å¹¶ä¸ä¸€å®šéšç€æ—¶é—´å‡è¡¡åˆ†å¸ƒã€‚</li>
<li>æ—¶åºæ€§æ•°æ®ä¸€æ—¦å­˜å…¥åå¾ˆå°‘ä¿®æ”¹ã€‚</li>
<li>æ—¶åºæ€§æ•°æ®éšç€æ—¶é—´çš„å¢åŠ ï¼Œæ•°æ®é‡ä¼šå¾ˆå¤§ã€‚</li>
</ul>
<p>Elastisearch åœ¨æ—¶åºæ€§æ•°æ®çš„ä½¿ç”¨ä¸­ï¼Œå¾€å¾€ä¼šæœ‰ä»¥ä¸‹çš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>ç´¢å¼•éšç€æ—¶é—´å¢åŠ è€Œæ•°ç›®è¾ƒå¤šã€‚</li>
<li>ç´¢å¼•å¤§å°æ— æ³•å‡è¡¡ã€‚</li>
<li>ç®¡ç†ç´¢å¼•æˆæœ¬è¾ƒé«˜ï¼Œéœ€è¦ç»´æŠ¤ merge åˆå¹¶åˆ é™¤ç­‰ä¸€ç³»åˆ—ä»»åŠ¡ã€‚</li>
<li>èŠ‚ç‚¹èµ„æºä¸å†·çƒ­æ•°æ®åˆ†å¸ƒä¸åŒ¹é…ã€‚</li>
</ul>
<p>åœ¨è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯ä¸‹ï¼Œæ•°æ®æµ Data stream åº”è¿è€Œç”Ÿã€‚</p>
<p>Data stream ï¼ˆæ•°æ®æµï¼‰æ˜¯ Elastic Stack 7.9 çš„ä¸€ä¸ªæ–°çš„åŠŸèƒ½ã€‚Data stream å¯ä»¥è·¨å¤šä¸ªç´¢å¼•å­˜å‚¨åªè¿½åŠ æ—¶åºæ€§æ•°æ®ï¼ŒåŒæ—¶ä¸ºæŸ¥è¯¢å†™å…¥ç­‰è¯·æ±‚æä¾›å”¯ä¸€çš„ä¸€ä¸ªå‘½åèµ„æºã€‚Data stream éå¸¸é€‚åˆæ—¥å¿—ï¼Œäº‹ä»¶ï¼ŒæŒ‡æ ‡ä»¥åŠå…¶ä»–æŒç»­ç”Ÿæˆçš„æ•°æ®ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼ŒData stream æ ¹æ®æ¨¡æ¿ç”Ÿæˆå­˜å‚¨æ•°æ®çš„åå¤‡ç´¢å¼•ï¼Œç„¶åè‡ªåŠ¨å°†æœç´¢æˆ–è€…ç´¢å¼•è¯·æ±‚è·¯ç”±åˆ°å­˜å‚¨æµæ•°æ®çš„åå¤‡ç´¢å¼•ã€‚è€Œè¿™äº›åå¤‡ç´¢å¼•åˆ™æ ¹æ®ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆ ILM ï¼‰æ¥è‡ªåŠ¨ç®¡ç†ã€‚</p>
<h2 id="Data-stream-çš„ç»„æˆ"><a href="#Data-stream-çš„ç»„æˆ" class="headerlink" title="Data stream çš„ç»„æˆ"></a>Data stream çš„ç»„æˆ</h2><p>æ•°æ®æµåœ¨ Elasticsearch é›†ç¾¤ä¸­ç”±ä¸€ä¸ªæˆ–å¤šä¸ªéšè—çš„ã€è‡ªåŠ¨ç”Ÿæˆçš„åå¤‡ç´¢å¼•ç»„æˆã€‚</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/2a1db1d79f6448398201a833be2e1d6c.png" alt=""></p>
<p>åœ¨å®é™…çš„ Elasticsearch æ“ä½œä¸­ï¼Œæ•°æ®æµä¾é ç´¢å¼•æ¨¡æ¿æ¥è®¾å®šæ•°æ®æµå®ä½“çš„åå¤‡ç´¢å¼•ã€‚</p>
<ul>
<li>æ¨¡æ¿åŒ…å«ç”¨äºé…ç½®æµçš„åå¤‡ç´¢å¼•çš„æ˜ å°„å’Œè®¾ç½®ã€‚</li>
<li>åŒä¸€ä¸ªç´¢å¼•æ¨¡æ¿å¯ç”¨äºå¤šä¸ªæ•°æ®æµã€‚</li>
<li>ä¸èƒ½åˆ é™¤æ•°æ®æµæ­£åœ¨ä½¿ç”¨çš„ç´¢å¼•æ¨¡æ¿ã€‚</li>
</ul>
<p>æ¯ä¸ªç´¢å¼•åˆ°æ•°æ®æµçš„æ–‡æ¡£ï¼Œå¿…é¡»åŒ…å«ä¸€ä¸ª @timestamp å­—æ®µï¼Œæ˜ å°„ä¸º date æˆ– date_nanos å­—æ®µç±»å‹ã€‚å¦‚æœç´¢å¼•æ¨¡æ¿æ²¡æœ‰ä¸º @timestamp å­—æ®µæŒ‡å®šæ˜ å°„ï¼ŒElasticsearch å°† @timestamp æ˜ å°„ä¸ºå¸¦æœ‰é»˜è®¤é€‰é¡¹çš„æ—¥æœŸå­—æ®µã€‚</p>
<p>Data stream çš„è¯»è¯·æ±‚ä¸»è¦å¦‚ä¸‹å›¾ï¼Œæ•°æ®æµè‡ªåŠ¨å°†è¯·æ±‚è·¯ç”±åˆ°å…¶æ‰€æœ‰åå¤‡ç´¢å¼•ã€‚</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/7f9c38c3deb84f3cb919e8581d69770b.png" alt=""></p>
<p>è€Œå¯¹äºå†™è¯·æ±‚ï¼Œæ•°æ®æµåˆ™å°†è¯¥è¯·æ±‚è‡ªåŠ¨è½¬å‘ç»™æœ€æ–°çš„åå¤‡ç´¢å¼•ã€‚</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/6d00171f1af04002b72ef6f9d263f192.png" alt=""></p>
<h2 id="Data-stream-çš„ç‰¹æ€§"><a href="#Data-stream-çš„ç‰¹æ€§" class="headerlink" title="Data stream çš„ç‰¹æ€§"></a>Data stream çš„ç‰¹æ€§</h2><h3 id="ç”Ÿæˆ"><a href="#ç”Ÿæˆ" class="headerlink" title="ç”Ÿæˆ"></a>ç”Ÿæˆ</h3><p>æ¯ä¸ª Data stream çš„åå¤‡ç´¢å¼•éƒ½æœ‰ä¸€ä¸ª generation æ•°ï¼Œä¸€ä¸ªå…­ä½æ•°ï¼Œé›¶å¡«å……çš„æ•´æ•°ï¼Œä» 000001 å¼€å§‹ï¼Œç”¨ä½œè¯¥æµçš„ rollover çš„è®¡æ•°ã€‚</p>
<p>åå¤‡ç´¢å¼•åä¸»è¦ä¾ç…§ä»¥ä¸‹æ ¼å¼ï¼š</p>
<p>.dsâ€“</p>
<p>Generation è¶Šå¤§ï¼Œåå¤‡ç´¢å¼•åŒ…å«çš„æ•°æ®è¶Šæ–°ã€‚ ä¾‹å¦‚ï¼Œweb-server-logs æ•°æ®æµæœ€æ–°çš„ generation ä¸º 34ã€‚è¯¥æµçš„æœ€æ–°åå¤‡ç´¢å¼•åä¸º .ds-web-server-logs-000034ã€‚</p>
<p>æ³¨æ„ï¼šæŸäº›æ“ä½œï¼ˆä¾‹å¦‚ shrink æˆ– restore ï¼‰å¯ä»¥æ›´æ”¹åå¤‡ç´¢å¼•çš„åç§°ã€‚ è¿™äº›åç§°æ›´æ”¹ä¸ä¼šä»å…¶æ•°æ®æµä¸­åˆ é™¤åå¤‡ç´¢å¼•ã€‚</p>
<h3 id="Rollover"><a href="#Rollover" class="headerlink" title="Rollover"></a>Rollover</h3><p>åœ¨ Data stream çš„ä½¿ç”¨ä¸­ï¼Œrollover æ˜¯å¿…ä¸å¯å°‘çš„æ¡ä»¶ã€‚</p>
<p>åˆ›å»ºæ•°æ®æµæ—¶ï¼ŒElasticsearch ä¼šè‡ªåŠ¨ä¸ºè¯¥ Data stream æ ¹æ® template åˆ›å»ºä¸€ä¸ªåå¤‡ç´¢å¼•ã€‚ è¯¥ç´¢å¼•è¿˜å……å½“æµçš„ç¬¬ä¸€ä¸ªå†™å…¥ç´¢å¼•ã€‚å½“æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶ï¼Œ rollover ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„åå¤‡ç´¢å¼•ï¼Œè¯¥åå¤‡ç´¢å¼•å°†æˆä¸º Data stream çš„æ–°å†™å…¥ç´¢å¼•ã€‚</p>
<p>å½“ç„¶ rollover çš„æ¡ä»¶è®¾ç½®ä¸»è¦ä¾é  ILMã€‚ å¦‚æœéœ€è¦ï¼Œä½ è¿˜å¯ä»¥æ‰‹åŠ¨å°†æ•°æ® rollover ã€‚</p>
<h3 id="è¿½åŠ "><a href="#è¿½åŠ " class="headerlink" title="è¿½åŠ "></a>è¿½åŠ </h3><p>ç”±äºæ—¶åºæ€§æ•°æ®çš„ç‰¹å¾ï¼ŒData stream çš„è®¾è®¡åœºæ™¯ä¸­ï¼Œæ•°æ®æ˜¯åªè¿½åŠ çš„ï¼Œæå°‘éœ€è¦ä¿®æ”¹åˆ é™¤ã€‚å¦‚æœå®é™…éœ€è¦ä¿®æ”¹åˆ é™¤ï¼Œåˆ™å¯ä»¥è€ƒè™‘ä»¥ä¸‹æ“ä½œï¼š</p>
<ul>
<li>å¯¹äºæ•°æ®æµåªèƒ½é€šè¿‡ update by query æˆ–è€… delete by query æ“ä½œï¼Œä¸èƒ½è¿›è¡Œ update æˆ–è€… delete æ–‡æ¡£ã€‚</li>
<li>éœ€è¦ delete æˆ–è€… update æ–‡æ¡£ï¼Œåˆ™ç›´æ¥å¯¹åå¤‡ç´¢å¼•æ“ä½œã€‚</li>
<li>éœ€è¦ç»å¸¸åˆ é™¤æˆ–è€…ä¿®æ”¹æ–‡æ¡£çš„ï¼Œè¯·ä½¿ç”¨ç´¢å¼•åˆ«åæˆ–è€…ç´¢å¼•æ¨¡æ¿ï¼Œä¸è¦å¯¹ Data stream æ“ä½œã€‚</li>
</ul>
<h2 id="Data-stream-çš„ä½¿ç”¨"><a href="#Data-stream-çš„ä½¿ç”¨" class="headerlink" title="Data stream çš„ä½¿ç”¨"></a>Data stream çš„ä½¿ç”¨</h2><h3 id="åˆ›å»ºç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥-ILM"><a href="#åˆ›å»ºç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥-ILM" class="headerlink" title="åˆ›å»ºç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥ ILM"></a>åˆ›å»ºç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥ ILM</h3><p>ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥ ILM çš„ä¸»è¦é…ç½®ç»†èŠ‚è§ç´¢å¼•å‘¨æœŸç®¡ç†ä¸€ç« ï¼Œæ­¤å¤„ä¸»è¦åš hot å’Œ delete é˜¶æ®µçš„è®¾ç½®ï¼Œç”¨äº rollover çš„å¼•ç”¨ã€‚</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">PUT /_ilm/policy/my-data-stream-policy</div><div class="line">&#123;</div><div class="line">  <span class="string">"policy"</span>: &#123;</div><div class="line">    <span class="string">"phases"</span>: &#123;</div><div class="line">      <span class="string">"hot"</span>: &#123;</div><div class="line">        <span class="string">"actions"</span>: &#123;</div><div class="line">          <span class="string">"rollover"</span>: &#123;</div><div class="line">            <span class="string">"max_size"</span>: <span class="string">"10mb"</span></div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="åˆ›å»ºç´¢å¼•æ¨¡æ¿"><a href="#åˆ›å»ºç´¢å¼•æ¨¡æ¿" class="headerlink" title="åˆ›å»ºç´¢å¼•æ¨¡æ¿"></a>åˆ›å»ºç´¢å¼•æ¨¡æ¿</h3><p>ç´¢å¼•æ¨¡æ¿æ˜¯åå¤‡ç´¢å¼•è®¾ç½®ï¼Œä»¥åŠ mapping çš„ä¸»è¦é…ç½®æ¥æºï¼Œæ­¤å¤„ä¸å±•å¼€å»¶ä¼¸ã€‚ä¸»è¦è®¾ç½® Data stream ç›¸å…³çš„éƒ¨åˆ†ã€‚</p>
<p>ç›¸å…³å‘½ä»¤ï¼š</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">PUT /_index_template/my-data-stream-template</div><div class="line">&#123;</div><div class="line">  <span class="string">"index_patterns"</span>: [ <span class="string">"my-data-stream*"</span> ],</div><div class="line">  <span class="string">"data_stream"</span>: &#123; &#125;,</div><div class="line">  <span class="string">"priority"</span>: <span class="number">200</span>,</div><div class="line">  <span class="string">"template"</span>: &#123;</div><div class="line">    <span class="string">"settings"</span>: &#123;</div><div class="line">      <span class="string">"index.lifecycle.name"</span>: <span class="string">"my-data-stream-policy"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼š</p>
<ol>
<li>å®šä¹‰ data_stream ä¸ºä¸€ä¸ªç©ºçš„ object ï¼Œè¿™æ˜¯å¿…è¦çš„ã€‚</li>
<li>Template ä¸­ä½¿ç”¨äº†ä¸Šä¸€æ­¥åˆ›å»ºçš„ ILM ç­–ç•¥ my-data-stream-policyã€‚</li>
</ol>
<p>æ­¤å¤–ï¼Œè¿˜éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š</p>
<ol>
<li>Elasticsearch æœ‰ä¸€äº›å†…ç½®ç´¢å¼•æ¨¡æ¿å¦‚ metric-<strong>-</strong> å’Œ logs-<strong>-</strong> ï¼Œé»˜è®¤ä¼˜å…ˆçº§ priority æ˜¯ 100ã€‚å¦‚æœæœ‰é‡åä½¿ç”¨ï¼Œåˆ™å¯ä»¥è°ƒé«˜ä¼˜å…ˆçº§ï¼Œé˜²æ­¢è¢«é»˜è®¤çš„è¦†ç›–ã€‚</li>
<li>ç´¢å¼•æ¨¡æ¿é»˜è®¤å°† @timestamp å­—æ®µè®¾ç½®ä¸º date å±æ€§</li>
</ol>
<h3 id="åˆ›å»º-Data-stream"><a href="#åˆ›å»º-Data-stream" class="headerlink" title="åˆ›å»º Data stream"></a>åˆ›å»º Data stream</h3><p>å¯ä»¥è‡ªåŠ¨åˆ©ç”¨ template çš„åŒ¹é…æ¨¡å¼æ–°å¢æ–‡æ¡£åˆ›å»º</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">PUT</span> /_data_stream/my-<span class="class"><span class="keyword">data</span>-stream</span></div></pre></td></tr></table></figure>
<h3 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h3><p>åˆ é™¤å‘½ä»¤ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">DELETE</span> <span class="regexp">/_data_stream/my</span>-data-stream</div></pre></td></tr></table></figure>
<p>åˆ é™¤æ•°æ®æµä¼šå°†æ•°æ®æµçš„åå¤‡ç´¢å¼•ä¸€èµ·åˆ é™¤ã€‚</p>
<h2 id="ä½¿ç”¨-Data-stream"><a href="#ä½¿ç”¨-Data-stream" class="headerlink" title="ä½¿ç”¨ Data stream"></a>ä½¿ç”¨ Data stream</h2><p>æ­¤å¤„å¯¹æ•°æ®æµçš„æ“ä½œä¸»è¦ä»¥å‘½ä»¤ä¸ºä¸»</p>
<h3 id="æ–°å¢æ•°æ®"><a href="#æ–°å¢æ•°æ®" class="headerlink" title="æ–°å¢æ•°æ®"></a>æ–°å¢æ•°æ®</h3><p>Data stream åœ¨æ–°å¢æ•°æ®æ—¶æ˜¯åªè¿½åŠ çš„æ¨¡å¼ï¼Œå› æ­¤åœ¨å›ºå®š id å’Œ bulk çš„æ¨¡å¼ä¸‹ï¼Œop_type æ˜¯æŒ‡å®š create çš„ã€‚</p>
<p>å¦‚ä¸‹é¢å‘½ä»¤ï¼š</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">POST</span> my-<span class="meta">data</span>-<span class="keyword">stream/_create/1</span></div><div class="line">&#123;<span class="string">"@timestamp"</span>:<span class="string">"2020-12-07T11:06:07.000Z"</span>,<span class="string">"test"</span>:<span class="number">1</span>&#125;</div></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">PUT /my-data-stream/_bulk?refresh</div><div class="line">&#123;<span class="string">"create"</span>:&#123; &#125;&#125;</div><div class="line">&#123; <span class="string">"@timestamp"</span>: <span class="string">"2020-12-08T11:04:05.000Z"</span>, <span class="string">"user"</span>: &#123; <span class="string">"id"</span>: <span class="string">"vlb44hny"</span> &#125;, <span class="string">"message"</span>: <span class="string">"Login attempt failed"</span> &#125;</div><div class="line">&#123;<span class="string">"create"</span>:&#123; &#125;&#125;</div><div class="line">&#123; <span class="string">"@timestamp"</span>: <span class="string">"2020-12-08T11:06:07.000Z"</span>, <span class="string">"user"</span>: &#123; <span class="string">"id"</span>: <span class="string">"8a4f500d"</span> &#125;, <span class="string">"message"</span>: <span class="string">"Login successful"</span> &#125;</div><div class="line">&#123;<span class="string">"create"</span>:&#123; &#125;&#125;</div><div class="line">&#123; <span class="string">"@timestamp"</span>: <span class="string">"2020-12-09T11:07:08.000Z"</span>, <span class="string">"user"</span>: &#123; <span class="string">"id"</span>: <span class="string">"l7gk7f82"</span> &#125;, <span class="string">"message"</span>: <span class="string">"Logout successful"</span> &#125;</div></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST /_reindex</div><div class="line">&#123;</div><div class="line">  <span class="string">"source"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"kibana_sample_data_logs_new"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"dest"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"my-data-stream"</span>,</div><div class="line">    <span class="string">"op_type"</span>: <span class="string">"create"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å› å­—æ®µä¸­<code>@timestamp</code>æ˜¯å¿…å¡«ï¼Œå®éªŒæ•°æ®å¦‚ä¸‹æ”¹åŠ¨ï¼š</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  <span class="string">"source"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"kibana_sample_data_logs"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"dest"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"kibana_sample_data_logs_new"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"script"</span>: &#123;</div><div class="line">    <span class="string">"source"</span>: <span class="string">"ctx._source['@timestamp'] = ctx._source.remove(\"</span>timestamp\<span class="string">")"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="è·å–-Data-stream-çŠ¶æ€"><a href="#è·å–-Data-stream-çŠ¶æ€" class="headerlink" title="è·å– Data stream çŠ¶æ€"></a>è·å– Data stream çŠ¶æ€</h3><p>ä½¿ç”¨ Data stream stats API æŸ¥çœ‹ Data stream çš„çŠ¶æ€ã€‚</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /<span class="variable">_data_stream</span>/my-data-stream/<span class="variable">_stats</span>?human=<span class="literal">true</span></div></pre></td></tr></table></figure>
<p>åŒæ—¶éœ€è¦ç”¨ _ilm/explain è·å– Data stream åå¤‡ç´¢å¼•æ‰€åœ¨çš„ ILM ç­–ç•¥çŠ¶æ€ã€‚</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">GET</span> my-<span class="class"><span class="keyword">data</span>-stream/_ilm/explain</span></div></pre></td></tr></table></figure>
<h3 id="æ‰‹åŠ¨-rollover-Data-stream"><a href="#æ‰‹åŠ¨-rollover-Data-stream" class="headerlink" title="æ‰‹åŠ¨ rollover Data stream"></a>æ‰‹åŠ¨ rollover Data stream</h3><p>ä½¿ç”¨ rollover APIï¼Œæ‰‹åŠ¨ rollover Data streamã€‚</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">POST</span> my-<span class="class"><span class="keyword">data</span>-stream/_rollover</span></div></pre></td></tr></table></figure>
<p>Response:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"acknowledged"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="attr">"shards_acknowledged"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="attr">"old_index"</span> : <span class="string">".ds-my-data-stream-000001"</span>,</div><div class="line">  <span class="attr">"new_index"</span> : <span class="string">".ds-my-data-stream-000002"</span>,</div><div class="line">  <span class="attr">"rolled_over"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="attr">"dry_run"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="attr">"conditions"</span> : &#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å† GET ç›¸å…³ Data stream çŠ¶æ€ï¼Œåå¤‡ç´¢å¼•å¢åŠ ã€‚</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">GET</span> /_data_stream/my-<span class="class"><span class="keyword">data</span>-stream/</span></div></pre></td></tr></table></figure>
<p>Response:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"data_streams"</span> : [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span> : <span class="string">"my-data-stream"</span>,</div><div class="line">      <span class="attr">"timestamp_field"</span> : &#123;</div><div class="line">        <span class="attr">"name"</span> : <span class="string">"@timestamp"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"indices"</span> : [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"index_name"</span> : <span class="string">".ds-my-data-stream-000001"</span>,</div><div class="line">          <span class="attr">"index_uuid"</span> : <span class="string">"AJBi0g3fRyG8-1tiH2UD2Q"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"index_name"</span> : <span class="string">".ds-my-data-stream-000002"</span>,</div><div class="line">          <span class="attr">"index_uuid"</span> : <span class="string">"AgOLGMSBSYWb4X-ID8uwtg"</span></div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="attr">"generation"</span> : <span class="number">2</span>,</div><div class="line">      <span class="attr">"status"</span> : <span class="string">"GREEN"</span>,</div><div class="line">      <span class="attr">"template"</span> : <span class="string">"my-data-stream-template"</span>,</div><div class="line">      <span class="attr">"ilm_policy"</span> : <span class="string">"my-data-stream-policy"</span>,</div><div class="line">      <span class="attr">"hidden"</span> : <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Reindex-Data-stream"><a href="#Reindex-Data-stream" class="headerlink" title="Reindex Data stream"></a>Reindex Data stream</h3><p>ä½¿ç”¨ reindex API å»å¤åˆ¶æ•°æ®åˆ°ä¸€ä¸ª Data streamã€‚ç”±äº Data stream çš„åªè¿½åŠ ç‰¹æ€§ï¼Œåœ¨ op_type ä¸­è¦é€‰æ‹©ä¸º create ã€‚</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST /_reindex</div><div class="line">&#123;</div><div class="line">  <span class="string">"source"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"test"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"dest"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"my-data-stream"</span>,</div><div class="line">    <span class="string">"op_type"</span>: <span class="string">"create"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Response:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"took"</span> : <span class="number">80</span>,</div><div class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="attr">"total"</span> : <span class="number">1</span>,</div><div class="line">  <span class="attr">"updated"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"created"</span> : <span class="number">1</span>,</div><div class="line">  <span class="attr">"deleted"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"batches"</span> : <span class="number">1</span>,</div><div class="line">  <span class="attr">"version_conflicts"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"noops"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"retries"</span> : &#123;</div><div class="line">    <span class="attr">"bulk"</span> : <span class="number">0</span>,</div><div class="line">    <span class="attr">"search"</span> : <span class="number">0</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"throttled_millis"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"requests_per_second"</span> : <span class="number">-1.0</span>,</div><div class="line">  <span class="attr">"throttled_until_millis"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"failures"</span> : [ ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Delete-Update-by-query"><a href="#Delete-Update-by-query" class="headerlink" title="Delete/Update by query"></a>Delete/Update by query</h3><p>é’ˆå¯¹ Data stream åªèƒ½ delete/update by query ã€‚</p>
<p>ç›¸å…³å‘½ä»¤ï¼š</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">POST /my-data-stream/_update_by_query</div><div class="line">&#123;</div><div class="line">  <span class="string">"query"</span>: &#123;</div><div class="line">    <span class="string">"match"</span>: &#123;</div><div class="line">      <span class="string">"user.id"</span>: <span class="string">"l7gk7f82"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"script"</span>: &#123;</div><div class="line">    <span class="string">"source"</span>: <span class="string">"ctx._source.user.id = params.new_id"</span>,</div><div class="line">    <span class="string">"params"</span>: &#123;</div><div class="line">      <span class="string">"new_id"</span>: <span class="string">"XgdX0NoX"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">POST /my-data-stream/_delete_by_query</div><div class="line">&#123;</div><div class="line">  <span class="string">"query"</span>: &#123;</div><div class="line">    <span class="string">"match"</span>: &#123;</div><div class="line">      <span class="string">"user.id"</span>: <span class="string">"vlb44hny"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/08/26/ES-ReIndexè¿ç§»æ•°æ®/" itemprop="url">
                  ES ReIndexè¿ç§»æ•°æ®
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2022-08-26T10:56:55+08:00" content="2022-08-26">
              2022-08-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2022/08/26/ES-ReIndexè¿ç§»æ•°æ®/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2022/08/26/ES-ReIndexè¿ç§»æ•°æ®/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ä¸€ã€ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•"><a href="#ä¸€ã€ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•" class="headerlink" title="ä¸€ã€ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•"></a><strong>ä¸€ã€</strong>ç»™ç›®æ ‡é›†ç¾¤æ–°å¢ç™½åå•</h1><h4 id="1ã€elasticsearch-ymlä¸­æ·»åŠ reindex-remote-whitelist-â€œxx-xx-xx-xx-9200â€-ï¼Œä¸åŠ httpï¼Œé‡å¯ESæœåŠ¡ï¼›"><a href="#1ã€elasticsearch-ymlä¸­æ·»åŠ reindex-remote-whitelist-â€œxx-xx-xx-xx-9200â€-ï¼Œä¸åŠ httpï¼Œé‡å¯ESæœåŠ¡ï¼›" class="headerlink" title="1ã€elasticsearch.ymlä¸­æ·»åŠ reindex.remote.whitelist: [â€œxx.xx.xx.xx:9200â€]ï¼Œä¸åŠ httpï¼Œé‡å¯ESæœåŠ¡ï¼›"></a>1ã€<a href="https://so.csdn.net/so/search?q=elasticsearch&amp;spm=1001.2101.3001.7020" target="_blank" rel="external">elasticsearch</a>.ymlä¸­æ·»åŠ reindex.remote.whitelist: [â€œxx.xx.xx.xx:9200â€]ï¼Œä¸åŠ httpï¼Œé‡å¯ESæœåŠ¡ï¼›</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">http.host: 0.0.0.0</div><div class="line">http.cors.enabled: true</div><div class="line">http.cors.allow-origin: &quot;*&quot;</div><div class="line">http.cors.allow-headers: Authorization</div><div class="line">xpack.security.enabled: true</div><div class="line">xpack.security.transport.ssl.enabled: true</div><div class="line">reindex.remote.whitelist: [&quot;124.70.107.101:30997&quot;,&quot;47.94.255.84:30997&quot;]</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker ps|grep elasticsearch</div><div class="line"></div><div class="line">docker exec -it elasticsearch /bin/bash</div><div class="line"></div><div class="line">vi config/elasticsearch.yml</div><div class="line"></div><div class="line">docker restart elasticsearch</div></pre></td></tr></table></figure>
<h1 id="äºŒã€ä½¿ç”¨PostManä¿®æ”¹ç›®æ ‡ä¸»æœºESå‚æ•°"><a href="#äºŒã€ä½¿ç”¨PostManä¿®æ”¹ç›®æ ‡ä¸»æœºESå‚æ•°" class="headerlink" title="äºŒã€ä½¿ç”¨PostManä¿®æ”¹ç›®æ ‡ä¸»æœºESå‚æ•°"></a><strong>äºŒã€ä½¿ç”¨PostManä¿®æ”¹ç›®æ ‡ä¸»æœºESå‚æ•°</strong></h1><h4 id="1ã€PUT-settings-pretty"><a href="#1ã€PUT-settings-pretty" class="headerlink" title="1ã€PUT _settings?pretty"></a>1ã€PUT _settings?pretty</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;index.refresh_interval&quot;: -1,</div><div class="line">  &quot;index.number_of_replicas&quot;: 0</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="ä¸‰ã€ä½¿ç”¨reindexåŒæ­¥æ•°æ®"><a href="#ä¸‰ã€ä½¿ç”¨reindexåŒæ­¥æ•°æ®" class="headerlink" title="ä¸‰ã€ä½¿ç”¨reindexåŒæ­¥æ•°æ®"></a><strong>ä¸‰ã€ä½¿ç”¨reindexåŒæ­¥æ•°æ®</strong></h1><h4 id="1ã€åŒæ­¥æ•°æ®ï¼ŒPOST-reindex-wait-for-completion-false"><a href="#1ã€åŒæ­¥æ•°æ®ï¼ŒPOST-reindex-wait-for-completion-false" class="headerlink" title="1ã€åŒæ­¥æ•°æ®ï¼ŒPOST _reindex?wait_for_completion=false"></a>1ã€åŒæ­¥æ•°æ®ï¼ŒPOST _reindex?wait_for_completion=false</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"># 1ã€è¿‡æ»¤æ•°æ®</div><div class="line">&#123;</div><div class="line">    &quot;source&quot;: &#123;</div><div class="line">        &quot;remote&quot;: &#123;</div><div class="line">            &quot;host&quot;: &quot;http://47.94.255.84:30997&quot;,</div><div class="line">            &quot;username&quot;: &quot;elastic&quot;,</div><div class="line">            &quot;password&quot;: &quot;IQsMLRniP5BcYfoNzTBT&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;size&quot;: 10000,</div><div class="line">        &quot;index&quot;: &quot;aiot_towercrane_realtime_master&quot;,</div><div class="line">        &quot;query&quot;: &#123;</div><div class="line">            &quot;bool&quot;: &#123;</div><div class="line">                &quot;filter&quot;: [</div><div class="line">                    &#123;</div><div class="line">                        &quot;range&quot;: &#123;</div><div class="line">                            &quot;createTime&quot;: &#123;</div><div class="line">                                &quot;gte&quot;: 1652262590167,</div><div class="line">                                &quot;lte&quot;: 1652262590346</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        &quot;term&quot;: &#123;</div><div class="line">                            &quot;tenantId&quot;: &quot;1441953685304872961&quot;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;dest&quot;: &#123;</div><div class="line">        &quot;index&quot;: &quot;aiot_towercrane_realtime_master&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"># 2 æŸ¥è¯¢æ•°æ®</div><div class="line">&#123;</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;remote&quot;: &#123;</div><div class="line">      &quot;host&quot;: &quot;http://47.94.255.84:30997&quot;,</div><div class="line">      &quot;username&quot;: &quot;elastic&quot;,</div><div class="line">      &quot;password&quot;: &quot;IQsMLRniP5BcYfoNzTBT&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;index&quot;: &quot;aiot_deeppit_mesure_day_record_master&quot;,</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">      &quot;match&quot;: &#123;</div><div class="line">        &quot;projectId&quot;: &quot;1447476989099610114&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;aiot_deeppit_mesure_day_record_xiongan&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p> <strong>æ³¨ï¼š</strong></p>
<ul>
<li><strong>åŒæ­¥ä¹‹å‰ï¼Œéœ€è¦åˆ é™¤ç›®æ ‡ä¸»æœºä¸­å·²å­˜åœ¨ç´¢å¼•ï¼Œå¦åˆ™åŒæ­¥ä¸æˆåŠŸã€‚</strong></li>
<li><strong>åŒæ­¥ESæ•°æ®æ—¶ï¼Œå¦‚æœéœ€è¦è®¤è¯ï¼Œç›®æ ‡ä¸»æœºæ·»åŠ Basic authè®¤è¯ï¼Œæºä¸»æœºæ·»åŠ usernameå’Œpassword;</strong></li>
</ul>
</blockquote>
<h4 id="2ã€æ‰¹é‡ä¿®æ”¹æ•°æ®-POST-aiot-towercrane-param-xiongan-update-by-query"><a href="#2ã€æ‰¹é‡ä¿®æ”¹æ•°æ®-POST-aiot-towercrane-param-xiongan-update-by-query" class="headerlink" title="2ã€æ‰¹é‡ä¿®æ”¹æ•°æ® POST aiot_towercrane_param_xiongan/_update_by_query"></a>2ã€æ‰¹é‡ä¿®æ”¹æ•°æ® POST aiot_towercrane_param_xiongan/_update_by_query</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">http://144.7.110.56:9200/aiot_towercrane_param_xiongan/_update_by_query</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123; </div><div class="line">    &quot;match_all&quot;: &#123;</div><div class="line">      </div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;script&quot;: &#123;</div><div class="line">    &quot;source&quot;: &quot;ctx._source.tenantId = 1504718344228839425L &quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>æ³¨æ„ï¼šLongç±»å‹æ›´æ–°éœ€è¦æ·»åŠ L</li>
</ul>
</blockquote>
<h1 id="å››ã€æŸ¥çœ‹è¿ç§»çŠ¶å†µ"><a href="#å››ã€æŸ¥çœ‹è¿ç§»çŠ¶å†µ" class="headerlink" title="å››ã€æŸ¥çœ‹è¿ç§»çŠ¶å†µ"></a>å››ã€æŸ¥çœ‹è¿ç§»çŠ¶å†µ</h1><h4 id="1ã€æŸ¥çœ‹æ‰€æœ‰task"><a href="#1ã€æŸ¥çœ‹æ‰€æœ‰task" class="headerlink" title="1ã€æŸ¥çœ‹æ‰€æœ‰task"></a>1ã€æŸ¥çœ‹æ‰€æœ‰task</h4><p>GET _tasks?detailed=true&amp;actions=*reindex<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://144.7.110.56:9200/_tasks?detailed=true&amp;actions=*reindex</div></pre></td></tr></table></figure></p>
<p>GET _tasks/xxx?pretty<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://144.7.110.56:9200/_tasks/6kPnJej0SZKt4Y5THf6TuQ:697134?pretty</div></pre></td></tr></table></figure></p>
<h1 id="äº”ã€æ¢å¤æ–°esè®¾ç½®"><a href="#äº”ã€æ¢å¤æ–°esè®¾ç½®" class="headerlink" title="äº”ã€æ¢å¤æ–°esè®¾ç½®"></a>äº”ã€æ¢å¤æ–°esè®¾ç½®</h1><h4 id="1ã€PUT-settings-pretty-1"><a href="#1ã€PUT-settings-pretty-1" class="headerlink" title="1ã€PUT _settings?pretty"></a>1ã€PUT _settings?pretty</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;index.refresh_interval&quot;: &quot;10m&quot;,</div><div class="line">  &quot;index.number_of_replicas&quot;: 1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">boolæŸ¥è¯¢æ€»ç»“</div><div class="line"></div><div class="line">mustï¼šä¸å…³ç³»ï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ andã€‚</div><div class="line"></div><div class="line">shouldï¼šæˆ–å…³ç³»ï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ orã€‚</div><div class="line"></div><div class="line">must_notï¼šéå…³ç³»ï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ notã€‚</div><div class="line"></div><div class="line">filterï¼šè¿‡æ»¤æ¡ä»¶ã€‚</div><div class="line"></div><div class="line">rangeï¼šæ¡ä»¶ç­›é€‰èŒƒå›´ã€‚</div><div class="line"></div><div class="line">gtï¼šå¤§äºï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ &gt;ã€‚</div><div class="line"></div><div class="line">gteï¼šå¤§äºç­‰äºï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ &gt;=ã€‚</div><div class="line"></div><div class="line">ltï¼šå°äºï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ &lt;ã€‚</div><div class="line"></div><div class="line">lteï¼šå°äºç­‰äºï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ &lt;=ã€‚</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/04/30/kubectl-å¤‡å¿˜å•/" itemprop="url">
                  kubectl å¤‡å¿˜å•
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2021-04-30T11:43:50+08:00" content="2021-04-30">
              2021-04-30
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2021/04/30/kubectl-å¤‡å¿˜å•/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/04/30/kubectl-å¤‡å¿˜å•/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Kubectl-ä¸Šä¸‹æ–‡å’Œé…ç½®"><a href="#Kubectl-ä¸Šä¸‹æ–‡å’Œé…ç½®" class="headerlink" title="Kubectl ä¸Šä¸‹æ–‡å’Œé…ç½®"></a>Kubectl ä¸Šä¸‹æ–‡å’Œé…ç½®</h2><p>è®¾ç½® <code>kubectl</code> ä¸å“ªä¸ª Kubernetes é›†ç¾¤è¿›è¡Œé€šä¿¡å¹¶ä¿®æ”¹é…ç½®ä¿¡æ¯ã€‚</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">view </span><span class="comment"># æ˜¾ç¤ºåˆå¹¶çš„ kubeconfig é…ç½®ã€‚</span></div><div class="line"></div><div class="line"><span class="comment"># åŒæ—¶ä½¿ç”¨å¤šä¸ª kubeconfig æ–‡ä»¶å¹¶æŸ¥çœ‹åˆå¹¶çš„é…ç½®</span></div><div class="line"><span class="string">KUBECONFIG=</span>~/.<span class="string">kube/</span><span class="string">config:</span>~/.<span class="string">kube/</span><span class="string">kubconfig2 </span><span class="string">kubectl </span><span class="string">config </span><span class="string">view</span></div><div class="line"></div><div class="line"><span class="comment"># è·å– e2e ç”¨æˆ·çš„å¯†ç </span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">view </span>-o <span class="string">jsonpath=</span><span class="string">'&#123;.users[?(@.name == "e2e")].user.password&#125;'</span></div><div class="line"></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">view </span>-o <span class="string">jsonpath=</span><span class="string">'&#123;.users[].name&#125;'</span>    <span class="comment"># æ˜¾ç¤ºç¬¬ä¸€ä¸ªç”¨æˆ·</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">view </span>-o <span class="string">jsonpath=</span><span class="string">'&#123;.users[*].name&#125;'</span>   <span class="comment"># è·å–ç”¨æˆ·åˆ—è¡¨</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="built_in">get-contexts</span>                          <span class="comment"># æ˜¾ç¤ºä¸Šä¸‹æ–‡åˆ—è¡¨</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">current-context </span>                      <span class="comment"># å±•ç¤ºå½“å‰æ‰€å¤„çš„ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">use-context </span><span class="string">my-cluster-</span><span class="string">name </span>          <span class="comment"># è®¾ç½®é»˜è®¤çš„ä¸Šä¸‹æ–‡ä¸º my-cluster-name</span></div><div class="line"></div><div class="line"><span class="comment"># æ·»åŠ æ–°çš„ç”¨æˆ·é…ç½®åˆ° kubeconf ä¸­ï¼Œä½¿ç”¨ basic auth è¿›è¡Œèº«ä»½è®¤è¯</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="built_in">set-credentials</span> <span class="string">kubeuser/</span><span class="string">foo.</span><span class="string">kubernetes.</span><span class="string">com </span><span class="built_in">--username=kubeuser</span> <span class="built_in">--password=kubepassword</span></div><div class="line"></div><div class="line"><span class="comment"># åœ¨æŒ‡å®šä¸Šä¸‹æ–‡ä¸­æŒä¹…æ€§åœ°ä¿å­˜åå­—ç©ºé—´ï¼Œä¾›æ‰€æœ‰åç»­ kubectl å‘½ä»¤ä½¿ç”¨</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="built_in">set-context</span> <span class="built_in">--current</span> <span class="built_in">--namespace=ggckad-s2</span></div><div class="line"></div><div class="line"><span class="comment"># ä½¿ç”¨ç‰¹å®šçš„ç”¨æˆ·åå’Œåå­—ç©ºé—´è®¾ç½®ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="built_in">set-context</span> <span class="string">gce </span><span class="built_in">--user=cluster-admin</span> <span class="built_in">--namespace=foo</span> \</div><div class="line">  &amp;&amp; <span class="string">kubectl </span><span class="string">config </span><span class="string">use-context </span><span class="string">gce</span></div><div class="line"></div><div class="line"><span class="string">kubectl </span><span class="string">config </span><span class="string">unset </span><span class="string">users.</span><span class="string">foo </span>                      <span class="comment"># åˆ é™¤ç”¨æˆ· foo</span></div></pre></td></tr></table></figure>
<h2 id="Kubectl-apply"><a href="#Kubectl-apply" class="headerlink" title="Kubectl apply"></a>Kubectl apply</h2><p><code>apply</code> é€šè¿‡å®šä¹‰ Kubernetes èµ„æºçš„æ–‡ä»¶æ¥ç®¡ç†åº”ç”¨ã€‚ å®ƒé€šè¿‡è¿è¡Œ <code>kubectl apply</code> åœ¨é›†ç¾¤ä¸­åˆ›å»ºå’Œæ›´æ–°èµ„æºã€‚ è¿™æ˜¯åœ¨ç”Ÿäº§ä¸­ç®¡ç† Kubernetes åº”ç”¨çš„æ¨èæ–¹æ³•</p>
<h2 id="åˆ›å»ºå¯¹è±¡"><a href="#åˆ›å»ºå¯¹è±¡" class="headerlink" title="åˆ›å»ºå¯¹è±¡ "></a>åˆ›å»ºå¯¹è±¡<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#creating-objects" target="_blank" rel="external"> </a></h2><p>Kubernetes é…ç½®å¯ä»¥ç”¨ YAML æˆ– JSON å®šä¹‰ã€‚å¯ä»¥ä½¿ç”¨çš„æ–‡ä»¶æ‰©å±•åæœ‰ <code>.yaml</code>ã€<code>.yml</code> å’Œ <code>.json</code>ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">kubectl apply -f ./my-manifest.yaml           <span class="comment"># åˆ›å»ºèµ„æº</span></div><div class="line">kubectl apply -f ./my1.yaml -f ./my2.yaml     <span class="comment"># ä½¿ç”¨å¤šä¸ªæ–‡ä»¶åˆ›å»º</span></div><div class="line">kubectl apply -f ./dir                        <span class="comment"># åŸºäºç›®å½•ä¸‹çš„æ‰€æœ‰æ¸…å•æ–‡ä»¶åˆ›å»ºèµ„æº</span></div><div class="line">kubectl apply -f https://git.io/vPieo         <span class="comment"># ä» URL ä¸­åˆ›å»ºèµ„æº</span></div><div class="line">kubectl create deployment nginx --image=nginx <span class="comment"># å¯åŠ¨å•å®ä¾‹ nginx</span></div><div class="line"></div><div class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ‰“å° â€œHello Worldâ€ çš„ Job</span></div><div class="line">kubectl create job hello --image=busybox -- echo <span class="string">"Hello World"</span> </div><div class="line"></div><div class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ‰“å° â€œHello Worldâ€ é—´éš”1åˆ†é’Ÿçš„ CronJob</span></div><div class="line">kubectl create cronjob hello --image=busybox   --schedule=<span class="string">"*/1 * * * *"</span> -- echo <span class="string">"Hello World"</span>    </div><div class="line"></div><div class="line">kubectl explain pods                          <span class="comment"># è·å– pod æ¸…å•çš„æ–‡æ¡£è¯´æ˜</span></div><div class="line"></div><div class="line"><span class="comment"># ä»æ ‡å‡†è¾“å…¥åˆ›å»ºå¤šä¸ª YAML å¯¹è±¡</span></div><div class="line">cat &lt;&lt;EOF | kubectl apply -f -</div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> Pod</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> busybox-sleep</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> busybox</div><div class="line"><span class="attr">    image:</span> busybox</div><div class="line"><span class="attr">    args:</span></div><div class="line"><span class="bullet">    -</span> sleep</div><div class="line"><span class="bullet">    -</span> <span class="string">"1000000"</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> Pod</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> busybox-sleep-less</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> busybox</div><div class="line"><span class="attr">    image:</span> busybox</div><div class="line"><span class="attr">    args:</span></div><div class="line"><span class="bullet">    -</span> sleep</div><div class="line"><span class="bullet">    -</span> <span class="string">"1000"</span></div><div class="line">EOF</div><div class="line"></div><div class="line"><span class="comment"># åˆ›å»ºæœ‰å¤šä¸ª key çš„ Secret</span></div><div class="line">cat &lt;&lt;EOF | kubectl apply -f -</div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> Secret</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> mysecret</div><div class="line"><span class="attr">type:</span> Opaque</div><div class="line"><span class="attr">data:</span></div><div class="line"><span class="attr">  password:</span> $(echo -n <span class="string">"s33msi4"</span> | base64 -w0)</div><div class="line"><span class="attr">  username:</span> $(echo -n <span class="string">"jane"</span> | base64 -w0)</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h2 id="æŸ¥çœ‹å’ŒæŸ¥æ‰¾èµ„æº"><a href="#æŸ¥çœ‹å’ŒæŸ¥æ‰¾èµ„æº" class="headerlink" title="æŸ¥çœ‹å’ŒæŸ¥æ‰¾èµ„æº"></a>æŸ¥çœ‹å’ŒæŸ¥æ‰¾èµ„æº</h2><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># get å‘½ä»¤çš„åŸºæœ¬è¾“å‡º</span></div><div class="line">kubectl <span class="keyword">get</span> services                          # åˆ—å‡ºå½“å‰å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ services</div><div class="line">kubectl <span class="keyword">get</span> pods --all-namespaces             # åˆ—å‡ºæ‰€æœ‰å‘½åç©ºé—´ä¸‹çš„å…¨éƒ¨çš„ Pods</div><div class="line">kubectl <span class="keyword">get</span> pods -o wide                      # åˆ—å‡ºå½“å‰å‘½åç©ºé—´ä¸‹çš„å…¨éƒ¨ Podsï¼Œå¹¶æ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯</div><div class="line">kubectl <span class="keyword">get</span> deployment my-dep                 # åˆ—å‡ºæŸä¸ªç‰¹å®šçš„ Deployment</div><div class="line">kubectl <span class="keyword">get</span> pods                              # åˆ—å‡ºå½“å‰å‘½åç©ºé—´ä¸‹çš„å…¨éƒ¨ Pods</div><div class="line">kubectl <span class="keyword">get</span> pod my-pod -o yaml                # è·å–ä¸€ä¸ª pod çš„ YAML</div><div class="line"></div><div class="line"><span class="meta"># describe å‘½ä»¤çš„è¯¦ç»†è¾“å‡º</span></div><div class="line">kubectl describe nodes my-node</div><div class="line">kubectl describe pods my-pod</div><div class="line"></div><div class="line"><span class="meta"># åˆ—å‡ºå½“å‰åå­—ç©ºé—´ä¸‹æ‰€æœ‰ Servicesï¼ŒæŒ‰åç§°æ’åº</span></div><div class="line">kubectl <span class="keyword">get</span> services --sort-by=.metadata.name</div><div class="line"></div><div class="line"><span class="meta"># åˆ—å‡º Podsï¼ŒæŒ‰é‡å¯æ¬¡æ•°æ’åº</span></div><div class="line">kubectl <span class="keyword">get</span> pods --sort-by=<span class="string">'.status.containerStatuses[0].restartCount'</span></div><div class="line"></div><div class="line"><span class="meta"># åˆ—ä¸¾æ‰€æœ‰ PV æŒä¹…å·ï¼ŒæŒ‰å®¹é‡æ’åº</span></div><div class="line">kubectl <span class="keyword">get</span> pv --sort-by=.spec.capacity.storage</div><div class="line"></div><div class="line"><span class="meta"># è·å–åŒ…å« app=cassandra æ ‡ç­¾çš„æ‰€æœ‰ Pods çš„ version æ ‡ç­¾</span></div><div class="line">kubectl <span class="keyword">get</span> pods --selector=app=cassandra -o \</div><div class="line">  jsonpath=<span class="string">'&#123;.items[*].metadata.labels.version&#125;'</span></div><div class="line"></div><div class="line"><span class="meta"># æ£€ç´¢å¸¦æœ‰ â€œ.â€ é”®å€¼ï¼Œä¾‹ï¼š 'ca.crt'</span></div><div class="line">kubectl <span class="keyword">get</span> configmap myconfig \</div><div class="line">  -o jsonpath=<span class="string">'&#123;.data.ca\.crt&#125;'</span></div><div class="line"></div><div class="line"><span class="meta"># è·å–æ‰€æœ‰å·¥ä½œèŠ‚ç‚¹ï¼ˆä½¿ç”¨é€‰æ‹©å™¨ä»¥æ’é™¤æ ‡ç­¾åç§°ä¸º 'node-role.kubernetes.io/master' çš„ç»“æœï¼‰</span></div><div class="line">kubectl <span class="keyword">get</span> node --selector=<span class="string">'!node-role.kubernetes.io/master'</span></div><div class="line"></div><div class="line"><span class="meta"># è·å–å½“å‰å‘½åç©ºé—´ä¸­æ­£åœ¨è¿è¡Œçš„ Pods</span></div><div class="line">kubectl <span class="keyword">get</span> pods --field-selector=status.phase=Running</div><div class="line"></div><div class="line"><span class="meta"># è·å–å…¨éƒ¨èŠ‚ç‚¹çš„ ExternalIP åœ°å€</span></div><div class="line">kubectl <span class="keyword">get</span> nodes -o jsonpath=<span class="string">'&#123;.items[*].status.addresses[?(@.type=="ExternalIP")].address&#125;'</span></div><div class="line"></div><div class="line"><span class="meta"># åˆ—å‡ºå±äºæŸä¸ªç‰¹å®š RC çš„ Pods çš„åç§°</span></div><div class="line"><span class="meta"># åœ¨è½¬æ¢å¯¹äº jsonpath è¿‡äºå¤æ‚çš„åœºåˆï¼Œ"jq" å‘½ä»¤å¾ˆæœ‰ç”¨ï¼›å¯ä»¥åœ¨ https://stedolan.github.io/jq/ æ‰¾åˆ°å®ƒã€‚</span></div><div class="line">sel=$&#123;$(kubectl <span class="keyword">get</span> rc my-rc --output=json | jq -j <span class="string">'.spec.selector | to_entries | .[] | "\(.key)=\(.value),"'</span>)%?&#125;</div><div class="line">echo $(kubectl <span class="keyword">get</span> pods --selector=$sel --output=jsonpath=&#123;.items..metadata.name&#125;)</div><div class="line"></div><div class="line"><span class="meta"># æ˜¾ç¤ºæ‰€æœ‰ Pods çš„æ ‡ç­¾ï¼ˆæˆ–ä»»ä½•å…¶ä»–æ”¯æŒæ ‡ç­¾çš„ Kubernetes å¯¹è±¡ï¼‰</span></div><div class="line">kubectl <span class="keyword">get</span> pods --show-labels</div><div class="line"></div><div class="line"><span class="meta"># æ£€æŸ¥å“ªäº›èŠ‚ç‚¹å¤„äºå°±ç»ªçŠ¶æ€</span></div><div class="line">JSONPATH=<span class="string">'&#123;range .items[*]&#125;&#123;@.metadata.name&#125;:&#123;range @.status.conditions[*]&#125;&#123;@.type&#125;=&#123;@.status&#125;;&#123;end&#125;&#123;end&#125;'</span> \</div><div class="line"> &amp;&amp; kubectl <span class="keyword">get</span> nodes -o jsonpath=<span class="string">"$JSONPATH"</span> | grep <span class="string">"Ready=True"</span></div><div class="line"></div><div class="line"><span class="meta"># åˆ—å‡ºè¢«ä¸€ä¸ª Pod ä½¿ç”¨çš„å…¨éƒ¨ Secret</span></div><div class="line">kubectl <span class="keyword">get</span> pods -o json | jq <span class="string">'.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name'</span> | grep -v <span class="literal">null</span> | sort | uniq</div><div class="line"></div><div class="line"><span class="meta"># åˆ—ä¸¾æ‰€æœ‰ Pods ä¸­åˆå§‹åŒ–å®¹å™¨çš„å®¹å™¨ IDï¼ˆcontainerIDï¼‰</span></div><div class="line"><span class="meta"># Helpful when cleaning up stopped containers, while avoiding removal of initContainers.</span></div><div class="line">kubectl <span class="keyword">get</span> pods --all-namespaces -o jsonpath=<span class="string">'&#123;range .items[*].status.initContainerStatuses[*]&#125;&#123;.containerID&#125;&#123;"\n"&#125;&#123;end&#125;'</span> | cut -d/ -f3</div><div class="line"></div><div class="line"><span class="meta"># åˆ—å‡ºäº‹ä»¶ï¼ˆEventsï¼‰ï¼ŒæŒ‰æ—¶é—´æˆ³æ’åº</span></div><div class="line">kubectl <span class="keyword">get</span> events --sort-by=.metadata.creationTimestamp</div><div class="line"></div><div class="line"><span class="meta"># æ¯”è¾ƒå½“å‰çš„é›†ç¾¤çŠ¶æ€å’Œå‡å®šæŸæ¸…å•è¢«åº”ç”¨ä¹‹åçš„é›†ç¾¤çŠ¶æ€</span></div><div class="line">kubectl diff -f ./my-manifest.yaml</div><div class="line"></div><div class="line"><span class="meta"># ç”Ÿæˆä¸€ä¸ªå¥ç‚¹åˆ†éš”çš„æ ‘ï¼Œå…¶ä¸­åŒ…å«ä¸ºèŠ‚ç‚¹è¿”å›çš„æ‰€æœ‰é”®</span></div><div class="line"><span class="meta"># åœ¨å¤æ‚çš„åµŒå¥—JSONç»“æ„ä¸­å®šä½é”®æ—¶éå¸¸æœ‰ç”¨</span></div><div class="line">kubectl <span class="keyword">get</span> nodes -o json | jq -c <span class="string">'path(..)|[.[]|tostring]|join(".")'</span></div><div class="line"></div><div class="line"><span class="meta"># ç”Ÿæˆä¸€ä¸ªå¥ç‚¹åˆ†éš”çš„æ ‘ï¼Œå…¶ä¸­åŒ…å«ä¸ºpodç­‰è¿”å›çš„æ‰€æœ‰é”®</span></div><div class="line">kubectl <span class="keyword">get</span> pods -o json | jq -c <span class="string">'path(..)|[.[]|tostring]|join(".")'</span></div></pre></td></tr></table></figure>
<h2 id="æ›´æ–°èµ„æº"><a href="#æ›´æ–°èµ„æº" class="headerlink" title="æ›´æ–°èµ„æº "></a>æ›´æ–°èµ„æº<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#æ›´æ–°èµ„æº" target="_blank" rel="external"> </a></h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">kubectl <span class="built_in">set</span> image deployment/frontend www=image:v2               <span class="comment"># æ»šåŠ¨æ›´æ–° "frontend" Deployment çš„ "www" å®¹å™¨é•œåƒ</span></div><div class="line">kubectl rollout history deployment/frontend                      <span class="comment"># æ£€æŸ¥ Deployment çš„å†å²è®°å½•ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬</span></div><div class="line">kubectl rollout undo deployment/frontend                         <span class="comment"># å›æ»šåˆ°ä¸Šæ¬¡éƒ¨ç½²ç‰ˆæœ¬</span></div><div class="line">kubectl rollout undo deployment/frontend <span class="comment">--to-revision=2         # å›æ»šåˆ°ç‰¹å®šéƒ¨ç½²ç‰ˆæœ¬</span></div><div class="line">kubectl rollout status -w deployment/frontend                    <span class="comment"># ç›‘è§† "frontend" Deployment çš„æ»šåŠ¨å‡çº§çŠ¶æ€ç›´åˆ°å®Œæˆ</span></div><div class="line">kubectl rollout restart deployment/frontend                      <span class="comment"># è½®æ›¿é‡å¯ "frontend" Deployment</span></div><div class="line"></div><div class="line">cat pod.json | kubectl <span class="built_in">replace</span> -f -                              <span class="comment"># é€šè¿‡ä¼ å…¥åˆ°æ ‡å‡†è¾“å…¥çš„ JSON æ¥æ›¿æ¢ Pod</span></div><div class="line"></div><div class="line"><span class="comment"># å¼ºåˆ¶æ›¿æ¢ï¼Œåˆ é™¤åé‡å»ºèµ„æºã€‚ä¼šå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚</span></div><div class="line">kubectl <span class="built_in">replace</span> <span class="comment">--force -f ./pod.json</span></div><div class="line"></div><div class="line"><span class="comment"># ä¸ºå¤šå‰¯æœ¬çš„ nginx åˆ›å»ºæœåŠ¡ï¼Œä½¿ç”¨ 80 ç«¯å£æä¾›æœåŠ¡ï¼Œè¿æ¥åˆ°å®¹å™¨çš„ 8000 ç«¯å£ã€‚</span></div><div class="line">kubectl expose rc nginx <span class="comment">--port=80 --target-port=8000</span></div><div class="line"></div><div class="line"><span class="comment"># å°†æŸå•å®¹å™¨ Pod çš„é•œåƒç‰ˆæœ¬ï¼ˆæ ‡ç­¾ï¼‰æ›´æ–°åˆ° v4</span></div><div class="line">kubectl <span class="built_in">get</span> pod mypod -o yaml | sed <span class="string">'s/\(image: myimage\):.*$/\1:v4/'</span> | kubectl <span class="built_in">replace</span> -f -</div><div class="line"></div><div class="line">kubectl label pods my-pod <span class="built_in">new</span>-label=awesome                      <span class="comment"># æ·»åŠ æ ‡ç­¾</span></div><div class="line">kubectl annotate pods my-pod icon-url=<span class="keyword">http</span>://goo.gl/XXBTWq       <span class="comment"># æ·»åŠ æ³¨è§£</span></div><div class="line">kubectl autoscale deployment foo <span class="comment">--min=2 --max=10                # å¯¹ "foo" Deployment è‡ªåŠ¨ä¼¸ç¼©å®¹</span></div></pre></td></tr></table></figure>
<h2 id="éƒ¨åˆ†æ›´æ–°èµ„æº"><a href="#éƒ¨åˆ†æ›´æ–°èµ„æº" class="headerlink" title="éƒ¨åˆ†æ›´æ–°èµ„æº "></a>éƒ¨åˆ†æ›´æ–°èµ„æº<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#éƒ¨åˆ†æ›´æ–°èµ„æº" target="_blank" rel="external"> </a></h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># éƒ¨åˆ†æ›´æ–°æŸèŠ‚ç‚¹</span></div><div class="line">kubectl patch <span class="keyword">node</span> <span class="title">k8s-node-1</span> -p '&#123;<span class="string">"spec"</span>:&#123;<span class="string">"unschedulable"</span>:<span class="literal">true</span>&#125;&#125;'</div><div class="line"></div><div class="line"><span class="comment"># æ›´æ–°å®¹å™¨çš„é•œåƒï¼›spec.containers[*].name æ˜¯å¿…é¡»çš„ã€‚å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªåˆå¹¶æ€§è´¨çš„ä¸»é”®ã€‚</span></div><div class="line">kubectl patch pod valid-pod -p '&#123;<span class="string">"spec"</span>:&#123;<span class="string">"containers"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"kubernetes-serve-hostname"</span>,<span class="string">"image"</span>:<span class="string">"new image"</span>&#125;]&#125;&#125;'</div><div class="line"></div><div class="line"><span class="comment"># ä½¿ç”¨å¸¦ä½ç½®æ•°ç»„çš„ JSON patch æ›´æ–°å®¹å™¨çš„é•œåƒ</span></div><div class="line">kubectl patch pod valid-pod --<span class="attr">type=</span>'json' -p='[&#123;<span class="string">"op"</span>: <span class="string">"replace"</span>, <span class="string">"path"</span>: <span class="string">"/spec/containers/0/image"</span>, <span class="string">"value"</span>:<span class="string">"new image"</span>&#125;]'</div><div class="line"></div><div class="line"><span class="comment"># ä½¿ç”¨å¸¦ä½ç½®æ•°ç»„çš„ JSON patch ç¦ç”¨æŸ Deployment çš„ livenessProbe</span></div><div class="line">kubectl patch deployment valid-deployment  --<span class="keyword">type</span> json   -p='[&#123;<span class="string">"op"</span>: <span class="string">"remove"</span>, <span class="string">"path"</span>: <span class="string">"/spec/template/spec/containers/0/livenessProbe"</span>&#125;]'</div><div class="line"></div><div class="line"><span class="comment"># åœ¨å¸¦ä½ç½®æ•°ç»„ä¸­æ·»åŠ å…ƒç´ </span></div><div class="line">kubectl patch sa default --<span class="attr">type=</span>'json' -p='[&#123;<span class="string">"op"</span>: <span class="string">"add"</span>, <span class="string">"path"</span>: <span class="string">"/secrets/1"</span>, <span class="string">"value"</span>: &#123;<span class="string">"name"</span>: <span class="string">"whatever"</span> &#125; &#125;]'</div></pre></td></tr></table></figure>
<h2 id="ç¼–è¾‘èµ„æº"><a href="#ç¼–è¾‘èµ„æº" class="headerlink" title="ç¼–è¾‘èµ„æº "></a>ç¼–è¾‘èµ„æº<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#ç¼–è¾‘èµ„æº" target="_blank" rel="external"> </a></h2><figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl <span class="keyword">edit</span> svc/docker-registry                      <span class="meta"># ç¼–è¾‘åä¸º docker-registry çš„æœåŠ¡</span></div></pre></td></tr></table></figure>
<h2 id="åˆ é™¤èµ„æº"><a href="#åˆ é™¤èµ„æº" class="headerlink" title="åˆ é™¤èµ„æº "></a>åˆ é™¤èµ„æº<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#åˆ é™¤èµ„æº" target="_blank" rel="external"> </a></h2><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">kubectl <span class="keyword">delete</span> -f ./pod.json                                              <span class="comment"># åˆ é™¤åœ¨ pod.json ä¸­æŒ‡å®šçš„ç±»å‹å’Œåç§°çš„ Pod</span></div><div class="line">kubectl <span class="keyword">delete</span> pod,service baz foo                                        <span class="comment"># åˆ é™¤åç§°ä¸º "baz" å’Œ "foo" çš„ Pod å’ŒæœåŠ¡</span></div><div class="line">kubectl <span class="keyword">delete</span> pods,services -l name=myLabel                              <span class="comment"># åˆ é™¤åŒ…å« name=myLabel æ ‡ç­¾çš„ pods å’ŒæœåŠ¡</span></div><div class="line">kubectl -n my-ns <span class="keyword">delete</span> pod,svc --all                                     <span class="comment"># åˆ é™¤åœ¨ my-ns åå­—ç©ºé—´ä¸­å…¨éƒ¨çš„ Pods å’ŒæœåŠ¡</span></div><div class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰ä¸ pattern1 æˆ– pattern2 awk æ¨¡å¼åŒ¹é…çš„ Pods</span></div><div class="line">kubectl get pods  -n mynamespace --<span class="literal">no</span>-headers=<span class="literal">true</span> | awk <span class="string">'/pattern1|pattern2/&#123;print $1&#125;'</span> | xargs  kubectl <span class="keyword">delete</span> -n mynamespace pod</div></pre></td></tr></table></figure>
<h2 id="ä¸è¿è¡Œä¸­çš„-Pods-è¿›è¡Œäº¤äº’"><a href="#ä¸è¿è¡Œä¸­çš„-Pods-è¿›è¡Œäº¤äº’" class="headerlink" title="ä¸è¿è¡Œä¸­çš„ Pods è¿›è¡Œäº¤äº’"></a>ä¸è¿è¡Œä¸­çš„ Pods è¿›è¡Œäº¤äº’</h2><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">kubectl logs <span class="keyword">my</span>-pod                                 <span class="comment"># è·å– pod æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰</span></div><div class="line">kubectl logs -l <span class="built_in">name</span>=myLabel                        <span class="comment"># è·å–å« name=myLabel æ ‡ç­¾çš„ Pods çš„æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰</span></div><div class="line">kubectl logs <span class="keyword">my</span>-pod <span class="comment">--previous                      # è·å–ä¸Šä¸ªå®¹å™¨å®ä¾‹çš„ pod æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰</span></div><div class="line">kubectl logs <span class="keyword">my</span>-pod -c <span class="keyword">my</span>-container                 <span class="comment"># è·å– Pod å®¹å™¨çš„æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡º, å¤šå®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl logs -l <span class="built_in">name</span>=myLabel -c <span class="keyword">my</span>-container        <span class="comment"># è·å–å« name=myLabel æ ‡ç­¾çš„ Pod å®¹å™¨æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡º, å¤šå®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl logs <span class="keyword">my</span>-pod -c <span class="keyword">my</span>-container <span class="comment">--previous      # è·å– Pod ä¸­æŸå®¹å™¨çš„ä¸Šä¸ªå®ä¾‹çš„æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡º, å¤šå®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl logs -f <span class="keyword">my</span>-pod                              <span class="comment"># æµå¼è¾“å‡º Pod çš„æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰</span></div><div class="line">kubectl logs -f <span class="keyword">my</span>-pod -c <span class="keyword">my</span>-container              <span class="comment"># æµå¼è¾“å‡º Pod å®¹å™¨çš„æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡º, å¤šå®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl logs -f -l <span class="built_in">name</span>=myLabel <span class="comment">--all-containers    # æµå¼è¾“å‡ºå« name=myLabel æ ‡ç­¾çš„ Pod çš„æ‰€æœ‰æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰</span></div><div class="line">kubectl <span class="built_in">run</span> -i <span class="comment">--tty busybox --image=busybox -- sh  # ä»¥äº¤äº’å¼ Shell è¿è¡Œ Pod</span></div><div class="line">kubectl <span class="built_in">run</span> nginx <span class="comment">--image=nginx -n mynamespace      # åœ¨æŒ‡å®šåå­—ç©ºé—´ä¸­è¿è¡Œ nginx Pod</span></div><div class="line">kubectl <span class="built_in">run</span> nginx <span class="comment">--image=nginx                     # è¿è¡Œ ngins Pod å¹¶å°†å…¶è§„çº¦å†™å…¥åˆ°åä¸º pod.yaml çš„æ–‡ä»¶</span></div><div class="line">  <span class="comment">--dry-run=client -o yaml &gt; pod.yaml</span></div><div class="line"></div><div class="line">kubectl attach <span class="keyword">my</span>-pod -i                            <span class="comment"># æŒ‚æ¥åˆ°ä¸€ä¸ªè¿è¡Œçš„å®¹å™¨ä¸­</span></div><div class="line">kubectl port-forward <span class="keyword">my</span>-pod <span class="number">5000</span>:<span class="number">6000</span>               <span class="comment"># åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šä¾¦å¬ç«¯å£ 5000 å¹¶è½¬å‘åˆ° my-pod ä¸Šçš„ç«¯å£ 6000</span></div><div class="line">kubectl exec <span class="keyword">my</span>-pod <span class="comment">-- ls /                         # åœ¨å·²æœ‰çš„ Pod ä¸­è¿è¡Œå‘½ä»¤ï¼ˆå•å®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl exec <span class="comment">--stdin --tty my-pod -- /bin/sh        # ä½¿ç”¨äº¤äº’ shell è®¿é—®æ­£åœ¨è¿è¡Œçš„ Pod (ä¸€ä¸ªå®¹å™¨åœºæ™¯)</span></div><div class="line">kubectl exec <span class="keyword">my</span>-pod -c <span class="keyword">my</span>-container <span class="comment">-- ls /         # åœ¨å·²æœ‰çš„ Pod ä¸­è¿è¡Œå‘½ä»¤ï¼ˆå¤šå®¹å™¨åœºæ™¯ï¼‰</span></div><div class="line">kubectl top pod POD_NAME <span class="comment">--containers               # æ˜¾ç¤ºç»™å®š Pod å’Œå…¶ä¸­å®¹å™¨çš„ç›‘æ§æ•°æ®</span></div></pre></td></tr></table></figure>
<h2 id="ä¸èŠ‚ç‚¹å’Œé›†ç¾¤è¿›è¡Œäº¤äº’"><a href="#ä¸èŠ‚ç‚¹å’Œé›†ç¾¤è¿›è¡Œäº¤äº’" class="headerlink" title="ä¸èŠ‚ç‚¹å’Œé›†ç¾¤è¿›è¡Œäº¤äº’"></a>ä¸èŠ‚ç‚¹å’Œé›†ç¾¤è¿›è¡Œäº¤äº’</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">kubectl cordon my-<span class="keyword">node</span>                                                <span class="title"># æ ‡è®° my-node</span> èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦</div><div class="line">kubectl drain my-<span class="keyword">node</span>                                                 <span class="title"># å¯¹ my-node</span> èŠ‚ç‚¹è¿›è¡Œæ¸…ç©ºæ“ä½œï¼Œä¸ºèŠ‚ç‚¹ç»´æŠ¤åšå‡†å¤‡</div><div class="line">kubectl uncordon my-<span class="keyword">node</span>                                              <span class="title"># æ ‡è®° my-node</span> èŠ‚ç‚¹ä¸ºå¯ä»¥è°ƒåº¦</div><div class="line">kubectl top <span class="keyword">node</span> <span class="title">my-node</span>                                              <span class="comment"># æ˜¾ç¤ºç»™å®šèŠ‚ç‚¹çš„åº¦é‡å€¼</span></div><div class="line">kubectl cluster<span class="literal">-inf</span>o                                                  <span class="comment"># æ˜¾ç¤ºä¸»æ§èŠ‚ç‚¹å’ŒæœåŠ¡çš„åœ°å€</span></div><div class="line">kubectl cluster<span class="literal">-inf</span>o dump                                             <span class="comment"># å°†å½“å‰é›†ç¾¤çŠ¶æ€è½¬å‚¨åˆ°æ ‡å‡†è¾“å‡º</span></div><div class="line">kubectl cluster<span class="literal">-inf</span>o dump --<span class="attr">output-directory=</span>/path/to/cluster-state   <span class="comment"># å°†å½“å‰é›†ç¾¤çŠ¶æ€è¾“å‡ºåˆ° /path/to/cluster-state</span></div><div class="line"></div><div class="line"><span class="comment"># å¦‚æœå·²å­˜åœ¨å…·æœ‰æŒ‡å®šé”®å’Œæ•ˆæœçš„æ±¡ç‚¹ï¼Œåˆ™æ›¿æ¢å…¶å€¼ä¸ºæŒ‡å®šå€¼ã€‚</span></div><div class="line">kubectl taint nodes foo <span class="attr">dedicated=</span>special-user:NoSchedule</div></pre></td></tr></table></figure>
<h3 id="æ ¼å¼åŒ–è¾“å‡º"><a href="#æ ¼å¼åŒ–è¾“å‡º" class="headerlink" title="æ ¼å¼åŒ–è¾“å‡º "></a>æ ¼å¼åŒ–è¾“å‡º<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#æ ¼å¼åŒ–è¾“å‡º" target="_blank" rel="external"> </a></h3><p>è¦ä»¥ç‰¹å®šæ ¼å¼å°†è¯¦ç»†ä¿¡æ¯è¾“å‡ºåˆ°ç»ˆç«¯çª—å£ï¼Œå°† <code>-o</code>ï¼ˆæˆ–è€… <code>--output</code>ï¼‰å‚æ•°æ·»åŠ åˆ°æ”¯æŒçš„ <code>kubectl</code> å‘½ä»¤ä¸­ã€‚</p>
<table>
<thead>
<tr>
<th>è¾“å‡ºæ ¼å¼</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-o=custom-columns=&lt;spec&gt;</code></td>
<td>ä½¿ç”¨é€—å·åˆ†éš”çš„è‡ªå®šä¹‰åˆ—æ¥æ‰“å°è¡¨æ ¼</td>
</tr>
<tr>
<td><code>-o=custom-columns-file=&lt;filename&gt;</code></td>
<td>ä½¿ç”¨ <code>&lt;filename&gt;</code> æ–‡ä»¶ä¸­çš„è‡ªå®šä¹‰åˆ—æ¨¡æ¿æ‰“å°è¡¨æ ¼</td>
</tr>
<tr>
<td><code>-o=json</code></td>
<td>è¾“å‡º JSON æ ¼å¼çš„ API å¯¹è±¡</td>
</tr>
<tr>
<td><code>-o=jsonpath=&lt;template&gt;</code></td>
<td>æ‰“å° <a href="https://kubernetes.io/zh/docs/reference/kubectl/jsonpath" target="_blank" rel="external">jsonpath</a> è¡¨è¾¾å¼ä¸­å®šä¹‰çš„å­—æ®µ</td>
</tr>
<tr>
<td><code>-o=jsonpath-file=&lt;filename&gt;</code></td>
<td>æ‰“å°åœ¨ <code>&lt;filename&gt;</code> æ–‡ä»¶ä¸­å®šä¹‰çš„ <a href="https://kubernetes.io/zh/docs/reference/kubectl/jsonpath" target="_blank" rel="external">jsonpath</a> è¡¨è¾¾å¼æ‰€æŒ‡å®šçš„å­—æ®µã€‚</td>
</tr>
<tr>
<td><code>-o=name</code></td>
<td>ä»…æ‰“å°èµ„æºåç§°è€Œä¸æ‰“å°å…¶ä»–å†…å®¹</td>
</tr>
<tr>
<td><code>-o=wide</code></td>
<td>ä»¥çº¯æ–‡æœ¬æ ¼å¼è¾“å‡ºé¢å¤–ä¿¡æ¯ï¼Œå¯¹äº Pod æ¥è¯´ï¼Œè¾“å‡ºä¸­åŒ…å«äº†èŠ‚ç‚¹åç§°</td>
</tr>
<tr>
<td><code>-o=yaml</code></td>
<td>è¾“å‡º YAML æ ¼å¼çš„ API å¯¹è±¡</td>
</tr>
</tbody>
</table>
<h3 id="Kubectl-æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦å’Œè°ƒè¯•"><a href="#Kubectl-æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦å’Œè°ƒè¯•" class="headerlink" title="Kubectl æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦å’Œè°ƒè¯• "></a>Kubectl æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦å’Œè°ƒè¯•<a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#kubectl-æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦å’Œè°ƒè¯•" target="_blank" rel="external"> </a></h3><p>Kubectl æ—¥å¿—è¾“å‡ºè¯¦ç»†ç¨‹åº¦æ˜¯é€šè¿‡ <code>-v</code> æˆ–è€… <code>--v</code> æ¥æ§åˆ¶çš„ï¼Œå‚æ•°åè·Ÿä¸€ä¸ªæ•°å­—è¡¨ç¤ºæ—¥å¿—çš„çº§åˆ«ã€‚ Kubernetes é€šç”¨çš„æ—¥å¿—ä¹ æƒ¯å’Œç›¸å…³çš„æ—¥å¿—çº§åˆ«åœ¨ <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md" target="_blank" rel="external">è¿™é‡Œ</a> æœ‰ç›¸åº”çš„æè¿°ã€‚</p>
<table>
<thead>
<tr>
<th>è¯¦ç»†ç¨‹åº¦</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--v=0</code></td>
<td>ç”¨äºé‚£äº›åº”è¯¥ <em>å§‹ç»ˆ</em> å¯¹è¿ç»´äººå‘˜å¯è§çš„ä¿¡æ¯ï¼Œå› ä¸ºè¿™äº›ä¿¡æ¯ä¸€èˆ¬å¾ˆæœ‰ç”¨ã€‚</td>
</tr>
<tr>
<td><code>--v=1</code></td>
<td>å¦‚æœæ‚¨ä¸æƒ³è¦çœ‹åˆ°å†—ä½™ä¿¡æ¯ï¼Œæ­¤å€¼æ˜¯ä¸€ä¸ªåˆç†çš„é»˜è®¤æ—¥å¿—çº§åˆ«ã€‚</td>
</tr>
<tr>
<td><code>--v=2</code></td>
<td>è¾“å‡ºæœ‰å…³æœåŠ¡çš„ç¨³å®šçŠ¶æ€çš„ä¿¡æ¯ä»¥åŠé‡è¦çš„æ—¥å¿—æ¶ˆæ¯ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½ä¸ç³»ç»Ÿä¸­çš„é‡å¤§å˜åŒ–æœ‰å…³ã€‚è¿™æ˜¯å»ºè®®å¤§å¤šæ•°ç³»ç»Ÿè®¾ç½®çš„é»˜è®¤æ—¥å¿—çº§åˆ«ã€‚</td>
</tr>
<tr>
<td><code>--v=3</code></td>
<td>åŒ…å«æœ‰å…³ç³»ç»ŸçŠ¶æ€å˜åŒ–çš„æ‰©å±•ä¿¡æ¯ã€‚</td>
</tr>
<tr>
<td><code>--v=4</code></td>
<td>åŒ…å«è°ƒè¯•çº§åˆ«çš„å†—ä½™ä¿¡æ¯ã€‚</td>
</tr>
<tr>
<td><code>--v=5</code></td>
<td>è·Ÿè¸ªçº§åˆ«çš„è¯¦ç»†ç¨‹åº¦ã€‚</td>
</tr>
<tr>
<td><code>--v=6</code></td>
<td>æ˜¾ç¤ºæ‰€è¯·æ±‚çš„èµ„æºã€‚</td>
</tr>
<tr>
<td><code>--v=7</code></td>
<td>æ˜¾ç¤º HTTP è¯·æ±‚å¤´ã€‚</td>
</tr>
<tr>
<td><code>--v=8</code></td>
<td>æ˜¾ç¤º HTTP è¯·æ±‚å†…å®¹ã€‚</td>
</tr>
<tr>
<td><code>--v=9</code></td>
<td>æ˜¾ç¤º HTTP è¯·æ±‚å†…å®¹è€Œä¸”ä¸æˆªæ–­å†…å®¹ã€‚</td>
</tr>
</tbody>
</table>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://ruby-china-files.b0.upaiyun.com/user/big_avatar/5575.jpg"
               alt="peterfei" />
          <p class="site-author-name" itemprop="name">peterfei</p>
          <p class="site-description motion-element" itemprop="description">peterfei|æŠ€æœ¯|ä¸Šä¸»æ˜¯æˆ‘çš„ç‰§è€…</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">76</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">åˆ†ç±»</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/peterfei" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">peterfei</span>
</div>

<div class="powered-by">
  ç”± <a class="theme-link" href="http://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"peterfei"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  


</body>
</html>
