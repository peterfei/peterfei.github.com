<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="peterfei.me,peterfei" />





  <link rel="alternate" href="/atom.xml" title="Peterfei" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.0" />






<meta name="description" content="peterfei|技术|上主是我的牧者">
<meta property="og:type" content="website">
<meta property="og:title" content="Peterfei">
<meta property="og:url" content="http://peterfei.me/page/3/index.html">
<meta property="og:site_name" content="Peterfei">
<meta property="og:description" content="peterfei|技术|上主是我的牧者">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Peterfei">
<meta name="twitter:description" content="peterfei|技术|上主是我的牧者">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: '[object Object]',
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Peterfei </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Peterfei</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">上主是我的牧者，我实在一无所缺</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'PqEYgqEwUwFoXjgtngj9','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/10/29/记k8s在公网部署/" itemprop="url">
                  记k8s在公网部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-10-29T10:26:59+08:00" content="2020-10-29">
              2020-10-29
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/10/29/记k8s在公网部署/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/10/29/记k8s在公网部署/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="1-安装必备软件"><a href="#1-安装必备软件" class="headerlink" title="1. 安装必备软件"></a>1. 安装必备软件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y wget vim net-tools epel-<span class="keyword">release</span></div></pre></td></tr></table></figure>
<h3 id="2-关闭swap"><a href="#2-关闭swap" class="headerlink" title="2. 关闭swap"></a>2. 关闭swap</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">swapoff -a</div><div class="line"></div><div class="line"><span class="comment"># 永久禁用，打开/etc/fstab注释掉swap那一行。</span></div><div class="line">sed -i <span class="string">'s/.*swap.*/#&amp;/'</span> <span class="regexp">/etc/</span>fstab</div></pre></td></tr></table></figure>
<h3 id="3-关闭selinux"><a href="#3-关闭selinux" class="headerlink" title="3. 关闭selinux"></a>3. 关闭selinux</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 临时禁用selinux</span></div><div class="line">setenforce <span class="number">0</span></div><div class="line"><span class="meta"># 永久关闭 修改/etc/sysconfig/selinux文件设置</span></div><div class="line">sed -i <span class="string">'s/SELINUX=permissive/SELINUX=disabled/'</span> /etc/sysconfig/selinux</div><div class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</div></pre></td></tr></table></figure>
<h3 id="4-关闭防火墙"><a href="#4-关闭防火墙" class="headerlink" title="4. 关闭防火墙"></a>4. 关闭防火墙</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl <span class="keyword">disable</span> firewalld</div><div class="line">systemctl <span class="keyword">stop</span> firewalld</div></pre></td></tr></table></figure>
<h2 id="安装Docker和配置代理"><a href="#安装Docker和配置代理" class="headerlink" title="安装Docker和配置代理"></a>安装Docker和配置代理</h2><h3 id="1-配置yum源"><a href="#1-配置yum源" class="headerlink" title="1. 配置yum源"></a>1. 配置yum源</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">## 配置默认源</div><div class="line">## 备份</div><div class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</div><div class="line"></div><div class="line">## 下载阿里源</div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http:<span class="comment">//mirrors.aliyun.com/repo/Centos-7.repo</span></div><div class="line"></div><div class="line">## 刷新</div><div class="line">yum makecache fast</div><div class="line"></div><div class="line">## 配置k8s源</div><div class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</div><div class="line">[kubernetes]</div><div class="line">name=Kubernetes</div><div class="line">baseurl=https:<span class="comment">//mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></div><div class="line">enabled=<span class="number">1</span></div><div class="line">gpgcheck=<span class="number">0</span></div><div class="line">EOF</div><div class="line"></div><div class="line">## 重建yum缓存</div><div class="line">yum clean all</div><div class="line">yum makecache fast</div><div class="line">yum -y update</div></pre></td></tr></table></figure>
<h3 id="2-安装docker"><a href="#2-安装docker" class="headerlink" title="2. 安装docker"></a>2. 安装docker</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">yum -y <span class="keyword">install</span> yum-utils device-mapper-persistent-<span class="keyword">data</span> lvm2</div><div class="line">yum-config-manager <span class="comment">--add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></div><div class="line">yum -y <span class="keyword">install</span> docker-ce</div><div class="line">systemctl <span class="keyword">enable</span> docker</div><div class="line">systemctl <span class="keyword">start</span> docker</div></pre></td></tr></table></figure>
<h3 id="3-确保kubelet使用的cgroup-driver-与-Docker的一致"><a href="#3-确保kubelet使用的cgroup-driver-与-Docker的一致" class="headerlink" title="3. 确保kubelet使用的cgroup driver 与 Docker的一致"></a>3. 确保kubelet使用的cgroup driver 与 Docker的一致</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;<span class="built_in">EOF</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</div><div class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</div><div class="line">  <span class="string">"log-opts"</span>: &#123;</div><div class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>,</div><div class="line">  <span class="string">"storage-opts"</span>: [</div><div class="line">    <span class="string">"overlay2.override_kernel_check=true"</span></div><div class="line">  ]</div><div class="line">&#125;</div><div class="line"><span class="built_in">EOF</span></div><div class="line"></div><div class="line">sudo systemctl daemon-reload sudo systemctl restart docker</div></pre></td></tr></table></figure>
<h3 id="4-设置docker代理（核心步骤-如果有代理）"><a href="#4-设置docker代理（核心步骤-如果有代理）" class="headerlink" title="4. 设置docker代理（核心步骤-如果有代理）"></a>4. 设置docker代理（核心步骤-如果有代理）</h3><blockquote>
<p>没有代理执行步骤5</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mkdir /etc/systemd/system/docker<span class="selector-class">.service</span><span class="selector-class">.d</span></div><div class="line">touch /etc/systemd/system/docker<span class="selector-class">.service</span><span class="selector-class">.d</span>/http-proxy<span class="selector-class">.conf</span></div><div class="line"></div><div class="line">[Service]</div><div class="line">Environment=<span class="string">"HTTP_PROXY=http://xxx"</span></div><div class="line">Environment=<span class="string">"HTTPS_PROXY=http://xxx"</span></div><div class="line">Environment=<span class="string">"NO_PROXY=localhost,127.0.0.1,localaddress,.localdomain.com"</span></div><div class="line"></div><div class="line">systemctl daemon-reload &amp;&amp; systemctl restart docker</div></pre></td></tr></table></figure>
<h3 id="5-从国内仓库拉取镜像（核心步骤-如果没有代理）"><a href="#5-从国内仓库拉取镜像（核心步骤-如果没有代理）" class="headerlink" title="5. 从国内仓库拉取镜像（核心步骤-如果没有代理）"></a>5. 从国内仓库拉取镜像（核心步骤-如果没有代理）</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## 查看集群初始化所需镜像及对应依赖版本号，列出的就是需要下载的镜像</span></div><div class="line">kubeadm config images <span class="built_in">list</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">images=(</div><div class="line">kube-apiserver:v1.18.0</div><div class="line">kube-controller-manager:v1.18.0</div><div class="line">kube-scheduler:v1.18.0</div><div class="line">kube-proxy:v1.18.0</div><div class="line">pause:3.2</div><div class="line">etcd:3.4.3-0</div><div class="line">coredns:1.6.7</div><div class="line">kubernetes-dashboard-amd64:v1.10.1</div><div class="line">)</div><div class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span>;<span class="keyword">do</span></div><div class="line">        docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></div><div class="line">        docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<h2 id="开始安装k8s"><a href="#开始安装k8s" class="headerlink" title="开始安装k8s"></a>开始安装k8s</h2><h3 id="1-安装kubeadm，kubelet等"><a href="#1-安装kubeadm，kubelet等" class="headerlink" title="1. 安装kubeadm，kubelet等"></a>1. 安装kubeadm，kubelet等</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum -y <span class="keyword">install</span> kubelet kubeadm kubectl kubernetes-cni</div><div class="line">systemctl <span class="keyword">enable</span> kubelet &amp;&amp; systemctl <span class="keyword">start</span> kubelet</div></pre></td></tr></table></figure>
<h3 id="2-集群初始化"><a href="#2-集群初始化" class="headerlink" title="2. 集群初始化"></a>2. 集群初始化</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">## master节点执行：</div><div class="line">sudo kubeadm init \</div><div class="line"> --apiserver-advertise-address <span class="number">10.1</span><span class="number">.69</span><span class="number">.101</span> \</div><div class="line"> --kubernetes-version=v1<span class="number">.15</span><span class="number">.0</span> \</div><div class="line"> --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></div></pre></td></tr></table></figure>
<blockquote>
<p>公网会卡在:</p>
</blockquote>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[wait-control-plane] Waiting <span class="keyword">for</span> the kubelet <span class="keyword">to</span> boot up the control plane <span class="keyword">as</span> <span class="keyword">static</span> Pods <span class="keyword">from</span> directory <span class="string">"/etc/kubernetes/manifests"</span>. This can <span class="keyword">take</span> up <span class="keyword">to</span> <span class="number">4</span>m0s</div><div class="line">[kubelet-check] Initial timeout <span class="keyword">of</span> <span class="number">40</span>s passed.</div></pre></td></tr></table></figure>
<h2 id="修改etcd-yaml"><a href="#修改etcd-yaml" class="headerlink" title="修改etcd.yaml"></a>修改etcd.yaml</h2><blockquote>
<p>文件路径”/etc/kubernetes/manifests/etcd.yaml”</p>
</blockquote>
<h5 id="修改前"><a href="#修改前" class="headerlink" title="修改前"></a>修改前</h5><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g90yzxelfhj30m00f8ac2.jpg" alt=""></p>
<h5 id="修改后"><a href="#修改后" class="headerlink" title="修改后"></a>修改后</h5><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g90z0cev0kj30m00f8dhs.jpg" alt=""></p>
<blockquote>
<p>此处”xxx”为公网ip，要关注的是”–listen-client-urls”和”–listen-peer-urls”。需要把–listen-client-urls 和 –listen-peer-urls 都改成0.0.0.0：xxx</p>
</blockquote>
<p><a href="https://my.oschina.net/u/4389078/blog/3233116" target="_blank" rel="external">来源</a></p>
<p>得到回复：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">(...省略)</div><div class="line"><span class="keyword">mkdir</span> -p <span class="variable">$HOME</span>/.kube</div><div class="line">sudo cp -i /etc/kubernetes/admin.<span class="keyword">conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -<span class="keyword">u</span>):$(id -<span class="keyword">g</span>) <span class="variable">$HOME</span>/.kube/config</div><div class="line"></div><div class="line">## 保存好该命令，丢了不好找回。节点加入时需要</div><div class="line">kubeadm join 10.1.69.101:6443 --<span class="keyword">token</span> ou5pvo.qseafc4s8licblzy \</div><div class="line">    --discovery-<span class="keyword">token</span>-<span class="keyword">ca</span>-cert-hash sha256:de9c10f11c50c074f212698b9d514fc12a9c1c4ffe70961aff89ac5e585f0663</div></pre></td></tr></table></figure>
<h3 id="3-拷贝配置，给kubectl使用"><a href="#3-拷贝配置，给kubectl使用" class="headerlink" title="3. 拷贝配置，给kubectl使用"></a>3. 拷贝配置，给kubectl使用</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir -<span class="selector-tag">p</span> <span class="variable">$HOME</span>/<span class="selector-class">.kube</span></div><div class="line">sudo cp -<span class="selector-tag">i</span> /etc/kubernetes/admin<span class="selector-class">.conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</div></pre></td></tr></table></figure>
<h3 id="4-安装flannel网络"><a href="#4-安装flannel网络" class="headerlink" title="4. 安装flannel网络"></a>4. 安装flannel网络</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo kubectl apply -<span class="keyword">f</span> http<span class="variable">s:</span>//raw.githubusercontent.<span class="keyword">com</span>/coreos/flannel/master/Documentation/kube-flannel.yml</div><div class="line"></div><div class="line">## 查看flannal是否安装成功</div><div class="line"></div><div class="line">sudo kubectl -n kube-<span class="built_in">system</span> <span class="built_in">get</span> <span class="keyword">po</span> -<span class="keyword">l</span> app=flannel -<span class="keyword">o</span> wide</div></pre></td></tr></table></figure>
<h2 id="5-node节点加入集群"><a href="#5-node节点加入集群" class="headerlink" title="5. node节点加入集群"></a>5. node节点加入集群</h2><p>其他节点执行：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">kubeadm</span> <span class="selector-tag">join</span> 39<span class="selector-class">.99</span><span class="selector-class">.xxx</span><span class="selector-class">.xxx</span><span class="selector-pseudo">:6443</span>   <span class="selector-tag">--token</span> <span class="selector-tag">w4tx2r</span><span class="selector-class">.0dm194h24wlw8m8t</span> <span class="selector-tag">--discovery-token-ca-cert-hash</span> <span class="selector-tag">sha256</span><span class="selector-pseudo">:caae3b178b4172839269254f373b6eaa14514173b01e129e0b0fe7d64694dc39</span></div></pre></td></tr></table></figure>
<h2 id="清理安装"><a href="#清理安装" class="headerlink" title="清理安装"></a>清理安装</h2><blockquote>
<p> 如果安装过程中出任何问题，可以重置后重新安装</p>
</blockquote>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">sudo kubeadm reset</span></div></pre></td></tr></table></figure>
<h1 id="Dashboard安装"><a href="#Dashboard安装" class="headerlink" title="Dashboard安装"></a>Dashboard安装</h1><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 安装dashboard，国内可以使用别的yaml源</span></div><div class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.<span class="number">10.1</span>/src/deploy/recommended/kubernetes-dashboard.yaml</div><div class="line"></div><div class="line"><span class="comment"># 修改node为NodePort模式</span></div><div class="line">kubectl patch svc -n kube-system kubernetes-dashboard -p '&#123;<span class="string">"spec"</span>:&#123;<span class="string">"type"</span>:<span class="string">"NodePort"</span>&#125;&#125;'</div><div class="line"></div><div class="line"><span class="comment"># 查看服务(得知dashboard运行在443:32383/TCP端口)</span></div><div class="line">kubectl get svc -n kube-system </div><div class="line"><span class="comment"># --- 输出 ---</span></div><div class="line">NAME                   <span class="keyword">TYPE</span>        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE</div><div class="line">kube-dns               ClusterIP   <span class="number">10.96</span>.<span class="number">0.10</span>      <span class="tag">&lt;none&gt;</span>        <span class="number">53</span>/UDP,<span class="number">53</span>/TCP,<span class="number">9153</span>/TCP   <span class="number">7h</span>40m</div><div class="line">kubernetes-dashboard   NodePort    <span class="number">10.111</span>.<span class="number">77.210</span>   <span class="tag">&lt;none&gt;</span>        <span class="number">443</span>:<span class="number">32383</span>/TCP            <span class="number">3h</span>42m</div><div class="line"><span class="comment"># --- 输出 ---</span></div><div class="line"></div><div class="line"><span class="comment"># 查看dashboard运行在哪个node(得知dashboard运行在192.168.20.4)</span></div><div class="line">kubectl get pods -A -o wide</div><div class="line"><span class="comment"># --- 输出 ---</span></div><div class="line">NAMESPACE     NAME                                    READY   STATUS    RESTARTS   AGE     IP             <span class="keyword">NODE</span>     <span class="title">NOMINATED</span> <span class="keyword">NODE</span>   <span class="title">READINESS</span> GATES</div><div class="line">kube-system   coredns-fb8b8dccf-rn8kd                 <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>43m   <span class="number">10.244</span>.<span class="number">0.2</span>     <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   coredns-fb8b8dccf-slwr4                 <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>43m   <span class="number">10.244</span>.<span class="number">0.3</span>     <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   etcd-<span class="keyword">master</span>                             <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-apiserver-<span class="keyword">master</span>                   <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-controller-manager-<span class="keyword">master</span>          <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-flannel-ds-amd64-l8c7c             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>3m    <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-flannel-ds-amd64-lcmxw             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">6h</span>50m   <span class="number">192.168</span>.<span class="number">20.4</span>   node1    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-flannel-ds-amd64-pqnln             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">6h</span>5m    <span class="number">192.168</span>.<span class="number">20.3</span>   node2    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-proxy-<span class="number">4</span>kcqb                        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>43m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-proxy-jcqjd                        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">6h</span>5m    <span class="number">192.168</span>.<span class="number">20.3</span>   node2    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-proxy-vm9sj                        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">6h</span>50m   <span class="number">192.168</span>.<span class="number">20.4</span>   node1    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-scheduler-<span class="keyword">master</span>                   <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kubernetes-dashboard-<span class="number">5</span>f7b999d65-<span class="number">2</span>ltmv   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3h</span>45m   <span class="number">10.244</span>.<span class="number">1.2</span>     node1    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line"><span class="comment"># --- 输出 ---</span></div><div class="line"><span class="comment"># 如果无法变成Running状态，可以使用以下命令排错</span></div><div class="line">journalctl -f -u kubelet  <span class="comment"># 只看当前的kubelet进程日志</span></div><div class="line"><span class="comment">### 提示拉取镜像失败，无法翻墙的可以使用以下方法预先拉取镜像</span></div><div class="line"><span class="comment">### 请在kubernetes-dashboard的节点上操作：</span></div><div class="line">docker pull mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span></div><div class="line">docker <span class="keyword">tag</span> <span class="title">mirrorgooglecontainers</span>/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span> k8s.gcr.io/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span></div><div class="line">docker rmi  mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span></div></pre></td></tr></table></figure>
<p>获取token命令</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## 获取登陆界面token</span></div><div class="line">kubectl -n kube-<span class="keyword">system</span> describe $(kubectl -n kube-<span class="keyword">system</span> \</div><div class="line"><span class="built_in">get</span> secret -n kube-<span class="keyword">system</span> -o name | grep namespace) | grep <span class="keyword">token</span></div></pre></td></tr></table></figure>
<p>如果dashboard的token过期，以下脚本重新生成config文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">TOKEN=$(kubectl -n kube-system describe secret default| awk <span class="string">'$1=="token:"&#123;print $2&#125;'</span>)</div><div class="line">kubectl config <span class="built_in">set</span>-credentials kubernetes-admin --token=<span class="string">"<span class="variable">$&#123;TOKEN&#125;</span>"</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/18/如何编写Dockerfile/" itemprop="url">
                  如何编写Dockerfile
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-18T13:59:18+08:00" content="2019-04-18">
              2019-04-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/18/如何编写Dockerfile/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/18/如何编写Dockerfile/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>假设我们需要使用Docker运行一个Node.js应用</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get upgrade -y  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nodejs ssh mysql  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> mysql &amp; sshd &amp; npm start</span></div></pre></td></tr></table></figure>
<p>构建镜像:</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-t mydocker .</div></pre></td></tr></table></figure>
<h4 id="编写-dockerignore文件"><a href="#编写-dockerignore文件" class="headerlink" title="编写.dockerignore文件"></a>编写.dockerignore文件</h4><p>构建镜像时，Docker需要先准备context ，将所有需要的文件收集到进程中。默认的context包含Dockerfile目录中的所有文件，但是实际上，我们并不需要.git目录，node_modules目录等内容。 .dockerignore 的作用和语法类似于 .gitignore，可以忽略一些不需要的文件，这样可以有效加快镜像构建时间，同时减少Docker镜像的大小。示例如下:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="title">.git/</span></div><div class="line">node<span class="emphasis">_modules/</span></div></pre></td></tr></table></figure>
<h4 id="容器只运行单个应用"><a href="#容器只运行单个应用" class="headerlink" title="容器只运行单个应用"></a>容器只运行单个应用</h4><p>从技术角度讲，你可以在Docker容器中运行多个进程。你可以将数据库，前端，后端，ssh，supervisor都运行在同一个Docker容器中。但是，这会让你非常痛苦:</p>
<ul>
<li>非常长的构建时间(修改前端之后，整个后端也需要重新构建)</li>
<li>非常大的镜像大小</li>
<li>多个应用的日志难以处理</li>
<li>横向扩展时非常浪费资源(不同的应用需要运行的容器数并不相同)</li>
<li>僵尸进程问题 - 你需要选择合适的init进程</li>
</ul>
<p>因此，我建议大家为每个应用构建单独的Docker镜像，然后使用 Docker Compose 运行多个Docker容器。</p>
<p>现在，我从Dockerfile中删除一些不需要的安装包，另外，SSH可以用docker exec替代。示例如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get upgrade -y</span></div><div class="line"></div><div class="line"><span class="comment"># we should remove ssh and mysql, and use</span></div><div class="line"><span class="comment"># separate container for database </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nodejs  <span class="comment"># ssh mysql  </span></span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="将多个RUN指令合并为一个"><a href="#将多个RUN指令合并为一个" class="headerlink" title="将多个RUN指令合并为一个"></a>将多个RUN指令合并为一个</h4><p>Docker镜像是分层的，下面这些知识点非常重要:</p>
<ul>
<li>Dockerfile中的每个指令都会创建一个新的镜像层。</li>
<li>镜像层将被缓存和复用</li>
<li>当Dockerfile的指令修改了，复制的文件变化了，或者构建镜像时指定的变量不同了，对应的镜像层缓存就会失效</li>
<li>某一层的镜像缓存失效之后，它之后的镜像层缓存都会失效</li>
<li>镜像层是不可变的，如果我们再某一层中添加一个文件，然后在下一层中删除它，则镜像中依然会包含该文件(只是这个文件在Docker容器中不可见了)。</li>
</ul>
<p>Docker镜像类似于洋葱。它们都有很多层。为了修改内层，则需要将外面的层都删掉。记住这一点的话，其他内容就很好理解了。</p>
<p>现在，我们将所有的RUN指令合并为一个。同时把apt-get upgrade删除，因为它会使得镜像构建非常不确定(我们只需要依赖基础镜像的更新就好了)</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \  </span></div><div class="line">    &amp;&amp; apt-get install -y nodejs \</div><div class="line">    &amp;&amp; cd /app \</div><div class="line">    &amp;&amp; npm install</div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<p>记住一点，我们只能将变化频率一样的指令合并在一起。将node.js安装与npm模块安装放在一起的话，则每次修改源代码，都需要重新安装node.js，这显然不合适。因此，正确的写法是这样的:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y nodejs  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="基础镜像的标签不要用latest"><a href="#基础镜像的标签不要用latest" class="headerlink" title="基础镜像的标签不要用latest"></a>基础镜像的标签不要用latest</h4><p>当镜像没有指定标签时，将默认使用latest 标签。因此， FROM ubuntu 指令等同于FROM ubuntu:latest。当时，当镜像更新时，latest标签会指向不同的镜像，这时构建镜像有可能失败。如果你的确需要使用最新版的基础镜像，可以使用latest标签，否则的话，最好指定确定的镜像标签。</p>
<p>示例Dockerfile应该使用16.04作为标签。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">16.04</span>  <span class="comment"># it's that easy!</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y nodejs  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="每个RUN指令后删除多余文件"><a href="#每个RUN指令后删除多余文件" class="headerlink" title="每个RUN指令后删除多余文件"></a>每个RUN指令后删除多余文件</h4><p>假设我们更新了apt-get源，下载，解压并安装了一些软件包，它们都保存在/var/lib/apt/lists/目录中。但是，运行应用时Docker镜像中并不需要这些文件。我们最好将它们删除，因为它会使Docker镜像变大。</p>
<p>示例Dockerfile中，我们可以删除/var/lib/apt/lists/目录中的文件(它们是由apt-get update生成的)。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ROM ubuntu:<span class="number">16.04</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \  </span></div><div class="line">    &amp;&amp; apt-get install -y nodejs \</div><div class="line">    <span class="comment"># added lines</span></div><div class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/*</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="选择合适的基础镜像-alpine版本最好"><a href="#选择合适的基础镜像-alpine版本最好" class="headerlink" title="选择合适的基础镜像(alpine版本最好)"></a>选择合适的基础镜像(alpine版本最好)</h4><p>在示例中，我们选择了ubuntu作为基础镜像。但是我们只需要运行node程序，有必要使用一个通用的基础镜像吗？node镜像应该是更好的选择。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="comment"># we don't need to install node </span></div><div class="line"><span class="comment"># anymore and use apt-get</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<p>更好的选择是alpine版本的node镜像。alpine是一个极小化的Linux发行版，只有4MB，这让它非常适合作为基础镜像。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="设置WORKDIR和-CMD"><a href="#设置WORKDIR和-CMD" class="headerlink" title="设置WORKDIR和 CMD"></a>设置WORKDIR和 CMD</h4><p>WORKDIR指令可以设置默认目录，也就是运行RUN / CMD / ENTRYPOINT指令的地方。</p>
<p>CMD指令可以设置容器创建是执行的默认命令。另外，你应该讲命令写在一个数组中，数组中每个元素为命令的每个单词(参考<a href="https://docs.docker.com/engine/reference/builder/#cmd" target="_blank" rel="external">官方文档</a>)。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"npm"</span>, <span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="使用ENTRYPOINT-可选"><a href="#使用ENTRYPOINT-可选" class="headerlink" title="使用ENTRYPOINT (可选)"></a>使用ENTRYPOINT (可选)</h4><p>ENTRYPOINT指令并不是必须的，因为它会增加复杂度。ENTRYPOINT是一个脚本，它会默认执行，并且将指定的命令错误其参数。它通常用于构建可执行的Docker镜像。entrypoint.sh如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env sh</span></div><div class="line"><span class="comment"># $0 is a script name, </span></div><div class="line"><span class="comment"># $1, $2, $3 etc are passed arguments</span></div><div class="line"><span class="comment"># $1 is our command</span></div><div class="line">CMD=<span class="variable">$1</span></div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$CMD</span>"</span> <span class="keyword">in</span>  </div><div class="line">  <span class="string">"dev"</span> )</div><div class="line">    npm install</div><div class="line">    <span class="built_in">export</span> NODE_ENV=development</div><div class="line">    <span class="built_in">exec</span> npm run dev</div><div class="line">    ;;</div><div class="line"></div><div class="line">  <span class="string">"start"</span> )</div><div class="line">    <span class="comment"># we can modify files here, using ENV variables passed in </span></div><div class="line">    <span class="comment"># "docker create" command. It can't be done during build process.</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"db: <span class="variable">$DATABASE_ADDRESS</span>"</span> &gt;&gt; /app/config.yml</div><div class="line">    <span class="built_in">export</span> NODE_ENV=production</div><div class="line">    <span class="built_in">exec</span> npm start</div><div class="line">    ;;</div><div class="line"></div><div class="line">   * )</div><div class="line">    <span class="comment"># Run custom command. Thanks to this line we can still use </span></div><div class="line">    <span class="comment"># "docker run our_image /bin/bash" and it will work</span></div><div class="line">    <span class="built_in">exec</span> <span class="variable">$CMD</span> <span class="variable">$&#123;@:2&#125;</span></div><div class="line">    ;;</div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure>
<p>示例Dockerfile:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<p>可以使用如下命令运行该镜像:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 运行开发版本</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> our-app dev </span></div><div class="line"></div><div class="line"><span class="comment"># 运行生产版本</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> our-app start </span></div><div class="line"></div><div class="line"><span class="comment"># 运行bash</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> -it our-app /bin/bash</span></div></pre></td></tr></table></figure>
<h4 id="COPY与ADD优先使用前者"><a href="#COPY与ADD优先使用前者" class="headerlink" title="COPY与ADD优先使用前者"></a>COPY与ADD优先使用前者</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="合理调整COPY与RUN的顺序"><a href="#合理调整COPY与RUN的顺序" class="headerlink" title="合理调整COPY与RUN的顺序"></a>合理调整COPY与RUN的顺序</h4><p>我们应该把变化最少的部分放在Dockerfile的前面，这样可以充分利用镜像缓存。</p>
<p>示例中，源代码会经常变化，则每次构建镜像时都需要重新安装NPM模块，这显然不是我们希望看到的。因此我们可以先拷贝package.json，然后安装NPM模块，最后才拷贝其余的源代码。这样的话，即使源代码变化，也不需要重新安装NPM模块。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="设置默认的环境变量，映射端口和数据卷"><a href="#设置默认的环境变量，映射端口和数据卷" class="headerlink" title="设置默认的环境变量，映射端口和数据卷"></a>设置默认的环境变量，映射端口和数据卷</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">ENV</span> PROJECT_DIR=/app</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json <span class="variable">$PROJECT_DIR</span>  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> MEDIA_DIR=/media \  </div><div class="line">    NODE_ENV=production \</div><div class="line">    APP_PORT=<span class="number">3000</span></div><div class="line"></div><div class="line"><span class="keyword">VOLUME</span><span class="bash"> <span class="variable">$MEDIA_DIR</span>  </span></div><div class="line"><span class="keyword">EXPOSE</span> $APP_PORT</div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="添加HEALTHCHECK"><a href="#添加HEALTHCHECK" class="headerlink" title="添加HEALTHCHECK"></a>添加HEALTHCHECK</h4><p>运行容器时，可以指定–restart always选项。这样的话，容器崩溃时，Docker守护进程(docker daemon)会重启容器。对于需要长时间运行的容器，这个选项非常有用。但是，如果容器的确在运行，但是不可(陷入死循环，配置错误)用怎么办？使用HEALTHCHECK指令可以让Docker周期性的检查容器的健康状况。我们只需要指定一个命令，如果一切正常的话返回0，否则返回1。示例如下:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine  </div><div class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer <span class="string">"jakub.skalecki@example.com"</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> PROJECT_DIR=/app  </div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json <span class="variable">$PROJECT_DIR</span>  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> MEDIA_DIR=/media \  </div><div class="line">    NODE_ENV=production \</div><div class="line">    APP_PORT=<span class="number">3000</span></div><div class="line"></div><div class="line"><span class="keyword">VOLUME</span><span class="bash"> <span class="variable">$MEDIA_DIR</span>  </span></div><div class="line"><span class="keyword">EXPOSE</span> $APP_PORT  </div><div class="line"><span class="keyword">HEALTHCHECK</span><span class="bash"> CMD curl --fail http://localhost:<span class="variable">$APP_PORT</span> || <span class="built_in">exit</span> 1</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/18/记-给公司Unity组实现的数据库缓存类/" itemprop="url">
                  记_给公司Unity小组实现的基于Sqlite缓存Cache类
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-18T10:28:51+08:00" content="2019-04-18">
              2019-04-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/18/记-给公司Unity组实现的数据库缓存类/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/18/记-给公司Unity组实现的数据库缓存类/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><ol>
<li>所有线上接口管理至本地缓存</li>
<li>使用面向对象</li>
<li>db使用sqlite</li>
</ol>
<h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><p>线上拉取数据,缓存至本地,读取本地版本,对比线上版本号,如有更新,更新本地数据库数据,如没有,则读取本地.</p>
<h3 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h3><blockquote>
<p><code>IDbDao.cs</code> 接口定义</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.DbDao</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface IDbDao&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">void</span> setCache(<span class="built_in">string</span> r);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>CacheOption.cs</code> 实现</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Linq;</div><div class="line">using System.Text;</div><div class="line">using Assets.Scripts.Repository;</div><div class="line">using Assets.Scripts.Model;</div><div class="line">using Assets.Scripts.Infrastructure;</div><div class="line">using UnityEngine;</div><div class="line">using Newtonsoft.Json;</div><div class="line"></div><div class="line">namespace Assets.Scripts.DbDao</div><div class="line">&#123;</div><div class="line">    public <span class="keyword">class</span> CacheOption&lt;T&gt; : IDbDao&lt;T&gt; where T : <span class="keyword">class</span>, new()</div><div class="line">    &#123;</div><div class="line">        public void setCache_dbPath(string r, string path, bool is_append = false)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> repository = new RemoteRepository&lt;GetStruct&gt;();</div><div class="line">            repository.Get&lt;Response&lt;T&gt;&gt;(r, (response) =&gt;</div><div class="line">            &#123;</div><div class="line">                Debug.<span class="built_in">Log</span>(JsonConvert.SerializeObject(response));</div><div class="line">                <span class="keyword">if</span> (response.<span class="keyword">List</span> != null &amp;&amp; response.<span class="keyword">List</span>.<span class="keyword">Count</span> != 0)</div><div class="line">                &#123;</div><div class="line">                   </div><div class="line">                    <span class="keyword">var</span> <span class="keyword">db</span> = new DbRepository&lt;T&gt;();</div><div class="line">                    <span class="keyword">db</span>.CreateDb(path);</div><div class="line">                    <span class="keyword">if</span> (!is_append)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">db</span>.DropTable();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">db</span>.CreateTable();</div><div class="line">                    <span class="keyword">db</span>.InsertAll(response.<span class="keyword">List</span>);<span class="comment">//更新远程数据源</span></div><div class="line">                    <span class="keyword">db</span>.<span class="keyword">Close</span>();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                &#123;</div><div class="line">                    Debug.<span class="built_in">Log</span>(<span class="string">"Struct List data is null "</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//实现写入缓存共有类</span></div><div class="line">        public void setCache(string r)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> repository = new RemoteRepository&lt;GetStruct&gt;();</div><div class="line"></div><div class="line">            <span class="keyword">var</span> <span class="keyword">version</span> = new DbRepository&lt;TableVersions&gt;();</div><div class="line">            <span class="keyword">version</span>.DataService(<span class="string">"vesali.db"</span>);</div><div class="line">            <span class="keyword">version</span>.CreateTable();</div><div class="line">            TableVersions tv = <span class="keyword">version</span>.SelectOne&lt;TableVersions&gt;((tmpT) =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (tmpT.table_name == <span class="keyword">typeof</span>(T).Name)</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">return</span> true;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> false;</div><div class="line"></div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">var</span> struct_version = <span class="string">"-1"</span>;</div><div class="line">            <span class="keyword">if</span> (tv != null)</div><div class="line">            &#123;</div><div class="line">                struct_version = tv.<span class="keyword">version</span>;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            </div><div class="line">            repository.Get&lt;Response&lt;T&gt;&gt;(r, new GetStruct &#123; <span class="keyword">Version</span> = struct_version, device = SystemInfo.deviceUniqueIdentifier, os = Enum.GetName(<span class="keyword">typeof</span>(asset_platform), PublicClass.platform) , level = ((int)PublicClass.Quality).<span class="keyword">ToString</span>(), softVersion = PublicClass.get_version() &#125;, (response) =&gt;</div><div class="line">                       &#123;</div><div class="line">                           <span class="keyword">if</span> (response.<span class="keyword">List</span> != null &amp;&amp; response.<span class="keyword">List</span>.<span class="keyword">Count</span> != 0)</div><div class="line">                           &#123;</div><div class="line">                               Debug.<span class="built_in">Log</span>(<span class="string">"============读取数据库缓存更新，从远程拉取数据，更新版本号=================== "</span>);</div><div class="line">                               <span class="comment">//如果有数据,更新数据和版本</span></div><div class="line">                               <span class="keyword">if</span> (tv == null)</div><div class="line">                               &#123;</div><div class="line">                                   <span class="keyword">version</span>.Insert(new TableVersions &#123; table_name = <span class="keyword">typeof</span>(T).Name, <span class="keyword">version</span> = response.maxVersion &#125;);</div><div class="line">                               &#125;</div><div class="line">                               <span class="keyword">else</span></div><div class="line">                               &#123;</div><div class="line">                                   <span class="keyword">version</span>.<span class="keyword">Update</span>(new TableVersions &#123; table_name = <span class="keyword">typeof</span>(T).Name, <span class="keyword">version</span> = response.maxVersion &#125;);</div><div class="line">                               &#125;</div><div class="line">                               <span class="keyword">version</span>.<span class="keyword">Close</span>();</div><div class="line">                               <span class="keyword">var</span> <span class="keyword">db</span> = new DbRepository&lt;T&gt;();</div><div class="line">                               <span class="keyword">db</span>.DataService(<span class="string">"vesali.db"</span>);</div><div class="line">                               <span class="keyword">db</span>.DropTable();</div><div class="line">                               <span class="keyword">db</span>.CreateTable();</div><div class="line">                               <span class="keyword">db</span>.InsertAll(response.<span class="keyword">List</span>);<span class="comment">//更新远程数据源</span></div><div class="line">                               <span class="keyword">db</span>.<span class="keyword">Close</span>();</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">else</span></div><div class="line">                           &#123;</div><div class="line">                               Debug.<span class="built_in">Log</span>(<span class="string">"Struct List data is null "</span>);</div><div class="line">                               <span class="comment">// Debug.Log("============读取数据库缓存=================== ");</span></div><div class="line">                               <span class="comment">//读取数据库缓存</span></div><div class="line">                           &#125;</div><div class="line">                           PublicClass.data_list_count++;</div><div class="line">                       &#125;);</div><div class="line">            <span class="comment">//throw new NotImplementedException();</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>IRepository.cs</code> 对基本数据操作接口定义,如增删改查</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface IRepository&lt;T&gt; where T:<span class="keyword">class</span>,<span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">void</span> Insert(T instance);</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Delete</span><span class="params">(T instance)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Update</span><span class="params">(T instance)</span></span>;</div><div class="line">        IEnumerable&lt;T&gt; Select(Func&lt;T,<span class="keyword">bool</span>&gt; func );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p> <code>DbRepository.cs</code>数据库脚本实现</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.IO;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> SQLite4Unity3d;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> DbRepository&lt;T&gt; : IRepository&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="comment">//public delegate void DoConnection(String str);</span></div><div class="line">        <span class="keyword">private</span> SQLiteConnection _connection;</div><div class="line">        <span class="comment">//private string v;</span></div><div class="line"></div><div class="line">        <span class="comment">//public DbRepository(string v)</span></div><div class="line">        <span class="comment">//&#123;</span></div><div class="line">        <span class="comment">//    this.v = v;</span></div><div class="line">        <span class="comment">//&#125;</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateTable</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            _connection.CreateTable&lt;T&gt;();</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> TableQuery&lt;T&gt; getTableQuerry()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;();</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DropTable</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            _connection.DropTable&lt;T&gt;();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Delete</span><span class="params">(T instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Delete(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span><span class="params">(T instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Insert(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InsertAll</span><span class="params">(T[] instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.InsertAll(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InsertAll</span><span class="params">(List&lt;T&gt; instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.InsertAll(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> T SelectOne&lt;R&gt;(Func&lt;T, <span class="keyword">bool</span>&gt; func) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;().Where(func).FirstOrDefault();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> IEnumerable&lt;T&gt; Select&lt;R&gt;(Func&lt;T, <span class="keyword">bool</span>&gt; func) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;().Where(func);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span><span class="params">(T t)</span></span></div><div class="line">        &#123;</div><div class="line"></div><div class="line">            _connection.Update(t);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Close();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateDb</span><span class="params">(<span class="built_in">string</span> dbPath)</span></span></div><div class="line">        &#123;</div><div class="line">            _connection = <span class="keyword">new</span> SQLiteConnection(dbPath, SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DataService</span><span class="params">(<span class="built_in">string</span> DatabaseName)</span></span></div><div class="line">        &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></div><div class="line">            var dbPath = <span class="built_in">string</span>.Format(<span class="string">"&#123;0&#125;/&#123;1&#125;"</span>, PublicClass.vesal_db_path, DatabaseName); <span class="comment">//string.Format(@"Assets/StreamingAssets/&#123;0&#125;", DatabaseName);</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">        </div><div class="line"></div><div class="line">        var filepath = <span class="built_in">string</span>.Format(<span class="string">"&#123;0&#125;/&#123;1&#125;"</span>,PublicClass.vesal_db_path, DatabaseName);</div><div class="line"></div><div class="line">       </div><div class="line"></div><div class="line">        var dbPath = filepath;</div><div class="line">        <span class="comment">// var dbPath = loadDb;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">            _connection = <span class="keyword">new</span> SQLiteConnection(dbPath, SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create);</div><div class="line">            <span class="comment">//DebugLog.DebugLogInfo("Final PATH: " + dbPath);</span></div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> IEnumerable&lt;T&gt; Select(Func&lt;T, <span class="keyword">bool</span>&gt; func)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>RemoteRepository.cs</code> 接口类实现</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> Assets.Scripts.Infrastructure;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> Assets.Scripts.Network;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> Newtonsoft.Json;</div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> RemoteRepository&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> ISerializer Serializer &#123; <span class="built_in">get</span>; set; &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> RemoteRepository(ISerializer serializer = null)</div><div class="line">        &#123;</div><div class="line">            Serializer = serializer ?? SerializerJson.Instance;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Get&lt;R&gt;(<span class="keyword">string</span> url, T instance, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            var parameters = HttpUtility.BuildParameters(instance, <span class="keyword">new</span> StringBuilder(<span class="string">"?"</span>));</div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Get,</div><div class="line">                Parameters = parameters</div><div class="line">            &#125;;</div><div class="line">            Debug.Log(httpRequest.Url + httpRequest.Parameters);</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    R r = JsonConvert.DeserializeObject&lt;R&gt;(httpResponse.Data);</div><div class="line">                    onSuccess(r);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//<span class="doctag">TODO:</span>异常处理</span></div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Get&lt;R&gt;(<span class="keyword">string</span> url, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// var parameters = HttpUtility.BuildParameters(instance, new StringBuilder("?"));</span></div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Get,</div><div class="line">                <span class="comment">// Parameters = parameters</span></div><div class="line">            &#125;;</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    R r = JsonConvert.DeserializeObject&lt;R&gt;(httpResponse.Data);</div><div class="line">                    Debug.Log(<span class="string">"json str :"</span> + r);</div><div class="line">                    onSuccess(r);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//<span class="doctag">TODO:</span>异常处理</span></div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Post&lt;R&gt;(<span class="keyword">string</span> url, T instance, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            var parameters = HttpUtility.BuildParameters(instance, <span class="keyword">new</span> StringBuilder());</div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Post,</div><div class="line">                Parameters = parameters</div><div class="line">            &#125;;</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    <span class="comment">//<span class="doctag">TODO:</span>判断是否有Data</span></div><div class="line">                    onSuccess(Serializer.Deserialize&lt;R&gt;(httpResponse.Data));</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Test()</div><div class="line">        &#123;</div><div class="line">            Debug.Log(<span class="string">"Hello..."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>Response.cs</code></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    [System.Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> Response&lt;T&gt;</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> msg;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> code;</div><div class="line">        <span class="keyword">public</span> List&lt;T&gt; List;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> maxVersion;</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>HttpUtility.cs</code> http操作类</p>
</blockquote>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line">namespace Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtility</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> string BuildParameters&lt;T&gt;(T instance, StringBuilder sb) where T:<span class="type">class</span>,<span class="keyword">new</span><span class="type"></span>()</div><div class="line">        &#123;</div><div class="line">            foreach (<span class="keyword">var</span> property <span class="keyword">in</span> instance.GetType().GetProperties())</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">var</span> propertyName = property.Name;</div><div class="line">                <span class="keyword">var</span> value = property.GetValue(instance, <span class="literal">null</span>);</div><div class="line">                sb.Append(propertyName + <span class="string">"="</span> + value + <span class="string">"&amp;"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> sb.ToString().TrimEnd(<span class="string">'&amp;'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>ISerializer.cs</code> 格式化接口 </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface ISerializer</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">string</span> Serialize&lt;T&gt;(T obj, <span class="keyword">bool</span> readableOutput = <span class="literal">false</span>) where T : <span class="keyword">class</span>, <span class="keyword">new</span>();</div><div class="line">        T Deserialize&lt;T&gt;(<span class="built_in">string</span> json) where T : <span class="keyword">class</span>, <span class="keyword">new</span>();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>SerializerJson.cs</code> </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> SerializerJson:ISerializer</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> readonly SerializerJson Instance=<span class="keyword">new</span> SerializerJson();</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">SerializerJson</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Serialize&lt;T&gt;(T obj, <span class="keyword">bool</span> readableOutput = <span class="literal">false</span>) where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> T Deserialize&lt;T&gt;(<span class="built_in">string</span> json) where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> JsonUtility.FromJson&lt;T&gt;(json);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>SQLite.cs</code></p>
</blockquote>
<p><a href="https://gist.github.com/peterfei/69f98addc648163cd61ca63b9f53ef68" target="_blank" rel="external">查看源码</a></p>
<blockquote>
<p><code>HttpMethod.cs</code></p>
</blockquote>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Linq;</div><div class="line">using System.Text;</div><div class="line"></div><div class="line">namespace Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    public <span class="class"><span class="keyword">enum</span> <span class="title">HttpMethod</span></span></div><div class="line">    &#123;</div><div class="line">        Get,</div><div class="line">        Post</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Model实例"><a href="#Model实例" class="headerlink" title="Model实例"></a>Model实例</h3><blockquote>
<p><code>TableVersions.cs</code></p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> SQLite4Unity3d;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Assets.Scripts.Model</span></div><div class="line">&#123;</div><div class="line">    [Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TableVersions</span></div><div class="line">    &#123;</div><div class="line">        [PrimaryKey]</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> table_name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> version &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">       </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>GetStruct.cs</code> </p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Assets.Scripts.Model</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">class</span> <span class="title">GetStruct</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Version &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> UpdateUrlUuid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> device &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> os &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> level &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> softVersion &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> cache_CommonLib = <span class="keyword">new</span> <span class="type">CacheOption</span>&lt;GetStruct&gt;();</div><div class="line">cache_CommonLib.setCache(PublicClass.server_ip+<span class="string">'v1/app/api'</span>)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/17/docker笔记01/" itemprop="url">
                  docker笔记01
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-17T18:16:56+08:00" content="2019-04-17">
              2019-04-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/17/docker笔记01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/17/docker笔记01/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h3><p>Mac 上的安装<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">brew </span>cask <span class="keyword">install </span>docker</div></pre></td></tr></table></figure></p>
<p>安装完成之后，执行 hello-world 试一下:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker <span class="keyword">run</span><span class="bash"> hello-world</span></div></pre></td></tr></table></figure>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Hello <span class="built_in">from</span> Docker!</div><div class="line">This message shows that your installation appears <span class="built_in">to</span> be working correctly.</div><div class="line"></div><div class="line">To generate this message, Docker took <span class="keyword">the</span> following steps:</div><div class="line"> <span class="number">1.</span> The Docker client contacted <span class="keyword">the</span> Docker daemon.</div><div class="line"> <span class="number">2.</span> The Docker daemon pulled <span class="keyword">the</span> <span class="string">"hello-world"</span> image <span class="built_in">from</span> <span class="keyword">the</span> Docker Hub.</div><div class="line">    (amd64)</div><div class="line"> <span class="number">3.</span> The Docker daemon created <span class="keyword">a</span> <span class="built_in">new</span> container <span class="built_in">from</span> that image which runs <span class="keyword">the</span></div><div class="line">    executable that produces <span class="keyword">the</span> output you are currently reading.</div><div class="line"> <span class="number">4.</span> The Docker daemon streamed that output <span class="built_in">to</span> <span class="keyword">the</span> Docker client, which sent <span class="keyword">it</span></div><div class="line">    <span class="built_in">to</span> your terminal.</div><div class="line"></div><div class="line">To <span class="keyword">try</span> something more ambitious, you can run <span class="keyword">an</span> Ubuntu container <span class="keyword">with</span>:</div><div class="line"> $ docker run -<span class="keyword">it</span> ubuntu bash</div><div class="line"></div><div class="line">Share images, automate workflows, <span class="keyword">and</span> more <span class="keyword">with</span> <span class="keyword">a</span> free Docker ID:</div><div class="line"> <span class="keyword">https</span>://hub.docker.com/</div><div class="line"></div><div class="line">For more examples <span class="keyword">and</span> ideas, visit:</div><div class="line"> <span class="keyword">https</span>://docs.docker.com/<span class="built_in">get</span>-started/</div></pre></td></tr></table></figure>
<h3 id="启动Nginx服务"><a href="#启动Nginx服务" class="headerlink" title="启动Nginx服务"></a>启动Nginx服务</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">run</span><span class="bash"> <span class="_">-d</span> -p 80:80 --restart=always  nginx:latest</span></div></pre></td></tr></table></figure>
<blockquote>
<p><code>-p</code> 表示宿主机IP:容器IP<br><code>--restart</code> 重启模式，设置 always，每次启动 docker 都会启动 nginx 容器</p>
</blockquote>
<h3 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker exec -<span class="keyword">it</span> <span class="number">4591552</span>a4185 bash</div></pre></td></tr></table></figure>
<p>参数说明：</p>
<blockquote>
<p><code>exec</code> 对容器操作<br><code>-it</code> 分配伪tty<br><code>4591552a4185</code>容器ID<br><code>bash</code>交互程序为bash</p>
</blockquote>
<p>Docker 提供数据挂载的功能，即可以指定容器内的某些路径映射到宿主机器上，修改命令，添加 -v 参数，启动新的容器。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p <span class="number">80</span>:<span class="number">80</span>  -v <span class="regexp">~/docker-demo/</span>nginx-<span class="string">htmls:</span><span class="regexp">/usr/</span>share<span class="regexp">/nginx/</span>html/ --restart=always  <span class="string">nginx:</span>latest</div></pre></td></tr></table></figure>
<blockquote>
<p>启动成功之后，docker 会帮你生成目录 ~/docker-demo/nginx-htmls</p>
</blockquote>
<h3 id="停止运行"><a href="#停止运行" class="headerlink" title="停止运行"></a>停止运行</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">stop</span> <span class="number">4591552</span>a4185</div></pre></td></tr></table></figure>
<h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker rm <span class="number">4591552</span>a4185</div></pre></td></tr></table></figure>
<h3 id="分配IP给宿主机"><a href="#分配IP给宿主机" class="headerlink" title="分配IP给宿主机"></a>分配IP给宿主机</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ifconfig lo0 alias <span class="number">192.168</span><span class="number">.64</span><span class="number">.0</span>/<span class="number">24</span></div></pre></td></tr></table></figure>
<p>访问 <code>http://192.168.64.0:8080</code> </p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/11/ReactNative之Realm预加载数据/" itemprop="url">
                  ReactNative之Realm预加载数据
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-11T11:28:51+08:00" content="2019-04-11">
              2019-04-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/11/ReactNative之Realm预加载数据/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/11/ReactNative之Realm预加载数据/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>realm 数据预加载</p>
</blockquote>
<h5 id="Require-Env"><a href="#Require-Env" class="headerlink" title="Require Env:"></a>Require Env:</h5><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">npm</span> i realm</div><div class="line"><span class="built_in">npm</span> i react-<span class="keyword">native</span>-fs</div><div class="line">react-<span class="keyword">native</span> link</div></pre></td></tr></table></figure>
<p>分别拷贝数据库至原生公用目录</p>
<h5 id="Android端"><a href="#Android端" class="headerlink" title="Android端"></a>Android端</h5><p><code>android/app/src/main/assets/demo.realm</code></p>
<h5 id="IOS端"><a href="#IOS端" class="headerlink" title="IOS端"></a>IOS端</h5><p><code>Build Phases-&gt;Copy Bundle Resources-&gt;demo.realm</code></p>
<h5 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h5><p>执行Realm 提供的copyBundledRealmFiles,可以将共用的数据库文件拷贝至应用安装的<code>Documents</code>目录.</p>
<blockquote>
<p><code>Realm.copyBundledRealmFiles();</code></p>
</blockquote>
<h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><h5 id="prepare-realm-data-demo"><a href="#prepare-realm-data-demo" class="headerlink" title="prepare-realm-data-demo"></a><a href="https://github.com/peterfei/prepare-realm-data-demo" target="_blank" rel="external">prepare-realm-data-demo</a></h5>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://ruby-china-files.b0.upaiyun.com/user/big_avatar/5575.jpg"
               alt="peterfei" />
          <p class="site-author-name" itemprop="name">peterfei</p>
          <p class="site-description motion-element" itemprop="description">peterfei|技术|上主是我的牧者</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">73</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/peterfei" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">peterfei</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"peterfei"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  


</body>
</html>
