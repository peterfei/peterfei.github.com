<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="peterfei.me,peterfei" />





  <link rel="alternate" href="/atom.xml" title="Peterfei" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.0" />






<meta name="description" content="peterfei|技术|上主是我的牧者">
<meta property="og:type" content="website">
<meta property="og:title" content="Peterfei">
<meta property="og:url" content="http://peterfei.me/page/3/index.html">
<meta property="og:site_name" content="Peterfei">
<meta property="og:description" content="peterfei|技术|上主是我的牧者">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Peterfei">
<meta name="twitter:description" content="peterfei|技术|上主是我的牧者">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: '[object Object]',
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Peterfei </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Peterfei</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">上主是我的牧者，我实在一无所缺</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'PqEYgqEwUwFoXjgtngj9','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/03/16/k8s-部署和gitlab-CI-CD/" itemprop="url">
                  k8s 部署和gitlab CI/CD
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2021-03-16T16:01:03+08:00" content="2021-03-16">
              2021-03-16
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2021/03/16/k8s-部署和gitlab-CI-CD/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/03/16/k8s-部署和gitlab-CI-CD/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="1-安装必备软件"><a href="#1-安装必备软件" class="headerlink" title="1. 安装必备软件"></a>1. 安装必备软件</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y wget vim net-tools epel-<span class="keyword">release</span></div></pre></td></tr></table></figure>
<h4 id="2-关闭swap"><a href="#2-关闭swap" class="headerlink" title="2. 关闭swap"></a>2. 关闭swap</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">swapoff -a</div><div class="line"></div><div class="line"><span class="comment"># 永久禁用，打开/etc/fstab注释掉swap那一行。</span></div><div class="line">sed -i <span class="string">'s/.*swap.*/#&amp;/'</span> <span class="regexp">/etc/</span>fstab</div></pre></td></tr></table></figure>
<h4 id="3-关闭selinux"><a href="#3-关闭selinux" class="headerlink" title="3. 关闭selinux"></a>3. 关闭selinux</h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 临时禁用selinux</span></div><div class="line">setenforce <span class="number">0</span></div><div class="line"><span class="meta"># 永久关闭 修改/etc/sysconfig/selinux文件设置</span></div><div class="line">sed -i <span class="string">'s/SELINUX=permissive/SELINUX=disabled/'</span> /etc/sysconfig/selinux</div><div class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</div></pre></td></tr></table></figure>
<h3 id="4-关闭防火墙"><a href="#4-关闭防火墙" class="headerlink" title="4. 关闭防火墙"></a>4. 关闭防火墙</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl <span class="keyword">disable</span> firewalld</div><div class="line">systemctl <span class="keyword">stop</span> firewalld</div></pre></td></tr></table></figure>
<h2 id="安装Docker和配置代理"><a href="#安装Docker和配置代理" class="headerlink" title="安装Docker和配置代理"></a>安装Docker和配置代理</h2><h3 id="1-配置yum源"><a href="#1-配置yum源" class="headerlink" title="1. 配置yum源"></a>1. 配置yum源</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">## 配置默认源</div><div class="line">## 备份</div><div class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</div><div class="line"></div><div class="line">## 下载阿里源</div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http:<span class="comment">//mirrors.aliyun.com/repo/Centos-7.repo</span></div><div class="line"></div><div class="line">## 刷新</div><div class="line">yum makecache fast</div><div class="line"></div><div class="line">## 配置k8s源</div><div class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</div><div class="line">[kubernetes]</div><div class="line">name=Kubernetes</div><div class="line">baseurl=https:<span class="comment">//mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></div><div class="line">enabled=<span class="number">1</span></div><div class="line">gpgcheck=<span class="number">0</span></div><div class="line">EOF</div><div class="line"></div><div class="line">## 重建yum缓存</div><div class="line">yum clean all</div><div class="line">yum makecache fast</div><div class="line">yum -y update</div></pre></td></tr></table></figure>
<h3 id="2-安装docker"><a href="#2-安装docker" class="headerlink" title="2. 安装docker"></a>2. 安装docker</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">yum -y <span class="keyword">install</span> yum-utils device-mapper-persistent-<span class="keyword">data</span> lvm2</div><div class="line">yum-config-manager <span class="comment">--add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></div><div class="line">yum -y <span class="keyword">install</span>  docker-ce<span class="number">-20.10</span><span class="number">.5</span> </div><div class="line">systemctl <span class="keyword">enable</span> docker</div><div class="line">systemctl <span class="keyword">start</span> docker</div></pre></td></tr></table></figure>
<h3 id="3-确保kubelet使用的cgroup-driver-与-Docker的一致"><a href="#3-确保kubelet使用的cgroup-driver-与-Docker的一致" class="headerlink" title="3. 确保kubelet使用的cgroup driver 与 Docker的一致"></a>3. 确保kubelet使用的cgroup driver 与 Docker的一致</h3><figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;<span class="symbol">EOF</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</div><div class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</div><div class="line">  <span class="string">"log-opts"</span>: &#123;</div><div class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>,</div><div class="line">  <span class="string">"storage-opts"</span>: [</div><div class="line">    <span class="string">"overlay2.override_kernel_check=true"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://ifa4ye2m.mirror.aliyuncs.com"</span>]</div><div class="line">&#125;</div><div class="line"><span class="symbol">EOF</span></div><div class="line"></div><div class="line">sudo systemctl daemon-reload sudo systemctl restart docker</div></pre></td></tr></table></figure>
<h3 id="4-从国内仓库拉取镜像（核心步骤-如果没有代理）"><a href="#4-从国内仓库拉取镜像（核心步骤-如果没有代理）" class="headerlink" title="4. 从国内仓库拉取镜像（核心步骤-如果没有代理）"></a>4. 从国内仓库拉取镜像（核心步骤-如果没有代理）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">images=(</div><div class="line">kube-apiserver:v1.18.16</div><div class="line">kube-controller-manager:v1.18.16</div><div class="line">kube-scheduler:v1.18.16</div><div class="line">kube-proxy:v1.18.16</div><div class="line">pause:3.2</div><div class="line">etcd:3.4.3-0</div><div class="line">coredns:1.6.7</div><div class="line">kubernetes-dashboard-amd64:v1.10.1</div><div class="line">)</div><div class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span>;<span class="keyword">do</span></div><div class="line">        docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></div><div class="line">        docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<h2 id="开始安装k8s"><a href="#开始安装k8s" class="headerlink" title="开始安装k8s"></a>开始安装k8s</h2><h3 id="1-安装kubeadm，kubelet等"><a href="#1-安装kubeadm，kubelet等" class="headerlink" title="1. 安装kubeadm，kubelet等"></a>1. 安装kubeadm，kubelet等</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">yum</span> <span class="selector-tag">install</span> <span class="selector-tag">kubelet-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span> <span class="selector-tag">kubeadm-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span> <span class="selector-tag">kubectl-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span> <span class="selector-tag">kubernetes-cni-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span></div></pre></td></tr></table></figure>
<h3 id="2-集群初始化"><a href="#2-集群初始化" class="headerlink" title="2. 集群初始化"></a>2. 集群初始化</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">## master节点执行：</div><div class="line">sudo kubeadm init \</div><div class="line"> --apiserver-advertise-address <span class="number">10.1</span><span class="number">.69</span><span class="number">.101</span> \</div><div class="line"> --kubernetes-version=v1<span class="number">.15</span><span class="number">.0</span> \</div><div class="line"> --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">如果外网：</div><div class="line"></div><div class="line">kubeadm init --apiserver-advertise-address xx.xx<span class="number">.255</span><span class="number">.84</span> --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> --kubernetes-version=v1<span class="number">.18</span><span class="number">.0</span></div></pre></td></tr></table></figure>
<p>得到回复：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">(...省略)</div><div class="line"><span class="keyword">mkdir</span> -p <span class="variable">$HOME</span>/.kube</div><div class="line">sudo cp -i /etc/kubernetes/admin.<span class="keyword">conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -<span class="keyword">u</span>):$(id -<span class="keyword">g</span>) <span class="variable">$HOME</span>/.kube/config</div><div class="line"></div><div class="line">## 保存好该命令，丢了不好找回。节点加入时需要</div><div class="line">kubeadm join 10.1.69.101:6443 --<span class="keyword">token</span> ou5pvo.qseafc4s8licblzy \</div><div class="line">    --discovery-<span class="keyword">token</span>-<span class="keyword">ca</span>-cert-hash sha256:de9c10f11c50c074f212698b9d514fc12a9c1c4ffe70961aff89ac5e585f0663</div></pre></td></tr></table></figure>
<h3 id="3-拷贝配置，给kubectl使用"><a href="#3-拷贝配置，给kubectl使用" class="headerlink" title="3. 拷贝配置，给kubectl使用"></a>3. 拷贝配置，给kubectl使用</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir -<span class="selector-tag">p</span> <span class="variable">$HOME</span>/<span class="selector-class">.kube</span></div><div class="line">sudo cp -<span class="selector-tag">i</span> /etc/kubernetes/admin<span class="selector-class">.conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</div></pre></td></tr></table></figure>
<h3 id="4-安装flannel网络"><a href="#4-安装flannel网络" class="headerlink" title="4. 安装flannel网络"></a>4. 安装flannel网络</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo kubectl apply -<span class="keyword">f</span> http<span class="variable">s:</span>//raw.githubusercontent.<span class="keyword">com</span>/coreos/flannel/master/Documentation/kube-flannel.yml</div><div class="line"></div><div class="line">## 查看flannal是否安装成功</div><div class="line"></div><div class="line">sudo kubectl -n kube-<span class="built_in">system</span> <span class="built_in">get</span> <span class="keyword">po</span> -<span class="keyword">l</span> app=flannel -<span class="keyword">o</span> wide</div></pre></td></tr></table></figure>
<h2 id="5-node节点加入集群"><a href="#5-node节点加入集群" class="headerlink" title="5. node节点加入集群"></a>5. node节点加入集群</h2><p>其他节点执行：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">kubeadm</span> <span class="selector-tag">join</span> 10<span class="selector-class">.1</span><span class="selector-class">.69</span><span class="selector-class">.101</span><span class="selector-pseudo">:6443</span> <span class="selector-tag">--token</span> <span class="selector-tag">ou5pvo</span><span class="selector-class">.qseafc4s8licblzy</span> \</div><div class="line">    <span class="selector-tag">--discovery-token-ca-cert-hash</span> <span class="selector-tag">sha256</span><span class="selector-pseudo">:de9c10f11c50c074f212698b9d514fc12a9c1c4ffe70961aff89ac5e585f0663</span></div></pre></td></tr></table></figure>
<h2 id="清理安装"><a href="#清理安装" class="headerlink" title="清理安装"></a>清理安装</h2><ul>
<li>如果安装过程中出任何问题，可以重置后重新安装</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">sudo kubeadm reset</span></div></pre></td></tr></table></figure>
<h3 id="安装-helm-和-gitlab-runner"><a href="#安装-helm-和-gitlab-runner" class="headerlink" title="安装 helm 和 gitlab-runner"></a>安装 helm 和 gitlab-runner</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tar -zxvf helm-v2.<span class="number">12.1</span>-linux-amd64<span class="selector-class">.tar</span><span class="selector-class">.gz</span></div><div class="line">cd linux-amd64/</div><div class="line"></div><div class="line">cp helm /usr/local/bin</div></pre></td></tr></table></figure>
<p><code>cat tiller.yaml</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> apps/v1</div><div class="line"><span class="attr">kind:</span> Deployment</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> helm</div><div class="line"><span class="attr">    name:</span> tiller</div><div class="line"><span class="attr">  name:</span> tiller-deploy</div><div class="line"><span class="attr">  namespace:</span> kube-system</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">1</span></div><div class="line"><span class="attr">  strategy:</span> &#123;&#125;</div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      name:</span> tiller</div><div class="line"><span class="attr">      app:</span> helm</div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> helm</div><div class="line"><span class="attr">        name:</span> tiller</div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      automountServiceAccountToken:</span> <span class="literal">true</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - env:</span></div><div class="line"><span class="attr">        - name:</span> TILLER_NAMESPACE</div><div class="line"><span class="attr">          value:</span> kube-system</div><div class="line"><span class="attr">        - name:</span> TILLER_HISTORY_MAX</div><div class="line"><span class="attr">          value:</span> <span class="string">"0"</span></div><div class="line"><span class="attr">        image:</span> registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2<span class="number">.14</span><span class="number">.3</span></div><div class="line"><span class="attr">        imagePullPolicy:</span> IfNotPresent</div><div class="line"><span class="attr">        livenessProbe:</span></div><div class="line"><span class="attr">          httpGet:</span></div><div class="line"><span class="attr">            path:</span> /liveness</div><div class="line"><span class="attr">            port:</span> <span class="number">44135</span></div><div class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">        name:</span> tiller</div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - containerPort:</span> <span class="number">44134</span></div><div class="line"><span class="attr">          name:</span> tiller</div><div class="line"><span class="attr">        - containerPort:</span> <span class="number">44135</span></div><div class="line"><span class="attr">          name:</span> http</div><div class="line"><span class="attr">        readinessProbe:</span></div><div class="line"><span class="attr">          httpGet:</span></div><div class="line"><span class="attr">            path:</span> /readiness</div><div class="line"><span class="attr">            port:</span> <span class="number">44135</span></div><div class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">        resources:</span> &#123;&#125;</div><div class="line"><span class="attr">      serviceAccountName:</span> tiller</div><div class="line"><span class="attr">status:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> Service</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> helm</div><div class="line"><span class="attr">    name:</span> tiller</div><div class="line"><span class="attr">  name:</span> tiller-deploy</div><div class="line"><span class="attr">  namespace:</span> kube-system</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">  - name:</span> tiller</div><div class="line"><span class="attr">    port:</span> <span class="number">44134</span></div><div class="line"><span class="attr">    targetPort:</span> tiller</div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    app:</span> helm</div><div class="line"><span class="attr">    name:</span> tiller</div><div class="line"><span class="attr">  type:</span> ClusterIP</div><div class="line"><span class="attr">status:</span></div><div class="line"><span class="attr">  loadBalancer:</span> &#123;&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">kubectl apply -<span class="keyword">f</span> tiller.yaml</div><div class="line">helm init --upgrade --stable-repo-url http<span class="variable">s:</span>//kubernetes.oss-<span class="keyword">cn</span>-hangzhou.aliyuncs.<span class="keyword">com</span>/charts</div><div class="line"></div><div class="line">#helm init -i registry.<span class="keyword">cn</span>-hangzhou.aliyuncs.<span class="keyword">com</span>/google_containers/tiller:v2.<span class="number">14.3</span> --stable-repo-url http://mirror.azure.<span class="keyword">cn</span>/kubernetes/charts/ --service-account tiller --override spec.selector.matchLabels.<span class="string">'name'</span>=<span class="string">'tiller'</span>,spec.selector.matchLabels.<span class="string">'app'</span>=<span class="string">'helm'</span> --output yaml | sed <span class="string">'s@apiVersion: extensions/v1beta1@apiVersion: apps/v1@'</span> | kubectl <span class="keyword">delete</span> -<span class="keyword">f</span> -</div><div class="line"> </div><div class="line"> kubectl create serviceaccount --namespace kube-<span class="built_in">system</span> tiller</div><div class="line"> kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-<span class="built_in">system</span>:tiller</div><div class="line"> kubectl patch deploy --namespace kube-<span class="built_in">system</span> tiller-deploy -<span class="keyword">p</span> <span class="string">'&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;'</span></div><div class="line"></div><div class="line"></div><div class="line"> kubectl <span class="built_in">get</span> <span class="keyword">po</span>  -A|<span class="keyword">grep</span> tiller</div><div class="line"> kubectl patch deploy --namespace kube-<span class="built_in">system</span> tiller-deploy -<span class="keyword">p</span> <span class="string">'&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;'</span></div><div class="line"></div><div class="line"> helm repo <span class="built_in">add</span> gitlab http<span class="variable">s:</span>//charts.gitlab.io</div><div class="line"> helm repo <span class="keyword">update</span></div><div class="line"> helm fetch gitlab/gitlab-runner --<span class="keyword">version</span> <span class="string">"v0.10.0-rc1"</span></div><div class="line"> </div><div class="line"> kubectl create namespace gitlab-runners</div><div class="line"> <span class="built_in">mkdir</span> -<span class="keyword">p</span> gitlab-runner</div><div class="line"> <span class="keyword">cd</span> gitlab-runner/</div><div class="line"> kubectl create -<span class="keyword">f</span> rbac-runner-config.yaml</div></pre></td></tr></table></figure>
<p>cat rbac-runner-config.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> ServiceAccount</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">kind:</span> Role</div><div class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">rules:</span></div><div class="line"><span class="attr">- apiGroups:</span> [<span class="string">""</span>] <span class="comment">#"" indicates the core API group</span></div><div class="line"><span class="attr">  resources:</span> [<span class="string">"*"</span>]</div><div class="line"><span class="attr">  verbs:</span> [<span class="string">"*"</span>]</div><div class="line"><span class="attr">- apiGroups:</span> [<span class="string">"apps"</span>]</div><div class="line"><span class="attr">  resources:</span> [<span class="string">"deployments"</span>]</div><div class="line"><span class="attr">  verbs:</span> [<span class="string">"*"</span>]</div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">kind:</span> RoleBinding</div><div class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">subjects:</span></div><div class="line"><span class="attr">- kind:</span> ServiceAccount</div><div class="line"><span class="attr">  name:</span> gitlab <span class="comment"># Name is case sensitive</span></div><div class="line"><span class="attr">  apiGroup:</span> <span class="string">""</span></div><div class="line"><span class="attr">roleRef:</span></div><div class="line"><span class="attr">  kind:</span> Role <span class="comment">#this must be Role or ClusterRole</span></div><div class="line"><span class="attr">  name:</span> gitlab <span class="comment"># this must match the name of the Role or ClusterRole you wish to bind to</span></div><div class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</div></pre></td></tr></table></figure>
<blockquote>
<p> <code>cat  values-spm-operation-frontend.yaml</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## GitLab Runner Image</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## By default it's using gitlab/gitlab-runner:alpine-v&#123;VERSION&#125;</span></div><div class="line"><span class="comment">## where &#123;VERSION&#125; is taken from Chart.yaml from appVersion field</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## ref: https://hub.docker.com/r/gitlab/gitlab-runner/tags/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># image: gitlab/gitlab-runner:alpine-v11.6.0</span></div><div class="line"></div><div class="line"><span class="comment">## Specify a imagePullPolicy</span></div><div class="line"><span class="comment">## 'Always' if imageTag is 'latest', else set to 'IfNotPresent'</span></div><div class="line"><span class="comment">## ref: http://kubernetes.io/docs/user-guide/images/#pre-pulling-images</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">imagePullPolicy:</span> IfNotPresent</div><div class="line"><span class="attr">gitlabUrl:</span> http://xxx.xxx.cn/</div><div class="line"><span class="attr">runnerRegistrationToken:</span> <span class="string">"-Rxxz6Cqdk33Q96mRdxk"</span></div><div class="line"></div><div class="line"><span class="comment">## 和之前配置的 rbac name 对应</span></div><div class="line"></div><div class="line"><span class="comment">## 指定关联 runner 的标签</span></div><div class="line"><span class="attr">tags:</span> <span class="string">" operations"</span></div><div class="line"></div><div class="line"><span class="attr">privileged:</span> <span class="literal">true</span></div><div class="line"><span class="attr">serviceAccountName:</span> gitlab</div><div class="line"><span class="comment">## The GitLab Server URL (with protocol) that want to register the runner against</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/commands/README.html#gitlab-runner-register</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># gitlabUrl: http://gitlab.your-domain.com/</span></div><div class="line"></div><div class="line"><span class="comment">## The Registration Token for adding new Runners to the GitLab Server. This must</span></div><div class="line"><span class="comment">## be retrieved from your GitLab Instance.</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/ce/ci/runners/README.html</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># runnerRegistrationToken: ""</span></div><div class="line"></div><div class="line"><span class="comment">## The Runner Token for adding new Runners to the GitLab Server. This must</span></div><div class="line"><span class="comment">## be retrieved from your GitLab Instance. It is token of already registered runner.</span></div><div class="line"><span class="comment">## ref: (we don't yet have docs for that, but we want to use existing token)</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># runnerToken: ""</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Unregister all runners before termination</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## Updating the runner's chart version or configuration will cause the runner container</span></div><div class="line"><span class="comment">## to be terminated and created again. This may cause your Gitlab instance to reference</span></div><div class="line"><span class="comment">## non-existant runners. Un-registering the runner before termination mitigates this issue.</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/commands/README.html#gitlab-runner-unregister</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">unregisterRunners:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">## When stopping ther runner, give it time to wait for it's jobs to terminate.</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## Updating the runner's chart version or configuration will cause the runner container</span></div><div class="line"><span class="comment">## to be terminated with a graceful stop request. terminationGracePeriodSeconds</span></div><div class="line"><span class="comment">## instructs Kubernetes to wait long enough for the runner pod to terminate gracefully.</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/commands/#signals</span></div><div class="line"><span class="attr">terminationGracePeriodSeconds:</span> <span class="number">3600</span></div><div class="line"></div><div class="line"><span class="comment">## Set the certsSecretName in order to pass custom certficates for GitLab Runner to use</span></div><div class="line"><span class="comment">## Provide resource name for a Kubernetes Secret Object in the same namespace,</span></div><div class="line"><span class="comment">## this is used to populate the /home/gitlab-runner/.gitlab-runner/certs/ directory</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># certsSecretName:</span></div><div class="line"></div><div class="line"><span class="comment">## Configure the maximum number of concurrent jobs</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">concurrent:</span> <span class="number">10</span></div><div class="line"></div><div class="line"><span class="comment">## Defines in seconds how often to check GitLab for a new builds</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">checkInterval:</span> <span class="number">30</span></div><div class="line"><span class="attr">limitLine:</span> <span class="number">100000</span></div><div class="line"><span class="comment">## Configure GitLab Runner's logging level. Available values are: debug, info, warn, error, fatal, panic</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># logLevel:</span></div><div class="line"></div><div class="line"><span class="comment">## Configure GitLab Runner's logging format. Available values are: runner, text, json</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># logFormat:</span></div><div class="line"></div><div class="line"><span class="comment">## For RBAC support:</span></div><div class="line"><span class="attr">rbac:</span></div><div class="line"><span class="attr">  create:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  serviceAccountName:</span> gitlab</div><div class="line">  <span class="comment">## Define specific rbac permissions.</span></div><div class="line">  <span class="comment"># resources: ["pods", "pods/exec", "secrets"]</span></div><div class="line">  <span class="comment"># verbs: ["get", "list", "watch", "create", "patch", "delete"]</span></div><div class="line"></div><div class="line">  <span class="comment">## Run the gitlab-bastion container with the ability to deploy/manage containers of jobs</span></div><div class="line">  <span class="comment">## cluster-wide or only within namespace</span></div><div class="line"><span class="attr">  clusterWideAccess:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">  <span class="comment">## Use the following Kubernetes Service Account name if RBAC is disabled in this Helm chart (see rbac.create)</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># serviceAccountName: default</span></div><div class="line"></div><div class="line"><span class="comment">## Configure integrated Prometheus metrics exporter</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/monitoring/#configuration-of-the-metrics-http-server</span></div><div class="line"><span class="attr">metrics:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">## Configuration for the Pods that that the runner launches for each new job</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">runners:</span></div><div class="line">  <span class="comment">## Default container image to use for builds when none is specified</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  image:</span> ubuntu:<span class="number">16.04</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify one or more imagePullSecrets</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># imagePullSecrets: []</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify the image pull policy: never, if-not-present, always. The cluster default will be used if not set.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># imagePullPolicy: ""</span></div><div class="line"></div><div class="line">  <span class="comment">## Defines number of concurrent requests for new job from GitLab</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># requestConcurrency: 1</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify whether the runner should be locked to a specific project: true, false. Defaults to true.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># locked: true</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify the tags associated with the runner. Comma-separated list of tags.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/ce/ci/runners/#using-tags</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># tags: ""</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify if jobs without tags should be run.</span></div><div class="line">  <span class="comment">## If not specified, Runner will default to true if no tags were specified. In other case it will</span></div><div class="line">  <span class="comment">## default to false.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/ce/ci/runners/#allowing-runners-with-tags-to-pick-jobs-without-tags</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># runUntagged: true</span></div><div class="line"></div><div class="line">  <span class="comment">## Run all containers with the privileged flag enabled</span></div><div class="line">  <span class="comment">## This will allow the docker:dind image to run if you need to run Docker</span></div><div class="line">  <span class="comment">## commands. Please read the docs before turning this on:</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-dind</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  privileged:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">  <span class="comment">## The name of the secret containing runner-token and runner-registration-token</span></div><div class="line">  <span class="comment"># secret: gitlab-runner</span></div><div class="line"></div><div class="line">  <span class="comment">## Namespace to run Kubernetes jobs in (defaults to the same namespace of this release)</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># namespace:</span></div><div class="line"></div><div class="line">  <span class="comment">## Distributed runners caching</span></div><div class="line">  <span class="comment">## ref: https://gitlab.com/gitlab-org/gitlab-runner/blob/master/docs/configuration/autoscale.md#distributed-runners-caching</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## If you want to use s3 based distributing caching:</span></div><div class="line">  <span class="comment">## First of all you need to uncomment General settings and S3 settings sections.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Create a secret 's3access' containing 'accesskey' &amp; 'secretkey'</span></div><div class="line">  <span class="comment">## ref: https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## $ kubectl create secret generic s3access \</span></div><div class="line">  <span class="comment">##   --from-literal=accesskey="YourAccessKey" \</span></div><div class="line">  <span class="comment">##   --from-literal=secretkey="YourSecretKey"</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/secret/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## If you want to use gcs based distributing caching:</span></div><div class="line">  <span class="comment">## First of all you need to uncomment General settings and GCS settings sections.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Access using credentials file:</span></div><div class="line">  <span class="comment">## Create a secret 'google-application-credentials' containing your application credentials file.</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnerscachegcs-section</span></div><div class="line">  <span class="comment">## You could configure</span></div><div class="line">  <span class="comment">## $ kubectl create secret generic google-application-credentials \</span></div><div class="line">  <span class="comment">##   --from-file=gcs-applicaton-credentials-file=./path-to-your-google-application-credentials-file.json</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/secret/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Access using access-id and private-key:</span></div><div class="line">  <span class="comment">## Create a secret 'gcsaccess' containing 'gcs-access-id' &amp; 'gcs-private-key'.</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-cache-gcs-section</span></div><div class="line">  <span class="comment">## You could configure</span></div><div class="line">  <span class="comment">## $ kubectl create secret generic gcsaccess \</span></div><div class="line">  <span class="comment">##   --from-literal=gcs-access-id="YourAccessID" \</span></div><div class="line">  <span class="comment">##   --from-literal=gcs-private-key="YourPrivateKey"</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/secret/</span></div><div class="line"><span class="attr">  cache:</span> &#123;&#125;</div><div class="line">    <span class="comment">## General settings</span></div><div class="line">    <span class="comment"># cacheType: s3</span></div><div class="line">    <span class="comment"># cachePath: "gitlab_runner"</span></div><div class="line">    <span class="comment"># cacheShared: true</span></div><div class="line"></div><div class="line">    <span class="comment">## S3 settings</span></div><div class="line">    <span class="comment"># s3ServerAddress: s3.amazonaws.com</span></div><div class="line">    <span class="comment"># s3BucketName:</span></div><div class="line">    <span class="comment"># s3BucketLocation:</span></div><div class="line">    <span class="comment"># s3CacheInsecure: false</span></div><div class="line">    <span class="comment"># secretName: s3access</span></div><div class="line"></div><div class="line">    <span class="comment">## GCS settings</span></div><div class="line">    <span class="comment"># gcsBucketName:</span></div><div class="line">    <span class="comment">## Use this line for access using access-id and private-key</span></div><div class="line">    <span class="comment"># secretName: gcsaccess</span></div><div class="line">    <span class="comment">## Use this line for access using google-application-credentials file</span></div><div class="line">    <span class="comment"># secretName: google-application-credentials</span></div><div class="line"></div><div class="line">  <span class="comment">## Build Container specific configuration</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  builds:</span> &#123;&#125;</div><div class="line">    <span class="comment"># cpuLimit: 200m</span></div><div class="line">    <span class="comment"># memoryLimit: 256Mi</span></div><div class="line">    <span class="comment"># cpuRequests: 100m</span></div><div class="line">    <span class="comment"># memoryRequests: 128Mi</span></div><div class="line"></div><div class="line">  <span class="comment">## Service Container specific configuration</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  services:</span> &#123;&#125;</div><div class="line">    <span class="comment"># cpuLimit: 200m</span></div><div class="line">    <span class="comment"># memoryLimit: 256Mi</span></div><div class="line">    <span class="comment"># cpuRequests: 100m</span></div><div class="line">    <span class="comment"># memoryRequests: 128Mi</span></div><div class="line"></div><div class="line">  <span class="comment">## Helper Container specific configuration</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  helpers:</span> &#123;&#125;</div><div class="line">    <span class="comment"># cpuLimit: 200m</span></div><div class="line">    <span class="comment"># memoryLimit: 256Mi</span></div><div class="line">    <span class="comment"># cpuRequests: 100m</span></div><div class="line">    <span class="comment"># memoryRequests: 128Mi</span></div><div class="line">    <span class="comment"># image: gitlab/gitlab-runner-helper:x86_64-latest</span></div><div class="line"></div><div class="line">  <span class="comment">## Service Account to be used for runners</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># serviceAccountName:</span></div><div class="line"></div><div class="line">  <span class="comment">## If Gitlab is not reachable through $CI_SERVER_URL</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># cloneUrl:</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify node labels for CI job pods assignment</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># nodeSelector: &#123;&#125;</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify pod labels for CI job pods</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># podLabels: &#123;&#125;</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify annotations for job pods, useful for annotations such as iam.amazonaws.com/role</span></div><div class="line">  <span class="comment"># podAnnotations: &#123;&#125;</span></div><div class="line"></div><div class="line">  <span class="comment">## Configure environment variables that will be injected to the pods that are created while</span></div><div class="line">  <span class="comment">## the build is running. These variables are passed as parameters, i.e. `--env "NAME=VALUE"`,</span></div><div class="line">  <span class="comment">## to `gitlab-runner register` command.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Note that `envVars` (see below) are only present in the runner pod, not the pods that are</span></div><div class="line">  <span class="comment">## created for each build.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/commands/#gitlab-runner-register</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># env:</span></div><div class="line">  <span class="comment">#   NAME: VALUE</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## Configure resource requests and limits</span></div><div class="line"><span class="comment">## ref: http://kubernetes.io/docs/user-guide/compute-resources/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">resources:</span> &#123;&#125;</div><div class="line">  <span class="comment"># limits:</span></div><div class="line">  <span class="comment">#   memory: 256Mi</span></div><div class="line">  <span class="comment">#   cpu: 200m</span></div><div class="line">  <span class="comment"># requests:</span></div><div class="line">  <span class="comment">#   memory: 128Mi</span></div><div class="line">  <span class="comment">#   cpu: 100m</span></div><div class="line"></div><div class="line"><span class="comment">## Affinity for pod assignment</span></div><div class="line"><span class="comment">## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">affinity:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">## Node labels for pod assignment</span></div><div class="line"><span class="comment">## Ref: https://kubernetes.io/docs/user-guide/node-selection/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">nodeSelector:</span> &#123;</div><div class="line"><span class="attr">  nodeType:</span> k8s</div><div class="line">&#125;</div><div class="line">  <span class="comment"># Example: The gitlab runner manager should not run on spot instances so you can assign</span></div><div class="line">  <span class="comment"># them to the regular worker nodes only.</span></div><div class="line">  <span class="comment"># node-role.kubernetes.io/worker: "true"</span></div><div class="line"></div><div class="line"><span class="comment">## List of node taints to tolerate (requires Kubernetes &gt;= 1.6)</span></div><div class="line"><span class="comment">## Ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">tolerations:</span> []</div><div class="line">  <span class="comment"># Example: Regular worker nodes may have a taint, thus you need to tolerate the taint</span></div><div class="line">  <span class="comment"># when you assign the gitlab runner manager with nodeSelector or affinity to the nodes.</span></div><div class="line">  <span class="comment"># - key: "node-role.kubernetes.io/worker"</span></div><div class="line">  <span class="comment">#   operator: "Exists"</span></div><div class="line"></div><div class="line"><span class="comment">## Configure environment variables that will be present when the registration command runs</span></div><div class="line"><span class="comment">## This provides further control over the registration process and the config.toml file</span></div><div class="line"><span class="comment">## ref: `gitlab-runner register --help`</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># envVars:</span></div><div class="line"><span class="comment">#   - name: RUNNER_EXECUTOR</span></div><div class="line"><span class="comment">#     value: kubernetes</span></div><div class="line"></div><div class="line"><span class="comment">## list of hosts and IPs that will be injected into the pod's hosts file</span></div><div class="line"><span class="attr">hostAliases:</span> []</div><div class="line">  <span class="comment"># Example:</span></div><div class="line">  <span class="comment"># - ip: "127.0.0.1"</span></div><div class="line">  <span class="comment">#   hostnames:</span></div><div class="line">  <span class="comment">#   - "foo.local"</span></div><div class="line">  <span class="comment">#   - "bar.local"</span></div><div class="line">  <span class="comment"># - ip: "10.1.2.3"</span></div><div class="line">  <span class="comment">#   hostnames:</span></div><div class="line">  <span class="comment">#   - "foo.remote"</span></div><div class="line">  <span class="comment">#   - "bar.remote"</span></div><div class="line"></div><div class="line"><span class="comment">## Annotations to be added to manager pod</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">podAnnotations:</span> &#123;&#125;</div><div class="line">  <span class="comment"># Example:</span></div><div class="line">  <span class="comment"># iam.amazonaws.com/role: &lt;my_role_arn&gt;</span></div><div class="line"></div><div class="line"><span class="comment">## HPA support for custom metrics:</span></div><div class="line"><span class="comment">## This section enables runners to autoscale based on defined custom metrics.</span></div><div class="line"><span class="comment">## In order to use this functionality, Need to enable a custom metrics API server by</span></div><div class="line"><span class="comment">## implementing "custom.metrics.k8s.io" using supported third party adapter</span></div><div class="line"><span class="comment">## Example: https://github.com/directxman12/k8s-prometheus-adapter</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">#hpa: &#123;&#125;</span></div><div class="line">  <span class="comment"># minReplicas: 1</span></div><div class="line">  <span class="comment"># maxReplicas: 10</span></div><div class="line">  <span class="comment"># metrics:</span></div><div class="line">  <span class="comment"># - type: Pods</span></div><div class="line">  <span class="comment">#   pods:</span></div><div class="line">  <span class="comment">#     metricName: gitlab_runner_jobs</span></div><div class="line">  <span class="comment">#     targetAverageValue: 400m</span></div></pre></td></tr></table></figure>
<h3 id="Helm-for-gitlab-configmap"><a href="#Helm-for-gitlab-configmap" class="headerlink" title="Helm for gitlab configmap"></a>Helm for gitlab configmap</h3><p> cat templates/configmap.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ConfigMap</div><div class="line">metadata:</div><div class="line">  name: &#123;&#123; include <span class="string">"gitlab-runner.fullname"</span> . &#125;&#125;</div><div class="line">  labels:</div><div class="line">    app: &#123;&#123; include <span class="string">"gitlab-runner.fullname"</span> . &#125;&#125;</div><div class="line">    chart: &#123;&#123; include <span class="string">"gitlab-runner.chart"</span> . &#125;&#125;</div><div class="line">    release: <span class="string">"&#123;&#123; .Release.Name &#125;&#125;"</span></div><div class="line">    heritage: <span class="string">"&#123;&#123; .Release.Service &#125;&#125;"</span></div><div class="line">data:</div><div class="line">  entrypoint: |</div><div class="line">    <span class="comment">#!/bin/bash</span></div><div class="line">    <span class="built_in">set</span> <span class="_">-e</span></div><div class="line">    mkdir -p /home/gitlab-runner/.gitlab-runner/</div><div class="line">    cp /scripts/config.toml /home/gitlab-runner/.gitlab-runner/</div><div class="line"></div><div class="line">    <span class="comment"># Register the runner</span></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/accesskey &amp;&amp; <span class="_">-f</span> /secrets/secretkey ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> CACHE_S3_ACCESS_KEY=$(cat /secrets/accesskey)</div><div class="line">      <span class="built_in">export</span> CACHE_S3_SECRET_KEY=$(cat /secrets/secretkey)</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/gcs-applicaton-credentials-file ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> GOOGLE_APPLICATION_CREDENTIALS=<span class="string">"/secrets/gcs-applicaton-credentials-file"</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">      <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/gcs-access-id &amp;&amp; <span class="_">-f</span> /secrets/gcs-private-key ]]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">export</span> CACHE_GCS_ACCESS_ID=$(cat /secrets/gcs-access-id)</div><div class="line">        <span class="comment"># echo -e used to make private key multiline (in google json auth key private key is oneline with \n)</span></div><div class="line">        <span class="built_in">export</span> CACHE_GCS_PRIVATE_KEY=$(<span class="built_in">echo</span> <span class="_">-e</span> $(cat /secrets/gcs-private-key))</div><div class="line">      <span class="keyword">fi</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/runner-registration-token ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> REGISTRATION_TOKEN=$(cat /secrets/runner-registration-token)</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/runner-token ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> CI_SERVER_TOKEN=$(cat /secrets/runner-token)</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> ! sh /scripts/register-the-runner; <span class="keyword">then</span></div><div class="line">      <span class="built_in">exit</span> 1</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF</div><div class="line">      output_limit = 100000</div><div class="line">      [[runners.kubernetes.volumes.pvc]]</div><div class="line">        name = <span class="string">"gitlab-runner-maven-repo-claim"</span></div><div class="line">        mount_path = <span class="string">"/home/cache/maven"</span></div><div class="line">      [[runners.kubernetes.volumes.host_path]]</div><div class="line">        name = <span class="string">"docker"</span></div><div class="line">        mount_path = <span class="string">"/var/run/docker.sock"</span></div><div class="line">    EOF</div><div class="line">    <span class="comment"># Start the runner</span></div><div class="line">    <span class="built_in">exec</span> /entrypoint run --user=gitlab-runner \</div><div class="line">      --working-directory=/home/gitlab-runner</div><div class="line"></div><div class="line">  config.toml: |</div><div class="line">    concurrent = &#123;&#123; .Values.concurrent &#125;&#125;</div><div class="line">    check_interval = &#123;&#123; .Values.checkInterval &#125;&#125;</div><div class="line">    log_level = &#123;&#123; default <span class="string">"info"</span> .Values.logLevel | quote &#125;&#125;</div><div class="line">    output_limit = &#123;&#123; default 10000 .Values.limitLine&#125;&#125;</div><div class="line">    &#123;&#123;- <span class="keyword">if</span> .Values.logFormat &#125;&#125;</div><div class="line">    log_format = &#123;&#123; .Values.logFormat | quote &#125;&#125;</div><div class="line">    &#123;&#123;- end &#125;&#125;</div><div class="line">    &#123;&#123;- <span class="keyword">if</span> .Values.metrics.enabled &#125;&#125;</div><div class="line">    listen_address = <span class="string">'[::]:9252'</span></div><div class="line">    &#123;&#123;- end &#125;&#125;</div><div class="line">  configure: |</div><div class="line">    <span class="built_in">set</span> <span class="_">-e</span></div><div class="line">    cp /init-secrets/* /secrets</div><div class="line">  register-the-runner: |</div><div class="line">    <span class="comment">#!/bin/bash</span></div><div class="line">    MAX_REGISTER_ATTEMPTS=30</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> $(seq 1 <span class="string">"<span class="variable">$&#123;MAX_REGISTER_ATTEMPTS&#125;</span>"</span>); <span class="keyword">do</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"Registration attempt <span class="variable">$&#123;i&#125;</span> of <span class="variable">$&#123;MAX_REGISTER_ATTEMPTS&#125;</span>"</span></div><div class="line">      /entrypoint register \</div><div class="line">        &#123;&#123;- range .Values.runners.imagePullSecrets &#125;&#125;</div><div class="line">        --kubernetes-image-pull-secrets &#123;&#123; . | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$val</span> := .Values.runners.nodeSelector &#125;&#125;</div><div class="line">        --kubernetes-node-selector &#123;&#123; <span class="variable">$key</span> | quote &#125;&#125;:&#123;&#123; <span class="variable">$val</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$value</span> := .Values.runners.podLabels &#125;&#125;</div><div class="line">        --kubernetes-pod-labels &#123;&#123; <span class="variable">$key</span> | quote &#125;&#125;:&#123;&#123; <span class="variable">$value</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$val</span> := .Values.runners.podAnnotations &#125;&#125;</div><div class="line">        --kubernetes-pod-annotations &#123;&#123; <span class="variable">$key</span> | quote &#125;&#125;:&#123;&#123; <span class="variable">$val</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$value</span> := .Values.runners.env &#125;&#125;</div><div class="line">        --env &#123;&#123; <span class="variable">$key</span> | quote -&#125;&#125; = &#123;&#123;- <span class="variable">$value</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- <span class="keyword">if</span> and (hasKey .Values.runners <span class="string">"runUntagged"</span>) .Values.runners.runUntagged &#125;&#125;</div><div class="line">        --run-untagged=<span class="literal">true</span> \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        --non-interactive</div><div class="line"></div><div class="line">      retval=$?</div><div class="line"></div><div class="line">      <span class="keyword">if</span> [ <span class="variable">$&#123;retval&#125;</span> = 0 ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">break</span></div><div class="line">      <span class="keyword">elif</span> [ <span class="variable">$&#123;i&#125;</span> = <span class="variable">$&#123;MAX_REGISTER_ATTEMPTS&#125;</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line">      <span class="keyword">fi</span></div><div class="line"></div><div class="line">      sleep 5</div><div class="line">    <span class="keyword">done</span></div><div class="line"></div><div class="line">    <span class="built_in">exit</span> 0</div><div class="line"></div><div class="line">  check-live: |</div><div class="line">    <span class="comment">#!/bin/bash</span></div><div class="line">    <span class="keyword">if</span> /usr/bin/pgrep <span class="_">-f</span> .*register-the-runner; <span class="keyword">then</span></div><div class="line">      <span class="built_in">exit</span> 0</div><div class="line">    <span class="keyword">elif</span> /usr/bin/pgrep gitlab.*runner; <span class="keyword">then</span></div><div class="line">      <span class="built_in">exit</span> 0</div><div class="line">    <span class="keyword">else</span></div><div class="line">      <span class="built_in">exit</span> 1</div><div class="line">    <span class="keyword">fi</span></div></pre></td></tr></table></figure>
<h3 id="gitlab-runner"><a href="#gitlab-runner" class="headerlink" title="gitlab-runner"></a>gitlab-runner</h3><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="string">helm </span><span class="string">install </span><span class="built_in">--name</span> <span class="string">xxx </span><span class="string">gitlab/</span><span class="string">gitlab-runner </span>-f <span class="string">values-spm-</span><span class="string">labour.</span><span class="string">yaml </span> <span class="built_in">--namespace</span> <span class="string">gitlab-runners </span><span class="built_in">--version</span> <span class="string">"v0.10.0-rc1"</span></div><div class="line"><span class="string">helm </span><span class="string">upgrade </span><span class="string">xxx </span>./<span class="string">gitlab-runner/</span></div></pre></td></tr></table></figure>
<h3 id="创建runner-maven-缓存"><a href="#创建runner-maven-缓存" class="headerlink" title="创建runner maven 缓存"></a>创建runner maven 缓存</h3><blockquote>
<p>Java 需要</p>
</blockquote>
<p>cat maven-nfs.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> PersistentVolume</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab-runner-maven-repo</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span>Gi</div><div class="line"><span class="attr">  mountOptions:</span></div><div class="line"><span class="bullet">  -</span> nolock</div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> /data/nfs/volumes</div><div class="line"><span class="attr">    server:</span> YOURIPADDRESS</div><div class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> Recycle</div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> PersistentVolumeClaim</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab-runner-maven-repo-claim</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">  resources:</span></div><div class="line"><span class="attr">    requests:</span></div><div class="line"><span class="attr">      storage:</span> <span class="number">5</span>Gi</div><div class="line"><span class="attr">  volumeName:</span> gitlab-runner-maven-repo</div><div class="line"><span class="attr">status:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span>Gi</div></pre></td></tr></table></figure>
<h4 id="生成maven缓存PVC"><a href="#生成maven缓存PVC" class="headerlink" title="生成maven缓存PVC"></a>生成maven缓存PVC</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> PersistentVolumeClaim</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab-runner-maven-repo-claim</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">    resources:</span></div><div class="line"><span class="attr">    requests:</span></div><div class="line"><span class="attr">      storage:</span> <span class="number">5</span>Gi</div><div class="line"><span class="attr">    volumeName:</span> gitlab-runner-maven-repo</div><div class="line"><span class="attr">status:</span></div><div class="line"><span class="attr">    accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">    capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span>Gi</div></pre></td></tr></table></figure>
<h4 id="代码及镜像上传"><a href="#代码及镜像上传" class="headerlink" title="代码及镜像上传"></a>代码及镜像上传</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">##如果删除</div><div class="line">helm del --purge spm-labour</div><div class="line"></div><div class="line">##生成gitlab namespace</div><div class="line">kubectl create ns gitlab</div><div class="line">### 代码镜像上传密钥</div><div class="line">kubectl create secret docker-registry  huawei-auth --docker-server=XXX.myhuaweicloud.com --docker-username=XXX --docker-password=XXXX -ngitlab</div><div class="line">###kubectl create secret docker-registry  aliyun-auth --docker-server=registry.cn-zhangjiakou.aliyuncs.com --docker-username=xxx --docker-password=xxx -ngitlab</div></pre></td></tr></table></figure>
<h5 id="其它及遇到的坑"><a href="#其它及遇到的坑" class="headerlink" title="其它及遇到的坑"></a>其它及遇到的坑</h5><blockquote>
<p>GitLab集成k8s 签名错误</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl get secrets</div><div class="line">kubectl get secret default-token-52xsf  -o jsonpath="&#123;[<span class="string">'data'</span>][<span class="symbol">'ca\.crt'</span>]&#125;" | base64 --decode</div></pre></td></tr></table></figure>
<blockquote>
<p>cat gitlab-admin-service-account.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> ServiceAccount</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab</div><div class="line"></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</div><div class="line"><span class="attr">kind:</span> ClusterRoleBinding</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab</div><div class="line"><span class="attr">subjects:</span></div><div class="line"><span class="attr">  - kind:</span> ServiceAccount</div><div class="line"><span class="attr">    name:</span> gitlab</div><div class="line"><span class="attr">    namespace:</span> gitlab</div><div class="line"><span class="attr">roleRef:</span></div><div class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</div><div class="line"><span class="attr">  kind:</span> ClusterRole</div><div class="line"><span class="attr">  name:</span> cluster-admin</div></pre></td></tr></table></figure>
<blockquote>
<p>获取 Service Token</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl -n gitlab  describe secret $(kubectl -n gitlab get secret <span class="params">| grep gitlab|</span> awk <span class="string">'&#123;print $1&#125;'</span>)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/10/29/记k8s在公网部署/" itemprop="url">
                  记k8s在公网部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-10-29T10:26:59+08:00" content="2020-10-29">
              2020-10-29
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/10/29/记k8s在公网部署/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/10/29/记k8s在公网部署/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="1-安装必备软件"><a href="#1-安装必备软件" class="headerlink" title="1. 安装必备软件"></a>1. 安装必备软件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y wget vim net-tools epel-<span class="keyword">release</span></div></pre></td></tr></table></figure>
<h3 id="2-关闭swap"><a href="#2-关闭swap" class="headerlink" title="2. 关闭swap"></a>2. 关闭swap</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">swapoff -a</div><div class="line"></div><div class="line"><span class="comment"># 永久禁用，打开/etc/fstab注释掉swap那一行。</span></div><div class="line">sed -i <span class="string">'s/.*swap.*/#&amp;/'</span> <span class="regexp">/etc/</span>fstab</div></pre></td></tr></table></figure>
<h3 id="3-关闭selinux"><a href="#3-关闭selinux" class="headerlink" title="3. 关闭selinux"></a>3. 关闭selinux</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 临时禁用selinux</span></div><div class="line">setenforce <span class="number">0</span></div><div class="line"><span class="meta"># 永久关闭 修改/etc/sysconfig/selinux文件设置</span></div><div class="line">sed -i <span class="string">'s/SELINUX=permissive/SELINUX=disabled/'</span> /etc/sysconfig/selinux</div><div class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</div></pre></td></tr></table></figure>
<h3 id="4-关闭防火墙"><a href="#4-关闭防火墙" class="headerlink" title="4. 关闭防火墙"></a>4. 关闭防火墙</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl <span class="keyword">disable</span> firewalld</div><div class="line">systemctl <span class="keyword">stop</span> firewalld</div></pre></td></tr></table></figure>
<h2 id="安装Docker和配置代理"><a href="#安装Docker和配置代理" class="headerlink" title="安装Docker和配置代理"></a>安装Docker和配置代理</h2><h3 id="1-配置yum源"><a href="#1-配置yum源" class="headerlink" title="1. 配置yum源"></a>1. 配置yum源</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">## 配置默认源</div><div class="line">## 备份</div><div class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</div><div class="line"></div><div class="line">## 下载阿里源</div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http:<span class="comment">//mirrors.aliyun.com/repo/Centos-7.repo</span></div><div class="line"></div><div class="line">## 刷新</div><div class="line">yum makecache fast</div><div class="line"></div><div class="line">## 配置k8s源</div><div class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</div><div class="line">[kubernetes]</div><div class="line">name=Kubernetes</div><div class="line">baseurl=https:<span class="comment">//mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></div><div class="line">enabled=<span class="number">1</span></div><div class="line">gpgcheck=<span class="number">0</span></div><div class="line">EOF</div><div class="line"></div><div class="line">## 重建yum缓存</div><div class="line">yum clean all</div><div class="line">yum makecache fast</div><div class="line">yum -y update</div></pre></td></tr></table></figure>
<h3 id="2-安装docker"><a href="#2-安装docker" class="headerlink" title="2. 安装docker"></a>2. 安装docker</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">yum -y <span class="keyword">install</span> yum-utils device-mapper-persistent-<span class="keyword">data</span> lvm2</div><div class="line">yum-config-manager <span class="comment">--add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></div><div class="line">yum -y <span class="keyword">install</span> docker-ce</div><div class="line">systemctl <span class="keyword">enable</span> docker</div><div class="line">systemctl <span class="keyword">start</span> docker</div></pre></td></tr></table></figure>
<h3 id="3-确保kubelet使用的cgroup-driver-与-Docker的一致"><a href="#3-确保kubelet使用的cgroup-driver-与-Docker的一致" class="headerlink" title="3. 确保kubelet使用的cgroup driver 与 Docker的一致"></a>3. 确保kubelet使用的cgroup driver 与 Docker的一致</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;<span class="built_in">EOF</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</div><div class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</div><div class="line">  <span class="string">"log-opts"</span>: &#123;</div><div class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>,</div><div class="line">  <span class="string">"storage-opts"</span>: [</div><div class="line">    <span class="string">"overlay2.override_kernel_check=true"</span></div><div class="line">  ]</div><div class="line">&#125;</div><div class="line"><span class="built_in">EOF</span></div><div class="line"></div><div class="line">sudo systemctl daemon-reload sudo systemctl restart docker</div></pre></td></tr></table></figure>
<h3 id="4-设置docker代理（核心步骤-如果有代理）"><a href="#4-设置docker代理（核心步骤-如果有代理）" class="headerlink" title="4. 设置docker代理（核心步骤-如果有代理）"></a>4. 设置docker代理（核心步骤-如果有代理）</h3><blockquote>
<p>没有代理执行步骤5</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mkdir /etc/systemd/system/docker<span class="selector-class">.service</span><span class="selector-class">.d</span></div><div class="line">touch /etc/systemd/system/docker<span class="selector-class">.service</span><span class="selector-class">.d</span>/http-proxy<span class="selector-class">.conf</span></div><div class="line"></div><div class="line">[Service]</div><div class="line">Environment=<span class="string">"HTTP_PROXY=http://xxx"</span></div><div class="line">Environment=<span class="string">"HTTPS_PROXY=http://xxx"</span></div><div class="line">Environment=<span class="string">"NO_PROXY=localhost,127.0.0.1,localaddress,.localdomain.com"</span></div><div class="line"></div><div class="line">systemctl daemon-reload &amp;&amp; systemctl restart docker</div></pre></td></tr></table></figure>
<h3 id="5-从国内仓库拉取镜像（核心步骤-如果没有代理）"><a href="#5-从国内仓库拉取镜像（核心步骤-如果没有代理）" class="headerlink" title="5. 从国内仓库拉取镜像（核心步骤-如果没有代理）"></a>5. 从国内仓库拉取镜像（核心步骤-如果没有代理）</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## 查看集群初始化所需镜像及对应依赖版本号，列出的就是需要下载的镜像</span></div><div class="line">kubeadm config images <span class="built_in">list</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">images=(</div><div class="line">kube-apiserver:v1.18.0</div><div class="line">kube-controller-manager:v1.18.0</div><div class="line">kube-scheduler:v1.18.0</div><div class="line">kube-proxy:v1.18.0</div><div class="line">pause:3.2</div><div class="line">etcd:3.4.3-0</div><div class="line">coredns:1.6.7</div><div class="line">kubernetes-dashboard-amd64:v1.10.1</div><div class="line">)</div><div class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span>;<span class="keyword">do</span></div><div class="line">        docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></div><div class="line">        docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<h2 id="开始安装k8s"><a href="#开始安装k8s" class="headerlink" title="开始安装k8s"></a>开始安装k8s</h2><h3 id="1-安装kubeadm，kubelet等"><a href="#1-安装kubeadm，kubelet等" class="headerlink" title="1. 安装kubeadm，kubelet等"></a>1. 安装kubeadm，kubelet等</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum -y <span class="keyword">install</span> kubelet kubeadm kubectl kubernetes-cni</div><div class="line">systemctl <span class="keyword">enable</span> kubelet &amp;&amp; systemctl <span class="keyword">start</span> kubelet</div></pre></td></tr></table></figure>
<h3 id="2-集群初始化"><a href="#2-集群初始化" class="headerlink" title="2. 集群初始化"></a>2. 集群初始化</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">## master节点执行：</div><div class="line">sudo kubeadm init \</div><div class="line"> --apiserver-advertise-address <span class="number">10.1</span><span class="number">.69</span><span class="number">.101</span> \</div><div class="line"> --kubernetes-version=v1<span class="number">.15</span><span class="number">.0</span> \</div><div class="line"> --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></div></pre></td></tr></table></figure>
<blockquote>
<p>公网会卡在:</p>
</blockquote>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[wait-control-plane] Waiting <span class="keyword">for</span> the kubelet <span class="keyword">to</span> boot up the control plane <span class="keyword">as</span> <span class="keyword">static</span> Pods <span class="keyword">from</span> directory <span class="string">"/etc/kubernetes/manifests"</span>. This can <span class="keyword">take</span> up <span class="keyword">to</span> <span class="number">4</span>m0s</div><div class="line">[kubelet-check] Initial timeout <span class="keyword">of</span> <span class="number">40</span>s passed.</div></pre></td></tr></table></figure>
<h2 id="修改etcd-yaml"><a href="#修改etcd-yaml" class="headerlink" title="修改etcd.yaml"></a>修改etcd.yaml</h2><blockquote>
<p>文件路径”/etc/kubernetes/manifests/etcd.yaml”</p>
</blockquote>
<h5 id="修改前"><a href="#修改前" class="headerlink" title="修改前"></a>修改前</h5><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g90yzxelfhj30m00f8ac2.jpg" alt=""></p>
<h5 id="修改后"><a href="#修改后" class="headerlink" title="修改后"></a>修改后</h5><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g90z0cev0kj30m00f8dhs.jpg" alt=""></p>
<blockquote>
<p>此处”xxx”为公网ip，要关注的是”–listen-client-urls”和”–listen-peer-urls”。需要把–listen-client-urls 和 –listen-peer-urls 都改成0.0.0.0：xxx</p>
</blockquote>
<p><a href="https://my.oschina.net/u/4389078/blog/3233116" target="_blank" rel="external">来源</a></p>
<p>得到回复：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">(...省略)</div><div class="line"><span class="keyword">mkdir</span> -p <span class="variable">$HOME</span>/.kube</div><div class="line">sudo cp -i /etc/kubernetes/admin.<span class="keyword">conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -<span class="keyword">u</span>):$(id -<span class="keyword">g</span>) <span class="variable">$HOME</span>/.kube/config</div><div class="line"></div><div class="line">## 保存好该命令，丢了不好找回。节点加入时需要</div><div class="line">kubeadm join 10.1.69.101:6443 --<span class="keyword">token</span> ou5pvo.qseafc4s8licblzy \</div><div class="line">    --discovery-<span class="keyword">token</span>-<span class="keyword">ca</span>-cert-hash sha256:de9c10f11c50c074f212698b9d514fc12a9c1c4ffe70961aff89ac5e585f0663</div></pre></td></tr></table></figure>
<h3 id="3-拷贝配置，给kubectl使用"><a href="#3-拷贝配置，给kubectl使用" class="headerlink" title="3. 拷贝配置，给kubectl使用"></a>3. 拷贝配置，给kubectl使用</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir -<span class="selector-tag">p</span> <span class="variable">$HOME</span>/<span class="selector-class">.kube</span></div><div class="line">sudo cp -<span class="selector-tag">i</span> /etc/kubernetes/admin<span class="selector-class">.conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</div></pre></td></tr></table></figure>
<h3 id="4-安装flannel网络"><a href="#4-安装flannel网络" class="headerlink" title="4. 安装flannel网络"></a>4. 安装flannel网络</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo kubectl apply -<span class="keyword">f</span> http<span class="variable">s:</span>//raw.githubusercontent.<span class="keyword">com</span>/coreos/flannel/master/Documentation/kube-flannel.yml</div><div class="line"></div><div class="line">## 查看flannal是否安装成功</div><div class="line"></div><div class="line">sudo kubectl -n kube-<span class="built_in">system</span> <span class="built_in">get</span> <span class="keyword">po</span> -<span class="keyword">l</span> app=flannel -<span class="keyword">o</span> wide</div></pre></td></tr></table></figure>
<h2 id="5-node节点加入集群"><a href="#5-node节点加入集群" class="headerlink" title="5. node节点加入集群"></a>5. node节点加入集群</h2><p>其他节点执行：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">kubeadm</span> <span class="selector-tag">join</span> 39<span class="selector-class">.99</span><span class="selector-class">.xxx</span><span class="selector-class">.xxx</span><span class="selector-pseudo">:6443</span>   <span class="selector-tag">--token</span> <span class="selector-tag">w4tx2r</span><span class="selector-class">.0dm194h24wlw8m8t</span> <span class="selector-tag">--discovery-token-ca-cert-hash</span> <span class="selector-tag">sha256</span><span class="selector-pseudo">:caae3b178b4172839269254f373b6eaa14514173b01e129e0b0fe7d64694dc39</span></div></pre></td></tr></table></figure>
<h2 id="清理安装"><a href="#清理安装" class="headerlink" title="清理安装"></a>清理安装</h2><blockquote>
<p> 如果安装过程中出任何问题，可以重置后重新安装</p>
</blockquote>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">sudo kubeadm reset</span></div></pre></td></tr></table></figure>
<h1 id="Dashboard安装"><a href="#Dashboard安装" class="headerlink" title="Dashboard安装"></a>Dashboard安装</h1><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 安装dashboard，国内可以使用别的yaml源</span></div><div class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.<span class="number">10.1</span>/src/deploy/recommended/kubernetes-dashboard.yaml</div><div class="line"></div><div class="line"><span class="comment"># 修改node为NodePort模式</span></div><div class="line">kubectl patch svc -n kube-system kubernetes-dashboard -p '&#123;<span class="string">"spec"</span>:&#123;<span class="string">"type"</span>:<span class="string">"NodePort"</span>&#125;&#125;'</div><div class="line"></div><div class="line"><span class="comment"># 查看服务(得知dashboard运行在443:32383/TCP端口)</span></div><div class="line">kubectl get svc -n kube-system </div><div class="line"><span class="comment"># --- 输出 ---</span></div><div class="line">NAME                   <span class="keyword">TYPE</span>        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE</div><div class="line">kube-dns               ClusterIP   <span class="number">10.96</span>.<span class="number">0.10</span>      <span class="tag">&lt;none&gt;</span>        <span class="number">53</span>/UDP,<span class="number">53</span>/TCP,<span class="number">9153</span>/TCP   <span class="number">7h</span>40m</div><div class="line">kubernetes-dashboard   NodePort    <span class="number">10.111</span>.<span class="number">77.210</span>   <span class="tag">&lt;none&gt;</span>        <span class="number">443</span>:<span class="number">32383</span>/TCP            <span class="number">3h</span>42m</div><div class="line"><span class="comment"># --- 输出 ---</span></div><div class="line"></div><div class="line"><span class="comment"># 查看dashboard运行在哪个node(得知dashboard运行在192.168.20.4)</span></div><div class="line">kubectl get pods -A -o wide</div><div class="line"><span class="comment"># --- 输出 ---</span></div><div class="line">NAMESPACE     NAME                                    READY   STATUS    RESTARTS   AGE     IP             <span class="keyword">NODE</span>     <span class="title">NOMINATED</span> <span class="keyword">NODE</span>   <span class="title">READINESS</span> GATES</div><div class="line">kube-system   coredns-fb8b8dccf-rn8kd                 <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>43m   <span class="number">10.244</span>.<span class="number">0.2</span>     <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   coredns-fb8b8dccf-slwr4                 <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>43m   <span class="number">10.244</span>.<span class="number">0.3</span>     <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   etcd-<span class="keyword">master</span>                             <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-apiserver-<span class="keyword">master</span>                   <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-controller-manager-<span class="keyword">master</span>          <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-flannel-ds-amd64-l8c7c             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>3m    <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-flannel-ds-amd64-lcmxw             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">6h</span>50m   <span class="number">192.168</span>.<span class="number">20.4</span>   node1    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-flannel-ds-amd64-pqnln             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">6h</span>5m    <span class="number">192.168</span>.<span class="number">20.3</span>   node2    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-proxy-<span class="number">4</span>kcqb                        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>43m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-proxy-jcqjd                        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">6h</span>5m    <span class="number">192.168</span>.<span class="number">20.3</span>   node2    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-proxy-vm9sj                        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">6h</span>50m   <span class="number">192.168</span>.<span class="number">20.4</span>   node1    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kube-scheduler-<span class="keyword">master</span>                   <span class="title">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7h</span>42m   <span class="number">192.168</span>.<span class="number">20.5</span>   <span class="keyword">master</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></div><div class="line">kube-system   kubernetes-dashboard-<span class="number">5</span>f7b999d65-<span class="number">2</span>ltmv   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3h</span>45m   <span class="number">10.244</span>.<span class="number">1.2</span>     node1    <span class="tag">&lt;none&gt;</span>           <span class="tag">&lt;none&gt;</span></div><div class="line"><span class="comment"># --- 输出 ---</span></div><div class="line"><span class="comment"># 如果无法变成Running状态，可以使用以下命令排错</span></div><div class="line">journalctl -f -u kubelet  <span class="comment"># 只看当前的kubelet进程日志</span></div><div class="line"><span class="comment">### 提示拉取镜像失败，无法翻墙的可以使用以下方法预先拉取镜像</span></div><div class="line"><span class="comment">### 请在kubernetes-dashboard的节点上操作：</span></div><div class="line">docker pull mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span></div><div class="line">docker <span class="keyword">tag</span> <span class="title">mirrorgooglecontainers</span>/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span> k8s.gcr.io/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span></div><div class="line">docker rmi  mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.<span class="number">10.1</span></div></pre></td></tr></table></figure>
<p>获取token命令</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## 获取登陆界面token</span></div><div class="line">kubectl -n kube-<span class="keyword">system</span> describe $(kubectl -n kube-<span class="keyword">system</span> \</div><div class="line"><span class="built_in">get</span> secret -n kube-<span class="keyword">system</span> -o name | grep namespace) | grep <span class="keyword">token</span></div></pre></td></tr></table></figure>
<p>如果dashboard的token过期，以下脚本重新生成config文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">TOKEN=$(kubectl -n kube-system describe secret default| awk <span class="string">'$1=="token:"&#123;print $2&#125;'</span>)</div><div class="line">kubectl config <span class="built_in">set</span>-credentials kubernetes-admin --token=<span class="string">"<span class="variable">$&#123;TOKEN&#125;</span>"</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/18/如何编写Dockerfile/" itemprop="url">
                  如何编写Dockerfile
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-18T13:59:18+08:00" content="2019-04-18">
              2019-04-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/18/如何编写Dockerfile/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/18/如何编写Dockerfile/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>假设我们需要使用Docker运行一个Node.js应用</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get upgrade -y  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nodejs ssh mysql  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> mysql &amp; sshd &amp; npm start</span></div></pre></td></tr></table></figure>
<p>构建镜像:</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-t mydocker .</div></pre></td></tr></table></figure>
<h4 id="编写-dockerignore文件"><a href="#编写-dockerignore文件" class="headerlink" title="编写.dockerignore文件"></a>编写.dockerignore文件</h4><p>构建镜像时，Docker需要先准备context ，将所有需要的文件收集到进程中。默认的context包含Dockerfile目录中的所有文件，但是实际上，我们并不需要.git目录，node_modules目录等内容。 .dockerignore 的作用和语法类似于 .gitignore，可以忽略一些不需要的文件，这样可以有效加快镜像构建时间，同时减少Docker镜像的大小。示例如下:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="title">.git/</span></div><div class="line">node<span class="emphasis">_modules/</span></div></pre></td></tr></table></figure>
<h4 id="容器只运行单个应用"><a href="#容器只运行单个应用" class="headerlink" title="容器只运行单个应用"></a>容器只运行单个应用</h4><p>从技术角度讲，你可以在Docker容器中运行多个进程。你可以将数据库，前端，后端，ssh，supervisor都运行在同一个Docker容器中。但是，这会让你非常痛苦:</p>
<ul>
<li>非常长的构建时间(修改前端之后，整个后端也需要重新构建)</li>
<li>非常大的镜像大小</li>
<li>多个应用的日志难以处理</li>
<li>横向扩展时非常浪费资源(不同的应用需要运行的容器数并不相同)</li>
<li>僵尸进程问题 - 你需要选择合适的init进程</li>
</ul>
<p>因此，我建议大家为每个应用构建单独的Docker镜像，然后使用 Docker Compose 运行多个Docker容器。</p>
<p>现在，我从Dockerfile中删除一些不需要的安装包，另外，SSH可以用docker exec替代。示例如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get upgrade -y</span></div><div class="line"></div><div class="line"><span class="comment"># we should remove ssh and mysql, and use</span></div><div class="line"><span class="comment"># separate container for database </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nodejs  <span class="comment"># ssh mysql  </span></span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="将多个RUN指令合并为一个"><a href="#将多个RUN指令合并为一个" class="headerlink" title="将多个RUN指令合并为一个"></a>将多个RUN指令合并为一个</h4><p>Docker镜像是分层的，下面这些知识点非常重要:</p>
<ul>
<li>Dockerfile中的每个指令都会创建一个新的镜像层。</li>
<li>镜像层将被缓存和复用</li>
<li>当Dockerfile的指令修改了，复制的文件变化了，或者构建镜像时指定的变量不同了，对应的镜像层缓存就会失效</li>
<li>某一层的镜像缓存失效之后，它之后的镜像层缓存都会失效</li>
<li>镜像层是不可变的，如果我们再某一层中添加一个文件，然后在下一层中删除它，则镜像中依然会包含该文件(只是这个文件在Docker容器中不可见了)。</li>
</ul>
<p>Docker镜像类似于洋葱。它们都有很多层。为了修改内层，则需要将外面的层都删掉。记住这一点的话，其他内容就很好理解了。</p>
<p>现在，我们将所有的RUN指令合并为一个。同时把apt-get upgrade删除，因为它会使得镜像构建非常不确定(我们只需要依赖基础镜像的更新就好了)</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \  </span></div><div class="line">    &amp;&amp; apt-get install -y nodejs \</div><div class="line">    &amp;&amp; cd /app \</div><div class="line">    &amp;&amp; npm install</div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<p>记住一点，我们只能将变化频率一样的指令合并在一起。将node.js安装与npm模块安装放在一起的话，则每次修改源代码，都需要重新安装node.js，这显然不合适。因此，正确的写法是这样的:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y nodejs  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="基础镜像的标签不要用latest"><a href="#基础镜像的标签不要用latest" class="headerlink" title="基础镜像的标签不要用latest"></a>基础镜像的标签不要用latest</h4><p>当镜像没有指定标签时，将默认使用latest 标签。因此， FROM ubuntu 指令等同于FROM ubuntu:latest。当时，当镜像更新时，latest标签会指向不同的镜像，这时构建镜像有可能失败。如果你的确需要使用最新版的基础镜像，可以使用latest标签，否则的话，最好指定确定的镜像标签。</p>
<p>示例Dockerfile应该使用16.04作为标签。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">16.04</span>  <span class="comment"># it's that easy!</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y nodejs  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="每个RUN指令后删除多余文件"><a href="#每个RUN指令后删除多余文件" class="headerlink" title="每个RUN指令后删除多余文件"></a>每个RUN指令后删除多余文件</h4><p>假设我们更新了apt-get源，下载，解压并安装了一些软件包，它们都保存在/var/lib/apt/lists/目录中。但是，运行应用时Docker镜像中并不需要这些文件。我们最好将它们删除，因为它会使Docker镜像变大。</p>
<p>示例Dockerfile中，我们可以删除/var/lib/apt/lists/目录中的文件(它们是由apt-get update生成的)。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ROM ubuntu:<span class="number">16.04</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \  </span></div><div class="line">    &amp;&amp; apt-get install -y nodejs \</div><div class="line">    <span class="comment"># added lines</span></div><div class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/*</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="选择合适的基础镜像-alpine版本最好"><a href="#选择合适的基础镜像-alpine版本最好" class="headerlink" title="选择合适的基础镜像(alpine版本最好)"></a>选择合适的基础镜像(alpine版本最好)</h4><p>在示例中，我们选择了ubuntu作为基础镜像。但是我们只需要运行node程序，有必要使用一个通用的基础镜像吗？node镜像应该是更好的选择。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="comment"># we don't need to install node </span></div><div class="line"><span class="comment"># anymore and use apt-get</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<p>更好的选择是alpine版本的node镜像。alpine是一个极小化的Linux发行版，只有4MB，这让它非常适合作为基础镜像。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="设置WORKDIR和-CMD"><a href="#设置WORKDIR和-CMD" class="headerlink" title="设置WORKDIR和 CMD"></a>设置WORKDIR和 CMD</h4><p>WORKDIR指令可以设置默认目录，也就是运行RUN / CMD / ENTRYPOINT指令的地方。</p>
<p>CMD指令可以设置容器创建是执行的默认命令。另外，你应该讲命令写在一个数组中，数组中每个元素为命令的每个单词(参考<a href="https://docs.docker.com/engine/reference/builder/#cmd" target="_blank" rel="external">官方文档</a>)。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"npm"</span>, <span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="使用ENTRYPOINT-可选"><a href="#使用ENTRYPOINT-可选" class="headerlink" title="使用ENTRYPOINT (可选)"></a>使用ENTRYPOINT (可选)</h4><p>ENTRYPOINT指令并不是必须的，因为它会增加复杂度。ENTRYPOINT是一个脚本，它会默认执行，并且将指定的命令错误其参数。它通常用于构建可执行的Docker镜像。entrypoint.sh如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env sh</span></div><div class="line"><span class="comment"># $0 is a script name, </span></div><div class="line"><span class="comment"># $1, $2, $3 etc are passed arguments</span></div><div class="line"><span class="comment"># $1 is our command</span></div><div class="line">CMD=<span class="variable">$1</span></div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$CMD</span>"</span> <span class="keyword">in</span>  </div><div class="line">  <span class="string">"dev"</span> )</div><div class="line">    npm install</div><div class="line">    <span class="built_in">export</span> NODE_ENV=development</div><div class="line">    <span class="built_in">exec</span> npm run dev</div><div class="line">    ;;</div><div class="line"></div><div class="line">  <span class="string">"start"</span> )</div><div class="line">    <span class="comment"># we can modify files here, using ENV variables passed in </span></div><div class="line">    <span class="comment"># "docker create" command. It can't be done during build process.</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"db: <span class="variable">$DATABASE_ADDRESS</span>"</span> &gt;&gt; /app/config.yml</div><div class="line">    <span class="built_in">export</span> NODE_ENV=production</div><div class="line">    <span class="built_in">exec</span> npm start</div><div class="line">    ;;</div><div class="line"></div><div class="line">   * )</div><div class="line">    <span class="comment"># Run custom command. Thanks to this line we can still use </span></div><div class="line">    <span class="comment"># "docker run our_image /bin/bash" and it will work</span></div><div class="line">    <span class="built_in">exec</span> <span class="variable">$CMD</span> <span class="variable">$&#123;@:2&#125;</span></div><div class="line">    ;;</div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure>
<p>示例Dockerfile:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<p>可以使用如下命令运行该镜像:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 运行开发版本</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> our-app dev </span></div><div class="line"></div><div class="line"><span class="comment"># 运行生产版本</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> our-app start </span></div><div class="line"></div><div class="line"><span class="comment"># 运行bash</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> -it our-app /bin/bash</span></div></pre></td></tr></table></figure>
<h4 id="COPY与ADD优先使用前者"><a href="#COPY与ADD优先使用前者" class="headerlink" title="COPY与ADD优先使用前者"></a>COPY与ADD优先使用前者</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="合理调整COPY与RUN的顺序"><a href="#合理调整COPY与RUN的顺序" class="headerlink" title="合理调整COPY与RUN的顺序"></a>合理调整COPY与RUN的顺序</h4><p>我们应该把变化最少的部分放在Dockerfile的前面，这样可以充分利用镜像缓存。</p>
<p>示例中，源代码会经常变化，则每次构建镜像时都需要重新安装NPM模块，这显然不是我们希望看到的。因此我们可以先拷贝package.json，然后安装NPM模块，最后才拷贝其余的源代码。这样的话，即使源代码变化，也不需要重新安装NPM模块。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="设置默认的环境变量，映射端口和数据卷"><a href="#设置默认的环境变量，映射端口和数据卷" class="headerlink" title="设置默认的环境变量，映射端口和数据卷"></a>设置默认的环境变量，映射端口和数据卷</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">ENV</span> PROJECT_DIR=/app</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json <span class="variable">$PROJECT_DIR</span>  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> MEDIA_DIR=/media \  </div><div class="line">    NODE_ENV=production \</div><div class="line">    APP_PORT=<span class="number">3000</span></div><div class="line"></div><div class="line"><span class="keyword">VOLUME</span><span class="bash"> <span class="variable">$MEDIA_DIR</span>  </span></div><div class="line"><span class="keyword">EXPOSE</span> $APP_PORT</div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="添加HEALTHCHECK"><a href="#添加HEALTHCHECK" class="headerlink" title="添加HEALTHCHECK"></a>添加HEALTHCHECK</h4><p>运行容器时，可以指定–restart always选项。这样的话，容器崩溃时，Docker守护进程(docker daemon)会重启容器。对于需要长时间运行的容器，这个选项非常有用。但是，如果容器的确在运行，但是不可(陷入死循环，配置错误)用怎么办？使用HEALTHCHECK指令可以让Docker周期性的检查容器的健康状况。我们只需要指定一个命令，如果一切正常的话返回0，否则返回1。示例如下:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine  </div><div class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer <span class="string">"jakub.skalecki@example.com"</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> PROJECT_DIR=/app  </div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json <span class="variable">$PROJECT_DIR</span>  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> MEDIA_DIR=/media \  </div><div class="line">    NODE_ENV=production \</div><div class="line">    APP_PORT=<span class="number">3000</span></div><div class="line"></div><div class="line"><span class="keyword">VOLUME</span><span class="bash"> <span class="variable">$MEDIA_DIR</span>  </span></div><div class="line"><span class="keyword">EXPOSE</span> $APP_PORT  </div><div class="line"><span class="keyword">HEALTHCHECK</span><span class="bash"> CMD curl --fail http://localhost:<span class="variable">$APP_PORT</span> || <span class="built_in">exit</span> 1</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/18/记-给公司Unity组实现的数据库缓存类/" itemprop="url">
                  记_给公司Unity小组实现的基于Sqlite缓存Cache类
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-18T10:28:51+08:00" content="2019-04-18">
              2019-04-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/18/记-给公司Unity组实现的数据库缓存类/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/18/记-给公司Unity组实现的数据库缓存类/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><ol>
<li>所有线上接口管理至本地缓存</li>
<li>使用面向对象</li>
<li>db使用sqlite</li>
</ol>
<h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><p>线上拉取数据,缓存至本地,读取本地版本,对比线上版本号,如有更新,更新本地数据库数据,如没有,则读取本地.</p>
<h3 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h3><blockquote>
<p><code>IDbDao.cs</code> 接口定义</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.DbDao</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface IDbDao&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">void</span> setCache(<span class="built_in">string</span> r);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>CacheOption.cs</code> 实现</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Linq;</div><div class="line">using System.Text;</div><div class="line">using Assets.Scripts.Repository;</div><div class="line">using Assets.Scripts.Model;</div><div class="line">using Assets.Scripts.Infrastructure;</div><div class="line">using UnityEngine;</div><div class="line">using Newtonsoft.Json;</div><div class="line"></div><div class="line">namespace Assets.Scripts.DbDao</div><div class="line">&#123;</div><div class="line">    public <span class="keyword">class</span> CacheOption&lt;T&gt; : IDbDao&lt;T&gt; where T : <span class="keyword">class</span>, new()</div><div class="line">    &#123;</div><div class="line">        public void setCache_dbPath(string r, string path, bool is_append = false)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> repository = new RemoteRepository&lt;GetStruct&gt;();</div><div class="line">            repository.Get&lt;Response&lt;T&gt;&gt;(r, (response) =&gt;</div><div class="line">            &#123;</div><div class="line">                Debug.<span class="built_in">Log</span>(JsonConvert.SerializeObject(response));</div><div class="line">                <span class="keyword">if</span> (response.<span class="keyword">List</span> != null &amp;&amp; response.<span class="keyword">List</span>.<span class="keyword">Count</span> != 0)</div><div class="line">                &#123;</div><div class="line">                   </div><div class="line">                    <span class="keyword">var</span> <span class="keyword">db</span> = new DbRepository&lt;T&gt;();</div><div class="line">                    <span class="keyword">db</span>.CreateDb(path);</div><div class="line">                    <span class="keyword">if</span> (!is_append)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">db</span>.DropTable();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">db</span>.CreateTable();</div><div class="line">                    <span class="keyword">db</span>.InsertAll(response.<span class="keyword">List</span>);<span class="comment">//更新远程数据源</span></div><div class="line">                    <span class="keyword">db</span>.<span class="keyword">Close</span>();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                &#123;</div><div class="line">                    Debug.<span class="built_in">Log</span>(<span class="string">"Struct List data is null "</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//实现写入缓存共有类</span></div><div class="line">        public void setCache(string r)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> repository = new RemoteRepository&lt;GetStruct&gt;();</div><div class="line"></div><div class="line">            <span class="keyword">var</span> <span class="keyword">version</span> = new DbRepository&lt;TableVersions&gt;();</div><div class="line">            <span class="keyword">version</span>.DataService(<span class="string">"vesali.db"</span>);</div><div class="line">            <span class="keyword">version</span>.CreateTable();</div><div class="line">            TableVersions tv = <span class="keyword">version</span>.SelectOne&lt;TableVersions&gt;((tmpT) =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (tmpT.table_name == <span class="keyword">typeof</span>(T).Name)</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">return</span> true;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> false;</div><div class="line"></div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">var</span> struct_version = <span class="string">"-1"</span>;</div><div class="line">            <span class="keyword">if</span> (tv != null)</div><div class="line">            &#123;</div><div class="line">                struct_version = tv.<span class="keyword">version</span>;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            </div><div class="line">            repository.Get&lt;Response&lt;T&gt;&gt;(r, new GetStruct &#123; <span class="keyword">Version</span> = struct_version, device = SystemInfo.deviceUniqueIdentifier, os = Enum.GetName(<span class="keyword">typeof</span>(asset_platform), PublicClass.platform) , level = ((int)PublicClass.Quality).<span class="keyword">ToString</span>(), softVersion = PublicClass.get_version() &#125;, (response) =&gt;</div><div class="line">                       &#123;</div><div class="line">                           <span class="keyword">if</span> (response.<span class="keyword">List</span> != null &amp;&amp; response.<span class="keyword">List</span>.<span class="keyword">Count</span> != 0)</div><div class="line">                           &#123;</div><div class="line">                               Debug.<span class="built_in">Log</span>(<span class="string">"============读取数据库缓存更新，从远程拉取数据，更新版本号=================== "</span>);</div><div class="line">                               <span class="comment">//如果有数据,更新数据和版本</span></div><div class="line">                               <span class="keyword">if</span> (tv == null)</div><div class="line">                               &#123;</div><div class="line">                                   <span class="keyword">version</span>.Insert(new TableVersions &#123; table_name = <span class="keyword">typeof</span>(T).Name, <span class="keyword">version</span> = response.maxVersion &#125;);</div><div class="line">                               &#125;</div><div class="line">                               <span class="keyword">else</span></div><div class="line">                               &#123;</div><div class="line">                                   <span class="keyword">version</span>.<span class="keyword">Update</span>(new TableVersions &#123; table_name = <span class="keyword">typeof</span>(T).Name, <span class="keyword">version</span> = response.maxVersion &#125;);</div><div class="line">                               &#125;</div><div class="line">                               <span class="keyword">version</span>.<span class="keyword">Close</span>();</div><div class="line">                               <span class="keyword">var</span> <span class="keyword">db</span> = new DbRepository&lt;T&gt;();</div><div class="line">                               <span class="keyword">db</span>.DataService(<span class="string">"vesali.db"</span>);</div><div class="line">                               <span class="keyword">db</span>.DropTable();</div><div class="line">                               <span class="keyword">db</span>.CreateTable();</div><div class="line">                               <span class="keyword">db</span>.InsertAll(response.<span class="keyword">List</span>);<span class="comment">//更新远程数据源</span></div><div class="line">                               <span class="keyword">db</span>.<span class="keyword">Close</span>();</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">else</span></div><div class="line">                           &#123;</div><div class="line">                               Debug.<span class="built_in">Log</span>(<span class="string">"Struct List data is null "</span>);</div><div class="line">                               <span class="comment">// Debug.Log("============读取数据库缓存=================== ");</span></div><div class="line">                               <span class="comment">//读取数据库缓存</span></div><div class="line">                           &#125;</div><div class="line">                           PublicClass.data_list_count++;</div><div class="line">                       &#125;);</div><div class="line">            <span class="comment">//throw new NotImplementedException();</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>IRepository.cs</code> 对基本数据操作接口定义,如增删改查</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface IRepository&lt;T&gt; where T:<span class="keyword">class</span>,<span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">void</span> Insert(T instance);</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Delete</span><span class="params">(T instance)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Update</span><span class="params">(T instance)</span></span>;</div><div class="line">        IEnumerable&lt;T&gt; Select(Func&lt;T,<span class="keyword">bool</span>&gt; func );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p> <code>DbRepository.cs</code>数据库脚本实现</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.IO;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> SQLite4Unity3d;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> DbRepository&lt;T&gt; : IRepository&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="comment">//public delegate void DoConnection(String str);</span></div><div class="line">        <span class="keyword">private</span> SQLiteConnection _connection;</div><div class="line">        <span class="comment">//private string v;</span></div><div class="line"></div><div class="line">        <span class="comment">//public DbRepository(string v)</span></div><div class="line">        <span class="comment">//&#123;</span></div><div class="line">        <span class="comment">//    this.v = v;</span></div><div class="line">        <span class="comment">//&#125;</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateTable</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            _connection.CreateTable&lt;T&gt;();</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> TableQuery&lt;T&gt; getTableQuerry()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;();</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DropTable</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            _connection.DropTable&lt;T&gt;();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Delete</span><span class="params">(T instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Delete(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span><span class="params">(T instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Insert(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InsertAll</span><span class="params">(T[] instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.InsertAll(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InsertAll</span><span class="params">(List&lt;T&gt; instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.InsertAll(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> T SelectOne&lt;R&gt;(Func&lt;T, <span class="keyword">bool</span>&gt; func) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;().Where(func).FirstOrDefault();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> IEnumerable&lt;T&gt; Select&lt;R&gt;(Func&lt;T, <span class="keyword">bool</span>&gt; func) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;().Where(func);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span><span class="params">(T t)</span></span></div><div class="line">        &#123;</div><div class="line"></div><div class="line">            _connection.Update(t);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Close();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateDb</span><span class="params">(<span class="built_in">string</span> dbPath)</span></span></div><div class="line">        &#123;</div><div class="line">            _connection = <span class="keyword">new</span> SQLiteConnection(dbPath, SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DataService</span><span class="params">(<span class="built_in">string</span> DatabaseName)</span></span></div><div class="line">        &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></div><div class="line">            var dbPath = <span class="built_in">string</span>.Format(<span class="string">"&#123;0&#125;/&#123;1&#125;"</span>, PublicClass.vesal_db_path, DatabaseName); <span class="comment">//string.Format(@"Assets/StreamingAssets/&#123;0&#125;", DatabaseName);</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">        </div><div class="line"></div><div class="line">        var filepath = <span class="built_in">string</span>.Format(<span class="string">"&#123;0&#125;/&#123;1&#125;"</span>,PublicClass.vesal_db_path, DatabaseName);</div><div class="line"></div><div class="line">       </div><div class="line"></div><div class="line">        var dbPath = filepath;</div><div class="line">        <span class="comment">// var dbPath = loadDb;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">            _connection = <span class="keyword">new</span> SQLiteConnection(dbPath, SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create);</div><div class="line">            <span class="comment">//DebugLog.DebugLogInfo("Final PATH: " + dbPath);</span></div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> IEnumerable&lt;T&gt; Select(Func&lt;T, <span class="keyword">bool</span>&gt; func)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>RemoteRepository.cs</code> 接口类实现</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> Assets.Scripts.Infrastructure;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> Assets.Scripts.Network;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> Newtonsoft.Json;</div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> RemoteRepository&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> ISerializer Serializer &#123; <span class="built_in">get</span>; set; &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> RemoteRepository(ISerializer serializer = null)</div><div class="line">        &#123;</div><div class="line">            Serializer = serializer ?? SerializerJson.Instance;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Get&lt;R&gt;(<span class="keyword">string</span> url, T instance, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            var parameters = HttpUtility.BuildParameters(instance, <span class="keyword">new</span> StringBuilder(<span class="string">"?"</span>));</div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Get,</div><div class="line">                Parameters = parameters</div><div class="line">            &#125;;</div><div class="line">            Debug.Log(httpRequest.Url + httpRequest.Parameters);</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    R r = JsonConvert.DeserializeObject&lt;R&gt;(httpResponse.Data);</div><div class="line">                    onSuccess(r);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//<span class="doctag">TODO:</span>异常处理</span></div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Get&lt;R&gt;(<span class="keyword">string</span> url, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// var parameters = HttpUtility.BuildParameters(instance, new StringBuilder("?"));</span></div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Get,</div><div class="line">                <span class="comment">// Parameters = parameters</span></div><div class="line">            &#125;;</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    R r = JsonConvert.DeserializeObject&lt;R&gt;(httpResponse.Data);</div><div class="line">                    Debug.Log(<span class="string">"json str :"</span> + r);</div><div class="line">                    onSuccess(r);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//<span class="doctag">TODO:</span>异常处理</span></div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Post&lt;R&gt;(<span class="keyword">string</span> url, T instance, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            var parameters = HttpUtility.BuildParameters(instance, <span class="keyword">new</span> StringBuilder());</div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Post,</div><div class="line">                Parameters = parameters</div><div class="line">            &#125;;</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    <span class="comment">//<span class="doctag">TODO:</span>判断是否有Data</span></div><div class="line">                    onSuccess(Serializer.Deserialize&lt;R&gt;(httpResponse.Data));</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Test()</div><div class="line">        &#123;</div><div class="line">            Debug.Log(<span class="string">"Hello..."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>Response.cs</code></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    [System.Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> Response&lt;T&gt;</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> msg;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> code;</div><div class="line">        <span class="keyword">public</span> List&lt;T&gt; List;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> maxVersion;</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>HttpUtility.cs</code> http操作类</p>
</blockquote>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line">namespace Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtility</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> string BuildParameters&lt;T&gt;(T instance, StringBuilder sb) where T:<span class="type">class</span>,<span class="keyword">new</span><span class="type"></span>()</div><div class="line">        &#123;</div><div class="line">            foreach (<span class="keyword">var</span> property <span class="keyword">in</span> instance.GetType().GetProperties())</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">var</span> propertyName = property.Name;</div><div class="line">                <span class="keyword">var</span> value = property.GetValue(instance, <span class="literal">null</span>);</div><div class="line">                sb.Append(propertyName + <span class="string">"="</span> + value + <span class="string">"&amp;"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> sb.ToString().TrimEnd(<span class="string">'&amp;'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>ISerializer.cs</code> 格式化接口 </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface ISerializer</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">string</span> Serialize&lt;T&gt;(T obj, <span class="keyword">bool</span> readableOutput = <span class="literal">false</span>) where T : <span class="keyword">class</span>, <span class="keyword">new</span>();</div><div class="line">        T Deserialize&lt;T&gt;(<span class="built_in">string</span> json) where T : <span class="keyword">class</span>, <span class="keyword">new</span>();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>SerializerJson.cs</code> </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> SerializerJson:ISerializer</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> readonly SerializerJson Instance=<span class="keyword">new</span> SerializerJson();</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">SerializerJson</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Serialize&lt;T&gt;(T obj, <span class="keyword">bool</span> readableOutput = <span class="literal">false</span>) where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> T Deserialize&lt;T&gt;(<span class="built_in">string</span> json) where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> JsonUtility.FromJson&lt;T&gt;(json);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>SQLite.cs</code></p>
</blockquote>
<p><a href="https://gist.github.com/peterfei/69f98addc648163cd61ca63b9f53ef68" target="_blank" rel="external">查看源码</a></p>
<blockquote>
<p><code>HttpMethod.cs</code></p>
</blockquote>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Linq;</div><div class="line">using System.Text;</div><div class="line"></div><div class="line">namespace Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    public <span class="class"><span class="keyword">enum</span> <span class="title">HttpMethod</span></span></div><div class="line">    &#123;</div><div class="line">        Get,</div><div class="line">        Post</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Model实例"><a href="#Model实例" class="headerlink" title="Model实例"></a>Model实例</h3><blockquote>
<p><code>TableVersions.cs</code></p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> SQLite4Unity3d;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Assets.Scripts.Model</span></div><div class="line">&#123;</div><div class="line">    [Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TableVersions</span></div><div class="line">    &#123;</div><div class="line">        [PrimaryKey]</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> table_name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> version &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">       </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>GetStruct.cs</code> </p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Assets.Scripts.Model</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">class</span> <span class="title">GetStruct</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Version &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> UpdateUrlUuid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> device &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> os &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> level &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> softVersion &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> cache_CommonLib = <span class="keyword">new</span> <span class="type">CacheOption</span>&lt;GetStruct&gt;();</div><div class="line">cache_CommonLib.setCache(PublicClass.server_ip+<span class="string">'v1/app/api'</span>)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/17/docker笔记01/" itemprop="url">
                  docker笔记01
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-17T18:16:56+08:00" content="2019-04-17">
              2019-04-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/17/docker笔记01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/17/docker笔记01/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h3><p>Mac 上的安装<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">brew </span>cask <span class="keyword">install </span>docker</div></pre></td></tr></table></figure></p>
<p>安装完成之后，执行 hello-world 试一下:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker <span class="keyword">run</span><span class="bash"> hello-world</span></div></pre></td></tr></table></figure>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Hello <span class="built_in">from</span> Docker!</div><div class="line">This message shows that your installation appears <span class="built_in">to</span> be working correctly.</div><div class="line"></div><div class="line">To generate this message, Docker took <span class="keyword">the</span> following steps:</div><div class="line"> <span class="number">1.</span> The Docker client contacted <span class="keyword">the</span> Docker daemon.</div><div class="line"> <span class="number">2.</span> The Docker daemon pulled <span class="keyword">the</span> <span class="string">"hello-world"</span> image <span class="built_in">from</span> <span class="keyword">the</span> Docker Hub.</div><div class="line">    (amd64)</div><div class="line"> <span class="number">3.</span> The Docker daemon created <span class="keyword">a</span> <span class="built_in">new</span> container <span class="built_in">from</span> that image which runs <span class="keyword">the</span></div><div class="line">    executable that produces <span class="keyword">the</span> output you are currently reading.</div><div class="line"> <span class="number">4.</span> The Docker daemon streamed that output <span class="built_in">to</span> <span class="keyword">the</span> Docker client, which sent <span class="keyword">it</span></div><div class="line">    <span class="built_in">to</span> your terminal.</div><div class="line"></div><div class="line">To <span class="keyword">try</span> something more ambitious, you can run <span class="keyword">an</span> Ubuntu container <span class="keyword">with</span>:</div><div class="line"> $ docker run -<span class="keyword">it</span> ubuntu bash</div><div class="line"></div><div class="line">Share images, automate workflows, <span class="keyword">and</span> more <span class="keyword">with</span> <span class="keyword">a</span> free Docker ID:</div><div class="line"> <span class="keyword">https</span>://hub.docker.com/</div><div class="line"></div><div class="line">For more examples <span class="keyword">and</span> ideas, visit:</div><div class="line"> <span class="keyword">https</span>://docs.docker.com/<span class="built_in">get</span>-started/</div></pre></td></tr></table></figure>
<h3 id="启动Nginx服务"><a href="#启动Nginx服务" class="headerlink" title="启动Nginx服务"></a>启动Nginx服务</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">run</span><span class="bash"> <span class="_">-d</span> -p 80:80 --restart=always  nginx:latest</span></div></pre></td></tr></table></figure>
<blockquote>
<p><code>-p</code> 表示宿主机IP:容器IP<br><code>--restart</code> 重启模式，设置 always，每次启动 docker 都会启动 nginx 容器</p>
</blockquote>
<h3 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker exec -<span class="keyword">it</span> <span class="number">4591552</span>a4185 bash</div></pre></td></tr></table></figure>
<p>参数说明：</p>
<blockquote>
<p><code>exec</code> 对容器操作<br><code>-it</code> 分配伪tty<br><code>4591552a4185</code>容器ID<br><code>bash</code>交互程序为bash</p>
</blockquote>
<p>Docker 提供数据挂载的功能，即可以指定容器内的某些路径映射到宿主机器上，修改命令，添加 -v 参数，启动新的容器。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p <span class="number">80</span>:<span class="number">80</span>  -v <span class="regexp">~/docker-demo/</span>nginx-<span class="string">htmls:</span><span class="regexp">/usr/</span>share<span class="regexp">/nginx/</span>html/ --restart=always  <span class="string">nginx:</span>latest</div></pre></td></tr></table></figure>
<blockquote>
<p>启动成功之后，docker 会帮你生成目录 ~/docker-demo/nginx-htmls</p>
</blockquote>
<h3 id="停止运行"><a href="#停止运行" class="headerlink" title="停止运行"></a>停止运行</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">stop</span> <span class="number">4591552</span>a4185</div></pre></td></tr></table></figure>
<h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker rm <span class="number">4591552</span>a4185</div></pre></td></tr></table></figure>
<h3 id="分配IP给宿主机"><a href="#分配IP给宿主机" class="headerlink" title="分配IP给宿主机"></a>分配IP给宿主机</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ifconfig lo0 alias <span class="number">192.168</span><span class="number">.64</span><span class="number">.0</span>/<span class="number">24</span></div></pre></td></tr></table></figure>
<p>访问 <code>http://192.168.64.0:8080</code> </p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://ruby-china-files.b0.upaiyun.com/user/big_avatar/5575.jpg"
               alt="peterfei" />
          <p class="site-author-name" itemprop="name">peterfei</p>
          <p class="site-description motion-element" itemprop="description">peterfei|技术|上主是我的牧者</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">74</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/peterfei" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">peterfei</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"peterfei"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  


</body>
</html>
