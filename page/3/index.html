<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="peterfei.me,peterfei" />





  <link rel="alternate" href="/atom.xml" title="Peterfei" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.0" />






<meta name="description" content="peterfei|技术|上主是我的牧者">
<meta property="og:type" content="website">
<meta property="og:title" content="Peterfei">
<meta property="og:url" content="http://peterfei.me/page/3/index.html">
<meta property="og:site_name" content="Peterfei">
<meta property="og:description" content="peterfei|技术|上主是我的牧者">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Peterfei">
<meta name="twitter:description" content="peterfei|技术|上主是我的牧者">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: '[object Object]',
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Peterfei </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Peterfei</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">上主是我的牧者，我实在一无所缺</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'PqEYgqEwUwFoXjgtngj9','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/18/如何编写Dockerfile/" itemprop="url">
                  如何编写Dockerfile
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-18T13:59:18+08:00" content="2019-04-18">
              2019-04-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/18/如何编写Dockerfile/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/18/如何编写Dockerfile/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>假设我们需要使用Docker运行一个Node.js应用</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get upgrade -y  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nodejs ssh mysql  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> mysql &amp; sshd &amp; npm start</span></div></pre></td></tr></table></figure>
<p>构建镜像:</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-t mydocker .</div></pre></td></tr></table></figure>
<h4 id="编写-dockerignore文件"><a href="#编写-dockerignore文件" class="headerlink" title="编写.dockerignore文件"></a>编写.dockerignore文件</h4><p>构建镜像时，Docker需要先准备context ，将所有需要的文件收集到进程中。默认的context包含Dockerfile目录中的所有文件，但是实际上，我们并不需要.git目录，node_modules目录等内容。 .dockerignore 的作用和语法类似于 .gitignore，可以忽略一些不需要的文件，这样可以有效加快镜像构建时间，同时减少Docker镜像的大小。示例如下:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="title">.git/</span></div><div class="line">node<span class="emphasis">_modules/</span></div></pre></td></tr></table></figure>
<h4 id="容器只运行单个应用"><a href="#容器只运行单个应用" class="headerlink" title="容器只运行单个应用"></a>容器只运行单个应用</h4><p>从技术角度讲，你可以在Docker容器中运行多个进程。你可以将数据库，前端，后端，ssh，supervisor都运行在同一个Docker容器中。但是，这会让你非常痛苦:</p>
<ul>
<li>非常长的构建时间(修改前端之后，整个后端也需要重新构建)</li>
<li>非常大的镜像大小</li>
<li>多个应用的日志难以处理</li>
<li>横向扩展时非常浪费资源(不同的应用需要运行的容器数并不相同)</li>
<li>僵尸进程问题 - 你需要选择合适的init进程</li>
</ul>
<p>因此，我建议大家为每个应用构建单独的Docker镜像，然后使用 Docker Compose 运行多个Docker容器。</p>
<p>现在，我从Dockerfile中删除一些不需要的安装包，另外，SSH可以用docker exec替代。示例如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get upgrade -y</span></div><div class="line"></div><div class="line"><span class="comment"># we should remove ssh and mysql, and use</span></div><div class="line"><span class="comment"># separate container for database </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nodejs  <span class="comment"># ssh mysql  </span></span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="将多个RUN指令合并为一个"><a href="#将多个RUN指令合并为一个" class="headerlink" title="将多个RUN指令合并为一个"></a>将多个RUN指令合并为一个</h4><p>Docker镜像是分层的，下面这些知识点非常重要:</p>
<ul>
<li>Dockerfile中的每个指令都会创建一个新的镜像层。</li>
<li>镜像层将被缓存和复用</li>
<li>当Dockerfile的指令修改了，复制的文件变化了，或者构建镜像时指定的变量不同了，对应的镜像层缓存就会失效</li>
<li>某一层的镜像缓存失效之后，它之后的镜像层缓存都会失效</li>
<li>镜像层是不可变的，如果我们再某一层中添加一个文件，然后在下一层中删除它，则镜像中依然会包含该文件(只是这个文件在Docker容器中不可见了)。</li>
</ul>
<p>Docker镜像类似于洋葱。它们都有很多层。为了修改内层，则需要将外面的层都删掉。记住这一点的话，其他内容就很好理解了。</p>
<p>现在，我们将所有的RUN指令合并为一个。同时把apt-get upgrade删除，因为它会使得镜像构建非常不确定(我们只需要依赖基础镜像的更新就好了)</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \  </span></div><div class="line">    &amp;&amp; apt-get install -y nodejs \</div><div class="line">    &amp;&amp; cd /app \</div><div class="line">    &amp;&amp; npm install</div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<p>记住一点，我们只能将变化频率一样的指令合并在一起。将node.js安装与npm模块安装放在一起的话，则每次修改源代码，都需要重新安装node.js，这显然不合适。因此，正确的写法是这样的:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y nodejs  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="基础镜像的标签不要用latest"><a href="#基础镜像的标签不要用latest" class="headerlink" title="基础镜像的标签不要用latest"></a>基础镜像的标签不要用latest</h4><p>当镜像没有指定标签时，将默认使用latest 标签。因此， FROM ubuntu 指令等同于FROM ubuntu:latest。当时，当镜像更新时，latest标签会指向不同的镜像，这时构建镜像有可能失败。如果你的确需要使用最新版的基础镜像，可以使用latest标签，否则的话，最好指定确定的镜像标签。</p>
<p>示例Dockerfile应该使用16.04作为标签。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">16.04</span>  <span class="comment"># it's that easy!</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y nodejs  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="每个RUN指令后删除多余文件"><a href="#每个RUN指令后删除多余文件" class="headerlink" title="每个RUN指令后删除多余文件"></a>每个RUN指令后删除多余文件</h4><p>假设我们更新了apt-get源，下载，解压并安装了一些软件包，它们都保存在/var/lib/apt/lists/目录中。但是，运行应用时Docker镜像中并不需要这些文件。我们最好将它们删除，因为它会使Docker镜像变大。</p>
<p>示例Dockerfile中，我们可以删除/var/lib/apt/lists/目录中的文件(它们是由apt-get update生成的)。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ROM ubuntu:<span class="number">16.04</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \  </span></div><div class="line">    &amp;&amp; apt-get install -y nodejs \</div><div class="line">    <span class="comment"># added lines</span></div><div class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/*</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="选择合适的基础镜像-alpine版本最好"><a href="#选择合适的基础镜像-alpine版本最好" class="headerlink" title="选择合适的基础镜像(alpine版本最好)"></a>选择合适的基础镜像(alpine版本最好)</h4><p>在示例中，我们选择了ubuntu作为基础镜像。但是我们只需要运行node程序，有必要使用一个通用的基础镜像吗？node镜像应该是更好的选择。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="comment"># we don't need to install node </span></div><div class="line"><span class="comment"># anymore and use apt-get</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<p>更好的选择是alpine版本的node镜像。alpine是一个极小化的Linux发行版，只有4MB，这让它非常适合作为基础镜像。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> npm start</span></div></pre></td></tr></table></figure>
<h4 id="设置WORKDIR和-CMD"><a href="#设置WORKDIR和-CMD" class="headerlink" title="设置WORKDIR和 CMD"></a>设置WORKDIR和 CMD</h4><p>WORKDIR指令可以设置默认目录，也就是运行RUN / CMD / ENTRYPOINT指令的地方。</p>
<p>CMD指令可以设置容器创建是执行的默认命令。另外，你应该讲命令写在一个数组中，数组中每个元素为命令的每个单词(参考<a href="https://docs.docker.com/engine/reference/builder/#cmd" target="_blank" rel="external">官方文档</a>)。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"npm"</span>, <span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="使用ENTRYPOINT-可选"><a href="#使用ENTRYPOINT-可选" class="headerlink" title="使用ENTRYPOINT (可选)"></a>使用ENTRYPOINT (可选)</h4><p>ENTRYPOINT指令并不是必须的，因为它会增加复杂度。ENTRYPOINT是一个脚本，它会默认执行，并且将指定的命令错误其参数。它通常用于构建可执行的Docker镜像。entrypoint.sh如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env sh</span></div><div class="line"><span class="comment"># $0 is a script name, </span></div><div class="line"><span class="comment"># $1, $2, $3 etc are passed arguments</span></div><div class="line"><span class="comment"># $1 is our command</span></div><div class="line">CMD=<span class="variable">$1</span></div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$CMD</span>"</span> <span class="keyword">in</span>  </div><div class="line">  <span class="string">"dev"</span> )</div><div class="line">    npm install</div><div class="line">    <span class="built_in">export</span> NODE_ENV=development</div><div class="line">    <span class="built_in">exec</span> npm run dev</div><div class="line">    ;;</div><div class="line"></div><div class="line">  <span class="string">"start"</span> )</div><div class="line">    <span class="comment"># we can modify files here, using ENV variables passed in </span></div><div class="line">    <span class="comment"># "docker create" command. It can't be done during build process.</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"db: <span class="variable">$DATABASE_ADDRESS</span>"</span> &gt;&gt; /app/config.yml</div><div class="line">    <span class="built_in">export</span> NODE_ENV=production</div><div class="line">    <span class="built_in">exec</span> npm start</div><div class="line">    ;;</div><div class="line"></div><div class="line">   * )</div><div class="line">    <span class="comment"># Run custom command. Thanks to this line we can still use </span></div><div class="line">    <span class="comment"># "docker run our_image /bin/bash" and it will work</span></div><div class="line">    <span class="built_in">exec</span> <span class="variable">$CMD</span> <span class="variable">$&#123;@:2&#125;</span></div><div class="line">    ;;</div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure>
<p>示例Dockerfile:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app  </span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<p>可以使用如下命令运行该镜像:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 运行开发版本</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> our-app dev </span></div><div class="line"></div><div class="line"><span class="comment"># 运行生产版本</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> our-app start </span></div><div class="line"></div><div class="line"><span class="comment"># 运行bash</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> -it our-app /bin/bash</span></div></pre></td></tr></table></figure>
<h4 id="COPY与ADD优先使用前者"><a href="#COPY与ADD优先使用前者" class="headerlink" title="COPY与ADD优先使用前者"></a>COPY与ADD优先使用前者</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="合理调整COPY与RUN的顺序"><a href="#合理调整COPY与RUN的顺序" class="headerlink" title="合理调整COPY与RUN的顺序"></a>合理调整COPY与RUN的顺序</h4><p>我们应该把变化最少的部分放在Dockerfile的前面，这样可以充分利用镜像缓存。</p>
<p>示例中，源代码会经常变化，则每次构建镜像时都需要重新安装NPM模块，这显然不是我们希望看到的。因此我们可以先拷贝package.json，然后安装NPM模块，最后才拷贝其余的源代码。这样的话，即使源代码变化，也不需要重新安装NPM模块。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json /app  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . /app</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="设置默认的环境变量，映射端口和数据卷"><a href="#设置默认的环境变量，映射端口和数据卷" class="headerlink" title="设置默认的环境变量，映射端口和数据卷"></a>设置默认的环境变量，映射端口和数据卷</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine</div><div class="line"></div><div class="line"><span class="keyword">ENV</span> PROJECT_DIR=/app</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json <span class="variable">$PROJECT_DIR</span>  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> MEDIA_DIR=/media \  </div><div class="line">    NODE_ENV=production \</div><div class="line">    APP_PORT=<span class="number">3000</span></div><div class="line"></div><div class="line"><span class="keyword">VOLUME</span><span class="bash"> <span class="variable">$MEDIA_DIR</span>  </span></div><div class="line"><span class="keyword">EXPOSE</span> $APP_PORT</div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="添加HEALTHCHECK"><a href="#添加HEALTHCHECK" class="headerlink" title="添加HEALTHCHECK"></a>添加HEALTHCHECK</h4><p>运行容器时，可以指定–restart always选项。这样的话，容器崩溃时，Docker守护进程(docker daemon)会重启容器。对于需要长时间运行的容器，这个选项非常有用。但是，如果容器的确在运行，但是不可(陷入死循环，配置错误)用怎么办？使用HEALTHCHECK指令可以让Docker周期性的检查容器的健康状况。我们只需要指定一个命令，如果一切正常的话返回0，否则返回1。示例如下:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> node:<span class="number">7</span>-alpine  </div><div class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer <span class="string">"jakub.skalecki@example.com"</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> PROJECT_DIR=/app  </div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> package.json <span class="variable">$PROJECT_DIR</span>  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> npm install  </span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> . <span class="variable">$PROJECT_DIR</span></span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> MEDIA_DIR=/media \  </div><div class="line">    NODE_ENV=production \</div><div class="line">    APP_PORT=<span class="number">3000</span></div><div class="line"></div><div class="line"><span class="keyword">VOLUME</span><span class="bash"> <span class="variable">$MEDIA_DIR</span>  </span></div><div class="line"><span class="keyword">EXPOSE</span> $APP_PORT  </div><div class="line"><span class="keyword">HEALTHCHECK</span><span class="bash"> CMD curl --fail http://localhost:<span class="variable">$APP_PORT</span> || <span class="built_in">exit</span> 1</span></div><div class="line"></div><div class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./entrypoint.sh"</span>]  </span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start"</span>]</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/18/记-给公司Unity组实现的数据库缓存类/" itemprop="url">
                  记_给公司Unity小组实现的基于Sqlite缓存Cache类
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-18T10:28:51+08:00" content="2019-04-18">
              2019-04-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/18/记-给公司Unity组实现的数据库缓存类/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/18/记-给公司Unity组实现的数据库缓存类/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><ol>
<li>所有线上接口管理至本地缓存</li>
<li>使用面向对象</li>
<li>db使用sqlite</li>
</ol>
<h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><p>线上拉取数据,缓存至本地,读取本地版本,对比线上版本号,如有更新,更新本地数据库数据,如没有,则读取本地.</p>
<h3 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h3><blockquote>
<p><code>IDbDao.cs</code> 接口定义</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.DbDao</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface IDbDao&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">void</span> setCache(<span class="built_in">string</span> r);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>CacheOption.cs</code> 实现</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Linq;</div><div class="line">using System.Text;</div><div class="line">using Assets.Scripts.Repository;</div><div class="line">using Assets.Scripts.Model;</div><div class="line">using Assets.Scripts.Infrastructure;</div><div class="line">using UnityEngine;</div><div class="line">using Newtonsoft.Json;</div><div class="line"></div><div class="line">namespace Assets.Scripts.DbDao</div><div class="line">&#123;</div><div class="line">    public <span class="keyword">class</span> CacheOption&lt;T&gt; : IDbDao&lt;T&gt; where T : <span class="keyword">class</span>, new()</div><div class="line">    &#123;</div><div class="line">        public void setCache_dbPath(string r, string path, bool is_append = false)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> repository = new RemoteRepository&lt;GetStruct&gt;();</div><div class="line">            repository.Get&lt;Response&lt;T&gt;&gt;(r, (response) =&gt;</div><div class="line">            &#123;</div><div class="line">                Debug.<span class="built_in">Log</span>(JsonConvert.SerializeObject(response));</div><div class="line">                <span class="keyword">if</span> (response.<span class="keyword">List</span> != null &amp;&amp; response.<span class="keyword">List</span>.<span class="keyword">Count</span> != 0)</div><div class="line">                &#123;</div><div class="line">                   </div><div class="line">                    <span class="keyword">var</span> <span class="keyword">db</span> = new DbRepository&lt;T&gt;();</div><div class="line">                    <span class="keyword">db</span>.CreateDb(path);</div><div class="line">                    <span class="keyword">if</span> (!is_append)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">db</span>.DropTable();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">db</span>.CreateTable();</div><div class="line">                    <span class="keyword">db</span>.InsertAll(response.<span class="keyword">List</span>);<span class="comment">//更新远程数据源</span></div><div class="line">                    <span class="keyword">db</span>.<span class="keyword">Close</span>();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                &#123;</div><div class="line">                    Debug.<span class="built_in">Log</span>(<span class="string">"Struct List data is null "</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//实现写入缓存共有类</span></div><div class="line">        public void setCache(string r)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> repository = new RemoteRepository&lt;GetStruct&gt;();</div><div class="line"></div><div class="line">            <span class="keyword">var</span> <span class="keyword">version</span> = new DbRepository&lt;TableVersions&gt;();</div><div class="line">            <span class="keyword">version</span>.DataService(<span class="string">"vesali.db"</span>);</div><div class="line">            <span class="keyword">version</span>.CreateTable();</div><div class="line">            TableVersions tv = <span class="keyword">version</span>.SelectOne&lt;TableVersions&gt;((tmpT) =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (tmpT.table_name == <span class="keyword">typeof</span>(T).Name)</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">return</span> true;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> false;</div><div class="line"></div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">var</span> struct_version = <span class="string">"-1"</span>;</div><div class="line">            <span class="keyword">if</span> (tv != null)</div><div class="line">            &#123;</div><div class="line">                struct_version = tv.<span class="keyword">version</span>;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            </div><div class="line">            repository.Get&lt;Response&lt;T&gt;&gt;(r, new GetStruct &#123; <span class="keyword">Version</span> = struct_version, device = SystemInfo.deviceUniqueIdentifier, os = Enum.GetName(<span class="keyword">typeof</span>(asset_platform), PublicClass.platform) , level = ((int)PublicClass.Quality).<span class="keyword">ToString</span>(), softVersion = PublicClass.get_version() &#125;, (response) =&gt;</div><div class="line">                       &#123;</div><div class="line">                           <span class="keyword">if</span> (response.<span class="keyword">List</span> != null &amp;&amp; response.<span class="keyword">List</span>.<span class="keyword">Count</span> != 0)</div><div class="line">                           &#123;</div><div class="line">                               Debug.<span class="built_in">Log</span>(<span class="string">"============读取数据库缓存更新，从远程拉取数据，更新版本号=================== "</span>);</div><div class="line">                               <span class="comment">//如果有数据,更新数据和版本</span></div><div class="line">                               <span class="keyword">if</span> (tv == null)</div><div class="line">                               &#123;</div><div class="line">                                   <span class="keyword">version</span>.Insert(new TableVersions &#123; table_name = <span class="keyword">typeof</span>(T).Name, <span class="keyword">version</span> = response.maxVersion &#125;);</div><div class="line">                               &#125;</div><div class="line">                               <span class="keyword">else</span></div><div class="line">                               &#123;</div><div class="line">                                   <span class="keyword">version</span>.<span class="keyword">Update</span>(new TableVersions &#123; table_name = <span class="keyword">typeof</span>(T).Name, <span class="keyword">version</span> = response.maxVersion &#125;);</div><div class="line">                               &#125;</div><div class="line">                               <span class="keyword">version</span>.<span class="keyword">Close</span>();</div><div class="line">                               <span class="keyword">var</span> <span class="keyword">db</span> = new DbRepository&lt;T&gt;();</div><div class="line">                               <span class="keyword">db</span>.DataService(<span class="string">"vesali.db"</span>);</div><div class="line">                               <span class="keyword">db</span>.DropTable();</div><div class="line">                               <span class="keyword">db</span>.CreateTable();</div><div class="line">                               <span class="keyword">db</span>.InsertAll(response.<span class="keyword">List</span>);<span class="comment">//更新远程数据源</span></div><div class="line">                               <span class="keyword">db</span>.<span class="keyword">Close</span>();</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">else</span></div><div class="line">                           &#123;</div><div class="line">                               Debug.<span class="built_in">Log</span>(<span class="string">"Struct List data is null "</span>);</div><div class="line">                               <span class="comment">// Debug.Log("============读取数据库缓存=================== ");</span></div><div class="line">                               <span class="comment">//读取数据库缓存</span></div><div class="line">                           &#125;</div><div class="line">                           PublicClass.data_list_count++;</div><div class="line">                       &#125;);</div><div class="line">            <span class="comment">//throw new NotImplementedException();</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>IRepository.cs</code> 对基本数据操作接口定义,如增删改查</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface IRepository&lt;T&gt; where T:<span class="keyword">class</span>,<span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">void</span> Insert(T instance);</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Delete</span><span class="params">(T instance)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Update</span><span class="params">(T instance)</span></span>;</div><div class="line">        IEnumerable&lt;T&gt; Select(Func&lt;T,<span class="keyword">bool</span>&gt; func );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p> <code>DbRepository.cs</code>数据库脚本实现</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.IO;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> SQLite4Unity3d;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> DbRepository&lt;T&gt; : IRepository&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="comment">//public delegate void DoConnection(String str);</span></div><div class="line">        <span class="keyword">private</span> SQLiteConnection _connection;</div><div class="line">        <span class="comment">//private string v;</span></div><div class="line"></div><div class="line">        <span class="comment">//public DbRepository(string v)</span></div><div class="line">        <span class="comment">//&#123;</span></div><div class="line">        <span class="comment">//    this.v = v;</span></div><div class="line">        <span class="comment">//&#125;</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateTable</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            _connection.CreateTable&lt;T&gt;();</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> TableQuery&lt;T&gt; getTableQuerry()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;();</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DropTable</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            _connection.DropTable&lt;T&gt;();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Delete</span><span class="params">(T instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Delete(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span><span class="params">(T instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Insert(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InsertAll</span><span class="params">(T[] instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.InsertAll(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InsertAll</span><span class="params">(List&lt;T&gt; instance)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.InsertAll(instance);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> T SelectOne&lt;R&gt;(Func&lt;T, <span class="keyword">bool</span>&gt; func) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;().Where(func).FirstOrDefault();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> IEnumerable&lt;T&gt; Select&lt;R&gt;(Func&lt;T, <span class="keyword">bool</span>&gt; func) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> _connection.Table&lt;T&gt;().Where(func);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span><span class="params">(T t)</span></span></div><div class="line">        &#123;</div><div class="line"></div><div class="line">            _connection.Update(t);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                _connection.Close();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (Exception e)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.ToString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateDb</span><span class="params">(<span class="built_in">string</span> dbPath)</span></span></div><div class="line">        &#123;</div><div class="line">            _connection = <span class="keyword">new</span> SQLiteConnection(dbPath, SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DataService</span><span class="params">(<span class="built_in">string</span> DatabaseName)</span></span></div><div class="line">        &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></div><div class="line">            var dbPath = <span class="built_in">string</span>.Format(<span class="string">"&#123;0&#125;/&#123;1&#125;"</span>, PublicClass.vesal_db_path, DatabaseName); <span class="comment">//string.Format(@"Assets/StreamingAssets/&#123;0&#125;", DatabaseName);</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">        </div><div class="line"></div><div class="line">        var filepath = <span class="built_in">string</span>.Format(<span class="string">"&#123;0&#125;/&#123;1&#125;"</span>,PublicClass.vesal_db_path, DatabaseName);</div><div class="line"></div><div class="line">       </div><div class="line"></div><div class="line">        var dbPath = filepath;</div><div class="line">        <span class="comment">// var dbPath = loadDb;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">            _connection = <span class="keyword">new</span> SQLiteConnection(dbPath, SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create);</div><div class="line">            <span class="comment">//DebugLog.DebugLogInfo("Final PATH: " + dbPath);</span></div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> IEnumerable&lt;T&gt; Select(Func&lt;T, <span class="keyword">bool</span>&gt; func)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>RemoteRepository.cs</code> 接口类实现</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> Assets.Scripts.Infrastructure;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> Assets.Scripts.Network;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> Newtonsoft.Json;</div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Repository</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> RemoteRepository&lt;T&gt; where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> ISerializer Serializer &#123; <span class="built_in">get</span>; set; &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> RemoteRepository(ISerializer serializer = null)</div><div class="line">        &#123;</div><div class="line">            Serializer = serializer ?? SerializerJson.Instance;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Get&lt;R&gt;(<span class="keyword">string</span> url, T instance, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            var parameters = HttpUtility.BuildParameters(instance, <span class="keyword">new</span> StringBuilder(<span class="string">"?"</span>));</div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Get,</div><div class="line">                Parameters = parameters</div><div class="line">            &#125;;</div><div class="line">            Debug.Log(httpRequest.Url + httpRequest.Parameters);</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    R r = JsonConvert.DeserializeObject&lt;R&gt;(httpResponse.Data);</div><div class="line">                    onSuccess(r);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//<span class="doctag">TODO:</span>异常处理</span></div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Get&lt;R&gt;(<span class="keyword">string</span> url, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// var parameters = HttpUtility.BuildParameters(instance, new StringBuilder("?"));</span></div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Get,</div><div class="line">                <span class="comment">// Parameters = parameters</span></div><div class="line">            &#125;;</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    R r = JsonConvert.DeserializeObject&lt;R&gt;(httpResponse.Data);</div><div class="line">                    Debug.Log(<span class="string">"json str :"</span> + r);</div><div class="line">                    onSuccess(r);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//<span class="doctag">TODO:</span>异常处理</span></div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Post&lt;R&gt;(<span class="keyword">string</span> url, T instance, Action&lt;R&gt; onSuccess) where R : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            var parameters = HttpUtility.BuildParameters(instance, <span class="keyword">new</span> StringBuilder());</div><div class="line">            var httpRequest = <span class="keyword">new</span> HttpRequest</div><div class="line">            &#123;</div><div class="line">                Url = url,</div><div class="line">                Method = HttpMethod.Post,</div><div class="line">                Parameters = parameters</div><div class="line">            &#125;;</div><div class="line">            <span class="built_in">HttpClient</span>.Instance.SendAsync(httpRequest, httpResponse =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">if</span> (httpResponse.IsSuccess)</div><div class="line">                &#123;</div><div class="line">                    <span class="comment">//<span class="doctag">TODO:</span>判断是否有Data</span></div><div class="line">                    onSuccess(Serializer.Deserialize&lt;R&gt;(httpResponse.Data));</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Test()</div><div class="line">        &#123;</div><div class="line">            Debug.Log(<span class="string">"Hello..."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>Response.cs</code></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    [System.Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> Response&lt;T&gt;</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> msg;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> code;</div><div class="line">        <span class="keyword">public</span> List&lt;T&gt; List;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> maxVersion;</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>HttpUtility.cs</code> http操作类</p>
</blockquote>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line">namespace Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtility</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> string BuildParameters&lt;T&gt;(T instance, StringBuilder sb) where T:<span class="type">class</span>,<span class="keyword">new</span><span class="type"></span>()</div><div class="line">        &#123;</div><div class="line">            foreach (<span class="keyword">var</span> property <span class="keyword">in</span> instance.GetType().GetProperties())</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">var</span> propertyName = property.Name;</div><div class="line">                <span class="keyword">var</span> value = property.GetValue(instance, <span class="literal">null</span>);</div><div class="line">                sb.Append(propertyName + <span class="string">"="</span> + value + <span class="string">"&amp;"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> sb.ToString().TrimEnd(<span class="string">'&amp;'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>ISerializer.cs</code> 格式化接口 </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> interface ISerializer</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">string</span> Serialize&lt;T&gt;(T obj, <span class="keyword">bool</span> readableOutput = <span class="literal">false</span>) where T : <span class="keyword">class</span>, <span class="keyword">new</span>();</div><div class="line">        T Deserialize&lt;T&gt;(<span class="built_in">string</span> json) where T : <span class="keyword">class</span>, <span class="keyword">new</span>();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>SerializerJson.cs</code> </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> SerializerJson:ISerializer</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> readonly SerializerJson Instance=<span class="keyword">new</span> SerializerJson();</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">SerializerJson</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Serialize&lt;T&gt;(T obj, <span class="keyword">bool</span> readableOutput = <span class="literal">false</span>) where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> T Deserialize&lt;T&gt;(<span class="built_in">string</span> json) where T : <span class="keyword">class</span>, <span class="keyword">new</span>()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> JsonUtility.FromJson&lt;T&gt;(json);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>SQLite.cs</code></p>
</blockquote>
<p><a href="https://gist.github.com/peterfei/69f98addc648163cd61ca63b9f53ef68" target="_blank" rel="external">查看源码</a></p>
<blockquote>
<p><code>HttpMethod.cs</code></p>
</blockquote>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Linq;</div><div class="line">using System.Text;</div><div class="line"></div><div class="line">namespace Assets.Scripts.Infrastructure</div><div class="line">&#123;</div><div class="line">    public <span class="class"><span class="keyword">enum</span> <span class="title">HttpMethod</span></span></div><div class="line">    &#123;</div><div class="line">        Get,</div><div class="line">        Post</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Model实例"><a href="#Model实例" class="headerlink" title="Model实例"></a>Model实例</h3><blockquote>
<p><code>TableVersions.cs</code></p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> SQLite4Unity3d;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Assets.Scripts.Model</span></div><div class="line">&#123;</div><div class="line">    [Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TableVersions</span></div><div class="line">    &#123;</div><div class="line">        [PrimaryKey]</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> table_name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> version &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">       </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>GetStruct.cs</code> </p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Assets.Scripts.Model</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">class</span> <span class="title">GetStruct</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Version &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> UpdateUrlUuid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> device &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> os &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> level &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> softVersion &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> cache_CommonLib = <span class="keyword">new</span> <span class="type">CacheOption</span>&lt;GetStruct&gt;();</div><div class="line">cache_CommonLib.setCache(PublicClass.server_ip+<span class="string">'v1/app/api'</span>)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/17/docker笔记01/" itemprop="url">
                  docker笔记01
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-17T18:16:56+08:00" content="2019-04-17">
              2019-04-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/17/docker笔记01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/17/docker笔记01/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h3><p>Mac 上的安装<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">brew </span>cask <span class="keyword">install </span>docker</div></pre></td></tr></table></figure></p>
<p>安装完成之后，执行 hello-world 试一下:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker <span class="keyword">run</span><span class="bash"> hello-world</span></div></pre></td></tr></table></figure>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Hello <span class="built_in">from</span> Docker!</div><div class="line">This message shows that your installation appears <span class="built_in">to</span> be working correctly.</div><div class="line"></div><div class="line">To generate this message, Docker took <span class="keyword">the</span> following steps:</div><div class="line"> <span class="number">1.</span> The Docker client contacted <span class="keyword">the</span> Docker daemon.</div><div class="line"> <span class="number">2.</span> The Docker daemon pulled <span class="keyword">the</span> <span class="string">"hello-world"</span> image <span class="built_in">from</span> <span class="keyword">the</span> Docker Hub.</div><div class="line">    (amd64)</div><div class="line"> <span class="number">3.</span> The Docker daemon created <span class="keyword">a</span> <span class="built_in">new</span> container <span class="built_in">from</span> that image which runs <span class="keyword">the</span></div><div class="line">    executable that produces <span class="keyword">the</span> output you are currently reading.</div><div class="line"> <span class="number">4.</span> The Docker daemon streamed that output <span class="built_in">to</span> <span class="keyword">the</span> Docker client, which sent <span class="keyword">it</span></div><div class="line">    <span class="built_in">to</span> your terminal.</div><div class="line"></div><div class="line">To <span class="keyword">try</span> something more ambitious, you can run <span class="keyword">an</span> Ubuntu container <span class="keyword">with</span>:</div><div class="line"> $ docker run -<span class="keyword">it</span> ubuntu bash</div><div class="line"></div><div class="line">Share images, automate workflows, <span class="keyword">and</span> more <span class="keyword">with</span> <span class="keyword">a</span> free Docker ID:</div><div class="line"> <span class="keyword">https</span>://hub.docker.com/</div><div class="line"></div><div class="line">For more examples <span class="keyword">and</span> ideas, visit:</div><div class="line"> <span class="keyword">https</span>://docs.docker.com/<span class="built_in">get</span>-started/</div></pre></td></tr></table></figure>
<h3 id="启动Nginx服务"><a href="#启动Nginx服务" class="headerlink" title="启动Nginx服务"></a>启动Nginx服务</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">run</span><span class="bash"> <span class="_">-d</span> -p 80:80 --restart=always  nginx:latest</span></div></pre></td></tr></table></figure>
<blockquote>
<p><code>-p</code> 表示宿主机IP:容器IP<br><code>--restart</code> 重启模式，设置 always，每次启动 docker 都会启动 nginx 容器</p>
</blockquote>
<h3 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker exec -<span class="keyword">it</span> <span class="number">4591552</span>a4185 bash</div></pre></td></tr></table></figure>
<p>参数说明：</p>
<blockquote>
<p><code>exec</code> 对容器操作<br><code>-it</code> 分配伪tty<br><code>4591552a4185</code>容器ID<br><code>bash</code>交互程序为bash</p>
</blockquote>
<p>Docker 提供数据挂载的功能，即可以指定容器内的某些路径映射到宿主机器上，修改命令，添加 -v 参数，启动新的容器。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p <span class="number">80</span>:<span class="number">80</span>  -v <span class="regexp">~/docker-demo/</span>nginx-<span class="string">htmls:</span><span class="regexp">/usr/</span>share<span class="regexp">/nginx/</span>html/ --restart=always  <span class="string">nginx:</span>latest</div></pre></td></tr></table></figure>
<blockquote>
<p>启动成功之后，docker 会帮你生成目录 ~/docker-demo/nginx-htmls</p>
</blockquote>
<h3 id="停止运行"><a href="#停止运行" class="headerlink" title="停止运行"></a>停止运行</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">stop</span> <span class="number">4591552</span>a4185</div></pre></td></tr></table></figure>
<h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker rm <span class="number">4591552</span>a4185</div></pre></td></tr></table></figure>
<h3 id="分配IP给宿主机"><a href="#分配IP给宿主机" class="headerlink" title="分配IP给宿主机"></a>分配IP给宿主机</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ifconfig lo0 alias <span class="number">192.168</span><span class="number">.64</span><span class="number">.0</span>/<span class="number">24</span></div></pre></td></tr></table></figure>
<p>访问 <code>http://192.168.64.0:8080</code> </p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/11/ReactNative之Realm预加载数据/" itemprop="url">
                  ReactNative之Realm预加载数据
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-11T11:28:51+08:00" content="2019-04-11">
              2019-04-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/11/ReactNative之Realm预加载数据/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/11/ReactNative之Realm预加载数据/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>realm 数据预加载</p>
</blockquote>
<h5 id="Require-Env"><a href="#Require-Env" class="headerlink" title="Require Env:"></a>Require Env:</h5><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">npm</span> i realm</div><div class="line"><span class="built_in">npm</span> i react-<span class="keyword">native</span>-fs</div><div class="line">react-<span class="keyword">native</span> link</div></pre></td></tr></table></figure>
<p>分别拷贝数据库至原生公用目录</p>
<h5 id="Android端"><a href="#Android端" class="headerlink" title="Android端"></a>Android端</h5><p><code>android/app/src/main/assets/demo.realm</code></p>
<h5 id="IOS端"><a href="#IOS端" class="headerlink" title="IOS端"></a>IOS端</h5><p><code>Build Phases-&gt;Copy Bundle Resources-&gt;demo.realm</code></p>
<h5 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h5><p>执行Realm 提供的copyBundledRealmFiles,可以将共用的数据库文件拷贝至应用安装的<code>Documents</code>目录.</p>
<blockquote>
<p><code>Realm.copyBundledRealmFiles();</code></p>
</blockquote>
<h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><h5 id="prepare-realm-data-demo"><a href="#prepare-realm-data-demo" class="headerlink" title="prepare-realm-data-demo"></a><a href="https://github.com/peterfei/prepare-realm-data-demo" target="_blank" rel="external">prepare-realm-data-demo</a></h5>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/10/记IOS开发之我是如何解决react-native-unity-view插件在Product模式闪退Bug/" itemprop="url">
                  记IOS开发之我是如何解决react-native-unity-view插件在Product模式闪退
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-04-10T09:44:13+08:00" content="2019-04-10">
              2019-04-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/IOS/" itemprop="url" rel="index">
                    <span itemprop="name">IOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/04/10/记IOS开发之我是如何解决react-native-unity-view插件在Product模式闪退Bug/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/10/记IOS开发之我是如何解决react-native-unity-view插件在Product模式闪退Bug/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p> 事件起因:</p>
<p>公司在使用react-native开发解剖3D软件,需要和unity进行融合,在组件选择上,使用了react-native-unity-view这款插件,在融合过程中,踩了很多坑,花费精力最大的,是年后IOS升级为12.1后,集成方案集中出现闪退.</p>
</blockquote>
<h5 id="Issue-79"><a href="#Issue-79" class="headerlink" title="Issue #79"></a>Issue #79</h5><p><a href="https://github.com/f111fei/react-native-unity-view/issues/79" target="_blank" rel="external">iOS crashes on launch in release builds only #79</a></p>
<blockquote>
<p>Cash log 如下</p>
</blockquote>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">Thread <span class="number">7</span> <span class="symbol">name:</span>  com.facebook.react.JavaScript</div><div class="line">Thread <span class="number">7</span> <span class="symbol">Crashed:</span></div><div class="line"><span class="number">0</span>   libsystem_kernel.dylib        	<span class="number">0x00000001fbbbd104</span> __pthread_kill + <span class="number">8</span></div><div class="line"><span class="number">1</span>   libsystem_pthread.dylib       	<span class="number">0x00000001fbc3ca00</span> pthread_kill<span class="variable">$VARIANT</span><span class="variable">$armv81</span> + <span class="number">296</span></div><div class="line"><span class="number">2</span>   libsystem_c.dylib             	<span class="number">0x00000001fbb14d78</span> abort + <span class="number">140</span></div><div class="line"><span class="number">3</span>   libsystem_malloc.dylib        	<span class="number">0x00000001fbc11768</span> _malloc_put + <span class="number">0</span></div><div class="line"><span class="number">4</span>   libsystem_malloc.dylib        	<span class="number">0x00000001fbc11924</span> malloc_report + <span class="number">64</span></div><div class="line"><span class="number">5</span>   libsystem_malloc.dylib        	<span class="number">0x00000001fbc042d0</span> free + <span class="number">376</span></div><div class="line"><span class="number">6</span>   libc++.<span class="number">1</span>.dylib                	<span class="number">0x00000001fb1bf120</span> <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt;<span class="symbol">:</span><span class="symbol">:~basic_string+</span> <span class="number">258336</span> () + <span class="number">32</span></div><div class="line"><span class="number">7</span>   UnityTest                     	<span class="number">0x0000000102de23a4</span> <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:__vector_base&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt; &gt;<span class="symbol">:</span><span class="symbol">:~__vector_base</span>() + <span class="number">730020</span> (<span class="symbol">vector:</span><span class="number">451</span>)</div><div class="line"><span class="number">8</span>   UnityTest                     	<span class="number">0x0000000103385214</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:ModuleRegistry</span><span class="symbol">:</span><span class="symbol">:getConfig+</span> <span class="number">6640148</span> (<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; const&amp;) + <span class="number">100</span></div><div class="line"><span class="number">9</span>   UnityTest                     	<span class="number">0x0000000103394168</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSCNativeModules</span><span class="symbol">:</span><span class="symbol">:createModule+</span> <span class="number">6701416</span> (<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; const&amp;, OpaqueJSContext const*) + <span class="number">292</span></div><div class="line"><span class="number">10</span>  UnityTest                     	<span class="number">0x0000000103393cc8</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSCNativeModules</span><span class="symbol">:</span><span class="symbol">:getModule+</span> <span class="number">6700232</span> (OpaqueJSContext const*, OpaqueJSString*) + <span class="number">188</span></div><div class="line"><span class="number">11</span>  UnityTest                     	<span class="number">0x000000010338e85c</span> OpaqueJSValue const* (*<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:</span>(anonymous namespace)<span class="symbol">:</span><span class="symbol">:exceptionWrapMethod&lt;&amp;</span>(<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSCExecutor</span><span class="symbol">:</span><span class="symbol">:getNativeModule</span>(OpaqueJSValue*, OpaqueJSString*))&gt;())(OpaqueJSContext const*, OpaqueJSValue*, OpaqueJSString*, OpaqueJSValue const**)<span class="symbol">:</span><span class="symbol">:funcWrapper</span><span class="symbol">:</span><span class="symbol">:call+</span> <span class="number">6678620</span> (OpaqueJSContext const*, OpaqueJSValue*, OpaqueJSString*, OpaqueJSValue const**) + <span class="number">104</span></div><div class="line"><span class="number">12</span>  JavaScriptCore                	<span class="number">0x0000000203350404</span> <span class="symbol">JSC:</span><span class="symbol">:JSCallbackObject&lt;JSC</span><span class="symbol">:</span><span class="symbol">:JSDestructibleObject&gt;</span><span class="symbol">:</span><span class="symbol">:getOwnPropertySlot+</span> <span class="number">574468</span> (<span class="symbol">JSC:</span><span class="symbol">:JSObject*</span>, <span class="symbol">JSC:</span><span class="symbol">:ExecState*</span>, <span class="symbol">JSC:</span><span class="symbol">:PropertyName</span>, <span class="symbol">JSC:</span><span class="symbol">:PropertySlot&amp;</span>) + <span class="number">340</span></div><div class="line"><span class="number">13</span>  JavaScriptCore                	<span class="number">0x0000000203a354f0</span> llint_slow_path_get_by_id + <span class="number">2008</span></div><div class="line"><span class="number">14</span>  JavaScriptCore                	<span class="number">0x0000000203328928</span> llint_entry + <span class="number">11528</span></div><div class="line"><span class="number">15</span>  JavaScriptCore                	<span class="number">0x000000020332d134</span> llint_entry + <span class="number">29972</span></div><div class="line"><span class="number">16</span>  JavaScriptCore                	<span class="number">0x000000020332d134</span> llint_entry + <span class="number">29972</span></div><div class="line"><span class="number">17</span>  JavaScriptCore                	<span class="number">0x000000020332d134</span> llint_entry + <span class="number">29972</span></div><div class="line"><span class="number">18</span>  JavaScriptCore                	<span class="number">0x000000020332d134</span> llint_entry + <span class="number">29972</span></div><div class="line"><span class="number">19</span>  JavaScriptCore                	<span class="number">0x000000020332d134</span> llint_entry + <span class="number">29972</span></div><div class="line"><span class="number">20</span>  JavaScriptCore                	<span class="number">0x0000000203325a1c</span> vmEntryToJavaScript + <span class="number">300</span></div><div class="line"><span class="number">21</span>  JavaScriptCore                	<span class="number">0x000000020399bfe4</span> <span class="symbol">JSC:</span><span class="symbol">:Interpreter</span><span class="symbol">:</span><span class="symbol">:executeProgram+</span> <span class="number">7176164</span> (<span class="symbol">JSC:</span><span class="symbol">:SourceCode</span> const&amp;, <span class="symbol">JSC:</span><span class="symbol">:ExecState*</span>, <span class="symbol">JSC:</span><span class="symbol">:JSObject*</span>) + <span class="number">9620</span></div><div class="line"><span class="number">22</span>  JavaScriptCore                	<span class="number">0x0000000203b77218</span> <span class="symbol">JSC:</span><span class="symbol">:evaluate+</span> <span class="number">9122328</span> (<span class="symbol">JSC:</span><span class="symbol">:ExecState*</span>, <span class="symbol">JSC:</span><span class="symbol">:SourceCode</span> const&amp;, <span class="symbol">JSC:</span><span class="symbol">:JSValue</span>, <span class="symbol">WTF:</span><span class="symbol">:NakedPtr&lt;JSC</span><span class="symbol">:</span><span class="symbol">:Exception&gt;&amp;</span>) + <span class="number">316</span></div><div class="line"><span class="number">23</span>  JavaScriptCore                	<span class="number">0x000000020334e634</span> JSEvaluateScript + <span class="number">472</span></div><div class="line"><span class="number">24</span>  UnityTest                     	<span class="number">0x000000010336dad0</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:evaluateScript+</span> <span class="number">6544080</span> (OpaqueJSContext const*, OpaqueJSString*, OpaqueJSString*) + <span class="number">80</span></div><div class="line"><span class="number">25</span>  UnityTest                     	<span class="number">0x000000010338c918</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSCExecutor</span><span class="symbol">:</span><span class="symbol">:loadApplicationScript+</span> <span class="number">6670616</span> (<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:unique_ptr&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:default_delete&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const&gt; &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt;) + <span class="number">528</span></div><div class="line"><span class="number">26</span>  UnityTest                     	<span class="number">0x0000000103392ba4</span> <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:__function</span><span class="symbol">:</span><span class="symbol">:__func&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:NativeToJsBridge</span><span class="symbol">:</span><span class="symbol">:loadApplication</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:unique_ptr&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:RAMBundleRegistry</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:default_delete&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:RAMBundleRegistry&gt;</span> &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:unique_ptr&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:default_delete&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const&gt; &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt;)<span class="symbol">:</span><span class="symbol">:</span><span class="variable">$_0</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:NativeToJsBridge</span><span class="symbol">:</span><span class="symbol">:loadApplication</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:unique_ptr&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:RAMBundleRegistry</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:default_delete&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:RAMBundleRegistry&gt;</span> &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:unique_ptr&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:default_delete&lt;facebook</span><span class="symbol">:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSBigString</span> const&gt; &gt;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt;)<span class="symbol">:</span><span class="symbol">:</span><span class="variable">$_0</span>&gt;, void (<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSExecutor*</span>)&gt;<span class="symbol">:</span><span class="symbol">:operator</span>()+ <span class="number">6695844</span> (<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSExecutor*&amp;&amp;</span>) + <span class="number">144</span></div><div class="line"><span class="number">27</span>  UnityTest                     	<span class="number">0x0000000103393ba8</span> <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:function&lt;void</span> (<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSExecutor*</span>)&gt;<span class="symbol">:</span><span class="symbol">:operator</span>()+ <span class="number">6699944</span> (<span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:JSExecutor*</span>) const + <span class="number">40</span></div><div class="line"><span class="number">28</span>  UnityTest                     	<span class="number">0x000000010330c9cc</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:tryAndReturnError</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:function&lt;void</span> + <span class="number">6146508</span> ()&gt; const&amp;) + <span class="number">24</span></div><div class="line"><span class="number">29</span>  UnityTest                     	<span class="number">0x0000000103302528</span> <span class="symbol">facebook:</span><span class="symbol">:react</span><span class="symbol">:</span><span class="symbol">:RCTMessageThread</span><span class="symbol">:</span><span class="symbol">:tryFunc</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:function&lt;void</span> + <span class="number">6104360</span> ()&gt; const&amp;) + <span class="number">24</span></div><div class="line"><span class="number">30</span>  CoreFoundation                	<span class="number">0x00000001fbfb6408</span> __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK_<span class="number">_</span> + <span class="number">20</span></div><div class="line"><span class="number">31</span>  CoreFoundation                	<span class="number">0x00000001fbfb5d08</span> __CFRunLoopDoBlocks + <span class="number">272</span></div><div class="line"><span class="number">32</span>  CoreFoundation                	<span class="number">0x00000001fbfb1220</span> __CFRunLoopRun + <span class="number">2376</span></div><div class="line"><span class="number">33</span>  CoreFoundation                	<span class="number">0x00000001fbfb05b8</span> CFRunLoopRunSpecific + <span class="number">436</span></div><div class="line"><span class="number">34</span>  UnityTest                     	<span class="number">0x00000001032e36a4</span> +[RCTCxxBridge runRunLoop] + <span class="number">264</span></div><div class="line"><span class="number">35</span>  Foundation                    	<span class="number">0x00000001fcad73b0</span> __NSThread__start_<span class="number">_</span> + <span class="number">1040</span></div><div class="line"><span class="number">36</span>  libsystem_pthread.dylib       	<span class="number">0x00000001fbc412fc</span> _pthread_body + <span class="number">128</span></div><div class="line"><span class="number">37</span>  libsystem_pthread.dylib       	<span class="number">0x00000001fbc4125c</span> _pthread_start + <span class="number">48</span></div><div class="line"><span class="number">38</span>  libsystem_pthread.dylib       	<span class="number">0x00000001fbc44d08</span> thread_start + <span class="number">4</span></div></pre></td></tr></table></figure>
<h5 id="最初的解决方案"><a href="#最初的解决方案" class="headerlink" title="最初的解决方案"></a>最初的解决方案</h5><ul>
<li>升级<code>react-native</code>版本到0.57.0</li>
<li><code>rm -fr node_modules</code></li>
<li>升级插件版本<code>react-native-unity-view&quot;: &quot;^1.2.1&quot;</code></li>
<li>在Xcode里<code>Setting &quot;Strip Linked Product&quot; to NO</code>  </li>
</ul>
<p>成功阻止了编译闪退,但发布后被审核告知闪退.来来回回几次后,终于重新测试发现,居然是打包为<code>release IPA file</code>后才开始闪退-_-!!</p>
<h5 id="再次尝试"><a href="#再次尝试" class="headerlink" title="再次尝试"></a>再次尝试</h5><p>之后在issue里提问回帖,得到如下方案:</p>
<p>在配置文件里加入</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">COPY_PHASE_STRIP</span> = <span class="literal">YES</span>;</div><div class="line"><span class="attr">ENABLE_BITCODE</span> = <span class="literal">NO</span>;</div><div class="line"><span class="attr">STRIP_INSTALLED_PRODUCT</span> = <span class="literal">NO</span>;</div></pre></td></tr></table></figure>
<p>之后在测试机上运行,没有闪退.于是提交审核,发布了版本.之后有用户反馈在<code>IPHONE XS Max</code>上闪退 <code>-_-!!!</code></p>
<h5 id="最后的尝试"><a href="#最后的尝试" class="headerlink" title="最后的尝试"></a>最后的尝试</h5><p>之后继续回帖,在 <a href="https://github.com/JanOwiesniak" target="_blank" rel="external">JanOwiesniak</a>和<a href="https://github.com/mtostenson" target="_blank" rel="external">mtostenson </a>的建议下,进行如下改动:</p>
<ul>
<li>using XCodes new build system or the legacy build system</li>
<li>Reinstall node_modues </li>
<li>Update Unity from 2018.2.14f1 to 2018.3.6f1</li>
<li>Build UnityExport</li>
<li>Patch UnityExport <a href="https://github.com/jiulongw/swift-unity/pull/120#issuecomment-456315250" target="_blank" rel="external">jiulongw/swift-unity#120 (comment)</a> <a href="https://github.com/f111fei/react-native-unity-view/issues/79#issuecomment-465819733" target="_blank" rel="external">#79 (comment)</a></li>
<li>Update react-native-unity-view to 1.3.3</li>
<li>Update react-native to 0.57+</li>
<li>Patch react-native moduleNames() <a href="https://github.com/f111fei/react-native-unity-view/issues/79#issuecomment-465110101" target="_blank" rel="external">(#79 (comment)</a></li>
<li>Add AVKit.framework in Xcode</li>
</ul>
<h5 id="最终成功解决iphone-xs-max-12-1兼容"><a href="#最终成功解决iphone-xs-max-12-1兼容" class="headerlink" title="最终成功解决iphone xs max 12.1兼容"></a>最终成功解决iphone xs max 12.1兼容</h5>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://ruby-china-files.b0.upaiyun.com/user/big_avatar/5575.jpg"
               alt="peterfei" />
          <p class="site-author-name" itemprop="name">peterfei</p>
          <p class="site-description motion-element" itemprop="description">peterfei|技术|上主是我的牧者</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">72</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/peterfei" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">peterfei</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"peterfei"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  


</body>
</html>
