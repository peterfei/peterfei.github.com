<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="peterfei.me,peterfei" />





  <link rel="alternate" href="/atom.xml" title="Peterfei" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.0" />






<meta name="description" content="peterfei|技术|上主是我的牧者">
<meta property="og:type" content="website">
<meta property="og:title" content="Peterfei">
<meta property="og:url" content="http://peterfei.me/index.html">
<meta property="og:site_name" content="Peterfei">
<meta property="og:description" content="peterfei|技术|上主是我的牧者">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Peterfei">
<meta name="twitter:description" content="peterfei|技术|上主是我的牧者">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: '[object Object]',
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Peterfei </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Peterfei</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">上主是我的牧者，我实在一无所缺</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'PqEYgqEwUwFoXjgtngj9','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/09/17/大数据-实时计算Flink之FlinkSQL/" itemprop="url">
                  大数据-实时计算Flink之FlinkSQL
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2022-09-17T10:57:30+08:00" content="2022-09-17">
              2022-09-17
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2022/09/17/大数据-实时计算Flink之FlinkSQL/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2022/09/17/大数据-实时计算Flink之FlinkSQL/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>大数据处理技术现今已广泛应用于各个行业，为业务解决海量存储和海量分析的需求。但数据量的爆发式增长，对数据处理能力提出了更大的挑战，同时对时效性也提出了更高的要求。业务通常已不再满足滞后的分析结果，希望看到更实时的数据，从而在第一时间做出判断和决策。典型的场景如电商大促和金融风控等，基于延迟数据的分析结果已经失去了价值。</p>
<p>如何构建一个统一的数据湖存储，并在其上进行多种形式的数据分析，成了企业构建大数据生态的一个重要方向。如何快速、一致、原子性地在数据湖存储上构建起 Data Pipeline，成了亟待解决的问题。</p>
<p>下载<code>flink-sql-connector-mysql-cdc</code>, <code>flink-sql-connector-kafka</code> ,<code>flink-sql-connector-hive</code>到 /usr/lib/flink/lib/</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">wget https://repo1.maven.org/maven2/org/apache/flink/flink-sql-connector-kafka_2<span class="meta">.12</span>/<span class="number">1.14</span><span class="meta">.2</span>/flink-sql-connector-kafka_2<span class="meta">.12</span>-<span class="number">1.14</span><span class="meta">.2</span>.jar</div><div class="line"></div><div class="line">wget https://repo1.maven.org/maven2/com/ververica/flink-sql-connector-mysql-cdc/<span class="number">2.2</span><span class="meta">.1</span>/flink-sql-connector-mysql-cdc-<span class="number">2.2</span><span class="meta">.1</span>.jar</div><div class="line"></div><div class="line">wget https://repo.maven.apache.org/maven2/org/apache/flink/flink-sql-connector-hive-<span class="number">3.1</span><span class="meta">.2_2</span><span class="meta">.12</span>/<span class="number">1.14</span><span class="meta">.2</span>/flink-sql-connector-hive-<span class="number">3.1</span><span class="meta">.2_2</span><span class="meta">.12</span>-<span class="number">1.14</span><span class="meta">.2</span>.jar</div><div class="line"></div><div class="line">wget https://repo1.maven.org/maven2/org/apache/flink/flink-connector-jdbc_2<span class="meta">.12</span>/<span class="number">1.14</span><span class="meta">.2</span>/flink-connector-jdbc_2<span class="meta">.12</span>-<span class="number">1.14</span><span class="meta">.2</span>.jar</div></pre></td></tr></table></figure>
<p>Flink1.11引入了CDC的connector，通过这种方式可以很方便地捕获变化的数据，大大简化了数据处理的流程。Flink1.11的CDC connector主要包括：<code>MySQL CDC</code>和<code>Postgres CDC</code>,同时对Kafka的<strong>Connector</strong>支持<code>canal-json</code>和<code>debezium-json</code>以及<code>changelog-json</code>的format。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Flink CDC Connector 是ApacheFlink的一组数据源连接器，使用<strong>变化数据捕获change data capture (CDC)）</strong>从不同的数据库中提取变更数据。Flink CDC连接器将Debezium集成为引擎来捕获数据变更。因此，它可以充分利用Debezium的功能。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul>
<li>支持读取数据库快照，并且能够持续读取数据库的变更日志，即使发生故障，也支持<strong>exactly-once</strong> 的处理语义</li>
<li>对于DataStream API的CDC connector，用户无需部署Debezium和Kafka，即可在单个作业中使用多个数据库和表上的变更数据。</li>
<li>对于Table/SQL API 的CDC connector，用户可以使用SQL DDL创建CDC数据源，来监视单个表上的数据变更。</li>
</ul>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li>数据库之间的增量数据同步</li>
<li>审计日志</li>
<li>数据库之上的实时物化视图</li>
<li>基于CDC的维表join</li>
</ul>
<h2 id="Flink提供的-table-format"><a href="#Flink提供的-table-format" class="headerlink" title="Flink提供的 table format"></a>Flink提供的 table format</h2><p>Flink提供了一系列可以用于table connector的table format，具体如下：</p>
<table>
<thead>
<tr>
<th>Formats</th>
<th>Supported Connectors</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/csv.html" target="_blank" rel="external">CSV</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/kafka.html" target="_blank" rel="external">Apache Kafka</a>, <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/filesystem.html" target="_blank" rel="external">Filesystem</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/json.html" target="_blank" rel="external">JSON</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/kafka.html" target="_blank" rel="external">Apache Kafka</a>, <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/filesystem.html" target="_blank" rel="external">Filesystem</a>, <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/elasticsearch.html" target="_blank" rel="external">Elasticsearch</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/avro.html" target="_blank" rel="external">Apache Avro</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/kafka.html" target="_blank" rel="external">Apache Kafka</a>, <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/filesystem.html" target="_blank" rel="external">Filesystem</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/debezium.html" target="_blank" rel="external">Debezium CDC</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/kafka.html" target="_blank" rel="external">Apache Kafka</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/canal.html" target="_blank" rel="external">Canal CDC</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/kafka.html" target="_blank" rel="external">Apache Kafka</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/parquet.html" target="_blank" rel="external">Apache Parquet</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/filesystem.html" target="_blank" rel="external">Filesystem</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/orc.html" target="_blank" rel="external">Apache ORC</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/filesystem.html" target="_blank" rel="external">Filesystem</a></td>
</tr>
</tbody>
</table>
<h2 id="使用过程中的注意点"><a href="#使用过程中的注意点" class="headerlink" title="使用过程中的注意点"></a>使用过程中的注意点</h2><h3 id="使用MySQL-CDC的注意点"><a href="#使用MySQL-CDC的注意点" class="headerlink" title="使用MySQL CDC的注意点"></a>使用MySQL CDC的注意点</h3><p>如果要使用MySQL CDC connector，对于程序而言，需要添加如下依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.ververica<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-mysql-cdc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>如果要使用Flink SQL Client，需要添加如下jar包：<strong><a href="https://repo1.maven.org/maven2/com/alibaba/ververica/flink-sql-connector-mysql-cdc/1.0.0/flink-sql-connector-mysql-cdc-1.0.0.jar" target="_blank" rel="external">flink-sql-connector-mysql-cdc-1.0.0.jar</a></strong>，将该jar包放在Flink安装目录的lib文件夹下即可。</p>
<h2 id="之前，-mysql-中需加入配置"><a href="#之前，-mysql-中需加入配置" class="headerlink" title="之前， mysql 中需加入配置"></a>之前， mysql 中需加入配置</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server_id</span>=<span class="number">1</span></div><div class="line"><span class="attr">log_bin</span>=mysql-bin</div><div class="line"><span class="attr">binlog_format</span>=ROW</div><div class="line"><span class="attr">binlog_row_image</span>=FULL</div></pre></td></tr></table></figure>
<p>重启mysql.</p>
<h2 id="mysql-cdc的操作实践"><a href="#mysql-cdc的操作实践" class="headerlink" title="mysql-cdc的操作实践"></a>mysql-cdc的操作实践</h2><h3 id="创建MySQL数据源表"><a href="#创建MySQL数据源表" class="headerlink" title="创建MySQL数据源表"></a>创建MySQL数据源表</h3><p>在创建MySQL CDC表之前，需要先创建MySQL的数据表，如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- MySQL</span></div><div class="line"><span class="comment">/*Table structure for table `order_info` */</span></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`order_info`</span>;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`order_info`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'编号'</span>,</div><div class="line">  <span class="string">`consignee`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'收货人'</span>,</div><div class="line">  <span class="string">`consignee_tel`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'收件人电话'</span>,</div><div class="line">  <span class="string">`total_amount`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'总金额'</span>,</div><div class="line">  <span class="string">`order_status`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单状态,1表示下单，2表示支付'</span>,</div><div class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户id'</span>,</div><div class="line">  <span class="string">`payment_way`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'付款方式'</span>,</div><div class="line">  <span class="string">`delivery_address`</span> <span class="built_in">varchar</span>(<span class="number">1000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'送货地址'</span>,</div><div class="line">  <span class="string">`order_comment`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单备注'</span>,</div><div class="line">  <span class="string">`out_trade_no`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单交易编号（第三方支付用)'</span>,</div><div class="line">  <span class="string">`trade_body`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单描述(第三方支付用)'</span>,</div><div class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</div><div class="line">  <span class="string">`operate_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'操作时间'</span>,</div><div class="line">  <span class="string">`expire_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'失效时间'</span>,</div><div class="line">  <span class="string">`tracking_no`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'物流单编号'</span>,</div><div class="line">  <span class="string">`parent_order_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'父订单编号'</span>,</div><div class="line">  <span class="string">`img_url`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'图片路径'</span>,</div><div class="line">  <span class="string">`province_id`</span> <span class="built_in">int</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'地区'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'订单表'</span>;</div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="comment">-- Records of order_info</span></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_info`</span> </div><div class="line"><span class="keyword">VALUES</span> (<span class="number">476</span>, <span class="string">'lAXjcL'</span>, <span class="string">'13408115089'</span>, <span class="number">433.00</span>, <span class="string">'2'</span>, <span class="number">10</span>, <span class="string">'2'</span>, <span class="string">'OYyAdSdLxedceqovndCD'</span>, <span class="string">'ihjAYsSjrgJMQVdFQnSy'</span>, <span class="string">'8728720206'</span>, <span class="string">''</span>, <span class="string">'2020-06-18 02:21:38'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">9</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_info`</span></div><div class="line"><span class="keyword">VALUES</span> (<span class="number">477</span>, <span class="string">'QLiFDb'</span>, <span class="string">'13415139984'</span>, <span class="number">772.00</span>, <span class="string">'1'</span>, <span class="number">90</span>, <span class="string">'2'</span>, <span class="string">'OizYrQbKuWvrvdfpkeSZ'</span>, <span class="string">'wiBhhqhMndCCgXwmWVQq'</span>, <span class="string">'1679381473'</span>, <span class="string">''</span>, <span class="string">'2020-06-18 09:12:25'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">3</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_info`</span></div><div class="line"><span class="keyword">VALUES</span> (<span class="number">478</span>, <span class="string">'iwKjQD'</span>, <span class="string">'13320383859'</span>, <span class="number">88.00</span>, <span class="string">'1'</span>, <span class="number">107</span>, <span class="string">'1'</span>, <span class="string">'cbXLKtNHWOcWzJVBWdAs'</span>, <span class="string">'njjsnknHxsxhuCCeNDDi'</span>, <span class="string">'0937074290'</span>, <span class="string">''</span>, <span class="string">'2020-06-18 15:56:34'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">7</span>);</div><div class="line"></div><div class="line"><span class="comment">/*Table structure for table `order_detail` */</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`order_detail`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'编号'</span>,</div><div class="line">  <span class="string">`order_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单编号'</span>,</div><div class="line">  <span class="string">`sku_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'sku_id'</span>,</div><div class="line">  <span class="string">`sku_name`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'sku名称（冗余)'</span>,</div><div class="line">  <span class="string">`img_url`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'图片名称（冗余)'</span>,</div><div class="line">  <span class="string">`order_price`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'购买价格(下单时sku价格）'</span>,</div><div class="line">  <span class="string">`sku_num`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'购买个数'</span>,</div><div class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'订单明细表'</span>;</div><div class="line"></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="comment">-- Records of order_detail</span></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_detail`</span> </div><div class="line"><span class="keyword">VALUES</span> (<span class="number">1329</span>, <span class="number">476</span>, <span class="number">8</span>, <span class="string">'Apple iPhone XS Max (A2104) 256GB 深空灰色 移动联通电信4G手机 双卡双待'</span>, <span class="string">'http://XLMByOyZDTJQYxphQHNTgYAFzJJCKTmCbzvEJIpz'</span>, <span class="number">8900.00</span>, <span class="string">'3'</span>, <span class="string">'2020-06-18 02:21:38'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_detail`</span> </div><div class="line"><span class="keyword">VALUES</span> (<span class="number">1330</span>, <span class="number">477</span>, <span class="number">9</span>, <span class="string">'荣耀10 GT游戏加速 AIS手持夜景 6GB+64GB 幻影蓝全网通 移动联通电信'</span>, <span class="string">'http://ixOCtlYmlxEEgUfPLiLdjMftzrleOEIBKSjrhMne'</span>, <span class="number">2452.00</span>, <span class="string">'4'</span>, <span class="string">'2020-06-18 09:12:25'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_detail`</span></div><div class="line"><span class="keyword">VALUES</span> (<span class="number">1331</span>, <span class="number">478</span>, <span class="number">4</span>, <span class="string">'小米Play 流光渐变AI双摄 4GB+64GB 梦幻蓝 全网通4G 双卡双待 小水滴全面屏拍照游戏智能手机'</span>, <span class="string">'http://RqfEFnAOqnqRnNZLFRvBuwXxwNBtptYJCILDKQYv'</span>, <span class="number">1442.00</span>, <span class="string">'1'</span>, <span class="string">'2020-06-18 15:56:34'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_detail`</span> </div><div class="line"><span class="keyword">VALUES</span> (<span class="number">1332</span>, <span class="number">478</span>, <span class="number">8</span>, <span class="string">'Apple iPhone XS Max (A2104) 256GB 深空灰色 移动联通电信4G手机 双卡双待'</span>, <span class="string">'http://IwhuCDlsiLenfKjPzbJrIoxswdfofKhJLMzlJAKV'</span>, <span class="number">8900.00</span>, <span class="string">'3'</span>, <span class="string">'2020-06-18 15:56:34'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_detail`</span> </div><div class="line"><span class="keyword">VALUES</span> (<span class="number">1333</span>, <span class="number">478</span>, <span class="number">8</span>, <span class="string">'Apple iPhone XS Max (A2104) 256GB 深空灰色 移动联通电信4G手机 双卡双待'</span>, <span class="string">'http://bbfwTbAzTWapywODzOtDJMJUEqNTeRTUQuCDkqXP'</span>, <span class="number">8900.00</span>, <span class="string">'1'</span>, <span class="string">'2020-06-18 15:56:34'</span>);</div></pre></td></tr></table></figure>
<h3 id="Flink-SQL-Cli创建CDC数据源"><a href="#Flink-SQL-Cli创建CDC数据源" class="headerlink" title="Flink SQL Cli创建CDC数据源"></a>Flink SQL Cli创建CDC数据源</h3><p>启动 Flink 集群，再启动 SQL CLI,执行下面命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 创建订单信息表</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_info(</div><div class="line">    <span class="keyword">id</span> <span class="built_in">BIGINT</span>,</div><div class="line">    user_id <span class="built_in">BIGINT</span>,</div><div class="line">    create_time <span class="keyword">TIMESTAMP</span>(<span class="number">0</span>),</div><div class="line">    operate_time <span class="keyword">TIMESTAMP</span>(<span class="number">0</span>),</div><div class="line">    province_id <span class="built_in">INT</span>,</div><div class="line">    order_status <span class="keyword">STRING</span>,</div><div class="line">    total_amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>, <span class="number">5</span>)</div><div class="line">  ) <span class="keyword">WITH</span> (</div><div class="line">    <span class="string">'connector'</span> = <span class="string">'mysql-cdc'</span>,</div><div class="line">    <span class="string">'hostname'</span> = <span class="string">'kms-1'</span>,</div><div class="line">    <span class="string">'port'</span> = <span class="string">'3306'</span>,</div><div class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</div><div class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</div><div class="line">    <span class="string">'database-name'</span> = <span class="string">'mydw'</span>,</div><div class="line">    <span class="string">'table-name'</span> = <span class="string">'order_info'</span></div><div class="line">);</div></pre></td></tr></table></figure>
<p>在Flink SQL Cli中查询该表的数据：result-mode: tableau，+表示数据的insert</p>
<p><a href="https://jiamaoxiang.top/2020/08/12/Flink1-11中的CDC-Connectors操作实践/图1.png" target="_blank" rel="external"><img src="https://jiamaoxiang.top/2020/08/12/Flink1-11%E4%B8%AD%E7%9A%84CDC-Connectors%E6%93%8D%E4%BD%9C%E5%AE%9E%E8%B7%B5/%E5%9B%BE1.png" alt="img"></a></p>
<p>在SQL CLI中创建订单详情表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_detail(</div><div class="line">    <span class="keyword">id</span> <span class="built_in">BIGINT</span>,</div><div class="line">    order_id <span class="built_in">BIGINT</span>,</div><div class="line">    sku_id <span class="built_in">BIGINT</span>,</div><div class="line">    sku_name <span class="keyword">STRING</span>,</div><div class="line">    sku_num <span class="built_in">BIGINT</span>,</div><div class="line">    order_price <span class="built_in">DECIMAL</span>(<span class="number">10</span>, <span class="number">5</span>),</div><div class="line">	create_time <span class="keyword">TIMESTAMP</span>(<span class="number">0</span>)</div><div class="line"> ) <span class="keyword">WITH</span> (</div><div class="line">    <span class="string">'connector'</span> = <span class="string">'mysql-cdc'</span>,</div><div class="line">    <span class="string">'hostname'</span> = <span class="string">'kms-1'</span>,</div><div class="line">    <span class="string">'port'</span> = <span class="string">'3306'</span>,</div><div class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</div><div class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</div><div class="line">    <span class="string">'database-name'</span> = <span class="string">'mydw'</span>,</div><div class="line">    <span class="string">'table-name'</span> = <span class="string">'order_detail'</span></div><div class="line">);</div></pre></td></tr></table></figure>
<p>查询结果如下：</p>
<p><a href="https://jiamaoxiang.top/2020/08/12/Flink1-11中的CDC-Connectors操作实践/图2.png" target="_blank" rel="external"><img src="https://jiamaoxiang.top/2020/08/12/Flink1-11%E4%B8%AD%E7%9A%84CDC-Connectors%E6%93%8D%E4%BD%9C%E5%AE%9E%E8%B7%B5/%E5%9B%BE2.png" alt="img"></a></p>
<p>执行JOIN操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span></div><div class="line">    od.id,</div><div class="line">    oi.id order_id,</div><div class="line">    oi.user_id,</div><div class="line">    oi.province_id,</div><div class="line">    od.sku_id,</div><div class="line">    od.sku_name,</div><div class="line">    od.sku_num,</div><div class="line">    od.order_price,</div><div class="line">    oi.create_time,</div><div class="line">    oi.operate_time</div><div class="line"><span class="keyword">FROM</span></div><div class="line">   (</div><div class="line">    <span class="keyword">SELECT</span> * </div><div class="line">    <span class="keyword">FROM</span> order_info</div><div class="line">    <span class="keyword">WHERE</span> </div><div class="line">	     order_status = <span class="string">'2'</span><span class="comment">-- 已支付</span></div><div class="line">   ) oi</div><div class="line">   <span class="keyword">JOIN</span></div><div class="line">  (</div><div class="line">    <span class="keyword">SELECT</span> *</div><div class="line">    <span class="keyword">FROM</span> order_detail</div><div class="line">  ) od </div><div class="line">  <span class="keyword">ON</span> oi.id = od.order_id;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/09/05/Headscale-之部署私有-DERP-中继服务器/" itemprop="url">
                  Headscale 之部署私有 DERP 中继服务器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2022-09-05T19:42:20+08:00" content="2022-09-05">
              2022-09-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2022/09/05/Headscale-之部署私有-DERP-中继服务器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2022/09/05/Headscale-之部署私有-DERP-中继服务器/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="STUN-是什么"><a href="#STUN-是什么" class="headerlink" title="STUN 是什么"></a>STUN 是什么</h2><p>Tailscale 的终极目标是让两台<strong>处于网络上的任何位置</strong>的机器建立<strong>点对点连接</strong>（直连），但现实世界是复杂的，大部份情况下机器都位于 NAT 和防火墙后面，这时候就需要通过打洞来实现直连，也就是 NAT 穿透。</p>
<p>NAT 按照 <strong>NAT 映射行为</strong>和<strong>有状态防火墙行为</strong>可以分为多种类型，但对于 NAT 穿透来说根本不需要关心这么多类型，只需要看 <strong>NAT 或者有状态防火墙是否会严格检查目标 Endpoint</strong>，根据这个因素，可以将 NAT 分为 <strong>Easy NAT</strong> 和 <strong>Hard NAT</strong>。</p>
<ul>
<li><strong>Easy NAT</strong> 及其变种称为 “Endpoint-Independent Mapping” (<strong>EIM，终点无关的映射</strong>)<br>这里的 Endpoint 指的是目标 Endpoint，也就是说，有状态防火墙只要看到有客户端自己发起的出向包，就会允许相应的入向包进入，<strong>不管这个入向包是谁发进来的都可以</strong>。</li>
<li><strong>hard NAT</strong> 以及变种称为 “Endpoint-Dependent Mapping”（<strong>EDM，终点相关的映射</strong>）<br>这种 NAT 会针对每个目标 Endpoint 来生成一条相应的映射关系。 在这样的设备上，如果客户端向某个目标 Endpoint 发起了出向包，假设客户端的公网 IP 是 2.2.2.2，那么有状态防火墙就会打开一个端口，假设是 4242。那么只有来自该目标 Endpoint 的入向包才允许通过 <code>2.2.2.2:4242</code>，其他客户端一律不允许。这种 NAT 更加严格，所以叫 Hard NAT。</li>
</ul>
<p>对于 Easy NAT，我们只需要提供一个第三方的服务，它能够告诉客户端“它看到的客户端的公网 ip:port 是什么”，然后将这个信息以某种方式告诉通信对端（peer），后者就知道该和哪个地址建连了！这种服务就叫 <strong>STUN</strong> (Session Traversal Utilities for NAT，NAT会话穿越应用程序)。它的工作流程如下图所示：</p>
<ul>
<li>笔记本向 STUN 服务器发送一个请求：“从你的角度看，我的地址什么？”</li>
<li>STUN 服务器返回一个响应：“我看到你的 UDP 包是从这个地址来的：<code>ip:port</code>”。</li>
</ul>
<h2 id="中继是什么"><a href="#中继是什么" class="headerlink" title="中继是什么"></a>中继是什么</h2><p>对于 <strong>Hard NAT</strong> 来说，STUN 就不好使了，即使 STUN 拿到了客户端的公网 <code>ip:port</code> 告诉通信对端也于事无补，因为防火墙是和 STUN 通信才打开的缺口，这个缺口只允许 STUN 的入向包进入，其他通信对端知道了这个缺口也进不来。通常企业级 NAT 都属于 Hard NAT。</p>
<p>这种情况下打洞是不可能了，但也不能就此放弃，可以选择一种折衷的方式：创建一个中继服务器（relay server），客户端与中继服务器进行通信，中继服务器再将包中继（relay）给通信对端。</p>
<p>至于中继的性能，那要看具体情况了：</p>
<ul>
<li>如果能直连，那显然没必要用中继方式；</li>
<li>但如果无法直连，而中继路径又非常接近双方直连的真实路径，并且带宽足够大，那中继方式并不会明显降低通信质量。延迟肯定会增加一点，带宽会占用一些，但<strong>相比完全连接不上，还是可以接受的</strong>。</li>
</ul>
<p>事实上对于大部分网络而言，Tailscale 都可以通过各种黑科技打洞成功，只有极少数情况下才会选择中继，中继只是一种 fallback 机制。</p>
<h2 id="中继协议简介"><a href="#中继协议简介" class="headerlink" title="中继协议简介"></a>中继协议简介</h2><p>中继协议有多种实现方式。</p>
<h3 id="TURN"><a href="#TURN" class="headerlink" title="TURN"></a>TURN</h3><p>TURN 即 Traversal Using Relays around NAT，这是一种经典的中继实现方式，核心理念是：</p>
<ul>
<li><strong>用户</strong>（人）先去公网上的 TURN 服务器认证，成功后后者会告诉你：“我已经为你分配了 ip:port，接下来将为你中继流量”，</li>
<li>然后将这个 ip:port 地址告诉对方，让它去连接这个地址，接下去就是非常简单的客户端/服务器通信模型了。</li>
</ul>
<p>与 STUN 不同，这种协议没有真正的交互性，不是很好用，因此 Tailscale 并没有采用 TURN 作为中继协议。</p>
<h3 id="DERP"><a href="#DERP" class="headerlink" title="DERP"></a>DERP</h3><p>DERP 即 Detoured Encrypted Routing Protocol，这是 Tailscale 自研的一个协议：</p>
<ul>
<li>它是一个<strong>通用目的包中继协议，运行在 HTTP 之上</strong>，而大部分网络都是允许 HTTP 通信的。</li>
<li>它根据目的公钥（destination’s public key）来中继加密的流量（encrypted payloads）。</li>
</ul>
<h2 id="自建私有-DERP-server"><a href="#自建私有-DERP-server" class="headerlink" title="自建私有 DERP server"></a>自建私有 DERP server</h2><p>Tailscale 的私钥只会保存在当前节点，因此 DERP server 无法解密流量，它只能和互联网上的其他路由器一样，呆呆地将加密的流量从一个节点转发到另一个节点，只不过 DERP 使用了一个稍微高级一点的协议来防止滥用。</p>
<p>Tailscale 开源了 DERP 服务器的代码，如果你感兴趣，可以阅读 <a href="https://github.com/tailscale/tailscale/tree/main/derp" target="_blank" rel="external">DERP 的源代码</a>。</p>
<hr>
<p>Tailscale 官方内置了很多 DERP 服务器，分步在全球各地，<strong>惟独不包含中国大陆</strong>，原因你懂得。这就导致了一旦流量通过 DERP 服务器进行中继，延时就会非常高。而且官方提供的 DERP 服务器是万人骑，存在安全隐患。</p>
<p>为了实现低延迟、高安全性，我们可以参考 <a href="https://tailscale.com/kb/1118/custom-derp-servers/" target="_blank" rel="external">Tailscale 官方文档</a>自建私有的 DERP 服务器。有两种部署模式，一种是基于域名，另外一种不需要域名，可以直接使用 IP，不过需要一点黑科技。我们先来看最简单的使用域名的方案。</p>
<p>还需要创建自签名证书，可以通过脚本来创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># build_cert.sh</span></div><div class="line"></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">CERT_HOST=<span class="variable">$1</span></div><div class="line">CERT_DIR=<span class="variable">$2</span></div><div class="line">CONF_FILE=<span class="variable">$3</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"[req]</span></div><div class="line">default_bits  = 2048</div><div class="line">distinguished_name = req_distinguished_name</div><div class="line">req_extensions = req_ext</div><div class="line">x509_extensions = v3_req</div><div class="line">prompt = no</div><div class="line"></div><div class="line">[req_distinguished_name]</div><div class="line">countryName = XX</div><div class="line">stateOrProvinceName = N/A</div><div class="line">localityName = N/A</div><div class="line">organizationName = Self-signed certificate</div><div class="line">commonName = <span class="variable">$CERT_HOST</span>: Self-signed certificate</div><div class="line"></div><div class="line">[req_ext]</div><div class="line">subjectAltName = @alt_names</div><div class="line"></div><div class="line">[v3_req]</div><div class="line">subjectAltName = @alt_names</div><div class="line"></div><div class="line">[alt_names]</div><div class="line">IP.1 = <span class="variable">$CERT_HOST</span></div><div class="line">" &gt; <span class="string">"<span class="variable">$CONF_FILE</span>"</span></div><div class="line"></div><div class="line">mkdir -p <span class="string">"<span class="variable">$CERT_DIR</span>"</span></div><div class="line">openssl req -x509 -nodes -days 730 -newkey rsa:2048 -keyout <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.key"</span> -out <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.crt"</span> -config <span class="string">"<span class="variable">$CONF_FILE</span>"</span></div></pre></td></tr></table></figure>
<p>重新编写 Dockerfile，将 derper 的域名设置为 <code>127.0.0.1</code>：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> golang:latest AS builder</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># ========= CONFIG =========</span></div><div class="line"><span class="comment"># - download links</span></div><div class="line"><span class="keyword">ENV</span> MODIFIED_DERPER_GIT=https://github.com/yangchuansheng/ip_derper.git</div><div class="line"><span class="keyword">ENV</span> BRANCH=ip_derper</div><div class="line"><span class="comment"># ==========================</span></div><div class="line"></div><div class="line"><span class="comment"># build modified derper</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> git <span class="built_in">clone</span> -b <span class="variable">$BRANCH</span> <span class="variable">$MODIFIED_DERPER_GIT</span> tailscale --depth 1 &amp;&amp; \</span></div><div class="line">    <span class="built_in">cd</span> /app/tailscale/cmd/derper &amp;&amp; \</div><div class="line">    /usr/<span class="built_in">local</span>/go/bin/go build -ldflags <span class="string">"-s -w"</span> -o /app/derper &amp;&amp; \</div><div class="line">    <span class="built_in">cd</span> /app &amp;&amp; \</div><div class="line">    rm -rf /app/tailscale</div><div class="line"></div><div class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># ========= CONFIG =========</span></div><div class="line"><span class="comment"># - derper args</span></div><div class="line"><span class="keyword">ENV</span> DERP_HOST=<span class="number">127.0</span>.<span class="number">0.1</span></div><div class="line"><span class="keyword">ENV</span> DERP_CERTS=/app/certs/</div><div class="line"><span class="keyword">ENV</span> DERP_STUN true</div><div class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</div><div class="line"><span class="comment"># ==========================</span></div><div class="line"></div><div class="line"><span class="comment"># apt</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></div><div class="line">    apt-get install -y openssl curl</div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> build_cert.sh /app/</span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /app/derper /app/derper</span></div><div class="line"></div><div class="line"><span class="comment"># build self-signed certs &amp;&amp; start derper</span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> bash /app/build_cert.sh <span class="variable">$DERP_HOST</span> <span class="variable">$DERP_CERTS</span> /app/san.conf &amp;&amp; \</span></div><div class="line">    /app/derper --hostname=<span class="variable">$DERP_HOST</span> \</div><div class="line">    --certmode=manual \</div><div class="line">    --certdir=<span class="variable">$DERP_CERTS</span> \</div><div class="line">    --stun=<span class="variable">$DERP_STUN</span>  \</div><div class="line">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></div></pre></td></tr></table></figure>
<p>构建好镜像后，就可以在你想部署 derper 的主机上直接通过该镜像启动 derper 容器了，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">🐳  → docker run --restart always --net host --name derper  -p 12345:12345 -p 3478:3478/udp <span class="_">-e</span> DERP_ADDR=:12345  <span class="_">-d</span> ghcr.io/yangchuansheng/ip_derper</div></pre></td></tr></table></figure>
<p>Headscale 的本地 YAML 文件目前还不支持这个配置项，所以没办法，咱只能使用在线 URL 了。JSON 配置内容如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@jetlink headscale]# cat derp.json </div><div class="line">&#123;</div><div class="line">  "Regions": &#123;</div><div class="line">    "901": &#123;</div><div class="line">      "RegionID": 901,</div><div class="line">      "RegionCode": "ali-sh",</div><div class="line">      "RegionName": "Aliyun Shanghai",</div><div class="line">      "Nodes": [</div><div class="line">        &#123;</div><div class="line">          "Name": "901a",</div><div class="line">          "RegionID": 901,</div><div class="line">          "DERPPort": 12345,</div><div class="line">          "HostName": "xx.xx.xx.118",</div><div class="line">          "IPv4": "xx.xx.xx.118",</div><div class="line">          "InsecureForTests": true</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置解析：</p>
<ul>
<li><code>HostName</code> 直接填 derper 的公网 IP，即和 <code>IPv4</code> 的值相同。</li>
<li><code>InsecureForTests</code> 一定要设置为 true，以跳过域名验证。</li>
</ul>
<p>你需要把这个 JSON 文件变成 Headscale 服务器可以访问的 URL，比如在 Headscale 主机上搭个 Nginx，或者上传到对象存储（比如阿里云 OSS）</p>
<p>接下来还需要修改 Headscale 的配置文件，引用上面的自定义 DERP 的 URL。需要修改的配置项如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /etc/headscale/config.yaml</span></div><div class="line"><span class="attr">derp:</span></div><div class="line">  <span class="comment"># List of externally available DERP maps encoded in JSON</span></div><div class="line"><span class="attr">  urls:</span></div><div class="line">  <span class="comment">#  - https://controlplane.tailscale.com/derpmap/default</span></div><div class="line"><span class="attr">    - https:</span>//xxxxx/derp.json</div><div class="line"></div><div class="line">  <span class="comment"># Locally available DERP map files encoded in YAML</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment"># This option is mostly interesting for people hosting</span></div><div class="line">  <span class="comment"># their own DERP servers:</span></div><div class="line">  <span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment"># paths:</span></div><div class="line">  <span class="comment">#   - /etc/headscale/derp-example.yaml</span></div><div class="line"><span class="attr">  paths:</span></div><div class="line"><span class="bullet">    -</span> /etc/headscale/derp.yaml</div><div class="line"></div><div class="line">  <span class="comment"># If enabled, a worker will be set up to periodically</span></div><div class="line">  <span class="comment"># refresh the given sources and update the derpmap</span></div><div class="line">  <span class="comment"># will be set up.</span></div><div class="line"><span class="attr">  auto_update_enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment"># How often should we check for DERP updates?</span></div><div class="line"><span class="attr">  update_frequency:</span> <span class="number">24</span>h</div></pre></td></tr></table></figure>
<p>修改完配置后，重启 headscale 服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl restart headscale</div></pre></td></tr></table></figure>
<p>在 Tailscale 客户端上使用以下命令查看目前可以使用的 DERP 服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ tailscale netcheck</div><div class="line"></div><div class="line">Report:</div><div class="line">	* UDP: <span class="literal">true</span></div><div class="line">	* IPv4: yes, 192.168.100.1:49656</div><div class="line">	* IPv6: no</div><div class="line">	* MappingVariesByDestIP: <span class="literal">true</span></div><div class="line">	* HairPinning: <span class="literal">false</span></div><div class="line">	* PortMapping: UPnP</div><div class="line">	* Nearest DERP: Home Hangzhou</div><div class="line">	* DERP latency:</div><div class="line">		- home: 9.7ms   (Home Hangzhou)</div><div class="line">		-  hs: 25.2ms  (Huawei Shanghai)</div><div class="line">		- thk: 43.5ms  (Tencent Hongkong)</div></pre></td></tr></table></figure>
<p>再次查看与通信对端的连接方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ tailscale status</div><div class="line">                coredns              default      linux   active; direct xxxx:45986; offline, tx 131012 rx 196020</div><div class="line">                oneplus-8t           default      android active; relay <span class="string">"home"</span>; offline, tx 211900 rx 22780</div><div class="line">                openwrt              default      linux   active; direct 192.168.100.254:41641; offline, tx 189868 rx 4074772</div></pre></td></tr></table></figure>
<p>可以看到这一次 Tailscale 自动选择了一个线路最优的<strong>国内的</strong> DERP 服务器作为中继，可以测试一下延迟：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ tailscale ping 10.1.0.8</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 45ms</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</div></pre></td></tr></table></figure>
<p>完美！这里的 home 当然是我的家庭宽带，部署方式与上面所说的国内云主机类似，你需要额外开启公网的端口映射（12345/tcp, 3478/udp）。还有一点需要注意的是配置内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"Regions"</span>: &#123;</div><div class="line">    <span class="attr">"901"</span>: &#123;</div><div class="line">      <span class="attr">"RegionID"</span>: <span class="number">901</span>,</div><div class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"ali-sh"</span>,</div><div class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Aliyun Shanghai"</span>,</div><div class="line">      <span class="attr">"Nodes"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"Name"</span>: <span class="string">"901a"</span>,</div><div class="line">          <span class="attr">"RegionID"</span>: <span class="number">901</span>,</div><div class="line">          <span class="attr">"DERPPort"</span>: <span class="number">443</span>,</div><div class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"IPv4"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"902"</span>: &#123;</div><div class="line">      <span class="attr">"RegionID"</span>: <span class="number">902</span>,</div><div class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"home"</span>,</div><div class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Home Hangzhou"</span>,</div><div class="line">      <span class="attr">"Nodes"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"Name"</span>: <span class="string">"902a"</span>,</div><div class="line">          <span class="attr">"RegionID"</span>: <span class="number">902</span>,</div><div class="line">          <span class="attr">"DERPPort"</span>: <span class="number">12345</span>,</div><div class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与国内云主机相比，家庭宽带的配置有两点不同：</p>
<ul>
<li>需要删除 <code>IPv4</code> 配置项。因为家用宽带的公网 IP 是动态变化的，所以你需要使用 <strong>DDNS</strong> 来动态解析公网 IP。</li>
<li><code>HostName</code> 最好填域名，因为你的公网 IP 是动态变化的，没法填写 IP，除非你不停地修改配置文件。填域名也没关系啦，反正不会验证域名的，也不用关心证书的事情，<strong>只要域名能解析到你的公网 IP 即可。</strong></li>
</ul>
<h2 id="防止-DERP-被白嫖"><a href="#防止-DERP-被白嫖" class="headerlink" title="防止 DERP 被白嫖"></a>防止 DERP 被白嫖</h2><p>默认情况下 DERP 服务器是可以被白嫖的，只要别人知道了你的 DERP 服务器的地址和端口，就可以为他所用。如果你的服务器是个小水管，用的人多了可能会把你撑爆，因此我们需要修改配置来防止被白嫖。</p>
<blockquote>
<p>特别声明：只有使用域名的方式才可以通过认证防止被白嫖，使用纯 IP 的方式无法防白嫖，你只能小心翼翼地隐藏好你的 IP 和端口，不能让别人知道。</p>
</blockquote>
<p>只需要做两件事情：</p>
<p><strong>1、在 DERP 服务器上安装 Tailscale。</strong></p>
<p>第一步需要在 DERP 服务所在的主机上安装 Tailscale 客户端，<strong>启动 tailscaled 进程</strong>。</p>
<p><strong>2、derper 启动时加上参数 <code>--verify-clients</code>。</strong></p>
<p>本文推荐的是通过容器启动， <a href="https://github.com/yangchuansheng/docker-image/blob/master/derper/Dockerfile" target="_blank" rel="external">Dockerfile 内容</a>如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> golang:latest AS builder</div><div class="line"></div><div class="line"><span class="keyword">LABEL</span><span class="bash"> org.opencontainers.image.source https://github.com/yangchuansheng/docker-image</span></div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> go install tailscale.com/cmd/derper@main</span></div><div class="line"></div><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line">ARG DEBIAN_FRONTEND=noninteractive</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></div><div class="line">    apt-get install -y --no-install-recommends apt-utils &amp;&amp; \</div><div class="line">    apt-get install -y ca-certificates &amp;&amp; \</div><div class="line">    mkdir /app/certs</div><div class="line"></div><div class="line"><span class="keyword">ENV</span> DERP_DOMAIN your-hostname.com</div><div class="line"><span class="keyword">ENV</span> DERP_CERT_MODE letsencrypt</div><div class="line"><span class="keyword">ENV</span> DERP_CERT_DIR /app/certs</div><div class="line"><span class="keyword">ENV</span> DERP_ADDR :<span class="number">443</span></div><div class="line"><span class="keyword">ENV</span> DERP_STUN true</div><div class="line"><span class="keyword">ENV</span> DERP_HTTP_PORT <span class="number">80</span></div><div class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /go/bin/derper .</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> /app/derper --hostname=<span class="variable">$DERP_DOMAIN</span> \</span></div><div class="line">    --certmode=<span class="variable">$DERP_CERT_MODE</span> \</div><div class="line">    --certdir=<span class="variable">$DERP_CERT_DIR</span> \</div><div class="line">    -<span class="_">-a</span>=<span class="variable">$DERP_ADDR</span> \</div><div class="line">    --stun=<span class="variable">$DERP_STUN</span>  \</div><div class="line">    --http-port=<span class="variable">$DERP_HTTP_PORT</span> \</div><div class="line">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></div></pre></td></tr></table></figure>
<p>默认情况下 <code>--verify-clients</code> 参数设置的是 <code>false</code>。我们不需要对 Dockerfile 内容做任何改动，只需在容器启动时加上环境变量即可，将之前的启动命令修改一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">🐳  → docker run --restart always \</div><div class="line">  --name derper -p 12345:12345 -p 3478:3478/udp \</div><div class="line">  -v /root/.acme.sh/xxxx/:/app/certs \</div><div class="line">  <span class="_">-e</span> DERP_CERT_MODE=manual \</div><div class="line">  <span class="_">-e</span> DERP_ADDR=:12345 \</div><div class="line">  <span class="_">-e</span> DERP_DOMAIN=xxxx \</div><div class="line">  <span class="_">-e</span> DERP_VERIFY_CLIENTS=<span class="literal">true</span> \</div><div class="line">  <span class="_">-d</span> ghcr.io/yangchuansheng/derper:latest</div></pre></td></tr></table></figure>
<p>这样就大功告成了，别人即使知道了你的 DERP 服务器地址也无法使用，但还是要说明一点，即便如此，你也应该尽量不让别人知道你的服务器地址，防止别人有可趁之机。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文给大家介绍了 STUN 对于辅助 NAT 穿透的意义，科普了几种常见的中继协议，包含 Tailscale 自研的 DERP 协议。最后手把手教大家如何自建私有的 DERP 服务器，并让 Tailscale 使用我们自建的 DERP 服务器。</p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/09/05/使用Tailscale搭建VPN专线/" itemprop="url">
                  使用Tailscale搭建VPN专线
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2022-09-05T19:16:18+08:00" content="2022-09-05">
              2022-09-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2022/09/05/使用Tailscale搭建VPN专线/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2022/09/05/使用Tailscale搭建VPN专线/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Tailscale-是什么"><a href="#Tailscale-是什么" class="headerlink" title="Tailscale 是什么"></a>Tailscale 是什么</h2><p>Tailscale 是一种基于 WireGuard 的虚拟组网工具.</p>
<p>与 OpenVPN 之流相比还是能甩好几十条街的，Tailscale 虽然在性能上做了些许取舍，但在功能和易用性上绝对是完爆其他工具：</p>
<ol>
<li>开箱即用</li>
</ol>
<ul>
<li>无需配置防火墙</li>
<li>没有额外的配置</li>
</ul>
<ol>
<li>高安全性/私密性</li>
</ol>
<ul>
<li>自动密钥轮换</li>
<li>点对点连接</li>
<li>支持用户审查端到端的访问记录</li>
</ul>
<ol>
<li>在原有的 ICE、STUN 等 UDP 协议外，实现了 DERP TCP 协议来实现 NAT 穿透</li>
<li>基于公网的控制服务器下发 ACL 和配置，实现节点动态更新</li>
<li>通过第三方（如 Google） SSO 服务生成用户和私钥，实现身份认证</li>
</ol>
<p>简而言之，我们可以将 Tailscale 看成是更为易用、功能更完善的 WireGuard。</p>
<h2 id="Headscale-是什么"><a href="#Headscale-是什么" class="headerlink" title="Headscale 是什么"></a>Headscale 是什么</h2><p>Tailscale 的控制服务器是不开源的，而且对免费用户有诸多限制，这是人家的摇钱树，可以理解。好在目前有一款开源的实现叫 <a href="https://github.com/juanfont/headscale" target="_blank" rel="external">Headscale</a>，这也是唯一的一款，希望能发展壮大。</p>
<p>Headscale 由欧洲航天局的 Juan Font 使用 Go 语言开发，在 BSD 许可下发布，实现了 Tailscale 控制服务器的所有主要功能，可以部署在企业内部，没有任何设备数量的限制，且所有的网络流量都由自己控制</p>
<h2 id="Headscale-部署"><a href="#Headscale-部署" class="headerlink" title="Headscale 部署"></a>Headscale 部署</h2><p>Headscale 部署很简单，推荐直接在 Linux 主机上安装</p>
<p>首先需要到其 GitHub 仓库的 Release 页面下载最新版的二进制文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ wget --output-document=/usr/<span class="built_in">local</span>/bin/headscale \</div><div class="line">   https://github.com/juanfont/headscale/releases/download/v&lt;HEADSCALE VERSION&gt;/headscale_&lt;HEADSCALE VERSION&gt;_linux_&lt;ARCH&gt;</div><div class="line"></div><div class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/headscale</div></pre></td></tr></table></figure>
<p>创建配置目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /etc/headscale</div></pre></td></tr></table></figure>
<p>创建目录用来存储数据与证书：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /var/lib/headscale</div></pre></td></tr></table></figure>
<p>创建空的 SQLite 数据库文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ touch /var/lib/headscale/db.sqlite</div></pre></td></tr></table></figure>
<p>创建 Headscale 配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ wget https://github.com/juanfont/headscale/raw/main/config-example.yaml -O /etc/headscale/config.yaml</div></pre></td></tr></table></figure>
<ul>
<li><p>修改配置文件，将 <code>server_url</code> 改为公网 IP 或域名。<strong>如果是国内服务器，域名必须要备案</strong>。我的域名无法备案，所以我就直接用公网 IP 了。</p>
</li>
<li><p>如果暂时用不到 DNS 功能，可以先将 <code>magic_dns</code> 设为 false。</p>
</li>
<li><p><code>server_url</code> 设置为 <code>http://&lt;PUBLIC_IP&gt;:8080</code>，将 <code>&lt;PUBLIC_IP&gt;</code> 替换为公网 IP 或者域名。</p>
</li>
<li><p>可自定义私有网段，也可同时开启 IPv4 和 IPv6：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">ip_prefixes:</span></div><div class="line">  <span class="comment"># - fd7a:115c:a1e0::/48</span></div><div class="line"><span class="bullet">  -</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>创建 SystemD service 配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /etc/systemd/system/headscale.service</span></div><div class="line">[Unit]</div><div class="line">Description=headscale controller</div><div class="line">After=syslog.target</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=simple</div><div class="line">User=headscale</div><div class="line">Group=headscale</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/headscale serve</div><div class="line">Restart=always</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line"><span class="comment"># Optional security enhancements</span></div><div class="line">NoNewPrivileges=yes</div><div class="line">PrivateTmp=yes</div><div class="line">ProtectSystem=strict</div><div class="line">ProtectHome=yes</div><div class="line">ReadWritePaths=/var/lib/headscale /var/run/headscale</div><div class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</div><div class="line">RuntimeDirectory=headscale</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>创建 headscale 用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ useradd headscale <span class="_">-d</span> /home/headscale -m</div></pre></td></tr></table></figure>
<p>修改 /var/lib/headscale 目录的 owner：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ chown -R headscale:headscale /var/lib/headscale</div></pre></td></tr></table></figure>
<p>修改配置文件中的 <code>unix_socket</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">unix_socket:</span> /var/run/headscale/headscale.sock</div></pre></td></tr></table></figure>
<p>Reload SystemD 以加载新的配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl daemon-reload</div></pre></td></tr></table></figure>
<p>启动 Headscale 服务并设置开机自启：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl <span class="built_in">enable</span> --now headscale</div></pre></td></tr></table></figure>
<p>查看运行状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl status headscale</div></pre></td></tr></table></figure>
<p>查看占用端口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ ss -tulnp|grep headscale</div><div class="line"></div><div class="line">tcp LISTEN 0 1024 [::]:9090 [::]:* users:((<span class="string">"headscale"</span>,pi</div><div class="line"></div><div class="line">d=10899,fd=13))</div><div class="line"></div><div class="line">tcp LISTEN 0 1024 [::]:50443 [::]:* users:((<span class="string">"headscale"</span>,pi</div><div class="line"></div><div class="line">d=10899,fd=10))</div><div class="line"></div><div class="line">tcp LISTEN 0 1024 [::]:8080 [::]:* users:((<span class="string">"headscale"</span>,pi</div><div class="line"></div><div class="line">d=10899,fd=12))</div></pre></td></tr></table></figure>
<p>ailscale 中有一个概念叫 tailnet，你可以理解成租户，租户与租户之间是相互隔离的，具体看参考 Tailscale 的官方文档： <a href="https://tailscale.com/kb/1136/tailnet/" target="_blank" rel="external">What is a tailnet</a>。Headscale 也有类似的实现叫 namespace，即命名空间。我们需要先创建一个 namespace，以便后续客户端接入，例如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">headscale namespaces create vpn</div></pre></td></tr></table></figure>
<p>查看命名空间：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ headscale namespaces list</div><div class="line"></div><div class="line">ID | Name | Created</div><div class="line"></div><div class="line">1 | vpn | 2022-03-09 06:12:06</div></pre></td></tr></table></figure>
<h2 id="Tailscale-客户端接入"><a href="#Tailscale-客户端接入" class="headerlink" title="Tailscale 客户端接入"></a>Tailscale 客户端接入</h2><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Tailscale 官方提供了各种 Linux 发行版的软件包，但国内的网络你懂得，软件源根本用不了。好在官方还提供了 <a href="https://tailscale.com/download/linux/static" target="_blank" rel="external">静态编译的二进制文件</a>，我们可以直接下载。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ wget https://pkgs.tailscale.com/stable/tailscale_1.22.2_amd64.tgz</div></pre></td></tr></table></figure>
<p>解压：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ tar zxvf tailscale_1.22.2_amd64.tgz</div><div class="line">x tailscale_1.22.2_amd64/</div><div class="line">x tailscale_1.22.2_amd64/tailscale</div><div class="line">x tailscale_1.22.2_amd64/tailscaled</div><div class="line">x tailscale_1.22.2_amd64/systemd/</div><div class="line">x tailscale_1.22.2_amd64/systemd/tailscaled.defaults</div><div class="line">x tailscale_1.22.2_amd64/systemd/tailscaled.service</div></pre></td></tr></table></figure>
<p>将二进制文件复制到官方软件包默认的路径下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cp tailscale_1.22.2_amd64/tailscaled /usr/sbin/tailscaled</div><div class="line">$ cp tailscale_1.22.2_amd64/tailscale /usr/bin/tailscale</div></pre></td></tr></table></figure>
<p>将 systemD service 配置文件复制到系统路径下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp tailscale_1.22.2_amd64/systemd/tailscaled.service /lib/systemd/system/tailscaled.service</div></pre></td></tr></table></figure>
<p>将环境变量配置文件复制到系统路径下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp tailscale_1.22.2_amd64/systemd/tailscaled.defaults /etc/default/tailscaled</div></pre></td></tr></table></figure>
<p>启动 tailscaled.service 并设置开机自启：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl <span class="built_in">enable</span> --now tailscaled</div></pre></td></tr></table></figure>
<p>查看服务状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl status tailscaled</div></pre></td></tr></table></figure>
<p>Tailscale 接入 Headscale：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 将 &lt;HEADSCALE_PUB_IP&gt; 换成你的 Headscale 公网 IP 或域名</span></div><div class="line">$ tailscale up --login-server=http://xx.xx.xx.xx:8080 --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.xx.0/24</div></pre></td></tr></table></figure>
<p>这里推荐将 DNS 功能关闭，因为它会覆盖系统的默认 DNS。如果你对 DNS 有需求，可自己研究官方文档，这里不再赘述。</p>
<p>执行完上面的命令后，会出现下面的信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">To authenticate, visit:</div><div class="line"></div><div class="line">http://xxxxxx:8080/register?key=905cf165204800247fbd33989dbc22be95c987286c45aac303393704</div><div class="line"></div><div class="line">1150d846</div></pre></td></tr></table></figure>
<p>在浏览器中打开该链接，就会出现如下的界面</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-06-08qWbz.png" alt=""></p>
<p>将其中的命令复制粘贴到 headscale 所在机器的终端中，并将 NAMESPACE 替换为前面所创建的 namespace。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ headscale -n vpn nodes register --key 905cf165204800247fbd33989dbc22be95c987286c45aac3033937041150d846</div><div class="line">Machine register</div></pre></td></tr></table></figure>
<p>注册成功，查看注册的节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ headscale nodes list</div><div class="line"></div><div class="line">ID | Name | NodeKey | Namespace | IP addresses | Ephemeral | Last seen | Onlin</div><div class="line"></div><div class="line">e | Expired</div><div class="line"></div><div class="line">1 | coredns | [Ew3RB] | vpn | 10.1.0.1 | <span class="literal">false</span> | 2022-03-20 09:08:58 | onlin</div><div class="line"></div><div class="line">e | no</div></pre></td></tr></table></figure>
<p>回到 Tailscale 客户端所在的 Linux 主机，可以看到 Tailscale 会自动创建相关的路由表和 iptables 规则。路由表可通过以下命令查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ip route show table 52</div></pre></td></tr></table></figure>
<h3 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h3><p>macOS 有 3 种安装方法：</p>
<ul>
<li>直接通过应用商店安装，地址： <a href="https://apps.apple.com/ca/app/tailscale/id1475387142。前提是你**需要一个美区" target="_blank" rel="external">https://apps.apple.com/ca/app/tailscale/id1475387142。前提是你**需要一个美区</a> ID**。。。</li>
<li>下载 <a href="https://pkgs.tailscale.com/stable/#macos" target="_blank" rel="external">安装包</a>直接安装，绕过应用商店。</li>
<li>安装开源的命令行工具 <code>tailscale</code> 和 <code>tailscaled</code>。相关链接： <a href="https://github.com/tailscale/tailscale/wiki/Tailscaled-on-macOS。" target="_blank" rel="external">https://github.com/tailscale/tailscale/wiki/Tailscaled-on-macOS。</a></li>
</ul>
<p>这三种安装包的核心数据包处理代码是相同的，唯一的区别在于在于打包方式以及与系统的交互方式</p>
<p>安装完 GUI 版应用后还需要做一些骚操作，才能让 Tailscale 使用 Headscale 作为控制服务器。当然，Headscale 已经给我们提供了详细的操作步骤，你只需要在浏览器中打开 URL：<code>http://&lt;HEADSCALE_PUB_IP&gt;:8080/apple</code>，便会出现如下的界面：</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-39-arYdfv.png" alt=""></p>
<blockquote>
<p>非应用商店版本的 macOS 客户端需要将 <code>io.tailscale.ipn.macos</code> 替换为 <code>io.tailscale.ipn.macsys</code>。即：<code>defaults write io.tailscale.ipn.macsys ControlURL http://&lt;HEADSCALE_PUB_IP&gt;:8080</code></p>
</blockquote>
<p>修改完成后重启 Tailscale 客户端，在 macOS 顶部状态栏中找到 Tailscale 并点击，然后再点击 <code>Log in</code></p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-43-pTW3r7.png" alt=""></p>
<p>然后立马就会跳转到浏览器并打开一个页面。</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-17-46-AbzngB.png" alt=""></p>
<p>接下来与之前 Linux 客户端相同，回到 Headscale 所在的机器执行浏览器中的命令即可，注册成功</p>
<p>回到 Headscale 所在主机，查看注册的节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ headscale nodes list</div><div class="line"></div><div class="line">ID | Name | NodeKey | Namespace | IP addresses | Ephemeral | Last seen | Onlin</div><div class="line"></div><div class="line">e | Expired</div><div class="line"></div><div class="line">1 | coredns | [Ew3RB] | default | 10.1.0.1 | <span class="literal">false</span> | 2022-03-20 09:08:58 | onlin</div><div class="line"></div><div class="line">e | no</div><div class="line">2 | carsondemacbook-pro | [k7bzX] | default   | 10.1.0.2     | <span class="literal">false</span>     | 2022-03-20 09:48:30 | online  | no</div></pre></td></tr></table></figure>
<p>回到 macOS，测试是否能 ping 通对端节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ ping -c 2 10.1.0.1</div><div class="line">PING 10.1.0.1 (10.1.0.1): 56 data bytes</div><div class="line">64 bytes from 10.1.0.1: icmp_seq=0 ttl=64 time=37.025 ms</div><div class="line">64 bytes from 10.1.0.1: icmp_seq=1 ttl=64 time=38.181 ms</div><div class="line"></div><div class="line">--- 10.1.0.1 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0.0% packet loss</div><div class="line">round-trip min/avg/max/stddev = 37.025/37.603/38.181/0.578 ms</div></pre></td></tr></table></figure>
<p>也可以使用 Tailscale CLI 来测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ /Applications/Tailscale.app/Contents/MacOS/Tailscale ping 10.1.0.1</div><div class="line">pong from coredns (10.1.0.1) via xxxx:41641 <span class="keyword">in</span> 36ms</div></pre></td></tr></table></figure>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>Windows Tailscale 客户端想要使用 Headscale 作为控制服务器，只需在浏览器中打开 URL：<code>http://&lt;HEADSCALE_PUB_IP&gt;:8080/windows</code>，便会出现如下的界面</p>
<p><img src="https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting3@main/uPic/2022-03-20-23-30-zcQX3F.png" alt=""></p>
<p>按照其中的步骤操作即可。</p>
<h3 id="通过-Pre-Authkeys-接入"><a href="#通过-Pre-Authkeys-接入" class="headerlink" title="通过 Pre-Authkeys 接入"></a>通过 Pre-Authkeys 接入</h3><p>前面的接入方法都需要服务端同意，步骤比较烦琐，其实还有更简单的方法，可以直接接入，不需要服务端同意。</p>
<p>首先在服务端生成 pre-authkey 的 token，有效期可以设置为 24 小时：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ headscale preauthkeys create <span class="_">-e</span> 24h -n default</div></pre></td></tr></table></figure>
<p>查看已经生成的 key：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ headscale -n default preauthkeys list</div><div class="line">ID | Key                                              | Reusable | Ephemeral | Used  | Expiration          | Created            </div><div class="line">1  | 57e419c40e30b0dxxxxxxxf15562c18a8c6xxxx28ae76f57 | <span class="literal">false</span>    | <span class="literal">false</span>     | <span class="literal">false</span> | 2022-05-30 07:14:17 | 2022-05-29 07:14:17</div></pre></td></tr></table></figure>
<p>现在新节点就可以无需服务端同意直接接入了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tailscale up --login-server=http://&lt;HEADSCALE_PUB_IP&gt;:8080 --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --authkey <span class="variable">$KEY</span></div></pre></td></tr></table></figure>
<h2 id="打通局域网"><a href="#打通局域网" class="headerlink" title="打通局域网"></a>打通局域网</h2><p>到目前为止我们只是打造了一个点对点的 Mesh 网络，各个节点之间都可以通过 WireGuard 的私有网络 IP 进行直连。但我们可以更大胆一点，还记得我在文章开头提到的访问家庭内网的资源吗？我们可以通过适当的配置让每个节点都能访问其他节点的局域网 IP。这个使用场景就比较多了，你可以直接访问家庭内网的 NAS，或者内网的任何一个服务，<strong>更高级的玩家可以使用这个方法来访问云上 Kubernetes 集群的 Pod IP 和 Service IP。</strong></p>
<p>假设你的家庭内网有一台 Linux 主机（比如 OpenWrt）安装了 Tailscale 客户端，我们希望其他 Tailscale 客户端可以直接通过家中的局域网 IP（例如 <strong>192.168.100.0/24</strong>） 访问家庭内网的任何一台设备。</p>
<p>配置方法很简单，首先需要设置 IPv4 与 IPv6 路由转发：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">echo</span> <span class="string">'net.ipv4.ip_forward = 1'</span> | tee /etc/sysctl.d/ipforwarding.conf</div><div class="line">$ <span class="built_in">echo</span> <span class="string">'net.ipv6.conf.all.forwarding = 1'</span> | tee <span class="_">-a</span> /etc/sysctl.d/ipforwarding.conf</div><div class="line">$ sysctl -p /etc/sysctl.d/ipforwarding.conf</div></pre></td></tr></table></figure>
<p>客户端修改注册节点的命令，在原来命令的基础上加上参数 <code>--advertise-routes=192.168.100.0/24</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tailscale up --login-server=http://&lt;HEADSCALE_PUB_IP&gt;:8080 --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.100.0/24</div></pre></td></tr></table></figure>
<p>在 Headscale 端查看路由，可以看到相关路由是关闭的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ headscale nodes list|grep openwrt</div><div class="line"></div><div class="line">6 | openwrt | [7LdVc] | default | 10.1.0.6 | <span class="literal">false</span> | 2022-03-20 15:50:46 | onlin</div><div class="line"></div><div class="line">e | no</div><div class="line"></div><div class="line">$ headscale routes list -i 6</div><div class="line"></div><div class="line">Route | Enabled</div><div class="line"></div><div class="line">192.168.100.0/24 | <span class="literal">false</span></div></pre></td></tr></table></figure>
<p>开启路由：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ headscale routes <span class="built_in">enable</span> -i 6 -r <span class="string">"192.168.100.0/24"</span></div><div class="line"></div><div class="line">Route | Enabled</div><div class="line"></div><div class="line">192.168.100.0/24 | <span class="literal">true</span></div></pre></td></tr></table></figure>
<p>其他节点查看路由结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ip route show table 52|grep <span class="string">"192.168.100.0/24"</span></div><div class="line">192.168.100.0/24 dev tailscale0</div></pre></td></tr></table></figure>
<p>现在你在任何一个 Tailscale 客户端所在的节点都可以 ping 通家庭内网的机器.</p>
<hr>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/08/26/Elasticsearch-之Data-stream/" itemprop="url">
                  Elasticsearch 之Data stream
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2022-08-26T17:05:46+08:00" content="2022-08-26">
              2022-08-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2022/08/26/Elasticsearch-之Data-stream/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2022/08/26/Elasticsearch-之Data-stream/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>数据流</li>
<li>Elasticsearch</li>
</ul>
<h2 id="Data-stream-的概念"><a href="#Data-stream-的概念" class="headerlink" title="Data stream 的概念"></a>Data stream 的概念</h2><h3 id="时序性数据"><a href="#时序性数据" class="headerlink" title="时序性数据"></a>时序性数据</h3><p>时间序列数据（ time series data ）是在不同时间上收集到的数据，用于所描述现象随时间变化的情况。这类数据反映了某一事物、现象等，随时间的变化状态或程度。</p>
<p>总的来说，这类数据主要基于时间特性明显，随着时间的流逝，往往过去时间的数据没有现在时间的重要或者敏感。</p>
<p>对于 Elastisearch 处理时序性数据，有人总结了主要有以下特点：</p>
<ul>
<li>由时间戳 + 数据组成。基于时间的事件，可以是服务器日志或者社交媒体流。</li>
<li>通常搜索最近事件，旧文件变得不太重要。</li>
<li>索引的使用主要基于时间，但是数据并不一定随着时间均衡分布。</li>
<li>时序性数据一旦存入后很少修改。</li>
<li>时序性数据随着时间的增加，数据量会很大。</li>
</ul>
<p>Elastisearch 在时序性数据的使用中，往往会有以下的缺点：</p>
<ul>
<li>索引随着时间增加而数目较多。</li>
<li>索引大小无法均衡。</li>
<li>管理索引成本较高，需要维护 merge 合并删除等一系列任务。</li>
<li>节点资源与冷热数据分布不匹配。</li>
</ul>
<p>在这样的一个场景下，数据流 Data stream 应运而生。</p>
<p>Data stream （数据流）是 Elastic Stack 7.9 的一个新的功能。Data stream 可以跨多个索引存储只追加时序性数据，同时为查询写入等请求提供唯一的一个命名资源。Data stream 非常适合日志，事件，指标以及其他持续生成的数据。</p>
<p>简单来说，Data stream 根据模板生成存储数据的后备索引，然后自动将搜索或者索引请求路由到存储流数据的后备索引。而这些后备索引则根据索引生命周期管理（ ILM ）来自动管理。</p>
<h2 id="Data-stream-的组成"><a href="#Data-stream-的组成" class="headerlink" title="Data stream 的组成"></a>Data stream 的组成</h2><p>数据流在 Elasticsearch 集群中由一个或多个隐藏的、自动生成的后备索引组成。</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/2a1db1d79f6448398201a833be2e1d6c.png" alt=""></p>
<p>在实际的 Elasticsearch 操作中，数据流依靠索引模板来设定数据流实体的后备索引。</p>
<ul>
<li>模板包含用于配置流的后备索引的映射和设置。</li>
<li>同一个索引模板可用于多个数据流。</li>
<li>不能删除数据流正在使用的索引模板。</li>
</ul>
<p>每个索引到数据流的文档，必须包含一个 @timestamp 字段，映射为 date 或 date_nanos 字段类型。如果索引模板没有为 @timestamp 字段指定映射，Elasticsearch 将 @timestamp 映射为带有默认选项的日期字段。</p>
<p>Data stream 的读请求主要如下图，数据流自动将请求路由到其所有后备索引。</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/7f9c38c3deb84f3cb919e8581d69770b.png" alt=""></p>
<p>而对于写请求，数据流则将该请求自动转发给最新的后备索引。</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/6d00171f1af04002b72ef6f9d263f192.png" alt=""></p>
<h2 id="Data-stream-的特性"><a href="#Data-stream-的特性" class="headerlink" title="Data stream 的特性"></a>Data stream 的特性</h2><h3 id="生成"><a href="#生成" class="headerlink" title="生成"></a>生成</h3><p>每个 Data stream 的后备索引都有一个 generation 数，一个六位数，零填充的整数，从 000001 开始，用作该流的 rollover 的计数。</p>
<p>后备索引名主要依照以下格式：</p>
<p>.ds–</p>
<p>Generation 越大，后备索引包含的数据越新。 例如，web-server-logs 数据流最新的 generation 为 34。该流的最新后备索引名为 .ds-web-server-logs-000034。</p>
<p>注意：某些操作（例如 shrink 或 restore ）可以更改后备索引的名称。 这些名称更改不会从其数据流中删除后备索引。</p>
<h3 id="Rollover"><a href="#Rollover" class="headerlink" title="Rollover"></a>Rollover</h3><p>在 Data stream 的使用中，rollover 是必不可少的条件。</p>
<p>创建数据流时，Elasticsearch 会自动为该 Data stream 根据 template 创建一个后备索引。 该索引还充当流的第一个写入索引。当满足一定条件时， rollover 会创建一个新的后备索引，该后备索引将成为 Data stream 的新写入索引。</p>
<p>当然 rollover 的条件设置主要依靠 ILM。 如果需要，你还可以手动将数据 rollover 。</p>
<h3 id="追加"><a href="#追加" class="headerlink" title="追加"></a>追加</h3><p>由于时序性数据的特征，Data stream 的设计场景中，数据是只追加的，极少需要修改删除。如果实际需要修改删除，则可以考虑以下操作：</p>
<ul>
<li>对于数据流只能通过 update by query 或者 delete by query 操作，不能进行 update 或者 delete 文档。</li>
<li>需要 delete 或者 update 文档，则直接对后备索引操作。</li>
<li>需要经常删除或者修改文档的，请使用索引别名或者索引模板，不要对 Data stream 操作。</li>
</ul>
<h2 id="Data-stream-的使用"><a href="#Data-stream-的使用" class="headerlink" title="Data stream 的使用"></a>Data stream 的使用</h2><h3 id="创建索引生命周期管理策略-ILM"><a href="#创建索引生命周期管理策略-ILM" class="headerlink" title="创建索引生命周期管理策略 ILM"></a>创建索引生命周期管理策略 ILM</h3><p>索引生命周期管理策略 ILM 的主要配置细节见索引周期管理一章，此处主要做 hot 和 delete 阶段的设置，用于 rollover 的引用。</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">PUT /_ilm/policy/my-data-stream-policy</div><div class="line">&#123;</div><div class="line">  <span class="string">"policy"</span>: &#123;</div><div class="line">    <span class="string">"phases"</span>: &#123;</div><div class="line">      <span class="string">"hot"</span>: &#123;</div><div class="line">        <span class="string">"actions"</span>: &#123;</div><div class="line">          <span class="string">"rollover"</span>: &#123;</div><div class="line">            <span class="string">"max_size"</span>: <span class="string">"10mb"</span></div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="创建索引模板"><a href="#创建索引模板" class="headerlink" title="创建索引模板"></a>创建索引模板</h3><p>索引模板是后备索引设置，以及 mapping 的主要配置来源，此处不展开延伸。主要设置 Data stream 相关的部分。</p>
<p>相关命令：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">PUT /_index_template/my-data-stream-template</div><div class="line">&#123;</div><div class="line">  <span class="string">"index_patterns"</span>: [ <span class="string">"my-data-stream*"</span> ],</div><div class="line">  <span class="string">"data_stream"</span>: &#123; &#125;,</div><div class="line">  <span class="string">"priority"</span>: <span class="number">200</span>,</div><div class="line">  <span class="string">"template"</span>: &#123;</div><div class="line">    <span class="string">"settings"</span>: &#123;</div><div class="line">      <span class="string">"index.lifecycle.name"</span>: <span class="string">"my-data-stream-policy"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意：</p>
<ol>
<li>定义 data_stream 为一个空的 object ，这是必要的。</li>
<li>Template 中使用了上一步创建的 ILM 策略 my-data-stream-policy。</li>
</ol>
<p>此外，还需要注意两点：</p>
<ol>
<li>Elasticsearch 有一些内置索引模板如 metric-<strong>-</strong> 和 logs-<strong>-</strong> ，默认优先级 priority 是 100。如果有重名使用，则可以调高优先级，防止被默认的覆盖。</li>
<li>索引模板默认将 @timestamp 字段设置为 date 属性</li>
</ol>
<h3 id="创建-Data-stream"><a href="#创建-Data-stream" class="headerlink" title="创建 Data stream"></a>创建 Data stream</h3><p>可以自动利用 template 的匹配模式新增文档创建</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">PUT</span> /_data_stream/my-<span class="class"><span class="keyword">data</span>-stream</span></div></pre></td></tr></table></figure>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>删除命令：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">DELETE</span> <span class="regexp">/_data_stream/my</span>-data-stream</div></pre></td></tr></table></figure>
<p>删除数据流会将数据流的后备索引一起删除。</p>
<h2 id="使用-Data-stream"><a href="#使用-Data-stream" class="headerlink" title="使用 Data stream"></a>使用 Data stream</h2><p>此处对数据流的操作主要以命令为主</p>
<h3 id="新增数据"><a href="#新增数据" class="headerlink" title="新增数据"></a>新增数据</h3><p>Data stream 在新增数据时是只追加的模式，因此在固定 id 和 bulk 的模式下，op_type 是指定 create 的。</p>
<p>如下面命令：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">POST</span> my-<span class="meta">data</span>-<span class="keyword">stream/_create/1</span></div><div class="line">&#123;<span class="string">"@timestamp"</span>:<span class="string">"2020-12-07T11:06:07.000Z"</span>,<span class="string">"test"</span>:<span class="number">1</span>&#125;</div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">PUT /my-data-stream/_bulk?refresh</div><div class="line">&#123;<span class="string">"create"</span>:&#123; &#125;&#125;</div><div class="line">&#123; <span class="string">"@timestamp"</span>: <span class="string">"2020-12-08T11:04:05.000Z"</span>, <span class="string">"user"</span>: &#123; <span class="string">"id"</span>: <span class="string">"vlb44hny"</span> &#125;, <span class="string">"message"</span>: <span class="string">"Login attempt failed"</span> &#125;</div><div class="line">&#123;<span class="string">"create"</span>:&#123; &#125;&#125;</div><div class="line">&#123; <span class="string">"@timestamp"</span>: <span class="string">"2020-12-08T11:06:07.000Z"</span>, <span class="string">"user"</span>: &#123; <span class="string">"id"</span>: <span class="string">"8a4f500d"</span> &#125;, <span class="string">"message"</span>: <span class="string">"Login successful"</span> &#125;</div><div class="line">&#123;<span class="string">"create"</span>:&#123; &#125;&#125;</div><div class="line">&#123; <span class="string">"@timestamp"</span>: <span class="string">"2020-12-09T11:07:08.000Z"</span>, <span class="string">"user"</span>: &#123; <span class="string">"id"</span>: <span class="string">"l7gk7f82"</span> &#125;, <span class="string">"message"</span>: <span class="string">"Logout successful"</span> &#125;</div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST /_reindex</div><div class="line">&#123;</div><div class="line">  <span class="string">"source"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"kibana_sample_data_logs_new"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"dest"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"my-data-stream"</span>,</div><div class="line">    <span class="string">"op_type"</span>: <span class="string">"create"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因字段中<code>@timestamp</code>是必填，实验数据如下改动：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  <span class="string">"source"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"kibana_sample_data_logs"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"dest"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"kibana_sample_data_logs_new"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"script"</span>: &#123;</div><div class="line">    <span class="string">"source"</span>: <span class="string">"ctx._source['@timestamp'] = ctx._source.remove(\"</span>timestamp\<span class="string">")"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="获取-Data-stream-状态"><a href="#获取-Data-stream-状态" class="headerlink" title="获取 Data stream 状态"></a>获取 Data stream 状态</h3><p>使用 Data stream stats API 查看 Data stream 的状态。</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /<span class="variable">_data_stream</span>/my-data-stream/<span class="variable">_stats</span>?human=<span class="literal">true</span></div></pre></td></tr></table></figure>
<p>同时需要用 _ilm/explain 获取 Data stream 后备索引所在的 ILM 策略状态。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">GET</span> my-<span class="class"><span class="keyword">data</span>-stream/_ilm/explain</span></div></pre></td></tr></table></figure>
<h3 id="手动-rollover-Data-stream"><a href="#手动-rollover-Data-stream" class="headerlink" title="手动 rollover Data stream"></a>手动 rollover Data stream</h3><p>使用 rollover API，手动 rollover Data stream。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">POST</span> my-<span class="class"><span class="keyword">data</span>-stream/_rollover</span></div></pre></td></tr></table></figure>
<p>Response:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"acknowledged"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="attr">"shards_acknowledged"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="attr">"old_index"</span> : <span class="string">".ds-my-data-stream-000001"</span>,</div><div class="line">  <span class="attr">"new_index"</span> : <span class="string">".ds-my-data-stream-000002"</span>,</div><div class="line">  <span class="attr">"rolled_over"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="attr">"dry_run"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="attr">"conditions"</span> : &#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再 GET 相关 Data stream 状态，后备索引增加。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">GET</span> /_data_stream/my-<span class="class"><span class="keyword">data</span>-stream/</span></div></pre></td></tr></table></figure>
<p>Response:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"data_streams"</span> : [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span> : <span class="string">"my-data-stream"</span>,</div><div class="line">      <span class="attr">"timestamp_field"</span> : &#123;</div><div class="line">        <span class="attr">"name"</span> : <span class="string">"@timestamp"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"indices"</span> : [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"index_name"</span> : <span class="string">".ds-my-data-stream-000001"</span>,</div><div class="line">          <span class="attr">"index_uuid"</span> : <span class="string">"AJBi0g3fRyG8-1tiH2UD2Q"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"index_name"</span> : <span class="string">".ds-my-data-stream-000002"</span>,</div><div class="line">          <span class="attr">"index_uuid"</span> : <span class="string">"AgOLGMSBSYWb4X-ID8uwtg"</span></div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="attr">"generation"</span> : <span class="number">2</span>,</div><div class="line">      <span class="attr">"status"</span> : <span class="string">"GREEN"</span>,</div><div class="line">      <span class="attr">"template"</span> : <span class="string">"my-data-stream-template"</span>,</div><div class="line">      <span class="attr">"ilm_policy"</span> : <span class="string">"my-data-stream-policy"</span>,</div><div class="line">      <span class="attr">"hidden"</span> : <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Reindex-Data-stream"><a href="#Reindex-Data-stream" class="headerlink" title="Reindex Data stream"></a>Reindex Data stream</h3><p>使用 reindex API 去复制数据到一个 Data stream。由于 Data stream 的只追加特性，在 op_type 中要选择为 create 。</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST /_reindex</div><div class="line">&#123;</div><div class="line">  <span class="string">"source"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"test"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"dest"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"my-data-stream"</span>,</div><div class="line">    <span class="string">"op_type"</span>: <span class="string">"create"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Response:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"took"</span> : <span class="number">80</span>,</div><div class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="attr">"total"</span> : <span class="number">1</span>,</div><div class="line">  <span class="attr">"updated"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"created"</span> : <span class="number">1</span>,</div><div class="line">  <span class="attr">"deleted"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"batches"</span> : <span class="number">1</span>,</div><div class="line">  <span class="attr">"version_conflicts"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"noops"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"retries"</span> : &#123;</div><div class="line">    <span class="attr">"bulk"</span> : <span class="number">0</span>,</div><div class="line">    <span class="attr">"search"</span> : <span class="number">0</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"throttled_millis"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"requests_per_second"</span> : <span class="number">-1.0</span>,</div><div class="line">  <span class="attr">"throttled_until_millis"</span> : <span class="number">0</span>,</div><div class="line">  <span class="attr">"failures"</span> : [ ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Delete-Update-by-query"><a href="#Delete-Update-by-query" class="headerlink" title="Delete/Update by query"></a>Delete/Update by query</h3><p>针对 Data stream 只能 delete/update by query 。</p>
<p>相关命令：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">POST /my-data-stream/_update_by_query</div><div class="line">&#123;</div><div class="line">  <span class="string">"query"</span>: &#123;</div><div class="line">    <span class="string">"match"</span>: &#123;</div><div class="line">      <span class="string">"user.id"</span>: <span class="string">"l7gk7f82"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"script"</span>: &#123;</div><div class="line">    <span class="string">"source"</span>: <span class="string">"ctx._source.user.id = params.new_id"</span>,</div><div class="line">    <span class="string">"params"</span>: &#123;</div><div class="line">      <span class="string">"new_id"</span>: <span class="string">"XgdX0NoX"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">POST /my-data-stream/_delete_by_query</div><div class="line">&#123;</div><div class="line">  <span class="string">"query"</span>: &#123;</div><div class="line">    <span class="string">"match"</span>: &#123;</div><div class="line">      <span class="string">"user.id"</span>: <span class="string">"vlb44hny"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/08/26/ES-ReIndex迁移数据/" itemprop="url">
                  ES ReIndex迁移数据
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2022-08-26T10:56:55+08:00" content="2022-08-26">
              2022-08-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2022/08/26/ES-ReIndex迁移数据/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2022/08/26/ES-ReIndex迁移数据/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、给目标集群新增白名单"><a href="#一、给目标集群新增白名单" class="headerlink" title="一、给目标集群新增白名单"></a><strong>一、</strong>给目标集群新增白名单</h1><h4 id="1、elasticsearch-yml中添加reindex-remote-whitelist-“xx-xx-xx-xx-9200”-，不加http，重启ES服务；"><a href="#1、elasticsearch-yml中添加reindex-remote-whitelist-“xx-xx-xx-xx-9200”-，不加http，重启ES服务；" class="headerlink" title="1、elasticsearch.yml中添加reindex.remote.whitelist: [“xx.xx.xx.xx:9200”]，不加http，重启ES服务；"></a>1、<a href="https://so.csdn.net/so/search?q=elasticsearch&amp;spm=1001.2101.3001.7020" target="_blank" rel="external">elasticsearch</a>.yml中添加reindex.remote.whitelist: [“xx.xx.xx.xx:9200”]，不加http，重启ES服务；</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">http.host: 0.0.0.0</div><div class="line">http.cors.enabled: true</div><div class="line">http.cors.allow-origin: &quot;*&quot;</div><div class="line">http.cors.allow-headers: Authorization</div><div class="line">xpack.security.enabled: true</div><div class="line">xpack.security.transport.ssl.enabled: true</div><div class="line">reindex.remote.whitelist: [&quot;124.70.107.101:30997&quot;,&quot;47.94.255.84:30997&quot;]</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker ps|grep elasticsearch</div><div class="line"></div><div class="line">docker exec -it elasticsearch /bin/bash</div><div class="line"></div><div class="line">vi config/elasticsearch.yml</div><div class="line"></div><div class="line">docker restart elasticsearch</div></pre></td></tr></table></figure>
<h1 id="二、使用PostMan修改目标主机ES参数"><a href="#二、使用PostMan修改目标主机ES参数" class="headerlink" title="二、使用PostMan修改目标主机ES参数"></a><strong>二、使用PostMan修改目标主机ES参数</strong></h1><h4 id="1、PUT-settings-pretty"><a href="#1、PUT-settings-pretty" class="headerlink" title="1、PUT _settings?pretty"></a>1、PUT _settings?pretty</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;index.refresh_interval&quot;: -1,</div><div class="line">  &quot;index.number_of_replicas&quot;: 0</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="三、使用reindex同步数据"><a href="#三、使用reindex同步数据" class="headerlink" title="三、使用reindex同步数据"></a><strong>三、使用reindex同步数据</strong></h1><h4 id="1、同步数据，POST-reindex-wait-for-completion-false"><a href="#1、同步数据，POST-reindex-wait-for-completion-false" class="headerlink" title="1、同步数据，POST _reindex?wait_for_completion=false"></a>1、同步数据，POST _reindex?wait_for_completion=false</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"># 1、过滤数据</div><div class="line">&#123;</div><div class="line">    &quot;source&quot;: &#123;</div><div class="line">        &quot;remote&quot;: &#123;</div><div class="line">            &quot;host&quot;: &quot;http://47.94.255.84:30997&quot;,</div><div class="line">            &quot;username&quot;: &quot;elastic&quot;,</div><div class="line">            &quot;password&quot;: &quot;IQsMLRniP5BcYfoNzTBT&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;size&quot;: 10000,</div><div class="line">        &quot;index&quot;: &quot;aiot_towercrane_realtime_master&quot;,</div><div class="line">        &quot;query&quot;: &#123;</div><div class="line">            &quot;bool&quot;: &#123;</div><div class="line">                &quot;filter&quot;: [</div><div class="line">                    &#123;</div><div class="line">                        &quot;range&quot;: &#123;</div><div class="line">                            &quot;createTime&quot;: &#123;</div><div class="line">                                &quot;gte&quot;: 1652262590167,</div><div class="line">                                &quot;lte&quot;: 1652262590346</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        &quot;term&quot;: &#123;</div><div class="line">                            &quot;tenantId&quot;: &quot;1441953685304872961&quot;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;dest&quot;: &#123;</div><div class="line">        &quot;index&quot;: &quot;aiot_towercrane_realtime_master&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"># 2 查询数据</div><div class="line">&#123;</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;remote&quot;: &#123;</div><div class="line">      &quot;host&quot;: &quot;http://47.94.255.84:30997&quot;,</div><div class="line">      &quot;username&quot;: &quot;elastic&quot;,</div><div class="line">      &quot;password&quot;: &quot;IQsMLRniP5BcYfoNzTBT&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;index&quot;: &quot;aiot_deeppit_mesure_day_record_master&quot;,</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">      &quot;match&quot;: &#123;</div><div class="line">        &quot;projectId&quot;: &quot;1447476989099610114&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;aiot_deeppit_mesure_day_record_xiongan&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p> <strong>注：</strong></p>
<ul>
<li><strong>同步之前，需要删除目标主机中已存在索引，否则同步不成功。</strong></li>
<li><strong>同步ES数据时，如果需要认证，目标主机添加Basic auth认证，源主机添加username和password;</strong></li>
</ul>
</blockquote>
<h4 id="2、批量修改数据-POST-aiot-towercrane-param-xiongan-update-by-query"><a href="#2、批量修改数据-POST-aiot-towercrane-param-xiongan-update-by-query" class="headerlink" title="2、批量修改数据 POST aiot_towercrane_param_xiongan/_update_by_query"></a>2、批量修改数据 POST aiot_towercrane_param_xiongan/_update_by_query</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">http://144.7.110.56:9200/aiot_towercrane_param_xiongan/_update_by_query</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123; </div><div class="line">    &quot;match_all&quot;: &#123;</div><div class="line">      </div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;script&quot;: &#123;</div><div class="line">    &quot;source&quot;: &quot;ctx._source.tenantId = 1504718344228839425L &quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>注意：Long类型更新需要添加L</li>
</ul>
</blockquote>
<h1 id="四、查看迁移状况"><a href="#四、查看迁移状况" class="headerlink" title="四、查看迁移状况"></a>四、查看迁移状况</h1><h4 id="1、查看所有task"><a href="#1、查看所有task" class="headerlink" title="1、查看所有task"></a>1、查看所有task</h4><p>GET _tasks?detailed=true&amp;actions=*reindex<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://144.7.110.56:9200/_tasks?detailed=true&amp;actions=*reindex</div></pre></td></tr></table></figure></p>
<p>GET _tasks/xxx?pretty<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://144.7.110.56:9200/_tasks/6kPnJej0SZKt4Y5THf6TuQ:697134?pretty</div></pre></td></tr></table></figure></p>
<h1 id="五、恢复新es设置"><a href="#五、恢复新es设置" class="headerlink" title="五、恢复新es设置"></a>五、恢复新es设置</h1><h4 id="1、PUT-settings-pretty-1"><a href="#1、PUT-settings-pretty-1" class="headerlink" title="1、PUT _settings?pretty"></a>1、PUT _settings?pretty</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;index.refresh_interval&quot;: &quot;10m&quot;,</div><div class="line">  &quot;index.number_of_replicas&quot;: 1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">bool查询总结</div><div class="line"></div><div class="line">must：与关系，相当于关系型数据库中的 and。</div><div class="line"></div><div class="line">should：或关系，相当于关系型数据库中的 or。</div><div class="line"></div><div class="line">must_not：非关系，相当于关系型数据库中的 not。</div><div class="line"></div><div class="line">filter：过滤条件。</div><div class="line"></div><div class="line">range：条件筛选范围。</div><div class="line"></div><div class="line">gt：大于，相当于关系型数据库中的 &gt;。</div><div class="line"></div><div class="line">gte：大于等于，相当于关系型数据库中的 &gt;=。</div><div class="line"></div><div class="line">lt：小于，相当于关系型数据库中的 &lt;。</div><div class="line"></div><div class="line">lte：小于等于，相当于关系型数据库中的 &lt;=。</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://ruby-china-files.b0.upaiyun.com/user/big_avatar/5575.jpg"
               alt="peterfei" />
          <p class="site-author-name" itemprop="name">peterfei</p>
          <p class="site-description motion-element" itemprop="description">peterfei|技术|上主是我的牧者</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">72</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/peterfei" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">peterfei</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"peterfei"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  


</body>
</html>
