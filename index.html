<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="peterfei.me,peterfei" />





  <link rel="alternate" href="/atom.xml" title="Peterfei" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.0" />






<meta name="description" content="peterfei|技术|上主是我的牧者">
<meta property="og:type" content="website">
<meta property="og:title" content="Peterfei">
<meta property="og:url" content="http://peterfei.me/index.html">
<meta property="og:site_name" content="Peterfei">
<meta property="og:description" content="peterfei|技术|上主是我的牧者">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Peterfei">
<meta name="twitter:description" content="peterfei|技术|上主是我的牧者">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: '[object Object]',
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Peterfei </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Peterfei</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">上主是我的牧者，我实在一无所缺</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'PqEYgqEwUwFoXjgtngj9','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2023/05/13/Helm-创建高可用mysql集群/" itemprop="url">
                  Helm 创建高可用mysql集群
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2023-05-13T09:35:27+08:00" content="2023-05-13">
              2023-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2023/05/13/Helm-创建高可用mysql集群/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2023/05/13/Helm-创建高可用mysql集群/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="helm-安装-MySQL-1主2从"><a href="#helm-安装-MySQL-1主2从" class="headerlink" title="helm 安装 MySQL 1主2从#"></a><code>helm</code> 安装 <code>MySQL 1主2从</code><a href="https://www.cnblogs.com/evescn/p/16249207.html#237848894" target="_blank" rel="external">#</a></h2><h3 id="1-添加-bitnami-的仓库"><a href="#1-添加-bitnami-的仓库" class="headerlink" title="1. 添加 bitnami 的仓库#"></a>1. 添加 <code>bitnami</code> 的仓库<a href="https://www.cnblogs.com/evescn/p/16249207.html#1990877426" target="_blank" rel="external">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Copy$ helm repo add kubegemsapp https://charts.kubegems.io/kubegemsapp</div></pre></td></tr></table></figure>
<h3 id="2-查询-MySQL-资源"><a href="#2-查询-MySQL-资源" class="headerlink" title="2. 查询 MySQL 资源#"></a>2. 查询 <code>MySQL</code> 资源<a href="https://www.cnblogs.com/evescn/p/16249207.html#1955462305" target="_blank" rel="external">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ helm repo update</div><div class="line">$ helm search repo mysql</div><div class="line">NAME                   	CHART VERSION	APP VERSION	DESCRIPTION                                       </div><div class="line">bitnami/mysql          	8.9.6        	8.0.29     	MySQL is a fast, reliable, scalable, and easy t...</div><div class="line">bitnami/phpmyadmin     	10.0.1       	5.1.3      	phpMyAdmin is a free software tool written in P...</div><div class="line">bitnami/mariadb        	11.0.2       	10.6.7     	MariaDB is an open source, community-developed ...</div><div class="line">bitnami/mariadb-cluster	1.0.2        	10.2.14    	DEPRECATED Chart to create a Highly available M...</div><div class="line">bitnami/mariadb-galera 	7.1.8        	10.6.7     	MariaDB Galera is a multi-primary database clus...</div></pre></td></tr></table></figure>
<h3 id="3-拉取-MySQL-chart-到本地"><a href="#3-拉取-MySQL-chart-到本地" class="headerlink" title="3. 拉取 MySQL chart 到本地#"></a>3. 拉取 <code>MySQL chart</code> 到本地<a href="https://www.cnblogs.com/evescn/p/16249207.html#2359108108" target="_blank" rel="external">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ mkdir /root/mysql &amp;&amp; cd /root/mysql</div><div class="line"></div><div class="line"># 拉取 chart 到本地 /root/mysql 目录</div><div class="line">$ helm pull kubegemsapp/mysql --version 4.5.2</div><div class="line"></div><div class="line"></div><div class="line">$ tar -xvf mysql-4.5.2.tgz</div><div class="line">$ cp mysql/values.yaml ./values.yaml</div><div class="line"></div><div class="line"># 查看当前目录层级</div><div class="line">$ tree -L 2</div><div class="line">.</div><div class="line">├── mysql</div><div class="line">│   ├── Chart.yaml</div><div class="line">│   ├── files</div><div class="line">│   ├── README.md</div><div class="line">│   ├── templates</div><div class="line">│   ├── values-production.yaml</div><div class="line">│   └── values.yaml</div><div class="line">├── mysql-4.5.2.tgz</div><div class="line">└── values.yaml</div></pre></td></tr></table></figure>
<h3 id="4-对本地-values-test-yaml-修改"><a href="#4-对本地-values-test-yaml-修改" class="headerlink" title="4. 对本地 values-test.yaml 修改#"></a>4. 对本地 <code>values-test.yaml</code> 修改<a href="https://www.cnblogs.com/evescn/p/16249207.html#2791212695" target="_blank" rel="external">#</a></h3><ul>
<li>查看集群 <code>storageclasses</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ kubectl get storageclasses.storage.k8s.io </div><div class="line">NAME                   PROVISIONER           RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</div><div class="line">openebs-device         openebs.io/local      Delete          WaitForFirstConsumer   false                  34d</div><div class="line">openebs-hostpath       openebs.io/local      Delete          WaitForFirstConsumer   false                  34d</div><div class="line">openebs-jiva-default   jiva.csi.openebs.io   Delete          Immediate              true                   33d</div></pre></td></tr></table></figure>
<ul>
<li>修改配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div></pre></td><td class="code"><pre><div class="line">$ cat values.yaml </div><div class="line"></div><div class="line">nameOverride: mysql</div><div class="line">fullnameOverride: mysql</div><div class="line"></div><div class="line">image:</div><div class="line">  registry: registry.cn-beijing.aliyuncs.com</div><div class="line">  repository: kubegemsapp/mysql</div><div class="line">  tag: 5.7.26</div><div class="line">  pullPolicy: IfNotPresent</div><div class="line"></div><div class="line">service:</div><div class="line">  type: ClusterIP</div><div class="line">  port: 3306</div><div class="line"></div><div class="line">securityContext:</div><div class="line">  enabled: true</div><div class="line">  fsGroup: 1001</div><div class="line">  runAsUser: 1001</div><div class="line"></div><div class="line">root:</div><div class="line">  password: Huazhu@2021</div><div class="line">  forcePassword: true</div><div class="line"></div><div class="line">db:</div><div class="line">  user:  huazhu</div><div class="line">  password: Huazhu@2021</div><div class="line">  name: my_database</div><div class="line">  forcePassword: true</div><div class="line"></div><div class="line">replication:</div><div class="line">  enabled: true</div><div class="line">  #user: huazhu_replicator</div><div class="line">  user: root</div><div class="line">  password: Huazhu@2021</div><div class="line">  forcePassword: true</div><div class="line"></div><div class="line">master:</div><div class="line">  antiAffinity: soft</div><div class="line">  updateStrategy:</div><div class="line">    type: RollingUpdate</div><div class="line">  persistence:</div><div class="line">    enabled: true</div><div class="line">    storageClass: &quot;managed-nfs-storage&quot;</div><div class="line">    mountPath: /bitnami/mysql</div><div class="line"></div><div class="line">    annotations:</div><div class="line">    accessModes:</div><div class="line">    - ReadWriteOnce</div><div class="line">    size: 5Gi</div><div class="line"></div><div class="line">  config: |-</div><div class="line">    [mysqld]</div><div class="line">    default_authentication_plugin=mysql_native_password</div><div class="line">    skip-name-resolve</div><div class="line">    explicit_defaults_for_timestamp</div><div class="line">    basedir=/opt/bitnami/mysql</div><div class="line">    port=3306</div><div class="line">    socket=/opt/bitnami/mysql/tmp/mysql.sock</div><div class="line">    tmpdir=/opt/bitnami/mysql/tmp</div><div class="line">    max_allowed_packet=16M</div><div class="line">    bind-address=0.0.0.0</div><div class="line">    pid-file=/opt/bitnami/mysql/tmp/mysqld.pid</div><div class="line">    log-error=/opt/bitnami/mysql/logs/mysqld.log</div><div class="line">    character-set-server=UTF8</div><div class="line">    collation-server=utf8_general_ci</div><div class="line"></div><div class="line">    [client]</div><div class="line">    port=3306</div><div class="line">    socket=/opt/bitnami/mysql/tmp/mysql.sock</div><div class="line">    default-character-set=UTF8</div><div class="line"></div><div class="line">    [manager]</div><div class="line">    port=3306</div><div class="line">    socket=/opt/bitnami/mysql/tmp/mysql.sock</div><div class="line">    pid-file=/opt/bitnami/mysql/tmp/mysqld.pid</div><div class="line"></div><div class="line">  resources: &#123;&#125;</div><div class="line">  livenessProbe:</div><div class="line">    enabled: true</div><div class="line">    initialDelaySeconds: 120</div><div class="line">    periodSeconds: 10</div><div class="line">    timeoutSeconds: 1</div><div class="line">    successThreshold: 1</div><div class="line">    failureThreshold: 3</div><div class="line">  readinessProbe:</div><div class="line">    enabled: true</div><div class="line">    initialDelaySeconds: 15</div><div class="line">    periodSeconds: 10</div><div class="line">    timeoutSeconds: 1</div><div class="line">    successThreshold: 1</div><div class="line">    failureThreshold: 3</div><div class="line"></div><div class="line">slave:</div><div class="line">  replicas: 1</div><div class="line">  antiAffinity: soft</div><div class="line">  updateStrategy:</div><div class="line">    type: RollingUpdate</div><div class="line">  persistence:</div><div class="line">    enabled: true</div><div class="line">    storageClass: &quot;managed-nfs-storage&quot;</div><div class="line">    mountPath: /bitnami/mysql</div><div class="line">    annotations:</div><div class="line">    accessModes:</div><div class="line">    - ReadWriteOnce</div><div class="line">    size: 5Gi</div><div class="line"></div><div class="line">  config: |-</div><div class="line">    [mysqld]</div><div class="line">    default_authentication_plugin=mysql_native_password</div><div class="line">    skip-name-resolve</div><div class="line">    explicit_defaults_for_timestamp</div><div class="line">    basedir=/opt/bitnami/mysql</div><div class="line">    port=3306</div><div class="line">    socket=/opt/bitnami/mysql/tmp/mysql.sock</div><div class="line">    tmpdir=/opt/bitnami/mysql/tmp</div><div class="line">    max_allowed_packet=16M</div><div class="line">    bind-address=0.0.0.0</div><div class="line">    pid-file=/opt/bitnami/mysql/tmp/mysqld.pid</div><div class="line">    log-error=/opt/bitnami/mysql/logs/mysqld.log</div><div class="line">    character-set-server=UTF8</div><div class="line">    collation-server=utf8_general_ci</div><div class="line"></div><div class="line">    [client]</div><div class="line">    port=3306</div><div class="line">    socket=/opt/bitnami/mysql/tmp/mysql.sock</div><div class="line">    default-character-set=UTF8</div><div class="line"></div><div class="line">    [manager]</div><div class="line">    port=3306</div><div class="line">    socket=/opt/bitnami/mysql/tmp/mysql.sock</div><div class="line">    pid-file=/opt/bitnami/mysql/tmp/mysqld.pid</div><div class="line"></div><div class="line">  resources: &#123;&#125;</div><div class="line">  livenessProbe:</div><div class="line">    enabled: true</div><div class="line">    initialDelaySeconds: 120</div><div class="line">    periodSeconds: 30</div><div class="line">    timeoutSeconds: 1</div><div class="line">    successThreshold: 1</div><div class="line">    failureThreshold: 3</div><div class="line">  readinessProbe:</div><div class="line">    enabled: true</div><div class="line">    initialDelaySeconds: 15</div><div class="line">    periodSeconds: 30</div><div class="line">    timeoutSeconds: 1</div><div class="line">    successThreshold: 1</div><div class="line">    failureThreshold: 3</div><div class="line"></div><div class="line">metrics:</div><div class="line">  enabled: false</div><div class="line">  image:</div><div class="line">    registry: registry.cn-beijing.aliyuncs.com</div><div class="line">    repository: kubegemsapp/mysqld-exporter</div><div class="line">    tag: v0.10.0</div><div class="line">    pullPolicy: IfNotPresent</div><div class="line">  resources: &#123;&#125;</div><div class="line">  annotations:</div><div class="line">    prometheus.io/scrape: &quot;true&quot;</div><div class="line">    prometheus.io/port: &quot;9104&quot;</div></pre></td></tr></table></figure>
<h3 id="6-安装-MySQL-集群"><a href="#6-安装-MySQL-集群" class="headerlink" title="6. 安装 MySQL 集群"></a>6. 安装 <code>MySQL 集群</code></h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">helm <span class="keyword">install</span> <span class="comment">--namespace mysql mysql-ha -f ./values.yaml ./mysql  --set auth.rootPassword=Huazhu@2021</span></div><div class="line"></div><div class="line"><span class="keyword">NAME</span>: mysql-cluster</div><div class="line"><span class="keyword">LAST</span> DEPLOYED: Mon May  <span class="number">9</span> <span class="number">01</span>:<span class="number">54</span>:<span class="number">38</span> <span class="number">2022</span></div><div class="line">NAMESPACE: <span class="keyword">test</span>-middleware</div><div class="line"><span class="keyword">STATUS</span>: deployed</div><div class="line">REVISION: <span class="number">1</span></div><div class="line"><span class="keyword">TEST</span> SUITE: <span class="keyword">None</span></div><div class="line">NOTES:</div><div class="line">Please be patient <span class="keyword">while</span> the chart <span class="keyword">is</span> being deployed</div><div class="line"></div><div class="line">Tip:</div><div class="line"></div><div class="line">  Watch the deployment <span class="keyword">status</span> <span class="keyword">using</span> the command: kubectl <span class="keyword">get</span> pods -w <span class="comment">--namespace test-middleware</span></div><div class="line"></div><div class="line">Services:</div><div class="line"></div><div class="line">  echo <span class="keyword">Master</span>: mysql-cluster-mysql.test-middleware.svc.cluster.local:<span class="number">3306</span></div><div class="line">  echo <span class="keyword">Slave</span>:  mysql-cluster-mysql-slave.test-middleware.svc.cluster.local:<span class="number">3306</span></div><div class="line"></div><div class="line">Administrator credentials:</div><div class="line"></div><div class="line">  echo Username: root</div><div class="line">  echo <span class="keyword">Password</span> : $(kubectl <span class="keyword">get</span> secret <span class="comment">--namespace test-middleware mysql-cluster-mysql -o jsonpath="&#123;.data.mysql-root-password&#125;" | base64 --decode)</span></div><div class="line"></div><div class="line"><span class="keyword">To</span> <span class="keyword">connect</span> <span class="keyword">to</span> your <span class="keyword">database</span>:</div><div class="line"></div><div class="line">  <span class="number">1.</span> Run a pod that you can <span class="keyword">use</span> <span class="keyword">as</span> a <span class="keyword">client</span>:</div><div class="line"></div><div class="line">      kubectl run mysql-cluster-mysql-<span class="keyword">client</span> <span class="comment">--rm --tty -i --restart='Never' --image  docker.io/bitnami/mysql:5.7.26 --namespace test-middleware --command -- bash</span></div><div class="line"></div><div class="line">  <span class="number">2.</span> <span class="keyword">To</span> <span class="keyword">connect</span> <span class="keyword">to</span> <span class="keyword">master</span> service (<span class="keyword">read</span>/write):</div><div class="line"></div><div class="line">      mysql -h mysql-cluster-mysql.test-middleware.svc.cluster.local -uroot -p my_database</div><div class="line"></div><div class="line">  <span class="number">3.</span> <span class="keyword">To</span> <span class="keyword">connect</span> <span class="keyword">to</span> <span class="keyword">slave</span> service (<span class="keyword">read</span>-<span class="keyword">only</span>):</div><div class="line"></div><div class="line">      mysql -h mysql-cluster-mysql-slave.test-middleware.svc.cluster.local -uroot -p my_database</div><div class="line"></div><div class="line"><span class="keyword">To</span> <span class="keyword">upgrade</span> this helm chart:</div><div class="line"></div><div class="line">  <span class="number">1.</span> Obtain the <span class="keyword">password</span> <span class="keyword">as</span> described <span class="keyword">on</span> the <span class="string">'Administrator credentials'</span> <span class="keyword">section</span> <span class="keyword">and</span> <span class="keyword">set</span> the <span class="string">'root.password'</span> parameter <span class="keyword">as</span> shown below:</div><div class="line"></div><div class="line">      ROOT_PASSWORD=$(kubectl <span class="keyword">get</span> secret <span class="comment">--namespace test-middleware mysql-cluster-mysql -o jsonpath="&#123;.data.mysql-root-password&#125;" | base64 --decode)</span></div><div class="line">      helm <span class="keyword">upgrade</span> mysql-cluster bitnami/mysql <span class="comment">--set root.password=$ROOT_PASSWORD</span></div></pre></td></tr></table></figure>
<h3 id="7-查看部署的-MySQL-集群"><a href="#7-查看部署的-MySQL-集群" class="headerlink" title="7. 查看部署的 MySQL 集群#"></a>7. 查看部署的 <code>MySQL</code> 集群<a href="https://www.cnblogs.com/evescn/p/16249207.html#3339831180" target="_blank" rel="external">#</a></h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$ helm -<span class="keyword">n</span> mysql <span class="keyword">list</span></div><div class="line">NAME         	NAMESPACE      	REVISION	UPDATED                                	STATUS  	CHART      	<span class="keyword">APP</span> <span class="keyword">VERSION</span></div><div class="line">mysql-<span class="keyword">cluster</span>	<span class="keyword">test</span>-middleware	1       	2022-05-09 01:54:38.848559008 -0400 EDT	deployed	mysql-4.5.2	5.7.26</div><div class="line"></div><div class="line">$ kubectl -<span class="keyword">n</span> mysql get pods -<span class="keyword">l</span> <span class="keyword">app</span>=mysql</div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE</div><div class="line">mysql-<span class="keyword">cluster</span>-mysql-master-0   1/1     Running   0          16m</div><div class="line">mysql-<span class="keyword">cluster</span>-mysql-slave-0    1/1     Running   0          16m</div><div class="line">mysql-<span class="keyword">cluster</span>-mysql-slave-1    1/1     Running   0          14m</div><div class="line"></div><div class="line"></div><div class="line">&gt; mysql-<span class="keyword">cluster</span>-mysql-master-0 为主，mysql-<span class="keyword">cluster</span>-mysql-slave-0 和 mysql-<span class="keyword">cluster</span>-mysql-slave-1 为从</div><div class="line"></div><div class="line">&gt; default名称空间如何访问此 MySQL 集群</div><div class="line"></div><div class="line">&gt; MySQL主节点：mysql-<span class="keyword">cluster</span>-mysql.<span class="keyword">test</span>-middleware</div><div class="line">&gt; MySQL从节点0：mysql-<span class="keyword">cluster</span>-mysql-slave-0.mysql-<span class="keyword">cluster</span>-mysql-slave.<span class="keyword">test</span>-middleware</div><div class="line">&gt; MySQL从节点1：mysql-<span class="keyword">cluster</span>-mysql-slave-1.mysql-<span class="keyword">cluster</span>-mysql-slave.<span class="keyword">test</span>-middleware</div></pre></td></tr></table></figure>
<ul>
<li>查看服务使用的 <code>storageclass</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Copy# 查看 pvc</div><div class="line">$ kubectl -n test-middleware get pvc</div><div class="line">NAME                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS           AGE</div><div class="line">data-mysql-cluster-mysql-master-0   Bound    pvc-b9a1d1ca-44d3-4292-af45-e6f3b3063395   8Gi        RWO            openebs-jiva-default   31m</div><div class="line">data-mysql-cluster-mysql-slave-0    Bound    pvc-0d234b12-26eb-4e07-9dc0-ef9f0230e9fa   8Gi        RWO            openebs-jiva-default   31m</div><div class="line">data-mysql-cluster-mysql-slave-1    Bound    pvc-16531f4b-41ac-4a04-9d90-04b92aab7b49   8Gi        RWO            openebs-jiva-default   29m</div><div class="line"></div><div class="line"># 查看 pv</div><div class="line">$ kubectl get pv</div><div class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                                                 STORAGECLASS           REASON   AGE</div><div class="line">pvc-b9a1d1ca-44d3-4292-af45-e6f3b3063395   8Gi        RWO            Delete           Bound    test-middleware/data-mysql-cluster-mysql-master-0                     openebs-jiva-default            33m</div><div class="line">pvc-0d234b12-26eb-4e07-9dc0-ef9f0230e9fa   8Gi        RWO            Delete           Bound    test-middleware/data-mysql-cluster-mysql-slave-0                      openebs-jiva-default            33m</div><div class="line">pvc-16531f4b-41ac-4a04-9d90-04b92aab7b49   8Gi        RWO            Delete           Bound    test-middleware/data-mysql-cluster-mysql-slave-1                      openebs-jiva-default            31m</div></pre></td></tr></table></figure>
<h3 id="8-连接-MySQL-集群-验证服务"><a href="#8-连接-MySQL-集群-验证服务" class="headerlink" title="8. 连接 MySQL 集群 验证服务#"></a>8. 连接 <code>MySQL 集群</code> 验证服务<a href="https://www.cnblogs.com/evescn/p/16249207.html#3772543246" target="_blank" rel="external">#</a></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line">Copy<span class="comment"># 获取 MySQL 集群的密码</span></div><div class="line">$ kubectl get secret --namespace mysql mysql -o jsonpath=<span class="string">"&#123;.data.mysql-root-password&#125;"</span> | base64 --decode</div><div class="line">Huazhu@<span class="number">2021</span></div><div class="line"></div><div class="line"><span class="comment"># 启动一个临时容器</span></div><div class="line">$ kubectl run mysql-cluster-mysql-client --rm --tty -i --restart=<span class="string">'Never'</span> --image  docker.io/bitnami/mysql:<span class="number">5.7</span><span class="number">.26</span> --namespace mysql --command -- bash</div><div class="line"></div><div class="line"><span class="comment">## 登陆 MySQL Master节点</span></div><div class="line">$ mysql -h mysql.mysql -uroot -p</div><div class="line">Enter password: <span class="comment"># Huazhu@2021</span></div><div class="line"></div><div class="line">mysql&gt; show databases;</div><div class="line">+--------------------+</div><div class="line">| Database           <span class="string">|</span></div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| my_database        |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">| sys                |</div><div class="line">+--------------------+</div><div class="line">5 rows in set (0.00 sec)</div><div class="line"></div><div class="line"># 查看主从状态</div><div class="line"># 查看File和Position的值，在从库配置中会显示。</div><div class="line">&gt; show master status\G;</div><div class="line">*************************** 1. row ***************************</div><div class="line"><span class="attr">             File:</span> mysql-bin<span class="number">.000002</span></div><div class="line"><span class="attr">         Position:</span> <span class="number">154</span></div><div class="line"><span class="attr">     Binlog_Do_DB:</span> </div><div class="line"><span class="attr"> Binlog_Ignore_DB:</span> </div><div class="line"><span class="attr">Executed_Gtid_Set:</span> </div><div class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"><span class="attr">ERROR:</span> </div><div class="line"><span class="literal">No</span> query specified</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## 登陆从库，查看主从同步状态</span></div><div class="line">$ mysql -h mysql-mysql-slave.mysql -uroot -p</div><div class="line">Enter password:  <span class="comment"># root123</span></div><div class="line"></div><div class="line">mysql&gt; show slave status\G;</div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line"><span class="attr">               Slave_IO_State:</span> Waiting for master to send event</div><div class="line"><span class="attr">                  Master_Host:</span> mysql-cluster-mysql</div><div class="line"><span class="attr">                  Master_User:</span> replicator</div><div class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></div><div class="line"><span class="attr">                Connect_Retry:</span> <span class="number">10</span></div><div class="line"><span class="attr">              Master_Log_File:</span> mysql-bin<span class="number">.000002</span>  <span class="comment"># File: mysql-bin.000002</span></div><div class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">154</span>  <span class="comment"># Position: 154</span></div><div class="line"><span class="attr">               Relay_Log_File:</span> mysql-relay-bin<span class="number">.000004</span></div><div class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">367</span></div><div class="line"><span class="attr">        Relay_Master_Log_File:</span> mysql-bin<span class="number">.000002</span></div><div class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></div><div class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></div><div class="line"><span class="attr">              Replicate_Do_DB:</span> </div><div class="line"><span class="attr">          Replicate_Ignore_DB:</span> </div><div class="line"><span class="attr">           Replicate_Do_Table:</span> </div><div class="line"><span class="attr">       Replicate_Ignore_Table:</span> </div><div class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </div><div class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </div><div class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">                   Last_Error:</span> </div><div class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></div><div class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">154</span></div><div class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">2236</span></div><div class="line"><span class="attr">              Until_Condition:</span> None</div><div class="line"><span class="attr">               Until_Log_File:</span> </div><div class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></div><div class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></div><div class="line"><span class="attr">           Master_SSL_CA_File:</span> </div><div class="line"><span class="attr">           Master_SSL_CA_Path:</span> </div><div class="line"><span class="attr">              Master_SSL_Cert:</span> </div><div class="line"><span class="attr">            Master_SSL_Cipher:</span> </div><div class="line"><span class="attr">               Master_SSL_Key:</span> </div><div class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></div><div class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></div><div class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">                Last_IO_Error:</span> </div><div class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">               Last_SQL_Error:</span> </div><div class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </div><div class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">641</span></div><div class="line"><span class="attr">                  Master_UUID:</span> aa7a516b-cf5c<span class="bullet">-11</span>ec-b974-a2ee403fe88f</div><div class="line"><span class="attr">             Master_Info_File:</span> mysql.slave_master_info</div><div class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></div><div class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></div><div class="line"><span class="attr">      Slave_SQL_Running_State:</span> Slave has read all relay log; waiting for more updates</div><div class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></div><div class="line"><span class="attr">                  Master_Bind:</span> </div><div class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </div><div class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </div><div class="line"><span class="attr">               Master_SSL_Crl:</span> </div><div class="line"><span class="attr">           Master_SSL_Crlpath:</span> </div><div class="line"><span class="attr">           Retrieved_Gtid_Set:</span> </div><div class="line"><span class="attr">            Executed_Gtid_Set:</span> </div><div class="line"><span class="attr">                Auto_Position:</span> <span class="number">0</span></div><div class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </div><div class="line"><span class="attr">                 Channel_Name:</span> </div><div class="line"><span class="attr">           Master_TLS_Version:</span> </div><div class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"><span class="attr">ERROR:</span> </div><div class="line"><span class="literal">No</span> query specified</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2023/05/11/Helm-创建高可用redis集群/" itemprop="url">
                  Helm 创建高可用redis集群
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2023-05-11T20:24:00+08:00" content="2023-05-11">
              2023-05-11
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2023/05/11/Helm-创建高可用redis集群/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2023/05/11/Helm-创建高可用redis集群/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>数据 <strong>在多个Redis节点之间自动分片</strong></p>
<p> sentinel特点：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">它的主要功能有以下几点</div><div class="line"></div><div class="line">不时地监控redis是否按照预期良好地运行;</div><div class="line">如果发现某个redis节点运行出现状况，能够通知另外一个进程(例如它的客户端);</div><div class="line">能够进行自动切换。当一个<span class="literal">master</span>节点不可用时，能够选举出<span class="literal">master</span>的多个<span class="literal">slave</span>(如果有超过一个<span class="literal">slave</span>的话)中的一个来作为新的<span class="literal">master</span>,其它的<span class="literal">slave</span>节点会将它所追随的<span class="literal">master</span>的地址改为被提升为<span class="literal">master</span>的<span class="literal">slave</span>的新地址。</div></pre></td></tr></table></figure>
<p> sentinel配置文件详解</p>
<p>参考：<a href="https://segmentfault.com/a/1190000002680804" target="_blank" rel="external">https://segmentfault.com/a/1190000002680804</a></p>
<p>主节点down了，从节点选举机制如下：</p>
<p>　　<a href="https://blog.csdn.net/tr1912/article/details/81265007" target="_blank" rel="external">https://blog.csdn.net/tr1912/article/details/81265007</a></p>
<h2 id="安装redis集群"><a href="#安装redis集群" class="headerlink" title="安装redis集群"></a>安装redis集群</h2><p>我们首先添加一下helm库，并且搜索到redis</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ helm repo add bitnami https://charts.bitnami.com/bitnami</div><div class="line">$ helm search repo redis</div><div class="line">NAME                                CHART VERSION    APP VERSION    DESCRIPTION</div><div class="line">bitnami/redis                       14.6.6           6.2.4          Open <span class="built_in">source</span>, advanced key-value store. It is of...</div><div class="line">bitnami/redis-cluster               6.2.3            6.2.4          Open <span class="built_in">source</span>, advanced key-value store. It is of...</div><div class="line">stable/prometheus-redis-exporter    3.5.0            1.3.4          Prometheus exporter <span class="keyword">for</span> Redis metrics</div><div class="line">stable/redis                        10.5.7           5.0.7          DEPRECATED Open <span class="built_in">source</span>, advanced key-value stor...</div><div class="line">stable/redis-ha                     4.4.6            5.0.6          DEPRECATED - Highly available Kubernetes implem...</div></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">helm <span class="built_in">search</span> repo redis</div><div class="line">helm pull stable/redis-<span class="keyword">ha</span></div><div class="line">tar zxvf redis-<span class="keyword">ha</span>-*.tgz</div><div class="line"><span class="keyword">cp</span> redis-<span class="keyword">ha</span>/<span class="built_in">values</span>.yaml .</div></pre></td></tr></table></figure>
<p>cat value.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## Configure resource requests and limits</span></div><div class="line"><span class="comment">## ref: http://kubernetes.io/docs/user-guide/compute-resources/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">image:</span></div><div class="line"><span class="attr">  repository:</span> redis</div><div class="line"><span class="attr">  tag:</span> <span class="number">5.0</span><span class="number">.6</span>-alpine</div><div class="line"><span class="attr">  pullPolicy:</span> IfNotPresent</div><div class="line"></div><div class="line"><span class="comment">## Reference to one or more secrets to be used when pulling images</span></div><div class="line"><span class="comment">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/</span></div><div class="line"><span class="comment">## This imagePullSecrets is only for redis images</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">imagePullSecrets:</span> []</div><div class="line"><span class="comment"># - name: "image-pull-secret"</span></div><div class="line"></div><div class="line"><span class="comment">## replicas number for each component</span></div><div class="line"><span class="attr">replicas:</span> <span class="number">3</span></div><div class="line"></div><div class="line"><span class="comment">## Kubernetes priorityClass name for the redis-ha-server pod</span></div><div class="line"><span class="comment"># priorityClassName: ""</span></div><div class="line"></div><div class="line"><span class="comment">## Custom labels for the redis pod</span></div><div class="line"><span class="attr">labels:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">## Pods Service Account</span></div><div class="line"><span class="comment">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/</span></div><div class="line"><span class="attr">serviceAccount:</span></div><div class="line">  <span class="comment">## Specifies whether a ServiceAccount should be created</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  create:</span> <span class="literal">true</span></div><div class="line">  <span class="comment">## The name of the ServiceAccount to use.</span></div><div class="line">  <span class="comment">## If not set and create is true, a name is generated using the redis-ha.fullname template</span></div><div class="line">  <span class="comment"># name:</span></div><div class="line"></div><div class="line"><span class="comment">## Enables a HA Proxy for better LoadBalancing / Sentinel Master support. Automatically proxies to Redis master.</span></div><div class="line"><span class="comment">## Recommend for externally exposed Redis clusters.</span></div><div class="line"><span class="comment">## ref: https://cbonte.github.io/haproxy-dconv/1.9/intro.html</span></div><div class="line"><span class="attr">haproxy:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">false</span></div><div class="line">  <span class="comment"># Enable if you want a dedicated port in haproxy for redis-slaves</span></div><div class="line"><span class="attr">  readOnly:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    port:</span> <span class="number">6380</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">3</span></div><div class="line"><span class="attr">  image:</span></div><div class="line"><span class="attr">    repository:</span> haproxy</div><div class="line"><span class="attr">    tag:</span> <span class="number">2.0</span><span class="number">.4</span></div><div class="line"><span class="attr">    pullPolicy:</span> IfNotPresent</div><div class="line"></div><div class="line">  <span class="comment">## Reference to one or more secrets to be used when pulling images</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  imagePullSecrets:</span> []</div><div class="line">  <span class="comment"># - name: "image-pull-secret"</span></div><div class="line"></div><div class="line"><span class="attr">  annotations:</span> &#123;&#125;</div><div class="line"><span class="attr">  resources:</span> &#123;&#125;</div><div class="line"><span class="attr">  emptyDir:</span> &#123;&#125;</div><div class="line">  <span class="comment">## Enable sticky sessions to Redis nodes via HAProxy</span></div><div class="line">  <span class="comment">## Very useful for long-living connections as in case of Sentry for example</span></div><div class="line"><span class="attr">  stickyBalancing:</span> <span class="literal">false</span></div><div class="line">  <span class="comment">## Kubernetes priorityClass name for the haproxy pod</span></div><div class="line">  <span class="comment"># priorityClassName: ""</span></div><div class="line">  <span class="comment">## Service type for HAProxy</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="attr">    type:</span> ClusterIP</div><div class="line"><span class="attr">    loadBalancerIP:</span></div><div class="line"><span class="attr">    annotations:</span> &#123;&#125;</div><div class="line"><span class="attr">  serviceAccount:</span></div><div class="line"><span class="attr">    create:</span> <span class="literal">true</span></div><div class="line">  <span class="comment">## Official HAProxy embedded prometheus metrics settings.</span></div><div class="line">  <span class="comment">## Ref: https://github.com/haproxy/haproxy/tree/master/contrib/prometheus-exporter</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  metrics:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line">    <span class="comment"># prometheus port &amp; scrape path</span></div><div class="line"><span class="attr">    port:</span> <span class="number">9101</span></div><div class="line"><span class="attr">    portName:</span> exporter-port</div><div class="line"><span class="attr">    scrapePath:</span> /metrics</div><div class="line"></div><div class="line"><span class="attr">    serviceMonitor:</span></div><div class="line">      <span class="comment"># When set true then use a ServiceMonitor to configure scraping</span></div><div class="line"><span class="attr">      enabled:</span> <span class="literal">false</span></div><div class="line">      <span class="comment"># Set the namespace the ServiceMonitor should be deployed</span></div><div class="line">      <span class="comment"># namespace: monitoring</span></div><div class="line">      <span class="comment"># Set how frequently Prometheus should scrape</span></div><div class="line">      <span class="comment"># interval: 30s</span></div><div class="line">      <span class="comment"># Set path to redis-exporter telemtery-path</span></div><div class="line">      <span class="comment"># telemetryPath: /metrics</span></div><div class="line">      <span class="comment"># Set labels for the ServiceMonitor, use this to define your scrape label for Prometheus Operator</span></div><div class="line">      <span class="comment"># labels: &#123;&#125;</span></div><div class="line">      <span class="comment"># Set timeout for scrape</span></div><div class="line">      <span class="comment"># timeout: 10s</span></div><div class="line"><span class="attr">  init:</span></div><div class="line"><span class="attr">    resources:</span> &#123;&#125;</div><div class="line"><span class="attr">  timeout:</span></div><div class="line"><span class="attr">    connect:</span> <span class="number">4</span>s</div><div class="line"><span class="attr">    server:</span> <span class="number">30</span>s</div><div class="line"><span class="attr">    client:</span> <span class="number">30</span>s</div><div class="line"><span class="attr">    check:</span> <span class="number">2</span>s</div><div class="line"><span class="attr">  securityContext:</span></div><div class="line"><span class="attr">    runAsUser:</span> <span class="number">1000</span></div><div class="line"><span class="attr">    fsGroup:</span> <span class="number">1000</span></div><div class="line"><span class="attr">    runAsNonRoot:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## Whether the haproxy pods should be forced to run on separate nodes.</span></div><div class="line"><span class="attr">  hardAntiAffinity:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment">## Additional affinities to add to the haproxy pods.</span></div><div class="line"><span class="attr">  additionalAffinities:</span> &#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment">## Override all other affinity settings for the haproxy pods with a string.</span></div><div class="line"><span class="attr">  affinity:</span> <span class="string">|</span></div><div class="line"></div><div class="line">  ## Custom config-haproxy.cfg files used to override default settings. If this file is</div><div class="line">  ## specified then the config-haproxy.cfg above will be ignored.</div><div class="line">  # customConfig: |-</div><div class="line">      # Define configuration here</div><div class="line">  ## Place any additional configuration section to add to the default config-haproxy.cfg</div><div class="line">  # extraConfig: |-</div><div class="line">      # Define configuration here</div><div class="line"></div><div class="line"></div><div class="line">## Role Based Access</div><div class="line">## Ref: https://kubernetes.io/docs/admin/authorization/rbac/</div><div class="line">##</div><div class="line"><span class="attr">rbac:</span></div><div class="line"><span class="attr">  create:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="attr">sysctlImage:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  command:</span> []</div><div class="line"><span class="attr">  registry:</span> docker.io</div><div class="line"><span class="attr">  repository:</span> busybox</div><div class="line"><span class="attr">  tag:</span> <span class="number">1.31</span><span class="number">.1</span></div><div class="line"><span class="attr">  pullPolicy:</span> Always</div><div class="line"><span class="attr">  mountHostSys:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  resources:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">## Use an alternate scheduler, e.g. "stork".</span></div><div class="line"><span class="comment">## ref: https://kubernetes.io/docs/tasks/administer-cluster/configure-multiple-schedulers/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># schedulerName:</span></div><div class="line"></div><div class="line"><span class="comment">## Redis specific configuration options</span></div><div class="line"><span class="attr">redis:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">6379</span></div><div class="line"><span class="attr">  masterGroupName:</span> <span class="string">"mymaster"</span>       <span class="comment"># must match ^[\\w-\\.]+$) and can be templated</span></div><div class="line"><span class="attr">  config:</span></div><div class="line">    <span class="comment">## Additional redis conf options can be added below</span></div><div class="line">    <span class="comment">## For all available options see http://download.redis.io/redis-stable/redis.conf</span></div><div class="line"><span class="attr">    min-replicas-to-write:</span> <span class="number">1</span></div><div class="line"><span class="attr">    min-replicas-max-lag:</span> <span class="number">5</span>   <span class="comment"># Value in seconds</span></div><div class="line"><span class="attr">    maxmemory:</span> <span class="string">"0"</span>       <span class="comment"># Max memory to use for each redis instance. Default is unlimited.</span></div><div class="line"><span class="attr">    maxmemory-policy:</span> <span class="string">"volatile-lru"</span>  <span class="comment"># Max memory policy to use for each redis instance. Default is volatile-lru.</span></div><div class="line">    <span class="comment"># Determines if scheduled RDB backups are created. Default is false.</span></div><div class="line">    <span class="comment"># Please note that local (on-disk) RDBs will still be created when re-syncing with a new slave. The only way to prevent this is to enable diskless replication.</span></div><div class="line"><span class="attr">    save:</span> <span class="string">"900 1"</span></div><div class="line">    <span class="comment"># When enabled, directly sends the RDB over the wire to slaves, without using the disk as intermediate storage. Default is false.</span></div><div class="line"><span class="attr">    repl-diskless-sync:</span> <span class="string">"yes"</span></div><div class="line"><span class="attr">    rdbcompression:</span> <span class="string">"yes"</span></div><div class="line"><span class="attr">    rdbchecksum:</span> <span class="string">"yes"</span></div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">## Custom redis.conf files used to override default settings. If this file is</span></div><div class="line">  <span class="comment">## specified then the redis.config above will be ignored.</span></div><div class="line">  <span class="comment"># customConfig: |-</span></div><div class="line">      <span class="comment"># Define configuration here</span></div><div class="line"></div><div class="line"><span class="attr">  resources:</span> &#123;&#125;</div><div class="line">  <span class="comment">#  requests:</span></div><div class="line">  <span class="comment">#    memory: 200Mi</span></div><div class="line">  <span class="comment">#    cpu: 100m</span></div><div class="line">  <span class="comment">#  limits:</span></div><div class="line">  <span class="comment">#    memory: 700Mi</span></div><div class="line"></div><div class="line"><span class="comment">## Sentinel specific configuration options</span></div><div class="line"><span class="attr">sentinel:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">26379</span></div><div class="line"><span class="attr">  quorum:</span> <span class="number">2</span></div><div class="line"><span class="attr">  config:</span></div><div class="line">    <span class="comment">## Additional sentinel conf options can be added below. Only options that</span></div><div class="line">    <span class="comment">## are expressed in the format simialar to 'sentinel xxx mymaster xxx' will</span></div><div class="line">    <span class="comment">## be properly templated expect maxclients option.</span></div><div class="line">    <span class="comment">## For available options see http://download.redis.io/redis-stable/sentinel.conf</span></div><div class="line"><span class="attr">    down-after-milliseconds:</span> <span class="number">10000</span></div><div class="line">    <span class="comment">## Failover timeout value in milliseconds</span></div><div class="line"><span class="attr">    failover-timeout:</span> <span class="number">180000</span></div><div class="line"><span class="attr">    parallel-syncs:</span> <span class="number">5</span></div><div class="line"><span class="attr">    maxclients:</span> <span class="number">10000</span></div><div class="line"></div><div class="line">  <span class="comment">## Custom sentinel.conf files used to override default settings. If this file is</span></div><div class="line">  <span class="comment">## specified then the sentinel.config above will be ignored.</span></div><div class="line">  <span class="comment"># customConfig: |-</span></div><div class="line">      <span class="comment"># Define configuration here</span></div><div class="line"></div><div class="line"><span class="attr">  resources:</span> &#123;&#125;</div><div class="line">  <span class="comment">#  requests:</span></div><div class="line">  <span class="comment">#    memory: 200Mi</span></div><div class="line">  <span class="comment">#    cpu: 100m</span></div><div class="line">  <span class="comment">#  limits:</span></div><div class="line">  <span class="comment">#    memory: 200Mi</span></div><div class="line"></div><div class="line"><span class="attr">securityContext:</span></div><div class="line"><span class="attr">  runAsUser:</span> <span class="number">1000</span></div><div class="line"><span class="attr">  fsGroup:</span> <span class="number">1000</span></div><div class="line"><span class="attr">  runAsNonRoot:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">## Node labels, affinity, and tolerations for pod assignment</span></div><div class="line"><span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector</span></div><div class="line"><span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#taints-and-tolerations-beta-feature</span></div><div class="line"><span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></div><div class="line"><span class="attr">nodeSelector:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">## Whether the Redis server pods should be forced to run on separate nodes.</span></div><div class="line"><span class="comment">## This is accomplished by setting their AntiAffinity with requiredDuringSchedulingIgnoredDuringExecution as opposed to preferred.</span></div><div class="line"><span class="comment">## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#inter-pod-affinity-and-anti-affinity-beta-feature</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">hardAntiAffinity:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">## Additional affinities to add to the Redis server pods.</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## Example:</span></div><div class="line"><span class="comment">##   nodeAffinity:</span></div><div class="line"><span class="comment">##     preferredDuringSchedulingIgnoredDuringExecution:</span></div><div class="line"><span class="comment">##       - weight: 50</span></div><div class="line"><span class="comment">##         preference:</span></div><div class="line"><span class="comment">##           matchExpressions:</span></div><div class="line"><span class="comment">##             - key: spot</span></div><div class="line"><span class="comment">##               operator: NotIn</span></div><div class="line"><span class="comment">##               values:</span></div><div class="line"><span class="comment">##                 - "true"</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">additionalAffinities:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">## Override all other affinity settings for the Redis server pods with a string.</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## Example:</span></div><div class="line"><span class="comment">## affinity: |</span></div><div class="line"><span class="comment">##   podAntiAffinity:</span></div><div class="line"><span class="comment">##     requiredDuringSchedulingIgnoredDuringExecution:</span></div><div class="line"><span class="comment">##       - labelSelector:</span></div><div class="line"><span class="comment">##           matchLabels:</span></div><div class="line"><span class="comment">##             app: &#123;&#123; template "redis-ha.name" . &#125;&#125;</span></div><div class="line"><span class="comment">##             release: &#123;&#123; .Release.Name &#125;&#125;</span></div><div class="line"><span class="comment">##         topologyKey: kubernetes.io/hostname</span></div><div class="line"><span class="comment">##     preferredDuringSchedulingIgnoredDuringExecution:</span></div><div class="line"><span class="comment">##       - weight: 100</span></div><div class="line"><span class="comment">##         podAffinityTerm:</span></div><div class="line"><span class="comment">##           labelSelector:</span></div><div class="line"><span class="comment">##             matchLabels:</span></div><div class="line"><span class="comment">##               app:  &#123;&#123; template "redis-ha.name" . &#125;&#125;</span></div><div class="line"><span class="comment">##               release: &#123;&#123; .Release.Name &#125;&#125;</span></div><div class="line"><span class="comment">##           topologyKey: failure-domain.beta.kubernetes.io/zone</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">affinity:</span> <span class="string">|</span></div><div class="line"></div><div class="line"># Prometheus exporter specific configuration options</div><div class="line"><span class="attr">exporter:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  image:</span> oliver006/redis_exporter</div><div class="line"><span class="attr">  tag:</span> v1<span class="number">.3</span><span class="number">.2</span></div><div class="line"><span class="attr">  pullPolicy:</span> IfNotPresent</div><div class="line"></div><div class="line">  <span class="comment"># prometheus port &amp; scrape path</span></div><div class="line"><span class="attr">  port:</span> <span class="number">9121</span></div><div class="line"><span class="attr">  scrapePath:</span> /metrics</div><div class="line"></div><div class="line">  <span class="comment"># cpu/memory resource limits/requests</span></div><div class="line"><span class="attr">  resources:</span> &#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment"># Additional args for redis exporter</span></div><div class="line"><span class="attr">  extraArgs:</span> &#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment"># Used to mount a LUA-Script via config map and use it for metrics-collection</span></div><div class="line">  <span class="comment"># script: |</span></div><div class="line">  <span class="comment">#   -- Example script copied from: https://github.com/oliver006/redis_exporter/blob/master/contrib/sample_collect_script.lua</span></div><div class="line">  <span class="comment">#   -- Example collect script for -script option</span></div><div class="line">  <span class="comment">#   -- This returns a Lua table with alternating keys and values.</span></div><div class="line">  <span class="comment">#   -- Both keys and values must be strings, similar to a HGETALL result.</span></div><div class="line">  <span class="comment">#   -- More info about Redis Lua scripting: https://redis.io/commands/eval</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment">#   local result = &#123;&#125;</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment">#   -- Add all keys and values from some hash in db 5</span></div><div class="line">  <span class="comment">#   redis.call("SELECT", 5)</span></div><div class="line">  <span class="comment">#   local r = redis.call("HGETALL", "some-hash-with-stats")</span></div><div class="line">  <span class="comment">#   if r ~= nil then</span></div><div class="line">  <span class="comment">#   for _,v in ipairs(r) do</span></div><div class="line">  <span class="comment">#   table.insert(result, v) -- alternating keys and values</span></div><div class="line">  <span class="comment">#   end</span></div><div class="line">  <span class="comment">#   end</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment">#   -- Set foo to 42</span></div><div class="line">  <span class="comment">#   table.insert(result, "foo")</span></div><div class="line">  <span class="comment">#   table.insert(result, "42") -- note the string, use tostring() if needed</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment">#   return result</span></div><div class="line"></div><div class="line"><span class="attr">  serviceMonitor:</span></div><div class="line">    <span class="comment"># When set true then use a ServiceMonitor to configure scraping</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line">    <span class="comment"># Set the namespace the ServiceMonitor should be deployed</span></div><div class="line">    <span class="comment"># namespace: monitoring</span></div><div class="line">    <span class="comment"># Set how frequently Prometheus should scrape</span></div><div class="line">    <span class="comment"># interval: 30s</span></div><div class="line">    <span class="comment"># Set path to redis-exporter telemtery-path</span></div><div class="line">    <span class="comment"># telemetryPath: /metrics</span></div><div class="line">    <span class="comment"># Set labels for the ServiceMonitor, use this to define your scrape label for Prometheus Operator</span></div><div class="line">    <span class="comment"># labels: &#123;&#125;</span></div><div class="line">    <span class="comment"># Set timeout for scrape</span></div><div class="line">    <span class="comment"># timeout: 10s</span></div><div class="line"></div><div class="line"><span class="attr">podDisruptionBudget:</span> &#123;&#125;</div><div class="line">  <span class="comment"># maxUnavailable: 1</span></div><div class="line">  <span class="comment"># minAvailable: 1</span></div><div class="line"></div><div class="line"><span class="comment">## Configures redis with AUTH (requirepass &amp; masterauth conf params)</span></div><div class="line"><span class="attr">auth:</span> <span class="literal">false</span></div><div class="line"><span class="comment"># redisPassword:</span></div><div class="line"></div><div class="line"><span class="comment">## Use existing secret containing key `authKey` (ignores redisPassword)</span></div><div class="line"><span class="comment"># existingSecret:</span></div><div class="line"></div><div class="line"><span class="comment">## Defines the key holding the redis password in existing secret.</span></div><div class="line"><span class="attr">authKey:</span> auth</div><div class="line"></div><div class="line"><span class="attr">persistentVolume:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line">  <span class="comment">## redis-ha data Persistent Volume Storage Class</span></div><div class="line">  <span class="comment">## If defined, storageClassName: &lt;storageClass&gt;</span></div><div class="line">  <span class="comment">## If set to "-", storageClassName: "", which disables dynamic provisioning</span></div><div class="line">  <span class="comment">## If undefined (the default) or set to null, no storageClassName spec is</span></div><div class="line">  <span class="comment">##   set, choosing the default provisioner.  (gp2 on AWS, standard on</span></div><div class="line">  <span class="comment">##   GKE, AWS &amp; OpenStack)</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># storageClass: "-"</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">    -</span> ReadWriteOnce</div><div class="line"><span class="attr">  size:</span> <span class="number">10</span>Gi</div><div class="line"><span class="attr">  annotations:</span> &#123;&#125;</div><div class="line">  <span class="comment"># reclaimPolicy per https://kubernetes.io/docs/concepts/storage/persistent-volumes/#reclaiming</span></div><div class="line"><span class="attr">  reclaimPolicy:</span> <span class="string">""</span></div><div class="line"><span class="attr">init:</span></div><div class="line"><span class="attr">  resources:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="comment"># To use a hostPath for data, set persistentVolume.enabled to false</span></div><div class="line"><span class="comment"># and define hostPath.path.</span></div><div class="line"><span class="comment"># Warning: this might overwrite existing folders on the host system!</span></div><div class="line"><span class="attr">hostPath:</span></div><div class="line">  <span class="comment">## path is evaluated as template so placeholders are replaced</span></div><div class="line">  <span class="comment"># path: "/data/&#123;&#123; .Release.Name &#125;&#125;"</span></div><div class="line"></div><div class="line">  <span class="comment"># if chown is true, an init-container with root permissions is launched to</span></div><div class="line">  <span class="comment"># change the owner of the hostPath folder to the user defined in the</span></div><div class="line">  <span class="comment"># security context</span></div><div class="line"><span class="attr">  chown:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="attr">emptyDir:</span> &#123;&#125;</div></pre></td></tr></table></figure>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>. 修改 “hardAntiAffinity: <span class="literal">true</span>” 为 “hardAntiAffinity: <span class="literal">false</span>” (仅限当replicas &gt; worker <span class="keyword">node</span> <span class="title">节点数时修改)</span></div><div class="line">2. 修改 “auth: <span class="literal">false</span>” 为 “auth: <span class="literal">true</span>”，打开 “<span class="comment"># redisPassword:” 的注释并设置密码</span></div><div class="line"><span class="number">1</span>. 打开 “ <span class="comment"># storageClass: “-“ ” 的注释，并修改 “-” 为 集群中的自动供给卷 “managed-nfs-storage”， 配置中 “size: 10Gi” 的大小为默认设置，可根据需要进行调整</span></div></pre></td></tr></table></figure>
<p>接着，我们来通过如下helm命令来创建redis集群，</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">helm install --namespace  redis redis-<span class="keyword">ha</span> -<span class="keyword">f</span> ./<span class="built_in">values</span>.yaml ./redis-<span class="keyword">ha</span></div><div class="line">helm upgrade redis-<span class="keyword">ha</span> --namespace redis -<span class="keyword">f</span> <span class="built_in">values</span>.yaml ./redis-<span class="keyword">ha</span></div><div class="line">helm <span class="keyword">delete</span> redis-<span class="keyword">ha</span> --namespace redis</div></pre></td></tr></table></figure>
<p>创建成功之后，会有如下输出，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">NAME: test-redis</div><div class="line">LAST DEPLOYED: Sat Jul 17 21:56:12 2021</div><div class="line">NAMESPACE: redis</div><div class="line">STATUS: deployed</div><div class="line">REVISION: 1</div><div class="line">TEST SUITE: None</div><div class="line">NOTES:</div><div class="line">** Please be patient while the chart is being deployed **</div><div class="line"></div><div class="line">Redis(TM) can be accessed on the following DNS names from within your cluster:</div><div class="line"></div><div class="line">    test-redis-master.redis.svc.cluster.local for read/write operations (port 6379)</div><div class="line">    test-redis-replicas.redis.svc.cluster.local for read-only operations (port 6379)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">To get your password run:</div><div class="line"></div><div class="line">    export REDIS_PASSWORD=$(kubectl get secret --namespace redis test-redis -o jsonpath=&quot;&#123;.data.redis-password&#125;&quot; | base64 --decode)</div><div class="line"></div><div class="line">To connect to your Redis(TM) server:</div><div class="line"></div><div class="line">1. Run a Redis(TM) pod that you can use as a client:</div><div class="line"></div><div class="line">   kubectl run --namespace redis redis-client --restart=&apos;Never&apos;  --env REDIS_PASSWORD=$REDIS_PASSWORD  --image docker.io/bitnami/redis:6.2.4-debian-10-r13 --command -- sleep infinity</div><div class="line"></div><div class="line">   Use the following command to attach to the pod:</div><div class="line"></div><div class="line">   kubectl exec --tty -i redis-client \</div><div class="line">   --namespace redis -- bash</div><div class="line"></div><div class="line">2. Connect using the Redis(TM) CLI:</div><div class="line">   redis-cli -h test-redis-master -a $REDIS_PASSWORD</div><div class="line">   redis-cli -h test-redis-replicas -a $REDIS_PASSWORD</div><div class="line"></div><div class="line">To connect to your database from outside the cluster execute the following commands:</div><div class="line"></div><div class="line">    export NODE_IP=$(kubectl get nodes --namespace redis -o jsonpath=&quot;&#123;.items[0].status.addresses[0].address&#125;&quot;)</div><div class="line">    export NODE_PORT=$(kubectl get --namespace redis -o jsonpath=&quot;&#123;.spec.ports[0].nodePort&#125;&quot; services test-redis-master)</div><div class="line">    redis-cli -h $NODE_IP -p $NODE_PORT -a $REDIS_PASSWORD</div></pre></td></tr></table></figure>
<p>这样等待redis集群的创建了，我们也可以通过命令查看是否创建成功：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ kubectl get all -n redis</div><div class="line">NAME                        READY   STATUS    RESTARTS   AGE</div><div class="line">pod<span class="regexp">/test-redis-master-0     1/</span><span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">24</span>h</div><div class="line">pod<span class="regexp">/test-redis-replicas-0   1/</span><span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">24</span>h</div><div class="line">pod<span class="regexp">/test-redis-replicas-1   1/</span><span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">24</span>h</div><div class="line">pod<span class="regexp">/test-redis-replicas-2   1/</span><span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">23</span>h</div><div class="line"></div><div class="line">NAME                          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</div><div class="line">service<span class="regexp">/test-redis-headless   ClusterIP   None           &lt;none&gt;        6379/</span>TCP         <span class="number">24</span>h</div><div class="line">service<span class="regexp">/test-redis-master     NodePort    172.21.0.201   &lt;none&gt;        6379:30676/</span>TCP   <span class="number">24</span>h</div><div class="line">service<span class="regexp">/test-redis-replicas   NodePort    172.21.6.241   &lt;none&gt;        6379:32112/</span>TCP   <span class="number">24</span>h</div><div class="line"></div><div class="line">NAME                                   READY   AGE</div><div class="line">statefulset.apps<span class="regexp">/test-redis-master     1/</span><span class="number">1</span>     <span class="number">24</span>h</div><div class="line">statefulset.apps<span class="regexp">/test-redis-replicas   3/</span><span class="number">3</span>     <span class="number">24</span>h</div></pre></td></tr></table></figure>
<p>这样创建全部成功，接下来就是使用redis了。</p>
<h3 id="验证-redis-ha"><a href="#验证-redis-ha" class="headerlink" title="验证 redis-ha"></a>验证 redis-ha</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">#查看所有 pod</span></div><div class="line">kubectl get pods</div><div class="line"><span class="comment">#执行结果</span></div><div class="line">NAME                                      READY   STATUS    RESTARTS   AGE</div><div class="line">nfs-client-provisioner-<span class="number">779</span>bcc9dbb-vfjtl   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">3</span>          <span class="number">2</span>d20h</div><div class="line">redis-ha-server-<span class="number">0</span>                         <span class="number">3</span>/<span class="number">3</span>     Running   <span class="number">1</span>          <span class="number">5</span>h32m</div><div class="line">redis-ha-server-<span class="number">1</span>                         <span class="number">3</span>/<span class="number">3</span>     Running   <span class="number">0</span>          <span class="number">5</span>h32m</div><div class="line"></div><div class="line"><span class="comment">#进入 redis-ha-server-0 容器内</span></div><div class="line"> kubectl exec -it redis-ha-server-<span class="number">0</span>  sh</div><div class="line"> 执行结果</div><div class="line"> Defaulting container name to redis.</div><div class="line">Use <span class="string">'kubectl describe pod/redis-ha-server-0 -n default'</span> to see all of the containers <span class="keyword">in</span> this pod.</div><div class="line">/data $ </div><div class="line"></div><div class="line"><span class="comment"># redis-cli 测试</span></div><div class="line">/data $ redis-cli</div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> auth xxxxxxxxxxx(此处为 values.yaml 文件中设置过的密码)</div><div class="line">OK</div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> keys *</div><div class="line"><span class="number">1</span>) <span class="string">"test"</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> get test</div><div class="line"><span class="string">"111"</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> set test <span class="number">222</span></div><div class="line">OK</div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> get test</div><div class="line"><span class="string">"222"</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>如果需要暴露给外部使用则需要再部署一个 NodePort Service</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master redis-cluster]<span class="comment"># cat service.yaml </span></div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: redis-ha-service    <span class="comment">#名称：随意</span></div><div class="line">  namespace: redis   <span class="comment">#名称：随意</span></div><div class="line">  labels:</div><div class="line">    app: redis-ha           <span class="comment">#部署的 redis-ha 名称</span></div><div class="line">spec:</div><div class="line">  ports:</div><div class="line">  - name: redis-ha          <span class="comment">#部署的 redis-ha 名称</span></div><div class="line">    protocol: <span class="string">"TCP"</span>           <span class="comment">#TCP 协议</span></div><div class="line">    port: 26379             </div><div class="line">    targetPort: 6379        </div><div class="line">    nodePort: 30379         <span class="comment">#此为外部连接k8s redis-ha 服务的端口</span></div><div class="line">  selector:</div><div class="line">    statefulset.kubernetes.io/pod-name: redis-ha-server-0</div><div class="line">  <span class="built_in">type</span>: NodePort</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#部署 Service</span></div><div class="line">kubectl apply <span class="_">-f</span> service.yaml</div><div class="line"></div><div class="line"><span class="comment">#查看部署结果</span></div><div class="line">kubectl get svc</div><div class="line">执行结果</div><div class="line">NAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                       AGE</div><div class="line">kubernetes            ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                       2d21h</div><div class="line">redis-ha              ClusterIP   None             &lt;none&gt;        6379/TCP,26379/TCP,9121/TCP   5h47m</div><div class="line">redis-ha-announce-0   ClusterIP   10.99.18.87      &lt;none&gt;        6379/TCP,26379/TCP,9121/TCP   5h47m</div><div class="line">redis-ha-announce-1   ClusterIP   10.100.130.186   &lt;none&gt;        6379/TCP,26379/TCP,9121/TCP   5h47m</div><div class="line">redis-ha-service      NodePort    10.109.28.12     &lt;none&gt;        26379:30379/TCP               3h25m</div><div class="line"></div><div class="line"><span class="comment">#此时可以通过 k8s 任意 master 节点 IP:30379 端口进行连接</span></div></pre></td></tr></table></figure>
<p><strong>故障转移实验</strong></p>
<p><strong>停止主redis：</strong></p>
<p><a href=""><img src="http://image-peterfei-blog.test.upcdn.net/copycode-20230511205316397.gif" alt="复制代码"></a></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">#<span class="number">1</span>、在主上故障转移测试，使主down掉</div><div class="line">redis-cli -h redis-ha-announce<span class="number">-0</span> -p <span class="number">6379</span> debug segfault</div><div class="line"></div><div class="line">#<span class="number">2</span>、然后进入redis容器或sentinel容器</div><div class="line">kubectl exec -it redis-ha-server<span class="number">-2</span> -c redis sh</div><div class="line">kubectl exec -it redis-ha-server<span class="number">-0</span> -c sentinel sh</div><div class="line"></div><div class="line">#<span class="number">3</span>、容器里面使用redis客户端连接redis服务端</div><div class="line">redis-cli -h redis-ha-announce<span class="number">-1</span> -p <span class="number">6379</span> </div><div class="line">redis-cli -h redis-ha-announce<span class="number">-2</span> -p <span class="number">6379</span></div><div class="line">#容器里面使用redis客户端连接Sentinel服务端</div><div class="line">redis-cli -h redis-ha-announce<span class="number">-0</span> -p <span class="number">26379</span></div><div class="line"></div><div class="line"></div><div class="line">#<span class="number">4</span>、redis查看主从状态</div><div class="line">info replication</div><div class="line">#sentinel查看状态 </div><div class="line">INFO Sentinel</div><div class="line"></div><div class="line">#<span class="number">5</span>、查看日志</div><div class="line">kubectl logs -f  redis-ha-server<span class="number">-0</span> -c redis</div><div class="line">kubectl logs -f  redis-ha-server<span class="number">-1</span> -c redis</div><div class="line">kubectl logs -f  redis-ha-server<span class="number">-2</span> -c redis</div></pre></td></tr></table></figure>
<p><a href=""><img src="http://image-peterfei-blog.test.upcdn.net/copycode.gif" alt="复制代码"></a></p>
<p>#主前任主上查看redis主从状态如下，10.106.29.241是第三台redis的ip，说转换成功了</p>
<p><img src="http://image-peterfei-blog.test.upcdn.net/972749-20190327150510717-1641374811-20230511205209692.png" alt="img"></p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2023/04/18/Kafka入门及进阶/" itemprop="url">
                  Kafka入门及进阶段
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2023-04-18T09:19:14+08:00" content="2023-04-18">
              2023-04-18
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2023/04/18/Kafka入门及进阶/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2023/04/18/Kafka入门及进阶/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-1-Kafka入门"><a href="#1-1-Kafka入门" class="headerlink" title="1.1 Kafka入门"></a>1.1 Kafka入门</h2><h2 id="一、Kafka-是什么？"><a href="#一、Kafka-是什么？" class="headerlink" title="一、Kafka 是什么？"></a>一、Kafka 是什么？</h2><p>有人说世界上有三个伟大的发明：火，轮子，以及 Kafka。</p>
<p>发展到现在，Apache Kafka 无疑是很成功的，Confluent 公司曾表示世界五百强中有三分之一的企业在使用 Kafka。在流式计算中，Kafka 一般用来缓存数据，例如 Flink 通过消费 Kafka 的数据进行计算。</p>
<p><img src="http://image-peterfei-blog.test.upcdn.net//20200915160628313.png" alt="image"></p>
<p>关于Kafka，我们最开始需要了解的是以下四点：</p>
<p>1.Apache Kafka 是一个开源 消息 系统，由 Scala 写成。是由 Apache 软件基金会开发的 一个开源消息系统项目。</p>
<p>2.Kafka 最初是由 LinkedIn 公司开发，用作 LinkedIn 的活动流（Activity Stream）和运营数据处理管道（Pipeline）的基础，现在它已被多家不同类型的公司作为多种类型的数据管道和消息系统使用。</p>
<p>3.Kafka 是一个分布式消息队列。Kafka 对消息保存时根据 Topic 进行归类，发送消息 者称为 Producer，消息接受者称为 Consumer，此外 kafka 集群有多个 kafka 实例组成，每个 实例(server)称为 broker。</p>
<p>4.无论是 kafka 集群，还是 consumer 都依赖于 Zookeeper 集群保存一些 meta 信息， 来保证系统可用性。</p>
<h2 id="二、为什么要有-Kafka"><a href="#二、为什么要有-Kafka" class="headerlink" title="二、为什么要有 Kafka?"></a>二、为什么要有 Kafka?</h2><p>kafka 之所以受到越来越多的青睐，与它所扮演的三大角色是分不开的的：</p>
<p>消息系统：kafka与传统的消息中间件都具备系统解耦、冗余存储、流量削峰、缓冲、异步通信、扩展性、可恢复性等功能。与此同时，kafka还提供了大多数消息系统难以实现的消息顺序性保障及回溯性消费的功能。</p>
<p>存储系统：kafka把消息持久化到磁盘，相比于其他基于内存存储的系统而言，有效的降低了消息丢失的风险。这得益于其消息持久化和多副本机制。也可以将kafka作为长期的存储系统来使用，只需要把对应的数据保留策略设置为“永久”或启用主题日志压缩功能。</p>
<p>流式处理平台：kafka为流行的流式处理框架提供了可靠的数据来源，还提供了一个完整的流式处理框架，比如窗口、连接、变换和聚合等各类操作。</p>
<p><img src="http://image-peterfei-blog.test.upcdn.net/2c447e5d62fc4332a6da3eca019f25c2.png" alt="image.png"></p>
<h2 id="三、Kafka-基本概念"><a href="#三、Kafka-基本概念" class="headerlink" title="三、Kafka 基本概念"></a>三、Kafka 基本概念</h2><p>在深入理解 Kafka 之前，可以先了解下 Kafka 的基本概念。</p>
<p>一个典型的 Kafka 包含若干Producer、若干 Broker、若干 Consumer 以及一个 Zookeeper 集群。Zookeeper 是 Kafka 用来负责集群元数据管理、控制器选举等操作的。Producer 是负责将消息发送到 Broker 的，Broker 负责将消息持久化到磁盘，而 Consumer 是负责从Broker 订阅并消费消息。Kafka体系结构如下所示：</p>
<p><img src="http://image-peterfei-blog.test.upcdn.net//watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JlaWlzQmVp,size_1,color_FFFFFF,t_70.png" alt="image"></p>
<h3 id="概念一：生产者（Producer）与消费者（Consumer）"><a href="#概念一：生产者（Producer）与消费者（Consumer）" class="headerlink" title="概念一：生产者（Producer）与消费者（Consumer）"></a>概念一：生产者（Producer）与消费者（Consumer）</h3><p><img src="http://image-peterfei-blog.test.upcdn.net//watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JlaWlzQmVp,size_1,color_FFFFFF,t_70-20230420181114281.png" alt="image"></p>
<p>对于 Kafka 来说客户端有两种基本类型：生产者（Producer）和 消费者（Consumer）。除此之外，还有用来做数据集成的 Kafka Connect API 和流式处理的 Kafka Streams 等高阶客户端，但这些高阶客户端底层仍然是生产者和消费者API，只不过是在上层做了封装。</p>
<p>Producer ：消息生产者，就是向 Kafka broker 发消息的客户端；</p>
<p>Consumer ：消息消费者，向 Kafka broker 取消息的客户端；</p>
<h3 id="概念二：Broker-和集群（Cluster）"><a href="#概念二：Broker-和集群（Cluster）" class="headerlink" title="概念二：Broker 和集群（Cluster）"></a>概念二：Broker 和集群（Cluster）</h3><p>一个 Kafka 服务器也称为 Broker，它接受生产者发送的消息并存入磁盘；Broker 同时服务消费者拉取分区消息的请求，返回目前已经提交的消息。使用特定的机器硬件，一个 Broker 每秒可以处理成千上万的分区和百万量级的消息。</p>
<p>若干个 Broker 组成一个 集群（Cluster），其中集群内某个 Broker 会成为集群控制器（Cluster Controller），它负责管理集群，包括分配分区到 Broker、监控 Broker 故障等。在集群内，一个分区由一个 Broker 负责，这个 Broker 也称为这个分区的 Leader；当然一个分区可以被复制到多个 Broker 上来实现冗余，这样当存在 Broker 故障时可以将其分区重新分配到其他 Broker 来负责。下图是一个样例：</p>
<p><img src="http://image-peterfei-blog.test.upcdn.net//watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JlaWlzQmVp,size_1,color_FFFFFF,t_70-20230420181200160.png" alt="image"></p>
<h3 id="概念三：主题（Topic）与分区（Partition）"><a href="#概念三：主题（Topic）与分区（Partition）" class="headerlink" title="概念三：主题（Topic）与分区（Partition）"></a>概念三：主题（Topic）与分区（Partition）</h3><p><img src="http://image-peterfei-blog.test.upcdn.net//watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JlaWlzQmVp,size_1,color_FFFFFF,t_70-20230420181206240.png" alt="image"></p>
<p>在 Kafka 中，消息以 主题（Topic）来分类，每一个主题都对应一个「消息队列」，这有点儿类似于数据库中的表。但是如果我们把所有同类的消息都塞入到一个“中心”队列中，势必缺少可伸缩性，无论是生产者/消费者数目的增加，还是消息数量的增加，都可能耗尽系统的性能或存储。</p>
<p><strong>Kafka是天然分布式的</strong>。</p>
<p><strong>备份分区仅仅用作于备份，不做读写。</strong>如果某个Broker挂了，那就会选举出其他Broker的partition来作为主分区，这就实现了<strong>高可用</strong>。</p>
<p>另外值得一提的是：当生产者把数据丢进topic时，我们知道是写在partition上的，那partition是怎么将其持久化的呢？（不持久化如果Broker中途挂了，那肯定会丢数据嘛)。</p>
<p>Kafka是将partition的数据写在<strong>磁盘</strong>的(消息日志)，不过Kafka只允许<strong>追加写入</strong>(顺序访问)，避免缓慢的随机 I/O 操作。</p>
<ul>
<li>Kafka也不是partition一有数据就立马将数据写到磁盘上，它会先<strong>缓存</strong>一部分，等到足够多数据量或等待一定的时间再批量写入(flush)。</li>
</ul>
<p>消费者在读的时候也很有讲究：正常的读磁盘数据是需要将内核态数据拷贝到用户态的，而Kafka 通过调用<code>sendfile()</code>直接从内核空间（DMA的）到内核空间（Socket的），<strong>少做了一步拷贝</strong>的操作。</p>
<p><img src="http://image-peterfei-blog.test.upcdn.net//v2-ecf911716b70f836b2a607157bbf11eb_1440w.webp" alt="img"></p>
<blockquote>
<p>附docker-compose.yml 脚本</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"><span class="attr">version:</span> <span class="string">"3"</span></div><div class="line"><span class="attr">services:</span></div><div class="line"><span class="attr">  zookeeper:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">'confluentinc/cp-zookeeper:6.2.0'</span></div><div class="line"><span class="attr">    hostname:</span> zookeeper</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">'2181:2181'</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line">      <span class="comment"># 匿名登录--必须开启</span></div><div class="line"><span class="bullet">      -</span> ALLOW_ANONYMOUS_LOGIN=<span class="literal">yes</span></div><div class="line"><span class="bullet">      -</span> ZOOKEEPER_CLIENT_PORT=<span class="number">2181</span></div><div class="line"><span class="bullet">      -</span> ZOOKEEPER_TICK_TIME=<span class="number">2000</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> ./zookeeper/data:/var/lib/zookeeper/data:Z</div><div class="line"><span class="bullet">      -</span> ./zookeeper/log:/var/lib/zookeeper/log:Z</div><div class="line">  <span class="comment"># 该镜像具体配置参考 https://github.com/bitnami/bitnami-docker-kafka/blob/master/README.md</span></div><div class="line"><span class="attr">  broker:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">'confluentinc/cp-kafka:6.2.0'</span></div><div class="line"><span class="attr">    hostname:</span> broker</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">'9092:9092'</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"29092:29092"</span></div><div class="line">      <span class="comment">#- '9999:9999'</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> KAFKA_BROKER_ID=<span class="number">1</span></div><div class="line"><span class="bullet">      -</span> KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</div><div class="line"><span class="bullet">      -</span> KAFKA_CFG_LISTENERS=PLAINTEXT://:<span class="number">9092</span></div><div class="line"><span class="bullet">      -</span> KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://<span class="number">192.168</span><span class="number">.3</span><span class="number">.92</span>:<span class="number">9092</span>,PLAINTEXT_HOST://localhost:<span class="number">29092</span></div><div class="line">      <span class="comment">#- KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT</span></div><div class="line">      <span class="comment"># 客户端访问地址，更换成自己的</span></div><div class="line">      <span class="comment">#- KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://192.168.3.92:9092</span></div><div class="line"><span class="bullet">      -</span> KAFKA_ZOOKEEPER_CONNECT=zookeeper:<span class="number">2181</span></div><div class="line"><span class="bullet">      -</span> KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=<span class="number">0</span></div><div class="line">      <span class="comment"># 允许使用PLAINTEXT协议(镜像中默认为关闭,需要手动开启)</span></div><div class="line"><span class="bullet">      -</span> ALLOW_PLAINTEXT_LISTENER=<span class="literal">yes</span></div><div class="line">      <span class="comment"># 关闭自动创建 topic 功能</span></div><div class="line">      <span class="comment">#- KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=false</span></div><div class="line">      <span class="comment"># 全局消息过期时间 6 小时(测试时可以设置短一点)</span></div><div class="line"><span class="bullet">      -</span> KAFKA_CFG_LOG_RETENTION_HOURS=<span class="number">6</span></div><div class="line"><span class="bullet">      -</span> KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=<span class="number">1</span></div><div class="line"><span class="bullet">      -</span> KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=<span class="number">1</span></div><div class="line"><span class="bullet">      -</span> KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=<span class="number">1</span></div><div class="line"><span class="bullet">      -</span> KAFKA_HEAP_OPTS=-Xmx256M -Xms128M</div><div class="line">      <span class="comment"># 开启JMX监控</span></div><div class="line">      <span class="comment">#- JMX_PORT=9999</span></div><div class="line">      <span class="comment">#- KAFKA_JMX_OPTS= -Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=192.168.3.92 -Dcom.sun.management.jmxremote.rmi.port=9999  -Dcom.sun.management.jmxremote.port=9999</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> ./kafka/data:/var/lib/kafka/data:Z</div><div class="line"><span class="bullet">      -</span> ./kafka/config:/var/lib/kafka/config:Z</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> zookeeper</div><div class="line"><span class="attr">  schema-registry:</span></div><div class="line"><span class="attr">    image:</span> confluentinc/cp-schema-registry:<span class="number">6.2</span><span class="number">.0</span></div><div class="line"><span class="attr">    hostname:</span> schema-registry</div><div class="line"><span class="attr">    container_name:</span> schema-registry</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> zookeeper</div><div class="line"><span class="bullet">      -</span> broker</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"8081:8081"</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="attr">      SCHEMA_REGISTRY_HOST_NAME:</span> schema-registry</div><div class="line"><span class="attr">      SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL:</span> zookeeper:<span class="number">2181</span></div><div class="line">      </div><div class="line"><span class="attr">  connect:</span></div><div class="line"><span class="attr">    image:</span> confluentinc/cp-kafka-connect:latest</div><div class="line"><span class="attr">    hostname:</span> connect</div><div class="line"><span class="attr">    container_name:</span> connect</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> zookeeper</div><div class="line"><span class="bullet">      -</span> broker</div><div class="line"><span class="bullet">      -</span> schema-registry</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"8083:8083"</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="attr">      CONNECT_BOOTSTRAP_SERVERS:</span> broker:<span class="number">29092</span></div><div class="line"><span class="attr">      CONNECT_REST_ADVERTISED_HOST_NAME:</span> localhost</div><div class="line"><span class="attr">      CONNECT_REST_PORT:</span> <span class="number">8083</span></div><div class="line"><span class="attr">      CONNECT_GROUP_ID:</span> ksql-connect-cluster</div><div class="line"><span class="attr">      CONNECT_OFFSET_STORAGE_TOPIC:</span> ksql-connect-configs</div><div class="line"><span class="attr">      CONNECT_CONFIG_STORAGE_TOPIC:</span> ksql-connect-topics</div><div class="line"><span class="attr">      CONNECT_STATUS_STORAGE_TOPIC:</span> ksql-connect-statuses</div><div class="line"><span class="attr">      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR:</span> <span class="number">1</span></div><div class="line"><span class="attr">      CONNECT_OFFSET_FLUSH_INTERVAL_MS:</span> <span class="number">10000</span></div><div class="line"><span class="attr">      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR:</span> <span class="number">1</span></div><div class="line"><span class="attr">      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR:</span> <span class="number">1</span></div><div class="line"><span class="attr">      CONNECT_KEY_CONVERTER:</span> org.apache.kafka.connect.storage.StringConverter</div><div class="line"><span class="attr">      CONNECT_VALUE_CONVERTER:</span> io.confluent.connect.avro.AvroConverter</div><div class="line"><span class="attr">      CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL:</span> http://schema-registry:<span class="number">8081</span></div><div class="line"><span class="attr">      CONNECT_INTERNAL_KEY_CONVERTER:</span> <span class="string">"org.apache.kafka.connect.json.JsonConverter"</span></div><div class="line"><span class="attr">      CONNECT_INTERNAL_VALUE_CONVERTER:</span> <span class="string">"org.apache.kafka.connect.json.JsonConverter"</span></div><div class="line"><span class="attr">      CONNECT_ZOOKEEPER_CONNECT:</span> <span class="string">'zookeeper:2181'</span></div><div class="line"><span class="attr">  ksqldb-server:</span></div><div class="line"><span class="attr">    image:</span> confluentinc/ksqldb-server:latest</div><div class="line"><span class="attr">    hostname:</span> ksqldb-server</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> broker</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"8088:8088"</span></div><div class="line">    <span class="comment">#healthcheck:</span></div><div class="line">    <span class="comment">#  test: curl -f http://ksqldb-server:8088/ || exit 1</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="attr">      KSQL_LISTENERS:</span> http://<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8088</span></div><div class="line"><span class="attr">      KSQL_BOOTSTRAP_SERVERS:</span> <span class="number">192.168</span><span class="number">.3</span><span class="number">.92</span>:<span class="number">9092</span></div><div class="line"><span class="attr">      KSQL_KSQL_LOGGING_PROCESSING_STREAM_AUTO_CREATE:</span> <span class="string">"true"</span></div><div class="line"><span class="attr">      KSQL_KSQL_LOGGING_PROCESSING_TOPIC_AUTO_CREATE:</span> <span class="string">"true"</span></div><div class="line"><span class="attr">      KSQL_KSQL_CONNECT_URL:</span> http://connect:<span class="number">8083</span></div><div class="line"></div><div class="line"><span class="attr">  ksqldb-cli:</span></div><div class="line"><span class="attr">    image:</span> confluentinc/ksqldb-cli:latest</div><div class="line"><span class="attr">    container_name:</span> ksqldb-cli</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> ksqldb-server</div><div class="line"><span class="bullet">      -</span> broker</div><div class="line"><span class="attr">    entrypoint:</span> /bin/sh</div><div class="line"><span class="attr">    tty:</span> <span class="literal">true</span></div></pre></td></tr></table></figure>
<blockquote>
<p>Kafka topic CLI:</p>
</blockquote>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">kafka</span><span class="literal">-</span><span class="comment">topics</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">bootstrap</span><span class="literal">-</span><span class="comment">server</span> <span class="comment">localhost:9092</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">list</span></div></pre></td></tr></table></figure>
<p><img src="http://image-peterfei-blog.test.upcdn.net//image-20230418103634592.png" alt="image-20230418103634592"></p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">kafka</span><span class="literal">-</span><span class="comment">console</span><span class="literal">-</span><span class="comment">producer</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">broker</span><span class="literal">-</span><span class="comment">list</span> <span class="comment">localhost:9092</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">topic</span> <span class="comment">test</span></div></pre></td></tr></table></figure>
<p><img src="http://image-peterfei-blog.test.upcdn.net//image-20230418103936415.png" alt="image-20230418103936415"></p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">kafka</span><span class="literal">-</span><span class="comment">console</span><span class="literal">-</span><span class="comment">consumer</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">bootstrap</span><span class="literal">-</span><span class="comment">server</span> <span class="comment">localhost:9092</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">topic</span> <span class="comment">test</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">from</span><span class="literal">-</span><span class="comment">beginning</span></div></pre></td></tr></table></figure>
<p><img src="http://image-peterfei-blog.test.upcdn.net//image-20230418104000562.png" alt="image-20230418104000562"></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">exec</span> -it ksqldb-cli ksql http:<span class="comment">//ksqldb-server:8088</span></div></pre></td></tr></table></figure>
<p><img src="http://image-peterfei-blog.test.upcdn.net//image-20230418110419615.png" alt="image-20230418110419615"></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">show </span>topics<span class="comment">;</span></div></pre></td></tr></table></figure>
<p><img src="http://image-peterfei-blog.test.upcdn.net//image-20230418110443996.png" alt="image-20230418110443996"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> STREAM riderLocations (profileId <span class="built_in">VARCHAR</span>, latitude <span class="keyword">DOUBLE</span>, longitude <span class="keyword">DOUBLE</span>)</div><div class="line">  <span class="keyword">WITH</span> (kafka_topic=<span class="string">'locations'</span>, value_format=<span class="string">'json'</span>, <span class="keyword">partitions</span>=<span class="number">1</span>);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'c2309eec'</span>, <span class="number">37.7877</span>, <span class="number">-122.4205</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'18f4ea86'</span>, <span class="number">37.3903</span>, <span class="number">-122.0643</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'4ab5cbad'</span>, <span class="number">37.3952</span>, <span class="number">-122.0813</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'8b6eae59'</span>, <span class="number">37.3944</span>, <span class="number">-122.0813</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'4a7c7b41'</span>, <span class="number">37.4049</span>, <span class="number">-122.0822</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'4ddad000'</span>, <span class="number">37.7857</span>, <span class="number">-122.4011</span>);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>select * from riderLocations;</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ksql&gt; select * from riderLocations;</div></pre></td></tr></table></figure>
<p><img src="http://image-peterfei-blog.test.upcdn.net//image-20230418111709787.png" alt="image-20230418111709787"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> myNearDemo <span class="keyword">AS</span> \</div><div class="line">&gt;<span class="keyword">select</span> profileId,la,lo <span class="keyword">from</span> currentLocation ;</div></pre></td></tr></table></figure>
<p><img src="http://image-peterfei-blog.test.upcdn.net//image-20230418151308205.png" alt="image-20230418151308205"></p>
<blockquote>
<p>监测变化</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> myNearDemo EMIT CHANGES;</div></pre></td></tr></table></figure>
<p><img src="http://image-peterfei-blog.test.upcdn.net//image-20230418151345474.png" alt="image-20230418151345474"></p>
<blockquote>
<p>原始流 stream 里插入元数据</p>
</blockquote>
<p><img src="http://image-peterfei-blog.test.upcdn.net//image-20230418151452071.png" alt="image-20230418151452071"></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="selector-tag">ksql</span>&gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">riderLocations</span> (profileId, latitude, longitude) <span class="selector-tag">VALUES</span> (<span class="string">'4ddad000'</span>, <span class="number">38.7857</span>, -<span class="number">122.4012</span>);</div></pre></td></tr></table></figure>
<p><img src="http://image-peterfei-blog.test.upcdn.net//image-20230418151605116-1980097.png" alt="image-20230418151605116" style="zoom:33%;"></p>
<blockquote>
</blockquote>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2023/02/22/Mysql使用pt-query-digest分析日志/" itemprop="url">
                  Mysql使用pt-query-digest分析日志
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2023-02-22T15:16:20+08:00" content="2023-02-22">
              2023-02-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2023/02/22/Mysql使用pt-query-digest分析日志/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2023/02/22/Mysql使用pt-query-digest分析日志/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-开启慢查询日志"><a href="#1-开启慢查询日志" class="headerlink" title="1. 开启慢查询日志"></a>1. 开启慢查询日志</h3><p>（1）首先我们要创建一个文件夹用于保存慢查询日志文件，并且设置 <strong>mysql</strong> 有权读写该目录：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir` `/``var``/log/mysql``sudo ``chown` `mysql:mysql -R /``var``/log/mysql</div></pre></td></tr></table></figure>
<p>（2）我们可以登入 <strong>mysql</strong> 命令行后执行如下命令，使用 <strong>set</strong> 设置变量来临时开启。注意这种方式重启服务即失效。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">set</span> <span class="string">``</span><span class="keyword">global</span><span class="string">` `</span>slow_query_log=<span class="keyword">on</span>; ``//开启慢查询功能``<span class="keyword">set</span> <span class="string">``</span><span class="keyword">global</span><span class="string">` `</span>slow_query_log_file=<span class="string">``</span><span class="string">'/var/log/mysql/mysql-slow.log'</span><span class="string">``</span>; ``//指定慢查询日志文件位置``<span class="keyword">set</span> <span class="string">``</span><span class="keyword">global</span><span class="string">` `</span>log_queries_not_using_indexes=<span class="keyword">on</span>;  ``//记录没有使用索引的查询（非必须）``<span class="keyword">set</span> <span class="string">``</span><span class="keyword">global</span><span class="string">` `</span>long_query_time=<span class="number">1</span>;  ``//只记录处理时间1s以上的慢查询</div></pre></td></tr></table></figure>
<p>（3）或者我们也可以通过修改配置文件来永久开启慢查询日志功能，首先编辑配置文件：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vi</span> /etc/my.<span class="keyword">cnf</span></div></pre></td></tr></table></figure>
<ul>
<li>然后在里面添加如下高亮配置：</li>
</ul>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[mysqld]``slow_query_log=on #开启慢查询功能``slow_query_log_file=``<span class="string">'/var/log/mysql/mysql-slow.log'</span>` `#指定慢查询日志文件位置``log_queries_not_using_indexes=on  #记录没有使用索引的查询（非必须）``long_query_time=<span class="number">1</span>  #只记录处理时间<span class="number">1</span>s以上的慢查询</div></pre></td></tr></table></figure>
<ul>
<li>保存关闭文件后，执行如下命令重启 <strong>mysql</strong> 即可：</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">service mysqld restart</span></div></pre></td></tr></table></figure>
<h3 id="2-查看慢查询功能是否开启"><a href="#2-查看慢查询功能是否开启" class="headerlink" title="2. 查看慢查询功能是否开启"></a>2. 查看慢查询功能是否开启</h3><p>（1）登入 <strong>mysql</strong> 命令行后执行如下命令可以查看慢查询开启状态，以及慢查询日志存放的位置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">``</span><span class="string">'slow_query%'</span><span class="string">``</span>;</div></pre></td></tr></table></figure>
<p>（2）执行如下命令可以查看查询超过多少秒才记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">``</span><span class="string">'long_query_time'</span><span class="string">``</span>;</div></pre></td></tr></table></figure>
<h3 id="3-慢查询测试"><a href="#3-慢查询测试" class="headerlink" title="3. 慢查询测试"></a>3. 慢查询测试</h3><p>（1）首先我们执行一个如下的 <strong>sql</strong>，模拟一个 <strong>2</strong> 秒的慢查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">sleep</span>(<span class="number">2</span>);</div></pre></td></tr></table></figure>
<p>（2）查看日志可以发现这个慢查询已经被记录：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat /``var``/log/mysql/mysql-slow.log</div></pre></td></tr></table></figure>
<h2 id="使用-pt-query-digest-工具分析慢查询日志"><a href="#使用-pt-query-digest-工具分析慢查询日志" class="headerlink" title="使用 pt-query-digest 工具分析慢查询日志"></a>使用 pt-query-digest 工具分析慢查询日志</h2><h3 id="1，工具安装"><a href="#1，工具安装" class="headerlink" title="1，工具安装"></a>1，工具安装</h3><p>（1）首先我们执行如下命令将 <strong>rpm</strong> 包下载到本地：</p>
<p><strong>注意</strong>：如果下载不下来也可访问其官网（<a href="https://www.percona.com/downloads/percona-toolkit/3.2.1/binary/redhat/7/" target="_blank" rel="external">点击打开</a>），手动下载下来再上传到服务器上。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget https:``<span class="regexp">//</span>downloads.percona.com<span class="regexp">/downloads/</span>percona-toolkit<span class="regexp">/3.2.1/</span>binary<span class="regexp">/redhat/</span><span class="number">7</span><span class="regexp">/x86_64/</span>percona-toolkit-<span class="number">3.2</span>.<span class="number">1</span>-<span class="number">1</span>.el7.x86_64.rpm</div></pre></td></tr></table></figure>
<p>（2）接着使用 <strong>yum</strong> 命令进行安装：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">yum</span> <span class="selector-tag">install</span> <span class="selector-tag">-y</span> <span class="selector-tag">percona-toolkit-3</span><span class="selector-class">.2</span><span class="selector-class">.1-1</span><span class="selector-class">.el7</span><span class="selector-class">.x86_64</span><span class="selector-class">.rpm</span></div></pre></td></tr></table></figure>
<h3 id="2-分析慢查询日志"><a href="#2-分析慢查询日志" class="headerlink" title="2. 分析慢查询日志"></a>2. 分析慢查询日志</h3><p>（1）执行如下命令可以分析指定的慢查询日志文件：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-query-digest /``var``/log/mysql/mysql-slow.log</div></pre></td></tr></table></figure>
<p>（2）分析结果分为三部分，第一部分是总体统计结果：</p>
<ul>
<li><strong>Overall</strong>：总共有多少条查询</li>
<li><strong>Time range</strong>：查询执行的时间范围</li>
<li><strong>unique</strong>：唯一查询数量，即对查询条件进行参数化以后，总共有多少个不同的查询</li>
<li><strong>total</strong>：所有查询总计时长</li>
<li><strong>min</strong>：所有查询最小时长</li>
<li><strong>max</strong>：所有查询最大时长</li>
<li><strong>avg</strong>：所有查询平均时长</li>
<li><strong>95%</strong>：把所有时长值从小到大排列，位置位于 <strong>95%</strong> 的那个时长数，这个数一般最具有参考价值</li>
<li><strong>median</strong>：中位数，把所有时长值从小到大排列，位置位于中间那个时长数</li>
</ul>
<p>（3）第二部分是查询分组统计结果：</p>
<ul>
<li><strong>Rank</strong>：所有语句的排名，默认按查询时间降序排列，通过 <strong>–order-by</strong> 指定</li>
<li><strong>Query ID</strong>：语句的 <strong>ID</strong>（去掉多余空格和文本字符，计算 <strong>hash</strong> 值）</li>
<li><strong>Response</strong>：总的响应时间</li>
<li><strong>time</strong>：该查询在本次分析中总的时间占比</li>
<li><strong>Calls</strong>：执行次数，即本次分析总共有多少条这种类型的查询语句</li>
<li><strong>R/Call</strong>：平均每次执行的响应时间</li>
<li><strong>V/M</strong>：响应时间 <strong>Variance-to-mean</strong> 的比率</li>
<li><strong>Item</strong>：查询对象</li>
</ul>
<p>（4）第三部分是每一种查询比较慢的 <strong>sql</strong> 的详细统计结果：</p>
<ul>
<li><strong>pct</strong>：该 <strong>sql</strong> 语句某执行属性占所有慢查询语句某执行属性的百分比</li>
<li><strong>total</strong>：该 <strong>sql</strong> 语句某执行属性的所有属性时间。</li>
<li><strong>Count</strong>：<strong>sql</strong> 语句执行的次数。对应的 <strong>pct</strong> 表示此 <strong>sql</strong> 语句执行次数占所有慢查询语句执行次数的 <strong>%</strong> 比（下图为 <strong>10%</strong>），对应的 <strong>total</strong> 表示总共执行了 <strong>3</strong> 次。</li>
<li><strong>Exec time</strong>：<strong>sql</strong> 执行时间</li>
<li><strong>Lock time</strong>：<strong>sql</strong> 执行期间被锁定的时间</li>
<li><strong>Rows sent</strong>：传输的有效数据，在 <strong>select</strong> 查询语句中才有值</li>
<li><strong>Rows examine</strong>：总共查询的数据，非目标数据。</li>
<li><strong>Query_time distribution</strong>：查询时间分布</li>
<li><strong>SQL</strong> 语句：下图中为 <strong>select sleep(7)\G</strong></li>
</ul>
<h3 id="3-进阶用法"><a href="#3-进阶用法" class="headerlink" title="3. 进阶用法"></a>3. 进阶用法</h3><p>（1）分析 <strong>slow.log</strong> 日志，并将分析报告输入到 <strong>slow_report.log</strong> 中：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-<span class="keyword">query</span>-digest slow.<span class="keyword">log</span> &gt; slow_report.<span class="built_in">log</span></div></pre></td></tr></table></figure>
<p>（2）分析最近 <strong>12</strong> 小时内的查询：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-<span class="keyword">query</span>-digest --since=12h slow.<span class="keyword">log</span> &gt; slow_report2.<span class="built_in">log</span></div></pre></td></tr></table></figure>
<p>（3）分析指定时间范围内的查询：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-query-digest slow.log --since ``<span class="string">'2020-04-17 09:30:00'</span>` `--until ``<span class="string">'2020-04-17 10:00:00'</span>` `&gt; slow_report3.log</div></pre></td></tr></table></figure>
<p>（4）分析指含有 <strong>select</strong> 语句的慢查询：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-query-digest --<span class="keyword">filter</span> <span class="string">``</span><span class="string">'$event-&gt;&#123;fingerprint&#125; =~ m/^select/i'</span><span class="string">` `</span>slow.<span class="keyword">log</span>&gt; slow_report4.<span class="keyword">log</span></div></pre></td></tr></table></figure>
<p>（5）针对某个用户的慢查询：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-query-digest --<span class="keyword">filter</span> <span class="string">``</span><span class="string">'($event-&gt;&#123;user&#125; || "") =~ m/^root/i'</span><span class="string">` `</span>slow.<span class="keyword">log</span>&gt; slow_report5.<span class="keyword">log</span></div></pre></td></tr></table></figure>
<p>（6）查询所有的全表扫描或 <strong>full join</strong> 的慢查询：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-<span class="keyword">query</span>-digest --filter ``'((<span class="variable">$event</span>-&gt;&#123;Full_scan&#125; || <span class="string">""</span>) <span class="keyword">eq</span> <span class="string">"yes"</span>) ||((<span class="variable">$event</span>-&gt;&#123;Full_join&#125; || <span class="string">""</span>) <span class="keyword">eq</span> <span class="string">"yes"</span>)'` `slow.<span class="keyword">log</span>&gt; slow_report6.<span class="built_in">log</span></div></pre></td></tr></table></figure>
<p>（7）把查询保存到 <strong>query_review</strong> 表：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">pt-query-</span><span class="string">digest </span><span class="built_in">--user=root</span> –<span class="string">password=</span><span class="string">abc123 </span><span class="built_in">--review</span> h=<span class="string">localhost,</span>D=<span class="string">test,</span>t=<span class="string">query_review-</span>-<span class="built_in">create-review-table</span> <span class="string">slow.</span><span class="string">log</span></div></pre></td></tr></table></figure>
<p>（8）通过 <strong>tcpdump</strong> 抓取 <strong>mysql</strong> 的 <strong>tcp</strong> 协议数据，然后再分析：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tcpdump -s <span class="number">65535</span> -x -nn -<span class="selector-tag">q</span> -tttt -<span class="selector-tag">i</span> any -c <span class="number">1000</span> port <span class="number">3306</span> &gt; mysql<span class="selector-class">.tcp</span><span class="selector-class">.txt</span>``pt-query-digest --type tcpdump mysql<span class="selector-class">.tcp</span><span class="selector-class">.txt</span>&gt; slow_report9.log</div></pre></td></tr></table></figure>
<p>（9）分析 <strong>binlog</strong>：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqlbinlog mysql-<span class="keyword">bin.000093 </span>&gt; mysql-<span class="keyword">bin000093.sql``pt-query-digest </span>--type=<span class="keyword">binlog </span>mysql-<span class="keyword">bin000093.sql </span>&gt; slow_report10.log</div></pre></td></tr></table></figure>
<p>（10）分析 <strong>general log</strong>：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-<span class="keyword">query</span>-digest --<span class="keyword">type</span>=genlog localhost.<span class="keyword">log</span> &gt; slow_report11.<span class="built_in">log</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2023/02/09/Elastic-使用极限网关进行数据双向切换/" itemprop="url">
                  Elastic 使用极限网关进行数据双向切换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2023-02-09T14:06:40+08:00" content="2023-02-09">
              2023-02-09
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2023/02/09/Elastic-使用极限网关进行数据双向切换/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2023/02/09/Elastic-使用极限网关进行数据双向切换/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>极限网关</strong> (<em>INFINI Gateway</em>) 是一个面向 Elasticsearch 的高性能应用网关，它包含丰富的特性，使用起来也非常简单。极限网关工作的方式和普通的反向代理一样，我们一般是将网关部署在 Elasticsearch 集群前面， 将以往直接发送给 Elasticsearch 的请求都发送给网关，再由网关转发给请求到后端的 Elasticsearch 集群。因为网关位于在用户端和后端 Elasticsearch 之间，所以网关在中间可以做非常多的事情， 比如可以实现索引级别的限速限流、常见查询的缓存加速、查询请求的审计、查询结果的动态修改等等</p>
<h2 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https:<span class="comment">//release.infinilabs.com/gateway/stable/gateway-1.8.6-769-linux-amd64.tar.gz</span></div><div class="line">tar vxzf gateway-<span class="number">1.8</span>.6-<span class="number">769</span>-linux-amd64.tar.gz</div><div class="line">mv gateway-linux-amd64 bin/gateway</div></pre></td></tr></table></figure>
<h2 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h2><p>极限网关下载解压之后，我们可以执行这个命令来验证安装包是否有效，如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">✗ ./<span class="selector-tag">bin</span>/<span class="selector-tag">gateway</span> <span class="selector-tag">-v</span></div><div class="line"><span class="selector-tag">gateway</span> <span class="selector-tag">1</span><span class="selector-class">.0</span><span class="selector-class">.0_SNAPSHOT</span> <span class="selector-tag">2021-01-03</span> <span class="selector-tag">22</span><span class="selector-pseudo">:45</span><span class="selector-pseudo">:28</span> <span class="selector-tag">6a54bb2</span></div></pre></td></tr></table></figure>
<p>如果能够正常看到上面的版本信息，说明网关程序本身一切正常。</p>
<h2 id="启动网关"><a href="#启动网关" class="headerlink" title="启动网关"></a>启动网关</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master gateway]# cat  /opt/gateway/gateway.yml</div><div class="line"># 数据路径</div><div class="line">path.data: data</div><div class="line"># 日志路径</div><div class="line">path.logs: log</div><div class="line"></div><div class="line"># 定义 Elasticsearch 集群地址</div><div class="line">elasticsearch:</div><div class="line"># cluster01 集群</div><div class="line">- name: cluster01</div><div class="line">  enabled: true</div><div class="line">  endpoint: http://192.168.10.15:9200</div><div class="line">  basic_auth:</div><div class="line">    username: elastic</div><div class="line">    password: IQsMLRniP5BcYfoNzTBT</div><div class="line">  discovery:</div><div class="line">    enabled: true</div><div class="line">    refresh:</div><div class="line">      enabled: true</div><div class="line">      interval: 1s</div><div class="line"># cluster02 集群</div><div class="line">- name: cluster02</div><div class="line">  enabled: true</div><div class="line">  endpoint: http://192.168.10.15:30993</div><div class="line">  basic_auth:</div><div class="line">    username: elastic</div><div class="line">    password: IQsMLRniP5BcYfoNzTBT</div><div class="line">  discovery:</div><div class="line">    enabled: true</div><div class="line">    refresh:</div><div class="line">      enabled: true</div><div class="line">      interval: 1s</div><div class="line"></div><div class="line"># 定义网关入口</div><div class="line">entry:</div><div class="line">  - name: my_es_entry</div><div class="line">    enabled: true</div><div class="line">    router: my_router</div><div class="line">    network:</div><div class="line">      binding: 0.0.0.0:8000</div><div class="line"></div><div class="line"># 定义工作流</div><div class="line">flow:</div><div class="line">  - name: auth-flow</div><div class="line">    filter:</div><div class="line">      #- basic_auth:</div><div class="line">      #    valid_users:</div><div class="line">      #      elastic: ******</div><div class="line">      - set_basic_auth:</div><div class="line">          username: elastic</div><div class="line">          password: IQsMLRniP5BcYfoNzTBT</div><div class="line">  - name: set-auth-for-backup-flow</div><div class="line">    filter:</div><div class="line">      - set_basic_auth: #覆盖备集群的身份信息用于备集群正常处理请求</div><div class="line">          username: elastic</div><div class="line">          password: IQsMLRniP5BcYfoNzTBT </div><div class="line"> # 写请求优先发给主集群, 当主集群不可用时发给备集群</div><div class="line"> # 当主集群数据写入成功时，记录到队列中，异步消费写入备集群</div><div class="line">  - name: write-flow</div><div class="line">    filter:</div><div class="line">      - flow:</div><div class="line">          flows:</div><div class="line">            - auth-flow</div><div class="line">      - if:</div><div class="line">      # 当主集群可用时</div><div class="line">          cluster_available: [&quot;cluster01&quot;]</div><div class="line">        then:</div><div class="line">          # 先将数据写入主集群</div><div class="line">          - elasticsearch:</div><div class="line">              elasticsearch: &quot;cluster01&quot;</div><div class="line">            # 写入消息队列,等待 pipeline 异步消费到备集群</div><div class="line">          - queue:</div><div class="line">              queue_name: &quot;cluster02-queue&quot;</div><div class="line">        else:</div><div class="line">          - elasticsearch:</div><div class="line">              elasticsearch: &quot;cluster02&quot;</div><div class="line">          - queue:</div><div class="line">              queue_name: &quot;cluster01-queue&quot;</div><div class="line">  # 读请求优先发给主集群, 当主集群不可用时发给备集群</div><div class="line">  - name: read-flow</div><div class="line">    filter:</div><div class="line">      - flow:</div><div class="line">          flows:</div><div class="line">            - set-auth-for-backup-flow</div><div class="line">      - if:</div><div class="line">          cluster_available: [&quot;cluster01&quot;]</div><div class="line">        then:</div><div class="line">          - elasticsearch:</div><div class="line">              elasticsearch: &quot;cluster01&quot;</div><div class="line">        else:</div><div class="line">          - elasticsearch:</div><div class="line">              elasticsearch: &quot;cluster02&quot;</div><div class="line"></div><div class="line"># 路由规则</div><div class="line">router:</div><div class="line">  - name: my_router</div><div class="line">    # 默认路由</div><div class="line">    default_flow: write-flow</div><div class="line">    # 读请求路由</div><div class="line">    rules:</div><div class="line">      - method:</div><div class="line">          - &quot;GET&quot;</div><div class="line">          - &quot;HEAD&quot;</div><div class="line">        pattern:</div><div class="line">          - &quot;/&#123;any:*&#125;&quot;</div><div class="line">        flow:</div><div class="line">          - read-flow</div><div class="line">      - method:</div><div class="line">          - &quot;POST&quot;</div><div class="line">          - &quot;GET&quot;</div><div class="line">        pattern:</div><div class="line">          - &quot;/_refresh&quot;</div><div class="line">          - &quot;/_count&quot;</div><div class="line">          - &quot;/_search&quot;</div><div class="line">          - &quot;/_msearch&quot;</div><div class="line">          - &quot;/_mget&quot;</div><div class="line">          - &quot;/&#123;any_index&#125;/_count&quot;</div><div class="line">          - &quot;/&#123;any_index&#125;/_search&quot;</div><div class="line">          - &quot;/&#123;any_index&#125;/_msearch&quot;</div><div class="line">          - &quot;/&#123;any_index&#125;/_mget&quot;</div><div class="line">        flow:</div><div class="line">          - read-flow</div><div class="line"></div><div class="line"># 定义管道, 异步将数据写入备集群</div><div class="line">pipeline:</div><div class="line">  - name: cluster01-consumer</div><div class="line">    auto_start: true</div><div class="line">    keep_running: true</div><div class="line">    processor:</div><div class="line">      - queue_consumer:</div><div class="line">          input_queue: &quot;cluster01-queue&quot; </div><div class="line">          elasticsearch: &quot;cluster01&quot;</div><div class="line">          when:</div><div class="line">            cluster_available: [&quot;cluster01&quot;] # 当集群可用时，才消费队列中的数据</div><div class="line">  - name: cluster02-consumer</div><div class="line">    auto_start: true</div><div class="line">    keep_running: true</div><div class="line">    processor:</div><div class="line">      - queue_consumer:</div><div class="line">          input_queue: &quot;cluster02-queue&quot;</div><div class="line">          elasticsearch: &quot;cluster02&quot;</div><div class="line">          when:</div><div class="line">            cluster_available: [&quot;cluster02&quot;]</div><div class="line"></div><div class="line">elastic:</div><div class="line">  enabled: true</div><div class="line">  remote_configs: false</div><div class="line">  health_check:</div><div class="line">    enabled: true</div><div class="line">    interval: 1s</div><div class="line">  availability_check:</div><div class="line">    enabled: true</div><div class="line">    interval: 1s</div><div class="line">  metadata_refresh:</div><div class="line">    enabled: true</div><div class="line">    interval: 1s</div><div class="line">  cluster_settings_check:</div><div class="line">    enabled: false</div><div class="line">    interval: 1s</div></pre></td></tr></table></figure>
<h2 id="启动网关-1"><a href="#启动网关-1" class="headerlink" title="启动网关"></a>启动网关</h2><p><code>[root@k8s-master gateway]#  ./bin/gateway</code></p>
<h2 id="测试准备"><a href="#测试准备" class="headerlink" title="测试准备"></a>测试准备</h2><h3 id="建立本地docker-es-集群，配置如下"><a href="#建立本地docker-es-集群，配置如下" class="headerlink" title="建立本地docker es 集群，配置如下"></a>建立本地docker es 集群，配置如下</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master gateway]<span class="comment"># cat docker-compose.yml </span></div><div class="line"><span class="attr">version:</span> <span class="string">'3.8'</span></div><div class="line"><span class="attr">services:</span></div><div class="line">  <span class="comment"># 集群 cluster01</span></div><div class="line">  <span class="comment"># Elasticsearch</span></div><div class="line"><span class="attr">  es01:</span></div><div class="line"><span class="attr">    image:</span> docker.io/library/elasticsearch:<span class="number">7.9</span><span class="number">.3</span></div><div class="line"><span class="attr">    container_name:</span> es01</div><div class="line"><span class="attr">    environment:</span></div><div class="line">      <span class="comment"># 节点名</span></div><div class="line"><span class="bullet">      -</span> node.name=es01</div><div class="line">      <span class="comment"># 集群名</span></div><div class="line"><span class="bullet">      -</span> cluster.name=cluster01</div><div class="line">      <span class="comment"># 指定单节点启动</span></div><div class="line"><span class="bullet">      -</span> discovery.type=single-node</div><div class="line">      <span class="comment"># 开启内存锁定</span></div><div class="line"><span class="bullet">      -</span> bootstrap.memory_lock=<span class="literal">true</span></div><div class="line">      <span class="comment"># 设置内存大小</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"ES_JAVA_OPTS=-Xms2g -Xmx2g"</span></div><div class="line">      <span class="comment"># 启用安全</span></div><div class="line"><span class="bullet">      -</span> xpack.security.enabled=<span class="literal">true</span></div><div class="line">      <span class="comment"># 设置 elastic 用户密码</span></div><div class="line"><span class="bullet">      -</span> ELASTIC_PASSWORD=IQsMLRniP5BcYfoNzTBT</div><div class="line"><span class="attr">    ulimits:</span></div><div class="line"><span class="attr">      memlock:</span></div><div class="line"><span class="attr">        soft:</span> <span class="bullet">-1</span></div><div class="line"><span class="attr">        hard:</span> <span class="bullet">-1</span></div><div class="line">    <span class="comment"># 映射到主机名的端口 宿主机端口:容器端口</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">9200</span>:<span class="number">9200</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="attr">      - data01:</span>/usr/share/elasticsearch/data</div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> elastic</div><div class="line">  <span class="comment"># Kibana</span></div><div class="line"><span class="attr">  kib01:</span></div><div class="line"><span class="attr">    image:</span> kibana:<span class="number">7.9</span><span class="number">.3</span></div><div class="line"><span class="attr">    container_name:</span> kib01</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">5601</span>:<span class="number">5601</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line">      <span class="comment"># Elasticsearch 连接信息</span></div><div class="line"><span class="attr">      ELASTICSEARCH_URL:</span> http://es01:<span class="number">9200</span></div><div class="line"><span class="attr">      ELASTICSEARCH_HOSTS:</span> <span class="string">'["http://es01:9200"]'</span></div><div class="line"><span class="attr">      ELASTICSEARCH_USERNAME:</span> elastic</div><div class="line"><span class="attr">      ELASTICSEARCH_PASSWORD:</span> IQsMLRniP5BcYfoNzTBT</div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> elastic</div><div class="line"></div><div class="line"><span class="comment"># 存储卷</span></div><div class="line"><span class="attr">volumes:</span></div><div class="line"><span class="attr">  data01:</span></div><div class="line"><span class="attr">    driver:</span> local</div><div class="line"><span class="attr">  data02:</span></div><div class="line"><span class="attr">    driver:</span> local</div><div class="line"><span class="attr">  data03:</span></div><div class="line"><span class="attr">    driver:</span> local</div><div class="line"></div><div class="line"><span class="comment"># 网络</span></div><div class="line"><span class="attr">networks:</span></div><div class="line"><span class="attr">  elastic:</span></div><div class="line"><span class="attr">    driver:</span> bridge</div></pre></td></tr></table></figure>
<h3 id="k8s-集群-已提前搭建"><a href="#k8s-集群-已提前搭建" class="headerlink" title="k8s 集群(已提前搭建)"></a>k8s 集群(已提前搭建)</h3><p>kubectl exec -it $(kubectl get pods -n esbeta| grep elasticsearch-client | sed -n 1p | awk ‘{print $1}’) -n esbeta – bin/elasticsearch-setup-passwords interactive </p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://ruby-china-files.b0.upaiyun.com/user/big_avatar/5575.jpg"
               alt="peterfei" />
          <p class="site-author-name" itemprop="name">peterfei</p>
          <p class="site-description motion-element" itemprop="description">peterfei|技术|上主是我的牧者</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">77</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/peterfei" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">peterfei</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"peterfei"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  


</body>
</html>
