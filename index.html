<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="peterfei.me,peterfei" />





  <link rel="alternate" href="/atom.xml" title="Peterfei" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.0" />






<meta name="description" content="peterfei|技术|上主是我的牧者">
<meta property="og:type" content="website">
<meta property="og:title" content="Peterfei">
<meta property="og:url" content="http://peterfei.me/index.html">
<meta property="og:site_name" content="Peterfei">
<meta property="og:description" content="peterfei|技术|上主是我的牧者">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Peterfei">
<meta name="twitter:description" content="peterfei|技术|上主是我的牧者">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: '[object Object]',
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Peterfei </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Peterfei</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">上主是我的牧者，我实在一无所缺</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'PqEYgqEwUwFoXjgtngj9','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2023/04/18/Kafka入门及进阶/" itemprop="url">
                  Kafka入门及进阶段
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2023-04-18T09:19:14+08:00" content="2023-04-18">
              2023-04-18
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2023/04/18/Kafka入门及进阶/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2023/04/18/Kafka入门及进阶/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-1-Kafka入门"><a href="#1-1-Kafka入门" class="headerlink" title="1.1 Kafka入门"></a>1.1 Kafka入门</h2><h2 id="一、Kafka-是什么？"><a href="#一、Kafka-是什么？" class="headerlink" title="一、Kafka 是什么？"></a>一、Kafka 是什么？</h2><p>有人说世界上有三个伟大的发明：火，轮子，以及 Kafka。</p>
<p>发展到现在，Apache Kafka 无疑是很成功的，Confluent 公司曾表示世界五百强中有三分之一的企业在使用 Kafka。在流式计算中，Kafka 一般用来缓存数据，例如 Flink 通过消费 Kafka 的数据进行计算。</p>
<p><img src="https://ucc.alicdn.com/images/user-upload-01/20200915160628313.png#pic_center" alt="image"></p>
<p>关于Kafka，我们最开始需要了解的是以下四点：</p>
<p>1.Apache Kafka 是一个开源 消息 系统，由 Scala 写成。是由 Apache 软件基金会开发的 一个开源消息系统项目。</p>
<p>2.Kafka 最初是由 LinkedIn 公司开发，用作 LinkedIn 的活动流（Activity Stream）和运营数据处理管道（Pipeline）的基础，现在它已被多家不同类型的公司作为多种类型的数据管道和消息系统使用。</p>
<p>3.Kafka 是一个分布式消息队列。Kafka 对消息保存时根据 Topic 进行归类，发送消息 者称为 Producer，消息接受者称为 Consumer，此外 kafka 集群有多个 kafka 实例组成，每个 实例(server)称为 broker。</p>
<p>4.无论是 kafka 集群，还是 consumer 都依赖于 Zookeeper 集群保存一些 meta 信息， 来保证系统可用性。</p>
<h2 id="二、为什么要有-Kafka"><a href="#二、为什么要有-Kafka" class="headerlink" title="二、为什么要有 Kafka?"></a>二、为什么要有 Kafka?</h2><p>kafka 之所以受到越来越多的青睐，与它所扮演的三大角色是分不开的的：</p>
<p>消息系统：kafka与传统的消息中间件都具备系统解耦、冗余存储、流量削峰、缓冲、异步通信、扩展性、可恢复性等功能。与此同时，kafka还提供了大多数消息系统难以实现的消息顺序性保障及回溯性消费的功能。</p>
<p>存储系统：kafka把消息持久化到磁盘，相比于其他基于内存存储的系统而言，有效的降低了消息丢失的风险。这得益于其消息持久化和多副本机制。也可以将kafka作为长期的存储系统来使用，只需要把对应的数据保留策略设置为“永久”或启用主题日志压缩功能。</p>
<p>流式处理平台：kafka为流行的流式处理框架提供了可靠的数据来源，还提供了一个完整的流式处理框架，比如窗口、连接、变换和聚合等各类操作。</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/2c447e5d62fc4332a6da3eca019f25c2.png" alt="image.png"></p>
<h2 id="三、Kafka-基本概念"><a href="#三、Kafka-基本概念" class="headerlink" title="三、Kafka 基本概念"></a>三、Kafka 基本概念</h2><p>在深入理解 Kafka 之前，可以先了解下 Kafka 的基本概念。</p>
<p>一个典型的 Kafka 包含若干Producer、若干 Broker、若干 Consumer 以及一个 Zookeeper 集群。Zookeeper 是 Kafka 用来负责集群元数据管理、控制器选举等操作的。Producer 是负责将消息发送到 Broker 的，Broker 负责将消息持久化到磁盘，而 Consumer 是负责从Broker 订阅并消费消息。Kafka体系结构如下所示：</p>
<p><img src="https://ucc.alicdn.com/images/user-upload-01/20200915162242149.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JlaWlzQmVp,size_1,color_FFFFFF,t_70#pic_center" alt="image"></p>
<h3 id="概念一：生产者（Producer）与消费者（Consumer）"><a href="#概念一：生产者（Producer）与消费者（Consumer）" class="headerlink" title="概念一：生产者（Producer）与消费者（Consumer）"></a>概念一：生产者（Producer）与消费者（Consumer）</h3><p><img src="https://ucc.alicdn.com/images/user-upload-01/20200210223638108.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JlaWlzQmVp,size_1,color_FFFFFF,t_70#pic_center" alt="image"></p>
<p>对于 Kafka 来说客户端有两种基本类型：生产者（Producer）和 消费者（Consumer）。除此之外，还有用来做数据集成的 Kafka Connect API 和流式处理的 Kafka Streams 等高阶客户端，但这些高阶客户端底层仍然是生产者和消费者API，只不过是在上层做了封装。</p>
<p>Producer ：消息生产者，就是向 Kafka broker 发消息的客户端；</p>
<p>Consumer ：消息消费者，向 Kafka broker 取消息的客户端；</p>
<h3 id="概念二：Broker-和集群（Cluster）"><a href="#概念二：Broker-和集群（Cluster）" class="headerlink" title="概念二：Broker 和集群（Cluster）"></a>概念二：Broker 和集群（Cluster）</h3><p>一个 Kafka 服务器也称为 Broker，它接受生产者发送的消息并存入磁盘；Broker 同时服务消费者拉取分区消息的请求，返回目前已经提交的消息。使用特定的机器硬件，一个 Broker 每秒可以处理成千上万的分区和百万量级的消息。</p>
<p>若干个 Broker 组成一个 集群（Cluster），其中集群内某个 Broker 会成为集群控制器（Cluster Controller），它负责管理集群，包括分配分区到 Broker、监控 Broker 故障等。在集群内，一个分区由一个 Broker 负责，这个 Broker 也称为这个分区的 Leader；当然一个分区可以被复制到多个 Broker 上来实现冗余，这样当存在 Broker 故障时可以将其分区重新分配到其他 Broker 来负责。下图是一个样例：</p>
<p><img src="https://ucc.alicdn.com/images/user-upload-01/20200210224455549.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JlaWlzQmVp,size_1,color_FFFFFF,t_70#pic_center" alt="image"></p>
<h3 id="概念三：主题（Topic）与分区（Partition）"><a href="#概念三：主题（Topic）与分区（Partition）" class="headerlink" title="概念三：主题（Topic）与分区（Partition）"></a>概念三：主题（Topic）与分区（Partition）</h3><p><img src="https://ucc.alicdn.com/images/user-upload-01/20200210223912550.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JlaWlzQmVp,size_1,color_FFFFFF,t_70#pic_center" alt="image"></p>
<p>在 Kafka 中，消息以 主题（Topic）来分类，每一个主题都对应一个「消息队列」，这有点儿类似于数据库中的表。但是如果我们把所有同类的消息都塞入到一个“中心”队列中，势必缺少可伸缩性，无论是生产者/消费者数目的增加，还是消息数量的增加，都可能耗尽系统的性能或存储。</p>
<p><strong>Kafka是天然分布式的</strong>。</p>
<p><strong>备份分区仅仅用作于备份，不做读写。</strong>如果某个Broker挂了，那就会选举出其他Broker的partition来作为主分区，这就实现了<strong>高可用</strong>。</p>
<p>另外值得一提的是：当生产者把数据丢进topic时，我们知道是写在partition上的，那partition是怎么将其持久化的呢？（不持久化如果Broker中途挂了，那肯定会丢数据嘛)。</p>
<p>Kafka是将partition的数据写在<strong>磁盘</strong>的(消息日志)，不过Kafka只允许<strong>追加写入</strong>(顺序访问)，避免缓慢的随机 I/O 操作。</p>
<ul>
<li>Kafka也不是partition一有数据就立马将数据写到磁盘上，它会先<strong>缓存</strong>一部分，等到足够多数据量或等待一定的时间再批量写入(flush)。</li>
</ul>
<p>消费者在读的时候也很有讲究：正常的读磁盘数据是需要将内核态数据拷贝到用户态的，而Kafka 通过调用<code>sendfile()</code>直接从内核空间（DMA的）到内核空间（Socket的），<strong>少做了一步拷贝</strong>的操作。</p>
<p><img src="https://pic4.zhimg.com/80/v2-ecf911716b70f836b2a607157bbf11eb_1440w.webp" alt="img"></p>
<blockquote>
<p>附docker-compose.yml 脚本</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"><span class="attr">version:</span> <span class="string">"3"</span></div><div class="line"><span class="attr">services:</span></div><div class="line"><span class="attr">  zookeeper:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">'confluentinc/cp-zookeeper:6.2.0'</span></div><div class="line"><span class="attr">    hostname:</span> zookeeper</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">'2181:2181'</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line">      <span class="comment"># 匿名登录--必须开启</span></div><div class="line"><span class="bullet">      -</span> ALLOW_ANONYMOUS_LOGIN=<span class="literal">yes</span></div><div class="line"><span class="bullet">      -</span> ZOOKEEPER_CLIENT_PORT=<span class="number">2181</span></div><div class="line"><span class="bullet">      -</span> ZOOKEEPER_TICK_TIME=<span class="number">2000</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> ./zookeeper/data:/var/lib/zookeeper/data:Z</div><div class="line"><span class="bullet">      -</span> ./zookeeper/log:/var/lib/zookeeper/log:Z</div><div class="line">  <span class="comment"># 该镜像具体配置参考 https://github.com/bitnami/bitnami-docker-kafka/blob/master/README.md</span></div><div class="line"><span class="attr">  broker:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">'confluentinc/cp-kafka:6.2.0'</span></div><div class="line"><span class="attr">    hostname:</span> broker</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">'9092:9092'</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"29092:29092"</span></div><div class="line">      <span class="comment">#- '9999:9999'</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> KAFKA_BROKER_ID=<span class="number">1</span></div><div class="line"><span class="bullet">      -</span> KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</div><div class="line"><span class="bullet">      -</span> KAFKA_CFG_LISTENERS=PLAINTEXT://:<span class="number">9092</span></div><div class="line"><span class="bullet">      -</span> KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://<span class="number">192.168</span><span class="number">.3</span><span class="number">.92</span>:<span class="number">9092</span>,PLAINTEXT_HOST://localhost:<span class="number">29092</span></div><div class="line">      <span class="comment">#- KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT</span></div><div class="line">      <span class="comment"># 客户端访问地址，更换成自己的</span></div><div class="line">      <span class="comment">#- KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://192.168.3.92:9092</span></div><div class="line"><span class="bullet">      -</span> KAFKA_ZOOKEEPER_CONNECT=zookeeper:<span class="number">2181</span></div><div class="line"><span class="bullet">      -</span> KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=<span class="number">0</span></div><div class="line">      <span class="comment"># 允许使用PLAINTEXT协议(镜像中默认为关闭,需要手动开启)</span></div><div class="line"><span class="bullet">      -</span> ALLOW_PLAINTEXT_LISTENER=<span class="literal">yes</span></div><div class="line">      <span class="comment"># 关闭自动创建 topic 功能</span></div><div class="line">      <span class="comment">#- KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=false</span></div><div class="line">      <span class="comment"># 全局消息过期时间 6 小时(测试时可以设置短一点)</span></div><div class="line"><span class="bullet">      -</span> KAFKA_CFG_LOG_RETENTION_HOURS=<span class="number">6</span></div><div class="line"><span class="bullet">      -</span> KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=<span class="number">1</span></div><div class="line"><span class="bullet">      -</span> KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=<span class="number">1</span></div><div class="line"><span class="bullet">      -</span> KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=<span class="number">1</span></div><div class="line"><span class="bullet">      -</span> KAFKA_HEAP_OPTS=-Xmx256M -Xms128M</div><div class="line">      <span class="comment"># 开启JMX监控</span></div><div class="line">      <span class="comment">#- JMX_PORT=9999</span></div><div class="line">      <span class="comment">#- KAFKA_JMX_OPTS= -Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=192.168.3.92 -Dcom.sun.management.jmxremote.rmi.port=9999  -Dcom.sun.management.jmxremote.port=9999</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> ./kafka/data:/var/lib/kafka/data:Z</div><div class="line"><span class="bullet">      -</span> ./kafka/config:/var/lib/kafka/config:Z</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> zookeeper</div><div class="line"><span class="attr">  schema-registry:</span></div><div class="line"><span class="attr">    image:</span> confluentinc/cp-schema-registry:<span class="number">6.2</span><span class="number">.0</span></div><div class="line"><span class="attr">    hostname:</span> schema-registry</div><div class="line"><span class="attr">    container_name:</span> schema-registry</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> zookeeper</div><div class="line"><span class="bullet">      -</span> broker</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"8081:8081"</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="attr">      SCHEMA_REGISTRY_HOST_NAME:</span> schema-registry</div><div class="line"><span class="attr">      SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL:</span> zookeeper:<span class="number">2181</span></div><div class="line">      </div><div class="line"><span class="attr">  connect:</span></div><div class="line"><span class="attr">    image:</span> confluentinc/cp-kafka-connect:latest</div><div class="line"><span class="attr">    hostname:</span> connect</div><div class="line"><span class="attr">    container_name:</span> connect</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> zookeeper</div><div class="line"><span class="bullet">      -</span> broker</div><div class="line"><span class="bullet">      -</span> schema-registry</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"8083:8083"</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="attr">      CONNECT_BOOTSTRAP_SERVERS:</span> broker:<span class="number">29092</span></div><div class="line"><span class="attr">      CONNECT_REST_ADVERTISED_HOST_NAME:</span> localhost</div><div class="line"><span class="attr">      CONNECT_REST_PORT:</span> <span class="number">8083</span></div><div class="line"><span class="attr">      CONNECT_GROUP_ID:</span> ksql-connect-cluster</div><div class="line"><span class="attr">      CONNECT_OFFSET_STORAGE_TOPIC:</span> ksql-connect-configs</div><div class="line"><span class="attr">      CONNECT_CONFIG_STORAGE_TOPIC:</span> ksql-connect-topics</div><div class="line"><span class="attr">      CONNECT_STATUS_STORAGE_TOPIC:</span> ksql-connect-statuses</div><div class="line"><span class="attr">      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR:</span> <span class="number">1</span></div><div class="line"><span class="attr">      CONNECT_OFFSET_FLUSH_INTERVAL_MS:</span> <span class="number">10000</span></div><div class="line"><span class="attr">      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR:</span> <span class="number">1</span></div><div class="line"><span class="attr">      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR:</span> <span class="number">1</span></div><div class="line"><span class="attr">      CONNECT_KEY_CONVERTER:</span> org.apache.kafka.connect.storage.StringConverter</div><div class="line"><span class="attr">      CONNECT_VALUE_CONVERTER:</span> io.confluent.connect.avro.AvroConverter</div><div class="line"><span class="attr">      CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL:</span> http://schema-registry:<span class="number">8081</span></div><div class="line"><span class="attr">      CONNECT_INTERNAL_KEY_CONVERTER:</span> <span class="string">"org.apache.kafka.connect.json.JsonConverter"</span></div><div class="line"><span class="attr">      CONNECT_INTERNAL_VALUE_CONVERTER:</span> <span class="string">"org.apache.kafka.connect.json.JsonConverter"</span></div><div class="line"><span class="attr">      CONNECT_ZOOKEEPER_CONNECT:</span> <span class="string">'zookeeper:2181'</span></div><div class="line"><span class="attr">  ksqldb-server:</span></div><div class="line"><span class="attr">    image:</span> confluentinc/ksqldb-server:latest</div><div class="line"><span class="attr">    hostname:</span> ksqldb-server</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> broker</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"8088:8088"</span></div><div class="line">    <span class="comment">#healthcheck:</span></div><div class="line">    <span class="comment">#  test: curl -f http://ksqldb-server:8088/ || exit 1</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="attr">      KSQL_LISTENERS:</span> http://<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8088</span></div><div class="line"><span class="attr">      KSQL_BOOTSTRAP_SERVERS:</span> <span class="number">192.168</span><span class="number">.3</span><span class="number">.92</span>:<span class="number">9092</span></div><div class="line"><span class="attr">      KSQL_KSQL_LOGGING_PROCESSING_STREAM_AUTO_CREATE:</span> <span class="string">"true"</span></div><div class="line"><span class="attr">      KSQL_KSQL_LOGGING_PROCESSING_TOPIC_AUTO_CREATE:</span> <span class="string">"true"</span></div><div class="line"><span class="attr">      KSQL_KSQL_CONNECT_URL:</span> http://connect:<span class="number">8083</span></div><div class="line"></div><div class="line"><span class="attr">  ksqldb-cli:</span></div><div class="line"><span class="attr">    image:</span> confluentinc/ksqldb-cli:latest</div><div class="line"><span class="attr">    container_name:</span> ksqldb-cli</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> ksqldb-server</div><div class="line"><span class="bullet">      -</span> broker</div><div class="line"><span class="attr">    entrypoint:</span> /bin/sh</div><div class="line"><span class="attr">    tty:</span> <span class="literal">true</span></div></pre></td></tr></table></figure>
<blockquote>
<p>Kafka topic CLI:</p>
</blockquote>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">kafka</span><span class="literal">-</span><span class="comment">topics</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">bootstrap</span><span class="literal">-</span><span class="comment">server</span> <span class="comment">localhost:9092</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">list</span></div></pre></td></tr></table></figure>
<p><img src="/Users/mac/Library/Application Support/typora-user-images/image-20230418103634592.png" alt="image-20230418103634592"></p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">kafka</span><span class="literal">-</span><span class="comment">console</span><span class="literal">-</span><span class="comment">producer</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">broker</span><span class="literal">-</span><span class="comment">list</span> <span class="comment">localhost:9092</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">topic</span> <span class="comment">test</span></div></pre></td></tr></table></figure>
<p><img src="/Users/mac/Library/Application Support/typora-user-images/image-20230418103936415.png" alt="image-20230418103936415"></p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">kafka</span><span class="literal">-</span><span class="comment">console</span><span class="literal">-</span><span class="comment">consumer</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">bootstrap</span><span class="literal">-</span><span class="comment">server</span> <span class="comment">localhost:9092</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">topic</span> <span class="comment">test</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">from</span><span class="literal">-</span><span class="comment">beginning</span></div></pre></td></tr></table></figure>
<p><img src="/Users/mac/Library/Application Support/typora-user-images/image-20230418104000562.png" alt="image-20230418104000562"></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">exec</span> -it ksqldb-cli ksql http:<span class="comment">//ksqldb-server:8088</span></div></pre></td></tr></table></figure>
<p><img src="/Users/mac/Library/Application Support/typora-user-images/image-20230418110419615.png" alt="image-20230418110419615"></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">show </span>topics<span class="comment">;</span></div></pre></td></tr></table></figure>
<p><img src="/Users/mac/Library/Application Support/typora-user-images/image-20230418110443996.png" alt="image-20230418110443996"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> STREAM riderLocations (profileId <span class="built_in">VARCHAR</span>, latitude <span class="keyword">DOUBLE</span>, longitude <span class="keyword">DOUBLE</span>)</div><div class="line">  <span class="keyword">WITH</span> (kafka_topic=<span class="string">'locations'</span>, value_format=<span class="string">'json'</span>, <span class="keyword">partitions</span>=<span class="number">1</span>);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'c2309eec'</span>, <span class="number">37.7877</span>, <span class="number">-122.4205</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'18f4ea86'</span>, <span class="number">37.3903</span>, <span class="number">-122.0643</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'4ab5cbad'</span>, <span class="number">37.3952</span>, <span class="number">-122.0813</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'8b6eae59'</span>, <span class="number">37.3944</span>, <span class="number">-122.0813</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'4a7c7b41'</span>, <span class="number">37.4049</span>, <span class="number">-122.0822</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> riderLocations (profileId, latitude, longitude) <span class="keyword">VALUES</span> (<span class="string">'4ddad000'</span>, <span class="number">37.7857</span>, <span class="number">-122.4011</span>);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>select * from riderLocations;</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ksql&gt; select * from riderLocations;</div></pre></td></tr></table></figure>
<p><img src="/Users/mac/Library/Application Support/typora-user-images/image-20230418111709787.png" alt="image-20230418111709787"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> myNearDemo <span class="keyword">AS</span> \</div><div class="line">&gt;<span class="keyword">select</span> profileId,la,lo <span class="keyword">from</span> currentLocation ;</div></pre></td></tr></table></figure>
<p><img src="/Users/mac/Library/Application Support/typora-user-images/image-20230418151308205.png" alt="image-20230418151308205"></p>
<blockquote>
<p>监测变化</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> myNearDemo EMIT CHANGES;</div></pre></td></tr></table></figure>
<p><img src="/Users/mac/Library/Application Support/typora-user-images/image-20230418151345474.png" alt="image-20230418151345474"></p>
<blockquote>
<p>原始流 stream 里插入元数据</p>
</blockquote>
<p><img src="/Users/mac/Library/Application Support/typora-user-images/image-20230418151452071.png" alt="image-20230418151452071"></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="selector-tag">ksql</span>&gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">riderLocations</span> (profileId, latitude, longitude) <span class="selector-tag">VALUES</span> (<span class="string">'4ddad000'</span>, <span class="number">38.7857</span>, -<span class="number">122.4012</span>);</div></pre></td></tr></table></figure>
<p><img src="/Users/mac/Library/Application Support/typora-user-images/image-20230418151605116.png" alt="image-20230418151605116"></p>
<blockquote>
</blockquote>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2023/02/22/Mysql使用pt-query-digest分析日志/" itemprop="url">
                  Mysql使用pt-query-digest分析日志
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2023-02-22T15:16:20+08:00" content="2023-02-22">
              2023-02-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2023/02/22/Mysql使用pt-query-digest分析日志/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2023/02/22/Mysql使用pt-query-digest分析日志/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-开启慢查询日志"><a href="#1-开启慢查询日志" class="headerlink" title="1. 开启慢查询日志"></a>1. 开启慢查询日志</h3><p>（1）首先我们要创建一个文件夹用于保存慢查询日志文件，并且设置 <strong>mysql</strong> 有权读写该目录：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir` `/``var``/log/mysql``sudo ``chown` `mysql:mysql -R /``var``/log/mysql</div></pre></td></tr></table></figure>
<p>（2）我们可以登入 <strong>mysql</strong> 命令行后执行如下命令，使用 <strong>set</strong> 设置变量来临时开启。注意这种方式重启服务即失效。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">set</span> <span class="string">``</span><span class="keyword">global</span><span class="string">` `</span>slow_query_log=<span class="keyword">on</span>; ``//开启慢查询功能``<span class="keyword">set</span> <span class="string">``</span><span class="keyword">global</span><span class="string">` `</span>slow_query_log_file=<span class="string">``</span><span class="string">'/var/log/mysql/mysql-slow.log'</span><span class="string">``</span>; ``//指定慢查询日志文件位置``<span class="keyword">set</span> <span class="string">``</span><span class="keyword">global</span><span class="string">` `</span>log_queries_not_using_indexes=<span class="keyword">on</span>;  ``//记录没有使用索引的查询（非必须）``<span class="keyword">set</span> <span class="string">``</span><span class="keyword">global</span><span class="string">` `</span>long_query_time=<span class="number">1</span>;  ``//只记录处理时间1s以上的慢查询</div></pre></td></tr></table></figure>
<p>（3）或者我们也可以通过修改配置文件来永久开启慢查询日志功能，首先编辑配置文件：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vi</span> /etc/my.<span class="keyword">cnf</span></div></pre></td></tr></table></figure>
<ul>
<li>然后在里面添加如下高亮配置：</li>
</ul>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[mysqld]``slow_query_log=on #开启慢查询功能``slow_query_log_file=``<span class="string">'/var/log/mysql/mysql-slow.log'</span>` `#指定慢查询日志文件位置``log_queries_not_using_indexes=on  #记录没有使用索引的查询（非必须）``long_query_time=<span class="number">1</span>  #只记录处理时间<span class="number">1</span>s以上的慢查询</div></pre></td></tr></table></figure>
<ul>
<li>保存关闭文件后，执行如下命令重启 <strong>mysql</strong> 即可：</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">service mysqld restart</span></div></pre></td></tr></table></figure>
<h3 id="2-查看慢查询功能是否开启"><a href="#2-查看慢查询功能是否开启" class="headerlink" title="2. 查看慢查询功能是否开启"></a>2. 查看慢查询功能是否开启</h3><p>（1）登入 <strong>mysql</strong> 命令行后执行如下命令可以查看慢查询开启状态，以及慢查询日志存放的位置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">``</span><span class="string">'slow_query%'</span><span class="string">``</span>;</div></pre></td></tr></table></figure>
<p>（2）执行如下命令可以查看查询超过多少秒才记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">``</span><span class="string">'long_query_time'</span><span class="string">``</span>;</div></pre></td></tr></table></figure>
<h3 id="3-慢查询测试"><a href="#3-慢查询测试" class="headerlink" title="3. 慢查询测试"></a>3. 慢查询测试</h3><p>（1）首先我们执行一个如下的 <strong>sql</strong>，模拟一个 <strong>2</strong> 秒的慢查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">sleep</span>(<span class="number">2</span>);</div></pre></td></tr></table></figure>
<p>（2）查看日志可以发现这个慢查询已经被记录：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat /``var``/log/mysql/mysql-slow.log</div></pre></td></tr></table></figure>
<h2 id="使用-pt-query-digest-工具分析慢查询日志"><a href="#使用-pt-query-digest-工具分析慢查询日志" class="headerlink" title="使用 pt-query-digest 工具分析慢查询日志"></a>使用 pt-query-digest 工具分析慢查询日志</h2><h3 id="1，工具安装"><a href="#1，工具安装" class="headerlink" title="1，工具安装"></a>1，工具安装</h3><p>（1）首先我们执行如下命令将 <strong>rpm</strong> 包下载到本地：</p>
<p><strong>注意</strong>：如果下载不下来也可访问其官网（<a href="https://www.percona.com/downloads/percona-toolkit/3.2.1/binary/redhat/7/" target="_blank" rel="external">点击打开</a>），手动下载下来再上传到服务器上。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget https:``<span class="regexp">//</span>downloads.percona.com<span class="regexp">/downloads/</span>percona-toolkit<span class="regexp">/3.2.1/</span>binary<span class="regexp">/redhat/</span><span class="number">7</span><span class="regexp">/x86_64/</span>percona-toolkit-<span class="number">3.2</span>.<span class="number">1</span>-<span class="number">1</span>.el7.x86_64.rpm</div></pre></td></tr></table></figure>
<p>（2）接着使用 <strong>yum</strong> 命令进行安装：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">yum</span> <span class="selector-tag">install</span> <span class="selector-tag">-y</span> <span class="selector-tag">percona-toolkit-3</span><span class="selector-class">.2</span><span class="selector-class">.1-1</span><span class="selector-class">.el7</span><span class="selector-class">.x86_64</span><span class="selector-class">.rpm</span></div></pre></td></tr></table></figure>
<h3 id="2-分析慢查询日志"><a href="#2-分析慢查询日志" class="headerlink" title="2. 分析慢查询日志"></a>2. 分析慢查询日志</h3><p>（1）执行如下命令可以分析指定的慢查询日志文件：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-query-digest /``var``/log/mysql/mysql-slow.log</div></pre></td></tr></table></figure>
<p>（2）分析结果分为三部分，第一部分是总体统计结果：</p>
<ul>
<li><strong>Overall</strong>：总共有多少条查询</li>
<li><strong>Time range</strong>：查询执行的时间范围</li>
<li><strong>unique</strong>：唯一查询数量，即对查询条件进行参数化以后，总共有多少个不同的查询</li>
<li><strong>total</strong>：所有查询总计时长</li>
<li><strong>min</strong>：所有查询最小时长</li>
<li><strong>max</strong>：所有查询最大时长</li>
<li><strong>avg</strong>：所有查询平均时长</li>
<li><strong>95%</strong>：把所有时长值从小到大排列，位置位于 <strong>95%</strong> 的那个时长数，这个数一般最具有参考价值</li>
<li><strong>median</strong>：中位数，把所有时长值从小到大排列，位置位于中间那个时长数</li>
</ul>
<p>（3）第二部分是查询分组统计结果：</p>
<ul>
<li><strong>Rank</strong>：所有语句的排名，默认按查询时间降序排列，通过 <strong>–order-by</strong> 指定</li>
<li><strong>Query ID</strong>：语句的 <strong>ID</strong>（去掉多余空格和文本字符，计算 <strong>hash</strong> 值）</li>
<li><strong>Response</strong>：总的响应时间</li>
<li><strong>time</strong>：该查询在本次分析中总的时间占比</li>
<li><strong>Calls</strong>：执行次数，即本次分析总共有多少条这种类型的查询语句</li>
<li><strong>R/Call</strong>：平均每次执行的响应时间</li>
<li><strong>V/M</strong>：响应时间 <strong>Variance-to-mean</strong> 的比率</li>
<li><strong>Item</strong>：查询对象</li>
</ul>
<p>（4）第三部分是每一种查询比较慢的 <strong>sql</strong> 的详细统计结果：</p>
<ul>
<li><strong>pct</strong>：该 <strong>sql</strong> 语句某执行属性占所有慢查询语句某执行属性的百分比</li>
<li><strong>total</strong>：该 <strong>sql</strong> 语句某执行属性的所有属性时间。</li>
<li><strong>Count</strong>：<strong>sql</strong> 语句执行的次数。对应的 <strong>pct</strong> 表示此 <strong>sql</strong> 语句执行次数占所有慢查询语句执行次数的 <strong>%</strong> 比（下图为 <strong>10%</strong>），对应的 <strong>total</strong> 表示总共执行了 <strong>3</strong> 次。</li>
<li><strong>Exec time</strong>：<strong>sql</strong> 执行时间</li>
<li><strong>Lock time</strong>：<strong>sql</strong> 执行期间被锁定的时间</li>
<li><strong>Rows sent</strong>：传输的有效数据，在 <strong>select</strong> 查询语句中才有值</li>
<li><strong>Rows examine</strong>：总共查询的数据，非目标数据。</li>
<li><strong>Query_time distribution</strong>：查询时间分布</li>
<li><strong>SQL</strong> 语句：下图中为 <strong>select sleep(7)\G</strong></li>
</ul>
<h3 id="3-进阶用法"><a href="#3-进阶用法" class="headerlink" title="3. 进阶用法"></a>3. 进阶用法</h3><p>（1）分析 <strong>slow.log</strong> 日志，并将分析报告输入到 <strong>slow_report.log</strong> 中：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-<span class="keyword">query</span>-digest slow.<span class="keyword">log</span> &gt; slow_report.<span class="built_in">log</span></div></pre></td></tr></table></figure>
<p>（2）分析最近 <strong>12</strong> 小时内的查询：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-<span class="keyword">query</span>-digest --since=12h slow.<span class="keyword">log</span> &gt; slow_report2.<span class="built_in">log</span></div></pre></td></tr></table></figure>
<p>（3）分析指定时间范围内的查询：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-query-digest slow.log --since ``<span class="string">'2020-04-17 09:30:00'</span>` `--until ``<span class="string">'2020-04-17 10:00:00'</span>` `&gt; slow_report3.log</div></pre></td></tr></table></figure>
<p>（4）分析指含有 <strong>select</strong> 语句的慢查询：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-query-digest --<span class="keyword">filter</span> <span class="string">``</span><span class="string">'$event-&gt;&#123;fingerprint&#125; =~ m/^select/i'</span><span class="string">` `</span>slow.<span class="keyword">log</span>&gt; slow_report4.<span class="keyword">log</span></div></pre></td></tr></table></figure>
<p>（5）针对某个用户的慢查询：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-query-digest --<span class="keyword">filter</span> <span class="string">``</span><span class="string">'($event-&gt;&#123;user&#125; || "") =~ m/^root/i'</span><span class="string">` `</span>slow.<span class="keyword">log</span>&gt; slow_report5.<span class="keyword">log</span></div></pre></td></tr></table></figure>
<p>（6）查询所有的全表扫描或 <strong>full join</strong> 的慢查询：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-<span class="keyword">query</span>-digest --filter ``'((<span class="variable">$event</span>-&gt;&#123;Full_scan&#125; || <span class="string">""</span>) <span class="keyword">eq</span> <span class="string">"yes"</span>) ||((<span class="variable">$event</span>-&gt;&#123;Full_join&#125; || <span class="string">""</span>) <span class="keyword">eq</span> <span class="string">"yes"</span>)'` `slow.<span class="keyword">log</span>&gt; slow_report6.<span class="built_in">log</span></div></pre></td></tr></table></figure>
<p>（7）把查询保存到 <strong>query_review</strong> 表：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">pt-query-</span><span class="string">digest </span><span class="built_in">--user=root</span> –<span class="string">password=</span><span class="string">abc123 </span><span class="built_in">--review</span> h=<span class="string">localhost,</span>D=<span class="string">test,</span>t=<span class="string">query_review-</span>-<span class="built_in">create-review-table</span> <span class="string">slow.</span><span class="string">log</span></div></pre></td></tr></table></figure>
<p>（8）通过 <strong>tcpdump</strong> 抓取 <strong>mysql</strong> 的 <strong>tcp</strong> 协议数据，然后再分析：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tcpdump -s <span class="number">65535</span> -x -nn -<span class="selector-tag">q</span> -tttt -<span class="selector-tag">i</span> any -c <span class="number">1000</span> port <span class="number">3306</span> &gt; mysql<span class="selector-class">.tcp</span><span class="selector-class">.txt</span>``pt-query-digest --type tcpdump mysql<span class="selector-class">.tcp</span><span class="selector-class">.txt</span>&gt; slow_report9.log</div></pre></td></tr></table></figure>
<p>（9）分析 <strong>binlog</strong>：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqlbinlog mysql-<span class="keyword">bin.000093 </span>&gt; mysql-<span class="keyword">bin000093.sql``pt-query-digest </span>--type=<span class="keyword">binlog </span>mysql-<span class="keyword">bin000093.sql </span>&gt; slow_report10.log</div></pre></td></tr></table></figure>
<p>（10）分析 <strong>general log</strong>：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-<span class="keyword">query</span>-digest --<span class="keyword">type</span>=genlog localhost.<span class="keyword">log</span> &gt; slow_report11.<span class="built_in">log</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2023/02/09/Elastic-使用极限网关进行数据双向切换/" itemprop="url">
                  Elastic 使用极限网关进行数据双向切换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2023-02-09T14:06:40+08:00" content="2023-02-09">
              2023-02-09
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2023/02/09/Elastic-使用极限网关进行数据双向切换/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2023/02/09/Elastic-使用极限网关进行数据双向切换/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>极限网关</strong> (<em>INFINI Gateway</em>) 是一个面向 Elasticsearch 的高性能应用网关，它包含丰富的特性，使用起来也非常简单。极限网关工作的方式和普通的反向代理一样，我们一般是将网关部署在 Elasticsearch 集群前面， 将以往直接发送给 Elasticsearch 的请求都发送给网关，再由网关转发给请求到后端的 Elasticsearch 集群。因为网关位于在用户端和后端 Elasticsearch 之间，所以网关在中间可以做非常多的事情， 比如可以实现索引级别的限速限流、常见查询的缓存加速、查询请求的审计、查询结果的动态修改等等</p>
<h2 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https:<span class="comment">//release.infinilabs.com/gateway/stable/gateway-1.8.6-769-linux-amd64.tar.gz</span></div><div class="line">tar vxzf gateway-<span class="number">1.8</span>.6-<span class="number">769</span>-linux-amd64.tar.gz</div><div class="line">mv gateway-linux-amd64 bin/gateway</div></pre></td></tr></table></figure>
<h2 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h2><p>极限网关下载解压之后，我们可以执行这个命令来验证安装包是否有效，如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">✗ ./<span class="selector-tag">bin</span>/<span class="selector-tag">gateway</span> <span class="selector-tag">-v</span></div><div class="line"><span class="selector-tag">gateway</span> <span class="selector-tag">1</span><span class="selector-class">.0</span><span class="selector-class">.0_SNAPSHOT</span> <span class="selector-tag">2021-01-03</span> <span class="selector-tag">22</span><span class="selector-pseudo">:45</span><span class="selector-pseudo">:28</span> <span class="selector-tag">6a54bb2</span></div></pre></td></tr></table></figure>
<p>如果能够正常看到上面的版本信息，说明网关程序本身一切正常。</p>
<h2 id="启动网关"><a href="#启动网关" class="headerlink" title="启动网关"></a>启动网关</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master gateway]# cat  /opt/gateway/gateway.yml</div><div class="line"># 数据路径</div><div class="line">path.data: data</div><div class="line"># 日志路径</div><div class="line">path.logs: log</div><div class="line"></div><div class="line"># 定义 Elasticsearch 集群地址</div><div class="line">elasticsearch:</div><div class="line"># cluster01 集群</div><div class="line">- name: cluster01</div><div class="line">  enabled: true</div><div class="line">  endpoint: http://192.168.10.15:9200</div><div class="line">  basic_auth:</div><div class="line">    username: elastic</div><div class="line">    password: IQsMLRniP5BcYfoNzTBT</div><div class="line">  discovery:</div><div class="line">    enabled: true</div><div class="line">    refresh:</div><div class="line">      enabled: true</div><div class="line">      interval: 1s</div><div class="line"># cluster02 集群</div><div class="line">- name: cluster02</div><div class="line">  enabled: true</div><div class="line">  endpoint: http://192.168.10.15:30993</div><div class="line">  basic_auth:</div><div class="line">    username: elastic</div><div class="line">    password: IQsMLRniP5BcYfoNzTBT</div><div class="line">  discovery:</div><div class="line">    enabled: true</div><div class="line">    refresh:</div><div class="line">      enabled: true</div><div class="line">      interval: 1s</div><div class="line"></div><div class="line"># 定义网关入口</div><div class="line">entry:</div><div class="line">  - name: my_es_entry</div><div class="line">    enabled: true</div><div class="line">    router: my_router</div><div class="line">    network:</div><div class="line">      binding: 0.0.0.0:8000</div><div class="line"></div><div class="line"># 定义工作流</div><div class="line">flow:</div><div class="line">  - name: auth-flow</div><div class="line">    filter:</div><div class="line">      #- basic_auth:</div><div class="line">      #    valid_users:</div><div class="line">      #      elastic: ******</div><div class="line">      - set_basic_auth:</div><div class="line">          username: elastic</div><div class="line">          password: IQsMLRniP5BcYfoNzTBT</div><div class="line">  - name: set-auth-for-backup-flow</div><div class="line">    filter:</div><div class="line">      - set_basic_auth: #覆盖备集群的身份信息用于备集群正常处理请求</div><div class="line">          username: elastic</div><div class="line">          password: IQsMLRniP5BcYfoNzTBT </div><div class="line"> # 写请求优先发给主集群, 当主集群不可用时发给备集群</div><div class="line"> # 当主集群数据写入成功时，记录到队列中，异步消费写入备集群</div><div class="line">  - name: write-flow</div><div class="line">    filter:</div><div class="line">      - flow:</div><div class="line">          flows:</div><div class="line">            - auth-flow</div><div class="line">      - if:</div><div class="line">      # 当主集群可用时</div><div class="line">          cluster_available: [&quot;cluster01&quot;]</div><div class="line">        then:</div><div class="line">          # 先将数据写入主集群</div><div class="line">          - elasticsearch:</div><div class="line">              elasticsearch: &quot;cluster01&quot;</div><div class="line">            # 写入消息队列,等待 pipeline 异步消费到备集群</div><div class="line">          - queue:</div><div class="line">              queue_name: &quot;cluster02-queue&quot;</div><div class="line">        else:</div><div class="line">          - elasticsearch:</div><div class="line">              elasticsearch: &quot;cluster02&quot;</div><div class="line">          - queue:</div><div class="line">              queue_name: &quot;cluster01-queue&quot;</div><div class="line">  # 读请求优先发给主集群, 当主集群不可用时发给备集群</div><div class="line">  - name: read-flow</div><div class="line">    filter:</div><div class="line">      - flow:</div><div class="line">          flows:</div><div class="line">            - set-auth-for-backup-flow</div><div class="line">      - if:</div><div class="line">          cluster_available: [&quot;cluster01&quot;]</div><div class="line">        then:</div><div class="line">          - elasticsearch:</div><div class="line">              elasticsearch: &quot;cluster01&quot;</div><div class="line">        else:</div><div class="line">          - elasticsearch:</div><div class="line">              elasticsearch: &quot;cluster02&quot;</div><div class="line"></div><div class="line"># 路由规则</div><div class="line">router:</div><div class="line">  - name: my_router</div><div class="line">    # 默认路由</div><div class="line">    default_flow: write-flow</div><div class="line">    # 读请求路由</div><div class="line">    rules:</div><div class="line">      - method:</div><div class="line">          - &quot;GET&quot;</div><div class="line">          - &quot;HEAD&quot;</div><div class="line">        pattern:</div><div class="line">          - &quot;/&#123;any:*&#125;&quot;</div><div class="line">        flow:</div><div class="line">          - read-flow</div><div class="line">      - method:</div><div class="line">          - &quot;POST&quot;</div><div class="line">          - &quot;GET&quot;</div><div class="line">        pattern:</div><div class="line">          - &quot;/_refresh&quot;</div><div class="line">          - &quot;/_count&quot;</div><div class="line">          - &quot;/_search&quot;</div><div class="line">          - &quot;/_msearch&quot;</div><div class="line">          - &quot;/_mget&quot;</div><div class="line">          - &quot;/&#123;any_index&#125;/_count&quot;</div><div class="line">          - &quot;/&#123;any_index&#125;/_search&quot;</div><div class="line">          - &quot;/&#123;any_index&#125;/_msearch&quot;</div><div class="line">          - &quot;/&#123;any_index&#125;/_mget&quot;</div><div class="line">        flow:</div><div class="line">          - read-flow</div><div class="line"></div><div class="line"># 定义管道, 异步将数据写入备集群</div><div class="line">pipeline:</div><div class="line">  - name: cluster01-consumer</div><div class="line">    auto_start: true</div><div class="line">    keep_running: true</div><div class="line">    processor:</div><div class="line">      - queue_consumer:</div><div class="line">          input_queue: &quot;cluster01-queue&quot; </div><div class="line">          elasticsearch: &quot;cluster01&quot;</div><div class="line">          when:</div><div class="line">            cluster_available: [&quot;cluster01&quot;] # 当集群可用时，才消费队列中的数据</div><div class="line">  - name: cluster02-consumer</div><div class="line">    auto_start: true</div><div class="line">    keep_running: true</div><div class="line">    processor:</div><div class="line">      - queue_consumer:</div><div class="line">          input_queue: &quot;cluster02-queue&quot;</div><div class="line">          elasticsearch: &quot;cluster02&quot;</div><div class="line">          when:</div><div class="line">            cluster_available: [&quot;cluster02&quot;]</div><div class="line"></div><div class="line">elastic:</div><div class="line">  enabled: true</div><div class="line">  remote_configs: false</div><div class="line">  health_check:</div><div class="line">    enabled: true</div><div class="line">    interval: 1s</div><div class="line">  availability_check:</div><div class="line">    enabled: true</div><div class="line">    interval: 1s</div><div class="line">  metadata_refresh:</div><div class="line">    enabled: true</div><div class="line">    interval: 1s</div><div class="line">  cluster_settings_check:</div><div class="line">    enabled: false</div><div class="line">    interval: 1s</div></pre></td></tr></table></figure>
<h2 id="启动网关-1"><a href="#启动网关-1" class="headerlink" title="启动网关"></a>启动网关</h2><p><code>[root@k8s-master gateway]#  ./bin/gateway</code></p>
<h2 id="测试准备"><a href="#测试准备" class="headerlink" title="测试准备"></a>测试准备</h2><h3 id="建立本地docker-es-集群，配置如下"><a href="#建立本地docker-es-集群，配置如下" class="headerlink" title="建立本地docker es 集群，配置如下"></a>建立本地docker es 集群，配置如下</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">[root@k8s-master gateway]<span class="comment"># cat docker-compose.yml </span></div><div class="line"><span class="attr">version:</span> <span class="string">'3.8'</span></div><div class="line"><span class="attr">services:</span></div><div class="line">  <span class="comment"># 集群 cluster01</span></div><div class="line">  <span class="comment"># Elasticsearch</span></div><div class="line"><span class="attr">  es01:</span></div><div class="line"><span class="attr">    image:</span> docker.io/library/elasticsearch:<span class="number">7.9</span><span class="number">.3</span></div><div class="line"><span class="attr">    container_name:</span> es01</div><div class="line"><span class="attr">    environment:</span></div><div class="line">      <span class="comment"># 节点名</span></div><div class="line"><span class="bullet">      -</span> node.name=es01</div><div class="line">      <span class="comment"># 集群名</span></div><div class="line"><span class="bullet">      -</span> cluster.name=cluster01</div><div class="line">      <span class="comment"># 指定单节点启动</span></div><div class="line"><span class="bullet">      -</span> discovery.type=single-node</div><div class="line">      <span class="comment"># 开启内存锁定</span></div><div class="line"><span class="bullet">      -</span> bootstrap.memory_lock=<span class="literal">true</span></div><div class="line">      <span class="comment"># 设置内存大小</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"ES_JAVA_OPTS=-Xms2g -Xmx2g"</span></div><div class="line">      <span class="comment"># 启用安全</span></div><div class="line"><span class="bullet">      -</span> xpack.security.enabled=<span class="literal">true</span></div><div class="line">      <span class="comment"># 设置 elastic 用户密码</span></div><div class="line"><span class="bullet">      -</span> ELASTIC_PASSWORD=IQsMLRniP5BcYfoNzTBT</div><div class="line"><span class="attr">    ulimits:</span></div><div class="line"><span class="attr">      memlock:</span></div><div class="line"><span class="attr">        soft:</span> <span class="bullet">-1</span></div><div class="line"><span class="attr">        hard:</span> <span class="bullet">-1</span></div><div class="line">    <span class="comment"># 映射到主机名的端口 宿主机端口:容器端口</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">9200</span>:<span class="number">9200</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="attr">      - data01:</span>/usr/share/elasticsearch/data</div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> elastic</div><div class="line">  <span class="comment"># Kibana</span></div><div class="line"><span class="attr">  kib01:</span></div><div class="line"><span class="attr">    image:</span> kibana:<span class="number">7.9</span><span class="number">.3</span></div><div class="line"><span class="attr">    container_name:</span> kib01</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">5601</span>:<span class="number">5601</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line">      <span class="comment"># Elasticsearch 连接信息</span></div><div class="line"><span class="attr">      ELASTICSEARCH_URL:</span> http://es01:<span class="number">9200</span></div><div class="line"><span class="attr">      ELASTICSEARCH_HOSTS:</span> <span class="string">'["http://es01:9200"]'</span></div><div class="line"><span class="attr">      ELASTICSEARCH_USERNAME:</span> elastic</div><div class="line"><span class="attr">      ELASTICSEARCH_PASSWORD:</span> IQsMLRniP5BcYfoNzTBT</div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> elastic</div><div class="line"></div><div class="line"><span class="comment"># 存储卷</span></div><div class="line"><span class="attr">volumes:</span></div><div class="line"><span class="attr">  data01:</span></div><div class="line"><span class="attr">    driver:</span> local</div><div class="line"><span class="attr">  data02:</span></div><div class="line"><span class="attr">    driver:</span> local</div><div class="line"><span class="attr">  data03:</span></div><div class="line"><span class="attr">    driver:</span> local</div><div class="line"></div><div class="line"><span class="comment"># 网络</span></div><div class="line"><span class="attr">networks:</span></div><div class="line"><span class="attr">  elastic:</span></div><div class="line"><span class="attr">    driver:</span> bridge</div></pre></td></tr></table></figure>
<h3 id="k8s-集群-已提前搭建"><a href="#k8s-集群-已提前搭建" class="headerlink" title="k8s 集群(已提前搭建)"></a>k8s 集群(已提前搭建)</h3><p>kubectl exec -it $(kubectl get pods -n esbeta| grep elasticsearch-client | sed -n 1p | awk ‘{print $1}’) -n esbeta – bin/elasticsearch-setup-passwords interactive </p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/09/17/大数据-实时计算Flink之FlinkSQL/" itemprop="url">
                  大数据-实时计算Flink之FlinkSQL
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2022-09-17T10:57:30+08:00" content="2022-09-17">
              2022-09-17
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2022/09/17/大数据-实时计算Flink之FlinkSQL/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2022/09/17/大数据-实时计算Flink之FlinkSQL/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>大数据处理技术现今已广泛应用于各个行业，为业务解决海量存储和海量分析的需求。但数据量的爆发式增长，对数据处理能力提出了更大的挑战，同时对时效性也提出了更高的要求。业务通常已不再满足滞后的分析结果，希望看到更实时的数据，从而在第一时间做出判断和决策。典型的场景如电商大促和金融风控等，基于延迟数据的分析结果已经失去了价值。</p>
<p>如何构建一个统一的数据湖存储，并在其上进行多种形式的数据分析，成了企业构建大数据生态的一个重要方向。如何快速、一致、原子性地在数据湖存储上构建起 Data Pipeline，成了亟待解决的问题。</p>
<p>下载<code>flink-sql-connector-mysql-cdc</code>, <code>flink-sql-connector-kafka</code> ,<code>flink-sql-connector-hive</code>到 /usr/lib/flink/lib/</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">wget https://repo1.maven.org/maven2/org/apache/flink/flink-sql-connector-kafka_2<span class="meta">.12</span>/<span class="number">1.14</span><span class="meta">.2</span>/flink-sql-connector-kafka_2<span class="meta">.12</span>-<span class="number">1.14</span><span class="meta">.2</span>.jar</div><div class="line"></div><div class="line">wget https://repo1.maven.org/maven2/com/ververica/flink-sql-connector-mysql-cdc/<span class="number">2.2</span><span class="meta">.1</span>/flink-sql-connector-mysql-cdc-<span class="number">2.2</span><span class="meta">.1</span>.jar</div><div class="line"></div><div class="line">wget https://repo.maven.apache.org/maven2/org/apache/flink/flink-sql-connector-hive-<span class="number">3.1</span><span class="meta">.2_2</span><span class="meta">.12</span>/<span class="number">1.14</span><span class="meta">.2</span>/flink-sql-connector-hive-<span class="number">3.1</span><span class="meta">.2_2</span><span class="meta">.12</span>-<span class="number">1.14</span><span class="meta">.2</span>.jar</div><div class="line"></div><div class="line">wget https://repo1.maven.org/maven2/org/apache/flink/flink-connector-jdbc_2<span class="meta">.12</span>/<span class="number">1.14</span><span class="meta">.2</span>/flink-connector-jdbc_2<span class="meta">.12</span>-<span class="number">1.14</span><span class="meta">.2</span>.jar</div></pre></td></tr></table></figure>
<p>Flink1.11引入了CDC的connector，通过这种方式可以很方便地捕获变化的数据，大大简化了数据处理的流程。Flink1.11的CDC connector主要包括：<code>MySQL CDC</code>和<code>Postgres CDC</code>,同时对Kafka的<strong>Connector</strong>支持<code>canal-json</code>和<code>debezium-json</code>以及<code>changelog-json</code>的format。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Flink CDC Connector 是ApacheFlink的一组数据源连接器，使用<strong>变化数据捕获change data capture (CDC)）</strong>从不同的数据库中提取变更数据。Flink CDC连接器将Debezium集成为引擎来捕获数据变更。因此，它可以充分利用Debezium的功能。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul>
<li>支持读取数据库快照，并且能够持续读取数据库的变更日志，即使发生故障，也支持<strong>exactly-once</strong> 的处理语义</li>
<li>对于DataStream API的CDC connector，用户无需部署Debezium和Kafka，即可在单个作业中使用多个数据库和表上的变更数据。</li>
<li>对于Table/SQL API 的CDC connector，用户可以使用SQL DDL创建CDC数据源，来监视单个表上的数据变更。</li>
</ul>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li>数据库之间的增量数据同步</li>
<li>审计日志</li>
<li>数据库之上的实时物化视图</li>
<li>基于CDC的维表join</li>
</ul>
<h2 id="Flink提供的-table-format"><a href="#Flink提供的-table-format" class="headerlink" title="Flink提供的 table format"></a>Flink提供的 table format</h2><p>Flink提供了一系列可以用于table connector的table format，具体如下：</p>
<table>
<thead>
<tr>
<th>Formats</th>
<th>Supported Connectors</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/csv.html" target="_blank" rel="external">CSV</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/kafka.html" target="_blank" rel="external">Apache Kafka</a>, <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/filesystem.html" target="_blank" rel="external">Filesystem</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/json.html" target="_blank" rel="external">JSON</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/kafka.html" target="_blank" rel="external">Apache Kafka</a>, <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/filesystem.html" target="_blank" rel="external">Filesystem</a>, <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/elasticsearch.html" target="_blank" rel="external">Elasticsearch</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/avro.html" target="_blank" rel="external">Apache Avro</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/kafka.html" target="_blank" rel="external">Apache Kafka</a>, <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/filesystem.html" target="_blank" rel="external">Filesystem</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/debezium.html" target="_blank" rel="external">Debezium CDC</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/kafka.html" target="_blank" rel="external">Apache Kafka</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/canal.html" target="_blank" rel="external">Canal CDC</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/kafka.html" target="_blank" rel="external">Apache Kafka</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/parquet.html" target="_blank" rel="external">Apache Parquet</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/filesystem.html" target="_blank" rel="external">Filesystem</a></td>
</tr>
<tr>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/formats/orc.html" target="_blank" rel="external">Apache ORC</a></td>
<td><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/connectors/filesystem.html" target="_blank" rel="external">Filesystem</a></td>
</tr>
</tbody>
</table>
<h2 id="使用过程中的注意点"><a href="#使用过程中的注意点" class="headerlink" title="使用过程中的注意点"></a>使用过程中的注意点</h2><h3 id="使用MySQL-CDC的注意点"><a href="#使用MySQL-CDC的注意点" class="headerlink" title="使用MySQL CDC的注意点"></a>使用MySQL CDC的注意点</h3><p>如果要使用MySQL CDC connector，对于程序而言，需要添加如下依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.ververica<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-mysql-cdc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>如果要使用Flink SQL Client，需要添加如下jar包：<strong><a href="https://repo1.maven.org/maven2/com/alibaba/ververica/flink-sql-connector-mysql-cdc/1.0.0/flink-sql-connector-mysql-cdc-1.0.0.jar" target="_blank" rel="external">flink-sql-connector-mysql-cdc-1.0.0.jar</a></strong>，将该jar包放在Flink安装目录的lib文件夹下即可。</p>
<h2 id="之前，-mysql-中需加入配置"><a href="#之前，-mysql-中需加入配置" class="headerlink" title="之前， mysql 中需加入配置"></a>之前， mysql 中需加入配置</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server_id</span>=<span class="number">1</span></div><div class="line"><span class="attr">log_bin</span>=mysql-bin</div><div class="line"><span class="attr">binlog_format</span>=ROW</div><div class="line"><span class="attr">binlog_row_image</span>=FULL</div></pre></td></tr></table></figure>
<p>重启mysql.</p>
<h2 id="mysql-cdc的操作实践"><a href="#mysql-cdc的操作实践" class="headerlink" title="mysql-cdc的操作实践"></a>mysql-cdc的操作实践</h2><h3 id="创建MySQL数据源表"><a href="#创建MySQL数据源表" class="headerlink" title="创建MySQL数据源表"></a>创建MySQL数据源表</h3><p>在创建MySQL CDC表之前，需要先创建MySQL的数据表，如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- MySQL</span></div><div class="line"><span class="comment">/*Table structure for table `order_info` */</span></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`order_info`</span>;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`order_info`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'编号'</span>,</div><div class="line">  <span class="string">`consignee`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'收货人'</span>,</div><div class="line">  <span class="string">`consignee_tel`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'收件人电话'</span>,</div><div class="line">  <span class="string">`total_amount`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'总金额'</span>,</div><div class="line">  <span class="string">`order_status`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单状态,1表示下单，2表示支付'</span>,</div><div class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户id'</span>,</div><div class="line">  <span class="string">`payment_way`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'付款方式'</span>,</div><div class="line">  <span class="string">`delivery_address`</span> <span class="built_in">varchar</span>(<span class="number">1000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'送货地址'</span>,</div><div class="line">  <span class="string">`order_comment`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单备注'</span>,</div><div class="line">  <span class="string">`out_trade_no`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单交易编号（第三方支付用)'</span>,</div><div class="line">  <span class="string">`trade_body`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单描述(第三方支付用)'</span>,</div><div class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</div><div class="line">  <span class="string">`operate_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'操作时间'</span>,</div><div class="line">  <span class="string">`expire_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'失效时间'</span>,</div><div class="line">  <span class="string">`tracking_no`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'物流单编号'</span>,</div><div class="line">  <span class="string">`parent_order_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'父订单编号'</span>,</div><div class="line">  <span class="string">`img_url`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'图片路径'</span>,</div><div class="line">  <span class="string">`province_id`</span> <span class="built_in">int</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'地区'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'订单表'</span>;</div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="comment">-- Records of order_info</span></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_info`</span> </div><div class="line"><span class="keyword">VALUES</span> (<span class="number">476</span>, <span class="string">'lAXjcL'</span>, <span class="string">'13408115089'</span>, <span class="number">433.00</span>, <span class="string">'2'</span>, <span class="number">10</span>, <span class="string">'2'</span>, <span class="string">'OYyAdSdLxedceqovndCD'</span>, <span class="string">'ihjAYsSjrgJMQVdFQnSy'</span>, <span class="string">'8728720206'</span>, <span class="string">''</span>, <span class="string">'2020-06-18 02:21:38'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">9</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_info`</span></div><div class="line"><span class="keyword">VALUES</span> (<span class="number">477</span>, <span class="string">'QLiFDb'</span>, <span class="string">'13415139984'</span>, <span class="number">772.00</span>, <span class="string">'1'</span>, <span class="number">90</span>, <span class="string">'2'</span>, <span class="string">'OizYrQbKuWvrvdfpkeSZ'</span>, <span class="string">'wiBhhqhMndCCgXwmWVQq'</span>, <span class="string">'1679381473'</span>, <span class="string">''</span>, <span class="string">'2020-06-18 09:12:25'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">3</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_info`</span></div><div class="line"><span class="keyword">VALUES</span> (<span class="number">478</span>, <span class="string">'iwKjQD'</span>, <span class="string">'13320383859'</span>, <span class="number">88.00</span>, <span class="string">'1'</span>, <span class="number">107</span>, <span class="string">'1'</span>, <span class="string">'cbXLKtNHWOcWzJVBWdAs'</span>, <span class="string">'njjsnknHxsxhuCCeNDDi'</span>, <span class="string">'0937074290'</span>, <span class="string">''</span>, <span class="string">'2020-06-18 15:56:34'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">7</span>);</div><div class="line"></div><div class="line"><span class="comment">/*Table structure for table `order_detail` */</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`order_detail`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'编号'</span>,</div><div class="line">  <span class="string">`order_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单编号'</span>,</div><div class="line">  <span class="string">`sku_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'sku_id'</span>,</div><div class="line">  <span class="string">`sku_name`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'sku名称（冗余)'</span>,</div><div class="line">  <span class="string">`img_url`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'图片名称（冗余)'</span>,</div><div class="line">  <span class="string">`order_price`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'购买价格(下单时sku价格）'</span>,</div><div class="line">  <span class="string">`sku_num`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'购买个数'</span>,</div><div class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'订单明细表'</span>;</div><div class="line"></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="comment">-- Records of order_detail</span></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_detail`</span> </div><div class="line"><span class="keyword">VALUES</span> (<span class="number">1329</span>, <span class="number">476</span>, <span class="number">8</span>, <span class="string">'Apple iPhone XS Max (A2104) 256GB 深空灰色 移动联通电信4G手机 双卡双待'</span>, <span class="string">'http://XLMByOyZDTJQYxphQHNTgYAFzJJCKTmCbzvEJIpz'</span>, <span class="number">8900.00</span>, <span class="string">'3'</span>, <span class="string">'2020-06-18 02:21:38'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_detail`</span> </div><div class="line"><span class="keyword">VALUES</span> (<span class="number">1330</span>, <span class="number">477</span>, <span class="number">9</span>, <span class="string">'荣耀10 GT游戏加速 AIS手持夜景 6GB+64GB 幻影蓝全网通 移动联通电信'</span>, <span class="string">'http://ixOCtlYmlxEEgUfPLiLdjMftzrleOEIBKSjrhMne'</span>, <span class="number">2452.00</span>, <span class="string">'4'</span>, <span class="string">'2020-06-18 09:12:25'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_detail`</span></div><div class="line"><span class="keyword">VALUES</span> (<span class="number">1331</span>, <span class="number">478</span>, <span class="number">4</span>, <span class="string">'小米Play 流光渐变AI双摄 4GB+64GB 梦幻蓝 全网通4G 双卡双待 小水滴全面屏拍照游戏智能手机'</span>, <span class="string">'http://RqfEFnAOqnqRnNZLFRvBuwXxwNBtptYJCILDKQYv'</span>, <span class="number">1442.00</span>, <span class="string">'1'</span>, <span class="string">'2020-06-18 15:56:34'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_detail`</span> </div><div class="line"><span class="keyword">VALUES</span> (<span class="number">1332</span>, <span class="number">478</span>, <span class="number">8</span>, <span class="string">'Apple iPhone XS Max (A2104) 256GB 深空灰色 移动联通电信4G手机 双卡双待'</span>, <span class="string">'http://IwhuCDlsiLenfKjPzbJrIoxswdfofKhJLMzlJAKV'</span>, <span class="number">8900.00</span>, <span class="string">'3'</span>, <span class="string">'2020-06-18 15:56:34'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`order_detail`</span> </div><div class="line"><span class="keyword">VALUES</span> (<span class="number">1333</span>, <span class="number">478</span>, <span class="number">8</span>, <span class="string">'Apple iPhone XS Max (A2104) 256GB 深空灰色 移动联通电信4G手机 双卡双待'</span>, <span class="string">'http://bbfwTbAzTWapywODzOtDJMJUEqNTeRTUQuCDkqXP'</span>, <span class="number">8900.00</span>, <span class="string">'1'</span>, <span class="string">'2020-06-18 15:56:34'</span>);</div></pre></td></tr></table></figure>
<h3 id="Flink-SQL-Cli创建CDC数据源"><a href="#Flink-SQL-Cli创建CDC数据源" class="headerlink" title="Flink SQL Cli创建CDC数据源"></a>Flink SQL Cli创建CDC数据源</h3><p>启动 Flink 集群，再启动 SQL CLI,执行下面命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 创建订单信息表</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_info(</div><div class="line">    <span class="keyword">id</span> <span class="built_in">BIGINT</span>,</div><div class="line">    user_id <span class="built_in">BIGINT</span>,</div><div class="line">    create_time <span class="keyword">TIMESTAMP</span>(<span class="number">0</span>),</div><div class="line">    operate_time <span class="keyword">TIMESTAMP</span>(<span class="number">0</span>),</div><div class="line">    province_id <span class="built_in">INT</span>,</div><div class="line">    order_status <span class="keyword">STRING</span>,</div><div class="line">    total_amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>, <span class="number">5</span>)</div><div class="line">  ) <span class="keyword">WITH</span> (</div><div class="line">    <span class="string">'connector'</span> = <span class="string">'mysql-cdc'</span>,</div><div class="line">    <span class="string">'hostname'</span> = <span class="string">'kms-1'</span>,</div><div class="line">    <span class="string">'port'</span> = <span class="string">'3306'</span>,</div><div class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</div><div class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</div><div class="line">    <span class="string">'database-name'</span> = <span class="string">'mydw'</span>,</div><div class="line">    <span class="string">'table-name'</span> = <span class="string">'order_info'</span></div><div class="line">);</div></pre></td></tr></table></figure>
<p>在Flink SQL Cli中查询该表的数据：result-mode: tableau，+表示数据的insert</p>
<p><a href="https://jiamaoxiang.top/2020/08/12/Flink1-11中的CDC-Connectors操作实践/图1.png" target="_blank" rel="external"><img src="https://jiamaoxiang.top/2020/08/12/Flink1-11%E4%B8%AD%E7%9A%84CDC-Connectors%E6%93%8D%E4%BD%9C%E5%AE%9E%E8%B7%B5/%E5%9B%BE1.png" alt="img"></a></p>
<p>在SQL CLI中创建订单详情表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_detail(</div><div class="line">    <span class="keyword">id</span> <span class="built_in">BIGINT</span>,</div><div class="line">    order_id <span class="built_in">BIGINT</span>,</div><div class="line">    sku_id <span class="built_in">BIGINT</span>,</div><div class="line">    sku_name <span class="keyword">STRING</span>,</div><div class="line">    sku_num <span class="built_in">BIGINT</span>,</div><div class="line">    order_price <span class="built_in">DECIMAL</span>(<span class="number">10</span>, <span class="number">5</span>),</div><div class="line">	create_time <span class="keyword">TIMESTAMP</span>(<span class="number">0</span>)</div><div class="line"> ) <span class="keyword">WITH</span> (</div><div class="line">    <span class="string">'connector'</span> = <span class="string">'mysql-cdc'</span>,</div><div class="line">    <span class="string">'hostname'</span> = <span class="string">'kms-1'</span>,</div><div class="line">    <span class="string">'port'</span> = <span class="string">'3306'</span>,</div><div class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</div><div class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</div><div class="line">    <span class="string">'database-name'</span> = <span class="string">'mydw'</span>,</div><div class="line">    <span class="string">'table-name'</span> = <span class="string">'order_detail'</span></div><div class="line">);</div></pre></td></tr></table></figure>
<p>查询结果如下：</p>
<p><a href="https://jiamaoxiang.top/2020/08/12/Flink1-11中的CDC-Connectors操作实践/图2.png" target="_blank" rel="external"><img src="https://jiamaoxiang.top/2020/08/12/Flink1-11%E4%B8%AD%E7%9A%84CDC-Connectors%E6%93%8D%E4%BD%9C%E5%AE%9E%E8%B7%B5/%E5%9B%BE2.png" alt="img"></a></p>
<p>执行JOIN操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span></div><div class="line">    od.id,</div><div class="line">    oi.id order_id,</div><div class="line">    oi.user_id,</div><div class="line">    oi.province_id,</div><div class="line">    od.sku_id,</div><div class="line">    od.sku_name,</div><div class="line">    od.sku_num,</div><div class="line">    od.order_price,</div><div class="line">    oi.create_time,</div><div class="line">    oi.operate_time</div><div class="line"><span class="keyword">FROM</span></div><div class="line">   (</div><div class="line">    <span class="keyword">SELECT</span> * </div><div class="line">    <span class="keyword">FROM</span> order_info</div><div class="line">    <span class="keyword">WHERE</span> </div><div class="line">	     order_status = <span class="string">'2'</span><span class="comment">-- 已支付</span></div><div class="line">   ) oi</div><div class="line">   <span class="keyword">JOIN</span></div><div class="line">  (</div><div class="line">    <span class="keyword">SELECT</span> *</div><div class="line">    <span class="keyword">FROM</span> order_detail</div><div class="line">  ) od </div><div class="line">  <span class="keyword">ON</span> oi.id = od.order_id;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/09/05/Headscale-之部署私有-DERP-中继服务器/" itemprop="url">
                  Headscale 之部署私有 DERP 中继服务器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2022-09-05T19:42:20+08:00" content="2022-09-05">
              2022-09-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2022/09/05/Headscale-之部署私有-DERP-中继服务器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2022/09/05/Headscale-之部署私有-DERP-中继服务器/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="STUN-是什么"><a href="#STUN-是什么" class="headerlink" title="STUN 是什么"></a>STUN 是什么</h2><p>Tailscale 的终极目标是让两台<strong>处于网络上的任何位置</strong>的机器建立<strong>点对点连接</strong>（直连），但现实世界是复杂的，大部份情况下机器都位于 NAT 和防火墙后面，这时候就需要通过打洞来实现直连，也就是 NAT 穿透。</p>
<p>NAT 按照 <strong>NAT 映射行为</strong>和<strong>有状态防火墙行为</strong>可以分为多种类型，但对于 NAT 穿透来说根本不需要关心这么多类型，只需要看 <strong>NAT 或者有状态防火墙是否会严格检查目标 Endpoint</strong>，根据这个因素，可以将 NAT 分为 <strong>Easy NAT</strong> 和 <strong>Hard NAT</strong>。</p>
<ul>
<li><strong>Easy NAT</strong> 及其变种称为 “Endpoint-Independent Mapping” (<strong>EIM，终点无关的映射</strong>)<br>这里的 Endpoint 指的是目标 Endpoint，也就是说，有状态防火墙只要看到有客户端自己发起的出向包，就会允许相应的入向包进入，<strong>不管这个入向包是谁发进来的都可以</strong>。</li>
<li><strong>hard NAT</strong> 以及变种称为 “Endpoint-Dependent Mapping”（<strong>EDM，终点相关的映射</strong>）<br>这种 NAT 会针对每个目标 Endpoint 来生成一条相应的映射关系。 在这样的设备上，如果客户端向某个目标 Endpoint 发起了出向包，假设客户端的公网 IP 是 2.2.2.2，那么有状态防火墙就会打开一个端口，假设是 4242。那么只有来自该目标 Endpoint 的入向包才允许通过 <code>2.2.2.2:4242</code>，其他客户端一律不允许。这种 NAT 更加严格，所以叫 Hard NAT。</li>
</ul>
<p>对于 Easy NAT，我们只需要提供一个第三方的服务，它能够告诉客户端“它看到的客户端的公网 ip:port 是什么”，然后将这个信息以某种方式告诉通信对端（peer），后者就知道该和哪个地址建连了！这种服务就叫 <strong>STUN</strong> (Session Traversal Utilities for NAT，NAT会话穿越应用程序)。它的工作流程如下图所示：</p>
<ul>
<li>笔记本向 STUN 服务器发送一个请求：“从你的角度看，我的地址什么？”</li>
<li>STUN 服务器返回一个响应：“我看到你的 UDP 包是从这个地址来的：<code>ip:port</code>”。</li>
</ul>
<h2 id="中继是什么"><a href="#中继是什么" class="headerlink" title="中继是什么"></a>中继是什么</h2><p>对于 <strong>Hard NAT</strong> 来说，STUN 就不好使了，即使 STUN 拿到了客户端的公网 <code>ip:port</code> 告诉通信对端也于事无补，因为防火墙是和 STUN 通信才打开的缺口，这个缺口只允许 STUN 的入向包进入，其他通信对端知道了这个缺口也进不来。通常企业级 NAT 都属于 Hard NAT。</p>
<p>这种情况下打洞是不可能了，但也不能就此放弃，可以选择一种折衷的方式：创建一个中继服务器（relay server），客户端与中继服务器进行通信，中继服务器再将包中继（relay）给通信对端。</p>
<p>至于中继的性能，那要看具体情况了：</p>
<ul>
<li>如果能直连，那显然没必要用中继方式；</li>
<li>但如果无法直连，而中继路径又非常接近双方直连的真实路径，并且带宽足够大，那中继方式并不会明显降低通信质量。延迟肯定会增加一点，带宽会占用一些，但<strong>相比完全连接不上，还是可以接受的</strong>。</li>
</ul>
<p>事实上对于大部分网络而言，Tailscale 都可以通过各种黑科技打洞成功，只有极少数情况下才会选择中继，中继只是一种 fallback 机制。</p>
<h2 id="中继协议简介"><a href="#中继协议简介" class="headerlink" title="中继协议简介"></a>中继协议简介</h2><p>中继协议有多种实现方式。</p>
<h3 id="TURN"><a href="#TURN" class="headerlink" title="TURN"></a>TURN</h3><p>TURN 即 Traversal Using Relays around NAT，这是一种经典的中继实现方式，核心理念是：</p>
<ul>
<li><strong>用户</strong>（人）先去公网上的 TURN 服务器认证，成功后后者会告诉你：“我已经为你分配了 ip:port，接下来将为你中继流量”，</li>
<li>然后将这个 ip:port 地址告诉对方，让它去连接这个地址，接下去就是非常简单的客户端/服务器通信模型了。</li>
</ul>
<p>与 STUN 不同，这种协议没有真正的交互性，不是很好用，因此 Tailscale 并没有采用 TURN 作为中继协议。</p>
<h3 id="DERP"><a href="#DERP" class="headerlink" title="DERP"></a>DERP</h3><p>DERP 即 Detoured Encrypted Routing Protocol，这是 Tailscale 自研的一个协议：</p>
<ul>
<li>它是一个<strong>通用目的包中继协议，运行在 HTTP 之上</strong>，而大部分网络都是允许 HTTP 通信的。</li>
<li>它根据目的公钥（destination’s public key）来中继加密的流量（encrypted payloads）。</li>
</ul>
<h2 id="自建私有-DERP-server"><a href="#自建私有-DERP-server" class="headerlink" title="自建私有 DERP server"></a>自建私有 DERP server</h2><p>Tailscale 的私钥只会保存在当前节点，因此 DERP server 无法解密流量，它只能和互联网上的其他路由器一样，呆呆地将加密的流量从一个节点转发到另一个节点，只不过 DERP 使用了一个稍微高级一点的协议来防止滥用。</p>
<p>Tailscale 开源了 DERP 服务器的代码，如果你感兴趣，可以阅读 <a href="https://github.com/tailscale/tailscale/tree/main/derp" target="_blank" rel="external">DERP 的源代码</a>。</p>
<hr>
<p>Tailscale 官方内置了很多 DERP 服务器，分步在全球各地，<strong>惟独不包含中国大陆</strong>，原因你懂得。这就导致了一旦流量通过 DERP 服务器进行中继，延时就会非常高。而且官方提供的 DERP 服务器是万人骑，存在安全隐患。</p>
<p>为了实现低延迟、高安全性，我们可以参考 <a href="https://tailscale.com/kb/1118/custom-derp-servers/" target="_blank" rel="external">Tailscale 官方文档</a>自建私有的 DERP 服务器。有两种部署模式，一种是基于域名，另外一种不需要域名，可以直接使用 IP，不过需要一点黑科技。我们先来看最简单的使用域名的方案。</p>
<p>还需要创建自签名证书，可以通过脚本来创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># build_cert.sh</span></div><div class="line"></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">CERT_HOST=<span class="variable">$1</span></div><div class="line">CERT_DIR=<span class="variable">$2</span></div><div class="line">CONF_FILE=<span class="variable">$3</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"[req]</span></div><div class="line">default_bits  = 2048</div><div class="line">distinguished_name = req_distinguished_name</div><div class="line">req_extensions = req_ext</div><div class="line">x509_extensions = v3_req</div><div class="line">prompt = no</div><div class="line"></div><div class="line">[req_distinguished_name]</div><div class="line">countryName = XX</div><div class="line">stateOrProvinceName = N/A</div><div class="line">localityName = N/A</div><div class="line">organizationName = Self-signed certificate</div><div class="line">commonName = <span class="variable">$CERT_HOST</span>: Self-signed certificate</div><div class="line"></div><div class="line">[req_ext]</div><div class="line">subjectAltName = @alt_names</div><div class="line"></div><div class="line">[v3_req]</div><div class="line">subjectAltName = @alt_names</div><div class="line"></div><div class="line">[alt_names]</div><div class="line">IP.1 = <span class="variable">$CERT_HOST</span></div><div class="line">" &gt; <span class="string">"<span class="variable">$CONF_FILE</span>"</span></div><div class="line"></div><div class="line">mkdir -p <span class="string">"<span class="variable">$CERT_DIR</span>"</span></div><div class="line">openssl req -x509 -nodes -days 730 -newkey rsa:2048 -keyout <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.key"</span> -out <span class="string">"<span class="variable">$CERT_DIR</span>/<span class="variable">$CERT_HOST</span>.crt"</span> -config <span class="string">"<span class="variable">$CONF_FILE</span>"</span></div></pre></td></tr></table></figure>
<p>重新编写 Dockerfile，将 derper 的域名设置为 <code>127.0.0.1</code>：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> golang:latest AS builder</div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># ========= CONFIG =========</span></div><div class="line"><span class="comment"># - download links</span></div><div class="line"><span class="keyword">ENV</span> MODIFIED_DERPER_GIT=https://github.com/yangchuansheng/ip_derper.git</div><div class="line"><span class="keyword">ENV</span> BRANCH=ip_derper</div><div class="line"><span class="comment"># ==========================</span></div><div class="line"></div><div class="line"><span class="comment"># build modified derper</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> git <span class="built_in">clone</span> -b <span class="variable">$BRANCH</span> <span class="variable">$MODIFIED_DERPER_GIT</span> tailscale --depth 1 &amp;&amp; \</span></div><div class="line">    <span class="built_in">cd</span> /app/tailscale/cmd/derper &amp;&amp; \</div><div class="line">    /usr/<span class="built_in">local</span>/go/bin/go build -ldflags <span class="string">"-s -w"</span> -o /app/derper &amp;&amp; \</div><div class="line">    <span class="built_in">cd</span> /app &amp;&amp; \</div><div class="line">    rm -rf /app/tailscale</div><div class="line"></div><div class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># ========= CONFIG =========</span></div><div class="line"><span class="comment"># - derper args</span></div><div class="line"><span class="keyword">ENV</span> DERP_HOST=<span class="number">127.0</span>.<span class="number">0.1</span></div><div class="line"><span class="keyword">ENV</span> DERP_CERTS=/app/certs/</div><div class="line"><span class="keyword">ENV</span> DERP_STUN true</div><div class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</div><div class="line"><span class="comment"># ==========================</span></div><div class="line"></div><div class="line"><span class="comment"># apt</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></div><div class="line">    apt-get install -y openssl curl</div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> build_cert.sh /app/</span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /app/derper /app/derper</span></div><div class="line"></div><div class="line"><span class="comment"># build self-signed certs &amp;&amp; start derper</span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> bash /app/build_cert.sh <span class="variable">$DERP_HOST</span> <span class="variable">$DERP_CERTS</span> /app/san.conf &amp;&amp; \</span></div><div class="line">    /app/derper --hostname=<span class="variable">$DERP_HOST</span> \</div><div class="line">    --certmode=manual \</div><div class="line">    --certdir=<span class="variable">$DERP_CERTS</span> \</div><div class="line">    --stun=<span class="variable">$DERP_STUN</span>  \</div><div class="line">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></div></pre></td></tr></table></figure>
<p>构建好镜像后，就可以在你想部署 derper 的主机上直接通过该镜像启动 derper 容器了，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">🐳  → docker run --restart always --net host --name derper  -p 12345:12345 -p 3478:3478/udp <span class="_">-e</span> DERP_ADDR=:12345  <span class="_">-d</span> ghcr.io/yangchuansheng/ip_derper</div></pre></td></tr></table></figure>
<p>Headscale 的本地 YAML 文件目前还不支持这个配置项，所以没办法，咱只能使用在线 URL 了。JSON 配置内容如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@jetlink headscale]# cat derp.json </div><div class="line">&#123;</div><div class="line">  "Regions": &#123;</div><div class="line">    "901": &#123;</div><div class="line">      "RegionID": 901,</div><div class="line">      "RegionCode": "ali-sh",</div><div class="line">      "RegionName": "Aliyun Shanghai",</div><div class="line">      "Nodes": [</div><div class="line">        &#123;</div><div class="line">          "Name": "901a",</div><div class="line">          "RegionID": 901,</div><div class="line">          "DERPPort": 12345,</div><div class="line">          "HostName": "xx.xx.xx.118",</div><div class="line">          "IPv4": "xx.xx.xx.118",</div><div class="line">          "InsecureForTests": true</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置解析：</p>
<ul>
<li><code>HostName</code> 直接填 derper 的公网 IP，即和 <code>IPv4</code> 的值相同。</li>
<li><code>InsecureForTests</code> 一定要设置为 true，以跳过域名验证。</li>
</ul>
<p>你需要把这个 JSON 文件变成 Headscale 服务器可以访问的 URL，比如在 Headscale 主机上搭个 Nginx，或者上传到对象存储（比如阿里云 OSS）</p>
<p>接下来还需要修改 Headscale 的配置文件，引用上面的自定义 DERP 的 URL。需要修改的配置项如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /etc/headscale/config.yaml</span></div><div class="line"><span class="attr">derp:</span></div><div class="line">  <span class="comment"># List of externally available DERP maps encoded in JSON</span></div><div class="line"><span class="attr">  urls:</span></div><div class="line">  <span class="comment">#  - https://controlplane.tailscale.com/derpmap/default</span></div><div class="line"><span class="attr">    - https:</span>//xxxxx/derp.json</div><div class="line"></div><div class="line">  <span class="comment"># Locally available DERP map files encoded in YAML</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment"># This option is mostly interesting for people hosting</span></div><div class="line">  <span class="comment"># their own DERP servers:</span></div><div class="line">  <span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></div><div class="line">  <span class="comment">#</span></div><div class="line">  <span class="comment"># paths:</span></div><div class="line">  <span class="comment">#   - /etc/headscale/derp-example.yaml</span></div><div class="line"><span class="attr">  paths:</span></div><div class="line"><span class="bullet">    -</span> /etc/headscale/derp.yaml</div><div class="line"></div><div class="line">  <span class="comment"># If enabled, a worker will be set up to periodically</span></div><div class="line">  <span class="comment"># refresh the given sources and update the derpmap</span></div><div class="line">  <span class="comment"># will be set up.</span></div><div class="line"><span class="attr">  auto_update_enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  <span class="comment"># How often should we check for DERP updates?</span></div><div class="line"><span class="attr">  update_frequency:</span> <span class="number">24</span>h</div></pre></td></tr></table></figure>
<p>修改完配置后，重启 headscale 服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl restart headscale</div></pre></td></tr></table></figure>
<p>在 Tailscale 客户端上使用以下命令查看目前可以使用的 DERP 服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ tailscale netcheck</div><div class="line"></div><div class="line">Report:</div><div class="line">	* UDP: <span class="literal">true</span></div><div class="line">	* IPv4: yes, 192.168.100.1:49656</div><div class="line">	* IPv6: no</div><div class="line">	* MappingVariesByDestIP: <span class="literal">true</span></div><div class="line">	* HairPinning: <span class="literal">false</span></div><div class="line">	* PortMapping: UPnP</div><div class="line">	* Nearest DERP: Home Hangzhou</div><div class="line">	* DERP latency:</div><div class="line">		- home: 9.7ms   (Home Hangzhou)</div><div class="line">		-  hs: 25.2ms  (Huawei Shanghai)</div><div class="line">		- thk: 43.5ms  (Tencent Hongkong)</div></pre></td></tr></table></figure>
<p>再次查看与通信对端的连接方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ tailscale status</div><div class="line">                coredns              default      linux   active; direct xxxx:45986; offline, tx 131012 rx 196020</div><div class="line">                oneplus-8t           default      android active; relay <span class="string">"home"</span>; offline, tx 211900 rx 22780</div><div class="line">                openwrt              default      linux   active; direct 192.168.100.254:41641; offline, tx 189868 rx 4074772</div></pre></td></tr></table></figure>
<p>可以看到这一次 Tailscale 自动选择了一个线路最优的<strong>国内的</strong> DERP 服务器作为中继，可以测试一下延迟：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ tailscale ping 10.1.0.8</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 45ms</div><div class="line">pong from oneplus-8t (10.1.0.8) via DERP(home) <span class="keyword">in</span> 30ms</div></pre></td></tr></table></figure>
<p>完美！这里的 home 当然是我的家庭宽带，部署方式与上面所说的国内云主机类似，你需要额外开启公网的端口映射（12345/tcp, 3478/udp）。还有一点需要注意的是配置内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"Regions"</span>: &#123;</div><div class="line">    <span class="attr">"901"</span>: &#123;</div><div class="line">      <span class="attr">"RegionID"</span>: <span class="number">901</span>,</div><div class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"ali-sh"</span>,</div><div class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Aliyun Shanghai"</span>,</div><div class="line">      <span class="attr">"Nodes"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"Name"</span>: <span class="string">"901a"</span>,</div><div class="line">          <span class="attr">"RegionID"</span>: <span class="number">901</span>,</div><div class="line">          <span class="attr">"DERPPort"</span>: <span class="number">443</span>,</div><div class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"IPv4"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"902"</span>: &#123;</div><div class="line">      <span class="attr">"RegionID"</span>: <span class="number">902</span>,</div><div class="line">      <span class="attr">"RegionCode"</span>: <span class="string">"home"</span>,</div><div class="line">      <span class="attr">"RegionName"</span>: <span class="string">"Home Hangzhou"</span>,</div><div class="line">      <span class="attr">"Nodes"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"Name"</span>: <span class="string">"902a"</span>,</div><div class="line">          <span class="attr">"RegionID"</span>: <span class="number">902</span>,</div><div class="line">          <span class="attr">"DERPPort"</span>: <span class="number">12345</span>,</div><div class="line">          <span class="attr">"HostName"</span>: <span class="string">"xxxx"</span>,</div><div class="line">          <span class="attr">"InsecureForTests"</span>: <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与国内云主机相比，家庭宽带的配置有两点不同：</p>
<ul>
<li>需要删除 <code>IPv4</code> 配置项。因为家用宽带的公网 IP 是动态变化的，所以你需要使用 <strong>DDNS</strong> 来动态解析公网 IP。</li>
<li><code>HostName</code> 最好填域名，因为你的公网 IP 是动态变化的，没法填写 IP，除非你不停地修改配置文件。填域名也没关系啦，反正不会验证域名的，也不用关心证书的事情，<strong>只要域名能解析到你的公网 IP 即可。</strong></li>
</ul>
<h2 id="防止-DERP-被白嫖"><a href="#防止-DERP-被白嫖" class="headerlink" title="防止 DERP 被白嫖"></a>防止 DERP 被白嫖</h2><p>默认情况下 DERP 服务器是可以被白嫖的，只要别人知道了你的 DERP 服务器的地址和端口，就可以为他所用。如果你的服务器是个小水管，用的人多了可能会把你撑爆，因此我们需要修改配置来防止被白嫖。</p>
<blockquote>
<p>特别声明：只有使用域名的方式才可以通过认证防止被白嫖，使用纯 IP 的方式无法防白嫖，你只能小心翼翼地隐藏好你的 IP 和端口，不能让别人知道。</p>
</blockquote>
<p>只需要做两件事情：</p>
<p><strong>1、在 DERP 服务器上安装 Tailscale。</strong></p>
<p>第一步需要在 DERP 服务所在的主机上安装 Tailscale 客户端，<strong>启动 tailscaled 进程</strong>。</p>
<p><strong>2、derper 启动时加上参数 <code>--verify-clients</code>。</strong></p>
<p>本文推荐的是通过容器启动， <a href="https://github.com/yangchuansheng/docker-image/blob/master/derper/Dockerfile" target="_blank" rel="external">Dockerfile 内容</a>如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> golang:latest AS builder</div><div class="line"></div><div class="line"><span class="keyword">LABEL</span><span class="bash"> org.opencontainers.image.source https://github.com/yangchuansheng/docker-image</span></div><div class="line"></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line"><span class="comment"># https://tailscale.com/kb/1118/custom-derp-servers/</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> go install tailscale.com/cmd/derper@main</span></div><div class="line"></div><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></div><div class="line"></div><div class="line">ARG DEBIAN_FRONTEND=noninteractive</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></div><div class="line">    apt-get install -y --no-install-recommends apt-utils &amp;&amp; \</div><div class="line">    apt-get install -y ca-certificates &amp;&amp; \</div><div class="line">    mkdir /app/certs</div><div class="line"></div><div class="line"><span class="keyword">ENV</span> DERP_DOMAIN your-hostname.com</div><div class="line"><span class="keyword">ENV</span> DERP_CERT_MODE letsencrypt</div><div class="line"><span class="keyword">ENV</span> DERP_CERT_DIR /app/certs</div><div class="line"><span class="keyword">ENV</span> DERP_ADDR :<span class="number">443</span></div><div class="line"><span class="keyword">ENV</span> DERP_STUN true</div><div class="line"><span class="keyword">ENV</span> DERP_HTTP_PORT <span class="number">80</span></div><div class="line"><span class="keyword">ENV</span> DERP_VERIFY_CLIENTS false</div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /go/bin/derper .</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> /app/derper --hostname=<span class="variable">$DERP_DOMAIN</span> \</span></div><div class="line">    --certmode=<span class="variable">$DERP_CERT_MODE</span> \</div><div class="line">    --certdir=<span class="variable">$DERP_CERT_DIR</span> \</div><div class="line">    -<span class="_">-a</span>=<span class="variable">$DERP_ADDR</span> \</div><div class="line">    --stun=<span class="variable">$DERP_STUN</span>  \</div><div class="line">    --http-port=<span class="variable">$DERP_HTTP_PORT</span> \</div><div class="line">    --verify-clients=<span class="variable">$DERP_VERIFY_CLIENTS</span></div></pre></td></tr></table></figure>
<p>默认情况下 <code>--verify-clients</code> 参数设置的是 <code>false</code>。我们不需要对 Dockerfile 内容做任何改动，只需在容器启动时加上环境变量即可，将之前的启动命令修改一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">🐳  → docker run --restart always \</div><div class="line">  --name derper -p 12345:12345 -p 3478:3478/udp \</div><div class="line">  -v /root/.acme.sh/xxxx/:/app/certs \</div><div class="line">  <span class="_">-e</span> DERP_CERT_MODE=manual \</div><div class="line">  <span class="_">-e</span> DERP_ADDR=:12345 \</div><div class="line">  <span class="_">-e</span> DERP_DOMAIN=xxxx \</div><div class="line">  <span class="_">-e</span> DERP_VERIFY_CLIENTS=<span class="literal">true</span> \</div><div class="line">  <span class="_">-d</span> ghcr.io/yangchuansheng/derper:latest</div></pre></td></tr></table></figure>
<p>这样就大功告成了，别人即使知道了你的 DERP 服务器地址也无法使用，但还是要说明一点，即便如此，你也应该尽量不让别人知道你的服务器地址，防止别人有可趁之机。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文给大家介绍了 STUN 对于辅助 NAT 穿透的意义，科普了几种常见的中继协议，包含 Tailscale 自研的 DERP 协议。最后手把手教大家如何自建私有的 DERP 服务器，并让 Tailscale 使用我们自建的 DERP 服务器。</p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://ruby-china-files.b0.upaiyun.com/user/big_avatar/5575.jpg"
               alt="peterfei" />
          <p class="site-author-name" itemprop="name">peterfei</p>
          <p class="site-description motion-element" itemprop="description">peterfei|技术|上主是我的牧者</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">75</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/peterfei" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">peterfei</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"peterfei"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  


</body>
</html>
