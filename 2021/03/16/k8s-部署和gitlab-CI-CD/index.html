<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="peterfei.me,peterfei" />





  <link rel="alternate" href="/atom.xml" title="Peterfei" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.0" />






<meta name="description" content="准备工作1. 安装必备软件1yum install -y wget vim net-tools epel-release
2. 关闭swap1234swapoff -a# 永久禁用，打开/etc/fstab注释掉swap那一行。sed -i &apos;s/.*swap.*/#&amp;amp;/&apos; /etc/fstab
3. 关闭selinux12345# 临时禁用selinuxsetenforce 0# 永久关">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s 部署和gitlab CI/CD">
<meta property="og:url" content="http://peterfei.me/2021/03/16/k8s-部署和gitlab-CI-CD/index.html">
<meta property="og:site_name" content="Peterfei">
<meta property="og:description" content="准备工作1. 安装必备软件1yum install -y wget vim net-tools epel-release
2. 关闭swap1234swapoff -a# 永久禁用，打开/etc/fstab注释掉swap那一行。sed -i &apos;s/.*swap.*/#&amp;amp;/&apos; /etc/fstab
3. 关闭selinux12345# 临时禁用selinuxsetenforce 0# 永久关">
<meta property="og:updated_time" content="2022-08-26T02:42:20.310Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="k8s 部署和gitlab CI/CD">
<meta name="twitter:description" content="准备工作1. 安装必备软件1yum install -y wget vim net-tools epel-release
2. 关闭swap1234swapoff -a# 永久禁用，打开/etc/fstab注释掉swap那一行。sed -i &apos;s/.*swap.*/#&amp;amp;/&apos; /etc/fstab
3. 关闭selinux12345# 临时禁用selinuxsetenforce 0# 永久关">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: '[object Object]',
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> k8s 部署和gitlab CI/CD | Peterfei </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  






  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Peterfei</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">上主是我的牧者，我实在一无所缺</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'PqEYgqEwUwFoXjgtngj9','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                k8s 部署和gitlab CI/CD
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2021-03-16T16:01:03+08:00" content="2021-03-16">
              2021-03-16
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2021/03/16/k8s-部署和gitlab-CI-CD/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/03/16/k8s-部署和gitlab-CI-CD/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="1-安装必备软件"><a href="#1-安装必备软件" class="headerlink" title="1. 安装必备软件"></a>1. 安装必备软件</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y wget vim net-tools epel-<span class="keyword">release</span></div></pre></td></tr></table></figure>
<h4 id="2-关闭swap"><a href="#2-关闭swap" class="headerlink" title="2. 关闭swap"></a>2. 关闭swap</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">swapoff -a</div><div class="line"></div><div class="line"><span class="comment"># 永久禁用，打开/etc/fstab注释掉swap那一行。</span></div><div class="line">sed -i <span class="string">'s/.*swap.*/#&amp;/'</span> <span class="regexp">/etc/</span>fstab</div></pre></td></tr></table></figure>
<h4 id="3-关闭selinux"><a href="#3-关闭selinux" class="headerlink" title="3. 关闭selinux"></a>3. 关闭selinux</h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 临时禁用selinux</span></div><div class="line">setenforce <span class="number">0</span></div><div class="line"><span class="meta"># 永久关闭 修改/etc/sysconfig/selinux文件设置</span></div><div class="line">sed -i <span class="string">'s/SELINUX=permissive/SELINUX=disabled/'</span> /etc/sysconfig/selinux</div><div class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</div></pre></td></tr></table></figure>
<h3 id="4-关闭防火墙"><a href="#4-关闭防火墙" class="headerlink" title="4. 关闭防火墙"></a>4. 关闭防火墙</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl <span class="keyword">disable</span> firewalld</div><div class="line">systemctl <span class="keyword">stop</span> firewalld</div></pre></td></tr></table></figure>
<h2 id="安装Docker和配置代理"><a href="#安装Docker和配置代理" class="headerlink" title="安装Docker和配置代理"></a>安装Docker和配置代理</h2><h3 id="1-配置yum源"><a href="#1-配置yum源" class="headerlink" title="1. 配置yum源"></a>1. 配置yum源</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">## 配置默认源</div><div class="line">## 备份</div><div class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</div><div class="line"></div><div class="line">## 下载阿里源</div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http:<span class="comment">//mirrors.aliyun.com/repo/Centos-7.repo</span></div><div class="line"></div><div class="line">## 刷新</div><div class="line">yum makecache fast</div><div class="line"></div><div class="line">## 配置k8s源</div><div class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</div><div class="line">[kubernetes]</div><div class="line">name=Kubernetes</div><div class="line">baseurl=https:<span class="comment">//mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></div><div class="line">enabled=<span class="number">1</span></div><div class="line">gpgcheck=<span class="number">0</span></div><div class="line">EOF</div><div class="line"></div><div class="line">## 重建yum缓存</div><div class="line">yum clean all</div><div class="line">yum makecache fast</div><div class="line">yum -y update</div></pre></td></tr></table></figure>
<h3 id="2-安装docker"><a href="#2-安装docker" class="headerlink" title="2. 安装docker"></a>2. 安装docker</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">yum -y <span class="keyword">install</span> yum-utils device-mapper-persistent-<span class="keyword">data</span> lvm2</div><div class="line">yum-config-manager <span class="comment">--add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></div><div class="line">yum -y <span class="keyword">install</span>  docker-ce<span class="number">-20.10</span><span class="number">.5</span> </div><div class="line">systemctl <span class="keyword">enable</span> docker</div><div class="line">systemctl <span class="keyword">start</span> docker</div></pre></td></tr></table></figure>
<h3 id="3-确保kubelet使用的cgroup-driver-与-Docker的一致"><a href="#3-确保kubelet使用的cgroup-driver-与-Docker的一致" class="headerlink" title="3. 确保kubelet使用的cgroup driver 与 Docker的一致"></a>3. 确保kubelet使用的cgroup driver 与 Docker的一致</h3><figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;<span class="symbol">EOF</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</div><div class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</div><div class="line">  <span class="string">"log-opts"</span>: &#123;</div><div class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>,</div><div class="line">  <span class="string">"storage-opts"</span>: [</div><div class="line">    <span class="string">"overlay2.override_kernel_check=true"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://ifa4ye2m.mirror.aliyuncs.com"</span>]</div><div class="line">&#125;</div><div class="line"><span class="symbol">EOF</span></div><div class="line"></div><div class="line">sudo systemctl daemon-reload sudo systemctl restart docker</div></pre></td></tr></table></figure>
<h3 id="4-从国内仓库拉取镜像（核心步骤-如果没有代理）"><a href="#4-从国内仓库拉取镜像（核心步骤-如果没有代理）" class="headerlink" title="4. 从国内仓库拉取镜像（核心步骤-如果没有代理）"></a>4. 从国内仓库拉取镜像（核心步骤-如果没有代理）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">images=(</div><div class="line">kube-apiserver:v1.18.16</div><div class="line">kube-controller-manager:v1.18.16</div><div class="line">kube-scheduler:v1.18.16</div><div class="line">kube-proxy:v1.18.16</div><div class="line">pause:3.2</div><div class="line">etcd:3.4.3-0</div><div class="line">coredns:1.6.7</div><div class="line">kubernetes-dashboard-amd64:v1.10.1</div><div class="line">)</div><div class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span>;<span class="keyword">do</span></div><div class="line">        docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></div><div class="line">        docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<h2 id="开始安装k8s"><a href="#开始安装k8s" class="headerlink" title="开始安装k8s"></a>开始安装k8s</h2><h3 id="1-安装kubeadm，kubelet等"><a href="#1-安装kubeadm，kubelet等" class="headerlink" title="1. 安装kubeadm，kubelet等"></a>1. 安装kubeadm，kubelet等</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">yum</span> <span class="selector-tag">install</span> <span class="selector-tag">kubelet-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span> <span class="selector-tag">kubeadm-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span> <span class="selector-tag">kubectl-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span> <span class="selector-tag">kubernetes-cni-1</span><span class="selector-class">.18</span><span class="selector-class">.0</span></div></pre></td></tr></table></figure>
<h3 id="2-集群初始化"><a href="#2-集群初始化" class="headerlink" title="2. 集群初始化"></a>2. 集群初始化</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">## master节点执行：</div><div class="line">sudo kubeadm init \</div><div class="line"> --apiserver-advertise-address <span class="number">10.1</span><span class="number">.69</span><span class="number">.101</span> \</div><div class="line"> --kubernetes-version=v1<span class="number">.15</span><span class="number">.0</span> \</div><div class="line"> --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">如果外网：</div><div class="line"></div><div class="line">kubeadm init --apiserver-advertise-address xx.xx<span class="number">.255</span><span class="number">.84</span> --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> --kubernetes-version=v1<span class="number">.18</span><span class="number">.0</span></div></pre></td></tr></table></figure>
<p>得到回复：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">(...省略)</div><div class="line"><span class="keyword">mkdir</span> -p <span class="variable">$HOME</span>/.kube</div><div class="line">sudo cp -i /etc/kubernetes/admin.<span class="keyword">conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -<span class="keyword">u</span>):$(id -<span class="keyword">g</span>) <span class="variable">$HOME</span>/.kube/config</div><div class="line"></div><div class="line">## 保存好该命令，丢了不好找回。节点加入时需要</div><div class="line">kubeadm join 10.1.69.101:6443 --<span class="keyword">token</span> ou5pvo.qseafc4s8licblzy \</div><div class="line">    --discovery-<span class="keyword">token</span>-<span class="keyword">ca</span>-cert-hash sha256:de9c10f11c50c074f212698b9d514fc12a9c1c4ffe70961aff89ac5e585f0663</div></pre></td></tr></table></figure>
<h3 id="3-拷贝配置，给kubectl使用"><a href="#3-拷贝配置，给kubectl使用" class="headerlink" title="3. 拷贝配置，给kubectl使用"></a>3. 拷贝配置，给kubectl使用</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir -<span class="selector-tag">p</span> <span class="variable">$HOME</span>/<span class="selector-class">.kube</span></div><div class="line">sudo cp -<span class="selector-tag">i</span> /etc/kubernetes/admin<span class="selector-class">.conf</span> <span class="variable">$HOME</span>/.kube/config</div><div class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</div></pre></td></tr></table></figure>
<h3 id="4-安装flannel网络"><a href="#4-安装flannel网络" class="headerlink" title="4. 安装flannel网络"></a>4. 安装flannel网络</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo kubectl apply -<span class="keyword">f</span> http<span class="variable">s:</span>//raw.githubusercontent.<span class="keyword">com</span>/coreos/flannel/master/Documentation/kube-flannel.yml</div><div class="line"></div><div class="line">## 查看flannal是否安装成功</div><div class="line"></div><div class="line">sudo kubectl -n kube-<span class="built_in">system</span> <span class="built_in">get</span> <span class="keyword">po</span> -<span class="keyword">l</span> app=flannel -<span class="keyword">o</span> wide</div></pre></td></tr></table></figure>
<h2 id="5-node节点加入集群"><a href="#5-node节点加入集群" class="headerlink" title="5. node节点加入集群"></a>5. node节点加入集群</h2><p>其他节点执行：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">kubeadm</span> <span class="selector-tag">join</span> 10<span class="selector-class">.1</span><span class="selector-class">.69</span><span class="selector-class">.101</span><span class="selector-pseudo">:6443</span> <span class="selector-tag">--token</span> <span class="selector-tag">ou5pvo</span><span class="selector-class">.qseafc4s8licblzy</span> \</div><div class="line">    <span class="selector-tag">--discovery-token-ca-cert-hash</span> <span class="selector-tag">sha256</span><span class="selector-pseudo">:de9c10f11c50c074f212698b9d514fc12a9c1c4ffe70961aff89ac5e585f0663</span></div></pre></td></tr></table></figure>
<h2 id="清理安装"><a href="#清理安装" class="headerlink" title="清理安装"></a>清理安装</h2><ul>
<li>如果安装过程中出任何问题，可以重置后重新安装</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">sudo kubeadm reset</span></div></pre></td></tr></table></figure>
<h3 id="安装-helm-和-gitlab-runner"><a href="#安装-helm-和-gitlab-runner" class="headerlink" title="安装 helm 和 gitlab-runner"></a>安装 helm 和 gitlab-runner</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tar -zxvf helm-v2.<span class="number">12.1</span>-linux-amd64<span class="selector-class">.tar</span><span class="selector-class">.gz</span></div><div class="line">cd linux-amd64/</div><div class="line"></div><div class="line">cp helm /usr/local/bin</div></pre></td></tr></table></figure>
<p><code>cat tiller.yaml</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> apps/v1</div><div class="line"><span class="attr">kind:</span> Deployment</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> helm</div><div class="line"><span class="attr">    name:</span> tiller</div><div class="line"><span class="attr">  name:</span> tiller-deploy</div><div class="line"><span class="attr">  namespace:</span> kube-system</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">1</span></div><div class="line"><span class="attr">  strategy:</span> &#123;&#125;</div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      name:</span> tiller</div><div class="line"><span class="attr">      app:</span> helm</div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> helm</div><div class="line"><span class="attr">        name:</span> tiller</div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      automountServiceAccountToken:</span> <span class="literal">true</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - env:</span></div><div class="line"><span class="attr">        - name:</span> TILLER_NAMESPACE</div><div class="line"><span class="attr">          value:</span> kube-system</div><div class="line"><span class="attr">        - name:</span> TILLER_HISTORY_MAX</div><div class="line"><span class="attr">          value:</span> <span class="string">"0"</span></div><div class="line"><span class="attr">        image:</span> registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2<span class="number">.14</span><span class="number">.3</span></div><div class="line"><span class="attr">        imagePullPolicy:</span> IfNotPresent</div><div class="line"><span class="attr">        livenessProbe:</span></div><div class="line"><span class="attr">          httpGet:</span></div><div class="line"><span class="attr">            path:</span> /liveness</div><div class="line"><span class="attr">            port:</span> <span class="number">44135</span></div><div class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">        name:</span> tiller</div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - containerPort:</span> <span class="number">44134</span></div><div class="line"><span class="attr">          name:</span> tiller</div><div class="line"><span class="attr">        - containerPort:</span> <span class="number">44135</span></div><div class="line"><span class="attr">          name:</span> http</div><div class="line"><span class="attr">        readinessProbe:</span></div><div class="line"><span class="attr">          httpGet:</span></div><div class="line"><span class="attr">            path:</span> /readiness</div><div class="line"><span class="attr">            port:</span> <span class="number">44135</span></div><div class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">        resources:</span> &#123;&#125;</div><div class="line"><span class="attr">      serviceAccountName:</span> tiller</div><div class="line"><span class="attr">status:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> Service</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> helm</div><div class="line"><span class="attr">    name:</span> tiller</div><div class="line"><span class="attr">  name:</span> tiller-deploy</div><div class="line"><span class="attr">  namespace:</span> kube-system</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">  - name:</span> tiller</div><div class="line"><span class="attr">    port:</span> <span class="number">44134</span></div><div class="line"><span class="attr">    targetPort:</span> tiller</div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    app:</span> helm</div><div class="line"><span class="attr">    name:</span> tiller</div><div class="line"><span class="attr">  type:</span> ClusterIP</div><div class="line"><span class="attr">status:</span></div><div class="line"><span class="attr">  loadBalancer:</span> &#123;&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">kubectl apply -<span class="keyword">f</span> tiller.yaml</div><div class="line">helm init --upgrade --stable-repo-url http<span class="variable">s:</span>//kubernetes.oss-<span class="keyword">cn</span>-hangzhou.aliyuncs.<span class="keyword">com</span>/charts</div><div class="line"></div><div class="line">#helm init -i registry.<span class="keyword">cn</span>-hangzhou.aliyuncs.<span class="keyword">com</span>/google_containers/tiller:v2.<span class="number">14.3</span> --stable-repo-url http://mirror.azure.<span class="keyword">cn</span>/kubernetes/charts/ --service-account tiller --override spec.selector.matchLabels.<span class="string">'name'</span>=<span class="string">'tiller'</span>,spec.selector.matchLabels.<span class="string">'app'</span>=<span class="string">'helm'</span> --output yaml | sed <span class="string">'s@apiVersion: extensions/v1beta1@apiVersion: apps/v1@'</span> | kubectl <span class="keyword">delete</span> -<span class="keyword">f</span> -</div><div class="line"> </div><div class="line"> kubectl create serviceaccount --namespace kube-<span class="built_in">system</span> tiller</div><div class="line"> kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-<span class="built_in">system</span>:tiller</div><div class="line"> kubectl patch deploy --namespace kube-<span class="built_in">system</span> tiller-deploy -<span class="keyword">p</span> <span class="string">'&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;'</span></div><div class="line"></div><div class="line"></div><div class="line"> kubectl <span class="built_in">get</span> <span class="keyword">po</span>  -A|<span class="keyword">grep</span> tiller</div><div class="line"> kubectl patch deploy --namespace kube-<span class="built_in">system</span> tiller-deploy -<span class="keyword">p</span> <span class="string">'&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;'</span></div><div class="line"></div><div class="line"> helm repo <span class="built_in">add</span> gitlab http<span class="variable">s:</span>//charts.gitlab.io</div><div class="line"> helm repo <span class="keyword">update</span></div><div class="line"> helm fetch gitlab/gitlab-runner --<span class="keyword">version</span> <span class="string">"v0.10.0-rc1"</span></div><div class="line"> </div><div class="line"> kubectl create namespace gitlab-runners</div><div class="line"> <span class="built_in">mkdir</span> -<span class="keyword">p</span> gitlab-runner</div><div class="line"> <span class="keyword">cd</span> gitlab-runner/</div><div class="line"> kubectl create -<span class="keyword">f</span> rbac-runner-config.yaml</div></pre></td></tr></table></figure>
<p>cat rbac-runner-config.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> ServiceAccount</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">kind:</span> Role</div><div class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">rules:</span></div><div class="line"><span class="attr">- apiGroups:</span> [<span class="string">""</span>] <span class="comment">#"" indicates the core API group</span></div><div class="line"><span class="attr">  resources:</span> [<span class="string">"*"</span>]</div><div class="line"><span class="attr">  verbs:</span> [<span class="string">"*"</span>]</div><div class="line"><span class="attr">- apiGroups:</span> [<span class="string">"apps"</span>]</div><div class="line"><span class="attr">  resources:</span> [<span class="string">"deployments"</span>]</div><div class="line"><span class="attr">  verbs:</span> [<span class="string">"*"</span>]</div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">kind:</span> RoleBinding</div><div class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">subjects:</span></div><div class="line"><span class="attr">- kind:</span> ServiceAccount</div><div class="line"><span class="attr">  name:</span> gitlab <span class="comment"># Name is case sensitive</span></div><div class="line"><span class="attr">  apiGroup:</span> <span class="string">""</span></div><div class="line"><span class="attr">roleRef:</span></div><div class="line"><span class="attr">  kind:</span> Role <span class="comment">#this must be Role or ClusterRole</span></div><div class="line"><span class="attr">  name:</span> gitlab <span class="comment"># this must match the name of the Role or ClusterRole you wish to bind to</span></div><div class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</div></pre></td></tr></table></figure>
<blockquote>
<p> <code>cat  values-spm-operation-frontend.yaml</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## GitLab Runner Image</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## By default it's using gitlab/gitlab-runner:alpine-v&#123;VERSION&#125;</span></div><div class="line"><span class="comment">## where &#123;VERSION&#125; is taken from Chart.yaml from appVersion field</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## ref: https://hub.docker.com/r/gitlab/gitlab-runner/tags/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># image: gitlab/gitlab-runner:alpine-v11.6.0</span></div><div class="line"></div><div class="line"><span class="comment">## Specify a imagePullPolicy</span></div><div class="line"><span class="comment">## 'Always' if imageTag is 'latest', else set to 'IfNotPresent'</span></div><div class="line"><span class="comment">## ref: http://kubernetes.io/docs/user-guide/images/#pre-pulling-images</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">imagePullPolicy:</span> IfNotPresent</div><div class="line"><span class="attr">gitlabUrl:</span> http://xxx.xxx.cn/</div><div class="line"><span class="attr">runnerRegistrationToken:</span> <span class="string">"-Rxxz6Cqdk33Q96mRdxk"</span></div><div class="line"></div><div class="line"><span class="comment">## 和之前配置的 rbac name 对应</span></div><div class="line"></div><div class="line"><span class="comment">## 指定关联 runner 的标签</span></div><div class="line"><span class="attr">tags:</span> <span class="string">" operations"</span></div><div class="line"></div><div class="line"><span class="attr">privileged:</span> <span class="literal">true</span></div><div class="line"><span class="attr">serviceAccountName:</span> gitlab</div><div class="line"><span class="comment">## The GitLab Server URL (with protocol) that want to register the runner against</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/commands/README.html#gitlab-runner-register</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># gitlabUrl: http://gitlab.your-domain.com/</span></div><div class="line"></div><div class="line"><span class="comment">## The Registration Token for adding new Runners to the GitLab Server. This must</span></div><div class="line"><span class="comment">## be retrieved from your GitLab Instance.</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/ce/ci/runners/README.html</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># runnerRegistrationToken: ""</span></div><div class="line"></div><div class="line"><span class="comment">## The Runner Token for adding new Runners to the GitLab Server. This must</span></div><div class="line"><span class="comment">## be retrieved from your GitLab Instance. It is token of already registered runner.</span></div><div class="line"><span class="comment">## ref: (we don't yet have docs for that, but we want to use existing token)</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># runnerToken: ""</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">## Unregister all runners before termination</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## Updating the runner's chart version or configuration will cause the runner container</span></div><div class="line"><span class="comment">## to be terminated and created again. This may cause your Gitlab instance to reference</span></div><div class="line"><span class="comment">## non-existant runners. Un-registering the runner before termination mitigates this issue.</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/commands/README.html#gitlab-runner-unregister</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">unregisterRunners:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">## When stopping ther runner, give it time to wait for it's jobs to terminate.</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">## Updating the runner's chart version or configuration will cause the runner container</span></div><div class="line"><span class="comment">## to be terminated with a graceful stop request. terminationGracePeriodSeconds</span></div><div class="line"><span class="comment">## instructs Kubernetes to wait long enough for the runner pod to terminate gracefully.</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/commands/#signals</span></div><div class="line"><span class="attr">terminationGracePeriodSeconds:</span> <span class="number">3600</span></div><div class="line"></div><div class="line"><span class="comment">## Set the certsSecretName in order to pass custom certficates for GitLab Runner to use</span></div><div class="line"><span class="comment">## Provide resource name for a Kubernetes Secret Object in the same namespace,</span></div><div class="line"><span class="comment">## this is used to populate the /home/gitlab-runner/.gitlab-runner/certs/ directory</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># certsSecretName:</span></div><div class="line"></div><div class="line"><span class="comment">## Configure the maximum number of concurrent jobs</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">concurrent:</span> <span class="number">10</span></div><div class="line"></div><div class="line"><span class="comment">## Defines in seconds how often to check GitLab for a new builds</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">checkInterval:</span> <span class="number">30</span></div><div class="line"><span class="attr">limitLine:</span> <span class="number">100000</span></div><div class="line"><span class="comment">## Configure GitLab Runner's logging level. Available values are: debug, info, warn, error, fatal, panic</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># logLevel:</span></div><div class="line"></div><div class="line"><span class="comment">## Configure GitLab Runner's logging format. Available values are: runner, text, json</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># logFormat:</span></div><div class="line"></div><div class="line"><span class="comment">## For RBAC support:</span></div><div class="line"><span class="attr">rbac:</span></div><div class="line"><span class="attr">  create:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  serviceAccountName:</span> gitlab</div><div class="line">  <span class="comment">## Define specific rbac permissions.</span></div><div class="line">  <span class="comment"># resources: ["pods", "pods/exec", "secrets"]</span></div><div class="line">  <span class="comment"># verbs: ["get", "list", "watch", "create", "patch", "delete"]</span></div><div class="line"></div><div class="line">  <span class="comment">## Run the gitlab-bastion container with the ability to deploy/manage containers of jobs</span></div><div class="line">  <span class="comment">## cluster-wide or only within namespace</span></div><div class="line"><span class="attr">  clusterWideAccess:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">  <span class="comment">## Use the following Kubernetes Service Account name if RBAC is disabled in this Helm chart (see rbac.create)</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># serviceAccountName: default</span></div><div class="line"></div><div class="line"><span class="comment">## Configure integrated Prometheus metrics exporter</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/monitoring/#configuration-of-the-metrics-http-server</span></div><div class="line"><span class="attr">metrics:</span></div><div class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">## Configuration for the Pods that that the runner launches for each new job</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">runners:</span></div><div class="line">  <span class="comment">## Default container image to use for builds when none is specified</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  image:</span> ubuntu:<span class="number">16.04</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify one or more imagePullSecrets</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># imagePullSecrets: []</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify the image pull policy: never, if-not-present, always. The cluster default will be used if not set.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># imagePullPolicy: ""</span></div><div class="line"></div><div class="line">  <span class="comment">## Defines number of concurrent requests for new job from GitLab</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># requestConcurrency: 1</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify whether the runner should be locked to a specific project: true, false. Defaults to true.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># locked: true</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify the tags associated with the runner. Comma-separated list of tags.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/ce/ci/runners/#using-tags</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># tags: ""</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify if jobs without tags should be run.</span></div><div class="line">  <span class="comment">## If not specified, Runner will default to true if no tags were specified. In other case it will</span></div><div class="line">  <span class="comment">## default to false.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/ce/ci/runners/#allowing-runners-with-tags-to-pick-jobs-without-tags</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># runUntagged: true</span></div><div class="line"></div><div class="line">  <span class="comment">## Run all containers with the privileged flag enabled</span></div><div class="line">  <span class="comment">## This will allow the docker:dind image to run if you need to run Docker</span></div><div class="line">  <span class="comment">## commands. Please read the docs before turning this on:</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-dind</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  privileged:</span> <span class="literal">false</span></div><div class="line"></div><div class="line">  <span class="comment">## The name of the secret containing runner-token and runner-registration-token</span></div><div class="line">  <span class="comment"># secret: gitlab-runner</span></div><div class="line"></div><div class="line">  <span class="comment">## Namespace to run Kubernetes jobs in (defaults to the same namespace of this release)</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># namespace:</span></div><div class="line"></div><div class="line">  <span class="comment">## Distributed runners caching</span></div><div class="line">  <span class="comment">## ref: https://gitlab.com/gitlab-org/gitlab-runner/blob/master/docs/configuration/autoscale.md#distributed-runners-caching</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## If you want to use s3 based distributing caching:</span></div><div class="line">  <span class="comment">## First of all you need to uncomment General settings and S3 settings sections.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Create a secret 's3access' containing 'accesskey' &amp; 'secretkey'</span></div><div class="line">  <span class="comment">## ref: https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## $ kubectl create secret generic s3access \</span></div><div class="line">  <span class="comment">##   --from-literal=accesskey="YourAccessKey" \</span></div><div class="line">  <span class="comment">##   --from-literal=secretkey="YourSecretKey"</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/secret/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## If you want to use gcs based distributing caching:</span></div><div class="line">  <span class="comment">## First of all you need to uncomment General settings and GCS settings sections.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Access using credentials file:</span></div><div class="line">  <span class="comment">## Create a secret 'google-application-credentials' containing your application credentials file.</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnerscachegcs-section</span></div><div class="line">  <span class="comment">## You could configure</span></div><div class="line">  <span class="comment">## $ kubectl create secret generic google-application-credentials \</span></div><div class="line">  <span class="comment">##   --from-file=gcs-applicaton-credentials-file=./path-to-your-google-application-credentials-file.json</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/secret/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Access using access-id and private-key:</span></div><div class="line">  <span class="comment">## Create a secret 'gcsaccess' containing 'gcs-access-id' &amp; 'gcs-private-key'.</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-cache-gcs-section</span></div><div class="line">  <span class="comment">## You could configure</span></div><div class="line">  <span class="comment">## $ kubectl create secret generic gcsaccess \</span></div><div class="line">  <span class="comment">##   --from-literal=gcs-access-id="YourAccessID" \</span></div><div class="line">  <span class="comment">##   --from-literal=gcs-private-key="YourPrivateKey"</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/secret/</span></div><div class="line"><span class="attr">  cache:</span> &#123;&#125;</div><div class="line">    <span class="comment">## General settings</span></div><div class="line">    <span class="comment"># cacheType: s3</span></div><div class="line">    <span class="comment"># cachePath: "gitlab_runner"</span></div><div class="line">    <span class="comment"># cacheShared: true</span></div><div class="line"></div><div class="line">    <span class="comment">## S3 settings</span></div><div class="line">    <span class="comment"># s3ServerAddress: s3.amazonaws.com</span></div><div class="line">    <span class="comment"># s3BucketName:</span></div><div class="line">    <span class="comment"># s3BucketLocation:</span></div><div class="line">    <span class="comment"># s3CacheInsecure: false</span></div><div class="line">    <span class="comment"># secretName: s3access</span></div><div class="line"></div><div class="line">    <span class="comment">## GCS settings</span></div><div class="line">    <span class="comment"># gcsBucketName:</span></div><div class="line">    <span class="comment">## Use this line for access using access-id and private-key</span></div><div class="line">    <span class="comment"># secretName: gcsaccess</span></div><div class="line">    <span class="comment">## Use this line for access using google-application-credentials file</span></div><div class="line">    <span class="comment"># secretName: google-application-credentials</span></div><div class="line"></div><div class="line">  <span class="comment">## Build Container specific configuration</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  builds:</span> &#123;&#125;</div><div class="line">    <span class="comment"># cpuLimit: 200m</span></div><div class="line">    <span class="comment"># memoryLimit: 256Mi</span></div><div class="line">    <span class="comment"># cpuRequests: 100m</span></div><div class="line">    <span class="comment"># memoryRequests: 128Mi</span></div><div class="line"></div><div class="line">  <span class="comment">## Service Container specific configuration</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  services:</span> &#123;&#125;</div><div class="line">    <span class="comment"># cpuLimit: 200m</span></div><div class="line">    <span class="comment"># memoryLimit: 256Mi</span></div><div class="line">    <span class="comment"># cpuRequests: 100m</span></div><div class="line">    <span class="comment"># memoryRequests: 128Mi</span></div><div class="line"></div><div class="line">  <span class="comment">## Helper Container specific configuration</span></div><div class="line">  <span class="comment">##</span></div><div class="line"><span class="attr">  helpers:</span> &#123;&#125;</div><div class="line">    <span class="comment"># cpuLimit: 200m</span></div><div class="line">    <span class="comment"># memoryLimit: 256Mi</span></div><div class="line">    <span class="comment"># cpuRequests: 100m</span></div><div class="line">    <span class="comment"># memoryRequests: 128Mi</span></div><div class="line">    <span class="comment"># image: gitlab/gitlab-runner-helper:x86_64-latest</span></div><div class="line"></div><div class="line">  <span class="comment">## Service Account to be used for runners</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># serviceAccountName:</span></div><div class="line"></div><div class="line">  <span class="comment">## If Gitlab is not reachable through $CI_SERVER_URL</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># cloneUrl:</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify node labels for CI job pods assignment</span></div><div class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># nodeSelector: &#123;&#125;</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify pod labels for CI job pods</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># podLabels: &#123;&#125;</span></div><div class="line"></div><div class="line">  <span class="comment">## Specify annotations for job pods, useful for annotations such as iam.amazonaws.com/role</span></div><div class="line">  <span class="comment"># podAnnotations: &#123;&#125;</span></div><div class="line"></div><div class="line">  <span class="comment">## Configure environment variables that will be injected to the pods that are created while</span></div><div class="line">  <span class="comment">## the build is running. These variables are passed as parameters, i.e. `--env "NAME=VALUE"`,</span></div><div class="line">  <span class="comment">## to `gitlab-runner register` command.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## Note that `envVars` (see below) are only present in the runner pod, not the pods that are</span></div><div class="line">  <span class="comment">## created for each build.</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment">## ref: https://docs.gitlab.com/runner/commands/#gitlab-runner-register</span></div><div class="line">  <span class="comment">##</span></div><div class="line">  <span class="comment"># env:</span></div><div class="line">  <span class="comment">#   NAME: VALUE</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## Configure resource requests and limits</span></div><div class="line"><span class="comment">## ref: http://kubernetes.io/docs/user-guide/compute-resources/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">resources:</span> &#123;&#125;</div><div class="line">  <span class="comment"># limits:</span></div><div class="line">  <span class="comment">#   memory: 256Mi</span></div><div class="line">  <span class="comment">#   cpu: 200m</span></div><div class="line">  <span class="comment"># requests:</span></div><div class="line">  <span class="comment">#   memory: 128Mi</span></div><div class="line">  <span class="comment">#   cpu: 100m</span></div><div class="line"></div><div class="line"><span class="comment">## Affinity for pod assignment</span></div><div class="line"><span class="comment">## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">affinity:</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">## Node labels for pod assignment</span></div><div class="line"><span class="comment">## Ref: https://kubernetes.io/docs/user-guide/node-selection/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">nodeSelector:</span> &#123;</div><div class="line"><span class="attr">  nodeType:</span> k8s</div><div class="line">&#125;</div><div class="line">  <span class="comment"># Example: The gitlab runner manager should not run on spot instances so you can assign</span></div><div class="line">  <span class="comment"># them to the regular worker nodes only.</span></div><div class="line">  <span class="comment"># node-role.kubernetes.io/worker: "true"</span></div><div class="line"></div><div class="line"><span class="comment">## List of node taints to tolerate (requires Kubernetes &gt;= 1.6)</span></div><div class="line"><span class="comment">## Ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">tolerations:</span> []</div><div class="line">  <span class="comment"># Example: Regular worker nodes may have a taint, thus you need to tolerate the taint</span></div><div class="line">  <span class="comment"># when you assign the gitlab runner manager with nodeSelector or affinity to the nodes.</span></div><div class="line">  <span class="comment"># - key: "node-role.kubernetes.io/worker"</span></div><div class="line">  <span class="comment">#   operator: "Exists"</span></div><div class="line"></div><div class="line"><span class="comment">## Configure environment variables that will be present when the registration command runs</span></div><div class="line"><span class="comment">## This provides further control over the registration process and the config.toml file</span></div><div class="line"><span class="comment">## ref: `gitlab-runner register --help`</span></div><div class="line"><span class="comment">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># envVars:</span></div><div class="line"><span class="comment">#   - name: RUNNER_EXECUTOR</span></div><div class="line"><span class="comment">#     value: kubernetes</span></div><div class="line"></div><div class="line"><span class="comment">## list of hosts and IPs that will be injected into the pod's hosts file</span></div><div class="line"><span class="attr">hostAliases:</span> []</div><div class="line">  <span class="comment"># Example:</span></div><div class="line">  <span class="comment"># - ip: "127.0.0.1"</span></div><div class="line">  <span class="comment">#   hostnames:</span></div><div class="line">  <span class="comment">#   - "foo.local"</span></div><div class="line">  <span class="comment">#   - "bar.local"</span></div><div class="line">  <span class="comment"># - ip: "10.1.2.3"</span></div><div class="line">  <span class="comment">#   hostnames:</span></div><div class="line">  <span class="comment">#   - "foo.remote"</span></div><div class="line">  <span class="comment">#   - "bar.remote"</span></div><div class="line"></div><div class="line"><span class="comment">## Annotations to be added to manager pod</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="attr">podAnnotations:</span> &#123;&#125;</div><div class="line">  <span class="comment"># Example:</span></div><div class="line">  <span class="comment"># iam.amazonaws.com/role: &lt;my_role_arn&gt;</span></div><div class="line"></div><div class="line"><span class="comment">## HPA support for custom metrics:</span></div><div class="line"><span class="comment">## This section enables runners to autoscale based on defined custom metrics.</span></div><div class="line"><span class="comment">## In order to use this functionality, Need to enable a custom metrics API server by</span></div><div class="line"><span class="comment">## implementing "custom.metrics.k8s.io" using supported third party adapter</span></div><div class="line"><span class="comment">## Example: https://github.com/directxman12/k8s-prometheus-adapter</span></div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment">#hpa: &#123;&#125;</span></div><div class="line">  <span class="comment"># minReplicas: 1</span></div><div class="line">  <span class="comment"># maxReplicas: 10</span></div><div class="line">  <span class="comment"># metrics:</span></div><div class="line">  <span class="comment"># - type: Pods</span></div><div class="line">  <span class="comment">#   pods:</span></div><div class="line">  <span class="comment">#     metricName: gitlab_runner_jobs</span></div><div class="line">  <span class="comment">#     targetAverageValue: 400m</span></div></pre></td></tr></table></figure>
<h3 id="Helm-for-gitlab-configmap"><a href="#Helm-for-gitlab-configmap" class="headerlink" title="Helm for gitlab configmap"></a>Helm for gitlab configmap</h3><p> cat templates/configmap.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ConfigMap</div><div class="line">metadata:</div><div class="line">  name: &#123;&#123; include <span class="string">"gitlab-runner.fullname"</span> . &#125;&#125;</div><div class="line">  labels:</div><div class="line">    app: &#123;&#123; include <span class="string">"gitlab-runner.fullname"</span> . &#125;&#125;</div><div class="line">    chart: &#123;&#123; include <span class="string">"gitlab-runner.chart"</span> . &#125;&#125;</div><div class="line">    release: <span class="string">"&#123;&#123; .Release.Name &#125;&#125;"</span></div><div class="line">    heritage: <span class="string">"&#123;&#123; .Release.Service &#125;&#125;"</span></div><div class="line">data:</div><div class="line">  entrypoint: |</div><div class="line">    <span class="comment">#!/bin/bash</span></div><div class="line">    <span class="built_in">set</span> <span class="_">-e</span></div><div class="line">    mkdir -p /home/gitlab-runner/.gitlab-runner/</div><div class="line">    cp /scripts/config.toml /home/gitlab-runner/.gitlab-runner/</div><div class="line"></div><div class="line">    <span class="comment"># Register the runner</span></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/accesskey &amp;&amp; <span class="_">-f</span> /secrets/secretkey ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> CACHE_S3_ACCESS_KEY=$(cat /secrets/accesskey)</div><div class="line">      <span class="built_in">export</span> CACHE_S3_SECRET_KEY=$(cat /secrets/secretkey)</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/gcs-applicaton-credentials-file ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> GOOGLE_APPLICATION_CREDENTIALS=<span class="string">"/secrets/gcs-applicaton-credentials-file"</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">      <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/gcs-access-id &amp;&amp; <span class="_">-f</span> /secrets/gcs-private-key ]]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">export</span> CACHE_GCS_ACCESS_ID=$(cat /secrets/gcs-access-id)</div><div class="line">        <span class="comment"># echo -e used to make private key multiline (in google json auth key private key is oneline with \n)</span></div><div class="line">        <span class="built_in">export</span> CACHE_GCS_PRIVATE_KEY=$(<span class="built_in">echo</span> <span class="_">-e</span> $(cat /secrets/gcs-private-key))</div><div class="line">      <span class="keyword">fi</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/runner-registration-token ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> REGISTRATION_TOKEN=$(cat /secrets/runner-registration-token)</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [[ <span class="_">-f</span> /secrets/runner-token ]]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">export</span> CI_SERVER_TOKEN=$(cat /secrets/runner-token)</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> ! sh /scripts/register-the-runner; <span class="keyword">then</span></div><div class="line">      <span class="built_in">exit</span> 1</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF</div><div class="line">      output_limit = 100000</div><div class="line">      [[runners.kubernetes.volumes.pvc]]</div><div class="line">        name = <span class="string">"gitlab-runner-maven-repo-claim"</span></div><div class="line">        mount_path = <span class="string">"/home/cache/maven"</span></div><div class="line">      [[runners.kubernetes.volumes.host_path]]</div><div class="line">        name = <span class="string">"docker"</span></div><div class="line">        mount_path = <span class="string">"/var/run/docker.sock"</span></div><div class="line">    EOF</div><div class="line">    <span class="comment"># Start the runner</span></div><div class="line">    <span class="built_in">exec</span> /entrypoint run --user=gitlab-runner \</div><div class="line">      --working-directory=/home/gitlab-runner</div><div class="line"></div><div class="line">  config.toml: |</div><div class="line">    concurrent = &#123;&#123; .Values.concurrent &#125;&#125;</div><div class="line">    check_interval = &#123;&#123; .Values.checkInterval &#125;&#125;</div><div class="line">    log_level = &#123;&#123; default <span class="string">"info"</span> .Values.logLevel | quote &#125;&#125;</div><div class="line">    output_limit = &#123;&#123; default 10000 .Values.limitLine&#125;&#125;</div><div class="line">    &#123;&#123;- <span class="keyword">if</span> .Values.logFormat &#125;&#125;</div><div class="line">    log_format = &#123;&#123; .Values.logFormat | quote &#125;&#125;</div><div class="line">    &#123;&#123;- end &#125;&#125;</div><div class="line">    &#123;&#123;- <span class="keyword">if</span> .Values.metrics.enabled &#125;&#125;</div><div class="line">    listen_address = <span class="string">'[::]:9252'</span></div><div class="line">    &#123;&#123;- end &#125;&#125;</div><div class="line">  configure: |</div><div class="line">    <span class="built_in">set</span> <span class="_">-e</span></div><div class="line">    cp /init-secrets/* /secrets</div><div class="line">  register-the-runner: |</div><div class="line">    <span class="comment">#!/bin/bash</span></div><div class="line">    MAX_REGISTER_ATTEMPTS=30</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> $(seq 1 <span class="string">"<span class="variable">$&#123;MAX_REGISTER_ATTEMPTS&#125;</span>"</span>); <span class="keyword">do</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"Registration attempt <span class="variable">$&#123;i&#125;</span> of <span class="variable">$&#123;MAX_REGISTER_ATTEMPTS&#125;</span>"</span></div><div class="line">      /entrypoint register \</div><div class="line">        &#123;&#123;- range .Values.runners.imagePullSecrets &#125;&#125;</div><div class="line">        --kubernetes-image-pull-secrets &#123;&#123; . | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$val</span> := .Values.runners.nodeSelector &#125;&#125;</div><div class="line">        --kubernetes-node-selector &#123;&#123; <span class="variable">$key</span> | quote &#125;&#125;:&#123;&#123; <span class="variable">$val</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$value</span> := .Values.runners.podLabels &#125;&#125;</div><div class="line">        --kubernetes-pod-labels &#123;&#123; <span class="variable">$key</span> | quote &#125;&#125;:&#123;&#123; <span class="variable">$value</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$val</span> := .Values.runners.podAnnotations &#125;&#125;</div><div class="line">        --kubernetes-pod-annotations &#123;&#123; <span class="variable">$key</span> | quote &#125;&#125;:&#123;&#123; <span class="variable">$val</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- range <span class="variable">$key</span>, <span class="variable">$value</span> := .Values.runners.env &#125;&#125;</div><div class="line">        --env &#123;&#123; <span class="variable">$key</span> | quote -&#125;&#125; = &#123;&#123;- <span class="variable">$value</span> | quote &#125;&#125; \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        &#123;&#123;- <span class="keyword">if</span> and (hasKey .Values.runners <span class="string">"runUntagged"</span>) .Values.runners.runUntagged &#125;&#125;</div><div class="line">        --run-untagged=<span class="literal">true</span> \</div><div class="line">        &#123;&#123;- end &#125;&#125;</div><div class="line">        --non-interactive</div><div class="line"></div><div class="line">      retval=$?</div><div class="line"></div><div class="line">      <span class="keyword">if</span> [ <span class="variable">$&#123;retval&#125;</span> = 0 ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">break</span></div><div class="line">      <span class="keyword">elif</span> [ <span class="variable">$&#123;i&#125;</span> = <span class="variable">$&#123;MAX_REGISTER_ATTEMPTS&#125;</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line">      <span class="keyword">fi</span></div><div class="line"></div><div class="line">      sleep 5</div><div class="line">    <span class="keyword">done</span></div><div class="line"></div><div class="line">    <span class="built_in">exit</span> 0</div><div class="line"></div><div class="line">  check-live: |</div><div class="line">    <span class="comment">#!/bin/bash</span></div><div class="line">    <span class="keyword">if</span> /usr/bin/pgrep <span class="_">-f</span> .*register-the-runner; <span class="keyword">then</span></div><div class="line">      <span class="built_in">exit</span> 0</div><div class="line">    <span class="keyword">elif</span> /usr/bin/pgrep gitlab.*runner; <span class="keyword">then</span></div><div class="line">      <span class="built_in">exit</span> 0</div><div class="line">    <span class="keyword">else</span></div><div class="line">      <span class="built_in">exit</span> 1</div><div class="line">    <span class="keyword">fi</span></div></pre></td></tr></table></figure>
<h3 id="gitlab-runner"><a href="#gitlab-runner" class="headerlink" title="gitlab-runner"></a>gitlab-runner</h3><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="string">helm </span><span class="string">install </span><span class="built_in">--name</span> <span class="string">xxx </span><span class="string">gitlab/</span><span class="string">gitlab-runner </span>-f <span class="string">values-spm-</span><span class="string">labour.</span><span class="string">yaml </span> <span class="built_in">--namespace</span> <span class="string">gitlab-runners </span><span class="built_in">--version</span> <span class="string">"v0.10.0-rc1"</span></div><div class="line"><span class="string">helm </span><span class="string">upgrade </span><span class="string">xxx </span>./<span class="string">gitlab-runner/</span></div></pre></td></tr></table></figure>
<h3 id="创建runner-maven-缓存"><a href="#创建runner-maven-缓存" class="headerlink" title="创建runner maven 缓存"></a>创建runner maven 缓存</h3><blockquote>
<p>Java 需要</p>
</blockquote>
<p>cat maven-nfs.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> PersistentVolume</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab-runner-maven-repo</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span>Gi</div><div class="line"><span class="attr">  mountOptions:</span></div><div class="line"><span class="bullet">  -</span> nolock</div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> /data/nfs/volumes</div><div class="line"><span class="attr">    server:</span> YOURIPADDRESS</div><div class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> Recycle</div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> PersistentVolumeClaim</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab-runner-maven-repo-claim</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">  resources:</span></div><div class="line"><span class="attr">    requests:</span></div><div class="line"><span class="attr">      storage:</span> <span class="number">5</span>Gi</div><div class="line"><span class="attr">  volumeName:</span> gitlab-runner-maven-repo</div><div class="line"><span class="attr">status:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span>Gi</div></pre></td></tr></table></figure>
<h4 id="生成maven缓存PVC"><a href="#生成maven缓存PVC" class="headerlink" title="生成maven缓存PVC"></a>生成maven缓存PVC</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> PersistentVolumeClaim</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab-runner-maven-repo-claim</div><div class="line"><span class="attr">  namespace:</span> gitlab-runners</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">    resources:</span></div><div class="line"><span class="attr">    requests:</span></div><div class="line"><span class="attr">      storage:</span> <span class="number">5</span>Gi</div><div class="line"><span class="attr">    volumeName:</span> gitlab-runner-maven-repo</div><div class="line"><span class="attr">status:</span></div><div class="line"><span class="attr">    accessModes:</span></div><div class="line"><span class="bullet">  -</span> ReadWriteMany</div><div class="line"><span class="attr">    capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span>Gi</div></pre></td></tr></table></figure>
<h4 id="代码及镜像上传"><a href="#代码及镜像上传" class="headerlink" title="代码及镜像上传"></a>代码及镜像上传</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">##如果删除</div><div class="line">helm del --purge spm-labour</div><div class="line"></div><div class="line">##生成gitlab namespace</div><div class="line">kubectl create ns gitlab</div><div class="line">### 代码镜像上传密钥</div><div class="line">kubectl create secret docker-registry  huawei-auth --docker-server=XXX.myhuaweicloud.com --docker-username=XXX --docker-password=XXXX -ngitlab</div><div class="line">###kubectl create secret docker-registry  aliyun-auth --docker-server=registry.cn-zhangjiakou.aliyuncs.com --docker-username=xxx --docker-password=xxx -ngitlab</div></pre></td></tr></table></figure>
<h5 id="其它及遇到的坑"><a href="#其它及遇到的坑" class="headerlink" title="其它及遇到的坑"></a>其它及遇到的坑</h5><blockquote>
<p>GitLab集成k8s 签名错误</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl get secrets</div><div class="line">kubectl get secret default-token-52xsf  -o jsonpath="&#123;[<span class="string">'data'</span>][<span class="symbol">'ca\.crt'</span>]&#125;" | base64 --decode</div></pre></td></tr></table></figure>
<blockquote>
<p>cat gitlab-admin-service-account.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> ServiceAccount</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab</div><div class="line"></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</div><div class="line"><span class="attr">kind:</span> ClusterRoleBinding</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> gitlab</div><div class="line"><span class="attr">  namespace:</span> gitlab</div><div class="line"><span class="attr">subjects:</span></div><div class="line"><span class="attr">  - kind:</span> ServiceAccount</div><div class="line"><span class="attr">    name:</span> gitlab</div><div class="line"><span class="attr">    namespace:</span> gitlab</div><div class="line"><span class="attr">roleRef:</span></div><div class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</div><div class="line"><span class="attr">  kind:</span> ClusterRole</div><div class="line"><span class="attr">  name:</span> cluster-admin</div></pre></td></tr></table></figure>
<blockquote>
<p>获取 Service Token</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl -n gitlab  describe secret $(kubectl -n gitlab get secret <span class="params">| grep gitlab|</span> awk <span class="string">'&#123;print $1&#125;'</span>)</div></pre></td></tr></table></figure>

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/10/29/记k8s在公网部署/" rel="next" title="记k8s在公网部署">
                <i class="fa fa-chevron-left"></i> 记k8s在公网部署
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/03/22/Springboot-AliOssUtil/" rel="prev" title="Springboot AliOssUtil">
                Springboot AliOssUtil <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
  <div class="ds-recent-visitors" data-num-items="28" data-avatar-size="42" id="ds-recent-visitors"></div>
    
      <div class="ds-thread" data-thread-key="2021/03/16/k8s-部署和gitlab-CI-CD/"
           data-title="k8s 部署和gitlab CI/CD" data-url="http://peterfei.me/2021/03/16/k8s-部署和gitlab-CI-CD/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://ruby-china-files.b0.upaiyun.com/user/big_avatar/5575.jpg"
               alt="peterfei" />
          <p class="site-author-name" itemprop="name">peterfei</p>
          <p class="site-description motion-element" itemprop="description">peterfei|技术|上主是我的牧者</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">76</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/peterfei" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备工作"><span class="nav-number">1.</span> <span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-安装必备软件"><span class="nav-number">1.1.</span> <span class="nav-text">1. 安装必备软件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-关闭swap"><span class="nav-number">1.2.</span> <span class="nav-text">2. 关闭swap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-关闭selinux"><span class="nav-number">1.3.</span> <span class="nav-text">3. 关闭selinux</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-关闭防火墙"><span class="nav-number">2.</span> <span class="nav-text">4. 关闭防火墙</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Docker和配置代理"><span class="nav-number"></span> <span class="nav-text">安装Docker和配置代理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-配置yum源"><span class="nav-number">1.</span> <span class="nav-text">1. 配置yum源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-安装docker"><span class="nav-number">2.</span> <span class="nav-text">2. 安装docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-确保kubelet使用的cgroup-driver-与-Docker的一致"><span class="nav-number">3.</span> <span class="nav-text">3. 确保kubelet使用的cgroup driver 与 Docker的一致</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-从国内仓库拉取镜像（核心步骤-如果没有代理）"><span class="nav-number">4.</span> <span class="nav-text">4. 从国内仓库拉取镜像（核心步骤-如果没有代理）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开始安装k8s"><span class="nav-number"></span> <span class="nav-text">开始安装k8s</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-安装kubeadm，kubelet等"><span class="nav-number">1.</span> <span class="nav-text">1. 安装kubeadm，kubelet等</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-集群初始化"><span class="nav-number">2.</span> <span class="nav-text">2. 集群初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-拷贝配置，给kubectl使用"><span class="nav-number">3.</span> <span class="nav-text">3. 拷贝配置，给kubectl使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-安装flannel网络"><span class="nav-number">4.</span> <span class="nav-text">4. 安装flannel网络</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-node节点加入集群"><span class="nav-number"></span> <span class="nav-text">5. node节点加入集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#清理安装"><span class="nav-number"></span> <span class="nav-text">清理安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-helm-和-gitlab-runner"><span class="nav-number">1.</span> <span class="nav-text">安装 helm 和 gitlab-runner</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Helm-for-gitlab-configmap"><span class="nav-number">2.</span> <span class="nav-text">Helm for gitlab configmap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gitlab-runner"><span class="nav-number">3.</span> <span class="nav-text">gitlab-runner</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建runner-maven-缓存"><span class="nav-number">4.</span> <span class="nav-text">创建runner maven 缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#生成maven缓存PVC"><span class="nav-number">4.1.</span> <span class="nav-text">生成maven缓存PVC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代码及镜像上传"><span class="nav-number">4.2.</span> <span class="nav-text">代码及镜像上传</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#其它及遇到的坑"><span class="nav-number">4.2.1.</span> <span class="nav-text">其它及遇到的坑</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">peterfei</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"peterfei"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  


</body>
</html>
